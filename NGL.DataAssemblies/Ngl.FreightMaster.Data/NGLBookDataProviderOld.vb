Imports Microsoft.VisualBasic
Imports System
Imports System.Collections.Generic
Imports System.Linq
Imports System.Data.Linq
Imports System.Data.SqlClient
Imports System.ServiceModel
Imports System.Data.SqlDbType
Imports System.Threading
Imports DTO = Ngl.FreightMaster.Data.DataTransferObjects
Imports LTS = Ngl.FreightMaster.Data.LTS
Imports Ngl.Core.ChangeTracker
Imports DTran = Ngl.Core.Utility.DataTransformation

Namespace Old
Public Class NGLBookData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.Books
        Me.LinqDB = db
    End Sub

#End Region

#Region "Properties"
    Private _RecalcTotals As Boolean = False
#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GetBookFiltered(Control:=Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return GetBooksFiltered()
    End Function

    Public Function GetBooksByCarrier(ByVal CarrierControl As Integer) As DTO.Book()
        If CarrierControl = 0 Then Return Nothing
        Return GetBooksFiltered(CarrierControl:=CarrierControl)
    End Function

    Public Function GetBooksByComp(ByVal CompControl As Integer) As DTO.Book()
        If CompControl = 0 Then Return Nothing
        Return GetBooksFiltered(CompControl:=CompControl)
    End Function

    Public Function GetBooksByLane(ByVal LaneControl As Integer) As DTO.Book()
        If LaneControl = 0 Then Return Nothing
        Return GetBooksFiltered(LaneControl:=LaneControl)
    End Function

    Public Function GetBookFiltered(Optional ByVal Control As Integer = 0, _
                                    Optional ByVal BookProNumber As String = "", _
                                    Optional ByVal BookConsPrefix As String = "", _
                                    Optional ByVal BookLoadPONumber As String = "", _
                                    Optional ByVal BookCarrBLNumber As String = "", _
                                    Optional ByVal BookFinAPBillNumber As String = "", _
                                    Optional ByVal BookCarrOrderNumber As String = "", _
                                    Optional ByVal BookOrderSequence As Integer = 0) As DTO.Book
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim oDLO As New DataLoadOptions
                oDLO.LoadWith(Of LTS.Book)(Function(t As LTS.Book) t.BookLoads)
                oDLO.LoadWith(Of LTS.Book)(Function(t As LTS.Book) t.BookNotes)
                oDLO.LoadWith(Of LTS.Book)(Function(t As LTS.Book) t.BookTracks)
                oDLO.LoadWith(Of LTS.BookLoad)(Function(t As LTS.BookLoad) t.BookItems)
                db.LoadOptions = oDLO
                'Get the newest record that matches the provided criteria                
                Dim Book As DTO.Book = ( _
                From d In db.Books _
                Where _
                    (d.BookControl = If(Control = 0, d.BookControl, Control)) _
                    And _
                    (BookProNumber Is Nothing OrElse String.IsNullOrEmpty(BookProNumber) OrElse d.BookProNumber = BookProNumber) _
                    And _
                    (BookConsPrefix Is Nothing OrElse String.IsNullOrEmpty(BookConsPrefix) OrElse d.BookConsPrefix = BookConsPrefix) _
                    And _
                    (BookCarrBLNumber Is Nothing OrElse String.IsNullOrEmpty(BookCarrBLNumber) OrElse d.BookCarrBLNumber = BookCarrBLNumber) _
                    And _
                    (BookFinAPBillNumber Is Nothing OrElse String.IsNullOrEmpty(BookFinAPBillNumber) OrElse d.BookFinAPBillNumber = BookFinAPBillNumber) _
                    And _
                    (BookCarrOrderNumber Is Nothing OrElse String.IsNullOrEmpty(BookCarrOrderNumber) OrElse d.BookCarrOrderNumber = BookCarrOrderNumber) _
                    And _
                    (BookOrderSequence = 0 OrElse d.BookOrderSequence = BookOrderSequence) _
                Order By d.BookStopNo Ascending _
                Select New DTO.Book With {.BookControl = d.BookControl _
                                            , .BookProNumber = d.BookProNumber _
                                            , .BookProBase = d.BookProBase _
                                            , .BookConsPrefix = d.BookConsPrefix _
                                            , .BookCustCompControl = d.BookCustCompControl _
                                            , .BookCommCompControl = d.BookCommCompControl _
                                            , .BookODControl = d.BookODControl _
                                            , .BookCarrierControl = d.BookCarrierControl _
                                            , .BookCarrierContact = d.BookCarrierContact _
                                            , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                            , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                            , .BookOrigName = d.BookOrigName _
                                            , .BookOrigAddress1 = d.BookOrigAddress1 _
                                            , .BookOrigAddress2 = d.BookOrigAddress2 _
                                            , .BookOrigAddress3 = d.BookOrigAddress3 _
                                            , .BookOrigCity = d.BookOrigCity _
                                            , .BookOrigState = d.BookOrigState _
                                            , .BookOrigCountry = d.BookOrigCountry _
                                            , .BookOrigZip = d.BookOrigZip _
                                            , .BookOrigPhone = d.BookOrigPhone _
                                            , .BookOrigFax = d.BookOrigFax _
                                            , .BookOriginStartHrs = d.BookOriginStartHrs _
                                            , .BookOriginStopHrs = d.BookOriginStopHrs _
                                            , .BookOriginApptReq = If(d.BookOriginApptReq.HasValue, d.BookOriginApptReq, False) _
                                            , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                            , .BookDestName = d.BookDestName _
                                            , .BookDestAddress1 = d.BookDestAddress1 _
                                            , .BookDestAddress2 = d.BookDestAddress2 _
                                            , .BookDestAddress3 = d.BookDestAddress3 _
                                            , .BookDestCity = d.BookDestCity _
                                            , .BookDestState = d.BookDestState _
                                            , .BookDestCountry = d.BookDestCountry _
                                            , .BookDestZip = d.BookDestZip _
                                            , .BookDestPhone = d.BookDestPhone _
                                            , .BookDestFax = d.BookDestFax _
                                            , .BookDestStartHrs = d.BookDestStartHrs _
                                            , .BookDestStopHrs = d.BookDestStopHrs _
                                            , .BookDestApptReq = If(d.BookDestApptReq.HasValue, d.BookDestApptReq, False) _
                                            , .BookDateOrdered = d.BookDateOrdered _
                                            , .BookDateLoad = d.BookDateLoad _
                                            , .BookDateInvoice = d.BookDateInvoice _
                                            , .BookDateRequired = d.BookDateRequired _
                                            , .BookDateDelivered = d.BookDateDelivered _
                                            , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                            , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                            , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                            , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                            , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                            , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                            , .BookTranCode = d.BookTranCode _
                                            , .BookPayCode = d.BookPayCode _
                                            , .BookTypeCode = d.BookTypeCode _
                                            , .BookBOLCode = d.BookBOLCode _
                                            , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                            , .BookCarrFBNumber = d.BookCarrFBNumber _
                                            , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                            , .BookCarrBLNumber = d.BookCarrBLNumber _
                                            , .BookCarrBookDate = d.BookCarrBookDate _
                                            , .BookCarrBookTime = d.BookCarrBookTime _
                                            , .BookCarrBookContact = d.BookCarrBookContact _
                                            , .BookCarrScheduleDate = d.BookCarrScheduleDate _
                                            , .BookCarrScheduleTime = d.BookCarrScheduleTime _
                                            , .BookCarrActualDate = d.BookCarrActualDate _
                                            , .BookCarrActualTime = d.BookCarrActualTime _
                                            , .BookCarrActLoadComplete_Date = d.BookCarrActLoadComplete_Date _
                                            , .BookCarrActLoadCompleteTime = d.BookCarrActLoadCompleteTime _
                                            , .BookCarrDockPUAssigment = d.BookCarrDockPUAssigment _
                                            , .BookCarrPODate = d.BookCarrPODate _
                                            , .BookCarrPOTime = d.BookCarrPOTime _
                                            , .BookCarrApptDate = d.BookCarrApptDate _
                                            , .BookCarrApptTime = d.BookCarrApptTime _
                                            , .BookCarrActDate = d.BookCarrActDate _
                                            , .BookCarrActTime = d.BookCarrActTime _
                                            , .BookCarrActUnloadCompDate = d.BookCarrActUnloadCompDate _
                                            , .BookCarrActUnloadCompTime = d.BookCarrActUnloadCompTime _
                                            , .BookCarrDockDelAssignment = d.BookCarrDockDelAssignment _
                                            , .BookCarrVarDay = If(d.BookCarrVarDay.HasValue, d.BookCarrVarDay, 0) _
                                            , .BookCarrVarHrs = If(d.BookCarrVarHrs.HasValue, d.BookCarrVarHrs, 0) _
                                            , .BookCarrTrailerNo = d.BookCarrTrailerNo _
                                            , .BookCarrSealNo = d.BookCarrSealNo _
                                            , .BookCarrDriverNo = d.BookCarrDriverNo _
                                            , .BookCarrDriverName = d.BookCarrDriverName _
                                            , .BookCarrRouteNo = d.BookCarrRouteNo _
                                            , .BookCarrTripNo = d.BookCarrTripNo _
                                            , .BookFinARBookFrt = If(d.BookFinARBookFrt.HasValue, d.BookFinARBookFrt, 0) _
                                            , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                            , .BookFinARInvoiceAmt = If(d.BookFinARInvoiceAmt.HasValue, d.BookFinARInvoiceAmt, 0) _
                                            , .BookFinARPayDate = d.BookFinARPayDate _
                                            , .BookFinARPayAmt = If(d.BookFinARPayAmt.HasValue, d.BookFinARPayAmt, 0) _
                                            , .BookFinARCheck = d.BookFinARCheck _
                                            , .BookFinARGLNumber = d.BookFinARGLNumber _
                                            , .BookFinARBalance = If(d.BookFinARBalance.HasValue, d.BookFinARBalance, 0) _
                                            , .BookFinARCurType = If(d.BookFinARCurType.HasValue, d.BookFinARCurType, 0) _
                                            , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                            , .BookFinAPBillNoDate = d.BookFinAPBillNoDate _
                                            , .BookFinAPBillInvDate = d.BookFinAPBillInvDate _
                                            , .BookFinAPActWgt = If(d.BookFinAPActWgt.HasValue, d.BookFinAPActWgt, 0) _
                                            , .BookFinAPStdCost = If(d.BookFinAPStdCost.HasValue, d.BookFinAPStdCost, 0) _
                                            , .BookFinAPActCost = If(d.BookFinAPActCost.HasValue, d.BookFinAPActCost, 0) _
                                            , .BookFinAPPayDate = d.BookFinAPPayDate _
                                            , .BookFinAPPayAmt = If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0) _
                                            , .BookFinAPCheck = d.BookFinAPCheck _
                                            , .BookFinAPGLNumber = d.BookFinAPGLNumber _
                                            , .BookFinAPLastViewed = d.BookFinAPLastViewed _
                                            , .BookFinAPCurType = If(d.BookFinAPCurType.HasValue, d.BookFinAPCurType, 0) _
                                            , .BookFinCommStd = If(d.BookFinCommStd.HasValue, d.BookFinCommStd, 0) _
                                            , .BookFinCommAct = If(d.BookFinCommAct.HasValue, d.BookFinCommAct, 0) _
                                            , .BookFinCommPayDate = d.BookFinCommPayDate _
                                            , .BookFinCommPayAmt = If(d.BookFinCommPayAmt.HasValue, d.BookFinCommPayAmt, 0) _
                                            , .BookFinCommtCheck = d.BookFinCommtCheck _
                                            , .BookFinCommCreditAmt = If(d.BookFinCommCreditAmt.HasValue, d.BookFinCommCreditAmt, 0) _
                                            , .BookFinCommCreditPayDate = d.BookFinCommCreditPayDate _
                                            , .BookFinCommLoadCount = If(d.BookFinCommLoadCount.HasValue, d.BookFinCommLoadCount, 0) _
                                            , .BookFinCommGLNumber = d.BookFinCommGLNumber _
                                            , .BookFinCheckClearedDate = d.BookFinCheckClearedDate _
                                            , .BookFinCheckClearedNumber = d.BookFinCheckClearedNumber _
                                            , .BookFinCheckClearedAmt = If(d.BookFinCheckClearedAmt.HasValue, d.BookFinCheckClearedAmt, 0) _
                                            , .BookFinCheckClearedDesc = d.BookFinCheckClearedDesc _
                                            , .BookFinCheckClearedAcct = d.BookFinCheckClearedAcct _
                                            , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                            , .BookRevCarrierCost = If(d.BookRevCarrierCost.HasValue, d.BookRevCarrierCost, 0) _
                                            , .BookRevStopQty = If(d.BookRevStopQty.HasValue, d.BookRevStopQty, 0) _
                                            , .BookRevStopCost = If(d.BookRevStopCost.HasValue, d.BookRevStopCost, 0) _
                                            , .BookRevOtherCost = If(d.BookRevOtherCost.HasValue, d.BookRevOtherCost, 0) _
                                            , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                            , .BookRevLoadSavings = If(d.BookRevLoadSavings.HasValue, d.BookRevLoadSavings, 0) _
                                            , .BookRevCommPercent = If(d.BookRevCommPercent.HasValue, d.BookRevCommPercent, 0) _
                                            , .BookRevCommCost = If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0) _
                                            , .BookRevGrossRevenue = If(d.BookRevGrossRevenue.HasValue, d.BookRevGrossRevenue, 0) _
                                            , .BookRevNegRevenue = If(d.BookRevNegRevenue.HasValue, d.BookRevNegRevenue, 0) _
                                            , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                            , .BookLaneCarrControl = If(d.BookLaneCarrControl.HasValue, d.BookLaneCarrControl, 0) _
                                            , .BookHoldLoad = If(d.BookHoldLoad.HasValue, d.BookHoldLoad, 0) _
                                            , .BookRouteFinalDate = d.BookRouteFinalDate _
                                            , .BookRouteFinalCode = d.BookRouteFinalCode _
                                            , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                            , .BookWarehouseNumber = d.BookWarehouseNumber _
                                            , .BookComCode = d.BookComCode _
                                            , .BookTransType = d.BookTransType _
                                            , .BookRouteConsFlag = d.BookRouteConsFlag _
                                            , .BookWhseAuthorizationNo = d.BookWhseAuthorizationNo _
                                            , .BookHotLoad = If(d.BookHotLoad.HasValue, d.BookHotLoad, False) _
                                            , .BookFinAPActTax = If(d.BookFinAPActTax.HasValue, d.BookFinAPActTax, 0) _
                                            , .BookFinAPExportFlag = d.BookFinAPExportFlag _
                                            , .BookFinARFreightTax = d.BookFinARFreightTax _
                                            , .BookRevFreightTax = d.BookRevFreightTax _
                                            , .BookRevNetCost = d.BookRevNetCost _
                                            , .BookFinServiceFee = If(d.BookFinServiceFee.HasValue, d.BookFinServiceFee, 0) _
                                            , .BookFinAPExportDate = d.BookFinAPExportDate _
                                            , .BookFinAPExportRetry = If(d.BookFinAPExportRetry.HasValue, d.BookFinAPExportRetry, 0) _
                                            , .BookCarrierContControl = If(d.BookCarrierContControl.HasValue, d.BookCarrierContControl, 0) _
                                            , .BookHotLoadSent = If(d.BookHotLoadSent.HasValue, d.BookHotLoadSent, False) _
                                            , .BookExportDocCreated = If(d.BookExportDocCreated.HasValue, d.BookExportDocCreated, False) _
                                            , .BookDoNotInvoice = d.BookDoNotInvoice _
                                            , .BookCarrStartLoadingDate = d.BookCarrStartLoadingDate _
                                            , .BookCarrStartLoadingTime = d.BookCarrStartLoadingTime _
                                            , .BookCarrFinishLoadingDate = d.BookCarrFinishLoadingDate _
                                            , .BookCarrFinishLoadingTime = d.BookCarrFinishLoadingTime _
                                            , .BookCarrStartUnloadingDate = d.BookCarrStartUnloadingDate _
                                            , .BookCarrStartUnloadingTime = d.BookCarrStartUnloadingTime _
                                            , .BookCarrFinishUnloadingDate = d.BookCarrFinishUnloadingDate _
                                            , .BookCarrFinishUnloadingTime = d.BookCarrFinishUnloadingTime _
                                            , .BookOrderSequence = d.BookOrderSequence _
                                            , .BookChepGLID = d.BookChepGLID _
                                            , .BookCarrierTypeCode = d.BookCarrierTypeCode _
                                            , .BookPalletPositions = d.BookPalletPositions _
                                            , .BookShipCarrierProNumber = d.BookShipCarrierProNumber _
                                            , .BookShipCarrierName = d.BookShipCarrierName _
                                            , .BookShipCarrierNumber = d.BookShipCarrierNumber _
                                            , .BookAPAdjReasonControl = d.BookAPAdjReasonControl _
                                            , .BookDateRequested = d.BookDateRequested _
                                            , .BookCarrierEquipmentCodes = d.BookCarrierEquipmentCodes _
                                            , .BookLockAllCosts = d.BookLockAllCosts _
                                            , .BookLockBFCCost = d.BookLockBFCCost _
                                            , .BookDestStopNumber = d.BookDestStopNumber _
                                            , .BookOrigStopNumber = d.BookOrigStopNumber _
                                            , .BookDestStopControl = d.BookDestStopControl _
                                            , .BookOrigStopControl = d.BookOrigStopControl _
                                            , .BookRouteTypeCode = d.BookRouteTypeCode _
                                            , .BookAlternateAddressLaneControl = d.BookAlternateAddressLaneControl _
                                            , .BookAlternateAddressLaneNumber = d.BookAlternateAddressLaneNumber _
                                            , .BookDefaultRouteSequence = d.BookDefaultRouteSequence _
                                            , .BookRouteGuideControl = d.BookRouteGuideControl _
                                            , .BookRouteGuideNumber = d.BookRouteGuideNumber _
                                            , .BookCustomerApprovalRecieved = d.BookCustomerApprovalRecieved _
                                            , .BookCustomerApprovalTransmitted = d.BookCustomerApprovalTransmitted _
                                            , .BookAMSPickupApptControl = d.BookAMSPickupApptControl _
                                            , .BookAMSDeliveryApptControl = d.BookAMSDeliveryApptControl _
                                            , .BookItemDetailDescription = d.BookItemDetailDescription _
                                            , .BookModDate = d.BookModDate _
                                            , .BookModUser = d.BookModUser _
                                            , .BookUpdated = d.BookUpdated.ToArray _
                                              , .BookLoads = ( _
                                                    From c In d.BookLoads _
                                                    Select New DTO.BookLoad With {.BookLoadControl = c.BookLoadControl _
                                                    , .BookLoadBookControl = c.BookLoadBookControl _
                                                    , .BookLoadBuy = c.BookLoadBuy _
                                                    , .BookLoadPONumber = c.BookLoadPONumber _
                                                    , .BookLoadVendor = c.BookLoadVendor _
                                                    , .BookLoadCaseQty = If(c.BookLoadCaseQty.HasValue, c.BookLoadCaseQty, 0) _
                                                    , .BookLoadWgt = If(c.BookLoadWgt.HasValue, c.BookLoadWgt, 0) _
                                                    , .BookLoadCube = If(c.BookLoadCube.HasValue, c.BookLoadCube, 0) _
                                                    , .BookLoadPL = If(c.BookLoadPL.HasValue, c.BookLoadPL, 0) _
                                                    , .BookLoadPX = If(c.BookLoadPX.HasValue, c.BookLoadPX, 0) _
                                                    , .BookLoadPType = c.BookLoadPType _
                                                    , .BookLoadCom = c.BookLoadCom _
                                                    , .BookLoadPUOrigin = c.BookLoadPUOrigin _
                                                    , .BookLoadBFC = If(c.BookLoadBFC.HasValue, c.BookLoadBFC, 0) _
                                                    , .BookLoadTotCost = If(c.BookLoadTotCost.HasValue, c.BookLoadTotCost, 0) _
                                                    , .BookLoadComments = c.BookLoadComments _
                                                    , .BookLoadStopSeq = If(c.BookLoadStopSeq.HasValue, c.BookLoadStopSeq, 0) _
                                                    , .BookLoadModDate = c.BookLoadModDate _
                                                    , .BookLoadModUser = c.BookLoadModUser _
                                                    , .BookLoadUpdated = c.BookLoadUpdated.ToArray() _
                                                    , .BookItems = ( _
                                                        From i In c.BookItems _
                                                        Select New DTO.BookItem With {.BookItemControl = i.BookItemControl _
                                                       , .BookItemBookLoadControl = i.BookItemBookLoadControl _
                                                       , .BookItemFixOffInvAllow = If(i.BookItemFixOffInvAllow.HasValue, i.BookItemFixOffInvAllow, 0) _
                                                       , .BookItemFixFrtAllow = If(i.BookItemFixFrtAllow.HasValue, i.BookItemFixFrtAllow, 0) _
                                                       , .BookItemItemNumber = i.BookItemItemNumber _
                                                       , .BookItemQtyOrdered = If(i.BookItemQtyOrdered.HasValue, i.BookItemQtyOrdered, 0) _
                                                       , .BookItemFreightCost = If(i.BookItemFreightCost.HasValue, i.BookItemFreightCost, 0) _
                                                       , .BookItemItemCost = If(i.BookItemItemCost.HasValue, i.BookItemItemCost, 0) _
                                                       , .BookItemWeight = If(i.BookItemWeight.HasValue, i.BookItemWeight, 0) _
                                                       , .BookItemCube = If(i.BookItemCube.HasValue, i.BookItemCube, 0) _
                                                       , .BookItemPack = If(i.BookItemPack.HasValue, i.BookItemPack, 0) _
                                                       , .BookItemSize = i.BookItemSize _
                                                       , .BookItemDescription = i.BookItemDescription _
                                                       , .BookItemHazmat = i.BookItemHazmat _
                                                       , .BookItemModDate = i.BookItemModDate _
                                                       , .BookItemModUser = i.BookItemModUser _
                                                       , .BookItemBrand = i.BookItemBrand _
                                                       , .BookItemCostCenter = i.BookItemCostCenter _
                                                       , .BookItemLotNumber = i.BookItemLotNumber _
                                                       , .BookItemLotExpirationDate = i.BookItemLotExpirationDate _
                                                       , .BookItemGTIN = i.BookItemGTIN _
                                                       , .BookCustItemNumber = i.BookCustItemNumber _
                                                       , .BookItemBFC = If(i.BookItemBFC.HasValue, i.BookItemBFC, 0) _
                                                       , .BookItemCountryOfOrigin = i.BookItemCountryOfOrigin _
                                                       , .BookItemHST = i.BookItemHST _
                                                       , .BookItemPalletTypeID = i.BookItemPalletTypeID _
                                                       , .BookItemHazmatTypeCode = i.BookItemHazmatTypeCode _
                                                       , .BookItem49CFRCode = i.BookItem49CFRCode _
                                                       , .BookItemIATACode = i.BookItemIATACode _
                                                       , .BookItemDOTCode = i.BookItemDOTCode _
                                                       , .BookItemMarineCode = i.BookItemMarineCode _
                                                       , .BookItemNMFCClass = i.BookItemNMFCClass _
                                                       , .BookItemFAKClass = i.BookItemFAKClass _
                                                       , .BookItemLimitedQtyFlag = i.BookItemLimitedQtyFlag _
                                                       , .BookItemPallets = i.BookItemPallets _
                                                       , .BookItemTies = i.BookItemTies _
                                                       , .BookItemHighs = i.BookItemHighs _
                                                       , .BookItemQtyPalletPercentage = i.BookItemQtyPalletPercentage _
                                                       , .BookItemQtyLength = i.BookItemQtyLength _
                                                       , .BookItemQtyWidth = i.BookItemQtyWidth _
                                                       , .BookItemQtyHeight = i.BookItemQtyHeight _
                                                       , .BookItemStackable = i.BookItemStackable _
                                                       , .BookItemLevelOfDensity = i.BookItemLevelOfDensity _
                                                       , .BookItemUpdated = i.BookItemUpdated.ToArray()}).ToList() _
                                                }).ToList() _
                                            , .BookNotes = ( _
                                                    From c In d.BookNotes _
                                                    Select New DTO.BookNote With {.BookNotesControl = c.BookNotesControl _
                                                    , .BookNotesBookControl = c.BookNotesBookControl _
                                                    , .BookNotesVisable1 = c.BookNotesVisable1 _
                                                    , .BookNotesVisable2 = c.BookNotesVisable2 _
                                                    , .BookNotesVisable3 = c.BookNotesVisable3 _
                                                    , .BookNotesVisable4 = c.BookNotesVisable4 _
                                                    , .BookNotesVisable5 = c.BookNotesVisable5 _
                                                    , .BookNotesConfidential1 = c.BookNotesConfidential1 _
                                                    , .BookNotesConfidential2 = c.BookNotesConfidential2 _
                                                    , .BookNotesConfidential3 = c.BookNotesConfidential3 _
                                                    , .BookNotesConfidential4 = c.BookNotesConfidential4 _
                                                    , .BookNotesConfidential5 = c.BookNotesConfidential5 _
                                                    , .BookNotesModDate = c.BookNotesModDate _
                                                    , .BookNotesModUser = c.BookNotesModUser _
                                                    , .BookNotesUpdated = c.BookNotesUpdated.ToArray()}).ToList() _
                                            , .BookTracks = ( _
                                                    From c In d.BookTracks _
                                                    Select New DTO.BookTrack With {.BookTrackControl = c.BookTrackControl _
                                                    , .BookTrackBookControl = c.BookTrackBookControl _
                                                    , .BookTrackDate = c.BookTrackDate _
                                                    , .BookTrackContact = c.BookTrackContact _
                                                    , .BookTrackComment = c.BookTrackComment _
                                                    , .BookTrackStatus = If(c.BookTrackStatus.HasValue, c.BookTrackStatus, 0) _
                                                    , .BookTrackModDate = c.BookTrackModDate _
                                                    , .BookTrackModUser = c.BookTrackModUser _
                                                    , .BookTrackUpdated = c.BookTrackUpdated.ToArray()}).ToList() _
                                              }).First

                Return Book

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBookFilteredNoChildren(ByVal Control As Integer) As DTO.Book
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Get the newest record that matches the provided criteria                
                Dim Book As DTO.Book = ( _
                From d In db.Books _
                Where _
                    (d.BookControl = Control) _
                Select New DTO.Book With {.BookControl = d.BookControl _
                                            , .BookProNumber = d.BookProNumber _
                                            , .BookProBase = d.BookProBase _
                                            , .BookConsPrefix = d.BookConsPrefix _
                                            , .BookCustCompControl = d.BookCustCompControl _
                                            , .BookCommCompControl = d.BookCommCompControl _
                                            , .BookODControl = d.BookODControl _
                                            , .BookCarrierControl = d.BookCarrierControl _
                                            , .BookCarrierContact = d.BookCarrierContact _
                                            , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                            , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                            , .BookOrigName = d.BookOrigName _
                                            , .BookOrigAddress1 = d.BookOrigAddress1 _
                                            , .BookOrigAddress2 = d.BookOrigAddress2 _
                                            , .BookOrigAddress3 = d.BookOrigAddress3 _
                                            , .BookOrigCity = d.BookOrigCity _
                                            , .BookOrigState = d.BookOrigState _
                                            , .BookOrigCountry = d.BookOrigCountry _
                                            , .BookOrigZip = d.BookOrigZip _
                                            , .BookOrigPhone = d.BookOrigPhone _
                                            , .BookOrigFax = d.BookOrigFax _
                                            , .BookOriginStartHrs = d.BookOriginStartHrs _
                                            , .BookOriginStopHrs = d.BookOriginStopHrs _
                                            , .BookOriginApptReq = If(d.BookOriginApptReq.HasValue, d.BookOriginApptReq, False) _
                                            , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                            , .BookDestName = d.BookDestName _
                                            , .BookDestAddress1 = d.BookDestAddress1 _
                                            , .BookDestAddress2 = d.BookDestAddress2 _
                                            , .BookDestAddress3 = d.BookDestAddress3 _
                                            , .BookDestCity = d.BookDestCity _
                                            , .BookDestState = d.BookDestState _
                                            , .BookDestCountry = d.BookDestCountry _
                                            , .BookDestZip = d.BookDestZip _
                                            , .BookDestPhone = d.BookDestPhone _
                                            , .BookDestFax = d.BookDestFax _
                                            , .BookDestStartHrs = d.BookDestStartHrs _
                                            , .BookDestStopHrs = d.BookDestStopHrs _
                                            , .BookDestApptReq = If(d.BookDestApptReq.HasValue, d.BookDestApptReq, False) _
                                            , .BookDateOrdered = d.BookDateOrdered _
                                            , .BookDateLoad = d.BookDateLoad _
                                            , .BookDateInvoice = d.BookDateInvoice _
                                            , .BookDateRequired = d.BookDateRequired _
                                            , .BookDateDelivered = d.BookDateDelivered _
                                            , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                            , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                            , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                            , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                            , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                            , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                            , .BookTranCode = d.BookTranCode _
                                            , .BookPayCode = d.BookPayCode _
                                            , .BookTypeCode = d.BookTypeCode _
                                            , .BookBOLCode = d.BookBOLCode _
                                            , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                            , .BookCarrFBNumber = d.BookCarrFBNumber _
                                            , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                            , .BookCarrBLNumber = d.BookCarrBLNumber _
                                            , .BookCarrBookDate = d.BookCarrBookDate _
                                            , .BookCarrBookTime = d.BookCarrBookTime _
                                            , .BookCarrBookContact = d.BookCarrBookContact _
                                            , .BookCarrScheduleDate = d.BookCarrScheduleDate _
                                            , .BookCarrScheduleTime = d.BookCarrScheduleTime _
                                            , .BookCarrActualDate = d.BookCarrActualDate _
                                            , .BookCarrActualTime = d.BookCarrActualTime _
                                            , .BookCarrActLoadComplete_Date = d.BookCarrActLoadComplete_Date _
                                            , .BookCarrActLoadCompleteTime = d.BookCarrActLoadCompleteTime _
                                            , .BookCarrDockPUAssigment = d.BookCarrDockPUAssigment _
                                            , .BookCarrPODate = d.BookCarrPODate _
                                            , .BookCarrPOTime = d.BookCarrPOTime _
                                            , .BookCarrApptDate = d.BookCarrApptDate _
                                            , .BookCarrApptTime = d.BookCarrApptTime _
                                            , .BookCarrActDate = d.BookCarrActDate _
                                            , .BookCarrActTime = d.BookCarrActTime _
                                            , .BookCarrActUnloadCompDate = d.BookCarrActUnloadCompDate _
                                            , .BookCarrActUnloadCompTime = d.BookCarrActUnloadCompTime _
                                            , .BookCarrDockDelAssignment = d.BookCarrDockDelAssignment _
                                            , .BookCarrVarDay = If(d.BookCarrVarDay.HasValue, d.BookCarrVarDay, 0) _
                                            , .BookCarrVarHrs = If(d.BookCarrVarHrs.HasValue, d.BookCarrVarHrs, 0) _
                                            , .BookCarrTrailerNo = d.BookCarrTrailerNo _
                                            , .BookCarrSealNo = d.BookCarrSealNo _
                                            , .BookCarrDriverNo = d.BookCarrDriverNo _
                                            , .BookCarrDriverName = d.BookCarrDriverName _
                                            , .BookCarrRouteNo = d.BookCarrRouteNo _
                                            , .BookCarrTripNo = d.BookCarrTripNo _
                                            , .BookFinARBookFrt = If(d.BookFinARBookFrt.HasValue, d.BookFinARBookFrt, 0) _
                                            , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                            , .BookFinARInvoiceAmt = If(d.BookFinARInvoiceAmt.HasValue, d.BookFinARInvoiceAmt, 0) _
                                            , .BookFinARPayDate = d.BookFinARPayDate _
                                            , .BookFinARPayAmt = If(d.BookFinARPayAmt.HasValue, d.BookFinARPayAmt, 0) _
                                            , .BookFinARCheck = d.BookFinARCheck _
                                            , .BookFinARGLNumber = d.BookFinARGLNumber _
                                            , .BookFinARBalance = If(d.BookFinARBalance.HasValue, d.BookFinARBalance, 0) _
                                            , .BookFinARCurType = If(d.BookFinARCurType.HasValue, d.BookFinARCurType, 0) _
                                            , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                            , .BookFinAPBillNoDate = d.BookFinAPBillNoDate _
                                            , .BookFinAPBillInvDate = d.BookFinAPBillInvDate _
                                            , .BookFinAPActWgt = If(d.BookFinAPActWgt.HasValue, d.BookFinAPActWgt, 0) _
                                            , .BookFinAPStdCost = If(d.BookFinAPStdCost.HasValue, d.BookFinAPStdCost, 0) _
                                            , .BookFinAPActCost = If(d.BookFinAPActCost.HasValue, d.BookFinAPActCost, 0) _
                                            , .BookFinAPPayDate = d.BookFinAPPayDate _
                                            , .BookFinAPPayAmt = If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0) _
                                            , .BookFinAPCheck = d.BookFinAPCheck _
                                            , .BookFinAPGLNumber = d.BookFinAPGLNumber _
                                            , .BookFinAPLastViewed = d.BookFinAPLastViewed _
                                            , .BookFinAPCurType = If(d.BookFinAPCurType.HasValue, d.BookFinAPCurType, 0) _
                                            , .BookFinCommStd = If(d.BookFinCommStd.HasValue, d.BookFinCommStd, 0) _
                                            , .BookFinCommAct = If(d.BookFinCommAct.HasValue, d.BookFinCommAct, 0) _
                                            , .BookFinCommPayDate = d.BookFinCommPayDate _
                                            , .BookFinCommPayAmt = If(d.BookFinCommPayAmt.HasValue, d.BookFinCommPayAmt, 0) _
                                            , .BookFinCommtCheck = d.BookFinCommtCheck _
                                            , .BookFinCommCreditAmt = If(d.BookFinCommCreditAmt.HasValue, d.BookFinCommCreditAmt, 0) _
                                            , .BookFinCommCreditPayDate = d.BookFinCommCreditPayDate _
                                            , .BookFinCommLoadCount = If(d.BookFinCommLoadCount.HasValue, d.BookFinCommLoadCount, 0) _
                                            , .BookFinCommGLNumber = d.BookFinCommGLNumber _
                                            , .BookFinCheckClearedDate = d.BookFinCheckClearedDate _
                                            , .BookFinCheckClearedNumber = d.BookFinCheckClearedNumber _
                                            , .BookFinCheckClearedAmt = If(d.BookFinCheckClearedAmt.HasValue, d.BookFinCheckClearedAmt, 0) _
                                            , .BookFinCheckClearedDesc = d.BookFinCheckClearedDesc _
                                            , .BookFinCheckClearedAcct = d.BookFinCheckClearedAcct _
                                            , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                            , .BookRevCarrierCost = If(d.BookRevCarrierCost.HasValue, d.BookRevCarrierCost, 0) _
                                            , .BookRevStopQty = If(d.BookRevStopQty.HasValue, d.BookRevStopQty, 0) _
                                            , .BookRevStopCost = If(d.BookRevStopCost.HasValue, d.BookRevStopCost, 0) _
                                            , .BookRevOtherCost = If(d.BookRevOtherCost.HasValue, d.BookRevOtherCost, 0) _
                                            , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                            , .BookRevLoadSavings = If(d.BookRevLoadSavings.HasValue, d.BookRevLoadSavings, 0) _
                                            , .BookRevCommPercent = If(d.BookRevCommPercent.HasValue, d.BookRevCommPercent, 0) _
                                            , .BookRevCommCost = If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0) _
                                            , .BookRevGrossRevenue = If(d.BookRevGrossRevenue.HasValue, d.BookRevGrossRevenue, 0) _
                                            , .BookRevNegRevenue = If(d.BookRevNegRevenue.HasValue, d.BookRevNegRevenue, 0) _
                                            , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                            , .BookLaneCarrControl = If(d.BookLaneCarrControl.HasValue, d.BookLaneCarrControl, 0) _
                                            , .BookHoldLoad = If(d.BookHoldLoad.HasValue, d.BookHoldLoad, 0) _
                                            , .BookRouteFinalDate = d.BookRouteFinalDate _
                                            , .BookRouteFinalCode = d.BookRouteFinalCode _
                                            , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                            , .BookWarehouseNumber = d.BookWarehouseNumber _
                                            , .BookComCode = d.BookComCode _
                                            , .BookTransType = d.BookTransType _
                                            , .BookRouteConsFlag = d.BookRouteConsFlag _
                                            , .BookWhseAuthorizationNo = d.BookWhseAuthorizationNo _
                                            , .BookHotLoad = If(d.BookHotLoad.HasValue, d.BookHotLoad, False) _
                                            , .BookFinAPActTax = If(d.BookFinAPActTax.HasValue, d.BookFinAPActTax, 0) _
                                            , .BookFinAPExportFlag = d.BookFinAPExportFlag _
                                            , .BookFinARFreightTax = d.BookFinARFreightTax _
                                            , .BookRevFreightTax = d.BookRevFreightTax _
                                            , .BookRevNetCost = d.BookRevNetCost _
                                            , .BookFinServiceFee = If(d.BookFinServiceFee.HasValue, d.BookFinServiceFee, 0) _
                                            , .BookFinAPExportDate = d.BookFinAPExportDate _
                                            , .BookFinAPExportRetry = If(d.BookFinAPExportRetry.HasValue, d.BookFinAPExportRetry, 0) _
                                            , .BookCarrierContControl = If(d.BookCarrierContControl.HasValue, d.BookCarrierContControl, 0) _
                                            , .BookHotLoadSent = If(d.BookHotLoadSent.HasValue, d.BookHotLoadSent, False) _
                                            , .BookExportDocCreated = If(d.BookExportDocCreated.HasValue, d.BookExportDocCreated, False) _
                                            , .BookDoNotInvoice = d.BookDoNotInvoice _
                                            , .BookCarrStartLoadingDate = d.BookCarrStartLoadingDate _
                                            , .BookCarrStartLoadingTime = d.BookCarrStartLoadingTime _
                                            , .BookCarrFinishLoadingDate = d.BookCarrFinishLoadingDate _
                                            , .BookCarrFinishLoadingTime = d.BookCarrFinishLoadingTime _
                                            , .BookCarrStartUnloadingDate = d.BookCarrStartUnloadingDate _
                                            , .BookCarrStartUnloadingTime = d.BookCarrStartUnloadingTime _
                                            , .BookCarrFinishUnloadingDate = d.BookCarrFinishUnloadingDate _
                                            , .BookCarrFinishUnloadingTime = d.BookCarrFinishUnloadingTime _
                                            , .BookOrderSequence = d.BookOrderSequence _
                                            , .BookChepGLID = d.BookChepGLID _
                                            , .BookCarrierTypeCode = d.BookCarrierTypeCode _
                                            , .BookPalletPositions = d.BookPalletPositions _
                                            , .BookShipCarrierProNumber = d.BookShipCarrierProNumber _
                                            , .BookShipCarrierName = d.BookShipCarrierName _
                                            , .BookShipCarrierNumber = d.BookShipCarrierNumber _
                                            , .BookAPAdjReasonControl = d.BookAPAdjReasonControl _
                                            , .BookDateRequested = d.BookDateRequested _
                                            , .BookCarrierEquipmentCodes = d.BookCarrierEquipmentCodes _
                                            , .BookLockAllCosts = d.BookLockAllCosts _
                                            , .BookLockBFCCost = d.BookLockBFCCost _
                                            , .BookDestStopNumber = d.BookDestStopNumber _
                                            , .BookOrigStopNumber = d.BookOrigStopNumber _
                                            , .BookDestStopControl = d.BookDestStopControl _
                                            , .BookOrigStopControl = d.BookOrigStopControl _
                                            , .BookRouteTypeCode = d.BookRouteTypeCode _
                                            , .BookAlternateAddressLaneControl = d.BookAlternateAddressLaneControl _
                                            , .BookAlternateAddressLaneNumber = d.BookAlternateAddressLaneNumber _
                                            , .BookDefaultRouteSequence = d.BookDefaultRouteSequence _
                                            , .BookRouteGuideControl = d.BookRouteGuideControl _
                                            , .BookRouteGuideNumber = d.BookRouteGuideNumber _
                                            , .BookCustomerApprovalRecieved = d.BookCustomerApprovalRecieved _
                                            , .BookCustomerApprovalTransmitted = d.BookCustomerApprovalTransmitted _
                                            , .BookAMSPickupApptControl = d.BookAMSPickupApptControl _
                                            , .BookAMSDeliveryApptControl = d.BookAMSDeliveryApptControl _
                                            , .BookItemDetailDescription = d.BookItemDetailDescription _
                                            , .BookModDate = d.BookModDate _
                                            , .BookModUser = d.BookModUser _
                                            , .BookUpdated = d.BookUpdated.ToArray}).First

                Return Book

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBooksFiltered(Optional ByVal BookConsPrefix As String = "", _
                                          Optional ByVal BookCarrBLNumber As String = "", _
                                          Optional ByVal BookFinAPBillNumber As String = "", _
                                          Optional ByVal BookCarrOrderNumber As String = "", _
                                          Optional ByVal CompControl As Integer = 0, _
                                          Optional ByVal LaneControl As Integer = 0, _
                                          Optional ByVal CarrierControl As Integer = 0) As DTO.Book()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'db.Log = New DebugTextWriter

                'Test code for SQL Log
                'Dim oBooks() As DTO.Book = (From d In db.Books _
                'Where _
                '    (BookConsPrefix Is Nothing OrElse String.IsNullOrEmpty(BookConsPrefix) OrElse d.BookConsPrefix = BookConsPrefix) _
                '    And _
                '    (BookCarrBLNumber Is Nothing OrElse String.IsNullOrEmpty(BookCarrBLNumber) OrElse d.BookCarrBLNumber = BookCarrBLNumber) _
                '    And _
                '    (BookFinAPBillNumber Is Nothing OrElse String.IsNullOrEmpty(BookFinAPBillNumber) OrElse d.BookFinAPBillNumber = BookFinAPBillNumber) _
                '    And _
                '    (BookCarrOrderNumber Is Nothing OrElse String.IsNullOrEmpty(BookCarrOrderNumber) OrElse d.BookCarrOrderNumber = BookCarrOrderNumber) _
                '    And _
                '    (CompControl = 0 OrElse d.BookCustCompControl = CompControl) _
                '    And _
                '    (LaneControl = 0 OrElse d.BookODControl = LaneControl) _
                '    And _
                '    (CarrierControl = 0 OrElse d.BookCarrierControl = CarrierControl) _
                'Order By d.BookStopNo Ascending _
                'Select New DTO.Book With {.BookControl = d.BookControl, _
                '                          .BookProNumber = d.BookProNumber, _
                '                          .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                '                         }).Take(10).ToArray()



                Dim oDLO As New DataLoadOptions
                oDLO.LoadWith(Of LTS.Book)(Function(t As LTS.Book) t.BookLoads)
                oDLO.LoadWith(Of LTS.Book)(Function(t As LTS.Book) t.BookNotes)
                oDLO.LoadWith(Of LTS.Book)(Function(t As LTS.Book) t.BookTracks)
                oDLO.LoadWith(Of LTS.BookLoad)(Function(t As LTS.BookLoad) t.BookItems)
                db.LoadOptions = oDLO
                'Get the newest record that matches the provided criteria
                Dim Books() As DTO.Book = ( _
                From d In db.Books _
                Where _
                    (BookConsPrefix Is Nothing OrElse String.IsNullOrEmpty(BookConsPrefix) OrElse d.BookConsPrefix = BookConsPrefix) _
                    And _
                    (BookCarrBLNumber Is Nothing OrElse String.IsNullOrEmpty(BookCarrBLNumber) OrElse d.BookCarrBLNumber = BookCarrBLNumber) _
                    And _
                    (BookFinAPBillNumber Is Nothing OrElse String.IsNullOrEmpty(BookFinAPBillNumber) OrElse d.BookFinAPBillNumber = BookFinAPBillNumber) _
                    And _
                    (BookCarrOrderNumber Is Nothing OrElse String.IsNullOrEmpty(BookCarrOrderNumber) OrElse d.BookCarrOrderNumber = BookCarrOrderNumber) _
                    And _
                    (CompControl = 0 OrElse d.BookCustCompControl = CompControl) _
                    And _
                    (d.BookODControl = If(LaneControl = 0, d.BookODControl, LaneControl)) _
                    And _
                    (d.BookCarrierControl = If(CarrierControl = 0, d.BookCarrierControl, CarrierControl)) _
                Order By d.BookStopNo Ascending _
                Select New DTO.Book With {.BookControl = d.BookControl _
                                            , .BookProNumber = d.BookProNumber _
                                            , .BookProBase = d.BookProBase _
                                            , .BookConsPrefix = d.BookConsPrefix _
                                            , .BookCustCompControl = d.BookCustCompControl _
                                            , .BookCommCompControl = d.BookCommCompControl _
                                            , .BookODControl = d.BookODControl _
                                            , .BookCarrierControl = d.BookCarrierControl _
                                            , .BookCarrierContact = d.BookCarrierContact _
                                            , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                            , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                            , .BookOrigName = d.BookOrigName _
                                            , .BookOrigAddress1 = d.BookOrigAddress1 _
                                            , .BookOrigAddress2 = d.BookOrigAddress2 _
                                            , .BookOrigAddress3 = d.BookOrigAddress3 _
                                            , .BookOrigCity = d.BookOrigCity _
                                            , .BookOrigState = d.BookOrigState _
                                            , .BookOrigCountry = d.BookOrigCountry _
                                            , .BookOrigZip = d.BookOrigZip _
                                            , .BookOrigPhone = d.BookOrigPhone _
                                            , .BookOrigFax = d.BookOrigFax _
                                            , .BookOriginStartHrs = d.BookOriginStartHrs _
                                            , .BookOriginStopHrs = d.BookOriginStopHrs _
                                            , .BookOriginApptReq = If(d.BookOriginApptReq.HasValue, d.BookOriginApptReq, False) _
                                            , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                            , .BookDestName = d.BookDestName _
                                            , .BookDestAddress1 = d.BookDestAddress1 _
                                            , .BookDestAddress2 = d.BookDestAddress2 _
                                            , .BookDestAddress3 = d.BookDestAddress3 _
                                            , .BookDestCity = d.BookDestCity _
                                            , .BookDestState = d.BookDestState _
                                            , .BookDestCountry = d.BookDestCountry _
                                            , .BookDestZip = d.BookDestZip _
                                            , .BookDestPhone = d.BookDestPhone _
                                            , .BookDestFax = d.BookDestFax _
                                            , .BookDestStartHrs = d.BookDestStartHrs _
                                            , .BookDestStopHrs = d.BookDestStopHrs _
                                            , .BookDestApptReq = If(d.BookDestApptReq.HasValue, d.BookDestApptReq, False) _
                                            , .BookDateOrdered = d.BookDateOrdered _
                                            , .BookDateLoad = d.BookDateLoad _
                                            , .BookDateInvoice = d.BookDateInvoice _
                                            , .BookDateRequired = d.BookDateRequired _
                                            , .BookDateDelivered = d.BookDateDelivered _
                                            , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                            , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                            , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                            , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                            , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                            , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                            , .BookTranCode = d.BookTranCode _
                                            , .BookPayCode = d.BookPayCode _
                                            , .BookTypeCode = d.BookTypeCode _
                                            , .BookBOLCode = d.BookBOLCode _
                                            , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                            , .BookCarrFBNumber = d.BookCarrFBNumber _
                                            , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                            , .BookCarrBLNumber = d.BookCarrBLNumber _
                                            , .BookCarrBookDate = d.BookCarrBookDate _
                                            , .BookCarrBookTime = d.BookCarrBookTime _
                                            , .BookCarrBookContact = d.BookCarrBookContact _
                                            , .BookCarrScheduleDate = d.BookCarrScheduleDate _
                                            , .BookCarrScheduleTime = d.BookCarrScheduleTime _
                                            , .BookCarrActualDate = d.BookCarrActualDate _
                                            , .BookCarrActualTime = d.BookCarrActualTime _
                                            , .BookCarrActLoadComplete_Date = d.BookCarrActLoadComplete_Date _
                                            , .BookCarrActLoadCompleteTime = d.BookCarrActLoadCompleteTime _
                                            , .BookCarrDockPUAssigment = d.BookCarrDockPUAssigment _
                                            , .BookCarrPODate = d.BookCarrPODate _
                                            , .BookCarrPOTime = d.BookCarrPOTime _
                                            , .BookCarrApptDate = d.BookCarrApptDate _
                                            , .BookCarrApptTime = d.BookCarrApptTime _
                                            , .BookCarrActDate = d.BookCarrActDate _
                                            , .BookCarrActTime = d.BookCarrActTime _
                                            , .BookCarrActUnloadCompDate = d.BookCarrActUnloadCompDate _
                                            , .BookCarrActUnloadCompTime = d.BookCarrActUnloadCompTime _
                                            , .BookCarrDockDelAssignment = d.BookCarrDockDelAssignment _
                                            , .BookCarrVarDay = If(d.BookCarrVarDay.HasValue, d.BookCarrVarDay, 0) _
                                            , .BookCarrVarHrs = If(d.BookCarrVarHrs.HasValue, d.BookCarrVarHrs, 0) _
                                            , .BookCarrTrailerNo = d.BookCarrTrailerNo _
                                            , .BookCarrSealNo = d.BookCarrSealNo _
                                            , .BookCarrDriverNo = d.BookCarrDriverNo _
                                            , .BookCarrDriverName = d.BookCarrDriverName _
                                            , .BookCarrRouteNo = d.BookCarrRouteNo _
                                            , .BookCarrTripNo = d.BookCarrTripNo _
                                            , .BookFinARBookFrt = If(d.BookFinARBookFrt.HasValue, d.BookFinARBookFrt, 0) _
                                            , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                            , .BookFinARInvoiceAmt = If(d.BookFinARInvoiceAmt.HasValue, d.BookFinARInvoiceAmt, 0) _
                                            , .BookFinARPayDate = d.BookFinARPayDate _
                                            , .BookFinARPayAmt = If(d.BookFinARPayAmt.HasValue, d.BookFinARPayAmt, 0) _
                                            , .BookFinARCheck = d.BookFinARCheck _
                                            , .BookFinARGLNumber = d.BookFinARGLNumber _
                                            , .BookFinARBalance = If(d.BookFinARBalance.HasValue, d.BookFinARBalance, 0) _
                                            , .BookFinARCurType = If(d.BookFinARCurType.HasValue, d.BookFinARCurType, 0) _
                                            , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                            , .BookFinAPBillNoDate = d.BookFinAPBillNoDate _
                                            , .BookFinAPBillInvDate = d.BookFinAPBillInvDate _
                                            , .BookFinAPActWgt = If(d.BookFinAPActWgt.HasValue, d.BookFinAPActWgt, 0) _
                                            , .BookFinAPStdCost = If(d.BookFinAPStdCost.HasValue, d.BookFinAPStdCost, 0) _
                                            , .BookFinAPActCost = If(d.BookFinAPActCost.HasValue, d.BookFinAPActCost, 0) _
                                            , .BookFinAPPayDate = d.BookFinAPPayDate _
                                            , .BookFinAPPayAmt = If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0) _
                                            , .BookFinAPCheck = d.BookFinAPCheck _
                                            , .BookFinAPGLNumber = d.BookFinAPGLNumber _
                                            , .BookFinAPLastViewed = d.BookFinAPLastViewed _
                                            , .BookFinAPCurType = If(d.BookFinAPCurType.HasValue, d.BookFinAPCurType, 0) _
                                            , .BookFinCommStd = If(d.BookFinCommStd.HasValue, d.BookFinCommStd, 0) _
                                            , .BookFinCommAct = If(d.BookFinCommAct.HasValue, d.BookFinCommAct, 0) _
                                            , .BookFinCommPayDate = d.BookFinCommPayDate _
                                            , .BookFinCommPayAmt = If(d.BookFinCommPayAmt.HasValue, d.BookFinCommPayAmt, 0) _
                                            , .BookFinCommtCheck = d.BookFinCommtCheck _
                                            , .BookFinCommCreditAmt = If(d.BookFinCommCreditAmt.HasValue, d.BookFinCommCreditAmt, 0) _
                                            , .BookFinCommCreditPayDate = d.BookFinCommCreditPayDate _
                                            , .BookFinCommLoadCount = If(d.BookFinCommLoadCount.HasValue, d.BookFinCommLoadCount, 0) _
                                            , .BookFinCommGLNumber = d.BookFinCommGLNumber _
                                            , .BookFinCheckClearedDate = d.BookFinCheckClearedDate _
                                            , .BookFinCheckClearedNumber = d.BookFinCheckClearedNumber _
                                            , .BookFinCheckClearedAmt = If(d.BookFinCheckClearedAmt.HasValue, d.BookFinCheckClearedAmt, 0) _
                                            , .BookFinCheckClearedDesc = d.BookFinCheckClearedDesc _
                                            , .BookFinCheckClearedAcct = d.BookFinCheckClearedAcct _
                                            , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                            , .BookRevCarrierCost = If(d.BookRevCarrierCost.HasValue, d.BookRevCarrierCost, 0) _
                                            , .BookRevStopQty = If(d.BookRevStopQty.HasValue, d.BookRevStopQty, 0) _
                                            , .BookRevStopCost = If(d.BookRevStopCost.HasValue, d.BookRevStopCost, 0) _
                                            , .BookRevOtherCost = If(d.BookRevOtherCost.HasValue, d.BookRevOtherCost, 0) _
                                            , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                            , .BookRevLoadSavings = If(d.BookRevLoadSavings.HasValue, d.BookRevLoadSavings, 0) _
                                            , .BookRevCommPercent = If(d.BookRevCommPercent.HasValue, d.BookRevCommPercent, 0) _
                                            , .BookRevCommCost = If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0) _
                                            , .BookRevGrossRevenue = If(d.BookRevGrossRevenue.HasValue, d.BookRevGrossRevenue, 0) _
                                            , .BookRevNegRevenue = If(d.BookRevNegRevenue.HasValue, d.BookRevNegRevenue, 0) _
                                            , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                            , .BookLaneCarrControl = If(d.BookLaneCarrControl.HasValue, d.BookLaneCarrControl, 0) _
                                            , .BookHoldLoad = If(d.BookHoldLoad.HasValue, d.BookHoldLoad, 0) _
                                            , .BookRouteFinalDate = d.BookRouteFinalDate _
                                            , .BookRouteFinalCode = d.BookRouteFinalCode _
                                            , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                            , .BookWarehouseNumber = d.BookWarehouseNumber _
                                            , .BookComCode = d.BookComCode _
                                            , .BookTransType = d.BookTransType _
                                            , .BookRouteConsFlag = d.BookRouteConsFlag _
                                            , .BookWhseAuthorizationNo = d.BookWhseAuthorizationNo _
                                            , .BookHotLoad = If(d.BookHotLoad.HasValue, d.BookHotLoad, False) _
                                            , .BookFinAPActTax = If(d.BookFinAPActTax.HasValue, d.BookFinAPActTax, 0) _
                                            , .BookFinAPExportFlag = d.BookFinAPExportFlag _
                                            , .BookFinARFreightTax = d.BookFinARFreightTax _
                                            , .BookRevFreightTax = d.BookRevFreightTax _
                                            , .BookRevNetCost = d.BookRevNetCost _
                                            , .BookFinServiceFee = If(d.BookFinServiceFee.HasValue, d.BookFinServiceFee, 0) _
                                            , .BookFinAPExportDate = d.BookFinAPExportDate _
                                            , .BookFinAPExportRetry = If(d.BookFinAPExportRetry.HasValue, d.BookFinAPExportRetry, 0) _
                                            , .BookCarrierContControl = If(d.BookCarrierContControl.HasValue, d.BookCarrierContControl, 0) _
                                            , .BookHotLoadSent = If(d.BookHotLoadSent.HasValue, d.BookHotLoadSent, False) _
                                            , .BookExportDocCreated = If(d.BookExportDocCreated.HasValue, d.BookExportDocCreated, False) _
                                            , .BookDoNotInvoice = d.BookDoNotInvoice _
                                            , .BookCarrStartLoadingDate = d.BookCarrStartLoadingDate _
                                            , .BookCarrStartLoadingTime = d.BookCarrStartLoadingTime _
                                            , .BookCarrFinishLoadingDate = d.BookCarrFinishLoadingDate _
                                            , .BookCarrFinishLoadingTime = d.BookCarrFinishLoadingTime _
                                            , .BookCarrStartUnloadingDate = d.BookCarrStartUnloadingDate _
                                            , .BookCarrStartUnloadingTime = d.BookCarrStartUnloadingTime _
                                            , .BookCarrFinishUnloadingDate = d.BookCarrFinishUnloadingDate _
                                            , .BookCarrFinishUnloadingTime = d.BookCarrFinishUnloadingTime _
                                            , .BookOrderSequence = d.BookOrderSequence _
                                            , .BookChepGLID = d.BookChepGLID _
                                            , .BookCarrierTypeCode = d.BookCarrierTypeCode _
                                            , .BookPalletPositions = d.BookPalletPositions _
                                            , .BookShipCarrierProNumber = d.BookShipCarrierProNumber _
                                            , .BookShipCarrierName = d.BookShipCarrierName _
                                            , .BookShipCarrierNumber = d.BookShipCarrierNumber _
                                            , .BookAPAdjReasonControl = d.BookAPAdjReasonControl _
                                            , .BookDateRequested = d.BookDateRequested _
                                            , .BookCarrierEquipmentCodes = d.BookCarrierEquipmentCodes _
                                            , .BookLockAllCosts = d.BookLockAllCosts _
                                            , .BookLockBFCCost = d.BookLockBFCCost _
                                            , .BookDestStopNumber = d.BookDestStopNumber _
                                            , .BookOrigStopNumber = d.BookOrigStopNumber _
                                            , .BookDestStopControl = d.BookDestStopControl _
                                            , .BookOrigStopControl = d.BookOrigStopControl _
                                            , .BookRouteTypeCode = d.BookRouteTypeCode _
                                            , .BookAlternateAddressLaneControl = d.BookAlternateAddressLaneControl _
                                            , .BookAlternateAddressLaneNumber = d.BookAlternateAddressLaneNumber _
                                            , .BookDefaultRouteSequence = d.BookDefaultRouteSequence _
                                            , .BookRouteGuideControl = d.BookRouteGuideControl _
                                            , .BookRouteGuideNumber = d.BookRouteGuideNumber _
                                            , .BookCustomerApprovalRecieved = d.BookCustomerApprovalRecieved _
                                            , .BookCustomerApprovalTransmitted = d.BookCustomerApprovalTransmitted _
                                            , .BookAMSPickupApptControl = d.BookAMSPickupApptControl _
                                            , .BookAMSDeliveryApptControl = d.BookAMSDeliveryApptControl _
                                            , .BookItemDetailDescription = d.BookItemDetailDescription _
                                            , .BookModDate = d.BookModDate _
                                            , .BookModUser = d.BookModUser _
                                            , .BookUpdated = d.BookUpdated.ToArray _
                                              , .BookLoads = ( _
                                                    From c In d.BookLoads _
                                                    Select New DTO.BookLoad With {.BookLoadControl = c.BookLoadControl _
                                                    , .BookLoadBookControl = c.BookLoadBookControl _
                                                    , .BookLoadBuy = c.BookLoadBuy _
                                                    , .BookLoadPONumber = c.BookLoadPONumber _
                                                    , .BookLoadVendor = c.BookLoadVendor _
                                                    , .BookLoadCaseQty = If(c.BookLoadCaseQty.HasValue, c.BookLoadCaseQty, 0) _
                                                    , .BookLoadWgt = If(c.BookLoadWgt.HasValue, c.BookLoadWgt, 0) _
                                                    , .BookLoadCube = If(c.BookLoadCube.HasValue, c.BookLoadCube, 0) _
                                                    , .BookLoadPL = If(c.BookLoadPL.HasValue, c.BookLoadPL, 0) _
                                                    , .BookLoadPX = If(c.BookLoadPX.HasValue, c.BookLoadPX, 0) _
                                                    , .BookLoadPType = c.BookLoadPType _
                                                    , .BookLoadCom = c.BookLoadCom _
                                                    , .BookLoadPUOrigin = c.BookLoadPUOrigin _
                                                    , .BookLoadBFC = If(c.BookLoadBFC.HasValue, c.BookLoadBFC, 0) _
                                                    , .BookLoadTotCost = If(c.BookLoadTotCost.HasValue, c.BookLoadTotCost, 0) _
                                                    , .BookLoadComments = c.BookLoadComments _
                                                    , .BookLoadStopSeq = If(c.BookLoadStopSeq.HasValue, c.BookLoadStopSeq, 0) _
                                                    , .BookLoadModDate = c.BookLoadModDate _
                                                    , .BookLoadModUser = c.BookLoadModUser _
                                                    , .BookLoadUpdated = c.BookLoadUpdated.ToArray() _
                                                    , .BookItems = ( _
                                                        From i In c.BookItems _
                                                        Select New DTO.BookItem With {.BookItemControl = i.BookItemControl _
                                                       , .BookItemBookLoadControl = i.BookItemBookLoadControl _
                                                       , .BookItemFixOffInvAllow = If(i.BookItemFixOffInvAllow.HasValue, i.BookItemFixOffInvAllow, 0) _
                                                       , .BookItemFixFrtAllow = If(i.BookItemFixFrtAllow.HasValue, i.BookItemFixFrtAllow, 0) _
                                                       , .BookItemItemNumber = i.BookItemItemNumber _
                                                       , .BookItemQtyOrdered = If(i.BookItemQtyOrdered.HasValue, i.BookItemQtyOrdered, 0) _
                                                       , .BookItemFreightCost = If(i.BookItemFreightCost.HasValue, i.BookItemFreightCost, 0) _
                                                       , .BookItemItemCost = If(i.BookItemItemCost.HasValue, i.BookItemItemCost, 0) _
                                                       , .BookItemWeight = If(i.BookItemWeight.HasValue, i.BookItemWeight, 0) _
                                                       , .BookItemCube = If(i.BookItemCube.HasValue, i.BookItemCube, 0) _
                                                       , .BookItemPack = If(i.BookItemPack.HasValue, i.BookItemPack, 0) _
                                                       , .BookItemSize = i.BookItemSize _
                                                       , .BookItemDescription = i.BookItemDescription _
                                                       , .BookItemHazmat = i.BookItemHazmat _
                                                       , .BookItemModDate = i.BookItemModDate _
                                                       , .BookItemModUser = i.BookItemModUser _
                                                       , .BookItemBrand = i.BookItemBrand _
                                                       , .BookItemCostCenter = i.BookItemCostCenter _
                                                       , .BookItemLotNumber = i.BookItemLotNumber _
                                                       , .BookItemLotExpirationDate = i.BookItemLotExpirationDate _
                                                       , .BookItemGTIN = i.BookItemGTIN _
                                                       , .BookCustItemNumber = i.BookCustItemNumber _
                                                       , .BookItemBFC = If(i.BookItemBFC.HasValue, i.BookItemBFC, 0) _
                                                       , .BookItemCountryOfOrigin = i.BookItemCountryOfOrigin _
                                                       , .BookItemHST = i.BookItemHST _
                                                       , .BookItemPalletTypeID = i.BookItemPalletTypeID _
                                                       , .BookItemHazmatTypeCode = i.BookItemHazmatTypeCode _
                                                       , .BookItem49CFRCode = i.BookItem49CFRCode _
                                                       , .BookItemIATACode = i.BookItemIATACode _
                                                       , .BookItemDOTCode = i.BookItemDOTCode _
                                                       , .BookItemMarineCode = i.BookItemMarineCode _
                                                       , .BookItemNMFCClass = i.BookItemNMFCClass _
                                                       , .BookItemFAKClass = i.BookItemFAKClass _
                                                       , .BookItemLimitedQtyFlag = i.BookItemLimitedQtyFlag _
                                                       , .BookItemPallets = i.BookItemPallets _
                                                       , .BookItemTies = i.BookItemTies _
                                                       , .BookItemHighs = i.BookItemHighs _
                                                       , .BookItemQtyPalletPercentage = i.BookItemQtyPalletPercentage _
                                                       , .BookItemQtyLength = i.BookItemQtyLength _
                                                       , .BookItemQtyWidth = i.BookItemQtyWidth _
                                                       , .BookItemQtyHeight = i.BookItemQtyHeight _
                                                       , .BookItemStackable = i.BookItemStackable _
                                                       , .BookItemLevelOfDensity = i.BookItemLevelOfDensity _
                                                       , .BookItemUpdated = i.BookItemUpdated.ToArray()}).ToList() _
                                                }).ToList() _
                                            , .BookNotes = ( _
                                                    From c In d.BookNotes _
                                                    Select New DTO.BookNote With {.BookNotesControl = c.BookNotesControl _
                                                    , .BookNotesBookControl = c.BookNotesBookControl _
                                                    , .BookNotesVisable1 = c.BookNotesVisable1 _
                                                    , .BookNotesVisable2 = c.BookNotesVisable2 _
                                                    , .BookNotesVisable3 = c.BookNotesVisable3 _
                                                    , .BookNotesVisable4 = c.BookNotesVisable4 _
                                                    , .BookNotesVisable5 = c.BookNotesVisable5 _
                                                    , .BookNotesConfidential1 = c.BookNotesConfidential1 _
                                                    , .BookNotesConfidential2 = c.BookNotesConfidential2 _
                                                    , .BookNotesConfidential3 = c.BookNotesConfidential3 _
                                                    , .BookNotesConfidential4 = c.BookNotesConfidential4 _
                                                    , .BookNotesConfidential5 = c.BookNotesConfidential5 _
                                                    , .BookNotesModDate = c.BookNotesModDate _
                                                    , .BookNotesModUser = c.BookNotesModUser _
                                                    , .BookNotesUpdated = c.BookNotesUpdated.ToArray()}).ToList() _
                                            , .BookTracks = ( _
                                                    From c In d.BookTracks _
                                                    Select New DTO.BookTrack With {.BookTrackControl = c.BookTrackControl _
                                                    , .BookTrackBookControl = c.BookTrackBookControl _
                                                    , .BookTrackDate = c.BookTrackDate _
                                                    , .BookTrackContact = c.BookTrackContact _
                                                    , .BookTrackComment = c.BookTrackComment _
                                                    , .BookTrackStatus = If(c.BookTrackStatus.HasValue, c.BookTrackStatus, 0) _
                                                    , .BookTrackModDate = c.BookTrackModDate _
                                                    , .BookTrackModUser = c.BookTrackModUser _
                                                    , .BookTrackUpdated = c.BookTrackUpdated.ToArray()}).ToList() _
                                              }).Take(20).ToArray()

                Return Books

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBooksFilteredNoChildren(Optional ByVal BookConsPrefix As String = "", _
                                         Optional ByVal BookCarrBLNumber As String = "", _
                                         Optional ByVal BookFinAPBillNumber As String = "", _
                                         Optional ByVal BookCarrOrderNumber As String = "", _
                                         Optional ByVal CompControl As Integer = 0, _
                                         Optional ByVal LaneControl As Integer = 0, _
                                         Optional ByVal CarrierControl As Integer = 0) As DTO.Book()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                Dim oDLO As New DataLoadOptions
                oDLO.LoadWith(Of LTS.Book)(Function(t As LTS.Book) t.BookLoads)
                oDLO.LoadWith(Of LTS.Book)(Function(t As LTS.Book) t.BookNotes)
                oDLO.LoadWith(Of LTS.Book)(Function(t As LTS.Book) t.BookTracks)
                oDLO.LoadWith(Of LTS.BookLoad)(Function(t As LTS.BookLoad) t.BookItems)
                db.LoadOptions = oDLO
                'Get the newest record that matches the provided criteria
                Dim Books() As DTO.Book = ( _
                From d In db.Books _
                Where _
                    (BookConsPrefix Is Nothing OrElse String.IsNullOrEmpty(BookConsPrefix) OrElse d.BookConsPrefix = BookConsPrefix) _
                    And _
                    (BookCarrBLNumber Is Nothing OrElse String.IsNullOrEmpty(BookCarrBLNumber) OrElse d.BookCarrBLNumber = BookCarrBLNumber) _
                    And _
                    (BookFinAPBillNumber Is Nothing OrElse String.IsNullOrEmpty(BookFinAPBillNumber) OrElse d.BookFinAPBillNumber = BookFinAPBillNumber) _
                    And _
                    (BookCarrOrderNumber Is Nothing OrElse String.IsNullOrEmpty(BookCarrOrderNumber) OrElse d.BookCarrOrderNumber = BookCarrOrderNumber) _
                    And _
                    (CompControl = 0 OrElse d.BookCustCompControl = CompControl) _
                    And _
                    (d.BookODControl = If(LaneControl = 0, d.BookODControl, LaneControl)) _
                    And _
                    (d.BookCarrierControl = If(CarrierControl = 0, d.BookCarrierControl, CarrierControl)) _
                Order By d.BookStopNo Ascending _
                Select New DTO.Book With {.BookControl = d.BookControl _
                                            , .BookProNumber = d.BookProNumber _
                                            , .BookProBase = d.BookProBase _
                                            , .BookConsPrefix = d.BookConsPrefix _
                                            , .BookCustCompControl = d.BookCustCompControl _
                                            , .BookCommCompControl = d.BookCommCompControl _
                                            , .BookODControl = d.BookODControl _
                                            , .BookCarrierControl = d.BookCarrierControl _
                                            , .BookCarrierContact = d.BookCarrierContact _
                                            , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                            , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                            , .BookOrigName = d.BookOrigName _
                                            , .BookOrigAddress1 = d.BookOrigAddress1 _
                                            , .BookOrigAddress2 = d.BookOrigAddress2 _
                                            , .BookOrigAddress3 = d.BookOrigAddress3 _
                                            , .BookOrigCity = d.BookOrigCity _
                                            , .BookOrigState = d.BookOrigState _
                                            , .BookOrigCountry = d.BookOrigCountry _
                                            , .BookOrigZip = d.BookOrigZip _
                                            , .BookOrigPhone = d.BookOrigPhone _
                                            , .BookOrigFax = d.BookOrigFax _
                                            , .BookOriginStartHrs = d.BookOriginStartHrs _
                                            , .BookOriginStopHrs = d.BookOriginStopHrs _
                                            , .BookOriginApptReq = If(d.BookOriginApptReq.HasValue, d.BookOriginApptReq, False) _
                                            , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                            , .BookDestName = d.BookDestName _
                                            , .BookDestAddress1 = d.BookDestAddress1 _
                                            , .BookDestAddress2 = d.BookDestAddress2 _
                                            , .BookDestAddress3 = d.BookDestAddress3 _
                                            , .BookDestCity = d.BookDestCity _
                                            , .BookDestState = d.BookDestState _
                                            , .BookDestCountry = d.BookDestCountry _
                                            , .BookDestZip = d.BookDestZip _
                                            , .BookDestPhone = d.BookDestPhone _
                                            , .BookDestFax = d.BookDestFax _
                                            , .BookDestStartHrs = d.BookDestStartHrs _
                                            , .BookDestStopHrs = d.BookDestStopHrs _
                                            , .BookDestApptReq = If(d.BookDestApptReq.HasValue, d.BookDestApptReq, False) _
                                            , .BookDateOrdered = d.BookDateOrdered _
                                            , .BookDateLoad = d.BookDateLoad _
                                            , .BookDateInvoice = d.BookDateInvoice _
                                            , .BookDateRequired = d.BookDateRequired _
                                            , .BookDateDelivered = d.BookDateDelivered _
                                            , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                            , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                            , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                            , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                            , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                            , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                            , .BookTranCode = d.BookTranCode _
                                            , .BookPayCode = d.BookPayCode _
                                            , .BookTypeCode = d.BookTypeCode _
                                            , .BookBOLCode = d.BookBOLCode _
                                            , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                            , .BookCarrFBNumber = d.BookCarrFBNumber _
                                            , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                            , .BookCarrBLNumber = d.BookCarrBLNumber _
                                            , .BookCarrBookDate = d.BookCarrBookDate _
                                            , .BookCarrBookTime = d.BookCarrBookTime _
                                            , .BookCarrBookContact = d.BookCarrBookContact _
                                            , .BookCarrScheduleDate = d.BookCarrScheduleDate _
                                            , .BookCarrScheduleTime = d.BookCarrScheduleTime _
                                            , .BookCarrActualDate = d.BookCarrActualDate _
                                            , .BookCarrActualTime = d.BookCarrActualTime _
                                            , .BookCarrActLoadComplete_Date = d.BookCarrActLoadComplete_Date _
                                            , .BookCarrActLoadCompleteTime = d.BookCarrActLoadCompleteTime _
                                            , .BookCarrDockPUAssigment = d.BookCarrDockPUAssigment _
                                            , .BookCarrPODate = d.BookCarrPODate _
                                            , .BookCarrPOTime = d.BookCarrPOTime _
                                            , .BookCarrApptDate = d.BookCarrApptDate _
                                            , .BookCarrApptTime = d.BookCarrApptTime _
                                            , .BookCarrActDate = d.BookCarrActDate _
                                            , .BookCarrActTime = d.BookCarrActTime _
                                            , .BookCarrActUnloadCompDate = d.BookCarrActUnloadCompDate _
                                            , .BookCarrActUnloadCompTime = d.BookCarrActUnloadCompTime _
                                            , .BookCarrDockDelAssignment = d.BookCarrDockDelAssignment _
                                            , .BookCarrVarDay = If(d.BookCarrVarDay.HasValue, d.BookCarrVarDay, 0) _
                                            , .BookCarrVarHrs = If(d.BookCarrVarHrs.HasValue, d.BookCarrVarHrs, 0) _
                                            , .BookCarrTrailerNo = d.BookCarrTrailerNo _
                                            , .BookCarrSealNo = d.BookCarrSealNo _
                                            , .BookCarrDriverNo = d.BookCarrDriverNo _
                                            , .BookCarrDriverName = d.BookCarrDriverName _
                                            , .BookCarrRouteNo = d.BookCarrRouteNo _
                                            , .BookCarrTripNo = d.BookCarrTripNo _
                                            , .BookFinARBookFrt = If(d.BookFinARBookFrt.HasValue, d.BookFinARBookFrt, 0) _
                                            , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                            , .BookFinARInvoiceAmt = If(d.BookFinARInvoiceAmt.HasValue, d.BookFinARInvoiceAmt, 0) _
                                            , .BookFinARPayDate = d.BookFinARPayDate _
                                            , .BookFinARPayAmt = If(d.BookFinARPayAmt.HasValue, d.BookFinARPayAmt, 0) _
                                            , .BookFinARCheck = d.BookFinARCheck _
                                            , .BookFinARGLNumber = d.BookFinARGLNumber _
                                            , .BookFinARBalance = If(d.BookFinARBalance.HasValue, d.BookFinARBalance, 0) _
                                            , .BookFinARCurType = If(d.BookFinARCurType.HasValue, d.BookFinARCurType, 0) _
                                            , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                            , .BookFinAPBillNoDate = d.BookFinAPBillNoDate _
                                            , .BookFinAPBillInvDate = d.BookFinAPBillInvDate _
                                            , .BookFinAPActWgt = If(d.BookFinAPActWgt.HasValue, d.BookFinAPActWgt, 0) _
                                            , .BookFinAPStdCost = If(d.BookFinAPStdCost.HasValue, d.BookFinAPStdCost, 0) _
                                            , .BookFinAPActCost = If(d.BookFinAPActCost.HasValue, d.BookFinAPActCost, 0) _
                                            , .BookFinAPPayDate = d.BookFinAPPayDate _
                                            , .BookFinAPPayAmt = If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0) _
                                            , .BookFinAPCheck = d.BookFinAPCheck _
                                            , .BookFinAPGLNumber = d.BookFinAPGLNumber _
                                            , .BookFinAPLastViewed = d.BookFinAPLastViewed _
                                            , .BookFinAPCurType = If(d.BookFinAPCurType.HasValue, d.BookFinAPCurType, 0) _
                                            , .BookFinCommStd = If(d.BookFinCommStd.HasValue, d.BookFinCommStd, 0) _
                                            , .BookFinCommAct = If(d.BookFinCommAct.HasValue, d.BookFinCommAct, 0) _
                                            , .BookFinCommPayDate = d.BookFinCommPayDate _
                                            , .BookFinCommPayAmt = If(d.BookFinCommPayAmt.HasValue, d.BookFinCommPayAmt, 0) _
                                            , .BookFinCommtCheck = d.BookFinCommtCheck _
                                            , .BookFinCommCreditAmt = If(d.BookFinCommCreditAmt.HasValue, d.BookFinCommCreditAmt, 0) _
                                            , .BookFinCommCreditPayDate = d.BookFinCommCreditPayDate _
                                            , .BookFinCommLoadCount = If(d.BookFinCommLoadCount.HasValue, d.BookFinCommLoadCount, 0) _
                                            , .BookFinCommGLNumber = d.BookFinCommGLNumber _
                                            , .BookFinCheckClearedDate = d.BookFinCheckClearedDate _
                                            , .BookFinCheckClearedNumber = d.BookFinCheckClearedNumber _
                                            , .BookFinCheckClearedAmt = If(d.BookFinCheckClearedAmt.HasValue, d.BookFinCheckClearedAmt, 0) _
                                            , .BookFinCheckClearedDesc = d.BookFinCheckClearedDesc _
                                            , .BookFinCheckClearedAcct = d.BookFinCheckClearedAcct _
                                            , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                            , .BookRevCarrierCost = If(d.BookRevCarrierCost.HasValue, d.BookRevCarrierCost, 0) _
                                            , .BookRevStopQty = If(d.BookRevStopQty.HasValue, d.BookRevStopQty, 0) _
                                            , .BookRevStopCost = If(d.BookRevStopCost.HasValue, d.BookRevStopCost, 0) _
                                            , .BookRevOtherCost = If(d.BookRevOtherCost.HasValue, d.BookRevOtherCost, 0) _
                                            , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                            , .BookRevLoadSavings = If(d.BookRevLoadSavings.HasValue, d.BookRevLoadSavings, 0) _
                                            , .BookRevCommPercent = If(d.BookRevCommPercent.HasValue, d.BookRevCommPercent, 0) _
                                            , .BookRevCommCost = If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0) _
                                            , .BookRevGrossRevenue = If(d.BookRevGrossRevenue.HasValue, d.BookRevGrossRevenue, 0) _
                                            , .BookRevNegRevenue = If(d.BookRevNegRevenue.HasValue, d.BookRevNegRevenue, 0) _
                                            , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                            , .BookLaneCarrControl = If(d.BookLaneCarrControl.HasValue, d.BookLaneCarrControl, 0) _
                                            , .BookHoldLoad = If(d.BookHoldLoad.HasValue, d.BookHoldLoad, 0) _
                                            , .BookRouteFinalDate = d.BookRouteFinalDate _
                                            , .BookRouteFinalCode = d.BookRouteFinalCode _
                                            , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                            , .BookWarehouseNumber = d.BookWarehouseNumber _
                                            , .BookComCode = d.BookComCode _
                                            , .BookTransType = d.BookTransType _
                                            , .BookRouteConsFlag = d.BookRouteConsFlag _
                                            , .BookWhseAuthorizationNo = d.BookWhseAuthorizationNo _
                                            , .BookHotLoad = If(d.BookHotLoad.HasValue, d.BookHotLoad, False) _
                                            , .BookFinAPActTax = If(d.BookFinAPActTax.HasValue, d.BookFinAPActTax, 0) _
                                            , .BookFinAPExportFlag = d.BookFinAPExportFlag _
                                            , .BookFinARFreightTax = d.BookFinARFreightTax _
                                            , .BookRevFreightTax = d.BookRevFreightTax _
                                            , .BookRevNetCost = d.BookRevNetCost _
                                            , .BookFinServiceFee = If(d.BookFinServiceFee.HasValue, d.BookFinServiceFee, 0) _
                                            , .BookFinAPExportDate = d.BookFinAPExportDate _
                                            , .BookFinAPExportRetry = If(d.BookFinAPExportRetry.HasValue, d.BookFinAPExportRetry, 0) _
                                            , .BookCarrierContControl = If(d.BookCarrierContControl.HasValue, d.BookCarrierContControl, 0) _
                                            , .BookHotLoadSent = If(d.BookHotLoadSent.HasValue, d.BookHotLoadSent, False) _
                                            , .BookExportDocCreated = If(d.BookExportDocCreated.HasValue, d.BookExportDocCreated, False) _
                                            , .BookDoNotInvoice = d.BookDoNotInvoice _
                                            , .BookCarrStartLoadingDate = d.BookCarrStartLoadingDate _
                                            , .BookCarrStartLoadingTime = d.BookCarrStartLoadingTime _
                                            , .BookCarrFinishLoadingDate = d.BookCarrFinishLoadingDate _
                                            , .BookCarrFinishLoadingTime = d.BookCarrFinishLoadingTime _
                                            , .BookCarrStartUnloadingDate = d.BookCarrStartUnloadingDate _
                                            , .BookCarrStartUnloadingTime = d.BookCarrStartUnloadingTime _
                                            , .BookCarrFinishUnloadingDate = d.BookCarrFinishUnloadingDate _
                                            , .BookCarrFinishUnloadingTime = d.BookCarrFinishUnloadingTime _
                                            , .BookOrderSequence = d.BookOrderSequence _
                                            , .BookChepGLID = d.BookChepGLID _
                                            , .BookCarrierTypeCode = d.BookCarrierTypeCode _
                                            , .BookPalletPositions = d.BookPalletPositions _
                                            , .BookShipCarrierProNumber = d.BookShipCarrierProNumber _
                                            , .BookShipCarrierName = d.BookShipCarrierName _
                                            , .BookShipCarrierNumber = d.BookShipCarrierNumber _
                                            , .BookAPAdjReasonControl = d.BookAPAdjReasonControl _
                                            , .BookDateRequested = d.BookDateRequested _
                                            , .BookCarrierEquipmentCodes = d.BookCarrierEquipmentCodes _
                                            , .BookLockAllCosts = d.BookLockAllCosts _
                                            , .BookLockBFCCost = d.BookLockBFCCost _
                                            , .BookDestStopNumber = d.BookDestStopNumber _
                                            , .BookOrigStopNumber = d.BookOrigStopNumber _
                                            , .BookDestStopControl = d.BookDestStopControl _
                                            , .BookOrigStopControl = d.BookOrigStopControl _
                                            , .BookRouteTypeCode = d.BookRouteTypeCode _
                                            , .BookAlternateAddressLaneControl = d.BookAlternateAddressLaneControl _
                                            , .BookAlternateAddressLaneNumber = d.BookAlternateAddressLaneNumber _
                                            , .BookDefaultRouteSequence = d.BookDefaultRouteSequence _
                                            , .BookRouteGuideControl = d.BookRouteGuideControl _
                                            , .BookRouteGuideNumber = d.BookRouteGuideNumber _
                                            , .BookCustomerApprovalRecieved = d.BookCustomerApprovalRecieved _
                                            , .BookCustomerApprovalTransmitted = d.BookCustomerApprovalTransmitted _
                                            , .BookAMSPickupApptControl = d.BookAMSPickupApptControl _
                                            , .BookAMSDeliveryApptControl = d.BookAMSDeliveryApptControl _
                                            , .BookItemDetailDescription = d.BookItemDetailDescription _
                                            , .BookModDate = d.BookModDate _
                                            , .BookModUser = d.BookModUser _
                                            , .BookUpdated = d.BookUpdated.ToArray}).Take(20).ToArray()

                Return Books

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBooksByPONumber(ByVal BookLoadPONumber As String) As DTO.Book()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                If BookLoadPONumber Is Nothing OrElse String.IsNullOrEmpty(BookLoadPONumber) Then Return Nothing
                Dim oBLs = From bl In db.BookLoads Where bl.BookLoadPONumber = BookLoadPONumber Select bl.BookLoadBookControl

                Dim oDLO As New DataLoadOptions
                oDLO.LoadWith(Of LTS.Book)(Function(t As LTS.Book) t.BookLoads)
                oDLO.LoadWith(Of LTS.Book)(Function(t As LTS.Book) t.BookNotes)
                oDLO.LoadWith(Of LTS.Book)(Function(t As LTS.Book) t.BookTracks)
                oDLO.LoadWith(Of LTS.BookLoad)(Function(t As LTS.BookLoad) t.BookItems)
                db.LoadOptions = oDLO
                'Get the newest record that matches the provided criteria
                Dim Books() As DTO.Book = ( _
                From d In db.Books _
                Where oBLs.Contains(d.BookControl) _
                Order By d.BookStopNo Ascending _
                Select New DTO.Book With {.BookControl = d.BookControl _
                                            , .BookProNumber = d.BookProNumber _
                                            , .BookProBase = d.BookProBase _
                                            , .BookConsPrefix = d.BookConsPrefix _
                                            , .BookCustCompControl = d.BookCustCompControl _
                                            , .BookCommCompControl = d.BookCommCompControl _
                                            , .BookODControl = d.BookODControl _
                                            , .BookCarrierControl = d.BookCarrierControl _
                                            , .BookCarrierContact = d.BookCarrierContact _
                                            , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                            , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                            , .BookOrigName = d.BookOrigName _
                                            , .BookOrigAddress1 = d.BookOrigAddress1 _
                                            , .BookOrigAddress2 = d.BookOrigAddress2 _
                                            , .BookOrigAddress3 = d.BookOrigAddress3 _
                                            , .BookOrigCity = d.BookOrigCity _
                                            , .BookOrigState = d.BookOrigState _
                                            , .BookOrigCountry = d.BookOrigCountry _
                                            , .BookOrigZip = d.BookOrigZip _
                                            , .BookOrigPhone = d.BookOrigPhone _
                                            , .BookOrigFax = d.BookOrigFax _
                                            , .BookOriginStartHrs = d.BookOriginStartHrs _
                                            , .BookOriginStopHrs = d.BookOriginStopHrs _
                                            , .BookOriginApptReq = If(d.BookOriginApptReq.HasValue, d.BookOriginApptReq, False) _
                                            , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                            , .BookDestName = d.BookDestName _
                                            , .BookDestAddress1 = d.BookDestAddress1 _
                                            , .BookDestAddress2 = d.BookDestAddress2 _
                                            , .BookDestAddress3 = d.BookDestAddress3 _
                                            , .BookDestCity = d.BookDestCity _
                                            , .BookDestState = d.BookDestState _
                                            , .BookDestCountry = d.BookDestCountry _
                                            , .BookDestZip = d.BookDestZip _
                                            , .BookDestPhone = d.BookDestPhone _
                                            , .BookDestFax = d.BookDestFax _
                                            , .BookDestStartHrs = d.BookDestStartHrs _
                                            , .BookDestStopHrs = d.BookDestStopHrs _
                                            , .BookDestApptReq = If(d.BookDestApptReq.HasValue, d.BookDestApptReq, False) _
                                            , .BookDateOrdered = d.BookDateOrdered _
                                            , .BookDateLoad = d.BookDateLoad _
                                            , .BookDateInvoice = d.BookDateInvoice _
                                            , .BookDateRequired = d.BookDateRequired _
                                            , .BookDateDelivered = d.BookDateDelivered _
                                            , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                            , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                            , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                            , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                            , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                            , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                            , .BookTranCode = d.BookTranCode _
                                            , .BookPayCode = d.BookPayCode _
                                            , .BookTypeCode = d.BookTypeCode _
                                            , .BookBOLCode = d.BookBOLCode _
                                            , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                            , .BookCarrFBNumber = d.BookCarrFBNumber _
                                            , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                            , .BookCarrBLNumber = d.BookCarrBLNumber _
                                            , .BookCarrBookDate = d.BookCarrBookDate _
                                            , .BookCarrBookTime = d.BookCarrBookTime _
                                            , .BookCarrBookContact = d.BookCarrBookContact _
                                            , .BookCarrScheduleDate = d.BookCarrScheduleDate _
                                            , .BookCarrScheduleTime = d.BookCarrScheduleTime _
                                            , .BookCarrActualDate = d.BookCarrActualDate _
                                            , .BookCarrActualTime = d.BookCarrActualTime _
                                            , .BookCarrActLoadComplete_Date = d.BookCarrActLoadComplete_Date _
                                            , .BookCarrActLoadCompleteTime = d.BookCarrActLoadCompleteTime _
                                            , .BookCarrDockPUAssigment = d.BookCarrDockPUAssigment _
                                            , .BookCarrPODate = d.BookCarrPODate _
                                            , .BookCarrPOTime = d.BookCarrPOTime _
                                            , .BookCarrApptDate = d.BookCarrApptDate _
                                            , .BookCarrApptTime = d.BookCarrApptTime _
                                            , .BookCarrActDate = d.BookCarrActDate _
                                            , .BookCarrActTime = d.BookCarrActTime _
                                            , .BookCarrActUnloadCompDate = d.BookCarrActUnloadCompDate _
                                            , .BookCarrActUnloadCompTime = d.BookCarrActUnloadCompTime _
                                            , .BookCarrDockDelAssignment = d.BookCarrDockDelAssignment _
                                            , .BookCarrVarDay = If(d.BookCarrVarDay.HasValue, d.BookCarrVarDay, 0) _
                                            , .BookCarrVarHrs = If(d.BookCarrVarHrs.HasValue, d.BookCarrVarHrs, 0) _
                                            , .BookCarrTrailerNo = d.BookCarrTrailerNo _
                                            , .BookCarrSealNo = d.BookCarrSealNo _
                                            , .BookCarrDriverNo = d.BookCarrDriverNo _
                                            , .BookCarrDriverName = d.BookCarrDriverName _
                                            , .BookCarrRouteNo = d.BookCarrRouteNo _
                                            , .BookCarrTripNo = d.BookCarrTripNo _
                                            , .BookFinARBookFrt = If(d.BookFinARBookFrt.HasValue, d.BookFinARBookFrt, 0) _
                                            , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                            , .BookFinARInvoiceAmt = If(d.BookFinARInvoiceAmt.HasValue, d.BookFinARInvoiceAmt, 0) _
                                            , .BookFinARPayDate = d.BookFinARPayDate _
                                            , .BookFinARPayAmt = If(d.BookFinARPayAmt.HasValue, d.BookFinARPayAmt, 0) _
                                            , .BookFinARCheck = d.BookFinARCheck _
                                            , .BookFinARGLNumber = d.BookFinARGLNumber _
                                            , .BookFinARBalance = If(d.BookFinARBalance.HasValue, d.BookFinARBalance, 0) _
                                            , .BookFinARCurType = If(d.BookFinARCurType.HasValue, d.BookFinARCurType, 0) _
                                            , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                            , .BookFinAPBillNoDate = d.BookFinAPBillNoDate _
                                            , .BookFinAPBillInvDate = d.BookFinAPBillInvDate _
                                            , .BookFinAPActWgt = If(d.BookFinAPActWgt.HasValue, d.BookFinAPActWgt, 0) _
                                            , .BookFinAPStdCost = If(d.BookFinAPStdCost.HasValue, d.BookFinAPStdCost, 0) _
                                            , .BookFinAPActCost = If(d.BookFinAPActCost.HasValue, d.BookFinAPActCost, 0) _
                                            , .BookFinAPPayDate = d.BookFinAPPayDate _
                                            , .BookFinAPPayAmt = If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0) _
                                            , .BookFinAPCheck = d.BookFinAPCheck _
                                            , .BookFinAPGLNumber = d.BookFinAPGLNumber _
                                            , .BookFinAPLastViewed = d.BookFinAPLastViewed _
                                            , .BookFinAPCurType = If(d.BookFinAPCurType.HasValue, d.BookFinAPCurType, 0) _
                                            , .BookFinCommStd = If(d.BookFinCommStd.HasValue, d.BookFinCommStd, 0) _
                                            , .BookFinCommAct = If(d.BookFinCommAct.HasValue, d.BookFinCommAct, 0) _
                                            , .BookFinCommPayDate = d.BookFinCommPayDate _
                                            , .BookFinCommPayAmt = If(d.BookFinCommPayAmt.HasValue, d.BookFinCommPayAmt, 0) _
                                            , .BookFinCommtCheck = d.BookFinCommtCheck _
                                            , .BookFinCommCreditAmt = If(d.BookFinCommCreditAmt.HasValue, d.BookFinCommCreditAmt, 0) _
                                            , .BookFinCommCreditPayDate = d.BookFinCommCreditPayDate _
                                            , .BookFinCommLoadCount = If(d.BookFinCommLoadCount.HasValue, d.BookFinCommLoadCount, 0) _
                                            , .BookFinCommGLNumber = d.BookFinCommGLNumber _
                                            , .BookFinCheckClearedDate = d.BookFinCheckClearedDate _
                                            , .BookFinCheckClearedNumber = d.BookFinCheckClearedNumber _
                                            , .BookFinCheckClearedAmt = If(d.BookFinCheckClearedAmt.HasValue, d.BookFinCheckClearedAmt, 0) _
                                            , .BookFinCheckClearedDesc = d.BookFinCheckClearedDesc _
                                            , .BookFinCheckClearedAcct = d.BookFinCheckClearedAcct _
                                            , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                            , .BookRevCarrierCost = If(d.BookRevCarrierCost.HasValue, d.BookRevCarrierCost, 0) _
                                            , .BookRevStopQty = If(d.BookRevStopQty.HasValue, d.BookRevStopQty, 0) _
                                            , .BookRevStopCost = If(d.BookRevStopCost.HasValue, d.BookRevStopCost, 0) _
                                            , .BookRevOtherCost = If(d.BookRevOtherCost.HasValue, d.BookRevOtherCost, 0) _
                                            , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                            , .BookRevLoadSavings = If(d.BookRevLoadSavings.HasValue, d.BookRevLoadSavings, 0) _
                                            , .BookRevCommPercent = If(d.BookRevCommPercent.HasValue, d.BookRevCommPercent, 0) _
                                            , .BookRevCommCost = If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0) _
                                            , .BookRevGrossRevenue = If(d.BookRevGrossRevenue.HasValue, d.BookRevGrossRevenue, 0) _
                                            , .BookRevNegRevenue = If(d.BookRevNegRevenue.HasValue, d.BookRevNegRevenue, 0) _
                                            , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                            , .BookLaneCarrControl = If(d.BookLaneCarrControl.HasValue, d.BookLaneCarrControl, 0) _
                                            , .BookHoldLoad = If(d.BookHoldLoad.HasValue, d.BookHoldLoad, 0) _
                                            , .BookRouteFinalDate = d.BookRouteFinalDate _
                                            , .BookRouteFinalCode = d.BookRouteFinalCode _
                                            , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                            , .BookWarehouseNumber = d.BookWarehouseNumber _
                                            , .BookComCode = d.BookComCode _
                                            , .BookTransType = d.BookTransType _
                                            , .BookRouteConsFlag = d.BookRouteConsFlag _
                                            , .BookWhseAuthorizationNo = d.BookWhseAuthorizationNo _
                                            , .BookHotLoad = If(d.BookHotLoad.HasValue, d.BookHotLoad, False) _
                                            , .BookFinAPActTax = If(d.BookFinAPActTax.HasValue, d.BookFinAPActTax, 0) _
                                            , .BookFinAPExportFlag = d.BookFinAPExportFlag _
                                            , .BookFinARFreightTax = d.BookFinARFreightTax _
                                            , .BookRevFreightTax = d.BookRevFreightTax _
                                            , .BookRevNetCost = d.BookRevNetCost _
                                            , .BookFinServiceFee = If(d.BookFinServiceFee.HasValue, d.BookFinServiceFee, 0) _
                                            , .BookFinAPExportDate = d.BookFinAPExportDate _
                                            , .BookFinAPExportRetry = If(d.BookFinAPExportRetry.HasValue, d.BookFinAPExportRetry, 0) _
                                            , .BookCarrierContControl = If(d.BookCarrierContControl.HasValue, d.BookCarrierContControl, 0) _
                                            , .BookHotLoadSent = If(d.BookHotLoadSent.HasValue, d.BookHotLoadSent, False) _
                                            , .BookExportDocCreated = If(d.BookExportDocCreated.HasValue, d.BookExportDocCreated, False) _
                                            , .BookDoNotInvoice = d.BookDoNotInvoice _
                                            , .BookCarrStartLoadingDate = d.BookCarrStartLoadingDate _
                                            , .BookCarrStartLoadingTime = d.BookCarrStartLoadingTime _
                                            , .BookCarrFinishLoadingDate = d.BookCarrFinishLoadingDate _
                                            , .BookCarrFinishLoadingTime = d.BookCarrFinishLoadingTime _
                                            , .BookCarrStartUnloadingDate = d.BookCarrStartUnloadingDate _
                                            , .BookCarrStartUnloadingTime = d.BookCarrStartUnloadingTime _
                                            , .BookCarrFinishUnloadingDate = d.BookCarrFinishUnloadingDate _
                                            , .BookCarrFinishUnloadingTime = d.BookCarrFinishUnloadingTime _
                                            , .BookOrderSequence = d.BookOrderSequence _
                                            , .BookChepGLID = d.BookChepGLID _
                                            , .BookCarrierTypeCode = d.BookCarrierTypeCode _
                                            , .BookPalletPositions = d.BookPalletPositions _
                                            , .BookShipCarrierProNumber = d.BookShipCarrierProNumber _
                                            , .BookShipCarrierName = d.BookShipCarrierName _
                                            , .BookShipCarrierNumber = d.BookShipCarrierNumber _
                                            , .BookAPAdjReasonControl = d.BookAPAdjReasonControl _
                                            , .BookDateRequested = d.BookDateRequested _
                                            , .BookCarrierEquipmentCodes = d.BookCarrierEquipmentCodes _
                                            , .BookLockAllCosts = d.BookLockAllCosts _
                                            , .BookLockBFCCost = d.BookLockBFCCost _
                                            , .BookDestStopNumber = d.BookDestStopNumber _
                                            , .BookOrigStopNumber = d.BookOrigStopNumber _
                                            , .BookDestStopControl = d.BookDestStopControl _
                                            , .BookOrigStopControl = d.BookOrigStopControl _
                                            , .BookRouteTypeCode = d.BookRouteTypeCode _
                                            , .BookAlternateAddressLaneControl = d.BookAlternateAddressLaneControl _
                                            , .BookAlternateAddressLaneNumber = d.BookAlternateAddressLaneNumber _
                                            , .BookDefaultRouteSequence = d.BookDefaultRouteSequence _
                                            , .BookRouteGuideControl = d.BookRouteGuideControl _
                                            , .BookRouteGuideNumber = d.BookRouteGuideNumber _
                                            , .BookCustomerApprovalRecieved = d.BookCustomerApprovalRecieved _
                                            , .BookCustomerApprovalTransmitted = d.BookCustomerApprovalTransmitted _
                                            , .BookAMSPickupApptControl = d.BookAMSPickupApptControl _
                                            , .BookAMSDeliveryApptControl = d.BookAMSDeliveryApptControl _
                                            , .BookItemDetailDescription = d.BookItemDetailDescription _
                                            , .BookModDate = d.BookModDate _
                                            , .BookModUser = d.BookModUser _
                                            , .BookUpdated = d.BookUpdated.ToArray _
                                              , .BookLoads = ( _
                                                    From c In d.BookLoads _
                                                    Select New DTO.BookLoad With {.BookLoadControl = c.BookLoadControl _
                                                    , .BookLoadBookControl = c.BookLoadBookControl _
                                                    , .BookLoadBuy = c.BookLoadBuy _
                                                    , .BookLoadPONumber = c.BookLoadPONumber _
                                                    , .BookLoadVendor = c.BookLoadVendor _
                                                    , .BookLoadCaseQty = If(c.BookLoadCaseQty.HasValue, c.BookLoadCaseQty, 0) _
                                                    , .BookLoadWgt = If(c.BookLoadWgt.HasValue, c.BookLoadWgt, 0) _
                                                    , .BookLoadCube = If(c.BookLoadCube.HasValue, c.BookLoadCube, 0) _
                                                    , .BookLoadPL = If(c.BookLoadPL.HasValue, c.BookLoadPL, 0) _
                                                    , .BookLoadPX = If(c.BookLoadPX.HasValue, c.BookLoadPX, 0) _
                                                    , .BookLoadPType = c.BookLoadPType _
                                                    , .BookLoadCom = c.BookLoadCom _
                                                    , .BookLoadPUOrigin = c.BookLoadPUOrigin _
                                                    , .BookLoadBFC = If(c.BookLoadBFC.HasValue, c.BookLoadBFC, 0) _
                                                    , .BookLoadTotCost = If(c.BookLoadTotCost.HasValue, c.BookLoadTotCost, 0) _
                                                    , .BookLoadComments = c.BookLoadComments _
                                                    , .BookLoadStopSeq = If(c.BookLoadStopSeq.HasValue, c.BookLoadStopSeq, 0) _
                                                    , .BookLoadModDate = c.BookLoadModDate _
                                                    , .BookLoadModUser = c.BookLoadModUser _
                                                    , .BookLoadUpdated = c.BookLoadUpdated.ToArray() _
                                                    , .BookItems = ( _
                                                        From i In c.BookItems _
                                                        Select New DTO.BookItem With {.BookItemControl = i.BookItemControl _
                                                       , .BookItemBookLoadControl = i.BookItemBookLoadControl _
                                                       , .BookItemFixOffInvAllow = If(i.BookItemFixOffInvAllow.HasValue, i.BookItemFixOffInvAllow, 0) _
                                                       , .BookItemFixFrtAllow = If(i.BookItemFixFrtAllow.HasValue, i.BookItemFixFrtAllow, 0) _
                                                       , .BookItemItemNumber = i.BookItemItemNumber _
                                                       , .BookItemQtyOrdered = If(i.BookItemQtyOrdered.HasValue, i.BookItemQtyOrdered, 0) _
                                                       , .BookItemFreightCost = If(i.BookItemFreightCost.HasValue, i.BookItemFreightCost, 0) _
                                                       , .BookItemItemCost = If(i.BookItemItemCost.HasValue, i.BookItemItemCost, 0) _
                                                       , .BookItemWeight = If(i.BookItemWeight.HasValue, i.BookItemWeight, 0) _
                                                       , .BookItemCube = If(i.BookItemCube.HasValue, i.BookItemCube, 0) _
                                                       , .BookItemPack = If(i.BookItemPack.HasValue, i.BookItemPack, 0) _
                                                       , .BookItemSize = i.BookItemSize _
                                                       , .BookItemDescription = i.BookItemDescription _
                                                       , .BookItemHazmat = i.BookItemHazmat _
                                                       , .BookItemModDate = i.BookItemModDate _
                                                       , .BookItemModUser = i.BookItemModUser _
                                                       , .BookItemBrand = i.BookItemBrand _
                                                       , .BookItemCostCenter = i.BookItemCostCenter _
                                                       , .BookItemLotNumber = i.BookItemLotNumber _
                                                       , .BookItemLotExpirationDate = i.BookItemLotExpirationDate _
                                                       , .BookItemGTIN = i.BookItemGTIN _
                                                       , .BookCustItemNumber = i.BookCustItemNumber _
                                                       , .BookItemBFC = If(i.BookItemBFC.HasValue, i.BookItemBFC, 0) _
                                                       , .BookItemCountryOfOrigin = i.BookItemCountryOfOrigin _
                                                       , .BookItemHST = i.BookItemHST _
                                                       , .BookItemPalletTypeID = i.BookItemPalletTypeID _
                                                       , .BookItemHazmatTypeCode = i.BookItemHazmatTypeCode _
                                                       , .BookItem49CFRCode = i.BookItem49CFRCode _
                                                       , .BookItemIATACode = i.BookItemIATACode _
                                                       , .BookItemDOTCode = i.BookItemDOTCode _
                                                       , .BookItemMarineCode = i.BookItemMarineCode _
                                                       , .BookItemNMFCClass = i.BookItemNMFCClass _
                                                       , .BookItemFAKClass = i.BookItemFAKClass _
                                                       , .BookItemLimitedQtyFlag = i.BookItemLimitedQtyFlag _
                                                       , .BookItemPallets = i.BookItemPallets _
                                                       , .BookItemTies = i.BookItemTies _
                                                       , .BookItemHighs = i.BookItemHighs _
                                                       , .BookItemQtyPalletPercentage = i.BookItemQtyPalletPercentage _
                                                       , .BookItemQtyLength = i.BookItemQtyLength _
                                                       , .BookItemQtyWidth = i.BookItemQtyWidth _
                                                       , .BookItemQtyHeight = i.BookItemQtyHeight _
                                                       , .BookItemStackable = i.BookItemStackable _
                                                       , .BookItemLevelOfDensity = i.BookItemLevelOfDensity _
                                                       , .BookItemUpdated = i.BookItemUpdated.ToArray()}).ToList() _
                                                }).ToList() _
                                            , .BookNotes = ( _
                                                    From c In d.BookNotes _
                                                    Select New DTO.BookNote With {.BookNotesControl = c.BookNotesControl _
                                                    , .BookNotesBookControl = c.BookNotesBookControl _
                                                    , .BookNotesVisable1 = c.BookNotesVisable1 _
                                                    , .BookNotesVisable2 = c.BookNotesVisable2 _
                                                    , .BookNotesVisable3 = c.BookNotesVisable3 _
                                                    , .BookNotesVisable4 = c.BookNotesVisable4 _
                                                    , .BookNotesVisable5 = c.BookNotesVisable5 _
                                                    , .BookNotesConfidential1 = c.BookNotesConfidential1 _
                                                    , .BookNotesConfidential2 = c.BookNotesConfidential2 _
                                                    , .BookNotesConfidential3 = c.BookNotesConfidential3 _
                                                    , .BookNotesConfidential4 = c.BookNotesConfidential4 _
                                                    , .BookNotesConfidential5 = c.BookNotesConfidential5 _
                                                    , .BookNotesModDate = c.BookNotesModDate _
                                                    , .BookNotesModUser = c.BookNotesModUser _
                                                    , .BookNotesUpdated = c.BookNotesUpdated.ToArray()}).ToList() _
                                            , .BookTracks = ( _
                                                    From c In d.BookTracks _
                                                    Select New DTO.BookTrack With {.BookTrackControl = c.BookTrackControl _
                                                    , .BookTrackBookControl = c.BookTrackBookControl _
                                                    , .BookTrackDate = c.BookTrackDate _
                                                    , .BookTrackContact = c.BookTrackContact _
                                                    , .BookTrackComment = c.BookTrackComment _
                                                    , .BookTrackStatus = If(c.BookTrackStatus.HasValue, c.BookTrackStatus, 0) _
                                                    , .BookTrackModDate = c.BookTrackModDate _
                                                    , .BookTrackModUser = c.BookTrackModUser _
                                                    , .BookTrackUpdated = c.BookTrackUpdated.ToArray()}).ToList() _
                                              }).Take(20).ToArray()

                Return Books

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBooksFilteredContains(Optional ByVal BookProNumber As String = "", _
                                          Optional ByVal BookConsPrefix As String = "", _
                                          Optional ByVal BookCarrBLNumber As String = "", _
                                          Optional ByVal BookFinAPBillNumber As String = "", _
                                          Optional ByVal BookCarrOrderNumber As String = "") As DTO.Book()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl

                Dim oDLO As New DataLoadOptions
                oDLO.LoadWith(Of LTS.Book)(Function(t As LTS.Book) t.BookLoads)
                oDLO.LoadWith(Of LTS.Book)(Function(t As LTS.Book) t.BookNotes)
                oDLO.LoadWith(Of LTS.Book)(Function(t As LTS.Book) t.BookTracks)
                oDLO.LoadWith(Of LTS.BookLoad)(Function(t As LTS.BookLoad) t.BookItems)
                db.LoadOptions = oDLO
                'Get the newest record that matches the provided criteria
                Dim Books() As DTO.Book = ( _
                From d In db.Books _
                Where _
                    (BookProNumber Is Nothing OrElse String.IsNullOrEmpty(BookProNumber) OrElse d.BookProNumber.Contains(BookProNumber)) _
                    And _
                    (BookConsPrefix Is Nothing OrElse String.IsNullOrEmpty(BookConsPrefix) OrElse d.BookConsPrefix.Contains(BookConsPrefix)) _
                    And _
                    (BookCarrBLNumber Is Nothing OrElse String.IsNullOrEmpty(BookCarrBLNumber) OrElse d.BookCarrBLNumber.Contains(BookCarrBLNumber)) _
                    And _
                    (BookFinAPBillNumber Is Nothing OrElse String.IsNullOrEmpty(BookFinAPBillNumber) OrElse d.BookFinAPBillNumber.Contains(BookFinAPBillNumber)) _
                    And _
                    (BookCarrOrderNumber Is Nothing OrElse String.IsNullOrEmpty(BookCarrOrderNumber) OrElse d.BookCarrOrderNumber.Contains(BookCarrOrderNumber)) _
                    And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.BookCustCompControl)) _
                Order By d.BookStopNo Ascending _
                Select New DTO.Book With {.BookControl = d.BookControl _
                                            , .BookProNumber = d.BookProNumber _
                                            , .BookProBase = d.BookProBase _
                                            , .BookConsPrefix = d.BookConsPrefix _
                                            , .BookCustCompControl = d.BookCustCompControl _
                                            , .BookCommCompControl = d.BookCommCompControl _
                                            , .BookODControl = d.BookODControl _
                                            , .BookCarrierControl = d.BookCarrierControl _
                                            , .BookCarrierContact = d.BookCarrierContact _
                                            , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                            , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                            , .BookOrigName = d.BookOrigName _
                                            , .BookOrigAddress1 = d.BookOrigAddress1 _
                                            , .BookOrigAddress2 = d.BookOrigAddress2 _
                                            , .BookOrigAddress3 = d.BookOrigAddress3 _
                                            , .BookOrigCity = d.BookOrigCity _
                                            , .BookOrigState = d.BookOrigState _
                                            , .BookOrigCountry = d.BookOrigCountry _
                                            , .BookOrigZip = d.BookOrigZip _
                                            , .BookOrigPhone = d.BookOrigPhone _
                                            , .BookOrigFax = d.BookOrigFax _
                                            , .BookOriginStartHrs = d.BookOriginStartHrs _
                                            , .BookOriginStopHrs = d.BookOriginStopHrs _
                                            , .BookOriginApptReq = If(d.BookOriginApptReq.HasValue, d.BookOriginApptReq, False) _
                                            , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                            , .BookDestName = d.BookDestName _
                                            , .BookDestAddress1 = d.BookDestAddress1 _
                                            , .BookDestAddress2 = d.BookDestAddress2 _
                                            , .BookDestAddress3 = d.BookDestAddress3 _
                                            , .BookDestCity = d.BookDestCity _
                                            , .BookDestState = d.BookDestState _
                                            , .BookDestCountry = d.BookDestCountry _
                                            , .BookDestZip = d.BookDestZip _
                                            , .BookDestPhone = d.BookDestPhone _
                                            , .BookDestFax = d.BookDestFax _
                                            , .BookDestStartHrs = d.BookDestStartHrs _
                                            , .BookDestStopHrs = d.BookDestStopHrs _
                                            , .BookDestApptReq = If(d.BookDestApptReq.HasValue, d.BookDestApptReq, False) _
                                            , .BookDateOrdered = d.BookDateOrdered _
                                            , .BookDateLoad = d.BookDateLoad _
                                            , .BookDateInvoice = d.BookDateInvoice _
                                            , .BookDateRequired = d.BookDateRequired _
                                            , .BookDateDelivered = d.BookDateDelivered _
                                            , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                            , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                            , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                            , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                            , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                            , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                            , .BookTranCode = d.BookTranCode _
                                            , .BookPayCode = d.BookPayCode _
                                            , .BookTypeCode = d.BookTypeCode _
                                            , .BookBOLCode = d.BookBOLCode _
                                            , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                            , .BookCarrFBNumber = d.BookCarrFBNumber _
                                            , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                            , .BookCarrBLNumber = d.BookCarrBLNumber _
                                            , .BookCarrBookDate = d.BookCarrBookDate _
                                            , .BookCarrBookTime = d.BookCarrBookTime _
                                            , .BookCarrBookContact = d.BookCarrBookContact _
                                            , .BookCarrScheduleDate = d.BookCarrScheduleDate _
                                            , .BookCarrScheduleTime = d.BookCarrScheduleTime _
                                            , .BookCarrActualDate = d.BookCarrActualDate _
                                            , .BookCarrActualTime = d.BookCarrActualTime _
                                            , .BookCarrActLoadComplete_Date = d.BookCarrActLoadComplete_Date _
                                            , .BookCarrActLoadCompleteTime = d.BookCarrActLoadCompleteTime _
                                            , .BookCarrDockPUAssigment = d.BookCarrDockPUAssigment _
                                            , .BookCarrPODate = d.BookCarrPODate _
                                            , .BookCarrPOTime = d.BookCarrPOTime _
                                            , .BookCarrApptDate = d.BookCarrApptDate _
                                            , .BookCarrApptTime = d.BookCarrApptTime _
                                            , .BookCarrActDate = d.BookCarrActDate _
                                            , .BookCarrActTime = d.BookCarrActTime _
                                            , .BookCarrActUnloadCompDate = d.BookCarrActUnloadCompDate _
                                            , .BookCarrActUnloadCompTime = d.BookCarrActUnloadCompTime _
                                            , .BookCarrDockDelAssignment = d.BookCarrDockDelAssignment _
                                            , .BookCarrVarDay = If(d.BookCarrVarDay.HasValue, d.BookCarrVarDay, 0) _
                                            , .BookCarrVarHrs = If(d.BookCarrVarHrs.HasValue, d.BookCarrVarHrs, 0) _
                                            , .BookCarrTrailerNo = d.BookCarrTrailerNo _
                                            , .BookCarrSealNo = d.BookCarrSealNo _
                                            , .BookCarrDriverNo = d.BookCarrDriverNo _
                                            , .BookCarrDriverName = d.BookCarrDriverName _
                                            , .BookCarrRouteNo = d.BookCarrRouteNo _
                                            , .BookCarrTripNo = d.BookCarrTripNo _
                                            , .BookFinARBookFrt = If(d.BookFinARBookFrt.HasValue, d.BookFinARBookFrt, 0) _
                                            , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                            , .BookFinARInvoiceAmt = If(d.BookFinARInvoiceAmt.HasValue, d.BookFinARInvoiceAmt, 0) _
                                            , .BookFinARPayDate = d.BookFinARPayDate _
                                            , .BookFinARPayAmt = If(d.BookFinARPayAmt.HasValue, d.BookFinARPayAmt, 0) _
                                            , .BookFinARCheck = d.BookFinARCheck _
                                            , .BookFinARGLNumber = d.BookFinARGLNumber _
                                            , .BookFinARBalance = If(d.BookFinARBalance.HasValue, d.BookFinARBalance, 0) _
                                            , .BookFinARCurType = If(d.BookFinARCurType.HasValue, d.BookFinARCurType, 0) _
                                            , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                            , .BookFinAPBillNoDate = d.BookFinAPBillNoDate _
                                            , .BookFinAPBillInvDate = d.BookFinAPBillInvDate _
                                            , .BookFinAPActWgt = If(d.BookFinAPActWgt.HasValue, d.BookFinAPActWgt, 0) _
                                            , .BookFinAPStdCost = If(d.BookFinAPStdCost.HasValue, d.BookFinAPStdCost, 0) _
                                            , .BookFinAPActCost = If(d.BookFinAPActCost.HasValue, d.BookFinAPActCost, 0) _
                                            , .BookFinAPPayDate = d.BookFinAPPayDate _
                                            , .BookFinAPPayAmt = If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0) _
                                            , .BookFinAPCheck = d.BookFinAPCheck _
                                            , .BookFinAPGLNumber = d.BookFinAPGLNumber _
                                            , .BookFinAPLastViewed = d.BookFinAPLastViewed _
                                            , .BookFinAPCurType = If(d.BookFinAPCurType.HasValue, d.BookFinAPCurType, 0) _
                                            , .BookFinCommStd = If(d.BookFinCommStd.HasValue, d.BookFinCommStd, 0) _
                                            , .BookFinCommAct = If(d.BookFinCommAct.HasValue, d.BookFinCommAct, 0) _
                                            , .BookFinCommPayDate = d.BookFinCommPayDate _
                                            , .BookFinCommPayAmt = If(d.BookFinCommPayAmt.HasValue, d.BookFinCommPayAmt, 0) _
                                            , .BookFinCommtCheck = d.BookFinCommtCheck _
                                            , .BookFinCommCreditAmt = If(d.BookFinCommCreditAmt.HasValue, d.BookFinCommCreditAmt, 0) _
                                            , .BookFinCommCreditPayDate = d.BookFinCommCreditPayDate _
                                            , .BookFinCommLoadCount = If(d.BookFinCommLoadCount.HasValue, d.BookFinCommLoadCount, 0) _
                                            , .BookFinCommGLNumber = d.BookFinCommGLNumber _
                                            , .BookFinCheckClearedDate = d.BookFinCheckClearedDate _
                                            , .BookFinCheckClearedNumber = d.BookFinCheckClearedNumber _
                                            , .BookFinCheckClearedAmt = If(d.BookFinCheckClearedAmt.HasValue, d.BookFinCheckClearedAmt, 0) _
                                            , .BookFinCheckClearedDesc = d.BookFinCheckClearedDesc _
                                            , .BookFinCheckClearedAcct = d.BookFinCheckClearedAcct _
                                            , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                            , .BookRevCarrierCost = If(d.BookRevCarrierCost.HasValue, d.BookRevCarrierCost, 0) _
                                            , .BookRevStopQty = If(d.BookRevStopQty.HasValue, d.BookRevStopQty, 0) _
                                            , .BookRevStopCost = If(d.BookRevStopCost.HasValue, d.BookRevStopCost, 0) _
                                            , .BookRevOtherCost = If(d.BookRevOtherCost.HasValue, d.BookRevOtherCost, 0) _
                                            , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                            , .BookRevLoadSavings = If(d.BookRevLoadSavings.HasValue, d.BookRevLoadSavings, 0) _
                                            , .BookRevCommPercent = If(d.BookRevCommPercent.HasValue, d.BookRevCommPercent, 0) _
                                            , .BookRevCommCost = If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0) _
                                            , .BookRevGrossRevenue = If(d.BookRevGrossRevenue.HasValue, d.BookRevGrossRevenue, 0) _
                                            , .BookRevNegRevenue = If(d.BookRevNegRevenue.HasValue, d.BookRevNegRevenue, 0) _
                                            , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                            , .BookLaneCarrControl = If(d.BookLaneCarrControl.HasValue, d.BookLaneCarrControl, 0) _
                                            , .BookHoldLoad = If(d.BookHoldLoad.HasValue, d.BookHoldLoad, 0) _
                                            , .BookRouteFinalDate = d.BookRouteFinalDate _
                                            , .BookRouteFinalCode = d.BookRouteFinalCode _
                                            , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                            , .BookWarehouseNumber = d.BookWarehouseNumber _
                                            , .BookComCode = d.BookComCode _
                                            , .BookTransType = d.BookTransType _
                                            , .BookRouteConsFlag = d.BookRouteConsFlag _
                                            , .BookWhseAuthorizationNo = d.BookWhseAuthorizationNo _
                                            , .BookHotLoad = If(d.BookHotLoad.HasValue, d.BookHotLoad, False) _
                                            , .BookFinAPActTax = If(d.BookFinAPActTax.HasValue, d.BookFinAPActTax, 0) _
                                            , .BookFinAPExportFlag = d.BookFinAPExportFlag _
                                            , .BookFinARFreightTax = d.BookFinARFreightTax _
                                            , .BookRevFreightTax = d.BookRevFreightTax _
                                            , .BookRevNetCost = d.BookRevNetCost _
                                            , .BookFinServiceFee = If(d.BookFinServiceFee.HasValue, d.BookFinServiceFee, 0) _
                                            , .BookFinAPExportDate = d.BookFinAPExportDate _
                                            , .BookFinAPExportRetry = If(d.BookFinAPExportRetry.HasValue, d.BookFinAPExportRetry, 0) _
                                            , .BookCarrierContControl = If(d.BookCarrierContControl.HasValue, d.BookCarrierContControl, 0) _
                                            , .BookHotLoadSent = If(d.BookHotLoadSent.HasValue, d.BookHotLoadSent, False) _
                                            , .BookExportDocCreated = If(d.BookExportDocCreated.HasValue, d.BookExportDocCreated, False) _
                                            , .BookDoNotInvoice = d.BookDoNotInvoice _
                                            , .BookCarrStartLoadingDate = d.BookCarrStartLoadingDate _
                                            , .BookCarrStartLoadingTime = d.BookCarrStartLoadingTime _
                                            , .BookCarrFinishLoadingDate = d.BookCarrFinishLoadingDate _
                                            , .BookCarrFinishLoadingTime = d.BookCarrFinishLoadingTime _
                                            , .BookCarrStartUnloadingDate = d.BookCarrStartUnloadingDate _
                                            , .BookCarrStartUnloadingTime = d.BookCarrStartUnloadingTime _
                                            , .BookCarrFinishUnloadingDate = d.BookCarrFinishUnloadingDate _
                                            , .BookCarrFinishUnloadingTime = d.BookCarrFinishUnloadingTime _
                                            , .BookOrderSequence = d.BookOrderSequence _
                                            , .BookChepGLID = d.BookChepGLID _
                                            , .BookCarrierTypeCode = d.BookCarrierTypeCode _
                                            , .BookPalletPositions = d.BookPalletPositions _
                                            , .BookShipCarrierProNumber = d.BookShipCarrierProNumber _
                                            , .BookShipCarrierName = d.BookShipCarrierName _
                                            , .BookShipCarrierNumber = d.BookShipCarrierNumber _
                                            , .BookAPAdjReasonControl = d.BookAPAdjReasonControl _
                                            , .BookDateRequested = d.BookDateRequested _
                                            , .BookCarrierEquipmentCodes = d.BookCarrierEquipmentCodes _
                                            , .BookLockAllCosts = d.BookLockAllCosts _
                                            , .BookLockBFCCost = d.BookLockBFCCost _
                                            , .BookDestStopNumber = d.BookDestStopNumber _
                                            , .BookOrigStopNumber = d.BookOrigStopNumber _
                                            , .BookDestStopControl = d.BookDestStopControl _
                                            , .BookOrigStopControl = d.BookOrigStopControl _
                                            , .BookRouteTypeCode = d.BookRouteTypeCode _
                                            , .BookAlternateAddressLaneControl = d.BookAlternateAddressLaneControl _
                                            , .BookAlternateAddressLaneNumber = d.BookAlternateAddressLaneNumber _
                                            , .BookDefaultRouteSequence = d.BookDefaultRouteSequence _
                                            , .BookRouteGuideControl = d.BookRouteGuideControl _
                                            , .BookRouteGuideNumber = d.BookRouteGuideNumber _
                                            , .BookCustomerApprovalRecieved = d.BookCustomerApprovalRecieved _
                                            , .BookCustomerApprovalTransmitted = d.BookCustomerApprovalTransmitted _
                                            , .BookAMSPickupApptControl = d.BookAMSPickupApptControl _
                                            , .BookAMSDeliveryApptControl = d.BookAMSDeliveryApptControl _
                                            , .BookItemDetailDescription = d.BookItemDetailDescription _
                                            , .BookModDate = d.BookModDate _
                                            , .BookModUser = d.BookModUser _
                                            , .BookUpdated = d.BookUpdated.ToArray _
                                              , .BookLoads = ( _
                                                    From c In d.BookLoads _
                                                    Select New DTO.BookLoad With {.BookLoadControl = c.BookLoadControl _
                                                    , .BookLoadBookControl = c.BookLoadBookControl _
                                                    , .BookLoadBuy = c.BookLoadBuy _
                                                    , .BookLoadPONumber = c.BookLoadPONumber _
                                                    , .BookLoadVendor = c.BookLoadVendor _
                                                    , .BookLoadCaseQty = If(c.BookLoadCaseQty.HasValue, c.BookLoadCaseQty, 0) _
                                                    , .BookLoadWgt = If(c.BookLoadWgt.HasValue, c.BookLoadWgt, 0) _
                                                    , .BookLoadCube = If(c.BookLoadCube.HasValue, c.BookLoadCube, 0) _
                                                    , .BookLoadPL = If(c.BookLoadPL.HasValue, c.BookLoadPL, 0) _
                                                    , .BookLoadPX = If(c.BookLoadPX.HasValue, c.BookLoadPX, 0) _
                                                    , .BookLoadPType = c.BookLoadPType _
                                                    , .BookLoadCom = c.BookLoadCom _
                                                    , .BookLoadPUOrigin = c.BookLoadPUOrigin _
                                                    , .BookLoadBFC = If(c.BookLoadBFC.HasValue, c.BookLoadBFC, 0) _
                                                    , .BookLoadTotCost = If(c.BookLoadTotCost.HasValue, c.BookLoadTotCost, 0) _
                                                    , .BookLoadComments = c.BookLoadComments _
                                                    , .BookLoadStopSeq = If(c.BookLoadStopSeq.HasValue, c.BookLoadStopSeq, 0) _
                                                    , .BookLoadModDate = c.BookLoadModDate _
                                                    , .BookLoadModUser = c.BookLoadModUser _
                                                    , .BookLoadUpdated = c.BookLoadUpdated.ToArray() _
                                                    , .BookItems = ( _
                                                        From i In c.BookItems _
                                                        Select New DTO.BookItem With {.BookItemControl = i.BookItemControl _
                                                       , .BookItemBookLoadControl = i.BookItemBookLoadControl _
                                                       , .BookItemFixOffInvAllow = If(i.BookItemFixOffInvAllow.HasValue, i.BookItemFixOffInvAllow, 0) _
                                                       , .BookItemFixFrtAllow = If(i.BookItemFixFrtAllow.HasValue, i.BookItemFixFrtAllow, 0) _
                                                       , .BookItemItemNumber = i.BookItemItemNumber _
                                                       , .BookItemQtyOrdered = If(i.BookItemQtyOrdered.HasValue, i.BookItemQtyOrdered, 0) _
                                                       , .BookItemFreightCost = If(i.BookItemFreightCost.HasValue, i.BookItemFreightCost, 0) _
                                                       , .BookItemItemCost = If(i.BookItemItemCost.HasValue, i.BookItemItemCost, 0) _
                                                       , .BookItemWeight = If(i.BookItemWeight.HasValue, i.BookItemWeight, 0) _
                                                       , .BookItemCube = If(i.BookItemCube.HasValue, i.BookItemCube, 0) _
                                                       , .BookItemPack = If(i.BookItemPack.HasValue, i.BookItemPack, 0) _
                                                       , .BookItemSize = i.BookItemSize _
                                                       , .BookItemDescription = i.BookItemDescription _
                                                       , .BookItemHazmat = i.BookItemHazmat _
                                                       , .BookItemModDate = i.BookItemModDate _
                                                       , .BookItemModUser = i.BookItemModUser _
                                                       , .BookItemBrand = i.BookItemBrand _
                                                       , .BookItemCostCenter = i.BookItemCostCenter _
                                                       , .BookItemLotNumber = i.BookItemLotNumber _
                                                       , .BookItemLotExpirationDate = i.BookItemLotExpirationDate _
                                                       , .BookItemGTIN = i.BookItemGTIN _
                                                       , .BookCustItemNumber = i.BookCustItemNumber _
                                                       , .BookItemBFC = If(i.BookItemBFC.HasValue, i.BookItemBFC, 0) _
                                                       , .BookItemCountryOfOrigin = i.BookItemCountryOfOrigin _
                                                       , .BookItemHST = i.BookItemHST _
                                                       , .BookItemPalletTypeID = i.BookItemPalletTypeID _
                                                       , .BookItemHazmatTypeCode = i.BookItemHazmatTypeCode _
                                                       , .BookItem49CFRCode = i.BookItem49CFRCode _
                                                       , .BookItemIATACode = i.BookItemIATACode _
                                                       , .BookItemDOTCode = i.BookItemDOTCode _
                                                       , .BookItemMarineCode = i.BookItemMarineCode _
                                                       , .BookItemNMFCClass = i.BookItemNMFCClass _
                                                       , .BookItemFAKClass = i.BookItemFAKClass _
                                                       , .BookItemLimitedQtyFlag = i.BookItemLimitedQtyFlag _
                                                       , .BookItemPallets = i.BookItemPallets _
                                                       , .BookItemTies = i.BookItemTies _
                                                       , .BookItemHighs = i.BookItemHighs _
                                                       , .BookItemQtyPalletPercentage = i.BookItemQtyPalletPercentage _
                                                       , .BookItemQtyLength = i.BookItemQtyLength _
                                                       , .BookItemQtyWidth = i.BookItemQtyWidth _
                                                       , .BookItemQtyHeight = i.BookItemQtyHeight _
                                                       , .BookItemStackable = i.BookItemStackable _
                                                       , .BookItemLevelOfDensity = i.BookItemLevelOfDensity _
                                                       , .BookItemUpdated = i.BookItemUpdated.ToArray()}).ToList() _
                                                }).ToList() _
                                            , .BookNotes = ( _
                                                    From c In d.BookNotes _
                                                    Select New DTO.BookNote With {.BookNotesControl = c.BookNotesControl _
                                                    , .BookNotesBookControl = c.BookNotesBookControl _
                                                    , .BookNotesVisable1 = c.BookNotesVisable1 _
                                                    , .BookNotesVisable2 = c.BookNotesVisable2 _
                                                    , .BookNotesVisable3 = c.BookNotesVisable3 _
                                                    , .BookNotesVisable4 = c.BookNotesVisable4 _
                                                    , .BookNotesVisable5 = c.BookNotesVisable5 _
                                                    , .BookNotesConfidential1 = c.BookNotesConfidential1 _
                                                    , .BookNotesConfidential2 = c.BookNotesConfidential2 _
                                                    , .BookNotesConfidential3 = c.BookNotesConfidential3 _
                                                    , .BookNotesConfidential4 = c.BookNotesConfidential4 _
                                                    , .BookNotesConfidential5 = c.BookNotesConfidential5 _
                                                    , .BookNotesModDate = c.BookNotesModDate _
                                                    , .BookNotesModUser = c.BookNotesModUser _
                                                    , .BookNotesUpdated = c.BookNotesUpdated.ToArray()}).ToList() _
                                            , .BookTracks = ( _
                                                    From c In d.BookTracks _
                                                    Select New DTO.BookTrack With {.BookTrackControl = c.BookTrackControl _
                                                    , .BookTrackBookControl = c.BookTrackBookControl _
                                                    , .BookTrackDate = c.BookTrackDate _
                                                    , .BookTrackContact = c.BookTrackContact _
                                                    , .BookTrackComment = c.BookTrackComment _
                                                    , .BookTrackStatus = If(c.BookTrackStatus.HasValue, c.BookTrackStatus, 0) _
                                                    , .BookTrackModDate = c.BookTrackModDate _
                                                    , .BookTrackModUser = c.BookTrackModUser _
                                                    , .BookTrackUpdated = c.BookTrackUpdated.ToArray()}).ToList() _
                                              }).Take(20).ToArray()

                Return Books

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBooksByPONumberContains(ByVal BookLoadPONumber As String) As DTO.Book()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl

                If BookLoadPONumber Is Nothing OrElse String.IsNullOrEmpty(BookLoadPONumber) Then Return Nothing
                Dim oBLs = From bl In db.BookLoads Where bl.BookLoadPONumber.Contains(BookLoadPONumber) Select bl.BookLoadBookControl

                Dim oDLO As New DataLoadOptions
                oDLO.LoadWith(Of LTS.Book)(Function(t As LTS.Book) t.BookLoads)
                oDLO.LoadWith(Of LTS.Book)(Function(t As LTS.Book) t.BookNotes)
                oDLO.LoadWith(Of LTS.Book)(Function(t As LTS.Book) t.BookTracks)
                oDLO.LoadWith(Of LTS.BookLoad)(Function(t As LTS.BookLoad) t.BookItems)
                db.LoadOptions = oDLO
                'Get the newest record that matches the provided criteria
                Dim Books() As DTO.Book = ( _
                From d In db.Books _
                Where oBLs.Contains(d.BookControl) _
                And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.BookCustCompControl)) _
                Order By d.BookStopNo Ascending _
                Select New DTO.Book With {.BookControl = d.BookControl _
                                            , .BookProNumber = d.BookProNumber _
                                            , .BookProBase = d.BookProBase _
                                            , .BookConsPrefix = d.BookConsPrefix _
                                            , .BookCustCompControl = d.BookCustCompControl _
                                            , .BookCommCompControl = d.BookCommCompControl _
                                            , .BookODControl = d.BookODControl _
                                            , .BookCarrierControl = d.BookCarrierControl _
                                            , .BookCarrierContact = d.BookCarrierContact _
                                            , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                            , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                            , .BookOrigName = d.BookOrigName _
                                            , .BookOrigAddress1 = d.BookOrigAddress1 _
                                            , .BookOrigAddress2 = d.BookOrigAddress2 _
                                            , .BookOrigAddress3 = d.BookOrigAddress3 _
                                            , .BookOrigCity = d.BookOrigCity _
                                            , .BookOrigState = d.BookOrigState _
                                            , .BookOrigCountry = d.BookOrigCountry _
                                            , .BookOrigZip = d.BookOrigZip _
                                            , .BookOrigPhone = d.BookOrigPhone _
                                            , .BookOrigFax = d.BookOrigFax _
                                            , .BookOriginStartHrs = d.BookOriginStartHrs _
                                            , .BookOriginStopHrs = d.BookOriginStopHrs _
                                            , .BookOriginApptReq = If(d.BookOriginApptReq.HasValue, d.BookOriginApptReq, False) _
                                            , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                            , .BookDestName = d.BookDestName _
                                            , .BookDestAddress1 = d.BookDestAddress1 _
                                            , .BookDestAddress2 = d.BookDestAddress2 _
                                            , .BookDestAddress3 = d.BookDestAddress3 _
                                            , .BookDestCity = d.BookDestCity _
                                            , .BookDestState = d.BookDestState _
                                            , .BookDestCountry = d.BookDestCountry _
                                            , .BookDestZip = d.BookDestZip _
                                            , .BookDestPhone = d.BookDestPhone _
                                            , .BookDestFax = d.BookDestFax _
                                            , .BookDestStartHrs = d.BookDestStartHrs _
                                            , .BookDestStopHrs = d.BookDestStopHrs _
                                            , .BookDestApptReq = If(d.BookDestApptReq.HasValue, d.BookDestApptReq, False) _
                                            , .BookDateOrdered = d.BookDateOrdered _
                                            , .BookDateLoad = d.BookDateLoad _
                                            , .BookDateInvoice = d.BookDateInvoice _
                                            , .BookDateRequired = d.BookDateRequired _
                                            , .BookDateDelivered = d.BookDateDelivered _
                                            , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                            , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                            , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                            , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                            , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                            , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                            , .BookTranCode = d.BookTranCode _
                                            , .BookPayCode = d.BookPayCode _
                                            , .BookTypeCode = d.BookTypeCode _
                                            , .BookBOLCode = d.BookBOLCode _
                                            , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                            , .BookCarrFBNumber = d.BookCarrFBNumber _
                                            , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                            , .BookCarrBLNumber = d.BookCarrBLNumber _
                                            , .BookCarrBookDate = d.BookCarrBookDate _
                                            , .BookCarrBookTime = d.BookCarrBookTime _
                                            , .BookCarrBookContact = d.BookCarrBookContact _
                                            , .BookCarrScheduleDate = d.BookCarrScheduleDate _
                                            , .BookCarrScheduleTime = d.BookCarrScheduleTime _
                                            , .BookCarrActualDate = d.BookCarrActualDate _
                                            , .BookCarrActualTime = d.BookCarrActualTime _
                                            , .BookCarrActLoadComplete_Date = d.BookCarrActLoadComplete_Date _
                                            , .BookCarrActLoadCompleteTime = d.BookCarrActLoadCompleteTime _
                                            , .BookCarrDockPUAssigment = d.BookCarrDockPUAssigment _
                                            , .BookCarrPODate = d.BookCarrPODate _
                                            , .BookCarrPOTime = d.BookCarrPOTime _
                                            , .BookCarrApptDate = d.BookCarrApptDate _
                                            , .BookCarrApptTime = d.BookCarrApptTime _
                                            , .BookCarrActDate = d.BookCarrActDate _
                                            , .BookCarrActTime = d.BookCarrActTime _
                                            , .BookCarrActUnloadCompDate = d.BookCarrActUnloadCompDate _
                                            , .BookCarrActUnloadCompTime = d.BookCarrActUnloadCompTime _
                                            , .BookCarrDockDelAssignment = d.BookCarrDockDelAssignment _
                                            , .BookCarrVarDay = If(d.BookCarrVarDay.HasValue, d.BookCarrVarDay, 0) _
                                            , .BookCarrVarHrs = If(d.BookCarrVarHrs.HasValue, d.BookCarrVarHrs, 0) _
                                            , .BookCarrTrailerNo = d.BookCarrTrailerNo _
                                            , .BookCarrSealNo = d.BookCarrSealNo _
                                            , .BookCarrDriverNo = d.BookCarrDriverNo _
                                            , .BookCarrDriverName = d.BookCarrDriverName _
                                            , .BookCarrRouteNo = d.BookCarrRouteNo _
                                            , .BookCarrTripNo = d.BookCarrTripNo _
                                            , .BookFinARBookFrt = If(d.BookFinARBookFrt.HasValue, d.BookFinARBookFrt, 0) _
                                            , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                            , .BookFinARInvoiceAmt = If(d.BookFinARInvoiceAmt.HasValue, d.BookFinARInvoiceAmt, 0) _
                                            , .BookFinARPayDate = d.BookFinARPayDate _
                                            , .BookFinARPayAmt = If(d.BookFinARPayAmt.HasValue, d.BookFinARPayAmt, 0) _
                                            , .BookFinARCheck = d.BookFinARCheck _
                                            , .BookFinARGLNumber = d.BookFinARGLNumber _
                                            , .BookFinARBalance = If(d.BookFinARBalance.HasValue, d.BookFinARBalance, 0) _
                                            , .BookFinARCurType = If(d.BookFinARCurType.HasValue, d.BookFinARCurType, 0) _
                                            , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                            , .BookFinAPBillNoDate = d.BookFinAPBillNoDate _
                                            , .BookFinAPBillInvDate = d.BookFinAPBillInvDate _
                                            , .BookFinAPActWgt = If(d.BookFinAPActWgt.HasValue, d.BookFinAPActWgt, 0) _
                                            , .BookFinAPStdCost = If(d.BookFinAPStdCost.HasValue, d.BookFinAPStdCost, 0) _
                                            , .BookFinAPActCost = If(d.BookFinAPActCost.HasValue, d.BookFinAPActCost, 0) _
                                            , .BookFinAPPayDate = d.BookFinAPPayDate _
                                            , .BookFinAPPayAmt = If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0) _
                                            , .BookFinAPCheck = d.BookFinAPCheck _
                                            , .BookFinAPGLNumber = d.BookFinAPGLNumber _
                                            , .BookFinAPLastViewed = d.BookFinAPLastViewed _
                                            , .BookFinAPCurType = If(d.BookFinAPCurType.HasValue, d.BookFinAPCurType, 0) _
                                            , .BookFinCommStd = If(d.BookFinCommStd.HasValue, d.BookFinCommStd, 0) _
                                            , .BookFinCommAct = If(d.BookFinCommAct.HasValue, d.BookFinCommAct, 0) _
                                            , .BookFinCommPayDate = d.BookFinCommPayDate _
                                            , .BookFinCommPayAmt = If(d.BookFinCommPayAmt.HasValue, d.BookFinCommPayAmt, 0) _
                                            , .BookFinCommtCheck = d.BookFinCommtCheck _
                                            , .BookFinCommCreditAmt = If(d.BookFinCommCreditAmt.HasValue, d.BookFinCommCreditAmt, 0) _
                                            , .BookFinCommCreditPayDate = d.BookFinCommCreditPayDate _
                                            , .BookFinCommLoadCount = If(d.BookFinCommLoadCount.HasValue, d.BookFinCommLoadCount, 0) _
                                            , .BookFinCommGLNumber = d.BookFinCommGLNumber _
                                            , .BookFinCheckClearedDate = d.BookFinCheckClearedDate _
                                            , .BookFinCheckClearedNumber = d.BookFinCheckClearedNumber _
                                            , .BookFinCheckClearedAmt = If(d.BookFinCheckClearedAmt.HasValue, d.BookFinCheckClearedAmt, 0) _
                                            , .BookFinCheckClearedDesc = d.BookFinCheckClearedDesc _
                                            , .BookFinCheckClearedAcct = d.BookFinCheckClearedAcct _
                                            , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                            , .BookRevCarrierCost = If(d.BookRevCarrierCost.HasValue, d.BookRevCarrierCost, 0) _
                                            , .BookRevStopQty = If(d.BookRevStopQty.HasValue, d.BookRevStopQty, 0) _
                                            , .BookRevStopCost = If(d.BookRevStopCost.HasValue, d.BookRevStopCost, 0) _
                                            , .BookRevOtherCost = If(d.BookRevOtherCost.HasValue, d.BookRevOtherCost, 0) _
                                            , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                            , .BookRevLoadSavings = If(d.BookRevLoadSavings.HasValue, d.BookRevLoadSavings, 0) _
                                            , .BookRevCommPercent = If(d.BookRevCommPercent.HasValue, d.BookRevCommPercent, 0) _
                                            , .BookRevCommCost = If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0) _
                                            , .BookRevGrossRevenue = If(d.BookRevGrossRevenue.HasValue, d.BookRevGrossRevenue, 0) _
                                            , .BookRevNegRevenue = If(d.BookRevNegRevenue.HasValue, d.BookRevNegRevenue, 0) _
                                            , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                            , .BookLaneCarrControl = If(d.BookLaneCarrControl.HasValue, d.BookLaneCarrControl, 0) _
                                            , .BookHoldLoad = If(d.BookHoldLoad.HasValue, d.BookHoldLoad, 0) _
                                            , .BookRouteFinalDate = d.BookRouteFinalDate _
                                            , .BookRouteFinalCode = d.BookRouteFinalCode _
                                            , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                            , .BookWarehouseNumber = d.BookWarehouseNumber _
                                            , .BookComCode = d.BookComCode _
                                            , .BookTransType = d.BookTransType _
                                            , .BookRouteConsFlag = d.BookRouteConsFlag _
                                            , .BookWhseAuthorizationNo = d.BookWhseAuthorizationNo _
                                            , .BookHotLoad = If(d.BookHotLoad.HasValue, d.BookHotLoad, False) _
                                            , .BookFinAPActTax = If(d.BookFinAPActTax.HasValue, d.BookFinAPActTax, 0) _
                                            , .BookFinAPExportFlag = d.BookFinAPExportFlag _
                                            , .BookFinARFreightTax = d.BookFinARFreightTax _
                                            , .BookRevFreightTax = d.BookRevFreightTax _
                                            , .BookRevNetCost = d.BookRevNetCost _
                                            , .BookFinServiceFee = If(d.BookFinServiceFee.HasValue, d.BookFinServiceFee, 0) _
                                            , .BookFinAPExportDate = d.BookFinAPExportDate _
                                            , .BookFinAPExportRetry = If(d.BookFinAPExportRetry.HasValue, d.BookFinAPExportRetry, 0) _
                                            , .BookCarrierContControl = If(d.BookCarrierContControl.HasValue, d.BookCarrierContControl, 0) _
                                            , .BookHotLoadSent = If(d.BookHotLoadSent.HasValue, d.BookHotLoadSent, False) _
                                            , .BookExportDocCreated = If(d.BookExportDocCreated.HasValue, d.BookExportDocCreated, False) _
                                            , .BookDoNotInvoice = d.BookDoNotInvoice _
                                            , .BookCarrStartLoadingDate = d.BookCarrStartLoadingDate _
                                            , .BookCarrStartLoadingTime = d.BookCarrStartLoadingTime _
                                            , .BookCarrFinishLoadingDate = d.BookCarrFinishLoadingDate _
                                            , .BookCarrFinishLoadingTime = d.BookCarrFinishLoadingTime _
                                            , .BookCarrStartUnloadingDate = d.BookCarrStartUnloadingDate _
                                            , .BookCarrStartUnloadingTime = d.BookCarrStartUnloadingTime _
                                            , .BookCarrFinishUnloadingDate = d.BookCarrFinishUnloadingDate _
                                            , .BookCarrFinishUnloadingTime = d.BookCarrFinishUnloadingTime _
                                            , .BookOrderSequence = d.BookOrderSequence _
                                            , .BookChepGLID = d.BookChepGLID _
                                            , .BookCarrierTypeCode = d.BookCarrierTypeCode _
                                            , .BookPalletPositions = d.BookPalletPositions _
                                            , .BookShipCarrierProNumber = d.BookShipCarrierProNumber _
                                            , .BookShipCarrierName = d.BookShipCarrierName _
                                            , .BookShipCarrierNumber = d.BookShipCarrierNumber _
                                            , .BookAPAdjReasonControl = d.BookAPAdjReasonControl _
                                            , .BookDateRequested = d.BookDateRequested _
                                            , .BookCarrierEquipmentCodes = d.BookCarrierEquipmentCodes _
                                            , .BookLockAllCosts = d.BookLockAllCosts _
                                            , .BookLockBFCCost = d.BookLockBFCCost _
                                            , .BookDestStopNumber = d.BookDestStopNumber _
                                            , .BookOrigStopNumber = d.BookOrigStopNumber _
                                            , .BookDestStopControl = d.BookDestStopControl _
                                            , .BookOrigStopControl = d.BookOrigStopControl _
                                            , .BookRouteTypeCode = d.BookRouteTypeCode _
                                            , .BookAlternateAddressLaneControl = d.BookAlternateAddressLaneControl _
                                            , .BookAlternateAddressLaneNumber = d.BookAlternateAddressLaneNumber _
                                            , .BookDefaultRouteSequence = d.BookDefaultRouteSequence _
                                            , .BookRouteGuideControl = d.BookRouteGuideControl _
                                            , .BookRouteGuideNumber = d.BookRouteGuideNumber _
                                            , .BookCustomerApprovalRecieved = d.BookCustomerApprovalRecieved _
                                            , .BookCustomerApprovalTransmitted = d.BookCustomerApprovalTransmitted _
                                            , .BookAMSPickupApptControl = d.BookAMSPickupApptControl _
                                            , .BookAMSDeliveryApptControl = d.BookAMSDeliveryApptControl _
                                            , .BookItemDetailDescription = d.BookItemDetailDescription _
                                            , .BookModDate = d.BookModDate _
                                            , .BookModUser = d.BookModUser _
                                            , .BookUpdated = d.BookUpdated.ToArray _
                                              , .BookLoads = ( _
                                                    From c In d.BookLoads _
                                                    Select New DTO.BookLoad With {.BookLoadControl = c.BookLoadControl _
                                                    , .BookLoadBookControl = c.BookLoadBookControl _
                                                    , .BookLoadBuy = c.BookLoadBuy _
                                                    , .BookLoadPONumber = c.BookLoadPONumber _
                                                    , .BookLoadVendor = c.BookLoadVendor _
                                                    , .BookLoadCaseQty = If(c.BookLoadCaseQty.HasValue, c.BookLoadCaseQty, 0) _
                                                    , .BookLoadWgt = If(c.BookLoadWgt.HasValue, c.BookLoadWgt, 0) _
                                                    , .BookLoadCube = If(c.BookLoadCube.HasValue, c.BookLoadCube, 0) _
                                                    , .BookLoadPL = If(c.BookLoadPL.HasValue, c.BookLoadPL, 0) _
                                                    , .BookLoadPX = If(c.BookLoadPX.HasValue, c.BookLoadPX, 0) _
                                                    , .BookLoadPType = c.BookLoadPType _
                                                    , .BookLoadCom = c.BookLoadCom _
                                                    , .BookLoadPUOrigin = c.BookLoadPUOrigin _
                                                    , .BookLoadBFC = If(c.BookLoadBFC.HasValue, c.BookLoadBFC, 0) _
                                                    , .BookLoadTotCost = If(c.BookLoadTotCost.HasValue, c.BookLoadTotCost, 0) _
                                                    , .BookLoadComments = c.BookLoadComments _
                                                    , .BookLoadStopSeq = If(c.BookLoadStopSeq.HasValue, c.BookLoadStopSeq, 0) _
                                                    , .BookLoadModDate = c.BookLoadModDate _
                                                    , .BookLoadModUser = c.BookLoadModUser _
                                                    , .BookLoadUpdated = c.BookLoadUpdated.ToArray() _
                                                    , .BookItems = ( _
                                                        From i In c.BookItems _
                                                        Select New DTO.BookItem With {.BookItemControl = i.BookItemControl _
                                                       , .BookItemBookLoadControl = i.BookItemBookLoadControl _
                                                       , .BookItemFixOffInvAllow = If(i.BookItemFixOffInvAllow.HasValue, i.BookItemFixOffInvAllow, 0) _
                                                       , .BookItemFixFrtAllow = If(i.BookItemFixFrtAllow.HasValue, i.BookItemFixFrtAllow, 0) _
                                                       , .BookItemItemNumber = i.BookItemItemNumber _
                                                       , .BookItemQtyOrdered = If(i.BookItemQtyOrdered.HasValue, i.BookItemQtyOrdered, 0) _
                                                       , .BookItemFreightCost = If(i.BookItemFreightCost.HasValue, i.BookItemFreightCost, 0) _
                                                       , .BookItemItemCost = If(i.BookItemItemCost.HasValue, i.BookItemItemCost, 0) _
                                                       , .BookItemWeight = If(i.BookItemWeight.HasValue, i.BookItemWeight, 0) _
                                                       , .BookItemCube = If(i.BookItemCube.HasValue, i.BookItemCube, 0) _
                                                       , .BookItemPack = If(i.BookItemPack.HasValue, i.BookItemPack, 0) _
                                                       , .BookItemSize = i.BookItemSize _
                                                       , .BookItemDescription = i.BookItemDescription _
                                                       , .BookItemHazmat = i.BookItemHazmat _
                                                       , .BookItemModDate = i.BookItemModDate _
                                                       , .BookItemModUser = i.BookItemModUser _
                                                       , .BookItemBrand = i.BookItemBrand _
                                                       , .BookItemCostCenter = i.BookItemCostCenter _
                                                       , .BookItemLotNumber = i.BookItemLotNumber _
                                                       , .BookItemLotExpirationDate = i.BookItemLotExpirationDate _
                                                       , .BookItemGTIN = i.BookItemGTIN _
                                                       , .BookCustItemNumber = i.BookCustItemNumber _
                                                       , .BookItemBFC = If(i.BookItemBFC.HasValue, i.BookItemBFC, 0) _
                                                       , .BookItemCountryOfOrigin = i.BookItemCountryOfOrigin _
                                                       , .BookItemHST = i.BookItemHST _
                                                       , .BookItemPalletTypeID = i.BookItemPalletTypeID _
                                                       , .BookItemHazmatTypeCode = i.BookItemHazmatTypeCode _
                                                       , .BookItem49CFRCode = i.BookItem49CFRCode _
                                                       , .BookItemIATACode = i.BookItemIATACode _
                                                       , .BookItemDOTCode = i.BookItemDOTCode _
                                                       , .BookItemMarineCode = i.BookItemMarineCode _
                                                       , .BookItemNMFCClass = i.BookItemNMFCClass _
                                                       , .BookItemFAKClass = i.BookItemFAKClass _
                                                       , .BookItemLimitedQtyFlag = i.BookItemLimitedQtyFlag _
                                                       , .BookItemPallets = i.BookItemPallets _
                                                       , .BookItemTies = i.BookItemTies _
                                                       , .BookItemHighs = i.BookItemHighs _
                                                       , .BookItemQtyPalletPercentage = i.BookItemQtyPalletPercentage _
                                                       , .BookItemQtyLength = i.BookItemQtyLength _
                                                       , .BookItemQtyWidth = i.BookItemQtyWidth _
                                                       , .BookItemQtyHeight = i.BookItemQtyHeight _
                                                       , .BookItemStackable = i.BookItemStackable _
                                                       , .BookItemLevelOfDensity = i.BookItemLevelOfDensity _
                                                       , .BookItemUpdated = i.BookItemUpdated.ToArray()}).ToList() _
                                                }).ToList() _
                                            , .BookNotes = ( _
                                                    From c In d.BookNotes _
                                                    Select New DTO.BookNote With {.BookNotesControl = c.BookNotesControl _
                                                    , .BookNotesBookControl = c.BookNotesBookControl _
                                                    , .BookNotesVisable1 = c.BookNotesVisable1 _
                                                    , .BookNotesVisable2 = c.BookNotesVisable2 _
                                                    , .BookNotesVisable3 = c.BookNotesVisable3 _
                                                    , .BookNotesVisable4 = c.BookNotesVisable4 _
                                                    , .BookNotesVisable5 = c.BookNotesVisable5 _
                                                    , .BookNotesConfidential1 = c.BookNotesConfidential1 _
                                                    , .BookNotesConfidential2 = c.BookNotesConfidential2 _
                                                    , .BookNotesConfidential3 = c.BookNotesConfidential3 _
                                                    , .BookNotesConfidential4 = c.BookNotesConfidential4 _
                                                    , .BookNotesConfidential5 = c.BookNotesConfidential5 _
                                                    , .BookNotesModDate = c.BookNotesModDate _
                                                    , .BookNotesModUser = c.BookNotesModUser _
                                                    , .BookNotesUpdated = c.BookNotesUpdated.ToArray()}).ToList() _
                                            , .BookTracks = ( _
                                                    From c In d.BookTracks _
                                                    Select New DTO.BookTrack With {.BookTrackControl = c.BookTrackControl _
                                                    , .BookTrackBookControl = c.BookTrackBookControl _
                                                    , .BookTrackDate = c.BookTrackDate _
                                                    , .BookTrackContact = c.BookTrackContact _
                                                    , .BookTrackComment = c.BookTrackComment _
                                                    , .BookTrackStatus = If(c.BookTrackStatus.HasValue, c.BookTrackStatus, 0) _
                                                    , .BookTrackModDate = c.BookTrackModDate _
                                                    , .BookTrackModUser = c.BookTrackModUser _
                                                    , .BookTrackUpdated = c.BookTrackUpdated.ToArray()}).ToList() _
                                              }).Take(20).ToArray()

                Return Books

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function


    Public Function GetBooksByAppointment(ByVal AMSApptControl As Integer) As DTO.Book()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                If AMSApptControl = 0 Then Return Nothing

                Dim oDLO As New DataLoadOptions
                oDLO.LoadWith(Of LTS.Book)(Function(t As LTS.Book) t.BookLoads)
                db.LoadOptions = oDLO

                Dim Books() As DTO.Book = ( _
                From d In db.Books _
                Where _
                (d.BookAMSPickupApptControl = AMSApptControl Or d.BookAMSDeliveryApptControl = AMSApptControl) _
                Select New DTO.Book With {.BookControl = d.BookControl _
                                            , .BookProNumber = d.BookProNumber _
                                            , .BookProBase = d.BookProBase _
                                            , .BookConsPrefix = d.BookConsPrefix _
                                            , .BookCustCompControl = d.BookCustCompControl _
                                            , .BookCommCompControl = d.BookCommCompControl _
                                            , .BookODControl = d.BookODControl _
                                            , .BookCarrierControl = d.BookCarrierControl _
                                            , .BookCarrierContact = d.BookCarrierContact _
                                            , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                            , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                            , .BookOrigName = d.BookOrigName _
                                            , .BookOrigAddress1 = d.BookOrigAddress1 _
                                            , .BookOrigAddress2 = d.BookOrigAddress2 _
                                            , .BookOrigAddress3 = d.BookOrigAddress3 _
                                            , .BookOrigCity = d.BookOrigCity _
                                            , .BookOrigState = d.BookOrigState _
                                            , .BookOrigCountry = d.BookOrigCountry _
                                            , .BookOrigZip = d.BookOrigZip _
                                            , .BookOrigPhone = d.BookOrigPhone _
                                            , .BookOrigFax = d.BookOrigFax _
                                            , .BookOriginStartHrs = d.BookOriginStartHrs _
                                            , .BookOriginStopHrs = d.BookOriginStopHrs _
                                            , .BookOriginApptReq = If(d.BookOriginApptReq.HasValue, d.BookOriginApptReq, False) _
                                            , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                            , .BookDestName = d.BookDestName _
                                            , .BookDestAddress1 = d.BookDestAddress1 _
                                            , .BookDestAddress2 = d.BookDestAddress2 _
                                            , .BookDestAddress3 = d.BookDestAddress3 _
                                            , .BookDestCity = d.BookDestCity _
                                            , .BookDestState = d.BookDestState _
                                            , .BookDestCountry = d.BookDestCountry _
                                            , .BookDestZip = d.BookDestZip _
                                            , .BookDestPhone = d.BookDestPhone _
                                            , .BookDestFax = d.BookDestFax _
                                            , .BookDestStartHrs = d.BookDestStartHrs _
                                            , .BookDestStopHrs = d.BookDestStopHrs _
                                            , .BookDestApptReq = If(d.BookDestApptReq.HasValue, d.BookDestApptReq, False) _
                                            , .BookDateOrdered = d.BookDateOrdered _
                                            , .BookDateLoad = d.BookDateLoad _
                                            , .BookDateInvoice = d.BookDateInvoice _
                                            , .BookDateRequired = d.BookDateRequired _
                                            , .BookDateDelivered = d.BookDateDelivered _
                                            , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                            , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                            , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                            , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                            , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                            , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                            , .BookTranCode = d.BookTranCode _
                                            , .BookPayCode = d.BookPayCode _
                                            , .BookTypeCode = d.BookTypeCode _
                                            , .BookBOLCode = d.BookBOLCode _
                                            , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                            , .BookCarrFBNumber = d.BookCarrFBNumber _
                                            , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                            , .BookCarrBLNumber = d.BookCarrBLNumber _
                                            , .BookCarrBookDate = d.BookCarrBookDate _
                                            , .BookCarrBookTime = d.BookCarrBookTime _
                                            , .BookCarrBookContact = d.BookCarrBookContact _
                                            , .BookCarrScheduleDate = d.BookCarrScheduleDate _
                                            , .BookCarrScheduleTime = d.BookCarrScheduleTime _
                                            , .BookCarrActualDate = d.BookCarrActualDate _
                                            , .BookCarrActualTime = d.BookCarrActualTime _
                                            , .BookCarrActLoadComplete_Date = d.BookCarrActLoadComplete_Date _
                                            , .BookCarrActLoadCompleteTime = d.BookCarrActLoadCompleteTime _
                                            , .BookCarrDockPUAssigment = d.BookCarrDockPUAssigment _
                                            , .BookCarrPODate = d.BookCarrPODate _
                                            , .BookCarrPOTime = d.BookCarrPOTime _
                                            , .BookCarrApptDate = d.BookCarrApptDate _
                                            , .BookCarrApptTime = d.BookCarrApptTime _
                                            , .BookCarrActDate = d.BookCarrActDate _
                                            , .BookCarrActTime = d.BookCarrActTime _
                                            , .BookCarrActUnloadCompDate = d.BookCarrActUnloadCompDate _
                                            , .BookCarrActUnloadCompTime = d.BookCarrActUnloadCompTime _
                                            , .BookCarrDockDelAssignment = d.BookCarrDockDelAssignment _
                                            , .BookCarrVarDay = If(d.BookCarrVarDay.HasValue, d.BookCarrVarDay, 0) _
                                            , .BookCarrVarHrs = If(d.BookCarrVarHrs.HasValue, d.BookCarrVarHrs, 0) _
                                            , .BookCarrTrailerNo = d.BookCarrTrailerNo _
                                            , .BookCarrSealNo = d.BookCarrSealNo _
                                            , .BookCarrDriverNo = d.BookCarrDriverNo _
                                            , .BookCarrDriverName = d.BookCarrDriverName _
                                            , .BookCarrRouteNo = d.BookCarrRouteNo _
                                            , .BookCarrTripNo = d.BookCarrTripNo _
                                            , .BookFinARBookFrt = If(d.BookFinARBookFrt.HasValue, d.BookFinARBookFrt, 0) _
                                            , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                            , .BookFinARInvoiceAmt = If(d.BookFinARInvoiceAmt.HasValue, d.BookFinARInvoiceAmt, 0) _
                                            , .BookFinARPayDate = d.BookFinARPayDate _
                                            , .BookFinARPayAmt = If(d.BookFinARPayAmt.HasValue, d.BookFinARPayAmt, 0) _
                                            , .BookFinARCheck = d.BookFinARCheck _
                                            , .BookFinARGLNumber = d.BookFinARGLNumber _
                                            , .BookFinARBalance = If(d.BookFinARBalance.HasValue, d.BookFinARBalance, 0) _
                                            , .BookFinARCurType = If(d.BookFinARCurType.HasValue, d.BookFinARCurType, 0) _
                                            , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                            , .BookFinAPBillNoDate = d.BookFinAPBillNoDate _
                                            , .BookFinAPBillInvDate = d.BookFinAPBillInvDate _
                                            , .BookFinAPActWgt = If(d.BookFinAPActWgt.HasValue, d.BookFinAPActWgt, 0) _
                                            , .BookFinAPStdCost = If(d.BookFinAPStdCost.HasValue, d.BookFinAPStdCost, 0) _
                                            , .BookFinAPActCost = If(d.BookFinAPActCost.HasValue, d.BookFinAPActCost, 0) _
                                            , .BookFinAPPayDate = d.BookFinAPPayDate _
                                            , .BookFinAPPayAmt = If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0) _
                                            , .BookFinAPCheck = d.BookFinAPCheck _
                                            , .BookFinAPGLNumber = d.BookFinAPGLNumber _
                                            , .BookFinAPLastViewed = d.BookFinAPLastViewed _
                                            , .BookFinAPCurType = If(d.BookFinAPCurType.HasValue, d.BookFinAPCurType, 0) _
                                            , .BookFinCommStd = If(d.BookFinCommStd.HasValue, d.BookFinCommStd, 0) _
                                            , .BookFinCommAct = If(d.BookFinCommAct.HasValue, d.BookFinCommAct, 0) _
                                            , .BookFinCommPayDate = d.BookFinCommPayDate _
                                            , .BookFinCommPayAmt = If(d.BookFinCommPayAmt.HasValue, d.BookFinCommPayAmt, 0) _
                                            , .BookFinCommtCheck = d.BookFinCommtCheck _
                                            , .BookFinCommCreditAmt = If(d.BookFinCommCreditAmt.HasValue, d.BookFinCommCreditAmt, 0) _
                                            , .BookFinCommCreditPayDate = d.BookFinCommCreditPayDate _
                                            , .BookFinCommLoadCount = If(d.BookFinCommLoadCount.HasValue, d.BookFinCommLoadCount, 0) _
                                            , .BookFinCommGLNumber = d.BookFinCommGLNumber _
                                            , .BookFinCheckClearedDate = d.BookFinCheckClearedDate _
                                            , .BookFinCheckClearedNumber = d.BookFinCheckClearedNumber _
                                            , .BookFinCheckClearedAmt = If(d.BookFinCheckClearedAmt.HasValue, d.BookFinCheckClearedAmt, 0) _
                                            , .BookFinCheckClearedDesc = d.BookFinCheckClearedDesc _
                                            , .BookFinCheckClearedAcct = d.BookFinCheckClearedAcct _
                                            , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                            , .BookRevCarrierCost = If(d.BookRevCarrierCost.HasValue, d.BookRevCarrierCost, 0) _
                                            , .BookRevStopQty = If(d.BookRevStopQty.HasValue, d.BookRevStopQty, 0) _
                                            , .BookRevStopCost = If(d.BookRevStopCost.HasValue, d.BookRevStopCost, 0) _
                                            , .BookRevOtherCost = If(d.BookRevOtherCost.HasValue, d.BookRevOtherCost, 0) _
                                            , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                            , .BookRevLoadSavings = If(d.BookRevLoadSavings.HasValue, d.BookRevLoadSavings, 0) _
                                            , .BookRevCommPercent = If(d.BookRevCommPercent.HasValue, d.BookRevCommPercent, 0) _
                                            , .BookRevCommCost = If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0) _
                                            , .BookRevGrossRevenue = If(d.BookRevGrossRevenue.HasValue, d.BookRevGrossRevenue, 0) _
                                            , .BookRevNegRevenue = If(d.BookRevNegRevenue.HasValue, d.BookRevNegRevenue, 0) _
                                            , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                            , .BookLaneCarrControl = If(d.BookLaneCarrControl.HasValue, d.BookLaneCarrControl, 0) _
                                            , .BookHoldLoad = If(d.BookHoldLoad.HasValue, d.BookHoldLoad, 0) _
                                            , .BookRouteFinalDate = d.BookRouteFinalDate _
                                            , .BookRouteFinalCode = d.BookRouteFinalCode _
                                            , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                            , .BookWarehouseNumber = d.BookWarehouseNumber _
                                            , .BookComCode = d.BookComCode _
                                            , .BookTransType = d.BookTransType _
                                            , .BookRouteConsFlag = d.BookRouteConsFlag _
                                            , .BookWhseAuthorizationNo = d.BookWhseAuthorizationNo _
                                            , .BookHotLoad = If(d.BookHotLoad.HasValue, d.BookHotLoad, False) _
                                            , .BookFinAPActTax = If(d.BookFinAPActTax.HasValue, d.BookFinAPActTax, 0) _
                                            , .BookFinAPExportFlag = d.BookFinAPExportFlag _
                                            , .BookFinARFreightTax = d.BookFinARFreightTax _
                                            , .BookRevFreightTax = d.BookRevFreightTax _
                                            , .BookRevNetCost = d.BookRevNetCost _
                                            , .BookFinServiceFee = If(d.BookFinServiceFee.HasValue, d.BookFinServiceFee, 0) _
                                            , .BookFinAPExportDate = d.BookFinAPExportDate _
                                            , .BookFinAPExportRetry = If(d.BookFinAPExportRetry.HasValue, d.BookFinAPExportRetry, 0) _
                                            , .BookCarrierContControl = If(d.BookCarrierContControl.HasValue, d.BookCarrierContControl, 0) _
                                            , .BookHotLoadSent = If(d.BookHotLoadSent.HasValue, d.BookHotLoadSent, False) _
                                            , .BookExportDocCreated = If(d.BookExportDocCreated.HasValue, d.BookExportDocCreated, False) _
                                            , .BookDoNotInvoice = d.BookDoNotInvoice _
                                            , .BookCarrStartLoadingDate = d.BookCarrStartLoadingDate _
                                            , .BookCarrStartLoadingTime = d.BookCarrStartLoadingTime _
                                            , .BookCarrFinishLoadingDate = d.BookCarrFinishLoadingDate _
                                            , .BookCarrFinishLoadingTime = d.BookCarrFinishLoadingTime _
                                            , .BookCarrStartUnloadingDate = d.BookCarrStartUnloadingDate _
                                            , .BookCarrStartUnloadingTime = d.BookCarrStartUnloadingTime _
                                            , .BookCarrFinishUnloadingDate = d.BookCarrFinishUnloadingDate _
                                            , .BookCarrFinishUnloadingTime = d.BookCarrFinishUnloadingTime _
                                            , .BookOrderSequence = d.BookOrderSequence _
                                            , .BookChepGLID = d.BookChepGLID _
                                            , .BookCarrierTypeCode = d.BookCarrierTypeCode _
                                            , .BookPalletPositions = d.BookPalletPositions _
                                            , .BookShipCarrierProNumber = d.BookShipCarrierProNumber _
                                            , .BookShipCarrierName = d.BookShipCarrierName _
                                            , .BookShipCarrierNumber = d.BookShipCarrierNumber _
                                            , .BookAPAdjReasonControl = d.BookAPAdjReasonControl _
                                            , .BookDateRequested = d.BookDateRequested _
                                            , .BookCarrierEquipmentCodes = d.BookCarrierEquipmentCodes _
                                            , .BookLockAllCosts = d.BookLockAllCosts _
                                            , .BookLockBFCCost = d.BookLockBFCCost _
                                            , .BookDestStopNumber = d.BookDestStopNumber _
                                            , .BookOrigStopNumber = d.BookOrigStopNumber _
                                            , .BookDestStopControl = d.BookDestStopControl _
                                            , .BookOrigStopControl = d.BookOrigStopControl _
                                            , .BookRouteTypeCode = d.BookRouteTypeCode _
                                            , .BookAlternateAddressLaneControl = d.BookAlternateAddressLaneControl _
                                            , .BookAlternateAddressLaneNumber = d.BookAlternateAddressLaneNumber _
                                            , .BookDefaultRouteSequence = d.BookDefaultRouteSequence _
                                            , .BookRouteGuideControl = d.BookRouteGuideControl _
                                            , .BookRouteGuideNumber = d.BookRouteGuideNumber _
                                            , .BookCustomerApprovalRecieved = d.BookCustomerApprovalRecieved _
                                            , .BookCustomerApprovalTransmitted = d.BookCustomerApprovalTransmitted _
                                            , .BookAMSPickupApptControl = d.BookAMSPickupApptControl _
                                            , .BookAMSDeliveryApptControl = d.BookAMSDeliveryApptControl _
                                            , .BookItemDetailDescription = d.BookItemDetailDescription _
                                            , .BookModDate = d.BookModDate _
                                            , .BookModUser = d.BookModUser _
                                            , .BookUpdated = d.BookUpdated.ToArray _
                                            , .BookLoads = ( _
                                                    From c In d.BookLoads _
                                                    Select New DTO.BookLoad With {.BookLoadControl = c.BookLoadControl _
                                                    , .BookLoadBookControl = c.BookLoadBookControl _
                                                    , .BookLoadBuy = c.BookLoadBuy _
                                                    , .BookLoadPONumber = c.BookLoadPONumber _
                                                    , .BookLoadVendor = c.BookLoadVendor _
                                                    , .BookLoadCaseQty = If(c.BookLoadCaseQty.HasValue, c.BookLoadCaseQty, 0) _
                                                    , .BookLoadWgt = If(c.BookLoadWgt.HasValue, c.BookLoadWgt, 0) _
                                                    , .BookLoadCube = If(c.BookLoadCube.HasValue, c.BookLoadCube, 0) _
                                                    , .BookLoadPL = If(c.BookLoadPL.HasValue, c.BookLoadPL, 0) _
                                                    , .BookLoadPX = If(c.BookLoadPX.HasValue, c.BookLoadPX, 0) _
                                                    , .BookLoadPType = c.BookLoadPType _
                                                    , .BookLoadCom = c.BookLoadCom _
                                                    , .BookLoadPUOrigin = c.BookLoadPUOrigin _
                                                    , .BookLoadBFC = If(c.BookLoadBFC.HasValue, c.BookLoadBFC, 0) _
                                                    , .BookLoadTotCost = If(c.BookLoadTotCost.HasValue, c.BookLoadTotCost, 0) _
                                                    , .BookLoadComments = c.BookLoadComments _
                                                    , .BookLoadStopSeq = If(c.BookLoadStopSeq.HasValue, c.BookLoadStopSeq, 0) _
                                                    , .BookLoadModDate = c.BookLoadModDate _
                                                    , .BookLoadModUser = c.BookLoadModUser _
                                                    , .BookLoadUpdated = c.BookLoadUpdated.ToArray()}).ToList()}).ToArray()

                Return Books

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function


    Public Function GetBookAPCheckEntryRecords(ByVal CarrierControl As Integer) As DTO.Book()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                'Get the AP Check Entry Book Records
                Dim Books() As DTO.Book = ( _
                From d In db.Books _
                Where _
                    (d.BookPayCode = "P") _
                    And _
                    (d.BookCarrierControl = CarrierControl) _
                    And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.BookCustCompControl)) _
                Order By d.BookProNumber Ascending _
                Select New DTO.Book With {.BookControl = d.BookControl _
                                          , .BookProNumber = d.BookProNumber _
                                          , .BookProBase = d.BookProBase _
                                          , .BookConsPrefix = d.BookConsPrefix _
                                          , .BookCustCompControl = d.BookCustCompControl _
                                          , .BookCommCompControl = d.BookCommCompControl _
                                          , .BookODControl = d.BookODControl _
                                          , .BookCarrierControl = d.BookCarrierControl _
                                          , .BookCarrierContact = d.BookCarrierContact _
                                          , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                          , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                          , .BookOrigName = d.BookOrigName _
                                          , .BookOrigAddress1 = d.BookOrigAddress1 _
                                          , .BookOrigAddress2 = d.BookOrigAddress2 _
                                          , .BookOrigAddress3 = d.BookOrigAddress3 _
                                          , .BookOrigCity = d.BookOrigCity _
                                          , .BookOrigState = d.BookOrigState _
                                          , .BookOrigCountry = d.BookOrigCountry _
                                          , .BookOrigZip = d.BookOrigZip _
                                          , .BookOrigPhone = d.BookOrigPhone _
                                          , .BookOrigFax = d.BookOrigFax _
                                          , .BookOriginStartHrs = d.BookOriginStartHrs _
                                          , .BookOriginStopHrs = d.BookOriginStopHrs _
                                          , .BookOriginApptReq = If(d.BookOriginApptReq.HasValue, d.BookOriginApptReq, False) _
                                          , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                          , .BookDestName = d.BookDestName _
                                          , .BookDestAddress1 = d.BookDestAddress1 _
                                          , .BookDestAddress2 = d.BookDestAddress2 _
                                          , .BookDestAddress3 = d.BookDestAddress3 _
                                          , .BookDestCity = d.BookDestCity _
                                          , .BookDestState = d.BookDestState _
                                          , .BookDestCountry = d.BookDestCountry _
                                          , .BookDestZip = d.BookDestZip _
                                          , .BookDestPhone = d.BookDestPhone _
                                          , .BookDestFax = d.BookDestFax _
                                          , .BookDestStartHrs = d.BookDestStartHrs _
                                          , .BookDestStopHrs = d.BookDestStopHrs _
                                          , .BookDestApptReq = If(d.BookDestApptReq.HasValue, d.BookDestApptReq, False) _
                                          , .BookDateOrdered = d.BookDateOrdered _
                                          , .BookDateLoad = d.BookDateLoad _
                                          , .BookDateInvoice = d.BookDateInvoice _
                                          , .BookDateRequired = d.BookDateRequired _
                                          , .BookDateDelivered = d.BookDateDelivered _
                                          , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                          , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                          , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                          , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                          , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                          , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                          , .BookTranCode = d.BookTranCode _
                                          , .BookPayCode = d.BookPayCode _
                                          , .BookTypeCode = d.BookTypeCode _
                                          , .BookBOLCode = d.BookBOLCode _
                                          , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                          , .BookCarrFBNumber = d.BookCarrFBNumber _
                                          , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                          , .BookCarrBLNumber = d.BookCarrBLNumber _
                                          , .BookCarrBookDate = d.BookCarrBookDate _
                                          , .BookCarrBookTime = d.BookCarrBookTime _
                                          , .BookCarrBookContact = d.BookCarrBookContact _
                                          , .BookCarrScheduleDate = d.BookCarrScheduleDate _
                                          , .BookCarrScheduleTime = d.BookCarrScheduleTime _
                                          , .BookCarrActualDate = d.BookCarrActualDate _
                                          , .BookCarrActualTime = d.BookCarrActualTime _
                                          , .BookCarrActLoadComplete_Date = d.BookCarrActLoadComplete_Date _
                                          , .BookCarrActLoadCompleteTime = d.BookCarrActLoadCompleteTime _
                                          , .BookCarrDockPUAssigment = d.BookCarrDockPUAssigment _
                                          , .BookCarrPODate = d.BookCarrPODate _
                                          , .BookCarrPOTime = d.BookCarrPOTime _
                                          , .BookCarrApptDate = d.BookCarrApptDate _
                                          , .BookCarrApptTime = d.BookCarrApptTime _
                                          , .BookCarrActDate = d.BookCarrActDate _
                                          , .BookCarrActTime = d.BookCarrActTime _
                                          , .BookCarrActUnloadCompDate = d.BookCarrActUnloadCompDate _
                                          , .BookCarrActUnloadCompTime = d.BookCarrActUnloadCompTime _
                                          , .BookCarrDockDelAssignment = d.BookCarrDockDelAssignment _
                                          , .BookCarrVarDay = If(d.BookCarrVarDay.HasValue, d.BookCarrVarDay, 0) _
                                          , .BookCarrVarHrs = If(d.BookCarrVarHrs.HasValue, d.BookCarrVarHrs, 0) _
                                          , .BookCarrTrailerNo = d.BookCarrTrailerNo _
                                          , .BookCarrSealNo = d.BookCarrSealNo _
                                          , .BookCarrDriverNo = d.BookCarrDriverNo _
                                          , .BookCarrDriverName = d.BookCarrDriverName _
                                          , .BookCarrRouteNo = d.BookCarrRouteNo _
                                          , .BookCarrTripNo = d.BookCarrTripNo _
                                          , .BookFinARBookFrt = If(d.BookFinARBookFrt.HasValue, d.BookFinARBookFrt, 0) _
                                          , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                          , .BookFinARInvoiceAmt = If(d.BookFinARInvoiceAmt.HasValue, d.BookFinARInvoiceAmt, 0) _
                                          , .BookFinARPayDate = d.BookFinARPayDate _
                                          , .BookFinARPayAmt = If(d.BookFinARPayAmt.HasValue, d.BookFinARPayAmt, 0) _
                                          , .BookFinARCheck = d.BookFinARCheck _
                                          , .BookFinARGLNumber = d.BookFinARGLNumber _
                                          , .BookFinARBalance = If(d.BookFinARBalance.HasValue, d.BookFinARBalance, 0) _
                                          , .BookFinARCurType = If(d.BookFinARCurType.HasValue, d.BookFinARCurType, 0) _
                                          , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                          , .BookFinAPBillNoDate = d.BookFinAPBillNoDate _
                                          , .BookFinAPBillInvDate = d.BookFinAPBillInvDate _
                                          , .BookFinAPActWgt = If(d.BookFinAPActWgt.HasValue, d.BookFinAPActWgt, 0) _
                                          , .BookFinAPStdCost = If(d.BookFinAPStdCost.HasValue, d.BookFinAPStdCost, 0) _
                                          , .BookFinAPActCost = If(d.BookFinAPActCost.HasValue, d.BookFinAPActCost, 0) _
                                          , .BookFinAPPayDate = d.BookFinAPPayDate _
                                          , .BookFinAPPayAmt = If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0) _
                                          , .BookFinAPCheck = d.BookFinAPCheck _
                                          , .BookFinAPGLNumber = d.BookFinAPGLNumber _
                                          , .BookFinAPLastViewed = d.BookFinAPLastViewed _
                                          , .BookFinAPCurType = If(d.BookFinAPCurType.HasValue, d.BookFinAPCurType, 0) _
                                          , .BookFinCommStd = If(d.BookFinCommStd.HasValue, d.BookFinCommStd, 0) _
                                          , .BookFinCommAct = If(d.BookFinCommAct.HasValue, d.BookFinCommAct, 0) _
                                          , .BookFinCommPayDate = d.BookFinCommPayDate _
                                          , .BookFinCommPayAmt = If(d.BookFinCommPayAmt.HasValue, d.BookFinCommPayAmt, 0) _
                                          , .BookFinCommtCheck = d.BookFinCommtCheck _
                                          , .BookFinCommCreditAmt = If(d.BookFinCommCreditAmt.HasValue, d.BookFinCommCreditAmt, 0) _
                                          , .BookFinCommCreditPayDate = d.BookFinCommCreditPayDate _
                                          , .BookFinCommLoadCount = If(d.BookFinCommLoadCount.HasValue, d.BookFinCommLoadCount, 0) _
                                          , .BookFinCommGLNumber = d.BookFinCommGLNumber _
                                          , .BookFinCheckClearedDate = d.BookFinCheckClearedDate _
                                          , .BookFinCheckClearedNumber = d.BookFinCheckClearedNumber _
                                          , .BookFinCheckClearedAmt = If(d.BookFinCheckClearedAmt.HasValue, d.BookFinCheckClearedAmt, 0) _
                                          , .BookFinCheckClearedDesc = d.BookFinCheckClearedDesc _
                                          , .BookFinCheckClearedAcct = d.BookFinCheckClearedAcct _
                                          , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                          , .BookRevCarrierCost = If(d.BookRevCarrierCost.HasValue, d.BookRevCarrierCost, 0) _
                                          , .BookRevStopQty = If(d.BookRevStopQty.HasValue, d.BookRevStopQty, 0) _
                                          , .BookRevStopCost = If(d.BookRevStopCost.HasValue, d.BookRevStopCost, 0) _
                                          , .BookRevOtherCost = If(d.BookRevOtherCost.HasValue, d.BookRevOtherCost, 0) _
                                          , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                          , .BookRevLoadSavings = If(d.BookRevLoadSavings.HasValue, d.BookRevLoadSavings, 0) _
                                          , .BookRevCommPercent = If(d.BookRevCommPercent.HasValue, d.BookRevCommPercent, 0) _
                                          , .BookRevCommCost = If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0) _
                                          , .BookRevGrossRevenue = If(d.BookRevGrossRevenue.HasValue, d.BookRevGrossRevenue, 0) _
                                          , .BookRevNegRevenue = If(d.BookRevNegRevenue.HasValue, d.BookRevNegRevenue, 0) _
                                          , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                          , .BookLaneCarrControl = If(d.BookLaneCarrControl.HasValue, d.BookLaneCarrControl, 0) _
                                          , .BookHoldLoad = If(d.BookHoldLoad.HasValue, d.BookHoldLoad, 0) _
                                          , .BookRouteFinalDate = d.BookRouteFinalDate _
                                          , .BookRouteFinalCode = d.BookRouteFinalCode _
                                          , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                          , .BookWarehouseNumber = d.BookWarehouseNumber _
                                          , .BookComCode = d.BookComCode _
                                          , .BookTransType = d.BookTransType _
                                          , .BookRouteConsFlag = d.BookRouteConsFlag _
                                          , .BookWhseAuthorizationNo = d.BookWhseAuthorizationNo _
                                          , .BookHotLoad = If(d.BookHotLoad.HasValue, d.BookHotLoad, False) _
                                          , .BookFinAPActTax = If(d.BookFinAPActTax.HasValue, d.BookFinAPActTax, 0) _
                                          , .BookFinAPExportFlag = d.BookFinAPExportFlag _
                                          , .BookFinARFreightTax = d.BookFinARFreightTax _
                                          , .BookRevFreightTax = d.BookRevFreightTax _
                                          , .BookRevNetCost = d.BookRevNetCost _
                                          , .BookFinServiceFee = If(d.BookFinServiceFee.HasValue, d.BookFinServiceFee, 0) _
                                          , .BookFinAPExportDate = d.BookFinAPExportDate _
                                          , .BookFinAPExportRetry = If(d.BookFinAPExportRetry.HasValue, d.BookFinAPExportRetry, 0) _
                                          , .BookCarrierContControl = If(d.BookCarrierContControl.HasValue, d.BookCarrierContControl, 0) _
                                          , .BookHotLoadSent = If(d.BookHotLoadSent.HasValue, d.BookHotLoadSent, False) _
                                          , .BookExportDocCreated = If(d.BookExportDocCreated.HasValue, d.BookExportDocCreated, False) _
                                          , .BookDoNotInvoice = d.BookDoNotInvoice _
                                          , .BookCarrStartLoadingDate = d.BookCarrStartLoadingDate _
                                          , .BookCarrStartLoadingTime = d.BookCarrStartLoadingTime _
                                          , .BookCarrFinishLoadingDate = d.BookCarrFinishLoadingDate _
                                          , .BookCarrFinishLoadingTime = d.BookCarrFinishLoadingTime _
                                          , .BookCarrStartUnloadingDate = d.BookCarrStartUnloadingDate _
                                          , .BookCarrStartUnloadingTime = d.BookCarrStartUnloadingTime _
                                          , .BookCarrFinishUnloadingDate = d.BookCarrFinishUnloadingDate _
                                          , .BookCarrFinishUnloadingTime = d.BookCarrFinishUnloadingTime _
                                          , .BookOrderSequence = d.BookOrderSequence _
                                          , .BookChepGLID = d.BookChepGLID _
                                          , .BookCarrierTypeCode = d.BookCarrierTypeCode _
                                          , .BookPalletPositions = d.BookPalletPositions _
                                          , .BookShipCarrierProNumber = d.BookShipCarrierProNumber _
                                          , .BookShipCarrierName = d.BookShipCarrierName _
                                          , .BookShipCarrierNumber = d.BookShipCarrierNumber _
                                          , .BookAPAdjReasonControl = d.BookAPAdjReasonControl _
                                          , .BookDateRequested = d.BookDateRequested _
                                          , .BookCarrierEquipmentCodes = d.BookCarrierEquipmentCodes _
                                          , .BookLockAllCosts = d.BookLockAllCosts _
                                          , .BookLockBFCCost = d.BookLockBFCCost _
                                        , .BookDestStopNumber = d.BookDestStopNumber _
                                        , .BookOrigStopNumber = d.BookOrigStopNumber _
                                        , .BookDestStopControl = d.BookDestStopControl _
                                        , .BookOrigStopControl = d.BookOrigStopControl _
                                        , .BookRouteTypeCode = d.BookRouteTypeCode _
                                        , .BookAlternateAddressLaneControl = d.BookAlternateAddressLaneControl _
                                        , .BookAlternateAddressLaneNumber = d.BookAlternateAddressLaneNumber _
                                        , .BookDefaultRouteSequence = d.BookDefaultRouteSequence _
                                        , .BookRouteGuideControl = d.BookRouteGuideControl _
                                        , .BookRouteGuideNumber = d.BookRouteGuideNumber _
                                        , .BookCustomerApprovalRecieved = d.BookCustomerApprovalRecieved _
                                        , .BookCustomerApprovalTransmitted = d.BookCustomerApprovalTransmitted _
                                            , .BookAMSPickupApptControl = d.BookAMSPickupApptControl _
                                            , .BookAMSDeliveryApptControl = d.BookAMSDeliveryApptControl _
                                            , .BookItemDetailDescription = d.BookItemDetailDescription _
                                          , .BookModDate = d.BookModDate _
                                          , .BookModUser = d.BookModUser _
                                          , .BookUpdated = d.BookUpdated.ToArray _
                                          }).ToArray()

                Return Books

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBookAPDetailRecords(ByVal CarrierControl As Integer, ByVal BookPayCode As String) As DTO.BookAPDetail()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl

                'Get the AP Detail Book Records
                Dim BookAPdetails() As DTO.BookAPDetail = ( _
                From d In db.Books _
                Where _
                    (d.BookPayCode = BookPayCode) _
                    And _
                    (d.BookCarrierControl = CarrierControl) _
                    And _
                    (d.BookFinAPBillNumber.Length > 0) _
                    And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.BookCustCompControl)) _
                Order By d.BookDateLoad, d.BookConsPrefix, d.BookProNumber Ascending _
                Select New DTO.BookAPDetail With {.BookControl = d.BookControl _
                                          , .BookProNumber = d.BookProNumber _
                                          , .BookConsPrefix = d.BookConsPrefix _
                                          , .BookCarrierControl = d.BookCarrierControl _
                                          , .BookDateLoad = d.BookDateLoad _
                                          , .BookTranCode = d.BookTranCode _
                                          , .BookPayCode = d.BookPayCode _
                                          , .BookCarrBLNumber = d.BookCarrBLNumber _
                                          , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                          , .BookFinAPBillNoDate = d.BookFinAPBillNoDate _
                                          , .BookFinAPBillInvDate = d.BookFinAPBillInvDate _
                                          , .BookFinAPActWgt = If(d.BookFinAPActWgt.HasValue, d.BookFinAPActWgt, 0) _
                                          , .BookFinAPPayDate = d.BookFinAPPayDate _
                                          , .BookFinAPPayAmt = If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0) _
                                          , .BookFinAPCheck = d.BookFinAPCheck _
                                          , .BookFinAPGLNumber = d.BookFinAPGLNumber _
                                          , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                          , .BookModDate = d.BookModDate _
                                          , .BookModUser = d.BookModUser _
                                          , .BookUpdated = d.BookUpdated.ToArray _
                                          }).Take(2500).ToArray()

                Return BookAPdetails

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBookAPDetailRecord(ByVal Control As Integer) As DTO.BookAPDetail
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Get the AP Detail Book Record
                Dim BookAPdetail As DTO.BookAPDetail = ( _
                From d In db.Books _
                Where _
                    (d.BookControl = Control) _
                Select New DTO.BookAPDetail With {.BookControl = d.BookControl _
                                          , .BookProNumber = d.BookProNumber _
                                          , .BookConsPrefix = d.BookConsPrefix _
                                          , .BookCarrierControl = d.BookCarrierControl _
                                          , .BookDateLoad = d.BookDateLoad _
                                          , .BookTranCode = d.BookTranCode _
                                          , .BookPayCode = d.BookPayCode _
                                          , .BookCarrBLNumber = d.BookCarrBLNumber _
                                          , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                          , .BookFinAPBillNoDate = d.BookFinAPBillNoDate _
                                          , .BookFinAPBillInvDate = d.BookFinAPBillInvDate _
                                          , .BookFinAPActWgt = If(d.BookFinAPActWgt.HasValue, d.BookFinAPActWgt, 0) _
                                          , .BookFinAPPayDate = d.BookFinAPPayDate _
                                          , .BookFinAPPayAmt = If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0) _
                                          , .BookFinAPCheck = d.BookFinAPCheck _
                                          , .BookFinAPGLNumber = d.BookFinAPGLNumber _
                                          , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                          , .BookModDate = d.BookModDate _
                                          , .BookModUser = d.BookModUser _
                                          , .BookUpdated = d.BookUpdated.ToArray _
                                          }).First

                Return BookAPdetail

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBookCriticalLoads(ByVal CarrierControl As Integer) As DTO.Book()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'db.Log = New DebugTextWriter
                'Get the Critical Loads Book Records
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl

                Dim Books() As DTO.Book = ( _
                From d In db.Books _
                Where _
                    (d.BookCarrierControl = CarrierControl) _
                    And _
                    (d.BookDateDelivered.HasValue = False) _
                    And _
                    (d.BookTranCode <> "N") _
                    And _
                    (d.BookTranCode <> "P") _
                    And _
                    (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.BookCustCompControl)) _
                Order By d.BookCarrierControl, d.BookCustCompControl _
                Select New DTO.Book With {.BookControl = d.BookControl _
                                          , .BookProNumber = d.BookProNumber _
                                          , .BookProBase = d.BookProBase _
                                          , .BookConsPrefix = d.BookConsPrefix _
                                          , .BookCustCompControl = d.BookCustCompControl _
                                          , .BookCommCompControl = d.BookCommCompControl _
                                          , .BookODControl = d.BookODControl _
                                          , .BookCarrierControl = d.BookCarrierControl _
                                          , .BookCarrierContact = d.BookCarrierContact _
                                          , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                          , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                          , .BookOrigName = d.BookOrigName _
                                          , .BookOrigAddress1 = d.BookOrigAddress1 _
                                          , .BookOrigAddress2 = d.BookOrigAddress2 _
                                          , .BookOrigAddress3 = d.BookOrigAddress3 _
                                          , .BookOrigCity = d.BookOrigCity _
                                          , .BookOrigState = d.BookOrigState _
                                          , .BookOrigCountry = d.BookOrigCountry _
                                          , .BookOrigZip = d.BookOrigZip _
                                          , .BookOrigPhone = d.BookOrigPhone _
                                          , .BookOrigFax = d.BookOrigFax _
                                          , .BookOriginStartHrs = d.BookOriginStartHrs _
                                          , .BookOriginStopHrs = d.BookOriginStopHrs _
                                          , .BookOriginApptReq = If(d.BookOriginApptReq.HasValue, d.BookOriginApptReq, False) _
                                          , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                          , .BookDestName = d.BookDestName _
                                          , .BookDestAddress1 = d.BookDestAddress1 _
                                          , .BookDestAddress2 = d.BookDestAddress2 _
                                          , .BookDestAddress3 = d.BookDestAddress3 _
                                          , .BookDestCity = d.BookDestCity _
                                          , .BookDestState = d.BookDestState _
                                          , .BookDestCountry = d.BookDestCountry _
                                          , .BookDestZip = d.BookDestZip _
                                          , .BookDestPhone = d.BookDestPhone _
                                          , .BookDestFax = d.BookDestFax _
                                          , .BookDestStartHrs = d.BookDestStartHrs _
                                          , .BookDestStopHrs = d.BookDestStopHrs _
                                          , .BookDestApptReq = If(d.BookDestApptReq.HasValue, d.BookDestApptReq, False) _
                                          , .BookDateOrdered = d.BookDateOrdered _
                                          , .BookDateLoad = d.BookDateLoad _
                                          , .BookDateInvoice = d.BookDateInvoice _
                                          , .BookDateRequired = d.BookDateRequired _
                                          , .BookDateDelivered = d.BookDateDelivered _
                                          , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                          , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                          , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                          , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                          , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                          , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                          , .BookTranCode = d.BookTranCode _
                                          , .BookPayCode = d.BookPayCode _
                                          , .BookTypeCode = d.BookTypeCode _
                                          , .BookBOLCode = d.BookBOLCode _
                                          , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                          , .BookCarrFBNumber = d.BookCarrFBNumber _
                                          , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                          , .BookCarrBLNumber = d.BookCarrBLNumber _
                                          , .BookCarrBookDate = d.BookCarrBookDate _
                                          , .BookCarrBookTime = d.BookCarrBookTime _
                                          , .BookCarrBookContact = d.BookCarrBookContact _
                                          , .BookCarrScheduleDate = d.BookCarrScheduleDate _
                                          , .BookCarrScheduleTime = d.BookCarrScheduleTime _
                                          , .BookCarrActualDate = d.BookCarrActualDate _
                                          , .BookCarrActualTime = d.BookCarrActualTime _
                                          , .BookCarrActLoadComplete_Date = d.BookCarrActLoadComplete_Date _
                                          , .BookCarrActLoadCompleteTime = d.BookCarrActLoadCompleteTime _
                                          , .BookCarrDockPUAssigment = d.BookCarrDockPUAssigment _
                                          , .BookCarrPODate = d.BookCarrPODate _
                                          , .BookCarrPOTime = d.BookCarrPOTime _
                                          , .BookCarrApptDate = d.BookCarrApptDate _
                                          , .BookCarrApptTime = d.BookCarrApptTime _
                                          , .BookCarrActDate = d.BookCarrActDate _
                                          , .BookCarrActTime = d.BookCarrActTime _
                                          , .BookCarrActUnloadCompDate = d.BookCarrActUnloadCompDate _
                                          , .BookCarrActUnloadCompTime = d.BookCarrActUnloadCompTime _
                                          , .BookCarrDockDelAssignment = d.BookCarrDockDelAssignment _
                                          , .BookCarrVarDay = If(d.BookCarrVarDay.HasValue, d.BookCarrVarDay, 0) _
                                          , .BookCarrVarHrs = If(d.BookCarrVarHrs.HasValue, d.BookCarrVarHrs, 0) _
                                          , .BookCarrTrailerNo = d.BookCarrTrailerNo _
                                          , .BookCarrSealNo = d.BookCarrSealNo _
                                          , .BookCarrDriverNo = d.BookCarrDriverNo _
                                          , .BookCarrDriverName = d.BookCarrDriverName _
                                          , .BookCarrRouteNo = d.BookCarrRouteNo _
                                          , .BookCarrTripNo = d.BookCarrTripNo _
                                          , .BookFinARBookFrt = If(d.BookFinARBookFrt.HasValue, d.BookFinARBookFrt, 0) _
                                          , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                          , .BookFinARInvoiceAmt = If(d.BookFinARInvoiceAmt.HasValue, d.BookFinARInvoiceAmt, 0) _
                                          , .BookFinARPayDate = d.BookFinARPayDate _
                                          , .BookFinARPayAmt = If(d.BookFinARPayAmt.HasValue, d.BookFinARPayAmt, 0) _
                                          , .BookFinARCheck = d.BookFinARCheck _
                                          , .BookFinARGLNumber = d.BookFinARGLNumber _
                                          , .BookFinARBalance = If(d.BookFinARBalance.HasValue, d.BookFinARBalance, 0) _
                                          , .BookFinARCurType = If(d.BookFinARCurType.HasValue, d.BookFinARCurType, 0) _
                                          , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                          , .BookFinAPBillNoDate = d.BookFinAPBillNoDate _
                                          , .BookFinAPBillInvDate = d.BookFinAPBillInvDate _
                                          , .BookFinAPActWgt = If(d.BookFinAPActWgt.HasValue, d.BookFinAPActWgt, 0) _
                                          , .BookFinAPStdCost = If(d.BookFinAPStdCost.HasValue, d.BookFinAPStdCost, 0) _
                                          , .BookFinAPActCost = If(d.BookFinAPActCost.HasValue, d.BookFinAPActCost, 0) _
                                          , .BookFinAPPayDate = d.BookFinAPPayDate _
                                          , .BookFinAPPayAmt = If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0) _
                                          , .BookFinAPCheck = d.BookFinAPCheck _
                                          , .BookFinAPGLNumber = d.BookFinAPGLNumber _
                                          , .BookFinAPLastViewed = d.BookFinAPLastViewed _
                                          , .BookFinAPCurType = If(d.BookFinAPCurType.HasValue, d.BookFinAPCurType, 0) _
                                          , .BookFinCommStd = If(d.BookFinCommStd.HasValue, d.BookFinCommStd, 0) _
                                          , .BookFinCommAct = If(d.BookFinCommAct.HasValue, d.BookFinCommAct, 0) _
                                          , .BookFinCommPayDate = d.BookFinCommPayDate _
                                          , .BookFinCommPayAmt = If(d.BookFinCommPayAmt.HasValue, d.BookFinCommPayAmt, 0) _
                                          , .BookFinCommtCheck = d.BookFinCommtCheck _
                                          , .BookFinCommCreditAmt = If(d.BookFinCommCreditAmt.HasValue, d.BookFinCommCreditAmt, 0) _
                                          , .BookFinCommCreditPayDate = d.BookFinCommCreditPayDate _
                                          , .BookFinCommLoadCount = If(d.BookFinCommLoadCount.HasValue, d.BookFinCommLoadCount, 0) _
                                          , .BookFinCommGLNumber = d.BookFinCommGLNumber _
                                          , .BookFinCheckClearedDate = d.BookFinCheckClearedDate _
                                          , .BookFinCheckClearedNumber = d.BookFinCheckClearedNumber _
                                          , .BookFinCheckClearedAmt = If(d.BookFinCheckClearedAmt.HasValue, d.BookFinCheckClearedAmt, 0) _
                                          , .BookFinCheckClearedDesc = d.BookFinCheckClearedDesc _
                                          , .BookFinCheckClearedAcct = d.BookFinCheckClearedAcct _
                                          , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                          , .BookRevCarrierCost = If(d.BookRevCarrierCost.HasValue, d.BookRevCarrierCost, 0) _
                                          , .BookRevStopQty = If(d.BookRevStopQty.HasValue, d.BookRevStopQty, 0) _
                                          , .BookRevStopCost = If(d.BookRevStopCost.HasValue, d.BookRevStopCost, 0) _
                                          , .BookRevOtherCost = If(d.BookRevOtherCost.HasValue, d.BookRevOtherCost, 0) _
                                          , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                          , .BookRevLoadSavings = If(d.BookRevLoadSavings.HasValue, d.BookRevLoadSavings, 0) _
                                          , .BookRevCommPercent = If(d.BookRevCommPercent.HasValue, d.BookRevCommPercent, 0) _
                                          , .BookRevCommCost = If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0) _
                                          , .BookRevGrossRevenue = If(d.BookRevGrossRevenue.HasValue, d.BookRevGrossRevenue, 0) _
                                          , .BookRevNegRevenue = If(d.BookRevNegRevenue.HasValue, d.BookRevNegRevenue, 0) _
                                          , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                          , .BookLaneCarrControl = If(d.BookLaneCarrControl.HasValue, d.BookLaneCarrControl, 0) _
                                          , .BookHoldLoad = If(d.BookHoldLoad.HasValue, d.BookHoldLoad, 0) _
                                          , .BookRouteFinalDate = d.BookRouteFinalDate _
                                          , .BookRouteFinalCode = d.BookRouteFinalCode _
                                          , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                          , .BookWarehouseNumber = d.BookWarehouseNumber _
                                          , .BookComCode = d.BookComCode _
                                          , .BookTransType = d.BookTransType _
                                          , .BookRouteConsFlag = d.BookRouteConsFlag _
                                          , .BookWhseAuthorizationNo = d.BookWhseAuthorizationNo _
                                          , .BookHotLoad = If(d.BookHotLoad.HasValue, d.BookHotLoad, False) _
                                          , .BookFinAPActTax = If(d.BookFinAPActTax.HasValue, d.BookFinAPActTax, 0) _
                                          , .BookFinAPExportFlag = d.BookFinAPExportFlag _
                                          , .BookFinARFreightTax = d.BookFinARFreightTax _
                                          , .BookRevFreightTax = d.BookRevFreightTax _
                                          , .BookRevNetCost = d.BookRevNetCost _
                                          , .BookFinServiceFee = If(d.BookFinServiceFee.HasValue, d.BookFinServiceFee, 0) _
                                          , .BookFinAPExportDate = d.BookFinAPExportDate _
                                          , .BookFinAPExportRetry = If(d.BookFinAPExportRetry.HasValue, d.BookFinAPExportRetry, 0) _
                                          , .BookCarrierContControl = If(d.BookCarrierContControl.HasValue, d.BookCarrierContControl, 0) _
                                          , .BookHotLoadSent = If(d.BookHotLoadSent.HasValue, d.BookHotLoadSent, False) _
                                          , .BookExportDocCreated = If(d.BookExportDocCreated.HasValue, d.BookExportDocCreated, False) _
                                          , .BookDoNotInvoice = d.BookDoNotInvoice _
                                          , .BookCarrStartLoadingDate = d.BookCarrStartLoadingDate _
                                          , .BookCarrStartLoadingTime = d.BookCarrStartLoadingTime _
                                          , .BookCarrFinishLoadingDate = d.BookCarrFinishLoadingDate _
                                          , .BookCarrFinishLoadingTime = d.BookCarrFinishLoadingTime _
                                          , .BookCarrStartUnloadingDate = d.BookCarrStartUnloadingDate _
                                          , .BookCarrStartUnloadingTime = d.BookCarrStartUnloadingTime _
                                          , .BookCarrFinishUnloadingDate = d.BookCarrFinishUnloadingDate _
                                          , .BookCarrFinishUnloadingTime = d.BookCarrFinishUnloadingTime _
                                          , .BookOrderSequence = d.BookOrderSequence _
                                          , .BookChepGLID = d.BookChepGLID _
                                          , .BookCarrierTypeCode = d.BookCarrierTypeCode _
                                          , .BookPalletPositions = d.BookPalletPositions _
                                          , .BookShipCarrierProNumber = d.BookShipCarrierProNumber _
                                          , .BookShipCarrierName = d.BookShipCarrierName _
                                          , .BookShipCarrierNumber = d.BookShipCarrierNumber _
                                          , .BookAPAdjReasonControl = d.BookAPAdjReasonControl _
                                          , .BookDateRequested = d.BookDateRequested _
                                          , .BookCarrierEquipmentCodes = d.BookCarrierEquipmentCodes _
                                          , .BookLockAllCosts = d.BookLockAllCosts _
                                          , .BookLockBFCCost = d.BookLockBFCCost _
                                            , .BookDestStopNumber = d.BookDestStopNumber _
                                            , .BookOrigStopNumber = d.BookOrigStopNumber _
                                            , .BookDestStopControl = d.BookDestStopControl _
                                            , .BookOrigStopControl = d.BookOrigStopControl _
                                            , .BookRouteTypeCode = d.BookRouteTypeCode _
                                            , .BookAlternateAddressLaneControl = d.BookAlternateAddressLaneControl _
                                            , .BookAlternateAddressLaneNumber = d.BookAlternateAddressLaneNumber _
                                            , .BookDefaultRouteSequence = d.BookDefaultRouteSequence _
                                            , .BookRouteGuideControl = d.BookRouteGuideControl _
                                            , .BookRouteGuideNumber = d.BookRouteGuideNumber _
                                            , .BookCustomerApprovalRecieved = d.BookCustomerApprovalRecieved _
                                            , .BookCustomerApprovalTransmitted = d.BookCustomerApprovalTransmitted _
                                            , .BookAMSPickupApptControl = d.BookAMSPickupApptControl _
                                            , .BookAMSDeliveryApptControl = d.BookAMSDeliveryApptControl _
                                            , .BookItemDetailDescription = d.BookItemDetailDescription _
                                          , .BookModDate = d.BookModDate _
                                          , .BookModUser = d.BookModUser _
                                          , .BookUpdated = d.BookUpdated.ToArray _
                                          , .BookTracks = ( _
                                                From c In d.BookTracks _
                                                Select New DTO.BookTrack With {.BookTrackControl = c.BookTrackControl _
                                                , .BookTrackBookControl = c.BookTrackBookControl _
                                                , .BookTrackDate = c.BookTrackDate _
                                                , .BookTrackContact = c.BookTrackContact _
                                                , .BookTrackComment = c.BookTrackComment _
                                                , .BookTrackStatus = If(c.BookTrackStatus.HasValue, c.BookTrackStatus, 0) _
                                                , .BookTrackModDate = c.BookTrackModDate _
                                                , .BookTrackModUser = c.BookTrackModUser _
                                                , .BookTrackUpdated = c.BookTrackUpdated.ToArray()}).ToList() _
                                          }).Take(200).ToArray()

                Return Books

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBookAPCommissionRecords(ByVal BookCommCompControl As Integer) As DTO.Book()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'db.Log = New DebugTextWriter
                'Get the AP Commission Book Records
                Dim Books() As DTO.Book = ( _
                From d In db.Books _
                Where _
                    (d.BookCommCompControl = BookCommCompControl) _
                    And _
                    (d.BookRevCommCost.HasValue AndAlso d.BookRevCommCost <> 0) _
                    And _
                    (d.BookFinCommPayAmt.HasValue = False OrElse d.BookFinCommPayAmt = 0) _
                    And _
                    (d.BookFinARPayAmt >= d.BookFinARInvoiceAmt) _
                Order By d.BookFinARInvoiceDate, d.BookProNumber Ascending _
                Select New DTO.Book With {.BookControl = d.BookControl _
                                          , .BookProNumber = d.BookProNumber _
                                          , .BookProBase = d.BookProBase _
                                          , .BookConsPrefix = d.BookConsPrefix _
                                          , .BookCustCompControl = d.BookCustCompControl _
                                          , .BookCommCompControl = d.BookCommCompControl _
                                          , .BookODControl = d.BookODControl _
                                          , .BookCarrierControl = d.BookCarrierControl _
                                          , .BookCarrierContact = d.BookCarrierContact _
                                          , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                          , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                          , .BookOrigName = d.BookOrigName _
                                          , .BookOrigAddress1 = d.BookOrigAddress1 _
                                          , .BookOrigAddress2 = d.BookOrigAddress2 _
                                          , .BookOrigAddress3 = d.BookOrigAddress3 _
                                          , .BookOrigCity = d.BookOrigCity _
                                          , .BookOrigState = d.BookOrigState _
                                          , .BookOrigCountry = d.BookOrigCountry _
                                          , .BookOrigZip = d.BookOrigZip _
                                          , .BookOrigPhone = d.BookOrigPhone _
                                          , .BookOrigFax = d.BookOrigFax _
                                          , .BookOriginStartHrs = d.BookOriginStartHrs _
                                          , .BookOriginStopHrs = d.BookOriginStopHrs _
                                          , .BookOriginApptReq = If(d.BookOriginApptReq.HasValue, d.BookOriginApptReq, False) _
                                          , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                          , .BookDestName = d.BookDestName _
                                          , .BookDestAddress1 = d.BookDestAddress1 _
                                          , .BookDestAddress2 = d.BookDestAddress2 _
                                          , .BookDestAddress3 = d.BookDestAddress3 _
                                          , .BookDestCity = d.BookDestCity _
                                          , .BookDestState = d.BookDestState _
                                          , .BookDestCountry = d.BookDestCountry _
                                          , .BookDestZip = d.BookDestZip _
                                          , .BookDestPhone = d.BookDestPhone _
                                          , .BookDestFax = d.BookDestFax _
                                          , .BookDestStartHrs = d.BookDestStartHrs _
                                          , .BookDestStopHrs = d.BookDestStopHrs _
                                          , .BookDestApptReq = If(d.BookDestApptReq.HasValue, d.BookDestApptReq, False) _
                                          , .BookDateOrdered = d.BookDateOrdered _
                                          , .BookDateLoad = d.BookDateLoad _
                                          , .BookDateInvoice = d.BookDateInvoice _
                                          , .BookDateRequired = d.BookDateRequired _
                                          , .BookDateDelivered = d.BookDateDelivered _
                                          , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                          , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                          , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                          , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                          , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                          , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                          , .BookTranCode = d.BookTranCode _
                                          , .BookPayCode = d.BookPayCode _
                                          , .BookTypeCode = d.BookTypeCode _
                                          , .BookBOLCode = d.BookBOLCode _
                                          , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                          , .BookCarrFBNumber = d.BookCarrFBNumber _
                                          , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                          , .BookCarrBLNumber = d.BookCarrBLNumber _
                                          , .BookCarrBookDate = d.BookCarrBookDate _
                                          , .BookCarrBookTime = d.BookCarrBookTime _
                                          , .BookCarrBookContact = d.BookCarrBookContact _
                                          , .BookCarrScheduleDate = d.BookCarrScheduleDate _
                                          , .BookCarrScheduleTime = d.BookCarrScheduleTime _
                                          , .BookCarrActualDate = d.BookCarrActualDate _
                                          , .BookCarrActualTime = d.BookCarrActualTime _
                                          , .BookCarrActLoadComplete_Date = d.BookCarrActLoadComplete_Date _
                                          , .BookCarrActLoadCompleteTime = d.BookCarrActLoadCompleteTime _
                                          , .BookCarrDockPUAssigment = d.BookCarrDockPUAssigment _
                                          , .BookCarrPODate = d.BookCarrPODate _
                                          , .BookCarrPOTime = d.BookCarrPOTime _
                                          , .BookCarrApptDate = d.BookCarrApptDate _
                                          , .BookCarrApptTime = d.BookCarrApptTime _
                                          , .BookCarrActDate = d.BookCarrActDate _
                                          , .BookCarrActTime = d.BookCarrActTime _
                                          , .BookCarrActUnloadCompDate = d.BookCarrActUnloadCompDate _
                                          , .BookCarrActUnloadCompTime = d.BookCarrActUnloadCompTime _
                                          , .BookCarrDockDelAssignment = d.BookCarrDockDelAssignment _
                                          , .BookCarrVarDay = If(d.BookCarrVarDay.HasValue, d.BookCarrVarDay, 0) _
                                          , .BookCarrVarHrs = If(d.BookCarrVarHrs.HasValue, d.BookCarrVarHrs, 0) _
                                          , .BookCarrTrailerNo = d.BookCarrTrailerNo _
                                          , .BookCarrSealNo = d.BookCarrSealNo _
                                          , .BookCarrDriverNo = d.BookCarrDriverNo _
                                          , .BookCarrDriverName = d.BookCarrDriverName _
                                          , .BookCarrRouteNo = d.BookCarrRouteNo _
                                          , .BookCarrTripNo = d.BookCarrTripNo _
                                          , .BookFinARBookFrt = If(d.BookFinARBookFrt.HasValue, d.BookFinARBookFrt, 0) _
                                          , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                          , .BookFinARInvoiceAmt = If(d.BookFinARInvoiceAmt.HasValue, d.BookFinARInvoiceAmt, 0) _
                                          , .BookFinARPayDate = d.BookFinARPayDate _
                                          , .BookFinARPayAmt = If(d.BookFinARPayAmt.HasValue, d.BookFinARPayAmt, 0) _
                                          , .BookFinARCheck = d.BookFinARCheck _
                                          , .BookFinARGLNumber = d.BookFinARGLNumber _
                                          , .BookFinARBalance = If(d.BookFinARBalance.HasValue, d.BookFinARBalance, 0) _
                                          , .BookFinARCurType = If(d.BookFinARCurType.HasValue, d.BookFinARCurType, 0) _
                                          , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                          , .BookFinAPBillNoDate = d.BookFinAPBillNoDate _
                                          , .BookFinAPBillInvDate = d.BookFinAPBillInvDate _
                                          , .BookFinAPActWgt = If(d.BookFinAPActWgt.HasValue, d.BookFinAPActWgt, 0) _
                                          , .BookFinAPStdCost = If(d.BookFinAPStdCost.HasValue, d.BookFinAPStdCost, 0) _
                                          , .BookFinAPActCost = If(d.BookFinAPActCost.HasValue, d.BookFinAPActCost, 0) _
                                          , .BookFinAPPayDate = d.BookFinAPPayDate _
                                          , .BookFinAPPayAmt = If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0) _
                                          , .BookFinAPCheck = d.BookFinAPCheck _
                                          , .BookFinAPGLNumber = d.BookFinAPGLNumber _
                                          , .BookFinAPLastViewed = d.BookFinAPLastViewed _
                                          , .BookFinAPCurType = If(d.BookFinAPCurType.HasValue, d.BookFinAPCurType, 0) _
                                          , .BookFinCommStd = If(d.BookFinCommStd.HasValue, d.BookFinCommStd, 0) _
                                          , .BookFinCommAct = If(d.BookFinCommAct.HasValue, d.BookFinCommAct, 0) _
                                          , .BookFinCommPayDate = d.BookFinCommPayDate _
                                          , .BookFinCommPayAmt = If(d.BookFinCommPayAmt.HasValue, d.BookFinCommPayAmt, 0) _
                                          , .BookFinCommtCheck = d.BookFinCommtCheck _
                                          , .BookFinCommCreditAmt = If(d.BookFinCommCreditAmt.HasValue, d.BookFinCommCreditAmt, 0) _
                                          , .BookFinCommCreditPayDate = d.BookFinCommCreditPayDate _
                                          , .BookFinCommLoadCount = If(d.BookFinCommLoadCount.HasValue, d.BookFinCommLoadCount, 0) _
                                          , .BookFinCommGLNumber = d.BookFinCommGLNumber _
                                          , .BookFinCheckClearedDate = d.BookFinCheckClearedDate _
                                          , .BookFinCheckClearedNumber = d.BookFinCheckClearedNumber _
                                          , .BookFinCheckClearedAmt = If(d.BookFinCheckClearedAmt.HasValue, d.BookFinCheckClearedAmt, 0) _
                                          , .BookFinCheckClearedDesc = d.BookFinCheckClearedDesc _
                                          , .BookFinCheckClearedAcct = d.BookFinCheckClearedAcct _
                                          , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                          , .BookRevCarrierCost = If(d.BookRevCarrierCost.HasValue, d.BookRevCarrierCost, 0) _
                                          , .BookRevStopQty = If(d.BookRevStopQty.HasValue, d.BookRevStopQty, 0) _
                                          , .BookRevStopCost = If(d.BookRevStopCost.HasValue, d.BookRevStopCost, 0) _
                                          , .BookRevOtherCost = If(d.BookRevOtherCost.HasValue, d.BookRevOtherCost, 0) _
                                          , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                          , .BookRevLoadSavings = If(d.BookRevLoadSavings.HasValue, d.BookRevLoadSavings, 0) _
                                          , .BookRevCommPercent = If(d.BookRevCommPercent.HasValue, d.BookRevCommPercent, 0) _
                                          , .BookRevCommCost = If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0) _
                                          , .BookRevGrossRevenue = If(d.BookRevGrossRevenue.HasValue, d.BookRevGrossRevenue, 0) _
                                          , .BookRevNegRevenue = If(d.BookRevNegRevenue.HasValue, d.BookRevNegRevenue, 0) _
                                          , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                          , .BookLaneCarrControl = If(d.BookLaneCarrControl.HasValue, d.BookLaneCarrControl, 0) _
                                          , .BookHoldLoad = If(d.BookHoldLoad.HasValue, d.BookHoldLoad, 0) _
                                          , .BookRouteFinalDate = d.BookRouteFinalDate _
                                          , .BookRouteFinalCode = d.BookRouteFinalCode _
                                          , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                          , .BookWarehouseNumber = d.BookWarehouseNumber _
                                          , .BookComCode = d.BookComCode _
                                          , .BookTransType = d.BookTransType _
                                          , .BookRouteConsFlag = d.BookRouteConsFlag _
                                          , .BookWhseAuthorizationNo = d.BookWhseAuthorizationNo _
                                          , .BookHotLoad = If(d.BookHotLoad.HasValue, d.BookHotLoad, False) _
                                          , .BookFinAPActTax = If(d.BookFinAPActTax.HasValue, d.BookFinAPActTax, 0) _
                                          , .BookFinAPExportFlag = d.BookFinAPExportFlag _
                                          , .BookFinARFreightTax = d.BookFinARFreightTax _
                                          , .BookRevFreightTax = d.BookRevFreightTax _
                                          , .BookRevNetCost = d.BookRevNetCost _
                                          , .BookFinServiceFee = If(d.BookFinServiceFee.HasValue, d.BookFinServiceFee, 0) _
                                          , .BookFinAPExportDate = d.BookFinAPExportDate _
                                          , .BookFinAPExportRetry = If(d.BookFinAPExportRetry.HasValue, d.BookFinAPExportRetry, 0) _
                                          , .BookCarrierContControl = If(d.BookCarrierContControl.HasValue, d.BookCarrierContControl, 0) _
                                          , .BookHotLoadSent = If(d.BookHotLoadSent.HasValue, d.BookHotLoadSent, False) _
                                          , .BookExportDocCreated = If(d.BookExportDocCreated.HasValue, d.BookExportDocCreated, False) _
                                          , .BookDoNotInvoice = d.BookDoNotInvoice _
                                          , .BookCarrStartLoadingDate = d.BookCarrStartLoadingDate _
                                          , .BookCarrStartLoadingTime = d.BookCarrStartLoadingTime _
                                          , .BookCarrFinishLoadingDate = d.BookCarrFinishLoadingDate _
                                          , .BookCarrFinishLoadingTime = d.BookCarrFinishLoadingTime _
                                          , .BookCarrStartUnloadingDate = d.BookCarrStartUnloadingDate _
                                          , .BookCarrStartUnloadingTime = d.BookCarrStartUnloadingTime _
                                          , .BookCarrFinishUnloadingDate = d.BookCarrFinishUnloadingDate _
                                          , .BookCarrFinishUnloadingTime = d.BookCarrFinishUnloadingTime _
                                          , .BookOrderSequence = d.BookOrderSequence _
                                          , .BookChepGLID = d.BookChepGLID _
                                          , .BookCarrierTypeCode = d.BookCarrierTypeCode _
                                          , .BookPalletPositions = d.BookPalletPositions _
                                          , .BookShipCarrierProNumber = d.BookShipCarrierProNumber _
                                          , .BookShipCarrierName = d.BookShipCarrierName _
                                          , .BookShipCarrierNumber = d.BookShipCarrierNumber _
                                          , .BookAPAdjReasonControl = d.BookAPAdjReasonControl _
                                          , .BookDateRequested = d.BookDateRequested _
                                          , .BookCarrierEquipmentCodes = d.BookCarrierEquipmentCodes _
                                          , .BookLockAllCosts = d.BookLockAllCosts _
                                          , .BookLockBFCCost = d.BookLockBFCCost _
                                            , .BookDestStopNumber = d.BookDestStopNumber _
                                            , .BookOrigStopNumber = d.BookOrigStopNumber _
                                            , .BookDestStopControl = d.BookDestStopControl _
                                            , .BookOrigStopControl = d.BookOrigStopControl _
                                            , .BookRouteTypeCode = d.BookRouteTypeCode _
                                            , .BookAlternateAddressLaneControl = d.BookAlternateAddressLaneControl _
                                            , .BookAlternateAddressLaneNumber = d.BookAlternateAddressLaneNumber _
                                            , .BookDefaultRouteSequence = d.BookDefaultRouteSequence _
                                            , .BookRouteGuideControl = d.BookRouteGuideControl _
                                            , .BookRouteGuideNumber = d.BookRouteGuideNumber _
                                            , .BookCustomerApprovalRecieved = d.BookCustomerApprovalRecieved _
                                            , .BookCustomerApprovalTransmitted = d.BookCustomerApprovalTransmitted _
                                            , .BookAMSPickupApptControl = d.BookAMSPickupApptControl _
                                            , .BookAMSDeliveryApptControl = d.BookAMSDeliveryApptControl _
                                            , .BookItemDetailDescription = d.BookItemDetailDescription _
                                          , .BookModDate = d.BookModDate _
                                          , .BookModUser = d.BookModUser _
                                          , .BookUpdated = d.BookUpdated.ToArray _
                                          }).ToArray()

                Return Books

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    'Public Function GetBookAPCommData(ByVal BookCommCompControl As Integer) As DTO.APCommData()
    '    Using db As New NGLMasBookDataContext(ConnectionString)
    '        Try
    '            'db.Log = New DebugTextWriter
    '            'Get the AP Commission Book Records
    '            Dim Results() As DTO.APCommData = ( _
    '            From d In db.Books _
    '            Where _
    '                (d.BookCommCompControl = BookCommCompControl) _
    '                And _
    '                (d.BookRevCommCost.HasValue AndAlso d.BookRevCommCost <> 0) _
    '                And _
    '                (d.BookFinCommPayAmt.HasValue = False OrElse d.BookFinCommPayAmt = 0) _
    '                And _
    '                (d.BookFinARPayAmt >= d.BookFinARInvoiceAmt) _
    '            Order By d.BookFinARInvoiceDate, d.BookProNumber Ascending _
    '            Select New DTO.APCommData With {.BookControl = d.BookControl _
    '                                      , .BookProNumber = d.BookProNumber _
    '                                      , .BookConsPrefix = d.BookConsPrefix _
    '                                      , .BookCommCompControl = d.BookCommCompControl _
    '                                      , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
    '                                      , .BookFinARPayAmt = If(d.BookFinARPayAmt.HasValue, d.BookFinARPayAmt, 0) _
    '                                      , .BookFinCommStd = If(d.BookFinCommStd.HasValue, d.BookFinCommStd, 0) _
    '                                      , .BookFinCommAct = If(d.BookFinCommAct.HasValue, d.BookFinCommAct, 0) _
    '                                      , .BookFinCommPayDate = d.BookFinCommPayDate _
    '                                      , .BookFinCommPayAmt = If(d.BookFinCommPayAmt.HasValue, d.BookFinCommPayAmt, 0) _
    '                                      , .BookFinCommtCheck = d.BookFinCommtCheck _
    '                                      , .BookFinCommCreditAmt = If(d.BookFinCommCreditAmt.HasValue, d.BookFinCommCreditAmt, 0) _
    '                                      , .BookFinCommCreditPayDate = d.BookFinCommCreditPayDate _
    '                                      , .BookFinCommLoadCount = If(d.BookFinCommLoadCount.HasValue, d.BookFinCommLoadCount, 0) _
    '                                      , .BookFinCommGLNumber = d.BookFinCommGLNumber _
    '                                      , .BookRevCommCost = If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0) _
    '                                      , .BookModDate = d.BookModDate _
    '                                      , .BookModUser = d.BookModUser _
    '                                      , .BookUpdated = d.BookUpdated.ToArray _
    '                                      }).ToArray()

    '            Return Results

    '        Catch ex As System.Data.SqlClient.SqlException
    '            Utilities.SaveAppError(ex.Message, Me.Parameters)
    '            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
    '        Catch ex As InvalidOperationException
    '            Utilities.SaveAppError(ex.Message, Me.Parameters)
    '            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
    '        Catch ex As Exception
    '            Utilities.SaveAppError(ex.Message, Me.Parameters)
    '            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
    '        End Try

    '        Return Nothing

    '    End Using
    'End Function

    Public Function GetBookAPPaidRecords(ByVal BookCarrierControl As Integer) As DTO.Book()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                'Get the AP Check Entry Book Records
                Dim Books() As DTO.Book = ( _
                From d In db.Books _
                Where _
                    (d.BookCarrierControl = BookCarrierControl) _
                    And _
                    (d.BookFinAPPayAmt.HasValue AndAlso d.BookFinAPPayAmt.Value <> 0) _
                    And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.BookCustCompControl)) _
                Order By d.BookPayCode, d.BookFinAPPayDate Descending _
                Select New DTO.Book With {.BookControl = d.BookControl _
                                          , .BookProNumber = d.BookProNumber _
                                          , .BookProBase = d.BookProBase _
                                          , .BookConsPrefix = d.BookConsPrefix _
                                          , .BookCustCompControl = d.BookCustCompControl _
                                          , .BookCommCompControl = d.BookCommCompControl _
                                          , .BookODControl = d.BookODControl _
                                          , .BookCarrierControl = d.BookCarrierControl _
                                          , .BookCarrierContact = d.BookCarrierContact _
                                          , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                          , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                          , .BookOrigName = d.BookOrigName _
                                          , .BookOrigAddress1 = d.BookOrigAddress1 _
                                          , .BookOrigAddress2 = d.BookOrigAddress2 _
                                          , .BookOrigAddress3 = d.BookOrigAddress3 _
                                          , .BookOrigCity = d.BookOrigCity _
                                          , .BookOrigState = d.BookOrigState _
                                          , .BookOrigCountry = d.BookOrigCountry _
                                          , .BookOrigZip = d.BookOrigZip _
                                          , .BookOrigPhone = d.BookOrigPhone _
                                          , .BookOrigFax = d.BookOrigFax _
                                          , .BookOriginStartHrs = d.BookOriginStartHrs _
                                          , .BookOriginStopHrs = d.BookOriginStopHrs _
                                          , .BookOriginApptReq = If(d.BookOriginApptReq.HasValue, d.BookOriginApptReq, False) _
                                          , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                          , .BookDestName = d.BookDestName _
                                          , .BookDestAddress1 = d.BookDestAddress1 _
                                          , .BookDestAddress2 = d.BookDestAddress2 _
                                          , .BookDestAddress3 = d.BookDestAddress3 _
                                          , .BookDestCity = d.BookDestCity _
                                          , .BookDestState = d.BookDestState _
                                          , .BookDestCountry = d.BookDestCountry _
                                          , .BookDestZip = d.BookDestZip _
                                          , .BookDestPhone = d.BookDestPhone _
                                          , .BookDestFax = d.BookDestFax _
                                          , .BookDestStartHrs = d.BookDestStartHrs _
                                          , .BookDestStopHrs = d.BookDestStopHrs _
                                          , .BookDestApptReq = If(d.BookDestApptReq.HasValue, d.BookDestApptReq, False) _
                                          , .BookDateOrdered = d.BookDateOrdered _
                                          , .BookDateLoad = d.BookDateLoad _
                                          , .BookDateInvoice = d.BookDateInvoice _
                                          , .BookDateRequired = d.BookDateRequired _
                                          , .BookDateDelivered = d.BookDateDelivered _
                                          , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                          , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                          , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                          , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                          , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                          , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                          , .BookTranCode = d.BookTranCode _
                                          , .BookPayCode = d.BookPayCode _
                                          , .BookTypeCode = d.BookTypeCode _
                                          , .BookBOLCode = d.BookBOLCode _
                                          , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                          , .BookCarrFBNumber = d.BookCarrFBNumber _
                                          , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                          , .BookCarrBLNumber = d.BookCarrBLNumber _
                                          , .BookCarrBookDate = d.BookCarrBookDate _
                                          , .BookCarrBookTime = d.BookCarrBookTime _
                                          , .BookCarrBookContact = d.BookCarrBookContact _
                                          , .BookCarrScheduleDate = d.BookCarrScheduleDate _
                                          , .BookCarrScheduleTime = d.BookCarrScheduleTime _
                                          , .BookCarrActualDate = d.BookCarrActualDate _
                                          , .BookCarrActualTime = d.BookCarrActualTime _
                                          , .BookCarrActLoadComplete_Date = d.BookCarrActLoadComplete_Date _
                                          , .BookCarrActLoadCompleteTime = d.BookCarrActLoadCompleteTime _
                                          , .BookCarrDockPUAssigment = d.BookCarrDockPUAssigment _
                                          , .BookCarrPODate = d.BookCarrPODate _
                                          , .BookCarrPOTime = d.BookCarrPOTime _
                                          , .BookCarrApptDate = d.BookCarrApptDate _
                                          , .BookCarrApptTime = d.BookCarrApptTime _
                                          , .BookCarrActDate = d.BookCarrActDate _
                                          , .BookCarrActTime = d.BookCarrActTime _
                                          , .BookCarrActUnloadCompDate = d.BookCarrActUnloadCompDate _
                                          , .BookCarrActUnloadCompTime = d.BookCarrActUnloadCompTime _
                                          , .BookCarrDockDelAssignment = d.BookCarrDockDelAssignment _
                                          , .BookCarrVarDay = If(d.BookCarrVarDay.HasValue, d.BookCarrVarDay, 0) _
                                          , .BookCarrVarHrs = If(d.BookCarrVarHrs.HasValue, d.BookCarrVarHrs, 0) _
                                          , .BookCarrTrailerNo = d.BookCarrTrailerNo _
                                          , .BookCarrSealNo = d.BookCarrSealNo _
                                          , .BookCarrDriverNo = d.BookCarrDriverNo _
                                          , .BookCarrDriverName = d.BookCarrDriverName _
                                          , .BookCarrRouteNo = d.BookCarrRouteNo _
                                          , .BookCarrTripNo = d.BookCarrTripNo _
                                          , .BookFinARBookFrt = If(d.BookFinARBookFrt.HasValue, d.BookFinARBookFrt, 0) _
                                          , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                          , .BookFinARInvoiceAmt = If(d.BookFinARInvoiceAmt.HasValue, d.BookFinARInvoiceAmt, 0) _
                                          , .BookFinARPayDate = d.BookFinARPayDate _
                                          , .BookFinARPayAmt = If(d.BookFinARPayAmt.HasValue, d.BookFinARPayAmt, 0) _
                                          , .BookFinARCheck = d.BookFinARCheck _
                                          , .BookFinARGLNumber = d.BookFinARGLNumber _
                                          , .BookFinARBalance = If(d.BookFinARBalance.HasValue, d.BookFinARBalance, 0) _
                                          , .BookFinARCurType = If(d.BookFinARCurType.HasValue, d.BookFinARCurType, 0) _
                                          , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                          , .BookFinAPBillNoDate = d.BookFinAPBillNoDate _
                                          , .BookFinAPBillInvDate = d.BookFinAPBillInvDate _
                                          , .BookFinAPActWgt = If(d.BookFinAPActWgt.HasValue, d.BookFinAPActWgt, 0) _
                                          , .BookFinAPStdCost = If(d.BookFinAPStdCost.HasValue, d.BookFinAPStdCost, 0) _
                                          , .BookFinAPActCost = If(d.BookFinAPActCost.HasValue, d.BookFinAPActCost, 0) _
                                          , .BookFinAPPayDate = d.BookFinAPPayDate _
                                          , .BookFinAPPayAmt = If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0) _
                                          , .BookFinAPCheck = d.BookFinAPCheck _
                                          , .BookFinAPGLNumber = d.BookFinAPGLNumber _
                                          , .BookFinAPLastViewed = d.BookFinAPLastViewed _
                                          , .BookFinAPCurType = If(d.BookFinAPCurType.HasValue, d.BookFinAPCurType, 0) _
                                          , .BookFinCommStd = If(d.BookFinCommStd.HasValue, d.BookFinCommStd, 0) _
                                          , .BookFinCommAct = If(d.BookFinCommAct.HasValue, d.BookFinCommAct, 0) _
                                          , .BookFinCommPayDate = d.BookFinCommPayDate _
                                          , .BookFinCommPayAmt = If(d.BookFinCommPayAmt.HasValue, d.BookFinCommPayAmt, 0) _
                                          , .BookFinCommtCheck = d.BookFinCommtCheck _
                                          , .BookFinCommCreditAmt = If(d.BookFinCommCreditAmt.HasValue, d.BookFinCommCreditAmt, 0) _
                                          , .BookFinCommCreditPayDate = d.BookFinCommCreditPayDate _
                                          , .BookFinCommLoadCount = If(d.BookFinCommLoadCount.HasValue, d.BookFinCommLoadCount, 0) _
                                          , .BookFinCommGLNumber = d.BookFinCommGLNumber _
                                          , .BookFinCheckClearedDate = d.BookFinCheckClearedDate _
                                          , .BookFinCheckClearedNumber = d.BookFinCheckClearedNumber _
                                          , .BookFinCheckClearedAmt = If(d.BookFinCheckClearedAmt.HasValue, d.BookFinCheckClearedAmt, 0) _
                                          , .BookFinCheckClearedDesc = d.BookFinCheckClearedDesc _
                                          , .BookFinCheckClearedAcct = d.BookFinCheckClearedAcct _
                                          , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                          , .BookRevCarrierCost = If(d.BookRevCarrierCost.HasValue, d.BookRevCarrierCost, 0) _
                                          , .BookRevStopQty = If(d.BookRevStopQty.HasValue, d.BookRevStopQty, 0) _
                                          , .BookRevStopCost = If(d.BookRevStopCost.HasValue, d.BookRevStopCost, 0) _
                                          , .BookRevOtherCost = If(d.BookRevOtherCost.HasValue, d.BookRevOtherCost, 0) _
                                          , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                          , .BookRevLoadSavings = If(d.BookRevLoadSavings.HasValue, d.BookRevLoadSavings, 0) _
                                          , .BookRevCommPercent = If(d.BookRevCommPercent.HasValue, d.BookRevCommPercent, 0) _
                                          , .BookRevCommCost = If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0) _
                                          , .BookRevGrossRevenue = If(d.BookRevGrossRevenue.HasValue, d.BookRevGrossRevenue, 0) _
                                          , .BookRevNegRevenue = If(d.BookRevNegRevenue.HasValue, d.BookRevNegRevenue, 0) _
                                          , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                          , .BookLaneCarrControl = If(d.BookLaneCarrControl.HasValue, d.BookLaneCarrControl, 0) _
                                          , .BookHoldLoad = If(d.BookHoldLoad.HasValue, d.BookHoldLoad, 0) _
                                          , .BookRouteFinalDate = d.BookRouteFinalDate _
                                          , .BookRouteFinalCode = d.BookRouteFinalCode _
                                          , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                          , .BookWarehouseNumber = d.BookWarehouseNumber _
                                          , .BookComCode = d.BookComCode _
                                          , .BookTransType = d.BookTransType _
                                          , .BookRouteConsFlag = d.BookRouteConsFlag _
                                          , .BookWhseAuthorizationNo = d.BookWhseAuthorizationNo _
                                          , .BookHotLoad = If(d.BookHotLoad.HasValue, d.BookHotLoad, False) _
                                          , .BookFinAPActTax = If(d.BookFinAPActTax.HasValue, d.BookFinAPActTax, 0) _
                                          , .BookFinAPExportFlag = d.BookFinAPExportFlag _
                                          , .BookFinARFreightTax = d.BookFinARFreightTax _
                                          , .BookRevFreightTax = d.BookRevFreightTax _
                                          , .BookRevNetCost = d.BookRevNetCost _
                                          , .BookFinServiceFee = If(d.BookFinServiceFee.HasValue, d.BookFinServiceFee, 0) _
                                          , .BookFinAPExportDate = d.BookFinAPExportDate _
                                          , .BookFinAPExportRetry = If(d.BookFinAPExportRetry.HasValue, d.BookFinAPExportRetry, 0) _
                                          , .BookCarrierContControl = If(d.BookCarrierContControl.HasValue, d.BookCarrierContControl, 0) _
                                          , .BookHotLoadSent = If(d.BookHotLoadSent.HasValue, d.BookHotLoadSent, False) _
                                          , .BookExportDocCreated = If(d.BookExportDocCreated.HasValue, d.BookExportDocCreated, False) _
                                          , .BookDoNotInvoice = d.BookDoNotInvoice _
                                          , .BookCarrStartLoadingDate = d.BookCarrStartLoadingDate _
                                          , .BookCarrStartLoadingTime = d.BookCarrStartLoadingTime _
                                          , .BookCarrFinishLoadingDate = d.BookCarrFinishLoadingDate _
                                          , .BookCarrFinishLoadingTime = d.BookCarrFinishLoadingTime _
                                          , .BookCarrStartUnloadingDate = d.BookCarrStartUnloadingDate _
                                          , .BookCarrStartUnloadingTime = d.BookCarrStartUnloadingTime _
                                          , .BookCarrFinishUnloadingDate = d.BookCarrFinishUnloadingDate _
                                          , .BookCarrFinishUnloadingTime = d.BookCarrFinishUnloadingTime _
                                          , .BookOrderSequence = d.BookOrderSequence _
                                          , .BookChepGLID = d.BookChepGLID _
                                          , .BookCarrierTypeCode = d.BookCarrierTypeCode _
                                          , .BookPalletPositions = d.BookPalletPositions _
                                          , .BookShipCarrierProNumber = d.BookShipCarrierProNumber _
                                          , .BookShipCarrierName = d.BookShipCarrierName _
                                          , .BookShipCarrierNumber = d.BookShipCarrierNumber _
                                          , .BookAPAdjReasonControl = d.BookAPAdjReasonControl _
                                          , .BookDateRequested = d.BookDateRequested _
                                          , .BookCarrierEquipmentCodes = d.BookCarrierEquipmentCodes _
                                          , .BookLockAllCosts = d.BookLockAllCosts _
                                          , .BookLockBFCCost = d.BookLockBFCCost _
                                            , .BookDestStopNumber = d.BookDestStopNumber _
                                            , .BookOrigStopNumber = d.BookOrigStopNumber _
                                            , .BookDestStopControl = d.BookDestStopControl _
                                            , .BookOrigStopControl = d.BookOrigStopControl _
                                            , .BookRouteTypeCode = d.BookRouteTypeCode _
                                            , .BookAlternateAddressLaneControl = d.BookAlternateAddressLaneControl _
                                            , .BookAlternateAddressLaneNumber = d.BookAlternateAddressLaneNumber _
                                            , .BookDefaultRouteSequence = d.BookDefaultRouteSequence _
                                            , .BookRouteGuideControl = d.BookRouteGuideControl _
                                            , .BookRouteGuideNumber = d.BookRouteGuideNumber _
                                            , .BookCustomerApprovalRecieved = d.BookCustomerApprovalRecieved _
                                            , .BookCustomerApprovalTransmitted = d.BookCustomerApprovalTransmitted _
                                            , .BookAMSPickupApptControl = d.BookAMSPickupApptControl _
                                            , .BookAMSDeliveryApptControl = d.BookAMSDeliveryApptControl _
                                            , .BookItemDetailDescription = d.BookItemDetailDescription _
                                          , .BookModDate = d.BookModDate _
                                          , .BookModUser = d.BookModUser _
                                          , .BookUpdated = d.BookUpdated.ToArray _
                                          }).Take(200).ToArray()

                Return Books

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBookARMassEntryRecords(ByVal BookCustCompControl As Integer) As DTO.Book()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Get the AP Check Entry Book Records
                Dim Books() As DTO.Book = ( _
                From d In db.Books _
                Where _
                    (d.BookCustCompControl = BookCustCompControl) _
                    And _
                    (d.BookFinARPayAmt.HasValue = False OrElse d.BookFinARPayAmt = 0) _
                    And _
                    (d.BookFinARInvoiceAmt.HasValue AndAlso d.BookFinARInvoiceAmt.Value <> 0) _
                Order By d.BookFinARInvoiceDate, d.BookProNumber, d.BookConsPrefix _
                Select New DTO.Book With {.BookControl = d.BookControl _
                                          , .BookProNumber = d.BookProNumber _
                                          , .BookProBase = d.BookProBase _
                                          , .BookConsPrefix = d.BookConsPrefix _
                                          , .BookCustCompControl = d.BookCustCompControl _
                                          , .BookCommCompControl = d.BookCommCompControl _
                                          , .BookODControl = d.BookODControl _
                                          , .BookCarrierControl = d.BookCarrierControl _
                                          , .BookCarrierContact = d.BookCarrierContact _
                                          , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                          , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                          , .BookOrigName = d.BookOrigName _
                                          , .BookOrigAddress1 = d.BookOrigAddress1 _
                                          , .BookOrigAddress2 = d.BookOrigAddress2 _
                                          , .BookOrigAddress3 = d.BookOrigAddress3 _
                                          , .BookOrigCity = d.BookOrigCity _
                                          , .BookOrigState = d.BookOrigState _
                                          , .BookOrigCountry = d.BookOrigCountry _
                                          , .BookOrigZip = d.BookOrigZip _
                                          , .BookOrigPhone = d.BookOrigPhone _
                                          , .BookOrigFax = d.BookOrigFax _
                                          , .BookOriginStartHrs = d.BookOriginStartHrs _
                                          , .BookOriginStopHrs = d.BookOriginStopHrs _
                                          , .BookOriginApptReq = If(d.BookOriginApptReq.HasValue, d.BookOriginApptReq, False) _
                                          , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                          , .BookDestName = d.BookDestName _
                                          , .BookDestAddress1 = d.BookDestAddress1 _
                                          , .BookDestAddress2 = d.BookDestAddress2 _
                                          , .BookDestAddress3 = d.BookDestAddress3 _
                                          , .BookDestCity = d.BookDestCity _
                                          , .BookDestState = d.BookDestState _
                                          , .BookDestCountry = d.BookDestCountry _
                                          , .BookDestZip = d.BookDestZip _
                                          , .BookDestPhone = d.BookDestPhone _
                                          , .BookDestFax = d.BookDestFax _
                                          , .BookDestStartHrs = d.BookDestStartHrs _
                                          , .BookDestStopHrs = d.BookDestStopHrs _
                                          , .BookDestApptReq = If(d.BookDestApptReq.HasValue, d.BookDestApptReq, False) _
                                          , .BookDateOrdered = d.BookDateOrdered _
                                          , .BookDateLoad = d.BookDateLoad _
                                          , .BookDateInvoice = d.BookDateInvoice _
                                          , .BookDateRequired = d.BookDateRequired _
                                          , .BookDateDelivered = d.BookDateDelivered _
                                          , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                          , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                          , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                          , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                          , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                          , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                          , .BookTranCode = d.BookTranCode _
                                          , .BookPayCode = d.BookPayCode _
                                          , .BookTypeCode = d.BookTypeCode _
                                          , .BookBOLCode = d.BookBOLCode _
                                          , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                          , .BookCarrFBNumber = d.BookCarrFBNumber _
                                          , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                          , .BookCarrBLNumber = d.BookCarrBLNumber _
                                          , .BookCarrBookDate = d.BookCarrBookDate _
                                          , .BookCarrBookTime = d.BookCarrBookTime _
                                          , .BookCarrBookContact = d.BookCarrBookContact _
                                          , .BookCarrScheduleDate = d.BookCarrScheduleDate _
                                          , .BookCarrScheduleTime = d.BookCarrScheduleTime _
                                          , .BookCarrActualDate = d.BookCarrActualDate _
                                          , .BookCarrActualTime = d.BookCarrActualTime _
                                          , .BookCarrActLoadComplete_Date = d.BookCarrActLoadComplete_Date _
                                          , .BookCarrActLoadCompleteTime = d.BookCarrActLoadCompleteTime _
                                          , .BookCarrDockPUAssigment = d.BookCarrDockPUAssigment _
                                          , .BookCarrPODate = d.BookCarrPODate _
                                          , .BookCarrPOTime = d.BookCarrPOTime _
                                          , .BookCarrApptDate = d.BookCarrApptDate _
                                          , .BookCarrApptTime = d.BookCarrApptTime _
                                          , .BookCarrActDate = d.BookCarrActDate _
                                          , .BookCarrActTime = d.BookCarrActTime _
                                          , .BookCarrActUnloadCompDate = d.BookCarrActUnloadCompDate _
                                          , .BookCarrActUnloadCompTime = d.BookCarrActUnloadCompTime _
                                          , .BookCarrDockDelAssignment = d.BookCarrDockDelAssignment _
                                          , .BookCarrVarDay = If(d.BookCarrVarDay.HasValue, d.BookCarrVarDay, 0) _
                                          , .BookCarrVarHrs = If(d.BookCarrVarHrs.HasValue, d.BookCarrVarHrs, 0) _
                                          , .BookCarrTrailerNo = d.BookCarrTrailerNo _
                                          , .BookCarrSealNo = d.BookCarrSealNo _
                                          , .BookCarrDriverNo = d.BookCarrDriverNo _
                                          , .BookCarrDriverName = d.BookCarrDriverName _
                                          , .BookCarrRouteNo = d.BookCarrRouteNo _
                                          , .BookCarrTripNo = d.BookCarrTripNo _
                                          , .BookFinARBookFrt = If(d.BookFinARBookFrt.HasValue, d.BookFinARBookFrt, 0) _
                                          , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                          , .BookFinARInvoiceAmt = If(d.BookFinARInvoiceAmt.HasValue, d.BookFinARInvoiceAmt, 0) _
                                          , .BookFinARPayDate = d.BookFinARPayDate _
                                          , .BookFinARPayAmt = If(d.BookFinARPayAmt.HasValue, d.BookFinARPayAmt, 0) _
                                          , .BookFinARCheck = d.BookFinARCheck _
                                          , .BookFinARGLNumber = d.BookFinARGLNumber _
                                          , .BookFinARBalance = If(d.BookFinARBalance.HasValue, d.BookFinARBalance, 0) _
                                          , .BookFinARCurType = If(d.BookFinARCurType.HasValue, d.BookFinARCurType, 0) _
                                          , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                          , .BookFinAPBillNoDate = d.BookFinAPBillNoDate _
                                          , .BookFinAPBillInvDate = d.BookFinAPBillInvDate _
                                          , .BookFinAPActWgt = If(d.BookFinAPActWgt.HasValue, d.BookFinAPActWgt, 0) _
                                          , .BookFinAPStdCost = If(d.BookFinAPStdCost.HasValue, d.BookFinAPStdCost, 0) _
                                          , .BookFinAPActCost = If(d.BookFinAPActCost.HasValue, d.BookFinAPActCost, 0) _
                                          , .BookFinAPPayDate = d.BookFinAPPayDate _
                                          , .BookFinAPPayAmt = If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0) _
                                          , .BookFinAPCheck = d.BookFinAPCheck _
                                          , .BookFinAPGLNumber = d.BookFinAPGLNumber _
                                          , .BookFinAPLastViewed = d.BookFinAPLastViewed _
                                          , .BookFinAPCurType = If(d.BookFinAPCurType.HasValue, d.BookFinAPCurType, 0) _
                                          , .BookFinCommStd = If(d.BookFinCommStd.HasValue, d.BookFinCommStd, 0) _
                                          , .BookFinCommAct = If(d.BookFinCommAct.HasValue, d.BookFinCommAct, 0) _
                                          , .BookFinCommPayDate = d.BookFinCommPayDate _
                                          , .BookFinCommPayAmt = If(d.BookFinCommPayAmt.HasValue, d.BookFinCommPayAmt, 0) _
                                          , .BookFinCommtCheck = d.BookFinCommtCheck _
                                          , .BookFinCommCreditAmt = If(d.BookFinCommCreditAmt.HasValue, d.BookFinCommCreditAmt, 0) _
                                          , .BookFinCommCreditPayDate = d.BookFinCommCreditPayDate _
                                          , .BookFinCommLoadCount = If(d.BookFinCommLoadCount.HasValue, d.BookFinCommLoadCount, 0) _
                                          , .BookFinCommGLNumber = d.BookFinCommGLNumber _
                                          , .BookFinCheckClearedDate = d.BookFinCheckClearedDate _
                                          , .BookFinCheckClearedNumber = d.BookFinCheckClearedNumber _
                                          , .BookFinCheckClearedAmt = If(d.BookFinCheckClearedAmt.HasValue, d.BookFinCheckClearedAmt, 0) _
                                          , .BookFinCheckClearedDesc = d.BookFinCheckClearedDesc _
                                          , .BookFinCheckClearedAcct = d.BookFinCheckClearedAcct _
                                          , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                          , .BookRevCarrierCost = If(d.BookRevCarrierCost.HasValue, d.BookRevCarrierCost, 0) _
                                          , .BookRevStopQty = If(d.BookRevStopQty.HasValue, d.BookRevStopQty, 0) _
                                          , .BookRevStopCost = If(d.BookRevStopCost.HasValue, d.BookRevStopCost, 0) _
                                          , .BookRevOtherCost = If(d.BookRevOtherCost.HasValue, d.BookRevOtherCost, 0) _
                                          , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                          , .BookRevLoadSavings = If(d.BookRevLoadSavings.HasValue, d.BookRevLoadSavings, 0) _
                                          , .BookRevCommPercent = If(d.BookRevCommPercent.HasValue, d.BookRevCommPercent, 0) _
                                          , .BookRevCommCost = If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0) _
                                          , .BookRevGrossRevenue = If(d.BookRevGrossRevenue.HasValue, d.BookRevGrossRevenue, 0) _
                                          , .BookRevNegRevenue = If(d.BookRevNegRevenue.HasValue, d.BookRevNegRevenue, 0) _
                                          , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                          , .BookLaneCarrControl = If(d.BookLaneCarrControl.HasValue, d.BookLaneCarrControl, 0) _
                                          , .BookHoldLoad = If(d.BookHoldLoad.HasValue, d.BookHoldLoad, False) _
                                          , .BookRouteFinalDate = d.BookRouteFinalDate _
                                          , .BookRouteFinalCode = d.BookRouteFinalCode _
                                          , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                          , .BookWarehouseNumber = d.BookWarehouseNumber _
                                          , .BookComCode = d.BookComCode _
                                          , .BookTransType = d.BookTransType _
                                          , .BookRouteConsFlag = d.BookRouteConsFlag _
                                          , .BookWhseAuthorizationNo = d.BookWhseAuthorizationNo _
                                          , .BookHotLoad = If(d.BookHotLoad.HasValue, d.BookHotLoad, 0) _
                                          , .BookFinAPActTax = If(d.BookFinAPActTax.HasValue, d.BookFinAPActTax, 0) _
                                          , .BookFinAPExportFlag = d.BookFinAPExportFlag _
                                          , .BookFinARFreightTax = d.BookFinARFreightTax _
                                          , .BookRevFreightTax = d.BookRevFreightTax _
                                          , .BookRevNetCost = d.BookRevNetCost _
                                          , .BookFinServiceFee = If(d.BookFinServiceFee.HasValue, d.BookFinServiceFee, 0) _
                                          , .BookFinAPExportDate = d.BookFinAPExportDate _
                                          , .BookFinAPExportRetry = If(d.BookFinAPExportRetry.HasValue, d.BookFinAPExportRetry, 0) _
                                          , .BookCarrierContControl = If(d.BookCarrierContControl.HasValue, d.BookCarrierContControl, 0) _
                                          , .BookHotLoadSent = If(d.BookHotLoadSent.HasValue, d.BookHotLoadSent, False) _
                                          , .BookExportDocCreated = If(d.BookExportDocCreated.HasValue, d.BookExportDocCreated, False) _
                                          , .BookDoNotInvoice = d.BookDoNotInvoice _
                                          , .BookCarrStartLoadingDate = d.BookCarrStartLoadingDate _
                                          , .BookCarrStartLoadingTime = d.BookCarrStartLoadingTime _
                                          , .BookCarrFinishLoadingDate = d.BookCarrFinishLoadingDate _
                                          , .BookCarrFinishLoadingTime = d.BookCarrFinishLoadingTime _
                                          , .BookCarrStartUnloadingDate = d.BookCarrStartUnloadingDate _
                                          , .BookCarrStartUnloadingTime = d.BookCarrStartUnloadingTime _
                                          , .BookCarrFinishUnloadingDate = d.BookCarrFinishUnloadingDate _
                                          , .BookCarrFinishUnloadingTime = d.BookCarrFinishUnloadingTime _
                                          , .BookOrderSequence = d.BookOrderSequence _
                                          , .BookChepGLID = d.BookChepGLID _
                                          , .BookCarrierTypeCode = d.BookCarrierTypeCode _
                                          , .BookPalletPositions = d.BookPalletPositions _
                                          , .BookShipCarrierProNumber = d.BookShipCarrierProNumber _
                                          , .BookShipCarrierName = d.BookShipCarrierName _
                                          , .BookShipCarrierNumber = d.BookShipCarrierNumber _
                                          , .BookAPAdjReasonControl = d.BookAPAdjReasonControl _
                                          , .BookDateRequested = d.BookDateRequested _
                                          , .BookCarrierEquipmentCodes = d.BookCarrierEquipmentCodes _
                                          , .BookLockAllCosts = d.BookLockAllCosts _
                                          , .BookLockBFCCost = d.BookLockBFCCost _
                                            , .BookDestStopNumber = d.BookDestStopNumber _
                                            , .BookOrigStopNumber = d.BookOrigStopNumber _
                                            , .BookDestStopControl = d.BookDestStopControl _
                                            , .BookOrigStopControl = d.BookOrigStopControl _
                                            , .BookRouteTypeCode = d.BookRouteTypeCode _
                                            , .BookAlternateAddressLaneControl = d.BookAlternateAddressLaneControl _
                                            , .BookAlternateAddressLaneNumber = d.BookAlternateAddressLaneNumber _
                                            , .BookDefaultRouteSequence = d.BookDefaultRouteSequence _
                                            , .BookRouteGuideControl = d.BookRouteGuideControl _
                                            , .BookRouteGuideNumber = d.BookRouteGuideNumber _
                                            , .BookCustomerApprovalRecieved = d.BookCustomerApprovalRecieved _
                                            , .BookCustomerApprovalTransmitted = d.BookCustomerApprovalTransmitted _
                                            , .BookAMSPickupApptControl = d.BookAMSPickupApptControl _
                                            , .BookAMSDeliveryApptControl = d.BookAMSDeliveryApptControl _
                                            , .BookItemDetailDescription = d.BookItemDetailDescription _
                                          , .BookModDate = d.BookModDate _
                                          , .BookModUser = d.BookModUser _
                                          , .BookUpdated = d.BookUpdated.ToArray _
                                          }).ToArray()

                Return Books

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBookCheckCalls(ByVal BookConsPrefix As String) As DTO.BookCheckCall()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'db.Log = New DebugTextWriter
                Dim BookCheckCalls() As DTO.BookCheckCall = ( _
                From d In db.Books _
                Where _
                    (d.BookConsPrefix = BookConsPrefix) _
                Order By d.BookStopNo Ascending, d.BookProNumber Ascending _
                Select New DTO.BookCheckCall With {.BookControl = d.BookControl _
                                            , .BookProNumber = d.BookProNumber _
                                            , .BookConsPrefix = d.BookConsPrefix _
                                            , .BookCustCompControl = d.BookCustCompControl _
                                            , .BookODControl = d.BookODControl _
                                            , .BookCarrierControl = d.BookCarrierControl _
                                            , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                            , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                            , .BookCarrActDate = d.BookCarrActDate _
                                            , .BookCarrActTime = d.BookCarrActTime _
                                            , .BookOrderSequence = d.BookOrderSequence}).ToArray()

                Return BookCheckCalls

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetvConsolidationData(ByVal Filters As String) As DTO.vConsolidation()
        'Create a data connection 
        Dim oQuery As New NGL.Core.Data.Query(ConnectionString)
        Dim oConsolidation As New List(Of DTO.vConsolidation)

        Try
            Dim strComp As String = ""
            If Not String.IsNullOrEmpty(Filters) AndAlso Filters.Trim.Length > 1 Then
                strComp = " AND "
            End If
            strComp &= "( " _
                & "(isnull((SELECT top 1 isnull(dbo.UserAdmin.UserAdminCompControl,0) FROM dbo.UserAdmin Where dbo.UserAdmin.UserAdminUserName = '" & Me.Parameters.UserName & "'),0) > 0" _
                & "	AND " _
                & " CompNumber In (SELECT dbo.UserAdmin.UserAdminCompControl FROM dbo.UserAdmin	Where dbo.UserAdmin.UserAdminUserName = '" & Me.Parameters.UserName & "')" _
                & ")" _
                & " OR " _
                & " isnull((SELECT top 1 isnull(dbo.UserAdmin.UserAdminCompControl,0) FROM dbo.UserAdmin Where dbo.UserAdmin.UserAdminUserName = '" & Me.Parameters.UserName & "'),0) = 0" _
                & ") "
            Dim strSQL As String = "Select Top 500 * from Consolidation Where " & Filters & strComp & " Order By BookOrigState, BookOrigCity, BookOrigZip, BookDateRequired, BookProNumber "
            Dim oQRet As NGL.Core.Data.QueryResult = oQuery.ExecuteWithFill(strSQL)
            If Not oQRet.Exception Is Nothing Then
                Utilities.SaveAppError(oQRet.Exception.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_FailedToExecute"}, New FaultReason("E_DataAccessError"))
            End If
            If Not oQRet.Data Is Nothing AndAlso oQRet.Data.Rows.Count > 0 Then
                For Each oRow As System.Data.DataRow In oQRet.Data.Rows
                    Dim oItem As New DTO.vConsolidation
                    With oItem
                        .BookControl = DTran.getDataRowValue(oRow, "BookControl", 0)

                        .BookDateLoad = DTran.getDataRowValue(oRow, "BookDateLoad")

                        .BookStopNo = DTran.getDataRowValue(oRow, "BookStopNo", 0)

                        .BookTranCode = DTran.getDataRowValue(oRow, "BookTranCode", "")

                        .BookOrigState = DTran.getDataRowValue(oRow, "BookOrigState", "")

                        .BookOrigCity = DTran.getDataRowValue(oRow, "BookOrigCity", "")

                        .BookOrigZip = DTran.getDataRowValue(oRow, "BookOrigZip", "")

                        .BookDateRequired = DTran.getDataRowValue(oRow, "BookDateRequired")

                        .BookConsPrefix = DTran.getDataRowValue(oRow, "BookConsPrefix", "")

                        .BookProNumber = DTran.getDataRowValue(oRow, "BookProNumber", "")

                        .CompControl = DTran.getDataRowValue(oRow, "CompControl", 0)

                        .CompNumber = DTran.getDataRowValue(oRow, "CompNumber", 0)

                        .CompName = DTran.getDataRowValue(oRow, "CompName", "")

                        .BookOrigName = DTran.getDataRowValue(oRow, "BookOrigName", "")

                        .BookDestName = DTran.getDataRowValue(oRow, "BookDestName", "")

                        .BookDestCity = DTran.getDataRowValue(oRow, "BookDestCity", "")

                        .BookDestState = DTran.getDataRowValue(oRow, "BookDestState", "")

                        .BookDestZip = DTran.getDataRowValue(oRow, "BookDestZip", "")

                        .BookTotalCases = DTran.getDataRowValue(oRow, "BookTotalCases", 0)

                        .BookTotalWgt = DTran.getDataRowValue(oRow, "BookTotalWgt", 0)

                        .BookTotalPL = DTran.getDataRowValue(oRow, "BookTotalPL", 0)

                        .BookTotalCube = DTran.getDataRowValue(oRow, "BookTotalCube", 0)

                        .BookTotalPX = DTran.getDataRowValue(oRow, "BookTotalPX", 0)

                        .BookTotalBFC = DTran.getDataRowValue(oRow, "BookTotalBFC", 0)

                        .BookDateDelivered = DTran.getDataRowValue(oRow, "BookDateDelivered")

                        .BookDateInvoice = DTran.getDataRowValue(oRow, "BookDateInvoice")

                        .BookODControl = DTran.getDataRowValue(oRow, "BookODControl", 0)

                        .BookCarrierControl = DTran.getDataRowValue(oRow, "BookCarrierControl", 0)

                        .BookPayCode = DTran.getDataRowValue(oRow, "BookPayCode", "")

                        .BookModDate = DTran.getDataRowValue(oRow, "BookModDate")

                        .BookModUser = DTran.getDataRowValue(oRow, "BookModUser", "")

                        .Expr1 = DTran.getDataRowValue(oRow, "Expr1")

                        .BookLoadPONumber = DTran.getDataRowValue(oRow, "BookLoadPONumber", "")

                        .BookLoadVendor = DTran.getDataRowValue(oRow, "BookLoadVendor", "")

                        .BookLoadCaseQty = DTran.getDataRowValue(oRow, "BookLoadCaseQty", 0)

                        .BookLoadWgt = DTran.getDataRowValue(oRow, "BookLoadWgt", 0)

                        .BookLoadCube = DTran.getDataRowValue(oRow, "BookLoadCube", 0)

                        .BookLoadPL = DTran.getDataRowValue(oRow, "BookLoadPL", 0)

                        .BookLoadPX = DTran.getDataRowValue(oRow, "BookLoadPX", 0)

                        .BookLoadCom = DTran.getDataRowValue(oRow, "BookLoadCom", "")

                        .BookLoadPUOrigin = DTran.getDataRowValue(oRow, "BookLoadPUOrigin", "")

                        .BookLoadBFC = DTran.getDataRowValue(oRow, "BookLoadBFC", 0)

                        .BookDestAddress1 = DTran.getDataRowValue(oRow, "BookDestAddress1", "")

                        .BookDestAddress2 = DTran.getDataRowValue(oRow, "BookDestAddress2", "")

                        .LaneLatitude = DTran.getDataRowValue(oRow, "LaneLatitude", 0)

                        .LaneLongitude = DTran.getDataRowValue(oRow, "LaneLongitude", 0)

                        .SpecialCodes = DTran.getDataRowValue(oRow, "SpecialCodes", "")

                        .LaneFixedTime = DTran.getDataRowValue(oRow, "LaneFixedTime", "")

                        .BookLoadControl = DTran.getDataRowValue(oRow, "BookLoadControl", 0)

                        .BookHoldLoad = DTran.getDataRowValue(oRow, "BookHoldLoad", 0)

                        .LaneControl = DTran.getDataRowValue(oRow, "LaneControl", 0)

                        .ActualWgt = DTran.getDataRowValue(oRow, "ActualWgt", 0)

                        .LaneNumber = DTran.getDataRowValue(oRow, "LaneNumber", "")

                        .BookCarrOrderNumber = DTran.getDataRowValue(oRow, "BookCarrOrderNumber", "")

                        .BookTransType = DTran.getDataRowValue(oRow, "BookTransType", "")

                        .BookRevBilledBFC = DTran.getDataRowValue(oRow, "BookRevBilledBFC", 0)

                        .BookCustCompControl = DTran.getDataRowValue(oRow, "BookCustCompControl", 0)

                        .BookRevTotalCost = DTran.getDataRowValue(oRow, "BookRevTotalCost", 0)

                        .BookTypeCode = DTran.getDataRowValue(oRow, "BookTypeCode", "")

                        .CarrierName = DTran.getDataRowValue(oRow, "CarrierName", "")

                        .CarrierNumber = DTran.getDataRowValue(oRow, "CarrierNumber", 0)

                        .CarrierNameNumber = .CarrierNumber.ToString & " " & .CarrierName

                        .BookNotesVisable1 = DTran.getDataRowValue(oRow, "BookNotesVisable1", "")

                    End With
                    oConsolidation.Add(oItem)
                Next
            Else
                oConsolidation.Add(New DTO.vConsolidation)
            End If
            Return oConsolidation.ToArray()
        Catch ex As FaultException
            Throw
        Catch ex As System.Data.SqlClient.SqlException
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
        Catch ex As InvalidOperationException
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
        Catch ex As Exception
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
        Finally
            oQuery = Nothing
        End Try

        Return Nothing
    End Function

    Public Function GetvLoadStatusBoardData(ByVal Filters As String) As DTO.vLoadStatusBoard()
        'Create a data connection 
        Dim oQuery As New NGL.Core.Data.Query(ConnectionString)
        Dim oLoadStatusBoard As New List(Of DTO.vLoadStatusBoard)

        Try
            Dim strComp As String = ""
            If Not String.IsNullOrEmpty(Filters) AndAlso Filters.Trim.Length > 1 Then
                strComp = " AND "
            End If
            strComp &= "( " _
                & "(isnull((SELECT top 1 isnull(dbo.UserAdmin.UserAdminCompControl,0) FROM dbo.UserAdmin Where dbo.UserAdmin.UserAdminUserName = '" & Me.Parameters.UserName & "'),0) > 0" _
                & "	AND " _
                & " CompNumber In (SELECT dbo.UserAdmin.UserAdminCompControl FROM dbo.UserAdmin	Where dbo.UserAdmin.UserAdminUserName = '" & Me.Parameters.UserName & "')" _
                & ")" _
                & " OR " _
                & " isnull((SELECT top 1 isnull(dbo.UserAdmin.UserAdminCompControl,0) FROM dbo.UserAdmin Where dbo.UserAdmin.UserAdminUserName = '" & Me.Parameters.UserName & "'),0) = 0" _
                & ") "

            Dim strSQL As String = "SELECT Top 500 BookControl, BookDateLoad, BookDateRequired, BookOrigZip, BookOrigCity, BookOrigState, BookConsPrefix, BookProNumber, " _
                                    & " BookCustCompControl, CompName, BookOrigName, BookDestName, BookDestCity, BookDestState, BookDestZip, BookTotalCases, BookTotalWgt, " _
                                     & " BookTotalPL, BookTotalCube, BookTotalPX, BookTotalBFC, BookCarrActDate, BookFinARInvoiceDate, BookODControl, BookCarrierControl, CarrierName, BookTranCode, " _
                                     & " BookPayCode, BookModDate, BookModUser, BookStopNo, BookRevBilledBFC, BookRevCarrierCost, BookRevOtherCost, BookRevTotalCost, " _
                                     & " BookMilesFrom , BookRouteConsFlag,BookCarrierContact , BookCarrierContactPhone,BookTypeCode,BookCarrOrderNumber " _
                                     & " FROM Book, Comp, Carrier " _
                                     & " WHERE Book.BookCustCompControl = Comp.CompControl and Book.BookCarrierControl = Carrier.CarrierControl " & strComp & " and " & Filters

            Dim oQRet As NGL.Core.Data.QueryResult = oQuery.ExecuteWithFill(strSQL)
            If Not oQRet.Exception Is Nothing Then
                Utilities.SaveAppError(oQRet.Exception.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_FailedToExecute"}, New FaultReason("E_DataAccessError"))
            End If
            If Not oQRet.Data Is Nothing AndAlso oQRet.Data.Rows.Count > 0 Then
                For Each oRow As System.Data.DataRow In oQRet.Data.Rows
                    Dim oItem As New DTO.vLoadStatusBoard
                    With oItem
                        .BookControl = DTran.getDataRowValue(oRow, "BookControl", 0)
                        .BookDateLoad = DTran.getDataRowValue(oRow, "BookDateLoad")
                        .BookDateRequired = DTran.getDataRowValue(oRow, "BookDateRequired")
                        .BookOrigZip = DTran.getDataRowValue(oRow, "BookOrigZip", "")
                        .BookOrigCity = DTran.getDataRowValue(oRow, "BookOrigCity", "")
                        .BookOrigState = DTran.getDataRowValue(oRow, "BookOrigState", "")
                        .BookConsPrefix = DTran.getDataRowValue(oRow, "BookConsPrefix", "")
                        .BookProNumber = DTran.getDataRowValue(oRow, "BookProNumber", "")
                        .BookCustCompControl = DTran.getDataRowValue(oRow, "BookCustCompControl", 0)
                        .CompName = DTran.getDataRowValue(oRow, "CompName", "")
                        .BookOrigName = DTran.getDataRowValue(oRow, "BookOrigName", "")
                        .BookDestName = DTran.getDataRowValue(oRow, "BookDestName", "")
                        .BookDestCity = DTran.getDataRowValue(oRow, "BookDestCity", "")
                        .BookDestState = DTran.getDataRowValue(oRow, "BookDestState", "")
                        .BookDestZip = DTran.getDataRowValue(oRow, "BookDestZip", "")
                        .BookTotalCases = DTran.getDataRowValue(oRow, "BookTotalCases", 0)
                        .BookTotalWgt = DTran.getDataRowValue(oRow, "BookTotalWgt", 0)
                        .BookTotalPL = DTran.getDataRowValue(oRow, "BookTotalPL", 0)
                        .BookTotalCube = DTran.getDataRowValue(oRow, "BookTotalCube", 0)
                        .BookTotalPX = DTran.getDataRowValue(oRow, "BookTotalPX", 0)
                        .BookTotalBFC = DTran.getDataRowValue(oRow, "BookTotalBFC", 0)
                        .BookCarrActDate = DTran.getDataRowValue(oRow, "BookCarrActDate")
                        .BookFinARInvoiceDate = DTran.getDataRowValue(oRow, "BookFinARInvoiceDate")
                        .BookODControl = DTran.getDataRowValue(oRow, "BookODControl", 0)
                        .BookCarrierControl = DTran.getDataRowValue(oRow, "BookCarrierControl", 0)
                        .CarrierName = DTran.getDataRowValue(oRow, "CarrierName", "")
                        .BookTranCode = DTran.getDataRowValue(oRow, "BookTranCode", "")
                        .BookPayCode = DTran.getDataRowValue(oRow, "BookPayCode", "")
                        .BookStopNo = DTran.getDataRowValue(oRow, "BookStopNo", 0)
                        .BookModDate = DTran.getDataRowValue(oRow, "BookModDate")
                        .BookModUser = DTran.getDataRowValue(oRow, "BookModUser", "")
                        .BookRevBilledBFC = DTran.getDataRowValue(oRow, "BookRevBilledBFC", 0)
                        .BookCarrOrderNumber = DTran.getDataRowValue(oRow, "BookCarrOrderNumber", "")
                        .BookRevCarrierCost = DTran.getDataRowValue(oRow, "BookRevCarrierCost", 0)
                        .BookRevOtherCost = DTran.getDataRowValue(oRow, "BookRevOtherCost", 0)
                        .BookRevTotalCost = DTran.getDataRowValue(oRow, "BookRevTotalCost", 0)
                        .BookMilesFrom = DTran.getDataRowValue(oRow, "BookMilesFrom", 0)
                        .BookRouteConsFlag = DTran.getDataRowValue(oRow, "BookRouteConsFlag", 0)
                        .BookCarrierContact = DTran.getDataRowValue(oRow, "BookCarrierContact", "")
                        .BookCarrierContactPhone = DTran.getDataRowValue(oRow, "BookCarrierContactPhone", "")
                        .BookTypeCode = DTran.getDataRowValue(oRow, "BookTypeCode", "")
                        .BookCarrOrderNumber = DTran.getDataRowValue(oRow, "BookCarrOrderNumber", "")
                    End With
                    oLoadStatusBoard.Add(oItem)
                Next
            Else
                oLoadStatusBoard.Add(New DTO.vLoadStatusBoard)
            End If
            Return oLoadStatusBoard.ToArray()
        Catch ex As FaultException
            Throw
        Catch ex As System.Data.SqlClient.SqlException
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
        Catch ex As InvalidOperationException
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
        Catch ex As Exception
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
        Finally
            oQuery = Nothing
        End Try

        Return Nothing
    End Function

    Public Function GetvOptimizationStopData(ByVal Filters As String) As DTO.vOptimizationStop()
        'Create a data connection 
        Dim oQuery As New NGL.Core.Data.Query(ConnectionString)
        Dim oStopData As New List(Of DTO.vOptimizationStop)

        Try
            Dim strComp As String = ""
            If Not String.IsNullOrEmpty(Filters) AndAlso Filters.Trim.Length > 1 Then
                strComp = " AND "
            End If
            strComp &= "( " _
                & "(isnull((SELECT top 1 isnull(dbo.UserAdmin.UserAdminCompControl,0) FROM dbo.UserAdmin Where dbo.UserAdmin.UserAdminUserName = '" & Me.Parameters.UserName & "'),0) > 0" _
                & "	AND " _
                & " CompNumber In (SELECT dbo.UserAdmin.UserAdminCompControl FROM dbo.UserAdmin	Where dbo.UserAdmin.UserAdminUserName = '" & Me.Parameters.UserName & "')" _
                & ")" _
                & " OR " _
                & " isnull((SELECT top 1 isnull(dbo.UserAdmin.UserAdminCompControl,0) FROM dbo.UserAdmin Where dbo.UserAdmin.UserAdminUserName = '" & Me.Parameters.UserName & "'),0) = 0" _
                & ") "
            Dim strSQL As String = "Select Top 500 * from Consolidation Where " & Filters & strComp & " And isnull([BookHoldLoad],0) = 0  Order By BookOrigState, BookOrigCity, BookOrigZip, BookDateRequired, BookProNumber "
            Dim oQRet As NGL.Core.Data.QueryResult = oQuery.ExecuteWithFill(strSQL)
            If Not oQRet.Exception Is Nothing Then
                Utilities.SaveAppError(oQRet.Exception.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_FailedToExecute"}, New FaultReason("E_DataAccessError"))
            End If
            If Not oQRet.Data Is Nothing AndAlso oQRet.Data.Rows.Count > 0 Then
                For Each oRow As System.Data.DataRow In oQRet.Data.Rows
                    Dim oItem As New DTO.vOptimizationStop
                    With oItem
                        .BookControl = DTran.getDataRowValue(oRow, "BookControl", 0)
                        .BookDateLoad = DTran.getDataRowValue(oRow, "BookDateLoad")
                        .BookStopNo = DTran.getDataRowValue(oRow, "BookStopNo", 0)
                        .BookDateRequired = DTran.getDataRowValue(oRow, "BookDateRequired")
                        .BookConsPrefix = DTran.getDataRowValue(oRow, "BookConsPrefix", "")
                        .BookProNumber = DTran.getDataRowValue(oRow, "BookProNumber", "")
                        .CompControl = DTran.getDataRowValue(oRow, "CompControl", 0)
                        .CompNumber = DTran.getDataRowValue(oRow, "CompNumber", 0)
                        .CompName = DTran.getDataRowValue(oRow, "CompName", "")
                        .BookDestName = DTran.getDataRowValue(oRow, "BookDestName", "")
                        .BookDestCity = DTran.getDataRowValue(oRow, "BookDestCity", "")
                        .BookDestState = DTran.getDataRowValue(oRow, "BookDestState", "")
                        .BookDestZip = DTran.getDataRowValue(oRow, "BookDestZip", "")
                        .BookODControl = DTran.getDataRowValue(oRow, "BookODControl", 0)
                        .BookLoadCaseQty = DTran.getDataRowValue(oRow, "BookLoadCaseQty", 0)
                        .BookLoadWgt = DTran.getDataRowValue(oRow, "BookLoadWgt", 0)
                        .BookLoadCube = DTran.getDataRowValue(oRow, "BookLoadCube", 0)
                        .BookLoadPL = DTran.getDataRowValue(oRow, "BookLoadPL", 0)
                        .BookLoadPX = DTran.getDataRowValue(oRow, "BookLoadPX", 0)
                        .BookDestAddress1 = DTran.getDataRowValue(oRow, "BookDestAddress1", "")
                        .BookDestAddress2 = DTran.getDataRowValue(oRow, "BookDestAddress2", "")
                        .LaneLatitude = DTran.getDataRowValue(oRow, "LaneLatitude", 0)
                        .LaneLongitude = DTran.getDataRowValue(oRow, "LaneLongitude", 0)
                        .SpecialCodes = DTran.getDataRowValue(oRow, "SpecialCodes", "")
                        .LaneFixedTime = DTran.getDataRowValue(oRow, "LaneFixedTime", "")
                        .BookLoadControl = DTran.getDataRowValue(oRow, "BookLoadControl", 0)
                        .BookHoldLoad = DTran.getDataRowValue(oRow, "BookHoldLoad", 0)
                        .LaneControl = DTran.getDataRowValue(oRow, "LaneControl", 0)
                        .ActualWgt = DTran.getDataRowValue(oRow, "ActualWgt", 0)
                        .LaneNumber = DTran.getDataRowValue(oRow, "LaneNumber", "")
                        .BookCarrOrderNumber = DTran.getDataRowValue(oRow, "BookCarrOrderNumber", "")
                    End With
                    oStopData.Add(oItem)
                Next
            Else
                oStopData.Add(New DTO.vOptimizationStop)
            End If
            Return oStopData.ToArray()
        Catch ex As FaultException
            Throw
        Catch ex As System.Data.SqlClient.SqlException
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
        Catch ex As InvalidOperationException
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
        Catch ex As Exception
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
        Finally
            oQuery = Nothing
        End Try

        Return Nothing
    End Function

    Public Function GetBookRevFees(ByVal BookControl As Integer) As DTO.BookRevFee()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Get the AP Check Entry Book Records
                Dim Fees() As DTO.BookRevFee = ( _
                From d In db.spGetBookFees(BookControl) _
                Select New DTO.BookRevFee With {.FeeName = d.FeeName, .FeeCost = If(d.FeeCost.HasValue, d.FeeCost, 0)}).ToArray()

                Return Fees

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetTotalCost(ByVal BookControl As Integer) As DTO.BookRevTotalCost
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Get the AP Check Entry Book Records
                Dim BookRevTotalCost As DTO.BookRevTotalCost = ( _
                From d In db.udfCalcTotalCost(BookControl) _
                Select New DTO.BookRevTotalCost With {.TotalCost = If(d.TotalCost.HasValue, d.TotalCost, 0), .NetCost = If(d.NetCost.HasValue, d.NetCost, 0), .FreightTax = If(d.FreightTax.HasValue, d.FreightTax, 0)}).First

                Return BookRevTotalCost

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using

    End Function

    Public Function GetBFC(ByVal BookControl As Integer) As Decimal
        Dim decRet As Decimal = 0
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                decRet = db.udfGetBFC(BookControl)

                Return decRet

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return decRet

        End Using

    End Function

    Public Function GetAPExportFileData() As DTO.APExportFileData()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                Dim oAPExportData() As DTO.APExportFileData = ( _
                From d In db.udfGetAPExportRecords() _
                Select New DTO.APExportFileData With {.BookCarrBLNumber = d.BookCarrBLNumber, _
                                                    .BookCarrOrderNumber = d.BookCarrOrderNumber, _
                                                    .BookFinAPActCost = d.BookFinAPActCost, _
                                                    .BookFinAPActTax = d.BookFinAPActTax, _
                                                    .BookFinAPActWgt = d.BookFinAPActWgt, _
                                                    .BookFinAPBillInvDate = d.BookFinAPBillInvDate, _
                                                    .BookFinAPBillNoDate = d.BookFinAPBillNoDate, _
                                                    .BookFinAPBillNumber = d.BookFinAPBillNumber, _
                                                    .BookItemCostCenterNumber = d.BookItemCostCenterNumber, _
                                                    .CarrierNumber = d.CarrierNumber, _
                                                    .LaneNumber = d.LaneNumber}).ToArray

                Return oAPExportData

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

        End Using


        Return Nothing
    End Function

    Public Function GetAPExportCSVData() As String
        Dim strRet As String = ""
        'Get the global parameter GlobalExportAPTaxDetailsToCSV
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim ExportTaxDetails = GetSystemParameterValue("GlobalExportAPTaxDetailsToCSV")
                If ExportTaxDetails = 1 Then
                    Dim oData = db.udfGetAPExportWithTaxDetails()
                    strRet = DTran.CreateCSV(oData)
                Else
                    Dim oData = db.udfGetAPExportRecords()
                    strRet = DTran.CreateCSV(oData)
                End If
                Return strRet
            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

        End Using

        Return strRet
    End Function

    Public Function RecalcOtherCost(ByVal BookControl As Integer) As Decimal
        Dim decRet As Decimal = 0
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                decRet = db.udfRecalcOtherCost(BookControl)

                Return decRet

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using

    End Function

    Public Function GetCarriersByCost(ByVal BookControl As Integer, ByVal LaneControl As Integer, ByVal BookConsPrefix As String) As DTO.CarriersByCost()


        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim oCarriers() As DTO.CarriersByCost = ( _
                From d In db.spEstimatedCarrierCosts(BookControl, 0, "", 0, 0, 0, 0) _
                Order By d.ErrMsg, d.CarrierCost _
                Select New DTO.CarriersByCost With {.CarrierControl = If(d.CarrierControl.HasValue, d.CarrierControl, 0), _
                                                    .CarrierNumber = If(d.CarrierNumber.HasValue, d.CarrierNumber, 0), _
                                                    .CarrierName = d.CarrierName, _
                                                    .CarrierMileRate = If(d.CarrierMileRate.HasValue, d.CarrierMileRate, 0), _
                                                    .CarrierLbsRate = If(d.CarrierLbsRate.HasValue, d.CarrierLbsRate, 0), _
                                                    .CarrierCubeRate = If(d.CarrierCubeRate.HasValue, d.CarrierCubeRate, 0), _
                                                    .CarrierCaseRate = If(d.CarrierCaseRate.HasValue, d.CarrierCaseRate, 0), _
                                                    .CarrierPltRate = If(d.CarrierPltRate.HasValue, d.CarrierPltRate, 0), _
                                                    .CarrierTLCost = If(d.CarrierTLCost.HasValue, d.CarrierTLCost, 0), _
                                                    .CarrierEquipment = d.CarrierEquipment, _
                                                    .CarrierCost = If(d.CarrierCost.HasValue, d.CarrierCost, 0), _
                                                    .CarrierMinCost = If(d.CarrierMinCost.HasValue, d.CarrierMinCost, 0), _
                                                    .CarrierRateExpires = d.CarrierRateExpires, _
                                                    .ErrMsg = d.ErrMsg, _
                                                    .StopCharges = If(d.StopCharges.HasValue, d.StopCharges, 0), _
                                                    .PickCharges = If(d.PickCharges.HasValue, d.PickCharges, 0), _
                                                    .FuelCost = If(d.FuelCost.HasValue, d.FuelCost, 0), _
                                                    .OtherFees = If(d.OtherFees.HasValue, d.OtherFees, 0), _
                                                    .TotalAccessorial = If(d.TotalAccessorial.HasValue, d.TotalAccessorial, 0)}).ToArray

                'Dim oCarriers() As DTO.CarriersByCost = ( _
                'From d In db.udfCarriersByCost(BookControl, LaneControl, BookConsPrefix, Date.Now) _
                'Order By d.ErrMsg, d.CarrierCost _
                'Select New DTO.CarriersByCost With {.CarrierControl = If(d.CarrierControl.HasValue, d.CarrierControl, 0), _
                '                                    .CarrierNumber = If(d.CarrierNumber.HasValue, d.CarrierNumber, 0), _
                '                                    .CarrierName = d.CarrierName, _
                '                                    .CarrierMileRate = If(d.CarrierMileRate.HasValue, d.CarrierMileRate, 0), _
                '                                    .CarrierLbsRate = If(d.CarrierLbsRate.HasValue, d.CarrierLbsRate, 0), _
                '                                    .CarrierCubeRate = If(d.CarrierCubeRate.HasValue, d.CarrierCubeRate, 0), _
                '                                    .CarrierCaseRate = If(d.CarrierCaseRate.HasValue, d.CarrierCaseRate, 0), _
                '                                    .CarrierPltRate = If(d.CarrierPltRate.HasValue, d.CarrierPltRate, 0), _
                '                                    .CarrierTLCost = If(d.CarrierTLCost.HasValue, d.CarrierTLCost, 0), _
                '                                    .CarrierEquipment = d.CarrierEquipment, _
                '                                    .CarrierCost = If(d.CarrierCost.HasValue, d.CarrierCost, 0), _
                '                                    .CarrierMinCost = If(d.CarrierMinCost.HasValue, d.CarrierMinCost, 0), _
                '                                    .CarrierRateExpires = d.CarrierRateExpires, _
                '                                    .ErrMsg = d.ErrMsg}).ToArray



                Return oCarriers

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using

    End Function

    Public Function unHoldFiltered(ByVal Filters As String) As Boolean
        Dim blnRet As Boolean = False
        'Create a data connection 
        Dim oQuery As New NGL.Core.Data.Query(ConnectionString)
        Dim oConsolidation As New List(Of DTO.vConsolidation)

        Try
            Dim strComp As String = ""
            If Not String.IsNullOrEmpty(Filters) AndAlso Filters.Trim.Length > 1 Then
                strComp = " AND "
            End If
            strComp &= "( " _
                & "(isnull((SELECT top 1 isnull(dbo.UserAdmin.UserAdminCompControl,0) FROM dbo.UserAdmin Where dbo.UserAdmin.UserAdminUserName = '" & Me.Parameters.UserName & "'),0) > 0" _
                & "	AND " _
                & " CompNumber In (SELECT dbo.UserAdmin.UserAdminCompControl FROM dbo.UserAdmin	Where dbo.UserAdmin.UserAdminUserName = '" & Me.Parameters.UserName & "')" _
                & ")" _
                & " OR " _
                & " isnull((SELECT top 1 isnull(dbo.UserAdmin.UserAdminCompControl,0) FROM dbo.UserAdmin Where dbo.UserAdmin.UserAdminUserName = '" & Me.Parameters.UserName & "'),0) = 0" _
                & ") "
            Dim strSQL As String = "Update dbo.Book set BookHoldLoad = 0 from dbo.Book inner join dbo.Comp on dbo.Book.BookCustCompControl = dbo.Comp.CompControl inner join dbo.Lane on dbo.Book.BookODControl = dbo.Lane.LaneControl where " & Filters & strComp
            Dim oQRet As NGL.Core.Data.QueryResult = oQuery.Execute(strSQL)
            If Not oQRet.Exception Is Nothing Then
                Utilities.SaveAppError(oQRet.Exception.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_FailedToExecute"}, New FaultReason("E_DataAccessError"))
            End If
            blnRet = True
        Catch ex As FaultException
            Throw
        Catch ex As System.Data.SqlClient.SqlException
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
        Catch ex As InvalidOperationException
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
        Catch ex As Exception
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
        Finally
            oQuery = Nothing
        End Try

        Return blnRet

    End Function

    Public Function GetBookTruckLoadData(ByVal BookConsPrefix As String) As DTO.BookTruckLoadData()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim oTruckData() As DTO.BookTruckLoadData = ( _
                From d In db.udfGetBookTruckLoadData(BookConsPrefix) _
                Select New DTO.BookTruckLoadData With {.BookControl = If(d.BookControl.HasValue, d.BookControl, 0), _
                                                    .BookCustCompControl = If(d.BookCustCompControl.HasValue, d.BookCustCompControl, 0), _
                                                    .BookOrigZip = d.BookOrigZip, _
                                                    .BookDestZip = d.BookDestZip, _
                                                    .BookOrigAddress1 = d.BookOrigAddress1, _
                                                    .BookDestAddress1 = d.BookDestAddress1, _
                                                    .BookOrigCity = d.BookOrigCity, _
                                                    .BookDestCity = d.BookDestCity, _
                                                    .BookOrigState = d.BookOrigState, _
                                                    .BookDestState = d.BookDestState, _
                                                    .BookLoadControl = If(d.BookLoadControl.HasValue, d.BookLoadControl, 0), _
                                                    .BookODControl = If(d.BookODControl.HasValue, d.BookODControl, 0), _
                                                    .BookProNumber = d.BookProNumber, _
                                                    .LaneOriginAddressUse = If(d.LaneOriginAddressUse.HasValue, d.LaneOriginAddressUse, False), _
                                                    .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0), _
                                                    .BookConsPrefix = d.BookConsPrefix}).ToArray

                Return oTruckData

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetCriticalALL() As DTO.CriticalALL()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Get All Critical Loads
                Dim Critical() As DTO.CriticalALL = ( _
                From d In db.spCriticalAll50(Me.Parameters.UserName) _
                Select New DTO.CriticalALL With {.CarrierControl = d.CarrierControl, _
                                                 .CarrierNumber = If(d.CarrierNumber.HasValue, d.CarrierNumber, 0), _
                                                 .CarrierName = d.CarrierName, _
                                                 .Critical = If(d.Critical.HasValue, d.Critical, 0), _
                                                 .Load_Count = If(d.Load_Count.HasValue, d.Load_Count, 0)}).ToArray()

                Return Critical

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetOrigDestCost(ByVal OrigState As String, ByVal DestState As String, ByVal FromComp As Integer, ByVal ToComp As Integer) As DTO.OrigDestCost()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Get the data
                Dim oList() As DTO.OrigDestCost = ( _
                From d In db.spOrigDestCost50(OrigState, DestState, FromComp, ToComp, Me.Parameters.UserName) _
                Select New DTO.OrigDestCost With {.CarrierNumber = d.CarrierNumber, _
                                                  .CompName = d.CompName, _
                                                  .BookOrigCity = d.BookOrigCity, _
                                                  .BookOrigState = d.BookOrigState, _
                                                  .BookDestCity = d.BookDestCity, _
                                                  .BookDestState = d.BookDestState, _
                                                  .BookDateLoad = d.BookDateLoad, _
                                                  .BookTotalWgt = d.BookTotalWgt, _
                                                  .BookTotalBFC = d.BookTotalBFC, _
                                                  .CarrierName = d.CarrierName, _
                                                  .BookProNumber = d.BookProNumber, _
                                                  .BookControl = d.BookControl, _
                                                  .CompNumber = d.CompNumber}).ToArray()

                Return oList

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetGetBookControlsWithSameCNS(ByVal CNS As String, ByVal bookControl As Integer) As DTO.vBookControl()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Get the data
                Dim oList As DTO.vBookControl() = ( _
                From d In db.spGetBookControlsWithSameCNS(CNS, bookControl) _
                 Select New DTO.vBookControl With {.BookControl = d.BookControl}).ToArray()

                Return oList

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetGetBookControlsWithSameStopNo(ByVal CNS As String, ByVal StopNumber As String, ByVal bookControl As Integer) As DTO.vBookControl()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim stpNumber As Integer = 0
                If Integer.TryParse(StopNumber, stpNumber) Then

                    'Get the data
                    Dim oList As DTO.vBookControl() = ( _
                    From d In db.spGetBookControlsWithSameStopNo(CNS, stpNumber, bookControl) _
                     Select New DTO.vBookControl With {.BookControl = d.BookControl}).ToArray()

                    Return oList
                End If

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    '  Public Function GetAllItems(ByVal proNumber As String, _
    ' ByVal CNS As String, _
    ' ByVal PO As String, _
    ' ByVal OrderNumber As String, _
    ' ByVal LoadDate As Nullable(Of DateTime), _
    '  ByVal LoadDateTo As Nullable(Of DateTime), _
    '  ByVal SCHEDULEDATE As Nullable(Of DateTime), _
    ' ByVal SCHEDULEDATETo As Nullable(Of DateTime), _
    'ByVal LOADDelScheduleDate As Nullable(Of DateTime), _
    'ByVal LOADDelScheduleDateTo As Nullable(Of DateTime), _
    '  ByVal LOADDelScheduleTime As String, _
    'ByVal LOADActDelDate As Nullable(Of DateTime), _
    ' ByVal LOADActDelDateTo As Nullable(Of DateTime), _
    '  ByVal LOADCARRIERNAME As String, _
    '  ByVal LOADCARRIERNUMBER As Nullable(Of Integer), _
    'ByVal LOADDESTNAME As String, _
    '  ByVal LOADDESTCITY As String, _
    '  ByVal LOADDESTSTATE As String, _
    ' ByVal LOADBROKERNUMBER As String, _
    ' ByVal LOADCARRIERCONTCONTROL As Nullable(Of Integer), _
    ' ByVal UseCarrierFilters As Nullable(Of Boolean), _
    ' ByVal DaysOut As Nullable(Of Integer), _
    ' ByVal DelDaysOut As Nullable(Of Integer), _
    '   ByVal xmlTransCode As String, _
    '     ByVal xmlLoadCompanyIDs As String, _
    '     ByVal xmlLoadLanes As String, _
    '      ByVal p_sortordinal As String, _
    '     ByVal p_sortdirection As String, _
    '    ByVal p_datefilterfield As String, _
    '    ByVal p_datefilterfrom As Nullable(Of DateTime), _
    '    ByVal p_datefilterto As Nullable(Of DateTime), _
    '    Optional ByVal page As Integer = 1, _
    '    Optional ByVal pagesize As Integer = 1000) As DTO.AllItem()
    '      Using db As New NGLMasBookDataContext(ConnectionString)

    '          Try



    '              Dim xmlXmlTransCode As XElement = If(String.IsNullOrEmpty(xmlTransCode), Nothing, XElement.Parse(xmlTransCode))
    '              Dim xmlXmlLoadCompanyIDs As XElement = If(String.IsNullOrEmpty(xmlLoadCompanyIDs), Nothing, XElement.Parse(xmlLoadCompanyIDs))
    '              Dim xmlXmlLoadLanes As XElement = If(String.IsNullOrEmpty(xmlLoadLanes), Nothing, XElement.Parse(xmlLoadLanes))

    '              'Get the data
    '              Dim oList1 = ( _
    '              From d In db.spNGLLOAD_SORTED(proNumber, _
    '  CNS, _
    '  PO, _
    '  OrderNumber, _
    '  LoadDate, _
    '   LoadDateTo, _
    '   SCHEDULEDATE, _
    '  SCHEDULEDATETo, _
    ' LOADDelScheduleDate, _
    ' LOADDelScheduleDateTo, _
    '   LOADDelScheduleTime, _
    ' LOADActDelDate, _
    '  LOADActDelDateTo, _
    '   LOADCARRIERNAME, _
    '   LOADCARRIERNUMBER, _
    ' LOADDESTNAME, _
    '   LOADDESTCITY, _
    '   LOADDESTSTATE, _
    '  LOADBROKERNUMBER, _
    '  LOADCARRIERCONTCONTROL, _
    '  UseCarrierFilters, _
    '  DaysOut, _
    '  DelDaysOut, _
    '  xmlXmlTransCode, _
    '    xmlXmlLoadCompanyIDs, _
    '     xmlXmlLoadLanes, _
    '       p_sortordinal, _
    '      p_sortdirection, _
    '     p_datefilterfield, _
    '     p_datefilterfrom, _
    '     p_datefilterto)).ToList()


    '              Dim intRecordCount As Integer = 0
    '              Dim intPageCount As Integer = 1
    '              'count the record

    '              Try
    '                  intRecordCount = oList1.Count

    '              Catch ex As Exception
    '                  'ignore any record count errors
    '              End Try
    '              If pagesize < 1 Then pagesize = 1
    '              If intRecordCount < 1 Then intRecordCount = 1
    '              If page < 1 Then page = 1
    '              If intRecordCount > pagesize Then intPageCount = ((intRecordCount - 1) \ pagesize) + 1
    '              Dim intSkip As Integer = (page - 1) * pagesize

    '              'Get the page data
    '              Dim oList() As DTO.AllItem = (From d In oList1 _
    '                                                Select New DTO.AllItem With {.Control = d.LOADBookControl, _
    '                                               .ProNumber = d.LOADProNumber, _
    '                                               .CnsNumber = d.LOADCONSPREFIX, _
    '                                               .StopNumber = d.LOADStopNo, _
    '                                              .BookPickupStopNumber = d.BookPickupStopNumber, _
    '                                               .PurchaseOrderNumber = d.LOADPO, _
    '                                              .OrderNumber = d.LOADOrderNumber, _
    '                                                  .ScheduledToLoad = d.LOADDATE, _
    '                                           .RequestedToArrive = d.SCHEDULEDATE, _
    '                                           .AssignedCarrier = d.LOADCarrierName, _
    '                                           .DestinationName = d.LOADDestName, _
    '                                           .DestinationCity = d.LOADDestCity, _
    '                                           .DestinationState = d.LOADDestState, _
    '                                           .CarrierData = New DTO.BookCarrier With {.BookCarrScheduleDate = d.LOADToLoadDate, _
    '                                                                                    .BookCarrScheduleTime = d.LOADScheduleTime, _
    '                                                                                    .BookCarrActualDate = d.LOADActPickupDate, _
    '                                                                                    .BookCarrActualTime = d.LOADActPickupTime, _
    '                                                                                    .BookCarrStartLoadingDate = d.LOADStartLoadingDate, _
    '                                                                                    .BookCarrStartLoadingTime = d.LOADStartLoadingTime, _
    '                                                                                    .BookCarrFinishLoadingDate = d.LOADFinishLoadingDate, _
    '                                                                                    .BookCarrFinishLoadingTime = d.LOADFinishLoadingTime, _
    '                                                                                    .BookCarrActLoadComplete_Date = d.LOADActLoadComplete_Date, _
    '                                                                                    .BookCarrActLoadCompleteTime = d.LOADActLoadCompleteTime, _
    '                                                                                    .BookCarrDockPUAssigment = d.LOADDockPUAssigment, _
    '                                                                                    .BookCarrApptDate = d.LOADDelScheduleDate, _
    '                                                                                    .BookCarrApptTime = d.LOADDelScheduleTime, _
    '                                                                                    .BookCarrActDate = d.LOADActDelDate, _
    '                                                                                    .BookCarrActTime = d.LOADActDelTime, _
    '                                                                                    .BookCarrStartUnloadingDate = d.LOADDelStartUnloadingDate, _
    '                                                                                    .BookCarrStartUnloadingTime = d.LOADDelStartUnloadingTime, _
    '                                                                                    .BookCarrFinishUnloadingDate = d.LOADDelFinishUnloadingDate, _
    '                                                                                    .BookCarrFinishUnloadingTime = d.LOADDelFinishUnloadingTime, _
    '                                                                                    .BookCarrActUnloadCompDate = d.LOADActLoadCompDate, _
    '                                                                                    .BookCarrActUnloadCompTime = d.LOADActLoadCompTime, _
    '                                                                                    .BookCarrDockDelAssignment = d.LOADDelDock, _
    '                                                                                    .BookCarrTrailerNo = d.LOADTrailerNo, _
    '                                                                                    .BookCarrSealNo = d.LOADSealNo, _
    '                                                                                    .BookCarrDriverNo = d.LOADDriverNo, _
    '                                                                                    .BookCarrDriverName = d.LOADDriverName, _
    '                                                                                    .BookCarrTripNo = d.LOADTripNo, _
    '                                                                                    .BookCarrRouteNo = d.LOADRouteNo, _
    '                                                                                    .BookWhseAuthorizationNo = d.LOADWhseAuthorizationNo}, _
    '                                           .Comments = d.Comments, _
    '                                           .BookNotes1 = d.BookNotesVisable1, _
    '                                           .BookNotes2 = d.BookNotesVisable2, _
    '                                           .BookNotes3 = d.BookNotesVisable3, _
    '                                           .AssignedProNumber = d.BookShipCarrierProNumber, _
    '                                           .AssignedCarrierName = d.BookShipCarrierName, _
    '                                           .AssignedCarrierNumber = d.BookShipCarrierNumber, _
    '                                           .AssignedCarrierContact = d.BookCarrierContact, _
    '                                           .AssignedCarrierContactPhone = d.BookCarrierContactPhone, _
    '                                           .Page = page, _
    '                                           .Pages = intPageCount}).Skip(intSkip).Take(pagesize).ToArray()

    '              Return oList

    '          Catch ex As System.Data.SqlClient.SqlException
    '              Utilities.SaveAppError(ex.Message, Me.Parameters)
    '              Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
    '          Catch ex As InvalidOperationException
    '              Utilities.SaveAppError(ex.Message, Me.Parameters)
    '              Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
    '          Catch ex As Exception
    '              Utilities.SaveAppError(ex.Message, Me.Parameters)
    '              Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
    '          End Try

    '          Return Nothing

    '      End Using
    '  End Function

    Public Function GetBooksPendingAcceptanceByCont(ByVal CarrierContControl As Integer, _
                                                    ByVal sortOrdinal As String, _
                                                    ByVal sortDirection As String, _
                                                    ByVal datefilterfield As String, _
                                                    ByVal dateFilterFrom As System.Nullable(Of Date), _
                                                    ByVal dateFilterTo As System.Nullable(Of Date)) As DTO.TenderedItem()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Get the data
                Dim oList() As DTO.TenderedItem = ( _
                From d In db.spBookRecordsPendingAcceptanceContControl_SORTED(CarrierContControl, sortOrdinal, sortDirection, datefilterfield, dateFilterFrom, dateFilterTo) _
                Select New DTO.TenderedItem With {.Control = d.BookControl, _
                                                 .ProNumber = d.BookProNumber, _
                                                 .CnsNumber = d.BookConsPrefix, _
                                                     .CnsIntegrity = d.BookRouteConsFlag, _
                                                 .OrderNumber = d.BookCarrOrderNumber, _
                                                .PickupName = d.BookOrigName, _
                                                 .PickupAddress = d.BookOrigAddress1, _
                                                .PickupCity = d.BookOrigCity, _
                                                    .PickupState = d.BookOrigState, _
                                                  .PickupZipCode = d.BookOrigZip, _
                                                   .DestinationName = d.BookDestName, _
                                                   .DestinationAddress = d.BookDestAddress1, _
                                                  .DestinationCity = d.BookDestCity, _
                                                  .DestinationState = d.BookDestState, _
                                                   .DestinationZipCode = d.BookDestZip, _
                                                    .Cases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0), _
                                                      .Weight = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0), _
                                                  .Pallets = If(d.BookTotalPl.HasValue, d.BookTotalPl, 0), _
                                                  .Cubes = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0), _
                                                  .PickupDate = d.BookDateLoad, _
                                                  .DeliveryDate = d.BookDateRequired, _
                                                   .ContractCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0), _
                                                  .AssignedDate = d.BookTrackDate}).ToArray()

                Return oList

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBooksRecordsPendingAcceptance(ByVal CarrierControl As Integer, _
                                                 ByVal sortOrdinal As String, _
                                                 ByVal sortDirection As String, _
                                                 ByVal datefilterfield As String, _
                                                 ByVal dateFilterFrom As System.Nullable(Of Date), _
                                                 ByVal dateFilterTo As System.Nullable(Of Date)) As DTO.TenderedItem()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Get the data
                Dim oList() As DTO.TenderedItem = ( _
                From d In db.BookRecordsPendingAcceptance_SORTED(CarrierControl, sortOrdinal, sortDirection, datefilterfield, dateFilterFrom, dateFilterTo) _
                Select New DTO.TenderedItem With {.Control = d.BookControl, _
                                                 .ProNumber = d.BookProNumber, _
                                                 .CnsNumber = d.BookConsPrefix, _
                                                  .CnsIntegrity = d.BookRouteConsFlag, _
                                                 .OrderNumber = d.BookCarrOrderNumber, _
                                                .PickupName = d.BookOrigName, _
                                                 .PickupAddress = d.BookOrigAddress1, _
                                                .PickupCity = d.BookOrigCity, _
                                                    .PickupState = d.BookOrigState, _
                                                  .PickupZipCode = d.BookOrigZip, _
                                                   .DestinationName = d.BookDestName, _
                                                   .DestinationAddress = d.BookDestAddress1, _
                                                  .DestinationCity = d.BookDestCity, _
                                                  .DestinationState = d.BookDestState, _
                                                   .DestinationZipCode = d.BookDestZip, _
                                                    .Cases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0), _
                                                      .Weight = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0), _
                                                  .Pallets = If(d.BookTotalPl.HasValue, d.BookTotalPl, 0), _
                                                  .Cubes = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0), _
                                                  .PickupDate = d.BookDateLoad, _
                                                  .DeliveryDate = d.BookDateRequired, _
                                                   .ContractCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0), _
                                                  .AssignedDate = d.BookTrackDate}).ToArray()

                Return oList

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetWebBillPayRecords(ByVal CarrierControl As System.Nullable(Of Integer), _
                                         ByVal CarrierContControl As System.Nullable(Of Integer), _
                                         ByVal proNumber As String, _
                                          ByVal cns As String, _
                                            ByVal bookCarrOrderNumber As String, _
                                              ByVal bookDateDelDate As System.Nullable(Of Date), _
                                                ByVal bookDateDelDateTo As System.Nullable(Of Date), _
                                                 ByVal bookPayCode As String, _
                                                    ByVal bookRevTotalCost As System.Nullable(Of Decimal), _
                                                     ByVal bookFinAPBillNumber As String, _
                                                     ByVal bookFinAPActCost As System.Nullable(Of Decimal), _
                                                 ByVal sortOrdinal As String, _
                                                 ByVal sortDirection As String, _
                                                 ByVal datefilterfield As String, _
                                                 ByVal dateFilterFrom As System.Nullable(Of Date), _
                                                 ByVal dateFilterTo As System.Nullable(Of Date)) As DTO.SettlementItem()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Get the data
                Dim oList() As DTO.SettlementItem = ( _
                From d In db.spGetWebBillPayRecords_SORTED(CarrierControl, CarrierContControl, proNumber, cns, bookCarrOrderNumber, bookDateDelDate, _
                                                          bookDateDelDateTo, bookPayCode, bookRevTotalCost, bookFinAPBillNumber, bookFinAPActCost, sortOrdinal, sortDirection, datefilterfield, dateFilterFrom, dateFilterTo) _
                Select New DTO.SettlementItem With {.Control = If(d.BookControl.HasValue, d.BookControl, 0), _
                                                 .ProNumber = d.BookProNumber, _
                                                 .CnsNumber = d.BookConsPrefix, _
                                                 .OrderNumber = d.BookCarrOrderNumber, _
                                                .PickupName = d.BookOrigName, _
                                                      .DestinationName = d.BookDestName, _
                                                 .Status = d.BookPayCode, _
                                                .DeliveredDate = d.BookDateDelivered, _
                                                    .ContractedCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0), _
                                                  .InvoiceNumber = d.BookFinAPBillNumber, _
                                                   .InvoiceAmount = If(d.BookFinAPActCost.HasValue, d.BookFinAPActCost, 0)}).ToArray()

                Return oList

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function


    Public Function GetWebSettledRecords(ByVal CarrierControl As System.Nullable(Of Integer), _
                                         ByVal CarrierContControl As System.Nullable(Of Integer), _
                                         ByVal proNumber As String, _
                                          ByVal cns As String, _
                                              ByVal bookFinAPPayDate As System.Nullable(Of Date), _
                                                ByVal bookFinAPPayAmt As System.Nullable(Of Decimal), _
                                                 ByVal bookFinAPPayCheck As String, _
                                                 ByVal bookRevTotalCost As System.Nullable(Of Decimal), _
                                                    ByVal bookFinAPBillNumber As String, _
                                                    ByVal bookFinAPActCost As System.Nullable(Of Decimal), _
                                                 ByVal sortOrdinal As String, _
                                                 ByVal sortDirection As String, _
                                                 ByVal datefilterfield As String, _
                                                 ByVal dateFilterFrom As System.Nullable(Of Date), _
                                                 ByVal dateFilterTo As System.Nullable(Of Date)) As DTO.SettledItem()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Get the data
                Dim oList() As DTO.SettledItem = ( _
                From d In db.spGetWebSettledRecords_SORTED(CarrierControl, _
                                                           CarrierContControl, _
                                                           proNumber, _
                                                           cns, _
                                                           bookFinAPPayDate, _
                                                           bookFinAPPayAmt, _
                                                           bookFinAPPayCheck, _
                                                           bookRevTotalCost, _
                                                           bookFinAPBillNumber, _
                                                           bookFinAPActCost, _
                                                          sortOrdinal, _
                                                          sortDirection, _
                                                          datefilterfield, _
                                                          dateFilterFrom, _
                                                          dateFilterTo) _
                Select New DTO.SettledItem With {.Control = If(d.BookControl.HasValue, d.BookControl, 0), _
                                                 .ProNumber = d.BookProNumber, _
                                                 .CnsNumber = d.BookConsPrefix, _
                                                 .InvoiceNumber = d.BookFinAPBillNumber, _
                                                .ContractedCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0), _
                                                      .PaidCost = If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0), _
                                                 .InvoiceAmount = If(d.BookFinAPActCost.HasValue, d.BookFinAPActCost, 0), _
                                                .PaidDate = d.BookFinAPPayDate, _
                                                    .CheckNumber = d.BookFinAPCheck}).ToArray()

                Return oList

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function


    Public Function GetBookTrackComments(ByVal bookControl As Integer) As DTO.vBookTrackXQ()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Get the data
                Dim oList() As DTO.vBookTrackXQ = ( _
                From d In db.spGetBookTrackComments(bookControl) _
                Select New DTO.vBookTrackXQ With {.BookTrackBookControl = If(d.BookTrackBookControl.HasValue, d.BookTrackBookControl, 0), _
                                                 .BookTrackComment = d.BookTrackComment, _
                                                 .BookTrackContact = d.BookTrackContact, _
                                                 .BookTrackControl = If(d.BookTrackControl.HasValue, d.BookTrackControl, 0), _
                                                .BookTrackDate = d.TrackDate, _
                                                 .BookTrackModDate = d.BookTrackModDate, _
                                                .BookTrackModUser = d.BookTrackModUser, _
                                                    .BookTrackStatus = If(d.BookTrackStatus.HasValue, d.BookTrackStatus, 0)}).ToArray()

                Return oList

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBookLoadDetailReport(ByVal proNumber As String) As DTO.BookLoadDetailReport()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Get the data
                Dim oList() As DTO.BookLoadDetailReport = ( _
                From d In db.spGetLoadDetailReport(proNumber) _
                Select New DTO.BookLoadDetailReport With {.BookCarrActDate = d.BookCarrActDate, _
                                                          .BookCarrActTime = d.BookCarrActTime, _
                                                        .BookCarrActualDate = d.BookCarrActualDate, _
                                                          .BookCarrActualTime = d.BookCarrActualTime, _
                                                          .BookCarrApptDate = d.BookCarrApptDate, _
                                                           .BookCarrApptTime = d.BookCarrApptTime, _
                                                          .BookCarrOrderNumber = d.BookCarrOrderNumber, _
                                                          .BookCarrScheduleDate = d.BookCarrScheduleDate, _
                                                           .BookCarrScheduleTime = d.BookCarrScheduleTime, _
                                                          .BookConsPrefix = d.BookConsPrefix, _
                                                          .BookControl = d.BookControl, _
                                                          .BookDateRequired = d.BookDateRequired, _
                                                          .BookDestAddress1 = d.BookDestAddress1, _
                                                          .BookDestCity = d.BookDestCity, _
                                                          .BookDestCountry = d.BookDestCountry, _
                                                          .BookDestName = d.BookDestName, _
                                                          .BookDestState = d.BookDestState, _
                                                          .BookDestZip = d.BookDestZip, _
                                                          .BookLoadPONumber = d.BookLoadPONumber, _
                                                          .BookOrigAddress1 = d.BookOrigAddress1, _
                                                          .BookOrigCity = d.BookOrigCity, _
                                                          .BookOrigCountry = d.BookOrigCountry, _
                                                          .BookOrigName = d.BookOrigName, _
                                                          .BookOrigState = d.BookOrigState, _
                                                          .BookOrigZip = d.BookOrigZip, _
                                                          .BookProNumber = d.BookProNumber, _
                                                          .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0), _
                                                          .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0), _
                                                          .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0), _
                                                          .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0), _
                                                          .CarrierName = d.CarrierName}).ToArray()

                Return oList

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function


    Public Function GetAllItemsLite(ByVal CompanyIDsDelimitedByComma As String) As DTO.AllItemLite()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                Dim xmlXmlLoadCompanyIDs As XElement = If(String.IsNullOrEmpty(CompanyIDsDelimitedByComma), Nothing, XElement.Parse(CompanyIDsDelimitedByComma))
                'Get the data
                Dim oList() As DTO.AllItemLite = ( _
                From d In db.spGetNGLLoadSortedLite(xmlXmlLoadCompanyIDs) _
                Select New DTO.AllItemLite With {.CarrierControl = d.CarrierControl, _
                                                 .CarrierName = d.CarrierName, _
                                                          .CarrierNumber = If(d.CarrierNumber.HasValue, d.CarrierNumber, 0)}).ToArray()

                Return oList

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetCarriersSchedDateLite(ByVal CompanyIDsDelimitedByComma As String, ByVal CarrierControl As Integer) As DTO.AllItemLite()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                Dim xmlXmlLoadCompanyIDs As XElement = If(String.IsNullOrEmpty(CompanyIDsDelimitedByComma), Nothing, XElement.Parse(CompanyIDsDelimitedByComma))
                'Get the data
                Dim oList() As DTO.AllItemLite = ( _
                From d In db.spGetNGLSchedCarriersByDateLite(xmlXmlLoadCompanyIDs, CarrierControl) _
                Select New DTO.AllItemLite With {.ScheduledToLoad = d.BookCarrApptDate, _
                                                 .PickupScheduledAppointmentDate = d.BookCarrScheduleDate}).ToArray()

                Return oList

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function


    Public Function GetLoadsByDateLite(ByVal CompanyIDsDelimitedByComma As String, ByVal CarrierControl As Integer, ByVal apptDate As DateTime?) As DTO.AllItemLite()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                Dim xmlXmlLoadCompanyIDs As XElement = If(String.IsNullOrEmpty(CompanyIDsDelimitedByComma), Nothing, XElement.Parse(CompanyIDsDelimitedByComma))
                'Get the data
                Dim oList() As DTO.AllItemLite = ( _
                From d In db.spGetNGLLoadsByDateLite(xmlXmlLoadCompanyIDs, CarrierControl, apptDate) _
                Select New DTO.AllItemLite With {.PickupScheduledAppointmentDate = If(d.BookCarrApptDate.HasValue, d.BookCarrApptDate, Nothing), _
                                                 .PickupDockPUAssignment = d.BookCarrDockPUAssigment,
                                                 .PickupFinishLoadingDate = If(d.BookCarrFinishLoadingDate.HasValue, d.BookCarrFinishLoadingDate, Nothing),
                                                 .PickupFinishLoadingTime = If(d.BookCarrFinishLoadingTime.HasValue, d.BookCarrFinishLoadingTime, Nothing),
                                                 .DeliveryFinishUnloadingDate = If(d.BookCarrFinishUnloadingDate.HasValue, d.BookCarrFinishUnloadingDate, Nothing),
                                                 .DeliveryFinishUnloadingTime = If(d.BookCarrFinishUnloadingTime.HasValue, d.BookCarrFinishUnloadingTime, Nothing),
                                                 .OrderNumber = d.BookCarrOrderNumber,
                                                 .ScheduledToLoad = If(d.BookCarrScheduleDate.HasValue, d.BookCarrScheduleDate, Nothing),
                                                 .PickupStartLoadingDate = If(d.BookCarrStartLoadingDate.HasValue, d.BookCarrStartLoadingDate, Nothing),
                                                 .PickupStartLoadingTime = If(d.BookCarrStartLoadingTime.HasValue, d.BookCarrStartLoadingTime, Nothing),
                                                 .DeliveryStartUnloadingDate = If(d.BookCarrStartUnloadingDate.HasValue, d.BookCarrStartUnloadingDate, Nothing),
                                                 .DeliveryStartUnloadingTime = If(d.BookCarrStartUnloadingTime.HasValue, d.BookCarrStartUnloadingTime, Nothing),
                                                 .CnsNumber = d.BookConsPrefix,
                                                 .Control = d.BookControl,
                                                 .DestinationName = d.BookDestName,
                                                 .DestinationCity = d.BookDestCity,
                                                 .DestinationState = d.BookDestState,
                                                 .OrigName = d.BookOrigName,
                                                 .OrigState = d.BookOrigState,
                                                 .OrigCity = d.BookOrigCity,
                                                 .ProNumber = d.BookProNumber,
                                                 .WhseAuthorizationNumber = d.BookWhseAuthorizationNo,
                                                 .CarrierName = d.CarrierName}).ToArray()

                Return oList

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function


    Public Function GetBookProNumber(ByVal proNumber As String, ByVal CompanyIDs As DTO.IDs()) As String
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim arr As List(Of String) = New List(Of String)()
                For Each item In CompanyIDs
                    arr.Add(item.Control.ToString)
                Next

                Dim pro1 As String = ""
                If arr.Count = 0 Then
                    pro1 = (From d In db.Books Where (d.BookProNumber = proNumber Or d.BookCarrOrderNumber = proNumber) Select d).First.BookProNumber
                Else
                    pro1 = (From d In db.Books Where (d.BookProNumber = proNumber Or d.BookCarrOrderNumber = proNumber) And arr.Contains(d.BookCustCompControl.ToString) Select d).First.BookProNumber
                End If

                'Dim pro = ( _
                'From d In db.spGetBookProNumber(proNumber, CompanyIDs) Select d)

                Return pro1

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function RecalculateFreightCosts(ByVal BookControl As Integer) As DTO.Book
        Dim strProcName As String = "dbo.spRecalculateFreightCosts"
        Dim oCmd As New System.Data.SqlClient.SqlCommand
        oCmd.Parameters.AddWithValue("@BookControl", BookControl)
        oCmd.Parameters.AddWithValue("@UserName", Left(Me.Parameters.UserName, 100))
        runNGLStoredProcedure(oCmd, strProcName, 0)
        Return GetBookFiltered(BookControl)
    End Function

    ''' <summary>
    ''' Used to re calculate costs
    ''' </summary>
    ''' <param name="BookControl"></param>
    ''' <param name="AllocateBFC"></param>
    ''' <param name="UpdateBFC"></param>
    ''' <returns></returns>
    ''' <remarks>
    ''' NOTE: Modified 3/29/11 by RHR we now call spCalcBookRev50 so that all calculations are the same
    ''' the AllocateBFC and UpdateBFC are no longer required and are always true
    ''' </remarks>
    Public Function CalcRevenue(ByVal BookControl As Integer, Optional ByVal AllocateBFC As Boolean = True, Optional ByVal UpdateBFC As Boolean = True) As DTO.Book
        'Dim strProcName As String = "dbo.spCalcRevenue"
        Dim strProcName As String = "dbo.spCalcBookRev50"
        Dim oCmd As New System.Data.SqlClient.SqlCommand
        oCmd.Parameters.AddWithValue("@BookControl", BookControl)
        'oCmd.Parameters.AddWithValue("@AllocateBFC ", AllocateBFC)
        'oCmd.Parameters.AddWithValue("@UpdateBFC ", UpdateBFC)
        oCmd.Parameters.AddWithValue("@UserName", Left(Me.Parameters.UserName, 100))
        runNGLStoredProcedure(oCmd, strProcName, 0)
        Return GetBookFiltered(BookControl)
    End Function

    Public Function SendInvoiceViaEmailReturnShouldPrint(ByVal compVlookup As DTO.vLookupList) As Boolean
        'Me.UpdateRecordWithDetailsNoReturn(oData)
        'Dim strProcName As String = "dbo.spCalcRevenue"
        'Dim oCmd As New System.Data.SqlClient.SqlCommand
        'oCmd.Parameters.AddWithValue("@BookControl", oData.BookControl)
        'oCmd.Parameters.AddWithValue("@AllocateBFC ", AllocateBFC)
        'oCmd.Parameters.AddWithValue("@UpdateBFC ", UpdateBFC)
        'oCmd.Parameters.AddWithValue("@UserName", Left(Me.Parameters.UserName, 100))
        'runNGLStoredProcedure(oCmd, strProcName, 0)
        'Return GetBookFiltered(oData.BookControl)
    End Function

    Public Function SaveAndCalcRevenue(ByVal oData As DTO.Book, ByVal AllocateBFC As Boolean, ByVal UpdateBFC As Boolean) As DTO.Book
        Me.UpdateRecordWithDetailsNoReturn(oData)
        Dim strProcName As String = "dbo.spCalcRevenue"
        Dim oCmd As New System.Data.SqlClient.SqlCommand
        oCmd.Parameters.AddWithValue("@BookControl", oData.BookControl)
        oCmd.Parameters.AddWithValue("@AllocateBFC ", AllocateBFC)
        oCmd.Parameters.AddWithValue("@UpdateBFC ", UpdateBFC)
        oCmd.Parameters.AddWithValue("@UserName", Left(Me.Parameters.UserName, 100))
        runNGLStoredProcedure(oCmd, strProcName, 0)
        Return GetBookFiltered(oData.BookControl)
    End Function

    Public Sub ClearCarrierCons(ByVal BookControl As Integer, ByVal ClearCNS As Boolean)

        Dim strProcName As String = "dbo.spClearCarrierCons"
        Dim oCmd As New System.Data.SqlClient.SqlCommand
        oCmd.Parameters.AddWithValue("@BookControl", BookControl)
        oCmd.Parameters.AddWithValue("@ClearCNS", ClearCNS)
        runNGLStoredProcedure(oCmd, strProcName, 0)

    End Sub

    Public Sub UpdateTruckStopData(ByVal StopName As String, _
                                   ByVal ID1 As String, _
                                   ByVal ID2 As String, _
                                   ByVal TruckID As String, _
                                   ByVal SeqNbr As Integer, _
                                   ByVal DistToPrev As Double, _
                                   ByVal TotalRouteCost As Double, _
                                   ByVal ConsNumber As String)

        Dim strProcName As String = "dbo.spUpdateTruckStopData50"
        Dim oCmd As New System.Data.SqlClient.SqlCommand
        oCmd.Parameters.AddWithValue("@StopName", Left(StopName, 20))
        oCmd.Parameters.AddWithValue("@ID1", Left(ID1, 15))
        oCmd.Parameters.AddWithValue("@ID2", Left(ID2, 10))
        oCmd.Parameters.AddWithValue("@TruckID", Left(TruckID, 25))
        oCmd.Parameters.AddWithValue("@SeqNbr", SeqNbr)
        oCmd.Parameters.AddWithValue("@DistToPrev", DistToPrev)
        oCmd.Parameters.AddWithValue("@TotalRouteCost", TotalRouteCost)
        oCmd.Parameters.AddWithValue("@ConsNumber", Left(ConsNumber, 20))
        oCmd.Parameters.AddWithValue("@UserName", Left(Me.Parameters.UserName, 100))
        runNGLStoredProcedure(oCmd, strProcName, 0)

    End Sub

    Public Sub UpdateOptimizedStopData(ByVal BookLoadControl As Integer, _
                                   ByVal SeqNbr As Integer, _
                                   ByVal DistToPrev As Double, _
                                   ByVal ConsNumber As String)

        Dim strProcName As String = "dbo.spUpdateOptimizedStopData50"
        Dim oCmd As New System.Data.SqlClient.SqlCommand
        oCmd.Parameters.AddWithValue("@BookLoadControl", BookLoadControl)
        oCmd.Parameters.AddWithValue("@SeqNbr", SeqNbr)
        oCmd.Parameters.AddWithValue("@DistToPrev", DistToPrev)
        oCmd.Parameters.AddWithValue("@ConsNumber", Left(ConsNumber, 20))
        oCmd.Parameters.AddWithValue("@UserName", Left(Me.Parameters.UserName, 100))
        runNGLStoredProcedure(oCmd, strProcName, 0)

    End Sub

    Public Sub AssignTruckStopCarrier(ByVal StopName As String, _
                                   ByVal ID1 As String, _
                                   ByVal ID2 As String, _
                                   ByVal TruckID As String, _
                                   ByVal SeqNbr As Integer, _
                                   ByVal DistToPrev As Double, _
                                   ByVal TotalRouteCost As Double, _
                                   ByVal ConsNumber As String)


        Dim strProcName As String = "dbo.spAssignTruckStopCarrier50"
        Dim oCmd As New System.Data.SqlClient.SqlCommand
        oCmd.Parameters.AddWithValue("@StopName", Left(StopName, 20))
        oCmd.Parameters.AddWithValue("@ID1", Left(ID1, 15))
        oCmd.Parameters.AddWithValue("@ID2", Left(ID2, 10))
        oCmd.Parameters.AddWithValue("@TruckID", Left(TruckID, 25))
        oCmd.Parameters.AddWithValue("@SeqNbr", SeqNbr)
        oCmd.Parameters.AddWithValue("@DistToPrev", DistToPrev)
        oCmd.Parameters.AddWithValue("@TotalRouteCost", TotalRouteCost)
        oCmd.Parameters.AddWithValue("@ConsNumber", Left(ConsNumber, 20))
        oCmd.Parameters.AddWithValue("@UserName", Left(Me.Parameters.UserName, 100))
        runNGLStoredProcedure(oCmd, strProcName, 0)

    End Sub

    Public Function UpdateBookAPDetailRecord(ByVal oData As DTO.BookAPDetail) As DTO.BookAPDetail
        Using LinqDB
            With oData
                Try

                    'Open the existing Record
                    Dim d = (From e In CType(LinqDB, NGLMasBookDataContext).Books Where e.BookControl = .BookControl Select e).First
                    If d Is Nothing Then
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_RecordDeleted"}, New FaultReason("E_InvalidOperationException"))
                    Else
                        'Check for conflicts
                        If .BookModDate <> d.BookModDate Then
                            'the data may have changed so check each field for conflicts
                            Dim ConflictData As New List(Of KeyValuePair(Of String, String))
                            Dim blnConflictFound As Boolean = False
                            addToConflicts("BookProNumber", .BookProNumber, d.BookProNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookConsPrefix", .BookConsPrefix, d.BookConsPrefix, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrierControl", .BookCarrierControl, d.BookCarrierControl, ConflictData, blnConflictFound)
                            addToConflicts("BookDateLoad", .BookDateLoad, d.BookDateLoad, ConflictData, blnConflictFound)
                            addToConflicts("BookTranCode", .BookTranCode, d.BookTranCode, ConflictData, blnConflictFound)
                            addToConflicts("BookPayCode", .BookPayCode, d.BookPayCode, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrBLNumber", .BookCarrBLNumber, d.BookCarrBLNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPBillNumber", .BookFinAPBillNumber, d.BookFinAPBillNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPBillNoDate", .BookFinAPBillNoDate, d.BookFinAPBillNoDate, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPBillInvDate", .BookFinAPBillInvDate, d.BookFinAPBillInvDate, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPActWgt", .BookFinAPActWgt, If(d.BookFinAPActWgt.HasValue, d.BookFinAPActWgt, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPPayDate", .BookFinAPPayDate, d.BookFinAPPayDate, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPPayAmt", .BookFinAPPayAmt, If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPCheck", .BookFinAPCheck, d.BookFinAPCheck, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPGLNumber", .BookFinAPGLNumber, d.BookFinAPGLNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookRevTotalCost", .BookRevTotalCost, If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0), ConflictData, blnConflictFound)

                            If blnConflictFound Then
                                'We only add the mod date and mod user if one or more other fields have been modified
                                addToConflicts("BookModDate", .BookModDate, d.BookModDate, ConflictData, blnConflictFound)
                                addToConflicts("BookModUser", .BookModUser, d.BookModUser, ConflictData, blnConflictFound)
                                Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(ConflictData))
                                conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                                Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                            End If
                        End If
                        'Update the table data
                        d.BookConsPrefix = .BookConsPrefix
                        d.BookCarrierControl = .BookCarrierControl
                        d.BookDateLoad = .BookDateLoad
                        d.BookPayCode = .BookPayCode
                        d.BookModDate = Date.Now
                        d.BookModUser = Me.Parameters.UserName
                        d.BookCarrBLNumber = .BookCarrBLNumber
                        d.BookFinAPBillNumber = .BookFinAPBillNumber
                        d.BookFinAPBillNoDate = .BookFinAPBillNoDate
                        d.BookFinAPBillInvDate = .BookFinAPBillInvDate
                        d.BookFinAPActWgt = .BookFinAPActWgt
                        d.BookFinAPPayDate = .BookFinAPPayDate
                        d.BookFinAPPayAmt = .BookFinAPPayAmt
                        d.BookFinAPCheck = .BookFinAPCheck
                        d.BookFinAPGLNumber = .BookFinAPGLNumber
                        d.BookRevTotalCost = .BookRevTotalCost
                    End If
                    LinqDB.SubmitChanges()
                Catch ex As FaultException
                    Throw
                Catch ex As SqlException
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
                Catch conflictEx As ChangeConflictException
                    Try
                        Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(LinqDB))
                        conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                        Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                    Catch ex As FaultException
                        Throw
                    Catch ex As Exception
                        Utilities.SaveAppError(ex.Message, Me.Parameters)
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
                    End Try
                Catch ex As InvalidOperationException
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_RecordDeleted"}, New FaultReason("E_InvalidOperationException"))
                Catch ex As Exception
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
                End Try

            End With
        End Using
        ' Return the updated order
        Return GetBookAPDetailRecord(oData.BookControl)

    End Function

    Public Function UpdateBookAPDetailRecordQuick(ByVal oData As DTO.BookAPDetail) As DTO.QuickSaveResults
        Using LinqDB
            With oData
                Try

                    'Open the existing Record
                    Dim d = (From e In CType(LinqDB, NGLMasBookDataContext).Books Where e.BookControl = .BookControl Select e).First
                    If d Is Nothing Then
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_RecordDeleted"}, New FaultReason("E_InvalidOperationException"))
                    Else
                        'Check for conflicts
                        If .BookModDate <> d.BookModDate Then
                            'the data may have changed so check each field for conflicts
                            Dim ConflictData As New List(Of KeyValuePair(Of String, String))
                            Dim blnConflictFound As Boolean = False
                            addToConflicts("BookProNumber", .BookProNumber, d.BookProNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookConsPrefix", .BookConsPrefix, d.BookConsPrefix, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrierControl", .BookCarrierControl, d.BookCarrierControl, ConflictData, blnConflictFound)
                            addToConflicts("BookDateLoad", .BookDateLoad, d.BookDateLoad, ConflictData, blnConflictFound)
                            addToConflicts("BookTranCode", .BookTranCode, d.BookTranCode, ConflictData, blnConflictFound)
                            addToConflicts("BookPayCode", .BookPayCode, d.BookPayCode, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrBLNumber", .BookCarrBLNumber, d.BookCarrBLNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPBillNumber", .BookFinAPBillNumber, d.BookFinAPBillNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPBillNoDate", .BookFinAPBillNoDate, d.BookFinAPBillNoDate, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPBillInvDate", .BookFinAPBillInvDate, d.BookFinAPBillInvDate, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPActWgt", .BookFinAPActWgt, If(d.BookFinAPActWgt.HasValue, d.BookFinAPActWgt, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPPayDate", .BookFinAPPayDate, d.BookFinAPPayDate, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPPayAmt", .BookFinAPPayAmt, If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPCheck", .BookFinAPCheck, d.BookFinAPCheck, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPGLNumber", .BookFinAPGLNumber, d.BookFinAPGLNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookRevTotalCost", .BookRevTotalCost, If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0), ConflictData, blnConflictFound)

                            If blnConflictFound Then
                                'We only add the mod date and mod user if one or more other fields have been modified
                                addToConflicts("BookModDate", .BookModDate, d.BookModDate, ConflictData, blnConflictFound)
                                addToConflicts("BookModUser", .BookModUser, d.BookModUser, ConflictData, blnConflictFound)
                                Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(ConflictData))
                                conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                                Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                            End If
                        End If
                        'Update the table data
                        d.BookConsPrefix = .BookConsPrefix
                        d.BookCarrierControl = .BookCarrierControl
                        d.BookDateLoad = .BookDateLoad
                        d.BookPayCode = .BookPayCode
                        d.BookModDate = Date.Now
                        d.BookModUser = Me.Parameters.UserName
                        d.BookCarrBLNumber = .BookCarrBLNumber
                        d.BookFinAPBillNumber = .BookFinAPBillNumber
                        d.BookFinAPBillNoDate = .BookFinAPBillNoDate
                        d.BookFinAPBillInvDate = .BookFinAPBillInvDate
                        d.BookFinAPActWgt = .BookFinAPActWgt
                        d.BookFinAPPayDate = .BookFinAPPayDate
                        d.BookFinAPPayAmt = .BookFinAPPayAmt
                        d.BookFinAPCheck = .BookFinAPCheck
                        d.BookFinAPGLNumber = .BookFinAPGLNumber
                        d.BookRevTotalCost = .BookRevTotalCost
                    End If
                    LinqDB.SubmitChanges()
                Catch ex As FaultException
                    Throw
                Catch ex As SqlException
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
                Catch conflictEx As ChangeConflictException
                    Try
                        Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(LinqDB))
                        conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                        Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                    Catch ex As FaultException
                        Throw
                    Catch ex As Exception
                        Utilities.SaveAppError(ex.Message, Me.Parameters)
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
                    End Try
                Catch ex As InvalidOperationException
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_RecordDeleted"}, New FaultReason("E_InvalidOperationException"))
                Catch ex As Exception
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
                End Try

            End With
        End Using
        ' get the updated order
        Dim oUpdated = GetBookAPDetailRecord(oData.BookControl)
        Dim oRet As New DTO.QuickSaveResults
        If Not oUpdated Is Nothing Then
            oRet.Control = oUpdated.BookControl
            oRet.ModDate = oUpdated.BookModDate
            oRet.ModUser = oUpdated.BookModUser
        End If
        Return oRet

    End Function

    Public Function IsCarrierContactUsed(ByVal CarrContControl As Integer) As Boolean
        Dim blnRet As Boolean = False
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'Check if a record exists
                Dim Book = ( _
                From d In db.Books _
                Where _
                    (d.BookCarrierContControl = CarrContControl) _
                Select d.BookControl).First

                'If We get here a record exists to return true
                Return True

            Catch ex As System.Data.SqlClient.SqlException
                Throw
            Catch ex As InvalidOperationException
                'do nothing this is the desired result.
            Catch ex As Exception
                Throw
            End Try

            Return blnRet

        End Using
    End Function

    Public Sub UpdateCNSLockFlags(ByVal BookControl As Integer)
        Dim strProcName As String = "dbo.spUpdateCNSLockFlags"
        Dim oCmd As New System.Data.SqlClient.SqlCommand
        oCmd.Parameters.AddWithValue("@BookControl", BookControl)
        oCmd.Parameters.AddWithValue("@UserName", Left(Me.Parameters.UserName, 100))
        runNGLStoredProcedure(oCmd, strProcName, 0)
    End Sub

    Public Sub UpdateBookConsPickNumber(ByVal BookConsPrefix As String)
        If BookConsPrefix.Trim.Length > 1 Then
            Dim strProcName As String = "dbo.spUpdateBookConsPickNumber"
            Dim oCmd As New System.Data.SqlClient.SqlCommand
            oCmd.Parameters.AddWithValue("@BookConsPrefix", BookConsPrefix)
            oCmd.Parameters.AddWithValue("@UserName", Left(Me.Parameters.UserName, 100))
            runNGLStoredProcedure(oCmd, strProcName, 0)
        End If
    End Sub

    Public Function CreateBookFilters() As DTO.BookFilters
        Return New DTO.BookFilters
    End Function

#End Region

#Region "Protected Methods"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Dim d = TryCast(oData, DTO.Book)
        Dim strCompAbrev As String = getScalarString("Select top 1 isnull(dbo.Comp.CompAbrev,'') From dbo.Comp Where dbo.Comp.CompControl = " & d.BookCustCompControl)
        Dim strBookPro As String = strCompAbrev & d.BookProBase

        'Create New Record
        Return New LTS.Book With {.BookControl = d.BookControl _
                                          , .BookProNumber = strBookPro _
                                          , .BookProBase = d.BookProBase _
                                          , .BookConsPrefix = d.BookConsPrefix _
                                          , .BookCustCompControl = d.BookCustCompControl _
                                          , .BookCommCompControl = d.BookCommCompControl _
                                          , .BookODControl = d.BookODControl _
                                          , .BookCarrierControl = d.BookCarrierControl _
                                          , .BookCarrierContact = d.BookCarrierContact _
                                          , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                          , .BookOrigCompControl = d.BookOrigCompControl _
                                          , .BookOrigName = d.BookOrigName _
                                          , .BookOrigAddress1 = d.BookOrigAddress1 _
                                          , .BookOrigAddress2 = d.BookOrigAddress2 _
                                          , .BookOrigAddress3 = d.BookOrigAddress3 _
                                          , .BookOrigCity = d.BookOrigCity _
                                          , .BookOrigState = d.BookOrigState _
                                          , .BookOrigCountry = d.BookOrigCountry _
                                          , .BookOrigZip = d.BookOrigZip _
                                          , .BookOrigPhone = d.BookOrigPhone _
                                          , .BookOrigFax = d.BookOrigFax _
                                          , .BookOriginStartHrs = d.BookOriginStartHrs _
                                          , .BookOriginStopHrs = d.BookOriginStopHrs _
                                          , .BookOriginApptReq = d.BookOriginApptReq _
                                          , .BookDestCompControl = d.BookDestCompControl _
                                          , .BookDestName = d.BookDestName _
                                          , .BookDestAddress1 = d.BookDestAddress1 _
                                          , .BookDestAddress2 = d.BookDestAddress2 _
                                          , .BookDestAddress3 = d.BookDestAddress3 _
                                          , .BookDestCity = d.BookDestCity _
                                          , .BookDestState = d.BookDestState _
                                          , .BookDestCountry = d.BookDestCountry _
                                          , .BookDestZip = d.BookDestZip _
                                          , .BookDestPhone = d.BookDestPhone _
                                          , .BookDestFax = d.BookDestFax _
                                          , .BookDestStartHrs = d.BookDestStartHrs _
                                          , .BookDestStopHrs = d.BookDestStopHrs _
                                          , .BookDestApptReq = d.BookDestApptReq _
                                          , .BookDateOrdered = d.BookDateOrdered _
                                          , .BookDateLoad = d.BookDateLoad _
                                          , .BookDateInvoice = d.BookDateInvoice _
                                          , .BookDateRequired = d.BookDateRequired _
                                          , .BookDateDelivered = d.BookDateDelivered _
                                          , .BookTotalCases = d.BookTotalCases _
                                          , .BookTotalWgt = d.BookTotalWgt _
                                          , .BookTotalPL = d.BookTotalPL _
                                          , .BookTotalCube = d.BookTotalCube _
                                          , .BookTotalPX = d.BookTotalPX _
                                          , .BookTotalBFC = d.BookTotalBFC _
                                          , .BookTranCode = d.BookTranCode _
                                          , .BookPayCode = d.BookPayCode _
                                          , .BookTypeCode = d.BookTypeCode _
                                          , .BookBOLCode = d.BookBOLCode _
                                          , .BookStopNo = d.BookStopNo _
                                          , .BookCarrFBNumber = d.BookCarrFBNumber _
                                          , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                          , .BookCarrBLNumber = d.BookCarrBLNumber _
                                          , .BookCarrBookDate = d.BookCarrBookDate _
                                          , .BookCarrBookTime = d.BookCarrBookTime _
                                          , .BookCarrBookContact = d.BookCarrBookContact _
                                          , .BookCarrScheduleDate = d.BookCarrScheduleDate _
                                          , .BookCarrScheduleTime = d.BookCarrScheduleTime _
                                          , .BookCarrActualDate = d.BookCarrActualDate _
                                          , .BookCarrActualTime = d.BookCarrActualTime _
                                          , .BookCarrActLoadComplete_Date = d.BookCarrActLoadComplete_Date _
                                          , .BookCarrActLoadCompleteTime = d.BookCarrActLoadCompleteTime _
                                          , .BookCarrDockPUAssigment = d.BookCarrDockPUAssigment _
                                          , .BookCarrPODate = d.BookCarrPODate _
                                          , .BookCarrPOTime = d.BookCarrPOTime _
                                          , .BookCarrApptDate = d.BookCarrApptDate _
                                          , .BookCarrApptTime = d.BookCarrApptTime _
                                          , .BookCarrActDate = d.BookCarrActDate _
                                          , .BookCarrActTime = d.BookCarrActTime _
                                          , .BookCarrActUnloadCompDate = d.BookCarrActUnloadCompDate _
                                          , .BookCarrActUnloadCompTime = d.BookCarrActUnloadCompTime _
                                          , .BookCarrDockDelAssignment = d.BookCarrDockDelAssignment _
                                          , .BookCarrVarDay = d.BookCarrVarDay _
                                          , .BookCarrVarHrs = d.BookCarrVarHrs _
                                          , .BookCarrTrailerNo = d.BookCarrTrailerNo _
                                          , .BookCarrSealNo = d.BookCarrSealNo _
                                          , .BookCarrDriverNo = d.BookCarrDriverNo _
                                          , .BookCarrDriverName = d.BookCarrDriverName _
                                          , .BookCarrRouteNo = d.BookCarrRouteNo _
                                          , .BookCarrTripNo = d.BookCarrTripNo _
                                          , .BookFinARBookFrt = d.BookFinARBookFrt _
                                          , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                          , .BookFinARInvoiceAmt = d.BookFinARInvoiceAmt _
                                          , .BookFinARPayDate = d.BookFinARPayDate _
                                          , .BookFinARPayAmt = d.BookFinARPayAmt _
                                          , .BookFinARCheck = d.BookFinARCheck _
                                          , .BookFinARGLNumber = d.BookFinARGLNumber _
                                          , .BookFinARBalance = d.BookFinARBalance _
                                          , .BookFinARCurType = d.BookFinARCurType _
                                          , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                          , .BookFinAPBillNoDate = d.BookFinAPBillNoDate _
                                          , .BookFinAPBillInvDate = d.BookFinAPBillInvDate _
                                          , .BookFinAPActWgt = d.BookFinAPActWgt _
                                          , .BookFinAPStdCost = d.BookFinAPStdCost _
                                          , .BookFinAPActCost = d.BookFinAPActCost _
                                          , .BookFinAPPayDate = d.BookFinAPPayDate _
                                          , .BookFinAPPayAmt = d.BookFinAPPayAmt _
                                          , .BookFinAPCheck = d.BookFinAPCheck _
                                          , .BookFinAPGLNumber = d.BookFinAPGLNumber _
                                          , .BookFinAPLastViewed = d.BookFinAPLastViewed _
                                          , .BookFinAPCurType = d.BookFinAPCurType _
                                          , .BookFinCommStd = d.BookFinCommStd _
                                          , .BookFinCommAct = d.BookFinCommAct _
                                          , .BookFinCommPayDate = d.BookFinCommPayDate _
                                          , .BookFinCommPayAmt = d.BookFinCommPayAmt _
                                          , .BookFinCommtCheck = d.BookFinCommtCheck _
                                          , .BookFinCommCreditAmt = d.BookFinCommCreditAmt _
                                          , .BookFinCommCreditPayDate = d.BookFinCommCreditPayDate _
                                          , .BookFinCommLoadCount = d.BookFinCommLoadCount _
                                          , .BookFinCommGLNumber = d.BookFinCommGLNumber _
                                          , .BookFinCheckClearedDate = d.BookFinCheckClearedDate _
                                          , .BookFinCheckClearedNumber = d.BookFinCheckClearedNumber _
                                          , .BookFinCheckClearedAmt = d.BookFinCheckClearedAmt _
                                          , .BookFinCheckClearedDesc = d.BookFinCheckClearedDesc _
                                          , .BookFinCheckClearedAcct = d.BookFinCheckClearedAcct _
                                          , .BookRevBilledBFC = d.BookRevBilledBFC _
                                          , .BookRevCarrierCost = d.BookRevCarrierCost _
                                          , .BookRevStopQty = d.BookRevStopQty _
                                          , .BookRevStopCost = d.BookRevStopCost _
                                          , .BookRevOtherCost = d.BookRevOtherCost _
                                          , .BookRevTotalCost = d.BookRevTotalCost _
                                          , .BookRevLoadSavings = d.BookRevLoadSavings _
                                          , .BookRevCommPercent = d.BookRevCommPercent _
                                          , .BookRevCommCost = d.BookRevCommCost _
                                          , .BookRevGrossRevenue = d.BookRevGrossRevenue _
                                          , .BookRevNegRevenue = d.BookRevNegRevenue _
                                          , .BookMilesFrom = d.BookMilesFrom _
                                          , .BookLaneCarrControl = d.BookLaneCarrControl _
                                          , .BookHoldLoad = d.BookHoldLoad _
                                          , .BookRouteFinalDate = d.BookRouteFinalDate _
                                          , .BookRouteFinalCode = d.BookRouteFinalCode _
                                          , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                          , .BookWarehouseNumber = d.BookWarehouseNumber _
                                          , .BookComCode = d.BookComCode _
                                          , .BookTransType = d.BookTransType _
                                          , .BookRouteConsFlag = d.BookRouteConsFlag _
                                          , .BookWhseAuthorizationNo = d.BookWhseAuthorizationNo _
                                          , .BookHotLoad = d.BookHotLoad _
                                          , .BookFinAPActTax = d.BookFinAPActTax _
                                          , .BookFinAPExportFlag = d.BookFinAPExportFlag _
                                          , .BookFinARFreightTax = d.BookFinARFreightTax _
                                          , .BookRevFreightTax = d.BookRevFreightTax _
                                          , .BookRevNetCost = d.BookRevNetCost _
                                          , .BookFinServiceFee = d.BookFinServiceFee _
                                          , .BookFinAPExportDate = d.BookFinAPExportDate _
                                          , .BookFinAPExportRetry = d.BookFinAPExportRetry _
                                          , .BookCarrierContControl = d.BookCarrierContControl _
                                          , .BookHotLoadSent = d.BookHotLoadSent _
                                          , .BookExportDocCreated = d.BookExportDocCreated _
                                          , .BookDoNotInvoice = d.BookDoNotInvoice _
                                          , .BookCarrStartLoadingDate = d.BookCarrStartLoadingDate _
                                          , .BookCarrStartLoadingTime = d.BookCarrStartLoadingTime _
                                          , .BookCarrFinishLoadingDate = d.BookCarrFinishLoadingDate _
                                          , .BookCarrFinishLoadingTime = d.BookCarrFinishLoadingTime _
                                          , .BookCarrStartUnloadingDate = d.BookCarrStartUnloadingDate _
                                          , .BookCarrStartUnloadingTime = d.BookCarrStartUnloadingTime _
                                          , .BookCarrFinishUnloadingDate = d.BookCarrFinishUnloadingDate _
                                          , .BookCarrFinishUnloadingTime = d.BookCarrFinishUnloadingTime _
                                          , .BookOrderSequence = d.BookOrderSequence _
                                          , .BookChepGLID = d.BookChepGLID _
                                          , .BookCarrierTypeCode = d.BookCarrierTypeCode _
                                          , .BookPalletPositions = d.BookPalletPositions _
                                          , .BookShipCarrierProNumber = d.BookShipCarrierProNumber _
                                          , .BookShipCarrierName = d.BookShipCarrierName _
                                          , .BookShipCarrierNumber = d.BookShipCarrierNumber _
                                          , .BookAPAdjReasonControl = d.BookAPAdjReasonControl _
                                          , .BookDateRequested = d.BookDateRequested _
                                          , .BookCarrierEquipmentCodes = d.BookCarrierEquipmentCodes _
                                          , .BookLockAllCosts = d.BookLockAllCosts _
                                          , .BookLockBFCCost = d.BookLockBFCCost _
                                            , .BookDestStopNumber = d.BookDestStopNumber _
                                            , .BookOrigStopNumber = d.BookOrigStopNumber _
                                            , .BookDestStopControl = d.BookDestStopControl _
                                            , .BookOrigStopControl = d.BookOrigStopControl _
                                            , .BookRouteTypeCode = d.BookRouteTypeCode _
                                            , .BookAlternateAddressLaneControl = d.BookAlternateAddressLaneControl _
                                            , .BookAlternateAddressLaneNumber = d.BookAlternateAddressLaneNumber _
                                            , .BookDefaultRouteSequence = d.BookDefaultRouteSequence _
                                            , .BookRouteGuideControl = d.BookRouteGuideControl _
                                            , .BookRouteGuideNumber = d.BookRouteGuideNumber _
                                            , .BookCustomerApprovalRecieved = d.BookCustomerApprovalRecieved _
                                            , .BookCustomerApprovalTransmitted = d.BookCustomerApprovalTransmitted _
                                            , .BookAMSPickupApptControl = d.BookAMSPickupApptControl _
                                            , .BookAMSDeliveryApptControl = d.BookAMSDeliveryApptControl _
                                            , .BookItemDetailDescription = d.BookItemDetailDescription _
                                          , .BookModDate = Date.Now _
                                          , .BookModUser = Me.Parameters.UserName _
                                          , .BookUpdated = If(d.BookUpdated Is Nothing, New Byte() {}, d.BookUpdated)}
    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Dim source As LTS.Book = TryCast(LinqTable, LTS.Book)
        If source Is Nothing Then Return Nothing
        If _RecalcTotals Then
            Dim blnRet As Boolean = (New NGLBatchProcessDataProvider(Me.Parameters).UpdateBookCapacityTotals2Way(source.BookControl))
            If blnRet Then _RecalcTotals = False
        End If
        Me.UpdateCNSLockFlags(source.BookControl)
        Return GetBookFiltered(Control:=source.BookControl)
    End Function

    Protected Overrides Sub NoReturnCleanUp(ByVal LinqTable As Object)
        Dim source As LTS.Book = TryCast(LinqTable, LTS.Book)
        If Not source Is Nothing Then
            Dim blnRet As Boolean = (New NGLBatchProcessDataProvider(Me.Parameters).UpdateBookCapacityTotals2Way(source.BookControl))
            Me.UpdateCNSLockFlags(source.BookControl)
        End If
    End Sub

    Protected Overrides Function GetQuickSaveResults(ByVal LinqTable As Object) As DataTransferObjects.QuickSaveResults
        Dim ret As DTO.QuickSaveResults
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim source As LTS.Book = TryCast(LinqTable, LTS.Book)
                If source Is Nothing Then Return Nothing
                Dim blnRet As Boolean = (New NGLBatchProcessDataProvider(Me.Parameters).UpdateBookCapacityTotals2Way(source.BookControl))
                Me.UpdateCNSLockFlags(source.BookControl)
                ret = (From d In db.Books _
                       Where d.BookControl = source.BookControl _
                       Select New DTO.QuickSaveResults With {.Control = d.BookControl _
                                                            , .ModDate = d.BookModDate _
                                                            , .ModUser = d.BookModUser _
                                                            , .Updated = d.BookUpdated.ToArray}).First
            Catch ex As FaultException(Of SqlFaultInfo)
                Throw
            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

        End Using
        Return ret
    End Function

    Protected Overrides Sub ValidateNewRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'Check if the data already exists only one allowed      
        With CType(oData, DTO.Book)
            Try
                'Check if a company is selected
                If .BookCustCompControl = 0 Then
                    Utilities.SaveAppError("Cannot save new Book data.  A company has not been selected.  Please select a company and try again.", Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_InvalidKeyField"}, New FaultReason("E_DataValidationFailure"))
                End If
                If String.IsNullOrEmpty(.BookProNumber) OrElse .BookProNumber.Trim.Length < 1 Then
                    'We need to add the pro number
                    Dim PROBase As String = getScalarString("SELECT TOP 1 p.ParValue FROM dbo.parameter as p WHERE p.parkey = 'PRONUMBER'")
                    Dim intNextPro As Integer = 0
                    Integer.TryParse(PROBase, intNextPro)
                    intNextPro += 1
                    executeSQL("Update dbo.Parameter Set ParValue = " & intNextPro & " Where ParKey = 'PRONUMBER'")
                    Dim NewPRONumber = Trim(GetCustAbrev(.BookCustCompControl)) & intNextPro.ToString
                    .BookProBase = Left(intNextPro.ToString, 50)
                    .BookProNumber = NewPRONumber
                    .TrackingState = TrackingInfo.Updated
                Else
                    'verify that the bookpronumber is not in use
                    Dim Book As DTO.Book = ( _
                        From t In CType(oDB, NGLMasBookDataContext).Books _
                         Where _
                             t.BookProNumber = .BookProNumber _
                         Select New DTO.Book With {.BookControl = t.BookControl}).First
                    If Not Book Is Nothing Then
                        Utilities.SaveAppError("Cannot save new Book data.  The Book Pro number, " & .BookProNumber & " ,  already exist.", Me.Parameters)
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_InvalidKeyField"}, New FaultReason("E_DataValidationFailure"))
                    End If
                End If
            Catch ex As FaultException
                Throw
            Catch ex As InvalidOperationException
                'do nothing this is the desired result.
            End Try
        End With
    End Sub

    Protected Overrides Sub ValidateUpdatedRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'Check if the data already exists only one allowed
        With CType(oData, DTO.Book)
            Try
                'Get the newest record that matches the provided criteria
                Dim Book As DTO.Book = ( _
                From t In CType(oDB, NGLMasBookDataContext).Books _
                 Where _
                     (t.BookControl <> .BookControl) _
                     And _
                     (t.BookProNumber = .BookProNumber) _
                 Select New DTO.Book With {.BookControl = t.BookControl}).FirstOrDefault()


                If Not Book Is Nothing AndAlso Book.BookControl <> 0 Then
                    Utilities.SaveAppError("Cannot save Book changes.  The Book PRO Number, " & .BookProNumber & " already exist.", Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_InvalidKeyField"}, New FaultReason("E_DataValidationFailure"))
                End If

            Catch ex As FaultException
                Throw
            Catch ex As InvalidOperationException
                'do nothing this is the desired result.
            End Try
        End With
    End Sub

    Protected Overrides Sub ValidateDeletedRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'Check if the Book is being used by the book data or the lane data
        With CType(oData, DTO.Book)
            Try
                ''Add code here to call the Book and Lane data providers when they are created
                'Dim dpBook As New NGLBookData(Me.Parameters)
                'Dim dpLane As New NGLLaneData(Me.Parameters)
                'Dim oBooks() As DTO.Book
                'Dim oLanes() As DTO.Lane
                'Try
                '    oBooks = dpBook.GetBooksByBook(.BookControl)
                'Catch ex As FaultException
                '    If ex.Message <> "E_NoData" Then
                '        Throw
                '    End If
                'End Try
                'Try
                '    oLanes = dpLane.GetLanesByBook(.BookControl)
                'Catch ex As FaultException
                '    If ex.Message <> "E_NoData" Then
                '        Throw
                '    End If
                'End Try
                'If (Not oBooks Is Nothing AndAlso oBooks.Length > 0) OrElse (Not oLanes Is Nothing AndAlso oLanes.Length > 0) Then
                '    Utilities.SaveAppError("Cannot delete Book data.  The Book number, " & .BookNumber & " is being used and cannot be deleted. check the book or lane information.", Me.Parameters)
                '    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_DataInUse"}, New FaultReason("E_DataValidationFailure"))
                'End If
            Catch ex As FaultException
                Throw
            Catch ex As InvalidOperationException
                'do nothing this is the desired result.
            End Try
        End With
    End Sub

    Protected Overrides Sub AddDetailsToLinq(ByRef LinqTable As Object, ByRef oData As DTO.DTOBaseClass)

        With CType(LinqTable, LTS.Book)
            'Add Book Loads Records
            .BookLoads.AddRange( _
                     From d In CType(oData, DTO.Book).BookLoads _
                     Select New LTS.BookLoad With {.BookLoadControl = d.BookLoadControl _
                                          , .BookLoadBookControl = d.BookLoadBookControl _
                                          , .BookLoadBuy = d.BookLoadBuy _
                                          , .BookLoadPONumber = d.BookLoadPONumber _
                                          , .BookLoadVendor = d.BookLoadVendor _
                                          , .BookLoadCaseQty = d.BookLoadCaseQty _
                                          , .BookLoadWgt = d.BookLoadWgt _
                                          , .BookLoadCube = d.BookLoadCube _
                                          , .BookLoadPL = d.BookLoadPL _
                                          , .BookLoadPX = d.BookLoadPX _
                                          , .BookLoadPType = d.BookLoadPType _
                                          , .BookLoadCom = d.BookLoadCom _
                                          , .BookLoadPUOrigin = d.BookLoadPUOrigin _
                                          , .BookLoadBFC = d.BookLoadBFC _
                                          , .BookLoadTotCost = d.BookLoadTotCost _
                                          , .BookLoadComments = d.BookLoadComments _
                                          , .BookLoadStopSeq = d.BookLoadStopSeq _
                                          , .BookLoadModDate = Date.Now _
                                          , .BookLoadModUser = Parameters.UserName _
                                          , .BookLoadUpdated = If(d.BookLoadUpdated Is Nothing, New Byte() {}, d.BookLoadUpdated)})
            'Add Book Notes Records
            .BookNotes.AddRange( _
                     From d In CType(oData, DTO.Book).BookNotes _
                     Select New LTS.BookNote With {.BookNotesControl = d.BookNotesControl _
                                        , .BookNotesBookControl = d.BookNotesBookControl _
                                        , .BookNotesVisable1 = d.BookNotesVisable1 _
                                        , .BookNotesVisable2 = d.BookNotesVisable2 _
                                        , .BookNotesVisable3 = d.BookNotesVisable3 _
                                        , .BookNotesVisable4 = d.BookNotesVisable4 _
                                        , .BookNotesVisable5 = d.BookNotesVisable5 _
                                        , .BookNotesConfidential1 = d.BookNotesConfidential1 _
                                        , .BookNotesConfidential2 = d.BookNotesConfidential2 _
                                        , .BookNotesConfidential3 = d.BookNotesConfidential3 _
                                        , .BookNotesConfidential4 = d.BookNotesConfidential4 _
                                        , .BookNotesConfidential5 = d.BookNotesConfidential5 _
                                        , .BookNotesModDate = Date.Now _
                                        , .BookNotesModUser = Parameters.UserName _
                                        , .BookNotesUpdated = If(d.BookNotesUpdated Is Nothing, New Byte() {}, d.BookNotesUpdated)})
            'Add Book Track Records
            .BookTracks.AddRange( _
                     From d In CType(oData, DTO.Book).BookTracks _
                     Select New LTS.BookTrack With {.BookTrackControl = d.BookTrackControl _
                                        , .BookTrackBookControl = d.BookTrackBookControl _
                                        , .BookTrackDate = d.BookTrackDate _
                                        , .BookTrackContact = d.BookTrackContact _
                                        , .BookTrackComment = d.BookTrackComment _
                                        , .BookTrackStatus = d.BookTrackStatus _
                                        , .BookTrackModUser = Parameters.UserName _
                                        , .BookTrackModDate = Date.Now _
                                        , .BookTrackUpdated = If(d.BookTrackUpdated Is Nothing, New Byte() {}, d.BookTrackUpdated)})


        End With
    End Sub

    Protected Overrides Sub InsertAllDetails(ByRef oDB As System.Data.Linq.DataContext, ByRef LinqTable As Object)
        With CType(oDB, NGLMasBookDataContext)
            .BookLoads.InsertAllOnSubmit(CType(LinqTable, LTS.Book).BookLoads)
            .BookNotes.InsertAllOnSubmit(CType(LinqTable, LTS.Book).BookNotes)
            .BookTracks.InsertAllOnSubmit(CType(LinqTable, LTS.Book).BookTracks)
        End With
    End Sub

    Protected Overrides Sub ProcessUpdatedDetails(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        With CType(oDB, NGLMasBookDataContext)

            ' Process any inserted bookload records  
            Dim oBookLoadChanges = GetBookLoadChanges(oData, TrackingInfo.Created)
            If Not oBookLoadChanges Is Nothing AndAlso oBookLoadChanges.Count > 0 Then _RecalcTotals = True
            .BookLoads.InsertAllOnSubmit(oBookLoadChanges)
            ' Process any updated bookload records
            oBookLoadChanges = GetBookLoadChanges(oData, TrackingInfo.Updated)
            If Not oBookLoadChanges Is Nothing AndAlso oBookLoadChanges.Count > 0 Then _RecalcTotals = True
            .BookLoads.AttachAll(oBookLoadChanges, True)
            ' Process any deleted bookload records
            Dim deletedLoadDetails = GetBookLoadChanges(oData, TrackingInfo.Deleted)
            If Not deletedLoadDetails Is Nothing AndAlso deletedLoadDetails.Count > 0 Then _RecalcTotals = True
            .BookLoads.AttachAll(deletedLoadDetails, True)
            .BookLoads.DeleteAllOnSubmit(deletedLoadDetails)
            'Process any BookItem Changes 
            For Each oRow As DTO.BookLoad In TryCast(oData, DTO.Book).BookLoads
                If oRow.TrackingState <> TrackingInfo.Deleted AndAlso ((Not oRow.BookItems Is Nothing) AndAlso oRow.BookItems.Count > 0) Then
                    ' Process any inserted bookitem records     
                    Dim oBookItemChanges = GetBookItemChanges(oRow, TrackingInfo.Created)
                    If Not oBookItemChanges Is Nothing AndAlso oBookItemChanges.Count > 0 Then _RecalcTotals = True
                    .BookItems.InsertAllOnSubmit(oBookItemChanges)
                    ' Process any updated bookload records     
                    oBookItemChanges = GetBookItemChanges(oRow, TrackingInfo.Updated)
                    If Not oBookItemChanges Is Nothing AndAlso oBookItemChanges.Count > 0 Then _RecalcTotals = True
                    .BookItems.AttachAll(oBookItemChanges, True)
                    ' Process any deleted bookload records
                    Dim deletedBookItems = GetBookItemChanges(oRow, TrackingInfo.Deleted)
                    If Not deletedBookItems Is Nothing AndAlso deletedBookItems.Count > 0 Then _RecalcTotals = True
                    .BookItems.AttachAll(deletedBookItems, True)
                    .BookItems.DeleteAllOnSubmit(deletedBookItems)
                End If
            Next


            ' Process any inserted BookNotes records 
            .BookNotes.InsertAllOnSubmit(GetBookNoteChanges(oData, TrackingInfo.Created))
            ' Process any updated BookNote records
            .BookNotes.AttachAll(GetBookNoteChanges(oData, TrackingInfo.Updated), True)
            ' Process any deleted BookNote records
            Dim deletedBudDetails = GetBookNoteChanges(oData, TrackingInfo.Deleted)
            .BookNotes.AttachAll(deletedBudDetails, True)
            .BookNotes.DeleteAllOnSubmit(deletedBudDetails)
            ' Process any inserted BookTrack records 
            .BookTracks.InsertAllOnSubmit(GetBookTrackChanges(oData, TrackingInfo.Created))
            ' Process any updated BookTrack records
            .BookTracks.AttachAll(GetBookTrackChanges(oData, TrackingInfo.Updated), True)
            ' Process any deleted BookTrack records
            Dim deletedTrackDetails = GetBookTrackChanges(oData, TrackingInfo.Deleted)
            .BookTracks.AttachAll(deletedTrackDetails, True)
            .BookTracks.DeleteAllOnSubmit(deletedTrackDetails)

        End With
    End Sub

    Protected Function GetBookLoadChanges(ByVal source As DTO.Book, ByVal changeType As TrackingInfo) As List(Of LTS.BookLoad)
        ' Test record details for specified change type.
        ' If Updated is null, set to byte[0] (for inserted items).
        Dim details As IEnumerable(Of LTS.BookLoad) = ( _
          From d In source.BookLoads _
          Where d.TrackingState = changeType _
          Select New LTS.BookLoad With {.BookLoadControl = d.BookLoadControl _
                                          , .BookLoadBookControl = d.BookLoadBookControl _
                                          , .BookLoadBuy = d.BookLoadBuy _
                                          , .BookLoadPONumber = d.BookLoadPONumber _
                                          , .BookLoadVendor = d.BookLoadVendor _
                                          , .BookLoadCaseQty = d.BookLoadCaseQty _
                                          , .BookLoadWgt = d.BookLoadWgt _
                                          , .BookLoadCube = d.BookLoadCube _
                                          , .BookLoadPL = d.BookLoadPL _
                                          , .BookLoadPX = d.BookLoadPX _
                                          , .BookLoadPType = d.BookLoadPType _
                                          , .BookLoadCom = d.BookLoadCom _
                                          , .BookLoadPUOrigin = d.BookLoadPUOrigin _
                                          , .BookLoadBFC = d.BookLoadBFC _
                                          , .BookLoadTotCost = d.BookLoadTotCost _
                                          , .BookLoadComments = d.BookLoadComments _
                                          , .BookLoadStopSeq = d.BookLoadStopSeq _
                                          , .BookLoadModDate = Date.Now _
                                          , .BookLoadModUser = Parameters.UserName _
                                          , .BookLoadUpdated = If(d.BookLoadUpdated Is Nothing, New Byte() {}, d.BookLoadUpdated)})
        Return details.ToList()
    End Function

    Protected Function GetBookItemChanges(ByVal source As DTO.BookLoad, ByVal changeType As TrackingInfo) As List(Of LTS.BookItem)
        ' Test record details for specified change type.
        ' If Updated is null, set to byte[0] (for inserted items).
        Dim details As IEnumerable(Of LTS.BookItem) = ( _
          From d In source.BookItems _
          Where d.TrackingState = changeType _
          Select New LTS.BookItem With {.BookItemControl = d.BookItemControl _
                                       , .BookItemBookLoadControl = d.BookItemBookLoadControl _
                                       , .BookItemFixOffInvAllow = d.BookItemFixOffInvAllow _
                                       , .BookItemFixFrtAllow = d.BookItemFixFrtAllow _
                                       , .BookItemItemNumber = d.BookItemItemNumber _
                                       , .BookItemQtyOrdered = d.BookItemQtyOrdered _
                                       , .BookItemFreightCost = d.BookItemFreightCost _
                                       , .BookItemItemCost = d.BookItemItemCost _
                                       , .BookItemWeight = d.BookItemWeight _
                                       , .BookItemCube = d.BookItemCube _
                                       , .BookItemPack = d.BookItemPack _
                                       , .BookItemSize = d.BookItemSize _
                                       , .BookItemDescription = d.BookItemDescription _
                                       , .BookItemHazmat = d.BookItemHazmat _
                                       , .BookItemModDate = Date.Now _
                                       , .BookItemModUser = Parameters.UserName _
                                       , .BookItemBrand = d.BookItemBrand _
                                       , .BookItemCostCenter = d.BookItemCostCenter _
                                       , .BookItemLotNumber = d.BookItemLotNumber _
                                       , .BookItemLotExpirationDate = d.BookItemLotExpirationDate _
                                       , .BookItemGTIN = d.BookItemGTIN _
                                       , .BookCustItemNumber = d.BookCustItemNumber _
                                       , .BookItemBFC = d.BookItemBFC _
                                       , .BookItemCountryOfOrigin = d.BookItemCountryOfOrigin _
                                       , .BookItemHST = d.BookItemHST _
                                       , .BookItemPalletTypeID = d.BookItemPalletTypeID _
                                        , .BookItemHazmatTypeCode = d.BookItemHazmatTypeCode _
                                        , .BookItem49CFRCode = d.BookItem49CFRCode _
                                        , .BookItemIATACode = d.BookItemIATACode _
                                        , .BookItemDOTCode = d.BookItemDOTCode _
                                        , .BookItemMarineCode = d.BookItemMarineCode _
                                        , .BookItemNMFCClass = d.BookItemNMFCClass _
                                        , .BookItemFAKClass = d.BookItemFAKClass _
                                        , .BookItemLimitedQtyFlag = d.BookItemLimitedQtyFlag _
                                        , .BookItemPallets = d.BookItemPallets _
                                        , .BookItemTies = d.BookItemTies _
                                        , .BookItemHighs = d.BookItemHighs _
                                        , .BookItemQtyPalletPercentage = d.BookItemQtyPalletPercentage _
                                        , .BookItemQtyLength = d.BookItemQtyLength _
                                        , .BookItemQtyWidth = d.BookItemQtyWidth _
                                        , .BookItemQtyHeight = d.BookItemQtyHeight _
                                        , .BookItemStackable = d.BookItemStackable _
                                        , .BookItemLevelOfDensity = d.BookItemLevelOfDensity _
                                        , .BookItemUpdated = If(d.BookItemUpdated Is Nothing, New Byte() {}, d.BookItemUpdated)})
        Return details.ToList()
    End Function

    Protected Function GetBookNoteChanges(ByVal source As DTO.Book, ByVal changeType As TrackingInfo) As List(Of LTS.BookNote)
        ' Test record details for specified change type.
        ' If Updated is null, set to byte[0] (for inserted items).
        Dim details As IEnumerable(Of LTS.BookNote) = ( _
          From d In source.BookNotes _
          Where d.TrackingState = changeType _
          Select New LTS.BookNote With {.BookNotesControl = d.BookNotesControl _
                                        , .BookNotesBookControl = d.BookNotesBookControl _
                                        , .BookNotesVisable1 = d.BookNotesVisable1 _
                                        , .BookNotesVisable2 = d.BookNotesVisable2 _
                                        , .BookNotesVisable3 = d.BookNotesVisable3 _
                                        , .BookNotesVisable4 = d.BookNotesVisable4 _
                                        , .BookNotesVisable5 = d.BookNotesVisable5 _
                                        , .BookNotesConfidential1 = d.BookNotesConfidential1 _
                                        , .BookNotesConfidential2 = d.BookNotesConfidential2 _
                                        , .BookNotesConfidential3 = d.BookNotesConfidential3 _
                                        , .BookNotesConfidential4 = d.BookNotesConfidential4 _
                                        , .BookNotesConfidential5 = d.BookNotesConfidential5 _
                                        , .BookNotesModDate = Date.Now _
                                        , .BookNotesModUser = Parameters.UserName _
                                        , .BookNotesUpdated = If(d.BookNotesUpdated Is Nothing, New Byte() {}, d.BookNotesUpdated)})
        Return details.ToList()
    End Function

    Protected Function GetBookTrackChanges(ByVal source As DTO.Book, ByVal changeType As TrackingInfo) As List(Of LTS.BookTrack)
        ' Test record details for specified change type.
        ' If Updated is null, set to byte[0] (for inserted items).
        Dim details As IEnumerable(Of LTS.BookTrack) = ( _
          From d In source.BookTracks _
          Where d.TrackingState = changeType _
          Select New LTS.BookTrack With {.BookTrackControl = d.BookTrackControl _
                                        , .BookTrackBookControl = d.BookTrackBookControl _
                                        , .BookTrackDate = d.BookTrackDate _
                                        , .BookTrackContact = d.BookTrackContact _
                                        , .BookTrackComment = d.BookTrackComment _
                                        , .BookTrackStatus = d.BookTrackStatus _
                                        , .BookTrackModUser = Parameters.UserName _
                                        , .BookTrackModDate = Date.Now _
                                        , .BookTrackUpdated = If(d.BookTrackUpdated Is Nothing, New Byte() {}, d.BookTrackUpdated)})
        Return details.ToList()
    End Function

    Private Function getNewBookCodeValues(ByRef intCodeVal1 As Integer, ByRef intCodeVal2 As Integer) As Boolean
        Dim blnRet As Boolean = False
        Try
            intCodeVal1 = getScalarInteger("Select dbo.getLastBookCode1() as RetVal")
            intCodeVal2 = getScalarInteger("Select dbo.getLastBookCode2() as RetVal")
            intCodeVal2 = intCodeVal2 + 1
            If intCodeVal2 >= 255 Then
                intCodeVal2 = 33
                intCodeVal1 = intCodeVal1 + 1
                If intCodeVal1 = 160 Then intCodeVal1 = 161
                If intCodeVal1 = 173 Then intCodeVal1 = 174
            End If
            If intCodeVal1 > 255 Then
                Utilities.SaveAppError("E_MaxNbrOfBooks", Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_MaxNbrOfBooks"}, New FaultReason("E_CreateRecordFailure"))
            End If
            If intCodeVal2 < 40 Then intCodeVal2 = 40
            If intCodeVal2 = 45 Then intCodeVal2 = 46
            If intCodeVal2 > 96 And intCodeVal2 < 123 Then intCodeVal2 = 124
            If intCodeVal2 = 126 Then intCodeVal2 = 128
            If intCodeVal2 = 127 Then intCodeVal2 = 128
            If intCodeVal2 = 160 Then intCodeVal2 = 161
            If intCodeVal1 = 173 Then intCodeVal1 = 174
            blnRet = True
        Catch ex As FaultException
            Throw
        Catch ex As Exception
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
        End Try
        Return blnRet
    End Function

    Private Function GetCustAbrev(ByVal Control As Integer, _
                                 Optional ByVal UseCompNumber As Boolean = False) As String

        Dim strSQL As String = "Select dbo.comp.compabrev as RetVal " _
            & " From dbo.comp "
        If UseCompNumber Then
            strSQL &= " Where dbo.comp.compnumber = " & Control
        Else
            strSQL &= " Where dbo.comp.compcontrol = " & Control
        End If
        Return getScalarString(strSQL)

    End Function

    Public Function GetBookAddr(ByVal compNumber As Integer, ByVal OrderNumber As String, ByVal OrderSequenceNo As Integer) As DTO.BookAddr
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'first select the comp control
                Dim compDB As New NGLMASCompDataContext(ConnectionString)
                Dim compControl As Integer = 0
                Dim oitemComp As DTO.Comp = ( _
               From d In compDB.Comps Where d.CompNumber = compNumber _
                   Select New DTO.Comp With {.CompControl = d.CompControl}).Single

                'now select the address data.

                'Get the data
                Dim oitem As DTO.BookAddr = ( _
                From d In db.Books Where d.BookCustCompControl = oitemComp.CompControl And d.BookCarrOrderNumber = OrderNumber And d.BookOrderSequence = OrderSequenceNo _
                 Select New DTO.BookAddr With {.BookControl = d.BookControl, _
                                               .BookCustCompControl = d.BookCustCompControl, _
                                               .BookDestAddress1 = d.BookDestAddress1, _
                                               .BookDestAddress2 = d.BookDestAddress2, _
                                               .BookDestAddress3 = d.BookDestAddress3, _
                                               .BookDestCity = d.BookDestCity, _
                                               .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl.Value, 0), _
                                               .BookDestCountry = d.BookDestCountry, _
                                               .BookDestName = d.BookDestName, _
                                               .BookDestState = d.BookDestState, _
                                               .BookDestZip = d.BookDestZip, _
                                               .BookODControl = d.BookODControl, _
                                               .BookOrigAddress1 = d.BookOrigAddress1, _
                                               .BookOrigAddress2 = d.BookOrigAddress2, _
                                               .BookOrigAddress3 = d.BookOrigAddress3, _
                                               .BookOrigCity = d.BookOrigCity, _
                                               .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl.Value, 0), _
                                               .BookOrigCountry = d.BookOrigCountry, _
                                               .BookOrigName = d.BookOrigName, _
                                               .BookOrigState = d.BookOrigState, _
                                               .BookOrigZip = d.BookOrigZip}).Single

                Return oitem

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                ' Utilities.SaveAppError(ex.Message, Me.Parameters)
                'Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData"}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

#End Region

End Class

Public Class NGLBookItemData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.BookItems
        Me.LinqDB = db
    End Sub

#End Region


#Region " Properties "

    Protected Overrides Property LinqTable() As Object
        Get
            Dim db As New NGLMasBookDataContext(ConnectionString)
            Me.LinqTable = db.BookItems
            Me.LinqDB = db
            Return _LinqTable
        End Get
        Set(ByVal value As Object)
            _LinqTable = value
        End Set
    End Property

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GetBookItemFiltered(Control:=Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return GetBookItemsFiltered()
    End Function

    Public Function GetBookItemFiltered(Optional ByVal Control As Integer = 0) As DTO.BookItem
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Get the newest record that matches the provided criteria
                Dim BookItem As DTO.BookItem = ( _
                From d In db.BookItems _
                Where _
                    (d.BookItemControl = If(Control = 0, d.BookItemControl, Control)) _
                Order By d.BookItemControl Descending _
                Select New DTO.BookItem With {.BookItemControl = d.BookItemControl _
                                       , .BookItemBookLoadControl = d.BookItemBookLoadControl _
                                       , .BookItemFixOffInvAllow = If(d.BookItemFixOffInvAllow.HasValue, d.BookItemFixOffInvAllow, 0) _
                                       , .BookItemFixFrtAllow = If(d.BookItemFixFrtAllow.HasValue, d.BookItemFixFrtAllow, 0) _
                                       , .BookItemItemNumber = d.BookItemItemNumber _
                                       , .BookItemQtyOrdered = If(d.BookItemQtyOrdered.HasValue, d.BookItemQtyOrdered, 0) _
                                       , .BookItemFreightCost = If(d.BookItemFreightCost.HasValue, d.BookItemFreightCost, 0) _
                                       , .BookItemItemCost = If(d.BookItemItemCost.HasValue, d.BookItemItemCost, 0) _
                                       , .BookItemWeight = If(d.BookItemWeight.HasValue, d.BookItemWeight, 0) _
                                       , .BookItemCube = If(d.BookItemCube.HasValue, d.BookItemCube, 0) _
                                       , .BookItemPack = If(d.BookItemPack.HasValue, d.BookItemPack, 0) _
                                       , .BookItemSize = d.BookItemSize _
                                       , .BookItemDescription = d.BookItemDescription _
                                       , .BookItemHazmat = d.BookItemHazmat _
                                       , .BookItemModDate = d.BookItemModDate _
                                       , .BookItemModUser = d.BookItemModUser _
                                       , .BookItemBrand = d.BookItemBrand _
                                       , .BookItemCostCenter = d.BookItemCostCenter _
                                       , .BookItemLotNumber = d.BookItemLotNumber _
                                       , .BookItemLotExpirationDate = d.BookItemLotExpirationDate _
                                       , .BookItemGTIN = d.BookItemGTIN _
                                       , .BookCustItemNumber = d.BookCustItemNumber _
                                       , .BookItemBFC = If(d.BookItemBFC.HasValue, d.BookItemBFC, 0) _
                                       , .BookItemCountryOfOrigin = d.BookItemCountryOfOrigin _
                                       , .BookItemHST = d.BookItemHST _
                                       , .BookItemPalletTypeID = d.BookItemPalletTypeID _
                                        , .BookItemHazmatTypeCode = d.BookItemHazmatTypeCode _
                                        , .BookItem49CFRCode = d.BookItem49CFRCode _
                                        , .BookItemIATACode = d.BookItemIATACode _
                                        , .BookItemDOTCode = d.BookItemDOTCode _
                                        , .BookItemMarineCode = d.BookItemMarineCode _
                                        , .BookItemNMFCClass = d.BookItemNMFCClass _
                                        , .BookItemFAKClass = d.BookItemFAKClass _
                                        , .BookItemLimitedQtyFlag = d.BookItemLimitedQtyFlag _
                                        , .BookItemPallets = d.BookItemPallets _
                                        , .BookItemTies = d.BookItemTies _
                                        , .BookItemHighs = d.BookItemHighs _
                                        , .BookItemQtyPalletPercentage = d.BookItemQtyPalletPercentage _
                                        , .BookItemQtyLength = d.BookItemQtyLength _
                                        , .BookItemQtyWidth = d.BookItemQtyWidth _
                                        , .BookItemQtyHeight = d.BookItemQtyHeight _
                                        , .BookItemStackable = d.BookItemStackable _
                                        , .BookItemLevelOfDensity = d.BookItemLevelOfDensity _
                                       , .BookItemUpdated = d.BookItemUpdated.ToArray()}).First
                Return BookItem

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBookItemsFiltered(Optional ByVal BookLoadControl As Integer = 0) As DTO.BookItem()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'db.Log = New DebugTextWriter
                'If(d.BookItemFixOffInvAllow.HasValue, d.BookItemFixOffInvAllow, 0)
                'Return all the contacts that match the criteria sorted by name
                Dim BookItems() As DTO.BookItem = ( _
                From d In db.BookItems _
                Where _
                    (d.BookItemBookLoadControl = BookLoadControl) _
                Order By d.BookItemControl _
                Select New DTO.BookItem With {.BookItemControl = d.BookItemControl _
                                       , .BookItemBookLoadControl = d.BookItemBookLoadControl _
                                       , .BookItemFixOffInvAllow = If(d.BookItemFixOffInvAllow.HasValue, d.BookItemFixOffInvAllow, 0) _
                                       , .BookItemFixFrtAllow = If(d.BookItemFixFrtAllow.HasValue, d.BookItemFixFrtAllow, 0) _
                                       , .BookItemItemNumber = d.BookItemItemNumber _
                                       , .BookItemQtyOrdered = If(d.BookItemQtyOrdered.HasValue, d.BookItemQtyOrdered, 0) _
                                       , .BookItemFreightCost = If(d.BookItemFreightCost.HasValue, d.BookItemFreightCost, 0) _
                                       , .BookItemItemCost = If(d.BookItemItemCost.HasValue, d.BookItemItemCost, 0) _
                                       , .BookItemWeight = If(d.BookItemWeight.HasValue, d.BookItemWeight, 0) _
                                       , .BookItemCube = If(d.BookItemCube.HasValue, d.BookItemCube, 0) _
                                       , .BookItemPack = If(d.BookItemPack.HasValue, d.BookItemPack, 0) _
                                       , .BookItemSize = d.BookItemSize _
                                       , .BookItemDescription = d.BookItemDescription _
                                       , .BookItemHazmat = d.BookItemHazmat _
                                       , .BookItemModDate = d.BookItemModDate _
                                       , .BookItemModUser = d.BookItemModUser _
                                       , .BookItemBrand = d.BookItemBrand _
                                       , .BookItemCostCenter = d.BookItemCostCenter _
                                       , .BookItemLotNumber = d.BookItemLotNumber _
                                       , .BookItemLotExpirationDate = d.BookItemLotExpirationDate _
                                       , .BookItemGTIN = d.BookItemGTIN _
                                       , .BookCustItemNumber = d.BookCustItemNumber _
                                       , .BookItemBFC = If(d.BookItemBFC.HasValue, d.BookItemBFC, 0) _
                                       , .BookItemCountryOfOrigin = d.BookItemCountryOfOrigin _
                                       , .BookItemHST = d.BookItemHST _
                                       , .BookItemPalletTypeID = d.BookItemPalletTypeID _
                                        , .BookItemHazmatTypeCode = d.BookItemHazmatTypeCode _
                                        , .BookItem49CFRCode = d.BookItem49CFRCode _
                                        , .BookItemIATACode = d.BookItemIATACode _
                                        , .BookItemDOTCode = d.BookItemDOTCode _
                                        , .BookItemMarineCode = d.BookItemMarineCode _
                                        , .BookItemNMFCClass = d.BookItemNMFCClass _
                                        , .BookItemFAKClass = d.BookItemFAKClass _
                                        , .BookItemLimitedQtyFlag = d.BookItemLimitedQtyFlag _
                                        , .BookItemPallets = d.BookItemPallets _
                                        , .BookItemTies = d.BookItemTies _
                                        , .BookItemHighs = d.BookItemHighs _
                                        , .BookItemQtyPalletPercentage = d.BookItemQtyPalletPercentage _
                                        , .BookItemQtyLength = d.BookItemQtyLength _
                                        , .BookItemQtyWidth = d.BookItemQtyWidth _
                                        , .BookItemQtyHeight = d.BookItemQtyHeight _
                                        , .BookItemStackable = d.BookItemStackable _
                                        , .BookItemLevelOfDensity = d.BookItemLevelOfDensity _
                                       , .BookItemUpdated = d.BookItemUpdated.ToArray()}).ToArray()
                Return BookItems

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    'oBookLoadControls As List(Of Integer)


    Public Function GetBookItemsFiltered(ByVal oBookLoadControls As List(Of Integer)) As List(Of DTO.BookItem)
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Return all the contacts that match the criteria sorted by name
                Dim BookItems As List(Of DTO.BookItem) = ( _
                From d In db.BookItems _
                Where _
                    (oBookLoadControls.Contains(d.BookItemBookLoadControl)) _
                Order By d.BookItemControl _
                Select New DTO.BookItem With {.BookItemControl = d.BookItemControl _
                                       , .BookItemBookLoadControl = d.BookItemBookLoadControl _
                                       , .BookItemFixOffInvAllow = If(d.BookItemFixOffInvAllow.HasValue, d.BookItemFixOffInvAllow, 0) _
                                       , .BookItemFixFrtAllow = If(d.BookItemFixFrtAllow.HasValue, d.BookItemFixFrtAllow, 0) _
                                       , .BookItemItemNumber = d.BookItemItemNumber _
                                       , .BookItemQtyOrdered = If(d.BookItemQtyOrdered.HasValue, d.BookItemQtyOrdered, 0) _
                                       , .BookItemFreightCost = If(d.BookItemFreightCost.HasValue, d.BookItemFreightCost, 0) _
                                       , .BookItemItemCost = If(d.BookItemItemCost.HasValue, d.BookItemItemCost, 0) _
                                       , .BookItemWeight = If(d.BookItemWeight.HasValue, d.BookItemWeight, 0) _
                                       , .BookItemCube = If(d.BookItemCube.HasValue, d.BookItemCube, 0) _
                                       , .BookItemPack = If(d.BookItemPack.HasValue, d.BookItemPack, 0) _
                                       , .BookItemSize = d.BookItemSize _
                                       , .BookItemDescription = d.BookItemDescription _
                                       , .BookItemHazmat = d.BookItemHazmat _
                                       , .BookItemModDate = d.BookItemModDate _
                                       , .BookItemModUser = d.BookItemModUser _
                                       , .BookItemBrand = d.BookItemBrand _
                                       , .BookItemCostCenter = d.BookItemCostCenter _
                                       , .BookItemLotNumber = d.BookItemLotNumber _
                                       , .BookItemLotExpirationDate = d.BookItemLotExpirationDate _
                                       , .BookItemGTIN = d.BookItemGTIN _
                                       , .BookCustItemNumber = d.BookCustItemNumber _
                                       , .BookItemBFC = If(d.BookItemBFC.HasValue, d.BookItemBFC, 0) _
                                       , .BookItemCountryOfOrigin = d.BookItemCountryOfOrigin _
                                       , .BookItemHST = d.BookItemHST _
                                       , .BookItemPalletTypeID = d.BookItemPalletTypeID _
                                        , .BookItemHazmatTypeCode = d.BookItemHazmatTypeCode _
                                        , .BookItem49CFRCode = d.BookItem49CFRCode _
                                        , .BookItemIATACode = d.BookItemIATACode _
                                        , .BookItemDOTCode = d.BookItemDOTCode _
                                        , .BookItemMarineCode = d.BookItemMarineCode _
                                        , .BookItemNMFCClass = d.BookItemNMFCClass _
                                        , .BookItemFAKClass = d.BookItemFAKClass _
                                        , .BookItemLimitedQtyFlag = d.BookItemLimitedQtyFlag _
                                        , .BookItemPallets = d.BookItemPallets _
                                        , .BookItemTies = d.BookItemTies _
                                        , .BookItemHighs = d.BookItemHighs _
                                        , .BookItemQtyPalletPercentage = d.BookItemQtyPalletPercentage _
                                        , .BookItemQtyLength = d.BookItemQtyLength _
                                        , .BookItemQtyWidth = d.BookItemQtyWidth _
                                        , .BookItemQtyHeight = d.BookItemQtyHeight _
                                        , .BookItemStackable = d.BookItemStackable _
                                        , .BookItemLevelOfDensity = d.BookItemLevelOfDensity _
                                       , .BookItemUpdated = d.BookItemUpdated.ToArray()}).ToList()
                Return BookItems

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using

    End Function

#End Region

#Region "Protected Functions"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Dim d = CType(oData, DTO.BookItem)
        'Create New Record
        Return New LTS.BookItem With {.BookItemControl = d.BookItemControl _
                                       , .BookItemBookLoadControl = d.BookItemBookLoadControl _
                                       , .BookItemFixOffInvAllow = d.BookItemFixOffInvAllow _
                                       , .BookItemFixFrtAllow = d.BookItemFixFrtAllow _
                                       , .BookItemItemNumber = d.BookItemItemNumber _
                                       , .BookItemQtyOrdered = d.BookItemQtyOrdered _
                                       , .BookItemFreightCost = d.BookItemFreightCost _
                                       , .BookItemItemCost = d.BookItemItemCost _
                                       , .BookItemWeight = d.BookItemWeight _
                                       , .BookItemCube = d.BookItemCube _
                                       , .BookItemPack = d.BookItemPack _
                                       , .BookItemSize = d.BookItemSize _
                                       , .BookItemDescription = d.BookItemDescription _
                                       , .BookItemHazmat = d.BookItemHazmat _
                                       , .BookItemModDate = Date.Now _
                                       , .BookItemModUser = Parameters.UserName _
                                       , .BookItemBrand = d.BookItemBrand _
                                       , .BookItemCostCenter = d.BookItemCostCenter _
                                       , .BookItemLotNumber = d.BookItemLotNumber _
                                       , .BookItemLotExpirationDate = d.BookItemLotExpirationDate _
                                       , .BookItemGTIN = d.BookItemGTIN _
                                       , .BookCustItemNumber = d.BookCustItemNumber _
                                       , .BookItemBFC = d.BookItemBFC _
                                       , .BookItemCountryOfOrigin = d.BookItemCountryOfOrigin _
                                       , .BookItemHST = d.BookItemHST _
                                       , .BookItemPalletTypeID = d.BookItemPalletTypeID _
                                        , .BookItemHazmatTypeCode = d.BookItemHazmatTypeCode _
                                        , .BookItem49CFRCode = d.BookItem49CFRCode _
                                        , .BookItemIATACode = d.BookItemIATACode _
                                        , .BookItemDOTCode = d.BookItemDOTCode _
                                        , .BookItemMarineCode = d.BookItemMarineCode _
                                        , .BookItemNMFCClass = d.BookItemNMFCClass _
                                        , .BookItemFAKClass = d.BookItemFAKClass _
                                        , .BookItemLimitedQtyFlag = d.BookItemLimitedQtyFlag _
                                        , .BookItemPallets = d.BookItemPallets _
                                        , .BookItemTies = d.BookItemTies _
                                        , .BookItemHighs = d.BookItemHighs _
                                        , .BookItemQtyPalletPercentage = d.BookItemQtyPalletPercentage _
                                        , .BookItemQtyLength = d.BookItemQtyLength _
                                        , .BookItemQtyWidth = d.BookItemQtyWidth _
                                        , .BookItemQtyHeight = d.BookItemQtyHeight _
                                        , .BookItemStackable = d.BookItemStackable _
                                        , .BookItemLevelOfDensity = d.BookItemLevelOfDensity _
                                       , .BookItemUpdated = If(d.BookItemUpdated Is Nothing, New Byte() {}, d.BookItemUpdated)}
    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Dim oData As LTS.BookItem = TryCast(LinqTable, LTS.BookItem)
        If oData Is Nothing Then Return Nothing
        Dim blnRet As Boolean = (New NGLBatchProcessDataProvider(Me.Parameters).UpdateBookItemTotals2Way(oData.BookItemBookLoadControl))
        Return GetBookItemFiltered(Control:=oData.BookItemControl)
    End Function

    Protected Overrides Sub NoReturnCleanUp(ByVal LinqTable As Object)
        Dim oData As LTS.BookItem = TryCast(LinqTable, LTS.BookItem)
        If Not oData Is Nothing Then
            Dim blnRet As Boolean = (New NGLBatchProcessDataProvider(Me.Parameters).UpdateBookItemTotals2Way(oData.BookItemBookLoadControl))
        End If
    End Sub

    Protected Overrides Sub DeleteCleanUp(ByVal LinqTable As Object)
        Dim oData As LTS.BookItem = TryCast(LinqTable, LTS.BookItem)
        If Not oData Is Nothing Then
            Dim blnRet As Boolean = (New NGLBatchProcessDataProvider(Me.Parameters).UpdateBookItemTotals2Way(oData.BookItemBookLoadControl))
        End If
    End Sub

    Protected Overrides Function GetQuickSaveResults(ByVal LinqTable As Object) As DataTransferObjects.QuickSaveResults
        Dim ret As DTO.QuickSaveResults
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim source As LTS.BookItem = TryCast(LinqTable, LTS.BookItem)
                If source Is Nothing Then Return Nothing
                Dim blnRet As Boolean = (New NGLBatchProcessDataProvider(Me.Parameters).UpdateBookItemTotals2Way(source.BookItemBookLoadControl))
                ret = (From d In db.BookItems _
                       Where d.BookItemControl = source.BookItemControl _
                       Select New DTO.QuickSaveResults With {.Control = d.BookItemControl _
                                                            , .ModDate = d.BookItemModDate _
                                                            , .ModUser = d.BookItemModUser _
                                                            , .Updated = d.BookItemUpdated.ToArray}).First
            Catch ex As FaultException(Of SqlFaultInfo)
                Throw
            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

        End Using
        Return ret
    End Function

#End Region

End Class

Public Class NGLBookTrackData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.BookTracks
        Me.LinqDB = db
    End Sub

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GetBookTrackFiltered(Control:=Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return GetBookTracksFiltered()
    End Function

    Public Function GetBookTrackFiltered(Optional ByVal Control As Integer = 0) As DTO.BookTrack
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Get the newest record that matches the provided criteria
                Dim BookTrack As DTO.BookTrack = ( _
                From d In db.BookTracks _
                Where _
                    (d.BookTrackControl = If(Control = 0, d.BookTrackControl, Control)) _
                Order By d.BookTrackControl Descending _
                Select New DTO.BookTrack With {.BookTrackControl = d.BookTrackControl _
                                        , .BookTrackBookControl = d.BookTrackBookControl _
                                        , .BookTrackDate = d.BookTrackDate _
                                        , .BookTrackContact = d.BookTrackContact _
                                        , .BookTrackComment = d.BookTrackComment _
                                        , .BookTrackStatus = If(d.BookTrackStatus.HasValue, d.BookTrackStatus, 0) _
                                        , .BookTrackModDate = d.BookTrackModDate _
                                        , .BookTrackModUser = d.BookTrackModUser _
                                        , .BookTrackUpdated = d.BookTrackUpdated.ToArray()}).First
                Return BookTrack

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBookTracksFiltered(Optional ByVal BookControl As Integer = 0) As DTO.BookTrack()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'db.Log = New DebugTextWriter
                'Return all the contacts that match the criteria sorted by name
                Dim BookTracks() As DTO.BookTrack = ( _
                From d In db.BookTracks _
                Where _
                    (d.BookTrackBookControl = If(BookControl = 0, d.BookTrackBookControl, BookControl)) _
                Order By d.BookTrackDate Descending _
                Select New DTO.BookTrack With {.BookTrackControl = d.BookTrackControl _
                                        , .BookTrackBookControl = d.BookTrackBookControl _
                                        , .BookTrackDate = d.BookTrackDate _
                                        , .BookTrackContact = d.BookTrackContact _
                                        , .BookTrackComment = d.BookTrackComment _
                                        , .BookTrackStatus = If(d.BookTrackStatus.HasValue, d.BookTrackStatus, 0) _
                                        , .BookTrackModDate = d.BookTrackModDate _
                                        , .BookTrackModUser = d.BookTrackModUser _
                                        , .BookTrackUpdated = d.BookTrackUpdated.ToArray()}).ToArray()
                Return BookTracks

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBookTracksFiltered(ByVal BookControl As Integer, ByVal ModUser As String) As DTO.BookTrack()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                If String.IsNullOrEmpty(ModUser) Then Return Nothing

                'db.Log = New DebugTextWriter
                'Return all the contacts that match the criteria sorted by name
                Dim BookTracks() As DTO.BookTrack = ( _
                From d In db.BookTracks _
                Where _
                    (d.BookTrackBookControl = If(BookControl = 0, d.BookTrackBookControl, BookControl)) And d.BookTrackModUser.ToUpper().Equals(ModUser.ToUpper()) _
                Order By d.BookTrackDate Descending _
                Select New DTO.BookTrack With {.BookTrackControl = d.BookTrackControl _
                                        , .BookTrackBookControl = d.BookTrackBookControl _
                                        , .BookTrackDate = d.BookTrackDate _
                                        , .BookTrackContact = d.BookTrackContact _
                                        , .BookTrackComment = d.BookTrackComment _
                                        , .BookTrackStatus = If(d.BookTrackStatus.HasValue, d.BookTrackStatus, 0) _
                                        , .BookTrackModDate = d.BookTrackModDate _
                                        , .BookTrackModUser = d.BookTrackModUser _
                                        , .BookTrackUpdated = d.BookTrackUpdated.ToArray()}).ToArray()
                Return BookTracks

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

#End Region

#Region "Protected Functions"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Dim d = CType(oData, DTO.BookTrack)
        'Create New Record
        Return New LTS.BookTrack With {.BookTrackControl = d.BookTrackControl _
                                        , .BookTrackBookControl = d.BookTrackBookControl _
                                        , .BookTrackDate = d.BookTrackDate _
                                        , .BookTrackContact = d.BookTrackContact _
                                        , .BookTrackComment = d.BookTrackComment _
                                        , .BookTrackStatus = d.BookTrackStatus _
                                        , .BookTrackModUser = Parameters.UserName _
                                        , .BookTrackModDate = Date.Now _
                                        , .BookTrackUpdated = If(d.BookTrackUpdated Is Nothing, New Byte() {}, d.BookTrackUpdated)}
    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Return GetBookTrackFiltered(Control:=CType(LinqTable, LTS.BookTrack).BookTrackControl)
    End Function

    Protected Overrides Function GetQuickSaveResults(ByVal LinqTable As Object) As DataTransferObjects.QuickSaveResults
        Dim ret As DTO.QuickSaveResults
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim source As LTS.BookTrack = TryCast(LinqTable, LTS.BookTrack)
                If source Is Nothing Then Return Nothing

                ret = (From d In db.BookTracks _
                       Where d.BookTrackControl = source.BookTrackControl _
                       Select New DTO.QuickSaveResults With {.Control = d.BookTrackControl _
                                                            , .ModDate = d.BookTrackModDate _
                                                            , .ModUser = d.BookTrackModUser _
                                                            , .Updated = d.BookTrackUpdated.ToArray}).First

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

        End Using
        Return ret
    End Function


#End Region

End Class

Public Class NGLBookNoteData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.BookNotes
        Me.LinqDB = db
    End Sub

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GetBookNoteFiltered(Control:=Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return GetBookNotesFiltered()
    End Function

    Public Function GetBookNoteFiltered(Optional ByVal Control As Integer = 0) As DTO.BookNote
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Get the newest record that matches the provided criteria
                Dim BookNote As DTO.BookNote = ( _
                From d In db.BookNotes _
                Where _
                    (d.BookNotesControl = If(Control = 0, d.BookNotesControl, Control)) _
                Order By d.BookNotesControl Descending _
                Select New DTO.BookNote With {.BookNotesControl = d.BookNotesControl _
                                        , .BookNotesBookControl = d.BookNotesBookControl _
                                        , .BookNotesVisable1 = d.BookNotesVisable1 _
                                        , .BookNotesVisable2 = d.BookNotesVisable2 _
                                        , .BookNotesVisable3 = d.BookNotesVisable3 _
                                        , .BookNotesVisable4 = d.BookNotesVisable4 _
                                        , .BookNotesVisable5 = d.BookNotesVisable5 _
                                        , .BookNotesConfidential1 = d.BookNotesConfidential1 _
                                        , .BookNotesConfidential2 = d.BookNotesConfidential2 _
                                        , .BookNotesConfidential3 = d.BookNotesConfidential3 _
                                        , .BookNotesConfidential4 = d.BookNotesConfidential4 _
                                        , .BookNotesConfidential5 = d.BookNotesConfidential5 _
                                        , .BookNotesModDate = d.BookNotesModDate _
                                        , .BookNotesModUser = d.BookNotesModUser _
                                        , .BookNotesUpdated = d.BookNotesUpdated.ToArray()}).First
                Return BookNote

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBookNotesFiltered(Optional ByVal BookControl As Integer = 0) As DTO.BookNote()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Return all the contacts that match the criteria sorted by name
                Dim BookNotes() As DTO.BookNote = ( _
                From d In db.BookNotes _
                Where _
                    (d.BookNotesBookControl = If(BookControl = 0, d.BookNotesBookControl, BookControl)) _
                Order By d.BookNotesControl _
                Select New DTO.BookNote With {.BookNotesControl = d.BookNotesControl _
                                        , .BookNotesBookControl = d.BookNotesBookControl _
                                        , .BookNotesVisable1 = d.BookNotesVisable1 _
                                        , .BookNotesVisable2 = d.BookNotesVisable2 _
                                        , .BookNotesVisable3 = d.BookNotesVisable3 _
                                        , .BookNotesVisable4 = d.BookNotesVisable4 _
                                        , .BookNotesVisable5 = d.BookNotesVisable5 _
                                        , .BookNotesConfidential1 = d.BookNotesConfidential1 _
                                        , .BookNotesConfidential2 = d.BookNotesConfidential2 _
                                        , .BookNotesConfidential3 = d.BookNotesConfidential3 _
                                        , .BookNotesConfidential4 = d.BookNotesConfidential4 _
                                        , .BookNotesConfidential5 = d.BookNotesConfidential5 _
                                        , .BookNotesModDate = d.BookNotesModDate _
                                        , .BookNotesModUser = d.BookNotesModUser _
                                        , .BookNotesUpdated = d.BookNotesUpdated.ToArray()}).ToArray()
                Return BookNotes

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

#End Region

#Region "Protected Functions"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Dim d = CType(oData, DTO.BookNote)
        'Create New Record
        Return New LTS.BookNote With {.BookNotesControl = d.BookNotesControl _
                                        , .BookNotesBookControl = d.BookNotesBookControl _
                                        , .BookNotesVisable1 = d.BookNotesVisable1 _
                                        , .BookNotesVisable2 = d.BookNotesVisable2 _
                                        , .BookNotesVisable3 = d.BookNotesVisable3 _
                                        , .BookNotesVisable4 = d.BookNotesVisable4 _
                                        , .BookNotesVisable5 = d.BookNotesVisable5 _
                                        , .BookNotesConfidential1 = d.BookNotesConfidential1 _
                                        , .BookNotesConfidential2 = d.BookNotesConfidential2 _
                                        , .BookNotesConfidential3 = d.BookNotesConfidential3 _
                                        , .BookNotesConfidential4 = d.BookNotesConfidential4 _
                                        , .BookNotesConfidential5 = d.BookNotesConfidential5 _
                                        , .BookNotesModDate = Date.Now _
                                        , .BookNotesModUser = Parameters.UserName _
                                        , .BookNotesUpdated = If(d.BookNotesUpdated Is Nothing, New Byte() {}, d.BookNotesUpdated)}
    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Return GetBookNoteFiltered(Control:=CType(LinqTable, LTS.BookNote).BookNotesControl)
    End Function

    Protected Overrides Function GetQuickSaveResults(ByVal LinqTable As Object) As DataTransferObjects.QuickSaveResults
        Dim ret As DTO.QuickSaveResults
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim source As LTS.BookNote = TryCast(LinqTable, LTS.BookNote)
                If source Is Nothing Then Return Nothing

                ret = (From d In db.BookNotes _
                       Where d.BookNotesControl = source.BookNotesControl _
                       Select New DTO.QuickSaveResults With {.Control = d.BookNotesControl _
                                                            , .ModDate = d.BookNotesModDate _
                                                            , .ModUser = d.BookNotesModUser _
                                                            , .Updated = d.BookNotesUpdated.ToArray}).First

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

        End Using
        Return ret
    End Function

#End Region

End Class

Public Class NGLBookLoadData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.BookLoads
        Me.LinqDB = db
    End Sub

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GetBookLoadFiltered(Control:=Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return GetBookLoadsFiltered()
    End Function
    ''' <summary>
    ''' 
    ''' </summary>
    ''' <param name="Control"></param>
    ''' <returns></returns>
    ''' <remarks>
    ''' Modified by RHR v-5.1.3 7/1/11 removed BookItems data.  We now leave this list empty
    ''' because the maximum allowed durring a save is a little over 50 records (WCF Error 400 issue)
    ''' </remarks>
    Public Function GetBookLoadFiltered(Optional ByVal Control As Integer = 0) As DTO.BookLoad
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Dim oDLO As New DataLoadOptions
                'oDLO.LoadWith(Of LTS.BookLoad)(Function(t As LTS.BookLoad) t.BookItems)
                'db.LoadOptions = oDLO
                'Get the newest record that matches the provided criteria
                'Dim BookLoad As DTO.BookLoad = ( _
                'From d In db.BookLoads _
                'Where _
                '    (d.BookLoadControl = If(Control = 0, d.BookLoadControl, Control)) _
                'Order By d.BookLoadControl Descending _
                'Select New DTO.BookLoad With {.BookLoadControl = d.BookLoadControl _
                '                          , .BookLoadBookControl = d.BookLoadBookControl _
                '                          , .BookLoadBuy = d.BookLoadBuy _
                '                          , .BookLoadPONumber = d.BookLoadPONumber _
                '                          , .BookLoadVendor = d.BookLoadVendor _
                '                          , .BookLoadCaseQty = If(d.BookLoadCaseQty.HasValue, d.BookLoadCaseQty, 0) _
                '                          , .BookLoadWgt = If(d.BookLoadWgt.HasValue, d.BookLoadWgt, 0) _
                '                          , .BookLoadCube = If(d.BookLoadCube.HasValue, d.BookLoadCube, 0) _
                '                          , .BookLoadPL = If(d.BookLoadPL.HasValue, d.BookLoadPL, 0) _
                '                          , .BookLoadPX = If(d.BookLoadPX.HasValue, d.BookLoadPX, 0) _
                '                          , .BookLoadPType = d.BookLoadPType _
                '                          , .BookLoadCom =  d.BookLoadCom _
                '                          , .BookLoadPUOrigin = d.BookLoadPUOrigin _
                '                          , .BookLoadBFC = If(d.BookLoadBFC.HasValue, d.BookLoadBFC, 0) _
                '                          , .BookLoadTotCost = If(d.BookLoadTotCost.HasValue, d.BookLoadTotCost, 0) _
                '                          , .BookLoadComments = d.BookLoadComments _
                '                          , .BookLoadStopSeq = If(d.BookLoadStopSeq.HasValue, d.BookLoadStopSeq, 0) _
                '                          , .BookLoadModDate = d.BookLoadModDate _
                '                          , .BookLoadModUser = d.BookLoadModUser _
                '                          , .BookLoadUpdated = d.BookLoadUpdated.ToArray() _
                '                          , .BookItems = ( _
                '                                From i In d.BookItems _
                '                                Select New DTO.BookItem With {.BookItemControl = i.BookItemControl _
                '                               , .BookItemBookLoadControl = i.BookItemBookLoadControl _
                '                               , .BookItemFixOffInvAllow = If(i.BookItemFixOffInvAllow.HasValue, i.BookItemFixOffInvAllow, 0) _
                '                               , .BookItemFixFrtAllow = If(i.BookItemFixFrtAllow.HasValue, i.BookItemFixFrtAllow, 0) _
                '                               , .BookItemItemNumber = i.BookItemItemNumber _
                '                               , .BookItemQtyOrdered = If(i.BookItemQtyOrdered.HasValue, i.BookItemQtyOrdered, 0) _
                '                               , .BookItemFreightCost = If(i.BookItemFreightCost.HasValue, i.BookItemFreightCost, 0) _
                '                               , .BookItemItemCost = If(i.BookItemItemCost.HasValue, i.BookItemItemCost, 0) _
                '                               , .BookItemWeight = If(i.BookItemWeight.HasValue, i.BookItemWeight, 0) _
                '                               , .BookItemCube = If(i.BookItemCube.HasValue, i.BookItemCube, 0) _
                '                               , .BookItemPack = If(i.BookItemPack.HasValue, i.BookItemPack, 0) _
                '                               , .BookItemSize = i.BookItemSize _
                '                               , .BookItemDescription = i.BookItemDescription _
                '                               , .BookItemHazmat = i.BookItemHazmat _
                '                               , .BookItemModDate = i.BookItemModDate _
                '                               , .BookItemModUser = i.BookItemModUser _
                '                               , .BookItemBrand = i.BookItemBrand _
                '                               , .BookItemCostCenter = i.BookItemCostCenter _
                '                               , .BookItemLotNumber = i.BookItemLotNumber _
                '                               , .BookItemLotExpirationDate = i.BookItemLotExpirationDate _
                '                               , .BookItemGTIN = i.BookItemGTIN _
                '                               , .BookCustItemNumber = i.BookCustItemNumber _
                '                               , .BookItemBFC = If(i.BookItemBFC.HasValue, i.BookItemBFC, 0) _
                '                               , .BookItemCountryOfOrigin = i.BookItemCountryOfOrigin _
                '                               , .BookItemHST = i.BookItemHST _
                '                               , .BookItemPalletTypeID = i.BookItemPalletTypeID _
                '                               , .BookItemUpdated = i.BookItemUpdated.ToArray()}).ToList() _
                '                        }).First

                Dim BookLoad As DTO.BookLoad = ( _
                From d In db.BookLoads _
                Where _
                    (d.BookLoadControl = If(Control = 0, d.BookLoadControl, Control)) _
                Order By d.BookLoadControl Descending _
                Select New DTO.BookLoad With {.BookLoadControl = d.BookLoadControl _
                                          , .BookLoadBookControl = d.BookLoadBookControl _
                                          , .BookLoadBuy = d.BookLoadBuy _
                                          , .BookLoadPONumber = d.BookLoadPONumber _
                                          , .BookLoadVendor = d.BookLoadVendor _
                                          , .BookLoadCaseQty = If(d.BookLoadCaseQty.HasValue, d.BookLoadCaseQty, 0) _
                                          , .BookLoadWgt = If(d.BookLoadWgt.HasValue, d.BookLoadWgt, 0) _
                                          , .BookLoadCube = If(d.BookLoadCube.HasValue, d.BookLoadCube, 0) _
                                          , .BookLoadPL = If(d.BookLoadPL.HasValue, d.BookLoadPL, 0) _
                                          , .BookLoadPX = If(d.BookLoadPX.HasValue, d.BookLoadPX, 0) _
                                          , .BookLoadPType = d.BookLoadPType _
                                          , .BookLoadCom = d.BookLoadCom _
                                          , .BookLoadPUOrigin = d.BookLoadPUOrigin _
                                          , .BookLoadBFC = If(d.BookLoadBFC.HasValue, d.BookLoadBFC, 0) _
                                          , .BookLoadTotCost = If(d.BookLoadTotCost.HasValue, d.BookLoadTotCost, 0) _
                                          , .BookLoadComments = d.BookLoadComments _
                                          , .BookLoadStopSeq = If(d.BookLoadStopSeq.HasValue, d.BookLoadStopSeq, 0) _
                                          , .BookLoadModDate = d.BookLoadModDate _
                                          , .BookLoadModUser = d.BookLoadModUser _
                                          , .BookLoadUpdated = d.BookLoadUpdated.ToArray()}).First

                Return BookLoad

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary>
    ''' 
    ''' </summary>
    ''' <param name="BookControl"></param>
    ''' <returns></returns>
    ''' <remarks>
    ''' Modified by RHR v-5.1.3 7/1/11 removed BookItems data.  We now leave this list empty
    ''' because the maximum allowed durring a save is a little over 50 records (WCF Error 400 issue)
    ''' </remarks>
    Public Function GetBookLoadsFiltered(Optional ByVal BookControl As Integer = 0) As DTO.BookLoad()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Dim oDLO As New DataLoadOptions
                'oDLO.LoadWith(Of LTS.BookLoad)(Function(t As LTS.BookLoad) t.BookItems)
                'db.LoadOptions = oDLO
                'Return all the contacts that match the criteria sorted by name
                'Dim BookLoads() As DTO.BookLoad = ( _
                'From d In db.BookLoads _
                'Where _
                '    (d.BookLoadBookControl = If(BookControl = 0, d.BookLoadBookControl, BookControl)) _
                'Order By d.BookLoadControl _
                'Select New DTO.BookLoad With {.BookLoadControl = d.BookLoadControl _
                '                          , .BookLoadBookControl = d.BookLoadBookControl _
                '                          , .BookLoadBuy = d.BookLoadBuy _
                '                          , .BookLoadPONumber = d.BookLoadPONumber _
                '                          , .BookLoadVendor = d.BookLoadVendor _
                '                          , .BookLoadCaseQty = If(d.BookLoadCaseQty.HasValue, d.BookLoadCaseQty, 0) _
                '                          , .BookLoadWgt = If(d.BookLoadWgt.HasValue, d.BookLoadWgt, 0) _
                '                          , .BookLoadCube = If(d.BookLoadCube.HasValue, d.BookLoadCube, 0) _
                '                          , .BookLoadPL = If(d.BookLoadPL.HasValue, d.BookLoadPL, 0) _
                '                          , .BookLoadPX = If(d.BookLoadPX.HasValue, d.BookLoadPX, 0) _
                '                          , .BookLoadPType = d.BookLoadPType _
                '                          , .BookLoadCom = d.BookLoadCom _
                '                          , .BookLoadPUOrigin = d.BookLoadPUOrigin _
                '                          , .BookLoadBFC = If(d.BookLoadBFC.HasValue, d.BookLoadBFC, 0) _
                '                          , .BookLoadTotCost = If(d.BookLoadTotCost.HasValue, d.BookLoadTotCost, 0) _
                '                          , .BookLoadComments = d.BookLoadComments _
                '                          , .BookLoadStopSeq = If(d.BookLoadStopSeq.HasValue, d.BookLoadStopSeq, 0) _
                '                          , .BookLoadModDate = d.BookLoadModDate _
                '                          , .BookLoadModUser = d.BookLoadModUser _
                '                          , .BookLoadUpdated = d.BookLoadUpdated.ToArray() _
                '                          , .BookItems = ( _
                '                                From i In d.BookItems _
                '                                Select New DTO.BookItem With {.BookItemControl = i.BookItemControl _
                '                               , .BookItemBookLoadControl = i.BookItemBookLoadControl _
                '                               , .BookItemFixOffInvAllow = If(i.BookItemFixOffInvAllow.HasValue, i.BookItemFixOffInvAllow, 0) _
                '                               , .BookItemFixFrtAllow = If(i.BookItemFixFrtAllow.HasValue, i.BookItemFixFrtAllow, 0) _
                '                               , .BookItemItemNumber = i.BookItemItemNumber _
                '                               , .BookItemQtyOrdered = If(i.BookItemQtyOrdered.HasValue, i.BookItemQtyOrdered, 0) _
                '                               , .BookItemFreightCost = If(i.BookItemFreightCost.HasValue, i.BookItemFreightCost, 0) _
                '                               , .BookItemItemCost = If(i.BookItemItemCost.HasValue, i.BookItemItemCost, 0) _
                '                               , .BookItemWeight = If(i.BookItemWeight.HasValue, i.BookItemWeight, 0) _
                '                               , .BookItemCube = If(i.BookItemCube.HasValue, i.BookItemCube, 0) _
                '                               , .BookItemPack = If(i.BookItemPack.HasValue, i.BookItemPack, 0) _
                '                               , .BookItemSize = i.BookItemSize _
                '                               , .BookItemDescription = i.BookItemDescription _
                '                               , .BookItemHazmat = i.BookItemHazmat _
                '                               , .BookItemModDate = i.BookItemModDate _
                '                               , .BookItemModUser = i.BookItemModUser _
                '                               , .BookItemBrand = i.BookItemBrand _
                '                               , .BookItemCostCenter = i.BookItemCostCenter _
                '                               , .BookItemLotNumber = i.BookItemLotNumber _
                '                               , .BookItemLotExpirationDate = i.BookItemLotExpirationDate _
                '                               , .BookItemGTIN = i.BookItemGTIN _
                '                               , .BookCustItemNumber = i.BookCustItemNumber _
                '                               , .BookItemBFC = If(i.BookItemBFC.HasValue, i.BookItemBFC, 0) _
                '                               , .BookItemCountryOfOrigin = i.BookItemCountryOfOrigin _
                '                               , .BookItemHST = i.BookItemHST _
                '                               , .BookItemPalletTypeID = i.BookItemPalletTypeID _
                '                               , .BookItemUpdated = i.BookItemUpdated.ToArray()}).ToList() _
                '                        }).ToArray()
                Dim BookLoads() As DTO.BookLoad = ( _
                From d In db.BookLoads _
                Where _
                   (d.BookLoadBookControl = If(BookControl = 0, d.BookLoadBookControl, BookControl)) _
                Order By d.BookLoadControl _
                Select New DTO.BookLoad With {.BookLoadControl = d.BookLoadControl _
                                         , .BookLoadBookControl = d.BookLoadBookControl _
                                         , .BookLoadBuy = d.BookLoadBuy _
                                         , .BookLoadPONumber = d.BookLoadPONumber _
                                         , .BookLoadVendor = d.BookLoadVendor _
                                         , .BookLoadCaseQty = If(d.BookLoadCaseQty.HasValue, d.BookLoadCaseQty, 0) _
                                         , .BookLoadWgt = If(d.BookLoadWgt.HasValue, d.BookLoadWgt, 0) _
                                         , .BookLoadCube = If(d.BookLoadCube.HasValue, d.BookLoadCube, 0) _
                                         , .BookLoadPL = If(d.BookLoadPL.HasValue, d.BookLoadPL, 0) _
                                         , .BookLoadPX = If(d.BookLoadPX.HasValue, d.BookLoadPX, 0) _
                                         , .BookLoadPType = d.BookLoadPType _
                                         , .BookLoadCom = d.BookLoadCom _
                                         , .BookLoadPUOrigin = d.BookLoadPUOrigin _
                                         , .BookLoadBFC = If(d.BookLoadBFC.HasValue, d.BookLoadBFC, 0) _
                                         , .BookLoadTotCost = If(d.BookLoadTotCost.HasValue, d.BookLoadTotCost, 0) _
                                         , .BookLoadComments = d.BookLoadComments _
                                         , .BookLoadStopSeq = If(d.BookLoadStopSeq.HasValue, d.BookLoadStopSeq, 0) _
                                         , .BookLoadModDate = d.BookLoadModDate _
                                         , .BookLoadModUser = d.BookLoadModUser _
                                         , .BookLoadUpdated = d.BookLoadUpdated.ToArray()}).ToArray()


                Return BookLoads

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

#End Region

#Region "Protected Functions"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Dim d = CType(oData, DTO.BookLoad)
        'Create New Record
        Return New LTS.BookLoad With {.BookLoadControl = d.BookLoadControl _
                                          , .BookLoadBookControl = d.BookLoadBookControl _
                                          , .BookLoadBuy = d.BookLoadBuy _
                                          , .BookLoadPONumber = d.BookLoadPONumber _
                                          , .BookLoadVendor = d.BookLoadVendor _
                                          , .BookLoadCaseQty = d.BookLoadCaseQty _
                                          , .BookLoadWgt = d.BookLoadWgt _
                                          , .BookLoadCube = d.BookLoadCube _
                                          , .BookLoadPL = d.BookLoadPL _
                                          , .BookLoadPX = d.BookLoadPX _
                                          , .BookLoadPType = d.BookLoadPType _
                                          , .BookLoadCom = d.BookLoadCom _
                                          , .BookLoadPUOrigin = d.BookLoadPUOrigin _
                                          , .BookLoadBFC = d.BookLoadBFC _
                                          , .BookLoadTotCost = d.BookLoadTotCost _
                                          , .BookLoadComments = d.BookLoadComments _
                                          , .BookLoadStopSeq = d.BookLoadStopSeq _
                                          , .BookLoadModDate = Date.Now _
                                          , .BookLoadModUser = Parameters.UserName _
                                          , .BookLoadUpdated = If(d.BookLoadUpdated Is Nothing, New Byte() {}, d.BookLoadUpdated)}
    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Dim oData As LTS.BookLoad = TryCast(LinqTable, LTS.BookLoad)
        If oData Is Nothing Then
            Return Nothing
        End If
        Dim blnRet As Boolean = (New NGLBatchProcessDataProvider(Me.Parameters).UpdateBookItemTotals2Way(oData.BookLoadControl))
        Return GetBookLoadFiltered(Control:=oData.BookLoadControl)
    End Function

    Protected Overrides Sub NoReturnCleanUp(ByVal LinqTable As Object)
        Dim oData As LTS.BookLoad = TryCast(LinqTable, LTS.BookLoad)
        If Not oData Is Nothing Then
            Dim blnRet As Boolean = (New NGLBatchProcessDataProvider(Me.Parameters).UpdateBookItemTotals2Way(oData.BookLoadControl))
        End If
    End Sub

    Protected Overrides Function GetQuickSaveResults(ByVal LinqTable As Object) As DataTransferObjects.QuickSaveResults
        Dim ret As DTO.QuickSaveResults
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim source As LTS.BookLoad = TryCast(LinqTable, LTS.BookLoad)
                If source Is Nothing Then Return Nothing
                Dim blnRet As Boolean = (New NGLBatchProcessDataProvider(Me.Parameters).UpdateBookItemTotals2Way(source.BookLoadControl))
                ret = (From d In db.BookLoads _
                       Where d.BookLoadControl = source.BookLoadControl _
                       Select New DTO.QuickSaveResults With {.Control = d.BookLoadControl _
                                                            , .ModDate = d.BookLoadModDate _
                                                            , .ModUser = d.BookLoadModUser _
                                                            , .Updated = d.BookLoadUpdated.ToArray}).First
            Catch ex As FaultException(Of SqlFaultInfo)
                Throw
            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

        End Using
        Return ret
    End Function

    ' ''' <summary>
    ' ''' 
    ' ''' </summary>
    ' ''' <param name="LinqTable"></param>
    ' ''' <param name="oData"></param>
    ' ''' <remarks>
    ' ''' Modified by RHR v-5.1.3 7/1/11 removed BookItems data.  We now leave this list empty
    ' ''' because the maximum allowed durring a save is a little over 50 records (WCF Error 400 issue)
    ' ''' </remarks>
    'Protected Overrides Sub AddDetailsToLinq(ByRef LinqTable As Object, ByRef oData As DTO.DTOBaseClass)

    '    With CType(LinqTable, LTS.BookLoad)
    '        'Add Book Loads Records
    '        .BookItems.AddRange( _
    '                 From d In CType(oData, DTO.BookLoad).BookItems _
    '                 Select New LTS.BookItem With {.BookItemControl = d.BookItemControl _
    '                                   , .BookItemBookLoadControl = d.BookItemBookLoadControl _
    '                                   , .BookItemFixOffInvAllow = d.BookItemFixOffInvAllow _
    '                                   , .BookItemFixFrtAllow = d.BookItemFixFrtAllow _
    '                                   , .BookItemItemNumber = d.BookItemItemNumber _
    '                                   , .BookItemQtyOrdered = d.BookItemQtyOrdered _
    '                                   , .BookItemFreightCost = d.BookItemFreightCost _
    '                                   , .BookItemItemCost = d.BookItemItemCost _
    '                                   , .BookItemWeight = d.BookItemWeight _
    '                                   , .BookItemCube = d.BookItemCube _
    '                                   , .BookItemPack = d.BookItemPack _
    '                                   , .BookItemSize = d.BookItemSize _
    '                                   , .BookItemDescription = d.BookItemDescription _
    '                                   , .BookItemHazmat = d.BookItemHazmat _
    '                                   , .BookItemModDate = Date.Now _
    '                                   , .BookItemModUser = Parameters.UserName _
    '                                   , .BookItemBrand = d.BookItemBrand _
    '                                   , .BookItemCostCenter = d.BookItemCostCenter _
    '                                   , .BookItemLotNumber = d.BookItemLotNumber _
    '                                   , .BookItemLotExpirationDate = d.BookItemLotExpirationDate _
    '                                   , .BookItemGTIN = d.BookItemGTIN _
    '                                   , .BookCustItemNumber = d.BookCustItemNumber _
    '                                   , .BookItemBFC = d.BookItemBFC _
    '                                   , .BookItemCountryOfOrigin = d.BookItemCountryOfOrigin _
    '                                   , .BookItemHST = d.BookItemHST _
    '                                   , .BookItemPalletTypeID = d.BookItemPalletTypeID _
    '                                   , .BookItemUpdated = If(d.BookItemUpdated Is Nothing, New Byte() {}, d.BookItemUpdated)})

    '    End With
    'End Sub

    ' ''' <summary>
    ' ''' 
    ' ''' </summary>
    ' ''' <param name="oDB"></param>
    ' ''' <param name="LinqTable"></param>
    ' ''' <remarks>
    ' ''' Modified by RHR v-5.1.3 7/1/11 removed BookItems data.  We now leave this list empty
    ' ''' because the maximum allowed durring a save is a little over 50 records (WCF Error 400 issue)
    ' ''' </remarks>
    'Protected Overrides Sub InsertAllDetails(ByRef oDB As System.Data.Linq.DataContext, ByRef LinqTable As Object)
    '    With CType(oDB, NGLMasBookDataContext)
    '        .BookItems.InsertAllOnSubmit(CType(LinqTable, LTS.BookLoad).BookItems)
    '    End With
    'End Sub

    ' ''' <summary>
    ' ''' 
    ' ''' </summary>
    ' ''' <param name="oDB"></param>
    ' ''' <param name="oData"></param>
    ' ''' <remarks>
    ' ''' Modified by RHR v-5.1.3 7/1/11 removed BookItems data.  We now leave this list empty
    ' ''' because the maximum allowed durring a save is a little over 50 records (WCF Error 400 issue)
    ' ''' </remarks>
    'Protected Overrides Sub ProcessUpdatedDetails(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
    '    With CType(oDB, NGLMasBookDataContext)
    '        If ((Not .BookItems Is Nothing) AndAlso .BookItems.Count > 0) Then
    '            ' Process any inserted item records 
    '            .BookItems.InsertAllOnSubmit(GetBookItemChanges(oData, TrackingInfo.Created))
    '            ' Process any updated contact records
    '            .BookItems.AttachAll(GetBookItemChanges(oData, TrackingInfo.Updated), True)
    '            ' Process any deleted contact records
    '            Dim deletedDetails = GetBookItemChanges(oData, TrackingInfo.Deleted)
    '            .BookItems.AttachAll(deletedDetails, True)
    '            .BookItems.DeleteAllOnSubmit(deletedDetails)
    '        End If
    '    End With
    'End Sub

    ' ''' <summary>
    ' ''' 
    ' ''' </summary>
    ' ''' <param name="source"></param>
    ' ''' <param name="changeType"></param>
    ' ''' <returns></returns>
    ' ''' <remarks>
    ' ''' Modified by RHR v-5.1.3 7/1/11 removed BookItems data.  We now leave this list empty
    ' ''' because the maximum allowed durring a save is a little over 50 records (WCF Error 400 issue)
    ' ''' </remarks>
    'Protected Function GetBookItemChanges(ByVal source As DTO.BookLoad, ByVal changeType As TrackingInfo) As List(Of LTS.BookItem)
    '    ' Test record details for specified change type.
    '    ' If Updated is null, set to byte[0] (for inserted items).
    '    Dim details As IEnumerable(Of LTS.BookItem) = ( _
    '      From d In source.BookItems _
    '      Where d.TrackingState = changeType _
    '      Select New LTS.BookItem With {.BookItemControl = d.BookItemControl _
    '                                   , .BookItemBookLoadControl = d.BookItemBookLoadControl _
    '                                   , .BookItemFixOffInvAllow = d.BookItemFixOffInvAllow _
    '                                   , .BookItemFixFrtAllow = d.BookItemFixFrtAllow _
    '                                   , .BookItemItemNumber = d.BookItemItemNumber _
    '                                   , .BookItemQtyOrdered = d.BookItemQtyOrdered _
    '                                   , .BookItemFreightCost = d.BookItemFreightCost _
    '                                   , .BookItemItemCost = d.BookItemItemCost _
    '                                   , .BookItemWeight = d.BookItemWeight _
    '                                   , .BookItemCube = d.BookItemCube _
    '                                   , .BookItemPack = d.BookItemPack _
    '                                   , .BookItemSize = d.BookItemSize _
    '                                   , .BookItemDescription = d.BookItemDescription _
    '                                   , .BookItemHazmat = d.BookItemHazmat _
    '                                   , .BookItemModDate = Date.Now _
    '                                   , .BookItemModUser = Parameters.UserName _
    '                                   , .BookItemBrand = d.BookItemBrand _
    '                                   , .BookItemCostCenter = d.BookItemCostCenter _
    '                                   , .BookItemLotNumber = d.BookItemLotNumber _
    '                                   , .BookItemLotExpirationDate = d.BookItemLotExpirationDate _
    '                                   , .BookItemGTIN = d.BookItemGTIN _
    '                                   , .BookCustItemNumber = d.BookCustItemNumber _
    '                                   , .BookItemBFC = d.BookItemBFC _
    '                                   , .BookItemCountryOfOrigin = d.BookItemCountryOfOrigin _
    '                                   , .BookItemHST = d.BookItemHST _
    '                                   , .BookItemPalletTypeID = d.BookItemPalletTypeID _
    '                                   , .BookItemUpdated = If(d.BookItemUpdated Is Nothing, New Byte() {}, d.BookItemUpdated)})
    '    Return details.ToList()
    'End Function

#End Region

End Class

Public Class NGLvBookConsData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.vBookConsSubForms
        Me.LinqDB = db
    End Sub

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GetvBookConsRecord(Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return Nothing
    End Function

    Public Function GetvBookConsRecord(ByVal Control As Integer) As DTO.vBookCons
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'Get the newest record that matches the provided criteria
                Dim ovBookCons As DTO.vBookCons = ( _
                From d In db.vBookConsSubForms _
                Where _
                    d.BookControl = Control _
                Select New DTO.vBookCons With {.BookCarrierContact = d.BookCarrierContact _
                                              , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                              , .BookCarrierControl = d.BookCarrierControl _
                                              , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                              , .BookCommCompControl = d.BookCommCompControl _
                                              , .BookConsPrefix = d.BookConsPrefix _
                                              , .BookControl = d.BookControl _
                                              , .BookCustCompControl = d.BookCustCompControl _
                                              , .BookDateDelivered = d.BookDateDelivered _
                                              , .BookDateInvoice = d.BookDateInvoice _
                                              , .BookDateLoad = d.BookDateLoad _
                                              , .BookDateOrdered = d.BookDateOrdered _
                                              , .BookDateRequired = d.BookDateRequired _
                                              , .BookDestAddress1 = d.BookDestAddress1 _
                                              , .BookDestAddress2 = d.BookDestAddress2 _
                                              , .BookDestAddress3 = d.BookDestAddress3 _
                                              , .BookDestCity = d.BookDestCity _
                                              , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                              , .BookDestCountry = d.BookDestCountry _
                                              , .BookDestFax = d.BookDestFax _
                                              , .BookDestName = d.BookDestName _
                                              , .BookDestPhone = d.BookDestPhone _
                                              , .BookDestState = d.BookDestState _
                                              , .BookDestZip = d.BookDestZip _
                                              , .BookLaneCarrControl = If(d.BookLaneCarrControl.HasValue, d.BookLaneCarrControl, 0) _
                                              , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                              , .BookModDate = d.BookModDate _
                                              , .BookModUser = d.BookModUser _
                                              , .BookODControl = d.BookODControl _
                                              , .BookOrigAddress1 = d.BookOrigAddress1 _
                                              , .BookOrigAddress2 = d.BookOrigAddress2 _
                                              , .BookOrigAddress3 = d.BookOrigAddress3 _
                                              , .BookOrigCity = d.BookOrigCity _
                                              , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                              , .BookOrigCountry = d.BookOrigCountry _
                                              , .BookOrigFax = d.BookOrigFax _
                                              , .BookOrigName = d.BookOrigName _
                                              , .BookOrigPhone = d.BookOrigPhone _
                                              , .BookOrigState = d.BookOrigState _
                                              , .BookOrigZip = d.BookOrigZip _
                                              , .BookPayCode = d.BookPayCode _
                                              , .BookProBase = d.BookProBase _
                                              , .BookProNumber = d.BookProNumber _
                                              , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                              , .BookRevCarrierCost = If(d.BookREvCarrierCost.HasValue, d.BookREvCarrierCost, 0) _
                                              , .BookRevCommCost = If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0) _
                                              , .BookRevCommPercent = If(d.BookRevCommPercent.HasValue, d.BookRevCommPercent, 0) _
                                              , .BookRevGrossRevenue = If(d.BookRevGrossRevenue.HasValue, d.BookRevGrossRevenue, 0) _
                                              , .BookRevLoadSavings = If(d.BookRevLoadSavings.HasValue, d.BookRevLoadSavings, 0) _
                                              , .BookRevOtherCost = If(d.BookRevOtherCost.HasValue, d.BookRevOtherCost, 0) _
                                              , .BookRevStopCost = If(d.BookRevStopCost.HasValue, d.BookRevStopCost, 0) _
                                              , .BookRevStopQty = If(d.BookRevStopQty.HasValue, d.BookRevStopQty, 0) _
                                              , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                              , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                              , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                              , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                              , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                              , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                              , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                              , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                              , .BookTranCode = d.BookTranCode _
                                              , .BookTypeCode = d.BookTypeCode _
                                              , .CarrierName = d.CarrierName _
                                              , .LaneBenchMiles = If(d.LaneBenchMiles.HasValue, d.LaneBenchMiles, 0) _
                                              , .LaneName = d.LaneName _
                                              , .LaneNumber = d.LaneNumber _
                                              , .BookRouteFinalCode = d.BookRouteFinalCode _
                                              , .BookRouteFinalDate = d.BookRouteFinalDate _
                                              , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                              , .BookLockAllCosts = d.BookLockAllCosts _
                                              , .BookLockBFCCost = d.BookLockBFCCost _
                                              , .CompFinUseImportFrtCost = d.CompFinUseImportFrtCost _
                                              , .CompanyName = d.CompanyName _
                                              , .CompanyNumber = d.CompanyNumber _
                                              , .BookUpdated = d.BookUpdated.ToArray()}).First


                Return ovBookCons

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetvBookConsFilteredContains(ByVal strBookConsPrefix As String) As DTO.vBookCons()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl

                'convert any * to %
                If Not String.IsNullOrEmpty(strBookConsPrefix) Then strBookConsPrefix = strBookConsPrefix.Replace("*", "%")
                'Get the newest record that matches the provided criteria
                Dim ovBookCons As DTO.vBookCons() = ( _
                From d In db.vBookConsSubForms _
                Where _
                    System.Data.Linq.SqlClient.SqlMethods.Like(d.BookConsPrefix, strBookConsPrefix) _
                    And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.BookCustCompControl)) _
                Order By _
                    d.BookConsPrefix, d.BookStopNo, d.BookProNumber _
                Select New DTO.vBookCons With {.BookCarrierContact = d.BookCarrierContact _
                                              , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                              , .BookCarrierControl = d.BookCarrierControl _
                                              , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                              , .BookCommCompControl = d.BookCommCompControl _
                                              , .BookConsPrefix = d.BookConsPrefix _
                                              , .BookControl = d.BookControl _
                                              , .BookCustCompControl = d.BookCustCompControl _
                                              , .BookDateDelivered = d.BookDateDelivered _
                                              , .BookDateInvoice = d.BookDateInvoice _
                                              , .BookDateLoad = d.BookDateLoad _
                                              , .BookDateOrdered = d.BookDateOrdered _
                                              , .BookDateRequired = d.BookDateRequired _
                                              , .BookDestAddress1 = d.BookDestAddress1 _
                                              , .BookDestAddress2 = d.BookDestAddress2 _
                                              , .BookDestAddress3 = d.BookDestAddress3 _
                                              , .BookDestCity = d.BookDestCity _
                                              , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                              , .BookDestCountry = d.BookDestCountry _
                                              , .BookDestFax = d.BookDestFax _
                                              , .BookDestName = d.BookDestName _
                                              , .BookDestPhone = d.BookDestPhone _
                                              , .BookDestState = d.BookDestState _
                                              , .BookDestZip = d.BookDestZip _
                                              , .BookLaneCarrControl = If(d.BookLaneCarrControl.HasValue, d.BookLaneCarrControl, 0) _
                                              , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                              , .BookModDate = d.BookModDate _
                                              , .BookModUser = d.BookModUser _
                                              , .BookODControl = d.BookODControl _
                                              , .BookOrigAddress1 = d.BookOrigAddress1 _
                                              , .BookOrigAddress2 = d.BookOrigAddress2 _
                                              , .BookOrigAddress3 = d.BookOrigAddress3 _
                                              , .BookOrigCity = d.BookOrigCity _
                                              , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                              , .BookOrigCountry = d.BookOrigCountry _
                                              , .BookOrigFax = d.BookOrigFax _
                                              , .BookOrigName = d.BookOrigName _
                                              , .BookOrigPhone = d.BookOrigPhone _
                                              , .BookOrigState = d.BookOrigState _
                                              , .BookOrigZip = d.BookOrigZip _
                                              , .BookPayCode = d.BookPayCode _
                                              , .BookProBase = d.BookProBase _
                                              , .BookProNumber = d.BookProNumber _
                                              , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                              , .BookRevCarrierCost = If(d.BookREvCarrierCost.HasValue, d.BookREvCarrierCost, 0) _
                                              , .BookRevCommCost = If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0) _
                                              , .BookRevCommPercent = If(d.BookRevCommPercent.HasValue, d.BookRevCommPercent, 0) _
                                              , .BookRevGrossRevenue = If(d.BookRevGrossRevenue.HasValue, d.BookRevGrossRevenue, 0) _
                                              , .BookRevLoadSavings = If(d.BookRevLoadSavings.HasValue, d.BookRevLoadSavings, 0) _
                                              , .BookRevOtherCost = If(d.BookRevOtherCost.HasValue, d.BookRevOtherCost, 0) _
                                              , .BookRevStopCost = If(d.BookRevStopCost.HasValue, d.BookRevStopCost, 0) _
                                              , .BookRevStopQty = If(d.BookRevStopQty.HasValue, d.BookRevStopQty, 0) _
                                              , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                              , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                              , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                              , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                              , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                              , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                              , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                              , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                              , .BookTranCode = d.BookTranCode _
                                              , .BookTypeCode = d.BookTypeCode _
                                              , .CarrierName = d.CarrierName _
                                              , .LaneBenchMiles = If(d.LaneBenchMiles.HasValue, d.LaneBenchMiles, 0) _
                                              , .LaneName = d.LaneName _
                                              , .LaneNumber = d.LaneNumber _
                                              , .BookRouteFinalCode = d.BookRouteFinalCode _
                                              , .BookRouteFinalDate = d.BookRouteFinalDate _
                                              , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                              , .BookLockAllCosts = d.BookLockAllCosts _
                                              , .BookLockBFCCost = d.BookLockBFCCost _
                                              , .CompFinUseImportFrtCost = d.CompFinUseImportFrtCost _
                                              , .CompanyName = d.CompanyName _
                                              , .CompanyNumber = d.CompanyNumber _
                                              , .BookUpdated = d.BookUpdated.ToArray()}).Take(100).ToArray


                Return ovBookCons

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetvBookConsFiltered(ByVal strBookConsPrefix As String) As DTO.vBookCons()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'Get the newest record that matches the provided criteria
                Dim ovBookCons As DTO.vBookCons() = ( _
                From d In db.vBookConsSubForms _
                Where _
                    d.BookConsPrefix = strBookConsPrefix _
                Order By _
                    d.BookConsPrefix, d.BookStopNo, d.BookProNumber _
                Select New DTO.vBookCons With {.BookCarrierContact = d.BookCarrierContact _
                                              , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                              , .BookCarrierControl = d.BookCarrierControl _
                                              , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                              , .BookCommCompControl = d.BookCommCompControl _
                                              , .BookConsPrefix = d.BookConsPrefix _
                                              , .BookControl = d.BookControl _
                                              , .BookCustCompControl = d.BookCustCompControl _
                                              , .BookDateDelivered = d.BookDateDelivered _
                                              , .BookDateInvoice = d.BookDateInvoice _
                                              , .BookDateLoad = d.BookDateLoad _
                                              , .BookDateOrdered = d.BookDateOrdered _
                                              , .BookDateRequired = d.BookDateRequired _
                                              , .BookDestAddress1 = d.BookDestAddress1 _
                                              , .BookDestAddress2 = d.BookDestAddress2 _
                                              , .BookDestAddress3 = d.BookDestAddress3 _
                                              , .BookDestCity = d.BookDestCity _
                                              , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                              , .BookDestCountry = d.BookDestCountry _
                                              , .BookDestFax = d.BookDestFax _
                                              , .BookDestName = d.BookDestName _
                                              , .BookDestPhone = d.BookDestPhone _
                                              , .BookDestState = d.BookDestState _
                                              , .BookDestZip = d.BookDestZip _
                                              , .BookLaneCarrControl = If(d.BookLaneCarrControl.HasValue, d.BookLaneCarrControl, 0) _
                                              , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                              , .BookModDate = d.BookModDate _
                                              , .BookModUser = d.BookModUser _
                                              , .BookODControl = d.BookODControl _
                                              , .BookOrigAddress1 = d.BookOrigAddress1 _
                                              , .BookOrigAddress2 = d.BookOrigAddress2 _
                                              , .BookOrigAddress3 = d.BookOrigAddress3 _
                                              , .BookOrigCity = d.BookOrigCity _
                                              , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                              , .BookOrigCountry = d.BookOrigCountry _
                                              , .BookOrigFax = d.BookOrigFax _
                                              , .BookOrigName = d.BookOrigName _
                                              , .BookOrigPhone = d.BookOrigPhone _
                                              , .BookOrigState = d.BookOrigState _
                                              , .BookOrigZip = d.BookOrigZip _
                                              , .BookPayCode = d.BookPayCode _
                                              , .BookProBase = d.BookProBase _
                                              , .BookProNumber = d.BookProNumber _
                                              , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                              , .BookRevCarrierCost = If(d.BookREvCarrierCost.HasValue, d.BookREvCarrierCost, 0) _
                                              , .BookRevCommCost = If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0) _
                                              , .BookRevCommPercent = If(d.BookRevCommPercent.HasValue, d.BookRevCommPercent, 0) _
                                              , .BookRevGrossRevenue = If(d.BookRevGrossRevenue.HasValue, d.BookRevGrossRevenue, 0) _
                                              , .BookRevLoadSavings = If(d.BookRevLoadSavings.HasValue, d.BookRevLoadSavings, 0) _
                                              , .BookRevOtherCost = If(d.BookRevOtherCost.HasValue, d.BookRevOtherCost, 0) _
                                              , .BookRevStopCost = If(d.BookRevStopCost.HasValue, d.BookRevStopCost, 0) _
                                              , .BookRevStopQty = If(d.BookRevStopQty.HasValue, d.BookRevStopQty, 0) _
                                              , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                              , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                              , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                              , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                              , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                              , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                              , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                              , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                              , .BookTranCode = d.BookTranCode _
                                              , .BookTypeCode = d.BookTypeCode _
                                              , .CarrierName = d.CarrierName _
                                              , .LaneBenchMiles = If(d.LaneBenchMiles.HasValue, d.LaneBenchMiles, 0) _
                                              , .LaneName = d.LaneName _
                                              , .LaneNumber = d.LaneNumber _
                                              , .BookRouteFinalCode = d.BookRouteFinalCode _
                                              , .BookRouteFinalDate = d.BookRouteFinalDate _
                                              , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                              , .BookLockAllCosts = d.BookLockAllCosts _
                                              , .BookLockBFCCost = d.BookLockBFCCost _
                                              , .CompFinUseImportFrtCost = d.CompFinUseImportFrtCost _
                                              , .CompanyName = d.CompanyName _
                                              , .CompanyNumber = d.CompanyNumber _
                                              , .BookUpdated = d.BookUpdated.ToArray()}).Take(100).ToArray


                Return ovBookCons

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Overrides Function Update(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity)) As Object
        SaveChanges(oData)
        Dim source As DTO.vBookCons = TryCast(oData, DTO.vBookCons)
        If source Is Nothing Then Return Nothing
        Dim oBook As New NGLBookData(Me.Parameters)
        oBook.UpdateCNSLockFlags(source.BookControl)
        ' Return the updated order
        Return GetvBookConsRecord(oData.BookControl)

    End Function

    Public Overrides Function UpdateQuick(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity)) As DTO.QuickSaveResults
        SaveChanges(oData)
        Dim source As DTO.vBookCons = TryCast(oData, DTO.vBookCons)
        If source Is Nothing Then Return Nothing
        ' Return the updated order
        Return GetQuickSaveResults(oData)

    End Function

    Public Overrides Sub UpdateNoReturn(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity))
        SaveChanges(oData)
        Dim source As DTO.vBookCons = TryCast(oData, DTO.vBookCons)
        If source Is Nothing Then Return
        Dim oBook As New NGLBookData(Me.Parameters)
        oBook.UpdateCNSLockFlags(source.BookControl)

    End Sub

    Public Overrides Sub Delete(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity))
        Using LinqDB
            'Note: the ValidateData Function must throw a FaultException error on failure
            ValidateDeletedRecord(LinqDB, oData)
            Try
                With CType(oData, DTO.BookLoadDetail)

                    'Open the existing Record
                    Dim nObject As LTS.vBookConsSubForm = (From e In CType(LinqDB, NGLMasBookDataContext).vBookConsSubForms Where e.BookControl = .BookControl Select e).First
                    If nObject Is Nothing Then
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_RecordDeleted"}, New FaultReason("E_InvalidOperationException"))
                    Else
                        CType(LinqDB, NGLMasBookDataContext).vBookConsSubForms.DeleteOnSubmit(nObject)
                        LinqDB.SubmitChanges()
                    End If

                End With
            Catch ex As SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch conflictEx As ChangeConflictException
                Try
                    Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(LinqDB))
                    conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                    Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                Catch ex As FaultException
                    Throw
                Catch ex As Exception
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
                End Try
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try
        End Using
    End Sub

#End Region

#Region "Protected Functions"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Dim d = CType(oData, DTO.vBookCons)
        'Create New Record
        Return New LTS.vBookConsSubForm With {.BookCarrierContact = d.BookCarrierContact _
                                              , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                              , .BookCarrierControl = d.BookCarrierControl _
                                              , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                              , .BookCommCompControl = d.BookCommCompControl _
                                              , .BookConsPrefix = d.BookConsPrefix _
                                              , .BookControl = d.BookControl _
                                              , .BookCustCompControl = d.BookCustCompControl _
                                              , .BookDateDelivered = d.BookDateDelivered _
                                              , .BookDateInvoice = d.BookDateInvoice _
                                              , .BookDateLoad = d.BookDateLoad _
                                              , .BookDateOrdered = d.BookDateOrdered _
                                              , .BookDateRequired = d.BookDateRequired _
                                              , .BookDestAddress1 = d.BookDestAddress1 _
                                              , .BookDestAddress2 = d.BookDestAddress2 _
                                              , .BookDestAddress3 = d.BookDestAddress3 _
                                              , .BookDestCity = d.BookDestCity _
                                              , .BookDestCompControl = d.BookDestCompControl _
                                              , .BookDestCountry = d.BookDestCountry _
                                              , .BookDestFax = d.BookDestFax _
                                              , .BookDestName = d.BookDestName _
                                              , .BookDestPhone = d.BookDestPhone _
                                              , .BookDestState = d.BookDestState _
                                              , .BookDestZip = d.BookDestZip _
                                              , .BookLaneCarrControl = d.BookLaneCarrControl _
                                              , .BookMilesFrom = d.BookMilesFrom _
                                              , .BookModDate = Date.Now _
                                              , .BookModUser = Parameters.UserName _
                                              , .BookODControl = d.BookODControl _
                                              , .BookOrigAddress1 = d.BookOrigAddress1 _
                                              , .BookOrigAddress2 = d.BookOrigAddress2 _
                                              , .BookOrigAddress3 = d.BookOrigAddress3 _
                                              , .BookOrigCity = d.BookOrigCity _
                                              , .BookOrigCompControl = d.BookOrigCompControl _
                                              , .BookOrigCountry = d.BookOrigCountry _
                                              , .BookOrigFax = d.BookOrigFax _
                                              , .BookOrigName = d.BookOrigName _
                                              , .BookOrigPhone = d.BookOrigPhone _
                                              , .BookOrigState = d.BookOrigState _
                                              , .BookOrigZip = d.BookOrigZip _
                                              , .BookPayCode = d.BookPayCode _
                                              , .BookProBase = d.BookProBase _
                                              , .BookProNumber = d.BookProNumber _
                                              , .BookRevBilledBFC = d.BookRevBilledBFC _
                                              , .BookREvCarrierCost = d.BookRevCarrierCost _
                                              , .BookRevCommCost = d.BookRevCommCost _
                                              , .BookRevCommPercent = d.BookRevCommPercent _
                                              , .BookRevGrossRevenue = d.BookRevGrossRevenue _
                                              , .BookRevLoadSavings = d.BookRevLoadSavings _
                                              , .BookRevOtherCost = d.BookRevOtherCost _
                                              , .BookRevStopCost = d.BookRevStopCost _
                                              , .BookRevStopQty = d.BookRevStopQty _
                                              , .BookRevTotalCost = d.BookRevTotalCost _
                                              , .BookStopNo = d.BookStopNo _
                                              , .BookTotalBFC = d.BookTotalBFC _
                                              , .BookTotalCases = d.BookTotalCases _
                                              , .BookTotalCube = d.BookTotalCube _
                                              , .BookTotalPL = d.BookTotalPL _
                                              , .BookTotalPX = d.BookTotalPX _
                                              , .BookTotalWgt = d.BookTotalWgt _
                                              , .BookTranCode = d.BookTranCode _
                                              , .BookTypeCode = d.BookTypeCode _
                                              , .BookRouteFinalCode = d.BookRouteFinalCode _
                                              , .BookRouteFinalDate = d.BookRouteFinalDate _
                                              , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                              , .BookLockAllCosts = d.BookLockAllCosts _
                                              , .BookLockBFCCost = d.BookLockBFCCost _
                                              , .BookUpdated = If(d.BookUpdated Is Nothing, New Byte() {}, d.BookUpdated)}

    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Dim source As LTS.vBookConsSubForm = TryCast(LinqTable, LTS.vBookConsSubForm)
        If source Is Nothing Then Return Nothing
        Dim oBook As New NGLBookData(Me.Parameters)
        oBook.UpdateCNSLockFlags(source.BookControl)
        Return GetRecordFiltered(Control:=source.BookControl)
    End Function

    Protected Overrides Sub NoReturnCleanUp(ByVal LinqTable As Object)
        Dim source As LTS.vBookConsSubForm = TryCast(LinqTable, LTS.vBookConsSubForm)
        If Not source Is Nothing Then
            Dim oBook As New NGLBookData(Me.Parameters)
            oBook.UpdateCNSLockFlags(source.BookControl)
        End If
    End Sub

    Protected Overrides Function GetQuickSaveResults(ByVal LinqTable As Object) As DataTransferObjects.QuickSaveResults
        Dim ret As DTO.QuickSaveResults
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim source As DTO.vBookCons = TryCast(LinqTable, DTO.vBookCons)
                If source Is Nothing Then Return Nothing
                Dim oBook As New NGLBookData(Me.Parameters)
                oBook.UpdateCNSLockFlags(source.BookControl)
                ret = (From d In db.vBookConsSubForms _
                       Where d.BookControl = source.BookControl _
                       Select New DTO.QuickSaveResults With {.Control = d.BookControl _
                                                            , .ModDate = d.BookModDate _
                                                            , .ModUser = d.BookModUser _
                                                            , .Updated = d.BookUpdated.ToArray}).First

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

        End Using
        Return ret
    End Function

    Private Sub SaveChanges(ByVal oData As DTO.vBookCons)
        Dim blnHasStopNbrChanged As Boolean = False
        If Not oData Is Nothing Then
            Dim strCNS As String = oData.BookConsPrefix
            Using LinqDB
                'Note: the ValidateData Function must throw a FaultException error on failure
                ValidateUpdatedRecord(LinqDB, oData)
                With oData
                    Try
                        'Open the existing Record
                        Dim d = (From e In CType(LinqDB, NGLMasBookDataContext).vBookConsSubForms Where e.BookControl = .BookControl Select e).First
                        If d Is Nothing Then
                            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_RecordDeleted"}, New FaultReason("E_InvalidOperationException"))
                        Else
                            'Check for conflicts
                            If .BookModDate <> d.BookModDate Then
                                'the data may have changed so check each field for conflicts
                                Dim ConflictData As New List(Of KeyValuePair(Of String, String))
                                Dim blnConflictFound As Boolean = False
                                addToConflicts("BookCarrierContact", .BookCarrierContact, d.BookCarrierContact, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrierContactPhone", .BookCarrierContactPhone, d.BookCarrierContactPhone, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrierControl", .BookCarrierControl, d.BookCarrierControl, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrOrderNumber", .BookCarrOrderNumber, d.BookCarrOrderNumber, ConflictData, blnConflictFound)
                                addToConflicts("BookCommCompControl", .BookCommCompControl, d.BookCommCompControl, ConflictData, blnConflictFound)
                                addToConflicts("BookConsPrefix", .BookConsPrefix, d.BookConsPrefix, ConflictData, blnConflictFound)
                                addToConflicts("BookCustCompControl", .BookCustCompControl, d.BookCustCompControl, ConflictData, blnConflictFound)
                                addToConflicts("BookDateDelivered", .BookDateDelivered, d.BookDateDelivered, ConflictData, blnConflictFound)
                                addToConflicts("BookDateInvoice", .BookDateInvoice, d.BookDateInvoice, ConflictData, blnConflictFound)
                                addToConflicts("BookDateLoad", .BookDateLoad, d.BookDateLoad, ConflictData, blnConflictFound)
                                addToConflicts("BookDateOrdered", .BookDateOrdered, d.BookDateOrdered, ConflictData, blnConflictFound)
                                addToConflicts("BookDestAddress1", .BookDestAddress1, d.BookDestAddress1, ConflictData, blnConflictFound)
                                addToConflicts("BookDestAddress2", .BookDestAddress2, d.BookDestAddress2, ConflictData, blnConflictFound)
                                addToConflicts("BookDestAddress3", .BookDestAddress3, d.BookDestAddress3, ConflictData, blnConflictFound)
                                addToConflicts("BookDestCity", .BookDestCity, d.BookDestCity, ConflictData, blnConflictFound)
                                addToConflicts("BookDestCompControl", .BookDestCompControl, d.BookDestCompControl, ConflictData, blnConflictFound)
                                addToConflicts("BookDestCountry", .BookDestCountry, d.BookDestCountry, ConflictData, blnConflictFound)
                                addToConflicts("BookDestFax", .BookDestFax, d.BookDestFax, ConflictData, blnConflictFound)
                                addToConflicts("BookDestName", .BookDestName, d.BookDestName, ConflictData, blnConflictFound)
                                addToConflicts("BookDestPhone", .BookDestPhone, d.BookDestPhone, ConflictData, blnConflictFound)
                                addToConflicts("BookDestState", .BookDestState, d.BookDestState, ConflictData, blnConflictFound)
                                addToConflicts("BookDestZip", .BookDestZip, d.BookDestZip, ConflictData, blnConflictFound)
                                addToConflicts("BookLaneCarrControl", .BookLaneCarrControl, d.BookLaneCarrControl, ConflictData, blnConflictFound)
                                addToConflicts("BookMilesFrom", .BookMilesFrom, d.BookMilesFrom, ConflictData, blnConflictFound)
                                addToConflicts("BookODControl", .BookODControl, d.BookODControl, ConflictData, blnConflictFound)
                                addToConflicts("BookOrigAddress1", .BookOrigAddress1, d.BookOrigAddress1, ConflictData, blnConflictFound)
                                addToConflicts("BookOrigAddress2", .BookOrigAddress2, d.BookOrigAddress2, ConflictData, blnConflictFound)
                                addToConflicts("BookOrigAddress3", .BookOrigAddress3, d.BookOrigAddress3, ConflictData, blnConflictFound)
                                addToConflicts("BookOrigCity", .BookOrigCity, d.BookOrigCity, ConflictData, blnConflictFound)
                                addToConflicts("BookOrigCompControl", .BookOrigCompControl, d.BookOrigCompControl, ConflictData, blnConflictFound)
                                addToConflicts("BookOrigCountry", .BookOrigCountry, d.BookOrigCountry, ConflictData, blnConflictFound)
                                addToConflicts("BookOrigFax", .BookOrigFax, d.BookOrigFax, ConflictData, blnConflictFound)
                                addToConflicts("BookOrigName", .BookOrigName, d.BookOrigName, ConflictData, blnConflictFound)
                                addToConflicts("BookOrigPhone", .BookOrigPhone, d.BookOrigPhone, ConflictData, blnConflictFound)
                                addToConflicts("BookOrigState", .BookOrigState, d.BookOrigState, ConflictData, blnConflictFound)
                                addToConflicts("BookOrigZip", .BookOrigZip, d.BookOrigZip, ConflictData, blnConflictFound)
                                addToConflicts("BookPayCode", .BookPayCode, d.BookPayCode, ConflictData, blnConflictFound)
                                addToConflicts("BookProBase", .BookProBase, d.BookProBase, ConflictData, blnConflictFound)
                                addToConflicts("BookProNumber", .BookProNumber, d.BookProNumber, ConflictData, blnConflictFound)
                                addToConflicts("BookRevBilledBFC", .BookRevBilledBFC, d.BookRevBilledBFC, ConflictData, blnConflictFound)
                                addToConflicts("BookRevCarrierCost", .BookRevCarrierCost, d.BookREvCarrierCost, ConflictData, blnConflictFound)
                                addToConflicts("BookRevCommCost", .BookRevCommCost, d.BookRevCommCost, ConflictData, blnConflictFound)
                                addToConflicts("BookRevCommPercent", .BookRevCommPercent, d.BookRevCommPercent, ConflictData, blnConflictFound)
                                addToConflicts("BookRevGrossRevenue", .BookRevGrossRevenue, d.BookRevGrossRevenue, ConflictData, blnConflictFound)
                                addToConflicts("BookRevLoadSavings", .BookRevLoadSavings, d.BookRevLoadSavings, ConflictData, blnConflictFound)
                                addToConflicts("BookRevOtherCost", .BookRevOtherCost, d.BookRevOtherCost, ConflictData, blnConflictFound)
                                addToConflicts("BookRevStopCost", .BookRevStopCost, d.BookRevStopCost, ConflictData, blnConflictFound)
                                addToConflicts("BookRevStopQty", .BookRevStopQty, d.BookRevStopQty, ConflictData, blnConflictFound)
                                addToConflicts("BookRevTotalCost", .BookRevTotalCost, d.BookRevTotalCost, ConflictData, blnConflictFound)
                                addToConflicts("BookStopNo", .BookStopNo, d.BookStopNo, ConflictData, blnConflictFound)
                                addToConflicts("BookTotalBFC", .BookTotalBFC, d.BookTotalBFC, ConflictData, blnConflictFound)
                                addToConflicts("BookTotalCases", .BookTotalCases, d.BookTotalCases, ConflictData, blnConflictFound)
                                addToConflicts("BookTotalCube", .BookTotalCube, d.BookTotalCube, ConflictData, blnConflictFound)
                                addToConflicts("BookTotalPL", .BookTotalPL, d.BookTotalPL, ConflictData, blnConflictFound)
                                addToConflicts("BookTotalPX", .BookTotalPX, d.BookTotalPX, ConflictData, blnConflictFound)
                                addToConflicts("BookTotalWgt", .BookTotalWgt, d.BookTotalWgt, ConflictData, blnConflictFound)
                                addToConflicts("BookTranCode", .BookTranCode, d.BookTranCode, ConflictData, blnConflictFound)
                                addToConflicts("BookTypeCode", .BookTypeCode, d.BookTypeCode, ConflictData, blnConflictFound)
                                addToConflicts("BookRouteFinalCode", .BookRouteFinalCode, d.BookRouteFinalCode, ConflictData, blnConflictFound)
                                addToConflicts("BookRouteFinalDate", .BookRouteFinalDate, d.BookRouteFinalDate, ConflictData, blnConflictFound)
                                addToConflicts("BookRouteFinalFlag", .BookRouteFinalFlag, d.BookRouteFinalFlag, ConflictData, blnConflictFound)
                                addToConflicts("BookLockAllCosts", .BookLockAllCosts, d.BookLockAllCosts, ConflictData, blnConflictFound)
                                addToConflicts("BookLockBFCCost", .BookLockBFCCost, d.BookLockBFCCost, ConflictData, blnConflictFound)
                                If blnConflictFound Then
                                    'We only add the mod date and mod user if one or more other fields have been modified
                                    addToConflicts("BookModDate", .BookModDate, d.BookModDate, ConflictData, blnConflictFound)
                                    addToConflicts("BookModUser", .BookModUser, d.BookModUser, ConflictData, blnConflictFound)
                                    Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(ConflictData))
                                    conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                                    Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                                End If
                            End If
                            'Update the table data
                            d.BookCarrierContact = .BookCarrierContact
                            d.BookCarrierContactPhone = .BookCarrierContactPhone
                            d.BookCarrierControl = .BookCarrierControl
                            d.BookCarrOrderNumber = .BookCarrOrderNumber
                            d.BookCommCompControl = .BookCommCompControl
                            d.BookConsPrefix = .BookConsPrefix
                            d.BookCustCompControl = .BookCustCompControl
                            d.BookDateDelivered = .BookDateDelivered
                            d.BookDateInvoice = .BookDateInvoice
                            d.BookDateLoad = .BookDateLoad
                            d.BookDateOrdered = .BookDateOrdered
                            d.BookDateRequired = .BookDateRequired
                            d.BookDestAddress1 = .BookDestAddress1
                            d.BookDestAddress2 = .BookDestAddress2
                            d.BookDestAddress3 = .BookDestAddress3
                            d.BookDestCity = .BookDestCity
                            d.BookDestCompControl = .BookDestCompControl
                            d.BookDestCountry = .BookDestCountry
                            d.BookDestFax = .BookDestFax
                            d.BookDestName = .BookDestName
                            d.BookDestPhone = .BookDestPhone
                            d.BookDestState = .BookDestState
                            d.BookDestZip = .BookDestZip
                            d.BookLaneCarrControl = .BookLaneCarrControl
                            d.BookMilesFrom = .BookMilesFrom
                            d.BookODControl = .BookODControl
                            d.BookOrigAddress1 = .BookOrigAddress1
                            d.BookOrigAddress2 = .BookOrigAddress2
                            d.BookOrigAddress3 = .BookOrigAddress3
                            d.BookOrigCity = .BookOrigCity
                            d.BookOrigCompControl = .BookOrigCompControl
                            d.BookOrigCountry = .BookOrigCountry
                            d.BookOrigFax = .BookOrigFax
                            d.BookOrigName = .BookOrigName
                            d.BookOrigPhone = .BookOrigPhone
                            d.BookOrigState = .BookOrigState
                            d.BookOrigZip = .BookOrigZip
                            d.BookPayCode = .BookPayCode
                            d.BookProBase = .BookProBase
                            d.BookProNumber = .BookProNumber
                            d.BookRevBilledBFC = .BookRevBilledBFC
                            d.BookREvCarrierCost = .BookRevCarrierCost
                            d.BookRevCommCost = .BookRevCommCost
                            d.BookRevCommPercent = .BookRevCommPercent
                            d.BookRevGrossRevenue = .BookRevGrossRevenue
                            d.BookRevLoadSavings = .BookRevLoadSavings
                            d.BookRevOtherCost = .BookRevOtherCost
                            d.BookRevStopCost = .BookRevStopCost
                            d.BookRevStopQty = .BookRevStopQty
                            d.BookRevTotalCost = .BookRevTotalCost
                            d.BookDestStopNumber = calculateBookDestStopNumber(d.BookStopNo, .BookStopNo, d.BookDestStopNumber)
                            d.BookStopNo = If(.BookStopNo < 1, 1, .BookStopNo)
                            d.BookTotalBFC = .BookTotalBFC
                            d.BookTotalCases = .BookTotalCases
                            d.BookTotalCube = .BookTotalCube
                            d.BookTotalPL = .BookTotalPL
                            d.BookTotalPX = .BookTotalPX
                            d.BookTotalWgt = .BookTotalWgt
                            d.BookTranCode = .BookTranCode
                            d.BookTypeCode = .BookTypeCode
                            d.BookRouteFinalCode = .BookRouteFinalCode
                            d.BookRouteFinalDate = .BookRouteFinalDate
                            d.BookRouteFinalFlag = .BookRouteFinalFlag
                            d.BookLockAllCosts = .BookLockAllCosts
                            d.BookLockBFCCost = .BookLockBFCCost
                            d.BookModDate = Date.Now
                            d.BookModUser = Me.Parameters.UserName
                        End If
                        LinqDB.SubmitChanges()
                    Catch ex As FaultException
                        Throw
                    Catch ex As SqlException
                        Utilities.SaveAppError(ex.Message, Me.Parameters)
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
                    Catch conflictEx As ChangeConflictException
                        Try
                            Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(LinqDB))
                            conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                            Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                        Catch ex As FaultException
                            Throw
                        Catch ex As Exception
                            Utilities.SaveAppError(ex.Message, Me.Parameters)
                            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
                        End Try
                    Catch ex As InvalidOperationException
                        Utilities.SaveAppError(ex.Message, Me.Parameters)
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_RecordDeleted"}, New FaultReason("E_InvalidOperationException"))
                    Catch ex As Exception
                        Utilities.SaveAppError(ex.Message, Me.Parameters)
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
                    End Try

                End With
            End Using
        End If

    End Sub

#End Region

End Class

Public Class NGLAPMassEntryData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.APMassEntries
        Me.LinqDB = db
    End Sub

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GetAPMassEntryFiltered(Control:=Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        'this function cannot be used to return records
        Return Nothing
    End Function

    Public Function GetAPMassEntryFiltered(Optional ByVal Control As Integer = 0) As DTO.APMassEntry
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'db.Log = New DebugTextWriter
                Dim oSecureComp = From s In db.UserAdminAsNvarcharRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.UserAdminCompControl
                'Get the newest record that matches the provided criteria
                Dim APMassEntry As DTO.APMassEntry = ( _
                From d In db.APMassEntries _
                Where _
                    (Control = 0 Or d.APControl = Control) _
                    And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.APCustomerID)) _
                Order By d.APControl Descending _
                Select New DTO.APMassEntry With {.APControl = d.APControl _
                    , .APCarrierNumber = If(d.APCarrierNumber.HasValue, d.APCarrierNumber, 0) _
                    , .APBillNumber = d.APBillNumber _
                    , .APBillDate = d.APBillDate _
                    , .APPONumber = d.APPONumber _
                    , .APCustomerID = d.APCustomerID _
                    , .APCostCenterNumber = d.APCostCenterNumber _
                    , .APTotalCost = d.APTotalCost _
                    , .APPRONumber = d.APPRONumber _
                    , .APBLNumber = d.APBLNumber _
                    , .APBilledWeight = If(d.APBilledWeight.HasValue, d.APBilledWeight, 0) _
                    , .APCNSNumber = d.APCNSNumber _
                    , .APReceivedDate = d.APReceivedDate _
                    , .APPayCode = d.APPayCode _
                    , .APElectronicFlag = d.APElectronicFlag _
                    , .APApprovedFlag = d.APApprovedFlag _
                    , .APMessage = d.APMessage _
                    , .APTotalTax = If(d.APTotalTax.HasValue, d.APTotalTax, 0) _
                    , .APFee1 = If(d.APFee1.HasValue, d.APFee1, 0) _
                    , .APFee2 = If(d.APFee2.HasValue, d.APFee2, 0) _
                    , .APFee3 = If(d.APFee3.HasValue, d.APFee3, 0) _
                    , .APFee4 = If(d.APFee4.HasValue, d.APFee4, 0) _
                    , .APFee5 = If(d.APFee5.HasValue, d.APFee5, 0) _
                    , .APFee6 = If(d.APFee6.HasValue, d.APFee6, 0) _
                    , .APOtherCosts = If(d.APOtherCosts.HasValue, d.APOtherCosts, 0) _
                    , .APCarrierCost = If(d.APCarrierCost.HasValue, d.APCarrierCost, 0) _
                    , .APExportFlag = If(d.APExportFlag.HasValue, d.APExportFlag, False) _
                    , .APOrderSequence = d.APOrderSequence _
                    , .APTaxDetail1 = d.APTaxDetail1 _
                    , .APTaxDetail2 = d.APTaxDetail2 _
                    , .APTaxDetail3 = d.APTaxDetail3 _
                    , .APTaxDetail4 = d.APTaxDetail4 _
                    , .APTaxDetail5 = d.APTaxDetail5 _
                    , .APModUser = d.APModUser _
                    , .APModDate = d.APModDate _
                    , .APUpdated = d.APUpdated.ToArray()}).First

                Return APMassEntry

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetAPMassEntrysFiltered(ByVal APCarrierNumber As Integer, _
                                            ByVal APReceivedDateFrom As Date, _
                                            ByVal APReceivedDateTo As Date, _
                                            ByVal APApprovedFlag As Boolean, _
                                            ByVal APElectronicFlag As Boolean, _
                                            ByVal ShowMatched As Boolean, _
                                            ByVal ShowAllErrors As Boolean) As DTO.APMassEntry()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'the show all errors flag overrides other the APApprovedFlag
                If ShowAllErrors = True Then APApprovedFlag = False
                Dim dtFrom As Date = DTran.formatStartDateFilter(APReceivedDateFrom)
                Dim dtTo As Date = DTran.formatEndDateFilter(APReceivedDateTo)

                Dim blnIgnoreElectronicFlag = False
                If ShowAllErrors = True Or ShowMatched = True Or APApprovedFlag = True Then blnIgnoreElectronicFlag = True

                'If APElectronicFlag = True Or (ShowMatched = False And APApprovedFlag = False) Then blnIgnoreElectronicFlag = False
                'db.Log = New DebugTextWriter
                Dim oSecureComp = From s In db.UserAdminAsNvarcharRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.UserAdminCompControl
                'Return all the contacts that match the criteria sorted by name
                Dim APMassEntrys() As DTO.APMassEntry = ( _
                From d In db.APMassEntries _
                Where _
                    (APCarrierNumber = 0 Or d.APCarrierNumber = APCarrierNumber) _
                    And _
                    (d.APReceivedDate >= dtFrom And d.APReceivedDate <= dtTo) _
                    And _
                    (d.APApprovedFlag = APApprovedFlag) _
                    And _
                    (blnIgnoreElectronicFlag = True OrElse d.APElectronicFlag = APElectronicFlag) _
                    And _
                    (ShowMatched = False OrElse d.APPayCode = "M") _
                    And _
                    (ShowAllErrors = False OrElse d.APMessage.Length > 1) _
                    And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.APCustomerID)) _
                Order By d.APCarrierNumber _
                Select New DTO.APMassEntry With {.APControl = d.APControl _
                                       , .APCarrierNumber = If(d.APCarrierNumber.HasValue, d.APCarrierNumber, 0) _
                                       , .APBillNumber = d.APBillNumber _
                                       , .APBillDate = d.APBillDate _
                                       , .APPONumber = d.APPONumber _
                                       , .APCustomerID = d.APCustomerID _
                                       , .APCostCenterNumber = d.APCostCenterNumber _
                                       , .APTotalCost = d.APTotalCost _
                                       , .APPRONumber = d.APPRONumber _
                                       , .APBLNumber = d.APBLNumber _
                                       , .APBilledWeight = If(d.APBilledWeight.HasValue, d.APBilledWeight, 0) _
                                       , .APCNSNumber = d.APCNSNumber _
                                       , .APReceivedDate = d.APReceivedDate _
                                       , .APPayCode = d.APPayCode _
                                       , .APElectronicFlag = d.APElectronicFlag _
                                       , .APApprovedFlag = d.APApprovedFlag _
                                       , .APMessage = d.APMessage _
                                       , .APTotalTax = If(d.APTotalTax.HasValue, d.APTotalTax, 0) _
                                       , .APFee1 = If(d.APFee1.HasValue, d.APFee1, 0) _
                                       , .APFee2 = If(d.APFee2.HasValue, d.APFee2, 0) _
                                       , .APFee3 = If(d.APFee3.HasValue, d.APFee3, 0) _
                                       , .APFee4 = If(d.APFee4.HasValue, d.APFee4, 0) _
                                       , .APFee5 = If(d.APFee5.HasValue, d.APFee5, 0) _
                                       , .APFee6 = If(d.APFee6.HasValue, d.APFee6, 0) _
                                       , .APOtherCosts = If(d.APOtherCosts.HasValue, d.APOtherCosts, 0) _
                                       , .APCarrierCost = If(d.APCarrierCost.HasValue, d.APCarrierCost, 0) _
                                       , .APExportFlag = If(d.APExportFlag.HasValue, d.APExportFlag, False) _
                                       , .APOrderSequence = d.APOrderSequence _
                                       , .APTaxDetail1 = d.APTaxDetail1 _
                                       , .APTaxDetail2 = d.APTaxDetail2 _
                                       , .APTaxDetail3 = d.APTaxDetail3 _
                                       , .APTaxDetail4 = d.APTaxDetail4 _
                                       , .APTaxDetail5 = d.APTaxDetail5 _
                                       , .APModUser = d.APModUser _
                                       , .APModDate = d.APModDate _
                                       , .APUpdated = d.APUpdated.ToArray()}).ToArray()
                Return APMassEntrys

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

#End Region

#Region "Protected Functions"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Dim d = CType(oData, DTO.APMassEntry)
        'Create New Record
        Return New LTS.APMassEntry With {.APControl = d.APControl _
                                       , .APCarrierNumber = d.APCarrierNumber _
                                       , .APBillNumber = d.APBillNumber _
                                       , .APBillDate = d.APBillDate _
                                       , .APPONumber = d.APPONumber _
                                       , .APCustomerID = d.APCustomerID _
                                       , .APCostCenterNumber = d.APCostCenterNumber _
                                       , .APTotalCost = d.APTotalCost _
                                       , .APPRONumber = d.APPRONumber _
                                       , .APBLNumber = d.APBLNumber _
                                       , .APBilledWeight = d.APBilledWeight _
                                       , .APCNSNumber = d.APCNSNumber _
                                       , .APReceivedDate = d.APReceivedDate _
                                       , .APPayCode = d.APPayCode _
                                       , .APElectronicFlag = d.APElectronicFlag _
                                       , .APApprovedFlag = d.APApprovedFlag _
                                       , .APMessage = d.APMessage _
                                       , .APTotalTax = d.APTotalTax _
                                       , .APFee1 = d.APFee1 _
                                       , .APFee2 = d.APFee2 _
                                       , .APFee3 = d.APFee3 _
                                       , .APFee4 = d.APFee4 _
                                       , .APFee5 = d.APFee5 _
                                       , .APFee6 = d.APFee6 _
                                       , .APOtherCosts = d.APOtherCosts _
                                       , .APCarrierCost = d.APCarrierCost _
                                       , .APExportFlag = d.APExportFlag _
                                       , .APOrderSequence = d.APOrderSequence _
                                       , .APTaxDetail1 = d.APTaxDetail1 _
                                       , .APTaxDetail2 = d.APTaxDetail2 _
                                       , .APTaxDetail3 = d.APTaxDetail3 _
                                       , .APTaxDetail4 = d.APTaxDetail4 _
                                       , .APTaxDetail5 = d.APTaxDetail5 _
                                       , .APModUser = Parameters.UserName _
                                       , .APModDate = Date.Now _
                                       , .APUpdated = If(d.APUpdated Is Nothing, New Byte() {}, d.APUpdated)}
    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Return GetAPMassEntryFiltered(Control:=CType(LinqTable, LTS.APMassEntry).APControl)
    End Function

    Protected Overrides Function GetQuickSaveResults(ByVal LinqTable As Object) As DataTransferObjects.QuickSaveResults
        Dim ret As DTO.QuickSaveResults
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim source As LTS.APMassEntry = TryCast(LinqTable, LTS.APMassEntry)
                If source Is Nothing Then Return Nothing

                ret = (From d In db.APMassEntries _
                       Where d.APControl = source.APControl _
                       Select New DTO.QuickSaveResults With {.Control = d.APControl _
                                                            , .ModDate = d.APModDate _
                                                            , .ModUser = d.APModUser _
                                                            , .Updated = d.APUpdated.ToArray}).First

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

        End Using
        Return ret
    End Function

#End Region

End Class

Public Class NGLAPCommData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.Books
        Me.LinqDB = db
    End Sub

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GetAPCommFiltered(Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return Nothing
    End Function

    Public Function GetAPCommFiltered(ByVal Control As Integer) As DTO.APComm
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                'db.Log = New DebugTextWriter
                'Get the AP Commission Book Record
                Dim Result As DTO.APComm = ( _
                From d In db.Books _
                Where _
                    (d.BookControl = Control) _
                    And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.BookCustCompControl)) _
                Select New DTO.APComm With {.BookControl = d.BookControl _
                                          , .BookProNumber = d.BookProNumber _
                                          , .BookConsPrefix = d.BookConsPrefix _
                                          , .BookCommCompControl = d.BookCommCompControl _
                                          , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                          , .BookFinARPayAmt = If(d.BookFinARPayAmt.HasValue, d.BookFinARPayAmt, 0) _
                                          , .BookFinCommStd = If(d.BookFinCommStd.HasValue, d.BookFinCommStd, 0) _
                                          , .BookFinCommAct = If(d.BookFinCommAct.HasValue, d.BookFinCommAct, 0) _
                                          , .BookFinCommPayDate = d.BookFinCommPayDate _
                                          , .BookFinCommPayAmt = If(d.BookFinCommPayAmt.HasValue, d.BookFinCommPayAmt, 0) _
                                          , .BookFinCommtCheck = d.BookFinCommtCheck _
                                          , .BookFinCommCreditAmt = If(d.BookFinCommCreditAmt.HasValue, d.BookFinCommCreditAmt, 0) _
                                          , .BookFinCommCreditPayDate = d.BookFinCommCreditPayDate _
                                          , .BookFinCommLoadCount = If(d.BookFinCommLoadCount.HasValue, d.BookFinCommLoadCount, 0) _
                                          , .BookFinCommGLNumber = d.BookFinCommGLNumber _
                                          , .BookRevCommCost = If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0) _
                                          , .BookModDate = d.BookModDate _
                                          , .BookModUser = d.BookModUser _
                                          , .BookUpdated = d.BookUpdated.ToArray _
                                          }).First()

                Return Result

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetAPCommsFiltered(ByVal BookCommCompControl As Integer) As DTO.APComm()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                'db.Log = New DebugTextWriter
                'Get the AP Commission Book Records
                Dim Results() As DTO.APComm = ( _
                From d In db.Books _
                Where _
                    (d.BookCommCompControl = BookCommCompControl) _
                    And _
                    d.BookTranCode = "IC" _
                    And _
                    d.BookFinARPayDate.HasValue _
                    And _
                    d.BookFinAPPayDate.HasValue _
                    And _
                    d.BookFinARCheck.Trim.Length > 0 _
                    And _
                    d.BookFinAPCheck.Trim.Length > 0 _
                    And _
                    (d.BookFinAPPayAmt.HasValue AndAlso d.BookFinAPPayAmt > 0) _
                    And _
                    (d.BookRevCommCost.HasValue AndAlso d.BookRevCommCost <> 0) _
                    And _
                    (d.BookFinCommPayAmt.HasValue = False OrElse d.BookFinCommPayAmt = 0) _
                    And _
                    ((d.BookFinARPayAmt.HasValue AndAlso d.BookFinARPayAmt > 0) _
                        And _
                        (d.BookFinARPayAmt >= d.BookFinARInvoiceAmt)) _
                    And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.BookCustCompControl)) _
                Order By d.BookFinARInvoiceDate, d.BookProNumber Ascending _
                Select New DTO.APComm With {.BookControl = d.BookControl _
                                          , .BookProNumber = d.BookProNumber _
                                          , .BookConsPrefix = d.BookConsPrefix _
                                          , .BookCommCompControl = d.BookCommCompControl _
                                          , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                          , .BookFinARPayAmt = If(d.BookFinARPayAmt.HasValue, d.BookFinARPayAmt, 0) _
                                          , .BookFinCommStd = If(d.BookFinCommStd.HasValue, d.BookFinCommStd, 0) _
                                          , .BookFinCommAct = If(d.BookFinCommAct.HasValue, d.BookFinCommAct, 0) _
                                          , .BookFinCommPayDate = d.BookFinCommPayDate _
                                          , .BookFinCommPayAmt = If(d.BookFinCommPayAmt.HasValue, d.BookFinCommPayAmt, 0) _
                                          , .BookFinCommtCheck = d.BookFinCommtCheck _
                                          , .BookFinCommCreditAmt = If(d.BookFinCommCreditAmt.HasValue, d.BookFinCommCreditAmt, 0) _
                                          , .BookFinCommCreditPayDate = d.BookFinCommCreditPayDate _
                                          , .BookFinCommLoadCount = If(d.BookFinCommLoadCount.HasValue, d.BookFinCommLoadCount, 0) _
                                          , .BookFinCommGLNumber = d.BookFinCommGLNumber _
                                          , .BookRevCommCost = If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0) _
                                          , .BookModDate = d.BookModDate _
                                          , .BookModUser = d.BookModUser _
                                          , .BookUpdated = d.BookUpdated.ToArray _
                                          }).Take(2000).ToArray()

                Return Results

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary> 
    ''' This method overfides the parent function it does not 
    ''' need to Attach the data object because this version of  
    ''' CopyDTOToLinq does not return a detached data object
    ''' </summary>
    ''' <typeparam name="TEntity"></typeparam>
    ''' <param name="oData"></param>
    ''' <param name="oLinqTable"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overrides Function UpdateQuick(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity)) As DTO.QuickSaveResults
        Using LinqDB
            'Note: the ValidateData Function must throw a FaultException error on failure
            ValidateUpdatedRecord(LinqDB, oData)
            Dim nObject = CopyDTOToLinq(oData)
            ' Return the quick results object
            Return GetQuickSaveResults(nObject)
        End Using

    End Function

    ''' <summary>
    ''' This method overfides the parent function it does not 
    ''' need to Attach the data object because this version of  
    ''' CopyDTOToLinq does not return a detached data object
    ''' </summary>
    ''' <typeparam name="TEntity"></typeparam>
    ''' <param name="oData"></param>
    ''' <param name="oLinqTable"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overrides Function Update(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity)) As Object
        Using LinqDB
            'Note: the ValidateData Function must throw a FaultException error on failure
            ValidateUpdatedRecord(LinqDB, oData) 
            Dim nObject = CopyDTOToLinq(oData)
            ' Return the updated order
            Return GetDTOUsingLinqTable(nObject)
        End Using
    End Function

    ''' <summary>
    ''' This method overfides the parent function it does not 
    ''' need to Attach the data object because this version of  
    ''' CopyDTOToLinq does not return a detached data object
    ''' </summary>
    ''' <typeparam name="TEntity"></typeparam>
    ''' <param name="oData"></param>
    ''' <param name="oLinqTable"></param>
    ''' <remarks></remarks>
    Public Overrides Sub UpdateNoReturn(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity))
        Using LinqDB
            'Note: the ValidateData Function must throw a FaultException error on failure
            ValidateUpdatedRecord(LinqDB, oData) 
            Dim nObject = CopyDTOToLinq(oData)
            NoReturnCleanUp(nObject)
        End Using
    End Sub

#End Region

#Region "Protected Functions"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Dim d = TryCast(oData, DTO.APComm)
        'Create Existing Record
        Dim source As New LTS.Book
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                If d Is Nothing Or d.BookControl = 0 Then
                    Utilities.SaveAppError("Cannot process data because the source record is empty or has an invalid control number", Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = "Cannot process data because the source record is empty or has an invalid control number"}, New FaultReason("E_InvalidOperationException"))
                End If
                source = (From b In db.Books _
                          Where b.BookControl = d.BookControl _
                          Select b).First()

                If source Is Nothing Then
                    Utilities.SaveAppError("Cannot process data because the source record cannot be found in the database", Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = "Cannot process data because the source record cannot be found in the database"}, New FaultReason("E_InvalidOperationException"))
                End If

                'Dim oBook As New LTS.Book
                'Dim type As Type = source.GetType()
                'Dim properties As System.Reflection.PropertyInfo() = type.GetProperties()
                'For Each p As System.Reflection.PropertyInfo In properties
                '    p.SetValue(oBook, p.GetValue(source, Nothing), Nothing)
                'Next



                With source
                    .BookConsPrefix = d.BookConsPrefix
                    .BookCommCompControl = d.BookCommCompControl
                    .BookFinARInvoiceDate = d.BookFinARInvoiceDate
                    .BookFinARPayAmt = d.BookFinARPayAmt
                    .BookFinCommStd = d.BookFinCommStd
                    .BookFinCommAct = d.BookFinCommAct
                    .BookFinCommPayDate = d.BookFinCommPayDate
                    .BookFinCommPayAmt = d.BookFinCommPayAmt
                    .BookFinCommtCheck = d.BookFinCommtCheck
                    .BookFinCommCreditAmt = d.BookFinCommCreditAmt
                    .BookFinCommCreditPayDate = d.BookFinCommCreditPayDate
                    .BookFinCommLoadCount = d.BookFinCommLoadCount
                    .BookFinCommGLNumber = d.BookFinCommGLNumber
                    .BookRevCommCost = d.BookRevCommCost
                    .BookModDate = Date.Now
                    .BookModUser = Me.Parameters.UserName
                    .BookUpdated = If(d.BookUpdated Is Nothing, New Byte() {}, d.BookUpdated)
                End With

                Try
                    db.SubmitChanges()
                Catch ex As SqlException
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = ex.Message}, New FaultReason("E_SQLException"))
                Catch conflictEx As ChangeConflictException
                    Try
                        Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(LinqDB))
                        conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                        Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                    Catch ex As FaultException
                        Throw
                    Catch ex As Exception
                        Utilities.SaveAppError(ex.Message, Me.Parameters)
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = ex.Message}, New FaultReason("E_UnExpected"))
                    End Try
                Catch ex As InvalidOperationException
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData"}, New FaultReason("E_InvalidOperationException"))
                Catch ex As Exception
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = ex.Message}, New FaultReason("E_UnExpected"))
                End Try

                Return source



            Catch ex As FaultException
                Throw
            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Return GetAPCommFiltered(Control:=CType(LinqTable, LTS.Book).BookControl)
    End Function

    Protected Overrides Function GetQuickSaveResults(ByVal LinqTable As Object) As DataTransferObjects.QuickSaveResults
        Dim ret As DTO.QuickSaveResults
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim source As LTS.Book = TryCast(LinqTable, LTS.Book)
                If source Is Nothing Then Return Nothing

                ret = (From d In db.Books _
                       Where d.BookControl = source.BookControl _
                       Select New DTO.QuickSaveResults With {.Control = d.BookControl _
                                                            , .ModDate = d.BookModDate _
                                                            , .ModUser = d.BookModUser _
                                                            , .Updated = d.BookUpdated.ToArray}).First

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

        End Using
        Return ret
    End Function

    Protected Overrides Sub ValidateNewRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'We do not allow booking records to be deleted from this class
        Utilities.SaveAppError("Cannot add data.  Records cannot be inserted using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))
    End Sub

    Protected Overrides Sub ValidateDeletedRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'We do not allow booking records to be deleted from this class
        Utilities.SaveAppError("Cannot delete data.  Records cannot be deleted using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))

    End Sub

#End Region

End Class

Public Class NGLvARMassEntryData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.vARMassEntries
        Me.LinqDB = db
    End Sub

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GetvARMassEntryFiltered(Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return Nothing
    End Function

    Public Function GetvARMassEntryFiltered(ByVal Control As Integer) As DTO.vARMassEntry
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl

                'Get the newest record that matches the provided criteria
                Dim ovARMassEntry As DTO.vARMassEntry = ( _
                From d In db.vARMassEntries _
                Where _
                    d.BookControl = Control _
                    And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.BookCustCompControl)) _
                Select New DTO.vARMassEntry With {.BookControl = d.BookControl _
                                              , .BookCustCompControl = d.BookCustCompControl _
                                              , .BookFinARGLNumber = d.BookFinARGLNumber _
                                              , .BookPayCode = d.BookPayCode _
                                              , .BookTypeCode = d.BookTypeCode _
                                              , .Check_No = d.Check_No _
                                              , .Cons_No = d.Cons_No _
                                              , .CurBal = d.CurBal _
                                              , .DaysOut = d.DaysOut _
                                              , .Invoice_Amt = d.Invoice_Amt _
                                              , .Invoiced = d.Invoiced _
                                              , .Pay_Amt = d.Pay_Amt _
                                              , .Payed = d.Payed _
                                              , .Pro_Number = d.Pro_Number _
                                              , .BookUpdated = d.BookUpdated.ToArray()}).First


                Return ovARMassEntry

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetvARMassEntriesFiltered(ByVal CompControl As Integer) As DTO.vARMassEntry()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select Control = s.CompControl

                'Get the newest record that matches the provided criteria
                Dim ovARMassEntry As DTO.vARMassEntry() = ( _
                From d In db.vARMassEntries _
                Where _
                    (d.BookCustCompControl = CompControl) _
                    And _
                    (d.Pay_Amt = 0) _
                    And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.BookCustCompControl)) _
                Select New DTO.vARMassEntry With {.BookControl = d.BookControl _
                                              , .BookCustCompControl = d.BookCustCompControl _
                                              , .BookFinARGLNumber = d.BookFinARGLNumber _
                                              , .BookPayCode = d.BookPayCode _
                                              , .BookTypeCode = d.BookTypeCode _
                                              , .Check_No = d.Check_No _
                                              , .Cons_No = d.Cons_No _
                                              , .CurBal = d.CurBal _
                                              , .DaysOut = d.DaysOut _
                                              , .Invoice_Amt = d.Invoice_Amt _
                                              , .Invoiced = d.Invoiced _
                                              , .Pay_Amt = d.Pay_Amt _
                                              , .Payed = d.Payed _
                                              , .Pro_Number = d.Pro_Number _
                                              , .BookUpdated = d.BookUpdated.ToArray()}).ToArray


                Return ovARMassEntry

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

#End Region

#Region "Protected Functions"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Dim d = CType(oData, DTO.vARMassEntry)
        'Create New Record
        Return New LTS.vARMassEntry With {.BookControl = d.BookControl _
                                              , .BookCustCompControl = d.BookCustCompControl _
                                              , .BookFinARGLNumber = d.BookFinARGLNumber _
                                              , .BookPayCode = d.BookPayCode _
                                              , .BookTypeCode = d.BookTypeCode _
                                              , .Check_No = d.Check_No _
                                              , .Cons_No = d.Cons_No _
                                              , .CurBal = d.CurBal _
                                              , .Invoice_Amt = d.Invoice_Amt _
                                              , .Invoiced = d.Invoiced _
                                              , .Pay_Amt = d.Pay_Amt _
                                              , .Payed = d.Payed _
                                              , .Pro_Number = d.Pro_Number _
                                              , .BookUpdated = If(d.BookUpdated Is Nothing, New Byte() {}, d.BookUpdated)}

    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Return GetRecordFiltered(Control:=CType(LinqTable, LTS.vARMassEntry).BookControl)
    End Function

    Protected Overrides Sub ValidateNewRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'We do not allow booking records to be inserted from this class
        Utilities.SaveAppError("Cannot add data.  Records cannot be inserted using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))
    End Sub

    Protected Overrides Sub ValidateDeletedRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'We do not allow booking records to be deleted from this class
        Utilities.SaveAppError("Cannot delete data.  Records cannot be deleted using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))

    End Sub
#End Region

End Class

Public Class NGLBookRevenueData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.vBookRevenues
        Me.LinqDB = db
    End Sub

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GetBookRevenueFiltered(Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return Nothing
    End Function

    Public Function GetBookRevenueFiltered(ByVal Control As Integer) As DTO.BookRevenue
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'Get the newest record that matches the provided criteria
                Dim oBookRevenue As DTO.BookRevenue = ( _
                From d In db.vBookRevenues _
                Where _
                    d.BookControl = Control _
                Select New DTO.BookRevenue With {.BookControl = d.BookControl, _
                                       .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0), _
                                       .BookRevCarrierCost = If(d.BookREvCarrierCost.HasValue, d.BookREvCarrierCost, 0), _
                                       .BookRevStopQty = If(d.BookRevStopQty.HasValue, d.BookRevStopQty, 0), _
                                       .BookRevStopCost = If(d.BookRevStopCost.HasValue, d.BookRevStopCost, 0), _
                                       .BookRevOtherCost = If(d.BookRevOtherCost.HasValue, d.BookRevOtherCost, 0), _
                                       .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0), _
                                       .BookRevLoadSavings = If(d.BookRevLoadSavings.HasValue, d.BookRevLoadSavings, 0), _
                                       .BookRevCommPercent = If(d.BookRevCommPercent.HasValue, d.BookRevCommPercent, 0), _
                                       .BookRevCommCost = If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0), _
                                       .BookRevGrossRevenue = If(d.BookRevGrossRevenue.HasValue, d.BookRevGrossRevenue, 0), _
                                       .BookRevNegRevenue = If(d.BookRevNegRevenue.HasValue, d.BookRevNegRevenue, 0), _
                                       .BookModDate = d.BookModDate, _
                                       .BookModUser = d.BookModUser, _
                                       .BookFinCommStd = If(d.BookFinCommStd.HasValue, d.BookFinCommStd, 0), _
                                       .BookFinARBookFrt = If(d.BookFinARBookFrt.HasValue, d.BookFinARBookFrt, 0), _
                                       .BookFinAPStdCost = If(d.BookFinAPStdCost.HasValue, d.BookFinAPStdCost, 0), _
                                       .BookRevNetCost = d.BookRevNetCost, _
                                       .BookRevFreightTax = d.BookRevFreightTax, _
                                       .BookTranCode = d.BookTranCode, _
                                       .BookTypeCode = d.BookTypeCode, _
                                       .BookCarrierControl = d.BookCarrierControl, _
                                       .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0), _
                                       .BookProNumber = d.BookProNumber, _
                                       .BookCustCompControl = d.BookCustCompControl, _
                                       .BookFinAPActCost = If(d.BookFinAPActCost.HasValue, d.BookFinAPActCost, 0), _
                                       .BookFinServiceFee = If(d.BookFinServiceFee.HasValue, d.BookFinServiceFee, 0), _
                                       .BookFinAPPayAmt = If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0), _
                                       .BookDateLoad = d.BookDateLoad, _
                                       .BookRouteFinalCode = d.BookRouteFinalCode, _
                                       .BookConsPrefix = d.BookConsPrefix, _
                                       .BookLockAllCosts = d.BookLockAllCosts, _
                                       .BookLockBFCCost = d.BookLockBFCCost, _
                                       .CompFinUseImportFrtCost = d.CompFinUseImportFrtCost, _
                                       .CompanyName = d.CompanyName, _
                                       .CompanyNumber = d.CompanyNumber, _
                                       .BookRevNonTaxable = d.BookRevNonTaxable}).First


                Return oBookRevenue

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary>
    ''' This method should only be called from the booking screen where records are locked 
    ''' or unlocked when set to IC status.  Anyone whom is authorized to make changes to IC
    ''' records will be allowed to recalculate costs
    ''' </summary>
    ''' <param name="oData"></param>
    ''' <param name="AllocateBFC"></param>
    ''' <param name="UpdateBFC"></param>
    ''' <returns></returns>
    ''' <remarks>
    ''' NOTE:
    ''' Modified 3/29/11 by RHR we now call spCalcBookRev50 AllocateBFC and UpdateBFC are no longer used and default to true
    ''' Modifie 5/4/11 by RHR we now call spCalcBookRevBFC with the IgnoreIC flag set to true
    ''' </remarks>
    Public Function SaveAndCalcRevenue(ByVal oData As DTO.BookRevenue, Optional ByVal AllocateBFC As Boolean = True, Optional ByVal UpdateBFC As Boolean = True) As DTO.BookRevenue
        Me.UpdateRecordNoReturn(oData)

        Dim strProcName As String = "dbo.spCalcBookRevBFC"
        Dim oCmd As New System.Data.SqlClient.SqlCommand
        oCmd.Parameters.AddWithValue("@BookControl", oData.BookControl)
        oCmd.Parameters.AddWithValue("@UserName", Left(Me.Parameters.UserName, 100))
        If UpdateBFC Then
            oCmd.Parameters.AddWithValue("@UpdateBFC", 1)
        End If
        'Added by RHR 05/04/11.   
        oCmd.Parameters.AddWithValue("@IgnoreIC", 1)
        runNGLStoredProcedure(oCmd, strProcName, 0)
        Return GetBookRevenueFiltered(oData.BookControl)
    End Function

    Public Function RecalculateFreightCosts(ByVal BookControl As Integer) As DTO.BookRevenue
        Dim strProcName As String = "dbo.spRecalculateFreightCosts"
        Dim oCmd As New System.Data.SqlClient.SqlCommand
        oCmd.Parameters.AddWithValue("@BookControl", BookControl)
        oCmd.Parameters.AddWithValue("@UserName", Left(Me.Parameters.UserName, 100))
        runNGLStoredProcedure(oCmd, strProcName, 0)
        Return GetBookRevenueFiltered(BookControl)
    End Function


    Public Sub RecalculateFreightCostsNoReturn(ByVal BookControl As Integer)
        Dim strProcName As String = "dbo.spRecalculateFreightCosts"
        Dim oCmd As New System.Data.SqlClient.SqlCommand
        oCmd.Parameters.AddWithValue("@BookControl", BookControl)
        oCmd.Parameters.AddWithValue("@UserName", Left(Me.Parameters.UserName, 100))
        runNGLStoredProcedure(oCmd, strProcName, 0)
    End Sub


    Public Overrides Function Update(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity)) As Object
        SaveChanges(oData)
        Dim source As DTO.BookRevenue = TryCast(oData, DTO.BookRevenue)
        If source Is Nothing Then Return Nothing
        Dim oBook As New NGLBookData(Me.Parameters)
        oBook.UpdateCNSLockFlags(source.BookControl)
        ' Return the updated order
        Return GetBookRevenueFiltered(Control:=source.BookControl)

    End Function

    Public Overrides Sub UpdateNoReturn(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity))
        SaveChanges(oData)
        Dim source As DTO.BookRevenue = TryCast(oData, DTO.BookRevenue)
        If source Is Nothing Then Return
        Dim oBook As New NGLBookData(Me.Parameters)
        oBook.UpdateCNSLockFlags(source.BookControl)
    End Sub

#End Region

#Region "Protected Functions"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Dim d = CType(oData, DTO.BookRevenue)
        'Create New Record
        Return New LTS.vBookRevenue With {.BookControl = d.BookControl, _
                                       .BookRevBilledBFC = d.BookRevBilledBFC, _
                                       .BookREvCarrierCost = d.BookRevCarrierCost, _
                                       .BookRevStopQty = d.BookRevStopQty, _
                                       .BookRevStopCost = d.BookRevStopCost, _
                                       .BookRevOtherCost = d.BookRevOtherCost, _
                                       .BookRevTotalCost = d.BookRevTotalCost, _
                                       .BookRevLoadSavings = d.BookRevLoadSavings, _
                                       .BookRevCommPercent = d.BookRevCommPercent, _
                                       .BookRevCommCost = d.BookRevCommCost, _
                                       .BookRevGrossRevenue = d.BookRevGrossRevenue, _
                                       .BookRevNegRevenue = d.BookRevNegRevenue, _
                                       .BookModDate = Date.Now, _
                                       .BookModUser = Me.Parameters.UserName, _
                                       .BookFinCommStd = d.BookFinCommStd, _
                                       .BookFinARBookFrt = d.BookFinARBookFrt, _
                                       .BookFinAPStdCost = d.BookFinAPStdCost, _
                                       .BookRevNetCost = d.BookRevNetCost, _
                                       .BookRevFreightTax = d.BookRevFreightTax, _
                                       .BookTranCode = d.BookTranCode, _
                                       .BookTypeCode = d.BookTypeCode, _
                                       .BookCarrierControl = d.BookCarrierControl, _
                                       .BookTotalBFC = d.BookTotalBFC, _
                                       .BookProNumber = d.BookProNumber, _
                                       .BookCustCompControl = d.BookCustCompControl, _
                                       .BookFinAPActCost = d.BookFinAPActCost, _
                                       .BookFinServiceFee = d.BookFinServiceFee, _
                                       .BookFinAPPayAmt = d.BookFinAPPayAmt, _
                                       .BookDateLoad = d.BookDateLoad, _
                                       .BookRouteFinalCode = d.BookRouteFinalCode, _
                                       .BookConsPrefix = d.BookConsPrefix, _
                                       .BookLockAllCosts = d.BookLockAllCosts, _
                                       .BookLockBFCCost = d.BookLockBFCCost, _
                                       .BookRevNonTaxable = d.BookRevNonTaxable}

    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Dim source As LTS.vBookRevenue = TryCast(LinqTable, LTS.vBookRevenue)
        If source Is Nothing Then Return Nothing
        Dim oBook As New NGLBookData(Me.Parameters)
        oBook.UpdateCNSLockFlags(source.BookControl)
        Return GetRecordFiltered(Control:=source.BookControl)
    End Function

    Protected Overrides Sub NoReturnCleanUp(ByVal LinqTable As Object)
        Dim oData As LTS.vBookRevenue = TryCast(LinqTable, LTS.vBookRevenue)
        If Not oData Is Nothing Then
            Dim oBook As New NGLBookData(Me.Parameters)
            oBook.UpdateCNSLockFlags(oData.BookControl)
        End If
    End Sub

    Protected Overrides Sub ValidateNewRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'We do not allow booking records to be inserted from this class
        Utilities.SaveAppError("Cannot add data.  Records cannot be inserted using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))
    End Sub

    Protected Overrides Sub ValidateDeletedRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'We do not allow booking records to be deleted from this class
        Utilities.SaveAppError("Cannot delete data.  Records cannot be deleted using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))

    End Sub

    Private Sub SaveChanges(ByVal oData As DTO.BookRevenue)
        Using LinqDB
            'Note: the ValidateData Function must throw a FaultException error on failure
            ValidateUpdatedRecord(LinqDB, oData)
            With oData
                Try
                    'Open the existing Record
                    Dim d = (From e In CType(LinqDB, NGLMasBookDataContext).vBookRevenues Where e.BookControl = .BookControl Select e).First
                    If d Is Nothing Then
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_RecordDeleted"}, New FaultReason("E_InvalidOperationException"))
                    Else
                        'Check for conflicts
                        If .BookModDate <> d.BookModDate Then
                            'the data may have changed so check each field for conflicts
                            Dim ConflictData As New List(Of KeyValuePair(Of String, String))
                            Dim blnConflictFound As Boolean = False
                            addToConflicts("BookRevBilledBFC", .BookRevBilledBFC, If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookRevCarrierCost", .BookRevCarrierCost, If(d.BookREvCarrierCost.HasValue, d.BookREvCarrierCost, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookRevStopQty", .BookRevStopQty, If(d.BookRevStopQty.HasValue, d.BookRevStopQty, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookRevStopCost", .BookRevStopCost, If(d.BookRevStopCost.HasValue, d.BookRevStopCost, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookRevOtherCost", .BookRevOtherCost, If(d.BookRevOtherCost.HasValue, d.BookRevOtherCost, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookRevTotalCost", .BookRevTotalCost, If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookRevLoadSavings", .BookRevLoadSavings, If(d.BookRevLoadSavings.HasValue, d.BookRevLoadSavings, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookRevCommPercent", .BookRevCommPercent, If(d.BookRevCommPercent.HasValue, d.BookRevCommPercent, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookRevCommCost", .BookRevCommCost, If(d.BookRevCommCost.HasValue, d.BookRevCommCost, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookRevGrossRevenue", .BookRevGrossRevenue, If(d.BookRevGrossRevenue.HasValue, d.BookRevGrossRevenue, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookRevNegRevenue", .BookRevNegRevenue, If(d.BookRevNegRevenue.HasValue, d.BookRevNegRevenue, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinCommStd", .BookFinCommStd, If(d.BookFinCommStd.HasValue, d.BookFinCommStd, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinARBookFrt", .BookFinARBookFrt, If(d.BookFinARBookFrt.HasValue, d.BookFinARBookFrt, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPStdCost", .BookFinAPStdCost, If(d.BookFinAPStdCost.HasValue, d.BookFinAPStdCost, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookRevNetCost", .BookRevNetCost, d.BookRevNetCost, ConflictData, blnConflictFound)
                            addToConflicts("BookRevFreightTax", .BookRevFreightTax, d.BookRevFreightTax, ConflictData, blnConflictFound)
                            addToConflicts("BookTranCode", .BookTranCode, d.BookTranCode, ConflictData, blnConflictFound)
                            addToConflicts("BookTypeCode", .BookTypeCode, d.BookTypeCode, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrierControl", .BookCarrierControl, d.BookCarrierControl, ConflictData, blnConflictFound)
                            addToConflicts("BookTotalBFC", .BookTotalBFC, If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookProNumber", .BookProNumber, d.BookProNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookCustCompControl", .BookCustCompControl, d.BookCustCompControl, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPActCost", .BookFinAPActCost, If(d.BookFinAPActCost.HasValue, d.BookFinAPActCost, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinServiceFee", .BookFinServiceFee, If(d.BookFinServiceFee.HasValue, d.BookFinServiceFee, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPPayAmt", .BookFinAPPayAmt, If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookDateLoad", .BookDateLoad, d.BookDateLoad, ConflictData, blnConflictFound)
                            addToConflicts("BookConsPrefix", .BookConsPrefix, d.BookConsPrefix, ConflictData, blnConflictFound)
                            addToConflicts("BookLockAllCosts", .BookLockAllCosts, d.BookLockAllCosts, ConflictData, blnConflictFound)
                            addToConflicts("BookLockBFCCost", .BookLockBFCCost, d.BookLockBFCCost, ConflictData, blnConflictFound)
                            addToConflicts("BookRevNonTaxable", .BookRevNonTaxable, d.BookRevNonTaxable, ConflictData, blnConflictFound)
                            If blnConflictFound Then
                                'We only add the mod date and mod user if one or more other fields have been modified
                                addToConflicts("BookModDate", .BookModDate, d.BookModDate, ConflictData, blnConflictFound)
                                addToConflicts("BookModUser", .BookModUser, d.BookModUser, ConflictData, blnConflictFound)
                                Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(ConflictData))
                                conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                                Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                            End If
                        End If
                        'Update the table data
                        d.BookRevBilledBFC = .BookRevBilledBFC
                        d.BookREvCarrierCost = .BookRevCarrierCost
                        d.BookRevStopQty = .BookRevStopQty
                        d.BookRevStopCost = .BookRevStopCost
                        d.BookRevOtherCost = .BookRevOtherCost
                        d.BookRevTotalCost = .BookRevTotalCost
                        d.BookRevLoadSavings = .BookRevLoadSavings
                        d.BookRevCommPercent = .BookRevCommPercent
                        d.BookRevCommCost = .BookRevCommCost
                        d.BookRevGrossRevenue = .BookRevGrossRevenue
                        d.BookRevNegRevenue = .BookRevNegRevenue
                        d.BookModDate = Date.Now
                        d.BookModUser = Me.Parameters.UserName
                        d.BookFinCommStd = .BookFinCommStd
                        d.BookFinARBookFrt = .BookFinARBookFrt
                        d.BookFinAPStdCost = .BookFinAPStdCost
                        d.BookRevNetCost = .BookRevNetCost
                        d.BookRevFreightTax = .BookRevFreightTax
                        d.BookTranCode = .BookTranCode
                        d.BookTypeCode = .BookTypeCode
                        d.BookCarrierControl = .BookCarrierControl
                        d.BookTotalBFC = .BookTotalBFC
                        d.BookProNumber = .BookProNumber
                        d.BookCustCompControl = .BookCustCompControl
                        d.BookFinAPActCost = .BookFinAPActCost
                        d.BookFinServiceFee = .BookFinServiceFee
                        d.BookFinAPPayAmt = .BookFinAPPayAmt
                        d.BookDateLoad = .BookDateLoad
                        d.BookRouteFinalCode = .BookRouteFinalCode
                        d.BookConsPrefix = .BookConsPrefix
                        d.BookLockAllCosts = .BookLockAllCosts
                        d.BookLockBFCCost = .BookLockBFCCost
                        d.BookRevNonTaxable = .BookRevNonTaxable
                    End If
                    LinqDB.SubmitChanges()
                Catch ex As FaultException
                    Throw
                Catch ex As SqlException
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
                Catch conflictEx As ChangeConflictException
                    Try
                        Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(LinqDB))
                        conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                        Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                    Catch ex As FaultException
                        Throw
                    Catch ex As Exception
                        Utilities.SaveAppError(ex.Message, Me.Parameters)
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
                    End Try
                Catch ex As InvalidOperationException
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_RecordDeleted"}, New FaultReason("E_InvalidOperationException"))
                Catch ex As Exception
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
                End Try

            End With
        End Using
    End Sub

#End Region

End Class

Public Class NGLBookCarrierData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.vBookCarriers
        Me.LinqDB = db
    End Sub

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GetBookCarrierFiltered(Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return Nothing
    End Function

    Public Function GetBookCarrierFiltered(ByVal Control As Integer) As DTO.BookCarrier
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'Get the newest record that matches the provided criteria
                Dim oBookCarrier As DTO.BookCarrier = ( _
                From d In db.vBookCarriers _
                Where _
                    d.BookControl = Control _
                Select selectDTOData(d, db)).First



                Return oBookCarrier

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Overrides Function Update(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity)) As Object
        SaveChanges(oData)
        ' Return the updated order
        Return GetBookCarrierFiltered(Control:=oData.BookControl)

    End Function

    Public Overrides Sub UpdateNoReturn(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity))
        SaveChanges(oData)
    End Sub


#End Region

#Region "Protected Functions"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Dim d = CType(oData, DTO.BookCarrier)
        'Create New Record
        Return New LTS.vBookCarrier With {.BookControl = d.BookControl _
                                          , .BookCarrFBNumber = d.BookCarrFBNumber _
                                          , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                          , .BookCarrBLNumber = d.BookCarrBLNumber _
                                          , .BookCarrBookDate = d.BookCarrBookDate _
                                          , .BookCarrBookTime = d.BookCarrBookTime _
                                          , .BookCarrBookContact = d.BookCarrBookContact _
                                          , .BookCarrScheduleDate = d.BookCarrScheduleDate _
                                          , .BookCarrScheduleTime = d.BookCarrScheduleTime _
                                          , .BookCarrActualDate = d.BookCarrActualDate _
                                          , .BookCarrActualTime = d.BookCarrActualTime _
                                          , .BookCarrActLoadComplete_Date = d.BookCarrActLoadComplete_Date _
                                          , .BookCarrActLoadCompleteTime = d.BookCarrActLoadCompleteTime _
                                          , .BookCarrDockPUAssigment = d.BookCarrDockPUAssigment _
                                          , .BookCarrPODate = d.BookCarrPODate _
                                          , .BookCarrPOTime = d.BookCarrPOTime _
                                          , .BookCarrApptDate = d.BookCarrApptDate _
                                          , .BookCarrApptTime = d.BookCarrApptTime _
                                          , .BookCarrActDate = d.BookCarrActDate _
                                          , .BookCarrActTime = d.BookCarrActTime _
                                          , .BookCarrActUnloadCompDate = d.BookCarrActUnloadCompDate _
                                          , .BookCarrActUnloadCompTime = d.BookCarrActUnloadCompTime _
                                          , .BookCarrDockDelAssignment = d.BookCarrDockDelAssignment _
                                          , .BookCarrVarDay = d.BookCarrVarDay _
                                          , .BookCarrVarHrs = d.BookCarrVarHrs _
                                          , .BookCarrTrailerNo = d.BookCarrTrailerNo _
                                          , .BookCarrSealNo = d.BookCarrSealNo _
                                          , .BookCarrDriverNo = d.BookCarrDriverNo _
                                          , .BookCarrDriverName = d.BookCarrDriverName _
                                          , .BookCarrRouteNo = d.BookCarrRouteNo _
                                          , .BookCarrTripNo = d.BookCarrTripNo _
                                          , .BookModDate = Date.Now _
                                          , .BookModUser = Me.Parameters.UserName _
                                          , .BookWhseAuthorizationNo = d.BookWhseAuthorizationNo _
                                          , .BookCarrStartLoadingDate = d.BookCarrStartLoadingDate _
                                          , .BookCarrStartLoadingTime = d.BookCarrStartLoadingTime _
                                          , .BookCarrFinishLoadingDate = d.BookCarrFinishLoadingDate _
                                          , .BookCarrFinishLoadingTime = d.BookCarrFinishLoadingTime _
                                          , .BookCarrStartUnloadingDate = d.BookCarrStartUnloadingDate _
                                          , .BookCarrStartUnloadingTime = d.BookCarrStartUnloadingTime _
                                          , .BookCarrFinishUnloadingDate = d.BookCarrFinishUnloadingDate _
                                          , .BookCarrFinishUnloadingTime = d.BookCarrFinishUnloadingTime _
                                          , .BookAMSDeliveryApptControl = d.BookAMSDeliveryApptControl _
                                          , .BookAMSPickupApptControl = d.BookAMSPickupApptControl}

    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Return GetRecordFiltered(Control:=CType(LinqTable, LTS.vBookCarrier).BookControl)
    End Function

    Protected Overrides Sub ValidateNewRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'We do not allow booking records to be inserted from this class
        Utilities.SaveAppError("Cannot add data.  Records cannot be inserted using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))
    End Sub

    Protected Overrides Sub ValidateDeletedRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'We do not allow booking records to be deleted from this class
        Utilities.SaveAppError("Cannot delete data.  Records cannot be deleted using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))

    End Sub

    Private Sub SaveChanges(ByVal oData As DTO.BookCarrier)
        Using LinqDB
            'Note: the ValidateData Function must throw a FaultException error on failure
            ValidateUpdatedRecord(LinqDB, oData)
            With oData
                Try
                    'Open the existing Record
                    Dim d = (From e In CType(LinqDB, NGLMasBookDataContext).vBookCarriers Where e.BookControl = .BookControl Select e).First
                    If d Is Nothing Then
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_RecordDeleted"}, New FaultReason("E_InvalidOperationException"))
                    Else
                        'Check for conflicts
                        If .BookModDate <> d.BookModDate Then
                            'the data may have changed so check each field for conflicts
                            Dim ConflictData As New List(Of KeyValuePair(Of String, String))
                            Dim blnConflictFound As Boolean = False
                            addToConflicts("BookCarrFBNumber", .BookCarrFBNumber, d.BookCarrFBNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrOrderNumber", .BookCarrOrderNumber, d.BookCarrOrderNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrBLNumber", .BookCarrBLNumber, d.BookCarrBLNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrBookDate", .BookCarrBookDate, d.BookCarrBookDate, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrBookTime", .BookCarrBookTime, d.BookCarrBookTime, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrBookContact", .BookCarrBookContact, d.BookCarrBookContact, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrScheduleDate", .BookCarrScheduleDate, d.BookCarrScheduleDate, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrScheduleTime", .BookCarrScheduleTime, d.BookCarrScheduleTime, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrActualDate", .BookCarrActualDate, d.BookCarrActualDate, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrActualTime", .BookCarrActualTime, d.BookCarrActualTime, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrActLoadComplete_Date", .BookCarrActLoadComplete_Date, d.BookCarrActLoadComplete_Date, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrActLoadCompleteTime", .BookCarrActLoadCompleteTime, d.BookCarrActLoadCompleteTime, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrDockPUAssigment", .BookCarrDockPUAssigment, d.BookCarrDockPUAssigment, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrPODate", .BookCarrPODate, d.BookCarrPODate, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrPOTime", .BookCarrPOTime, d.BookCarrPOTime, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrApptDate", .BookCarrApptDate, d.BookCarrApptDate, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrApptTime", .BookCarrApptTime, d.BookCarrApptTime, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrActDate", .BookCarrActDate, d.BookCarrActDate, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrActTime", .BookCarrActTime, d.BookCarrActTime, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrActUnloadCompDate", .BookCarrActUnloadCompDate, d.BookCarrActUnloadCompDate, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrActUnloadCompTime", .BookCarrActUnloadCompTime, d.BookCarrActUnloadCompTime, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrDockDelAssignment", .BookCarrDockDelAssignment, d.BookCarrDockDelAssignment, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrVarDay", .BookCarrVarDay, If(d.BookCarrVarDay.HasValue, d.BookCarrVarDay, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookCarrVarHrs", .BookCarrVarHrs, If(d.BookCarrVarHrs.HasValue, d.BookCarrVarHrs, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookCarrTrailerNo", .BookCarrTrailerNo, d.BookCarrTrailerNo, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrSealNo", .BookCarrSealNo, d.BookCarrSealNo, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrSealNo", .BookCarrSealNo, d.BookCarrSealNo, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrDriverNo", .BookCarrDriverNo, d.BookCarrDriverNo, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrDriverName", .BookCarrDriverName, d.BookCarrDriverName, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrRouteNo", .BookCarrRouteNo, d.BookCarrRouteNo, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrTripNo", .BookCarrTripNo, d.BookCarrTripNo, ConflictData, blnConflictFound)
                            addToConflicts("BookWhseAuthorizationNo", .BookWhseAuthorizationNo, d.BookWhseAuthorizationNo, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrStartLoadingDate", .BookCarrStartLoadingDate, d.BookCarrStartLoadingDate, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrStartLoadingTime", .BookCarrStartLoadingTime, d.BookCarrStartLoadingTime, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrFinishLoadingDate", .BookCarrFinishLoadingDate, d.BookCarrFinishLoadingDate, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrFinishLoadingTime", .BookCarrFinishLoadingTime, d.BookCarrFinishLoadingTime, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrStartUnloadingDate", .BookCarrStartUnloadingDate, d.BookCarrStartUnloadingDate, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrStartUnloadingTime", .BookCarrStartUnloadingTime, d.BookCarrStartUnloadingTime, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrFinishUnloadingDate", .BookCarrFinishUnloadingDate, d.BookCarrFinishUnloadingDate, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrFinishUnloadingTime", .BookCarrFinishUnloadingTime, d.BookCarrFinishUnloadingTime, ConflictData, blnConflictFound)
                            If blnConflictFound Then
                                'We only add the mod date and mod user if one or more other fields have been modified
                                addToConflicts("BookModDate", .BookModDate, d.BookModDate, ConflictData, blnConflictFound)
                                addToConflicts("BookModUser", .BookModUser, d.BookModUser, ConflictData, blnConflictFound)
                                Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(ConflictData))
                                conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                                Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                            End If
                        End If
                        'Update the table data
                        d.BookCarrFBNumber = .BookCarrFBNumber
                        d.BookCarrOrderNumber = .BookCarrOrderNumber
                        d.BookCarrBLNumber = .BookCarrBLNumber
                        d.BookCarrBookDate = .BookCarrBookDate
                        d.BookCarrBookTime = .BookCarrBookTime
                        d.BookCarrBookContact = .BookCarrBookContact
                        d.BookCarrScheduleDate = .BookCarrScheduleDate
                        d.BookCarrScheduleTime = .BookCarrScheduleTime
                        d.BookCarrActualDate = .BookCarrActualDate
                        d.BookCarrActualTime = .BookCarrActualTime
                        d.BookCarrActLoadComplete_Date = .BookCarrActLoadComplete_Date
                        d.BookCarrActLoadCompleteTime = .BookCarrActLoadCompleteTime
                        d.BookCarrDockPUAssigment = .BookCarrDockPUAssigment
                        d.BookCarrPODate = .BookCarrPODate
                        d.BookCarrPOTime = .BookCarrPOTime
                        d.BookCarrApptDate = .BookCarrApptDate
                        d.BookCarrApptTime = .BookCarrApptTime
                        d.BookCarrActDate = .BookCarrActDate
                        d.BookCarrActTime = .BookCarrActTime
                        d.BookCarrActUnloadCompDate = .BookCarrActUnloadCompDate
                        d.BookCarrActUnloadCompTime = .BookCarrActUnloadCompTime
                        d.BookCarrDockDelAssignment = .BookCarrDockDelAssignment
                        d.BookCarrVarDay = .BookCarrVarDay
                        d.BookCarrVarHrs = .BookCarrVarHrs
                        d.BookCarrTrailerNo = .BookCarrTrailerNo
                        d.BookCarrSealNo = .BookCarrSealNo
                        d.BookCarrDriverNo = .BookCarrDriverNo
                        d.BookCarrDriverName = .BookCarrDriverName
                        d.BookCarrRouteNo = .BookCarrRouteNo
                        d.BookCarrTripNo = .BookCarrTripNo
                        d.BookModDate = Date.Now
                        d.BookModUser = Me.Parameters.UserName
                        d.BookWhseAuthorizationNo = .BookWhseAuthorizationNo
                        d.BookCarrStartLoadingDate = .BookCarrStartLoadingDate
                        d.BookCarrStartLoadingTime = .BookCarrStartLoadingTime
                        d.BookCarrFinishLoadingDate = .BookCarrFinishLoadingDate
                        d.BookCarrFinishLoadingTime = .BookCarrFinishLoadingTime
                        d.BookCarrStartUnloadingDate = .BookCarrStartUnloadingDate
                        d.BookCarrStartUnloadingTime = .BookCarrStartUnloadingTime
                        d.BookCarrFinishUnloadingDate = .BookCarrFinishUnloadingDate
                        d.BookCarrFinishUnloadingTime = .BookCarrFinishUnloadingTime
                    End If
                    LinqDB.SubmitChanges()
                Catch ex As FaultException
                    Throw
                Catch ex As SqlException
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
                Catch conflictEx As ChangeConflictException
                    Try
                        Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(LinqDB))
                        conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                        Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                    Catch ex As FaultException
                        Throw
                    Catch ex As Exception
                        Utilities.SaveAppError(ex.Message, Me.Parameters)
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
                    End Try
                Catch ex As InvalidOperationException
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_RecordDeleted"}, New FaultReason("E_InvalidOperationException"))
                Catch ex As Exception
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
                End Try

            End With
        End Using
    End Sub

    Friend Function selectDTOData(ByVal d As LTS.vBookCarrier, ByRef db As NGLMasBookDataContext) As DTO.BookCarrier

        Return New DTO.BookCarrier With {.BookControl = d.BookControl _
                                            , .BookCarrFBNumber = d.BookCarrFBNumber _
                                            , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                            , .BookCarrBLNumber = d.BookCarrBLNumber _
                                            , .BookCarrBookDate = d.BookCarrBookDate _
                                            , .BookCarrBookTime = d.BookCarrBookTime _
                                            , .BookCarrBookContact = d.BookCarrBookContact _
                                            , .BookCarrScheduleDate = d.BookCarrScheduleDate _
                                            , .BookCarrScheduleTime = d.BookCarrScheduleTime _
                                            , .BookCarrActualDate = d.BookCarrActualDate _
                                            , .BookCarrActualTime = d.BookCarrActualTime _
                                            , .BookCarrActLoadComplete_Date = d.BookCarrActLoadComplete_Date _
                                            , .BookCarrActLoadCompleteTime = d.BookCarrActLoadCompleteTime _
                                            , .BookCarrDockPUAssigment = d.BookCarrDockPUAssigment _
                                            , .BookCarrPODate = d.BookCarrPODate _
                                            , .BookCarrPOTime = d.BookCarrPOTime _
                                            , .BookCarrApptDate = d.BookCarrApptDate _
                                            , .BookCarrApptTime = d.BookCarrApptTime _
                                            , .BookCarrActDate = d.BookCarrActDate _
                                            , .BookCarrActTime = d.BookCarrActTime _
                                            , .BookCarrActUnloadCompDate = d.BookCarrActUnloadCompDate _
                                            , .BookCarrActUnloadCompTime = d.BookCarrActUnloadCompTime _
                                            , .BookCarrDockDelAssignment = d.BookCarrDockDelAssignment _
                                            , .BookCarrVarDay = If(d.BookCarrVarDay.HasValue, d.BookCarrVarDay, 0) _
                                            , .BookCarrVarHrs = If(d.BookCarrVarHrs.HasValue, d.BookCarrVarHrs, 0) _
                                            , .BookCarrTrailerNo = d.BookCarrTrailerNo _
                                            , .BookCarrSealNo = d.BookCarrSealNo _
                                            , .BookCarrDriverNo = d.BookCarrDriverNo _
                                            , .BookCarrDriverName = d.BookCarrDriverName _
                                            , .BookCarrRouteNo = d.BookCarrRouteNo _
                                            , .BookCarrTripNo = d.BookCarrTripNo _
                                            , .BookModDate = d.BookModDate _
                                            , .BookModUser = d.BookModUser _
                                            , .BookWhseAuthorizationNo = d.BookWhseAuthorizationNo _
                                            , .BookCarrStartLoadingDate = d.BookCarrStartLoadingDate _
                                            , .BookCarrStartLoadingTime = d.BookCarrStartLoadingTime _
                                            , .BookCarrFinishLoadingDate = d.BookCarrFinishLoadingDate _
                                            , .BookCarrFinishLoadingTime = d.BookCarrFinishLoadingTime _
                                            , .BookCarrStartUnloadingDate = d.BookCarrStartUnloadingDate _
                                            , .BookCarrStartUnloadingTime = d.BookCarrStartUnloadingTime _
                                            , .BookCarrFinishUnloadingDate = d.BookCarrFinishUnloadingDate _
                                            , .BookCarrFinishUnloadingTime = d.BookCarrFinishUnloadingTime _
                                            , .BookAMSDeliveryApptControl = d.BookAMSDeliveryApptControl _
                                            , .BookAMSPickupApptControl = d.BookAMSPickupApptControl}
    End Function


#End Region

End Class

Public Class NGLBookFinancialData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.vBookFinancials
        Me.LinqDB = db
    End Sub

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GetBookFinancialFiltered(Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return Nothing
    End Function

    Public Function GetBookFinancialFiltered(ByVal Control As Integer) As DTO.BookFinancial
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'Get the newest record that matches the provided criteria
                Dim oBookFinancial As DTO.BookFinancial = ( _
                From d In db.vBookFinancials _
                Where _
                    d.BookControl = Control _
                Select New DTO.BookFinancial With {.BookControl = d.BookControl _
                                            , .BookCarrierControl = d.BookCarrierControl _
                                            , .BookFinARBookFrt = If(d.BookFinARBookFrt.HasValue, d.BookFinARBookFrt, 0) _
                                            , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                            , .BookFinARInvoiceAmt = If(d.BookFinARInvoiceAmt.HasValue, d.BookFinARInvoiceAmt, 0) _
                                            , .BookFinARPayDate = d.BookFinARPayDate _
                                            , .BookFinARPayAmt = If(d.BookFinARPayAmt.HasValue, d.BookFinARPayAmt, 0) _
                                            , .BookFinARCheck = d.BookFinARCheck _
                                            , .BookFinARGLNumber = d.BookFinARGLNumber _
                                            , .BookFinARBalance = If(d.BookFinARBalance.HasValue, d.BookFinARBalance, 0) _
                                            , .BookFinARCurType = If(d.BookFinARCurType.HasValue, d.BookFinARCurType, 0) _
                                            , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                            , .BookFinAPBillNoDate = d.BookFinAPBillNoDate _
                                            , .BookFinAPBillInvDate = d.BookFinAPBillInvDate _
                                            , .BookFinAPActWgt = If(d.BookFinAPActWgt.HasValue, d.BookFinAPActWgt, 0) _
                                            , .BookFinAPStdCost = If(d.BookFinAPStdCost.HasValue, d.BookFinAPStdCost, 0) _
                                            , .BookFinAPActCost = If(d.BookFinAPActCost.HasValue, d.BookFinAPActCost, 0) _
                                            , .BookFinAPPayDate = d.BookFinAPPayDate _
                                            , .BookFinAPPayAmt = If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0) _
                                            , .BookFinAPCheck = d.BookFinAPCheck _
                                            , .BookFinAPGLNumber = d.BookFinAPGLNumber _
                                            , .BookFinAPLastViewed = d.BookFinAPLastViewed _
                                            , .BookFinAPCurType = If(d.BookFinAPCurType.HasValue, d.BookFinAPCurType, 0) _
                                            , .BookFinCommStd = If(d.BookFinCommStd.HasValue, d.BookFinCommStd, 0) _
                                            , .BookFinCommAct = If(d.BookFinCommAct.HasValue, d.BookFinCommAct, 0) _
                                            , .BookFinCommPayDate = d.BookFinCommPayDate _
                                            , .BookFinCommPayAmt = If(d.BookFinCommPayAmt.HasValue, d.BookFinCommPayAmt, 0) _
                                            , .BookFinCommtCheck = d.BookFinCommtCheck _
                                            , .BookFinCommCreditAmt = If(d.BookFinCommCreditAmt.HasValue, d.BookFinCommCreditAmt, 0) _
                                            , .BookFinCommCreditPayDate = d.BookFinCommCreditPayDate _
                                            , .BookFinCommLoadCount = If(d.BookFinCommLoadCount.HasValue, d.BookFinCommLoadCount, 0) _
                                            , .BookFinCommGLNumber = d.BookFinCommGLNumber _
                                            , .BookFinCheckClearedDate = d.BookFinCheckClearedDate _
                                            , .BookFinCheckClearedNumber = d.BookFinCheckClearedNumber _
                                            , .BookFinCheckClearedAmt = If(d.BookFinCheckClearedAmt.HasValue, d.BookFinCheckClearedAmt, 0) _
                                            , .BookFinCheckClearedDesc = d.BookFinCheckClearedDesc _
                                            , .BookFinCheckClearedAcct = d.BookFinCheckClearedAcct _
                                            , .BookModDate = d.BookModDate _
                                            , .BookModUser = d.BookModUser _
                                            , .BookFinAPExportFlag = d.BookFinAPExportFlag _
                                            , .BookFinServiceFee = If(d.BookFinServiceFee.HasValue, d.BookFinServiceFee, 0) _
                                            , .BookFinAPExportDate = d.BookFinAPExportDate _
                                            , .BookFinAPExportRetry = If(d.BookFinAPExportRetry.HasValue, d.BookFinAPExportRetry, 0) _
                                            , .BookDoNotInvoice = d.BookDoNotInvoice _
                                            , .BookDateLoad = d.BookDateLoad _
                                            , .BookRouteFinalCode = d.BookRouteFinalCode _
                                            , .BookConsPrefix = d.BookConsPrefix _
                                            , .ARCustomerText = d.ARCustomerText _
                                            , .APCarrierText = d.APCarrierText _
                                            , .APCommissionsText = d.APCommissionsText}).First

                Return oBookFinancial

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Overrides Function Update(Of TEntity As Class)(ByVal oData As Object, _
                              ByVal oLinqTable As System.Data.Linq.Table(Of TEntity)) As Object
        SaveChanges(oData)
        ' Return the updated order
        Return GetBookFinancialFiltered(Control:=oData.BookControl)

    End Function

    Public Overrides Sub UpdateNoReturn(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity))
        SaveChanges(oData)
    End Sub

#End Region

#Region "Protected Functions"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Dim d = CType(oData, DTO.BookFinancial)
        'Create New Record
        Return New LTS.vBookFinancial With {.BookControl = d.BookControl _
                                          , .BookCarrierControl = d.BookCarrierControl _
                                          , .BookFinARBookFrt = d.BookFinARBookFrt _
                                          , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                          , .BookFinARInvoiceAmt = d.BookFinARInvoiceAmt _
                                          , .BookFinARPayDate = d.BookFinARPayDate _
                                          , .BookFinARPayAmt = d.BookFinARPayAmt _
                                          , .BookFinARCheck = d.BookFinARCheck _
                                          , .BookFinARGLNumber = d.BookFinARGLNumber _
                                          , .BookFinARBalance = d.BookFinARBalance _
                                          , .BookFinARCurType = d.BookFinARCurType _
                                          , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                          , .BookFinAPBillNoDate = d.BookFinAPBillNoDate _
                                          , .BookFinAPBillInvDate = d.BookFinAPBillInvDate _
                                          , .BookFinAPActWgt = d.BookFinAPActWgt _
                                          , .BookFinAPStdCost = d.BookFinAPStdCost _
                                          , .BookFinAPActCost = d.BookFinAPActCost _
                                          , .BookFinAPPayDate = d.BookFinAPPayDate _
                                          , .BookFinAPPayAmt = d.BookFinAPPayAmt _
                                          , .BookFinAPCheck = d.BookFinAPCheck _
                                          , .BookFinAPGLNumber = d.BookFinAPGLNumber _
                                          , .BookFinAPLastViewed = d.BookFinAPLastViewed _
                                          , .BookFinAPCurType = d.BookFinAPCurType _
                                          , .BookFinCommStd = d.BookFinCommStd _
                                          , .BookFinCommAct = d.BookFinCommAct _
                                          , .BookFinCommPayDate = d.BookFinCommPayDate _
                                          , .BookFinCommPayAmt = d.BookFinCommPayAmt _
                                          , .BookFinCommtCheck = d.BookFinCommtCheck _
                                          , .BookFinCommCreditAmt = d.BookFinCommCreditAmt _
                                          , .BookFinCommCreditPayDate = d.BookFinCommCreditPayDate _
                                          , .BookFinCommLoadCount = d.BookFinCommLoadCount _
                                          , .BookFinCommGLNumber = d.BookFinCommGLNumber _
                                          , .BookFinCheckClearedDate = d.BookFinCheckClearedDate _
                                          , .BookFinCheckClearedNumber = d.BookFinCheckClearedNumber _
                                          , .BookFinCheckClearedAmt = d.BookFinCheckClearedAmt _
                                          , .BookFinCheckClearedDesc = d.BookFinCheckClearedDesc _
                                          , .BookFinCheckClearedAcct = d.BookFinCheckClearedAcct _
                                          , .BookModDate = Date.Now _
                                          , .BookModUser = Me.Parameters.UserName _
                                          , .BookFinAPExportFlag = d.BookFinAPExportFlag _
                                          , .BookFinServiceFee = d.BookFinServiceFee _
                                          , .BookFinAPExportDate = d.BookFinAPExportDate _
                                          , .BookFinAPExportRetry = d.BookFinAPExportRetry _
                                          , .BookDoNotInvoice = d.BookDoNotInvoice _
                                          , .BookDateLoad = d.BookDateLoad _
                                          , .BookRouteFinalCode = d.BookRouteFinalCode _
                                          , .BookConsPrefix = d.BookConsPrefix}

    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Return GetRecordFiltered(Control:=CType(LinqTable, LTS.vBookFinancial).BookControl)
    End Function

    Protected Overrides Sub ValidateNewRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'We do not allow booking records to be inserted from this class
        Utilities.SaveAppError("Cannot add data.  Records cannot be inserted using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))
    End Sub

    Protected Overrides Sub ValidateDeletedRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'We do not allow booking records to be deleted from this class
        Utilities.SaveAppError("Cannot delete data.  Records cannot be deleted using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))

    End Sub

    Private Sub SaveChanges(ByVal oData As DTO.BookFinancial)
        Using LinqDB
            'Note: the ValidateData Function must throw a FaultException error on failure
            ValidateUpdatedRecord(LinqDB, oData)
            With oData
                Try
                    'LinqDB.Log = New DebugTextWriter
                    'Open the existing Record
                    Dim d = (From e In CType(LinqDB, NGLMasBookDataContext).vBookFinancials Where e.BookControl = .BookControl Select e).First
                    If d Is Nothing Then
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_RecordDeleted"}, New FaultReason("E_InvalidOperationException"))
                    Else
                        'Check for conflicts
                        If .BookModDate <> d.BookModDate Then
                            'the data has changed so check each field for conflicts
                            Dim ConflictData As New List(Of KeyValuePair(Of String, String))
                            Dim blnConflictFound As Boolean = False
                            addToConflicts("BookCarrierControl", .BookCarrierControl, d.BookCarrierControl, ConflictData, blnConflictFound)
                            addToConflicts("BookFinARBookFrt", .BookFinARBookFrt, If(d.BookFinARBookFrt.HasValue, d.BookFinARBookFrt, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinARInvoiceDate", .BookFinARInvoiceDate, d.BookFinARInvoiceDate, ConflictData, blnConflictFound)
                            addToConflicts("BookFinARInvoiceAmt", .BookFinARInvoiceAmt, If(d.BookFinARInvoiceAmt.HasValue, d.BookFinARInvoiceAmt, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinARPayDate", .BookFinARPayDate, d.BookFinARPayDate, ConflictData, blnConflictFound)
                            addToConflicts("BookFinARPayAmt", .BookFinARPayAmt, If(d.BookFinARPayAmt.HasValue, d.BookFinARPayAmt, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinARCheck", .BookFinARCheck, d.BookFinARCheck, ConflictData, blnConflictFound)
                            addToConflicts("BookFinARGLNumber", .BookFinARGLNumber, d.BookFinARGLNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookFinARBalance", .BookFinARBalance, d.BookFinARBalance, ConflictData, blnConflictFound)
                            addToConflicts("BookFinARCurType", .BookFinARCurType, d.BookFinARCurType, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPBillNumber", .BookFinAPBillNumber, d.BookFinAPBillNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPBillNoDate", .BookFinAPBillNoDate, d.BookFinAPBillNoDate, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPBillInvDate", .BookFinAPBillInvDate, d.BookFinAPBillInvDate, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPActWgt", .BookFinAPActWgt, If(d.BookFinAPActWgt.HasValue, d.BookFinAPActWgt, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPStdCost", .BookFinAPStdCost, If(d.BookFinAPStdCost.HasValue, d.BookFinAPStdCost, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPActCost", .BookFinAPActCost, If(d.BookFinAPActCost.HasValue, d.BookFinAPActCost, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPPayDate", .BookFinAPPayDate, d.BookFinAPPayDate, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPPayAmt", .BookFinAPPayAmt, If(d.BookFinAPPayAmt.HasValue, d.BookFinAPPayAmt, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPCheck", .BookFinAPCheck, d.BookFinAPCheck, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPGLNumber", .BookFinAPGLNumber, d.BookFinAPGLNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPLastViewed", .BookFinAPLastViewed, d.BookFinAPLastViewed, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPCurType", .BookFinAPCurType, If(d.BookFinAPCurType.HasValue, d.BookFinAPCurType, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinCommStd", .BookFinCommStd, If(d.BookFinCommStd.HasValue, d.BookFinCommStd, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinCommAct", .BookFinCommAct, If(d.BookFinCommAct.HasValue, d.BookFinCommAct, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinCommPayDate", .BookFinCommPayDate, d.BookFinCommPayDate, ConflictData, blnConflictFound)
                            addToConflicts("BookFinCommPayAmt", .BookFinCommPayAmt, If(d.BookFinCommPayAmt.HasValue, d.BookFinCommPayAmt, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinCommtCheck", .BookFinCommtCheck, d.BookFinCommtCheck, ConflictData, blnConflictFound)
                            addToConflicts("BookFinCommCreditAmt", .BookFinCommCreditAmt, If(d.BookFinCommCreditAmt.HasValue, d.BookFinCommCreditAmt, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinCommCreditPayDate", .BookFinCommCreditPayDate, d.BookFinCommCreditPayDate, ConflictData, blnConflictFound)
                            addToConflicts("BookFinCommLoadCount", .BookFinCommLoadCount, If(d.BookFinCommLoadCount.HasValue, d.BookFinCommLoadCount, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinCommGLNumber", .BookFinCommGLNumber, d.BookFinCommGLNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookFinCheckClearedDate", .BookFinCheckClearedDate, d.BookFinCheckClearedDate, ConflictData, blnConflictFound)
                            addToConflicts("BookFinCheckClearedNumber", .BookFinCheckClearedNumber, d.BookFinCheckClearedNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookFinCheckClearedAmt", .BookFinCheckClearedAmt, d.BookFinCheckClearedAmt, ConflictData, blnConflictFound)
                            addToConflicts("BookFinCheckClearedDesc", .BookFinCheckClearedDesc, d.BookFinCheckClearedDesc, ConflictData, blnConflictFound)
                            addToConflicts("BookFinCheckClearedAcct", .BookFinCheckClearedAcct, d.BookFinCheckClearedAcct, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPExportFlag", .BookFinAPExportFlag, d.BookFinAPExportFlag, ConflictData, blnConflictFound)
                            addToConflicts("BookFinServiceFee", .BookFinServiceFee, If(d.BookFinServiceFee.HasValue, d.BookFinServiceFee, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPExportDate", .BookFinAPExportDate, d.BookFinAPExportDate, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPExportRetry", .BookFinAPExportRetry, If(d.BookFinAPExportRetry.HasValue, d.BookFinAPExportRetry, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookDoNotInvoice", .BookDoNotInvoice, d.BookDoNotInvoice, ConflictData, blnConflictFound)
                            addToConflicts("BookDateLoad", .BookDateLoad, d.BookDateLoad, ConflictData, blnConflictFound)
                            addToConflicts("BookRouteFinalCode", .BookRouteFinalCode, d.BookRouteFinalCode, ConflictData, blnConflictFound)
                            addToConflicts("BookConsPrefix", .BookConsPrefix, d.BookConsPrefix, ConflictData, blnConflictFound)
                            If blnConflictFound Then
                                'We only add the mod date and mod user if one or more other fields have been modified
                                addToConflicts("BookModDate", .BookModDate, d.BookModDate, ConflictData, blnConflictFound)
                                addToConflicts("BookModUser", .BookModUser, d.BookModUser, ConflictData, blnConflictFound)
                                Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(ConflictData))
                                conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                                Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                            End If
                        End If
                        'Update the table data
                        d.BookCarrierControl = .BookCarrierControl
                        d.BookFinARBookFrt = .BookFinARBookFrt
                        d.BookFinARInvoiceDate = .BookFinARInvoiceDate
                        d.BookFinARInvoiceAmt = .BookFinARInvoiceAmt
                        d.BookFinARPayDate = .BookFinARPayDate
                        d.BookFinARPayAmt = .BookFinARPayAmt
                        d.BookFinARCheck = .BookFinARCheck
                        d.BookFinARGLNumber = .BookFinARGLNumber
                        d.BookFinARBalance = .BookFinARBalance
                        d.BookFinARCurType = .BookFinARCurType
                        d.BookFinAPBillNumber = .BookFinAPBillNumber
                        d.BookFinAPBillNoDate = .BookFinAPBillNoDate
                        d.BookFinAPBillInvDate = .BookFinAPBillInvDate
                        d.BookFinAPActWgt = .BookFinAPActWgt
                        d.BookFinAPStdCost = .BookFinAPStdCost
                        d.BookFinAPActCost = .BookFinAPActCost
                        d.BookFinAPPayDate = .BookFinAPPayDate
                        d.BookFinAPPayAmt = .BookFinAPPayAmt
                        d.BookFinAPCheck = .BookFinAPCheck
                        d.BookFinAPGLNumber = .BookFinAPGLNumber
                        d.BookFinAPLastViewed = .BookFinAPLastViewed
                        d.BookFinAPCurType = .BookFinAPCurType
                        d.BookFinCommStd = .BookFinCommStd
                        d.BookFinCommAct = .BookFinCommAct
                        d.BookFinCommPayDate = .BookFinCommPayDate
                        d.BookFinCommPayAmt = .BookFinCommPayAmt
                        d.BookFinCommtCheck = .BookFinCommtCheck
                        d.BookFinCommCreditAmt = .BookFinCommCreditAmt
                        d.BookFinCommCreditPayDate = .BookFinCommCreditPayDate
                        d.BookFinCommLoadCount = .BookFinCommLoadCount
                        d.BookFinCommGLNumber = .BookFinCommGLNumber
                        d.BookFinCheckClearedDate = .BookFinCheckClearedDate
                        d.BookFinCheckClearedNumber = .BookFinCheckClearedNumber
                        d.BookFinCheckClearedAmt = .BookFinCheckClearedAmt
                        d.BookFinCheckClearedDesc = .BookFinCheckClearedDesc
                        d.BookFinCheckClearedAcct = .BookFinCheckClearedAcct
                        d.BookModDate = Date.Now
                        d.BookModUser = Me.Parameters.UserName
                        d.BookFinAPExportFlag = .BookFinAPExportFlag
                        d.BookFinServiceFee = .BookFinServiceFee
                        d.BookFinAPExportDate = .BookFinAPExportDate
                        d.BookFinAPExportRetry = .BookFinAPExportRetry
                        d.BookDoNotInvoice = .BookDoNotInvoice
                        d.BookDateLoad = .BookDateLoad
                        d.BookRouteFinalCode = .BookRouteFinalCode
                        d.BookConsPrefix = .BookConsPrefix
                    End If
                    LinqDB.SubmitChanges()
                Catch ex As FaultException
                    Throw
                Catch ex As SqlException
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
                Catch conflictEx As ChangeConflictException
                    Try
                        Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(LinqDB))
                        conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                        Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                    Catch ex As FaultException
                        Throw
                    Catch ex As Exception
                        Utilities.SaveAppError(ex.Message, Me.Parameters)
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
                    End Try
                Catch ex As InvalidOperationException
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_RecordDeleted"}, New FaultReason("E_InvalidOperationException"))
                Catch ex As Exception
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
                End Try

            End With
        End Using
    End Sub

#End Region

End Class

Public Class NGLBookLoadDetailData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.vBookLoadMaintenances
        Me.LinqDB = db
    End Sub

#End Region

#Region "Properties"
    Private _RecalcTotals As Boolean = False
#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GetBookLoadDetailFiltered(Control:=Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return GetBookLoadDetailsFiltered()
    End Function

    Public Function GetBookLoadDetailsByCarrier(ByVal CarrierControl As Integer) As DTO.BookLoadDetail()
        If CarrierControl = 0 Then Return Nothing
        Return GetBookLoadDetailsFiltered(CarrierControl:=CarrierControl)
    End Function

    Public Function GetBookLoadDetailsByComp(ByVal CompControl As Integer) As DTO.BookLoadDetail()
        If CompControl = 0 Then Return Nothing
        Return GetBookLoadDetailsFiltered(CompControl:=CompControl)
    End Function

    Public Function GetBookLoadDetailsByLane(ByVal LaneControl As Integer) As DTO.BookLoadDetail()
        If LaneControl = 0 Then Return Nothing
        Return GetBookLoadDetailsFiltered(LaneControl:=LaneControl)
    End Function

    Public Function GetBookLoadDetailFiltered(Optional ByVal Control As Integer = 0, _
                                    Optional ByVal BookProNumber As String = "", _
                                    Optional ByVal BookConsPrefix As String = "", _
                                    Optional ByVal BookLoadPONumber As String = "", _
                                    Optional ByVal BookCarrBLNumber As String = "", _
                                    Optional ByVal BookFinAPBillNumber As String = "", _
                                    Optional ByVal BookCarrOrderNumber As String = "", _
                                    Optional ByVal BookOrderSequence As Integer = 0) As DTO.BookLoadDetail
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'Get the newest record that matches the provided criteria                
                    Dim BookLoadDetail As DTO.BookLoadDetail = ( _
                    From d In db.vBookLoadMaintenances _
                    Where _
                        (d.BookControl = If(Control = 0, d.BookControl, Control)) _
                        And _
                        (BookProNumber Is Nothing OrElse String.IsNullOrEmpty(BookProNumber) OrElse d.BookProNumber = BookProNumber) _
                        And _
                        (BookConsPrefix Is Nothing OrElse String.IsNullOrEmpty(BookConsPrefix) OrElse d.BookConsPrefix = BookConsPrefix) _
                        And _
                        (BookCarrBLNumber Is Nothing OrElse String.IsNullOrEmpty(BookCarrBLNumber) OrElse d.BookCarrBLNumber = BookCarrBLNumber) _
                        And _
                        (BookFinAPBillNumber Is Nothing OrElse String.IsNullOrEmpty(BookFinAPBillNumber) OrElse d.BookFinAPBillNumber = BookFinAPBillNumber) _
                        And _
                        (BookCarrOrderNumber Is Nothing OrElse String.IsNullOrEmpty(BookCarrOrderNumber) OrElse d.BookCarrOrderNumber = BookCarrOrderNumber) _
                        And _
                        (BookOrderSequence = 0 OrElse d.BookOrderSequence = BookOrderSequence) _
                    Order By d.BookStopNo Ascending _
                    Select New DTO.BookLoadDetail With {.BookControl = d.BookControl _
                                                , .BookProNumber = d.BookProNumber _
                                                , .BookProBase = d.BookProBase _
                                                , .BookConsPrefix = d.BookConsPrefix _
                                                , .BookCustCompControl = d.BookCustCompControl _
                                                , .BookCommCompControl = d.BookCommCompControl _
                                                , .BookODControl = d.BookODControl _
                                                , .BookCarrierControl = d.BookCarrierControl _
                                                , .BookCarrierContact = d.BookCarrierContact _
                                                , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                                , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                                , .BookOrigName = d.BookOrigName _
                                                , .BookOrigAddress1 = d.BookOrigAddress1 _
                                                , .BookOrigAddress2 = d.BookOrigAddress2 _
                                                , .BookOrigAddress3 = d.BookOrigAddress3 _
                                                , .BookOrigCity = d.BookOrigCity _
                                                , .BookOrigState = d.BookOrigState _
                                                , .BookOrigCountry = d.BookOrigCountry _
                                                , .BookOrigZip = d.BookOrigZip _
                                                , .BookOrigPhone = d.BookOrigPhone _
                                                , .BookOrigFax = d.BookOrigFax _
                                                , .BookOriginStartHrs = d.BookOriginStartHrs _
                                                , .BookOriginStopHrs = d.BookOriginStopHrs _
                                                , .BookOriginApptReq = If(d.BookOriginApptReq.HasValue, d.BookOriginApptReq, False) _
                                                , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                                , .BookDestName = d.BookDestName _
                                                , .BookDestAddress1 = d.BookDestAddress1 _
                                                , .BookDestAddress2 = d.BookDestAddress2 _
                                                , .BookDestAddress3 = d.BookDestAddress3 _
                                                , .BookDestCity = d.BookDestCity _
                                                , .BookDestState = d.BookDestState _
                                                , .BookDestCountry = d.BookDestCountry _
                                                , .BookDestZip = d.BookDestZip _
                                                , .BookDestPhone = d.BookDestPhone _
                                                , .BookDestFax = d.BookDestFax _
                                                , .BookDestStartHrs = d.BookDestStartHrs _
                                                , .BookDestStopHrs = d.BookDestStopHrs _
                                                , .BookDestApptReq = If(d.BookDestApptReq.HasValue, d.BookDestApptReq, False) _
                                                , .BookDateOrdered = d.BookDateOrdered _
                                                , .BookDateLoad = d.BookDateLoad _
                                                , .BookDateInvoice = d.BookDateInvoice _
                                                , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                                , .BookDateRequired = d.BookDateRequired _
                                                , .BookDateDelivered = d.BookDateDelivered _
                                                , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                                , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                                , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                                , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                                , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                                , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                                , .BookTranCode = d.BookTranCode _
                                                , .BookPayCode = d.BookPayCode _
                                                , .BookTypeCode = d.BookTypeCode _
                                                , .BookBOLCode = d.BookBOLCode _
                                                , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                                , .BookModDate = d.BookModDate _
                                                , .BookModUser = d.BookModUser _
                                                , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                                , .BookCarrBLNumber = d.BookCarrBLNumber _
                                                , .BookCarrActDate = d.BookCarrActDate _
                                                , .BookCarrActTime = d.BookCarrActTime _
                                                , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                                , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                                , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                                , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                                , .BookRouteFinalDate = d.BookRouteFinalDate _
                                                , .BookRouteFinalCode = d.BookRouteFinalCode _
                                                , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                                , .BookWarehouseNumber = d.BookWarehouseNumber _
                                                , .BookComCode = d.BookComCode _
                                                , .BookTransType = d.BookTransType _
                                                , .BookRouteConsFlag = d.BookRouteConsFlag _
                                                , .BookHotLoad = If(d.BookHotLoad.HasValue, d.BookHotLoad, False) _
                                                , .BookCarrierContControl = If(d.BookCarrierContControl.HasValue, d.BookCarrierContControl, 0) _
                                                , .BookExportDocCreated = If(d.BookExportDocCreated.HasValue, d.BookExportDocCreated, False) _
                                                , .BookDoNotInvoice = d.BookDoNotInvoice _
                                                , .BookOrderSequence = d.BookOrderSequence _
                                                , .BookShipCarrierProNumber = d.BookShipCarrierProNumber _
                                                , .BookShipCarrierName = d.BookShipCarrierName _
                                                , .BookShipCarrierNumber = d.BookShipCarrierNumber _
                                                , .BookAPAdjReasonControl = d.BookAPAdjReasonControl _
                                                , .BookDateRequested = d.BookDateRequested _
                                                , .BookCarrierEquipmentCodes = d.BookCarrierEquipmentCodes _
                                                , .BookLockAllCosts = d.BookLockAllCosts _
                                                , .BookLockBFCCost = d.BookLockBFCCost _
                                                , .BookDestStopNumber = d.BookDestStopNumber _
                                                , .BookOrigStopNumber = d.BookOrigStopNumber _
                                                , .BookDestStopControl = d.BookDestStopControl _
                                                , .BookOrigStopControl = d.BookOrigStopControl _
                                                , .BookRouteTypeCode = d.BookRouteTypeCode _
                                                , .BookAlternateAddressLaneControl = d.BookAlternateAddressLaneControl _
                                                , .BookAlternateAddressLaneNumber = d.BookAlternateAddressLaneNumber _
                                                , .BookDefaultRouteSequence = d.BookDefaultRouteSequence _
                                                , .BookRouteGuideControl = d.BookRouteGuideControl _
                                                , .BookRouteGuideNumber = d.BookRouteGuideNumber _
                                                , .BookCustomerApprovalRecieved = d.BookCustomerApprovalRecieved _
                                                , .BookCustomerApprovalTransmitted = d.BookCustomerApprovalTransmitted _
                                                , .CompanyName = d.CompanyName _
                                                , .CompanyNumber = d.CompanyNumber _
                                                , .CarrierText = d.CarrierText _
                                                , .CommissionsName = d.CommissionsName _
                                                , .LaneName = d.LaneName _
                                                , .LaneOriginAddressUse = d.LaneOriginAddressUse _
                                                , .CompFinUseImportFrtCost = d.CompFinUseImportFrtCost}).First

                Return BookLoadDetail

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBookLoadDetailsFiltered(Optional ByVal BookProNumber As String = "", _
                                          Optional ByVal BookConsPrefix As String = "", _
                                          Optional ByVal BookCarrBLNumber As String = "", _
                                          Optional ByVal BookFinAPBillNumber As String = "", _
                                          Optional ByVal BookCarrOrderNumber As String = "", _
                                          Optional ByVal CompControl As Integer = 0, _
                                          Optional ByVal LaneControl As Integer = 0, _
                                          Optional ByVal CarrierControl As Integer = 0) As DTO.BookLoadDetail()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'db.Log = New DebugTextWriter
                'Get the newest record that matches the provided criteria
                Dim BookLoadDetails() As DTO.BookLoadDetail = ( _
                From d In db.vBookLoadMaintenances _
                Where _
                    (BookProNumber Is Nothing OrElse String.IsNullOrEmpty(BookProNumber) OrElse d.BookProNumber = BookProNumber) _
                    And _
                    (BookConsPrefix Is Nothing OrElse String.IsNullOrEmpty(BookConsPrefix) OrElse d.BookConsPrefix = BookConsPrefix) _
                    And _
                    (BookCarrBLNumber Is Nothing OrElse String.IsNullOrEmpty(BookCarrBLNumber) OrElse d.BookCarrBLNumber = BookCarrBLNumber) _
                    And _
                    (BookFinAPBillNumber Is Nothing OrElse String.IsNullOrEmpty(BookFinAPBillNumber) OrElse d.BookFinAPBillNumber = BookFinAPBillNumber) _
                    And _
                    (BookCarrOrderNumber Is Nothing OrElse String.IsNullOrEmpty(BookCarrOrderNumber) OrElse d.BookCarrOrderNumber = BookCarrOrderNumber) _
                    And _
                    (CompControl = 0 OrElse d.BookCustCompControl = CompControl) _
                    And _
                    (d.BookODControl = If(LaneControl = 0, d.BookODControl, LaneControl)) _
                    And _
                    (d.BookCarrierControl = If(CarrierControl = 0, d.BookCarrierControl, CarrierControl)) _
                Order By d.BookProNumber Descending _
                Select New DTO.BookLoadDetail With {.BookControl = d.BookControl _
                                            , .BookProNumber = d.BookProNumber _
                                            , .BookProBase = d.BookProBase _
                                            , .BookConsPrefix = d.BookConsPrefix _
                                            , .BookCustCompControl = d.BookCustCompControl _
                                            , .BookCommCompControl = d.BookCommCompControl _
                                            , .BookODControl = d.BookODControl _
                                            , .BookCarrierControl = d.BookCarrierControl _
                                            , .BookCarrierContact = d.BookCarrierContact _
                                            , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                            , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                            , .BookOrigName = d.BookOrigName _
                                            , .BookOrigAddress1 = d.BookOrigAddress1 _
                                            , .BookOrigAddress2 = d.BookOrigAddress2 _
                                            , .BookOrigAddress3 = d.BookOrigAddress3 _
                                            , .BookOrigCity = d.BookOrigCity _
                                            , .BookOrigState = d.BookOrigState _
                                            , .BookOrigCountry = d.BookOrigCountry _
                                            , .BookOrigZip = d.BookOrigZip _
                                            , .BookOrigPhone = d.BookOrigPhone _
                                            , .BookOrigFax = d.BookOrigFax _
                                            , .BookOriginStartHrs = d.BookOriginStartHrs _
                                            , .BookOriginStopHrs = d.BookOriginStopHrs _
                                            , .BookOriginApptReq = If(d.BookOriginApptReq.HasValue, d.BookOriginApptReq, False) _
                                            , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                            , .BookDestName = d.BookDestName _
                                            , .BookDestAddress1 = d.BookDestAddress1 _
                                            , .BookDestAddress2 = d.BookDestAddress2 _
                                            , .BookDestAddress3 = d.BookDestAddress3 _
                                            , .BookDestCity = d.BookDestCity _
                                            , .BookDestState = d.BookDestState _
                                            , .BookDestCountry = d.BookDestCountry _
                                            , .BookDestZip = d.BookDestZip _
                                            , .BookDestPhone = d.BookDestPhone _
                                            , .BookDestFax = d.BookDestFax _
                                            , .BookDestStartHrs = d.BookDestStartHrs _
                                            , .BookDestStopHrs = d.BookDestStopHrs _
                                            , .BookDestApptReq = If(d.BookDestApptReq.HasValue, d.BookDestApptReq, False) _
                                            , .BookDateOrdered = d.BookDateOrdered _
                                            , .BookDateLoad = d.BookDateLoad _
                                            , .BookDateInvoice = d.BookDateInvoice _
                                            , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                            , .BookDateRequired = d.BookDateRequired _
                                            , .BookDateDelivered = d.BookDateDelivered _
                                            , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                            , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                            , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                            , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                            , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                            , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                            , .BookTranCode = d.BookTranCode _
                                            , .BookPayCode = d.BookPayCode _
                                            , .BookTypeCode = d.BookTypeCode _
                                            , .BookBOLCode = d.BookBOLCode _
                                            , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                            , .BookModDate = d.BookModDate _
                                            , .BookModUser = d.BookModUser _
                                            , .BookCarrBLNumber = d.BookCarrBLNumber _
                                            , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                            , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                            , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                            , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                            , .BookRouteFinalDate = d.BookRouteFinalDate _
                                            , .BookRouteFinalCode = d.BookRouteFinalCode _
                                            , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                            , .BookWarehouseNumber = d.BookWarehouseNumber _
                                            , .BookComCode = d.BookComCode _
                                            , .BookTransType = d.BookTransType _
                                            , .BookCarrActDate = d.BookCarrActDate _
                                            , .BookCarrActTime = d.BookCarrActTime _
                                            , .BookRouteConsFlag = d.BookRouteConsFlag _
                                            , .BookHotLoad = If(d.BookHotLoad.HasValue, d.BookHotLoad, False) _
                                            , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                            , .BookCarrierContControl = If(d.BookCarrierContControl.HasValue, d.BookCarrierContControl, 0) _
                                            , .BookExportDocCreated = If(d.BookExportDocCreated.HasValue, d.BookExportDocCreated, False) _
                                            , .BookDoNotInvoice = d.BookDoNotInvoice _
                                            , .BookOrderSequence = d.BookOrderSequence _
                                            , .BookCarrierEquipmentCodes = d.BookCarrierEquipmentCodes _
                                            , .BookDateRequested = d.BookDateRequested _
                                            , .BookShipCarrierProNumber = d.BookShipCarrierProNumber _
                                            , .BookShipCarrierName = d.BookShipCarrierName _
                                            , .BookShipCarrierNumber = d.BookShipCarrierNumber _
                                            , .BookAPAdjReasonControl = d.BookAPAdjReasonControl _
                                            , .CompanyName = d.CompanyName _
                                            , .CompanyNumber = d.CompanyNumber _
                                            , .CarrierText = d.CarrierText _
                                            , .CommissionsName = d.CommissionsName _
                                            , .LaneName = d.LaneName _
                                            , .LaneOriginAddressUse = d.LaneOriginAddressUse _
                                            , .BookLockAllCosts = d.BookLockAllCosts _
                                            , .BookLockBFCCost = d.BookLockBFCCost _
                                            , .BookDestStopNumber = d.BookDestStopNumber _
                                            , .BookOrigStopNumber = d.BookOrigStopNumber _
                                            , .BookDestStopControl = d.BookDestStopControl _
                                            , .BookOrigStopControl = d.BookOrigStopControl _
                                            , .BookRouteTypeCode = d.BookRouteTypeCode _
                                            , .BookAlternateAddressLaneControl = d.BookAlternateAddressLaneControl _
                                            , .BookAlternateAddressLaneNumber = d.BookAlternateAddressLaneNumber _
                                            , .BookDefaultRouteSequence = d.BookDefaultRouteSequence _
                                            , .BookRouteGuideControl = d.BookRouteGuideControl _
                                            , .BookRouteGuideNumber = d.BookRouteGuideNumber _
                                            , .BookCustomerApprovalRecieved = d.BookCustomerApprovalRecieved _
                                            , .BookCustomerApprovalTransmitted = d.BookCustomerApprovalTransmitted _
                                            , .CompFinUseImportFrtCost = d.CompFinUseImportFrtCost}).Take(20).ToArray()

                Return BookLoadDetails

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBookLoadDetailsByPONumber(ByVal BookLoadPONumber As String) As DTO.BookLoadDetail()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                If BookLoadPONumber Is Nothing OrElse String.IsNullOrEmpty(BookLoadPONumber) Then Return Nothing
                Dim oBLs = From bl In db.BookLoads Where bl.BookLoadPONumber = BookLoadPONumber Select bl.BookLoadBookControl

                'Get the newest record that matches the provided criteria
                Dim BookLoadDetails() As DTO.BookLoadDetail = ( _
                From d In db.vBookLoadMaintenances _
                Where oBLs.Contains(d.BookControl) _
                Order By d.BookStopNo Ascending _
                Select New DTO.BookLoadDetail With {.BookControl = d.BookControl _
                                            , .BookProNumber = d.BookProNumber _
                                            , .BookProBase = d.BookProBase _
                                            , .BookConsPrefix = d.BookConsPrefix _
                                            , .BookCustCompControl = d.BookCustCompControl _
                                            , .BookCommCompControl = d.BookCommCompControl _
                                            , .BookODControl = d.BookODControl _
                                            , .BookCarrierControl = d.BookCarrierControl _
                                            , .BookCarrierContact = d.BookCarrierContact _
                                            , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                            , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                            , .BookOrigName = d.BookOrigName _
                                            , .BookOrigAddress1 = d.BookOrigAddress1 _
                                            , .BookOrigAddress2 = d.BookOrigAddress2 _
                                            , .BookOrigAddress3 = d.BookOrigAddress3 _
                                            , .BookOrigCity = d.BookOrigCity _
                                            , .BookOrigState = d.BookOrigState _
                                            , .BookOrigCountry = d.BookOrigCountry _
                                            , .BookOrigZip = d.BookOrigZip _
                                            , .BookOrigPhone = d.BookOrigPhone _
                                            , .BookOrigFax = d.BookOrigFax _
                                            , .BookOriginStartHrs = d.BookOriginStartHrs _
                                            , .BookOriginStopHrs = d.BookOriginStopHrs _
                                            , .BookOriginApptReq = If(d.BookOriginApptReq.HasValue, d.BookOriginApptReq, False) _
                                            , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                            , .BookDestName = d.BookDestName _
                                            , .BookDestAddress1 = d.BookDestAddress1 _
                                            , .BookDestAddress2 = d.BookDestAddress2 _
                                            , .BookDestAddress3 = d.BookDestAddress3 _
                                            , .BookDestCity = d.BookDestCity _
                                            , .BookDestState = d.BookDestState _
                                            , .BookDestCountry = d.BookDestCountry _
                                            , .BookDestZip = d.BookDestZip _
                                            , .BookDestPhone = d.BookDestPhone _
                                            , .BookDestFax = d.BookDestFax _
                                            , .BookDestStartHrs = d.BookDestStartHrs _
                                            , .BookDestStopHrs = d.BookDestStopHrs _
                                            , .BookDestApptReq = If(d.BookDestApptReq.HasValue, d.BookDestApptReq, False) _
                                            , .BookDateOrdered = d.BookDateOrdered _
                                            , .BookDateLoad = d.BookDateLoad _
                                            , .BookDateInvoice = d.BookDateInvoice _
                                            , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                            , .BookDateRequired = d.BookDateRequired _
                                            , .BookDateDelivered = d.BookDateDelivered _
                                            , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                            , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                            , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                            , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                            , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                            , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                            , .BookTranCode = d.BookTranCode _
                                            , .BookPayCode = d.BookPayCode _
                                            , .BookTypeCode = d.BookTypeCode _
                                            , .BookBOLCode = d.BookBOLCode _
                                            , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                            , .BookModDate = d.BookModDate _
                                            , .BookModUser = d.BookModUser _
                                            , .BookCarrBLNumber = d.BookCarrBLNumber _
                                            , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                            , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                            , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                            , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                            , .BookRouteFinalDate = d.BookRouteFinalDate _
                                            , .BookRouteFinalCode = d.BookRouteFinalCode _
                                            , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                            , .BookWarehouseNumber = d.BookWarehouseNumber _
                                            , .BookComCode = d.BookComCode _
                                            , .BookTransType = d.BookTransType _
                                            , .BookCarrActDate = d.BookCarrActDate _
                                            , .BookCarrActTime = d.BookCarrActTime _
                                            , .BookRouteConsFlag = d.BookRouteConsFlag _
                                            , .BookHotLoad = If(d.BookHotLoad.HasValue, d.BookHotLoad, False) _
                                            , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                            , .BookCarrierContControl = If(d.BookCarrierContControl.HasValue, d.BookCarrierContControl, 0) _
                                            , .BookExportDocCreated = If(d.BookExportDocCreated.HasValue, d.BookExportDocCreated, False) _
                                            , .BookDoNotInvoice = d.BookDoNotInvoice _
                                            , .BookOrderSequence = d.BookOrderSequence _
                                            , .BookCarrierEquipmentCodes = d.BookCarrierEquipmentCodes _
                                            , .BookDateRequested = d.BookDateRequested _
                                            , .BookShipCarrierProNumber = d.BookShipCarrierProNumber _
                                            , .BookShipCarrierName = d.BookShipCarrierName _
                                            , .BookShipCarrierNumber = d.BookShipCarrierNumber _
                                            , .BookAPAdjReasonControl = d.BookAPAdjReasonControl _
                                            , .CompanyName = d.CompanyName _
                                            , .CompanyNumber = d.CompanyNumber _
                                            , .CarrierText = d.CarrierText _
                                            , .CommissionsName = d.CommissionsName _
                                            , .LaneName = d.LaneName _
                                            , .LaneOriginAddressUse = d.LaneOriginAddressUse _
                                            , .BookLockAllCosts = d.BookLockAllCosts _
                                            , .BookLockBFCCost = d.BookLockBFCCost _
                                            , .BookDestStopNumber = d.BookDestStopNumber _
                                            , .BookOrigStopNumber = d.BookOrigStopNumber _
                                            , .BookDestStopControl = d.BookDestStopControl _
                                            , .BookOrigStopControl = d.BookOrigStopControl _
                                            , .BookRouteTypeCode = d.BookRouteTypeCode _
                                            , .BookAlternateAddressLaneControl = d.BookAlternateAddressLaneControl _
                                            , .BookAlternateAddressLaneNumber = d.BookAlternateAddressLaneNumber _
                                            , .BookDefaultRouteSequence = d.BookDefaultRouteSequence _
                                            , .BookRouteGuideControl = d.BookRouteGuideControl _
                                            , .BookRouteGuideNumber = d.BookRouteGuideNumber _
                                            , .BookCustomerApprovalRecieved = d.BookCustomerApprovalRecieved _
                                            , .BookCustomerApprovalTransmitted = d.BookCustomerApprovalTransmitted _
                                            , .CompFinUseImportFrtCost = d.CompFinUseImportFrtCost}).Take(20).ToArray()

                Return BookLoadDetails

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBookLoadDetailsFilteredContains(Optional ByVal BookProNumber As String = "", _
                                          Optional ByVal BookConsPrefix As String = "", _
                                          Optional ByVal BookCarrBLNumber As String = "", _
                                          Optional ByVal BookFinAPBillNumber As String = "", _
                                          Optional ByVal BookCarrOrderNumber As String = "") As DTO.BookLoadDetail()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                'convert any * to %
                If Not String.IsNullOrEmpty(BookProNumber) Then BookProNumber = BookProNumber.Replace("*", "%")
                If Not String.IsNullOrEmpty(BookConsPrefix) Then BookConsPrefix = BookConsPrefix.Replace("*", "%")
                If Not String.IsNullOrEmpty(BookCarrBLNumber) Then BookCarrBLNumber = BookCarrBLNumber.Replace("*", "%")
                If Not String.IsNullOrEmpty(BookFinAPBillNumber) Then BookFinAPBillNumber = BookFinAPBillNumber.Replace("*", "%")
                If Not String.IsNullOrEmpty(BookCarrOrderNumber) Then BookCarrOrderNumber = BookCarrOrderNumber.Replace("*", "%")
                'db.Log = New DebugTextWriter
                'Get the newest record that matches the provided criteria
                Dim BookLoadDetails() As DTO.BookLoadDetail = ( _
                From d In db.vBookLoadMaintenances _
                Where _
                    (BookProNumber Is Nothing OrElse String.IsNullOrEmpty(BookProNumber) OrElse System.Data.Linq.SqlClient.SqlMethods.Like(d.BookProNumber, BookProNumber)) _
                    And _
                    (BookConsPrefix Is Nothing OrElse String.IsNullOrEmpty(BookConsPrefix) OrElse System.Data.Linq.SqlClient.SqlMethods.Like(d.BookConsPrefix, BookConsPrefix)) _
                    And _
                    (BookCarrBLNumber Is Nothing OrElse String.IsNullOrEmpty(BookCarrBLNumber) OrElse System.Data.Linq.SqlClient.SqlMethods.Like(d.BookCarrBLNumber, BookCarrBLNumber)) _
                    And _
                    (BookFinAPBillNumber Is Nothing OrElse String.IsNullOrEmpty(BookFinAPBillNumber) OrElse System.Data.Linq.SqlClient.SqlMethods.Like(d.BookFinAPBillNumber, BookFinAPBillNumber)) _
                    And _
                    (BookCarrOrderNumber Is Nothing OrElse String.IsNullOrEmpty(BookCarrOrderNumber) OrElse System.Data.Linq.SqlClient.SqlMethods.Like(d.BookCarrOrderNumber, BookCarrOrderNumber)) _
                    And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.BookCustCompControl)) _
                Order By d.BookProNumber Descending _
                Select New DTO.BookLoadDetail With {.BookControl = d.BookControl _
                                            , .BookProNumber = d.BookProNumber _
                                            , .BookProBase = d.BookProBase _
                                            , .BookConsPrefix = d.BookConsPrefix _
                                            , .BookCustCompControl = d.BookCustCompControl _
                                            , .BookCommCompControl = d.BookCommCompControl _
                                            , .BookODControl = d.BookODControl _
                                            , .BookCarrierControl = d.BookCarrierControl _
                                            , .BookCarrierContact = d.BookCarrierContact _
                                            , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                            , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                            , .BookOrigName = d.BookOrigName _
                                            , .BookOrigAddress1 = d.BookOrigAddress1 _
                                            , .BookOrigAddress2 = d.BookOrigAddress2 _
                                            , .BookOrigAddress3 = d.BookOrigAddress3 _
                                            , .BookOrigCity = d.BookOrigCity _
                                            , .BookOrigState = d.BookOrigState _
                                            , .BookOrigCountry = d.BookOrigCountry _
                                            , .BookOrigZip = d.BookOrigZip _
                                            , .BookOrigPhone = d.BookOrigPhone _
                                            , .BookOrigFax = d.BookOrigFax _
                                            , .BookOriginStartHrs = d.BookOriginStartHrs _
                                            , .BookOriginStopHrs = d.BookOriginStopHrs _
                                            , .BookOriginApptReq = If(d.BookOriginApptReq.HasValue, d.BookOriginApptReq, False) _
                                            , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                            , .BookDestName = d.BookDestName _
                                            , .BookDestAddress1 = d.BookDestAddress1 _
                                            , .BookDestAddress2 = d.BookDestAddress2 _
                                            , .BookDestAddress3 = d.BookDestAddress3 _
                                            , .BookDestCity = d.BookDestCity _
                                            , .BookDestState = d.BookDestState _
                                            , .BookDestCountry = d.BookDestCountry _
                                            , .BookDestZip = d.BookDestZip _
                                            , .BookDestPhone = d.BookDestPhone _
                                            , .BookDestFax = d.BookDestFax _
                                            , .BookDestStartHrs = d.BookDestStartHrs _
                                            , .BookDestStopHrs = d.BookDestStopHrs _
                                            , .BookDestApptReq = If(d.BookDestApptReq.HasValue, d.BookDestApptReq, False) _
                                            , .BookDateOrdered = d.BookDateOrdered _
                                            , .BookDateLoad = d.BookDateLoad _
                                            , .BookDateInvoice = d.BookDateInvoice _
                                            , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                            , .BookDateRequired = d.BookDateRequired _
                                            , .BookDateDelivered = d.BookDateDelivered _
                                            , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                            , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                            , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                            , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                            , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                            , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                            , .BookTranCode = d.BookTranCode _
                                            , .BookPayCode = d.BookPayCode _
                                            , .BookTypeCode = d.BookTypeCode _
                                            , .BookBOLCode = d.BookBOLCode _
                                            , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                            , .BookModDate = d.BookModDate _
                                            , .BookModUser = d.BookModUser _
                                            , .BookCarrBLNumber = d.BookCarrBLNumber _
                                            , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                            , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                            , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                            , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                            , .BookRouteFinalDate = d.BookRouteFinalDate _
                                            , .BookRouteFinalCode = d.BookRouteFinalCode _
                                            , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                            , .BookWarehouseNumber = d.BookWarehouseNumber _
                                            , .BookComCode = d.BookComCode _
                                            , .BookTransType = d.BookTransType _
                                            , .BookCarrActDate = d.BookCarrActDate _
                                            , .BookCarrActTime = d.BookCarrActTime _
                                            , .BookRouteConsFlag = d.BookRouteConsFlag _
                                            , .BookHotLoad = If(d.BookHotLoad.HasValue, d.BookHotLoad, False) _
                                            , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                            , .BookCarrierContControl = If(d.BookCarrierContControl.HasValue, d.BookCarrierContControl, 0) _
                                            , .BookExportDocCreated = If(d.BookExportDocCreated.HasValue, d.BookExportDocCreated, False) _
                                            , .BookDoNotInvoice = d.BookDoNotInvoice _
                                            , .BookOrderSequence = d.BookOrderSequence _
                                            , .BookCarrierEquipmentCodes = d.BookCarrierEquipmentCodes _
                                            , .BookDateRequested = d.BookDateRequested _
                                            , .BookShipCarrierProNumber = d.BookShipCarrierProNumber _
                                            , .BookShipCarrierName = d.BookShipCarrierName _
                                            , .BookShipCarrierNumber = d.BookShipCarrierNumber _
                                            , .BookAPAdjReasonControl = d.BookAPAdjReasonControl _
                                            , .CompanyName = d.CompanyName _
                                            , .CompanyNumber = d.CompanyNumber _
                                            , .CarrierText = d.CarrierText _
                                            , .CommissionsName = d.CommissionsName _
                                            , .LaneName = d.LaneName _
                                            , .LaneOriginAddressUse = d.LaneOriginAddressUse _
                                            , .BookLockAllCosts = d.BookLockAllCosts _
                                            , .BookLockBFCCost = d.BookLockBFCCost _
                                            , .BookDestStopNumber = d.BookDestStopNumber _
                                            , .BookOrigStopNumber = d.BookOrigStopNumber _
                                            , .BookDestStopControl = d.BookDestStopControl _
                                            , .BookOrigStopControl = d.BookOrigStopControl _
                                            , .BookRouteTypeCode = d.BookRouteTypeCode _
                                            , .BookAlternateAddressLaneControl = d.BookAlternateAddressLaneControl _
                                            , .BookAlternateAddressLaneNumber = d.BookAlternateAddressLaneNumber _
                                            , .BookDefaultRouteSequence = d.BookDefaultRouteSequence _
                                            , .BookRouteGuideControl = d.BookRouteGuideControl _
                                            , .BookRouteGuideNumber = d.BookRouteGuideNumber _
                                            , .BookCustomerApprovalRecieved = d.BookCustomerApprovalRecieved _
                                            , .BookCustomerApprovalTransmitted = d.BookCustomerApprovalTransmitted _
                                            , .CompFinUseImportFrtCost = d.CompFinUseImportFrtCost}).Take(20).ToArray()

                Return BookLoadDetails

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBookLoadDetailsByPONumberContains(ByVal BookLoadPONumber As String) As DTO.BookLoadDetail()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                'convert any * to %
                If Not String.IsNullOrEmpty(BookLoadPONumber) Then BookLoadPONumber = BookLoadPONumber.Replace("*", "%")
                If BookLoadPONumber Is Nothing OrElse String.IsNullOrEmpty(BookLoadPONumber) Then Return Nothing
                Dim oBLs = From bl In db.BookLoads Where System.Data.Linq.SqlClient.SqlMethods.Like(bl.BookLoadPONumber, BookLoadPONumber) Select bl.BookLoadBookControl
                'Get the newest record that matches the provided criteria
                Dim BookLoadDetails() As DTO.BookLoadDetail = ( _
                From d In db.vBookLoadMaintenances _
                Where oBLs.Contains(d.BookControl) _
                And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.BookCustCompControl)) _
                Order By d.BookStopNo Ascending _
                Select New DTO.BookLoadDetail With {.BookControl = d.BookControl _
                                            , .BookProNumber = d.BookProNumber _
                                            , .BookProBase = d.BookProBase _
                                            , .BookConsPrefix = d.BookConsPrefix _
                                            , .BookCustCompControl = d.BookCustCompControl _
                                            , .BookCommCompControl = d.BookCommCompControl _
                                            , .BookODControl = d.BookODControl _
                                            , .BookCarrierControl = d.BookCarrierControl _
                                            , .BookCarrierContact = d.BookCarrierContact _
                                            , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                            , .BookOrigCompControl = If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0) _
                                            , .BookOrigName = d.BookOrigName _
                                            , .BookOrigAddress1 = d.BookOrigAddress1 _
                                            , .BookOrigAddress2 = d.BookOrigAddress2 _
                                            , .BookOrigAddress3 = d.BookOrigAddress3 _
                                            , .BookOrigCity = d.BookOrigCity _
                                            , .BookOrigState = d.BookOrigState _
                                            , .BookOrigCountry = d.BookOrigCountry _
                                            , .BookOrigZip = d.BookOrigZip _
                                            , .BookOrigPhone = d.BookOrigPhone _
                                            , .BookOrigFax = d.BookOrigFax _
                                            , .BookOriginStartHrs = d.BookOriginStartHrs _
                                            , .BookOriginStopHrs = d.BookOriginStopHrs _
                                            , .BookOriginApptReq = If(d.BookOriginApptReq.HasValue, d.BookOriginApptReq, False) _
                                            , .BookDestCompControl = If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0) _
                                            , .BookDestName = d.BookDestName _
                                            , .BookDestAddress1 = d.BookDestAddress1 _
                                            , .BookDestAddress2 = d.BookDestAddress2 _
                                            , .BookDestAddress3 = d.BookDestAddress3 _
                                            , .BookDestCity = d.BookDestCity _
                                            , .BookDestState = d.BookDestState _
                                            , .BookDestCountry = d.BookDestCountry _
                                            , .BookDestZip = d.BookDestZip _
                                            , .BookDestPhone = d.BookDestPhone _
                                            , .BookDestFax = d.BookDestFax _
                                            , .BookDestStartHrs = d.BookDestStartHrs _
                                            , .BookDestStopHrs = d.BookDestStopHrs _
                                            , .BookDestApptReq = If(d.BookDestApptReq.HasValue, d.BookDestApptReq, False) _
                                            , .BookDateOrdered = d.BookDateOrdered _
                                            , .BookDateLoad = d.BookDateLoad _
                                            , .BookDateInvoice = d.BookDateInvoice _
                                            , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                            , .BookDateRequired = d.BookDateRequired _
                                            , .BookDateDelivered = d.BookDateDelivered _
                                            , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                            , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                            , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                            , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                            , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                            , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                            , .BookTranCode = d.BookTranCode _
                                            , .BookPayCode = d.BookPayCode _
                                            , .BookTypeCode = d.BookTypeCode _
                                            , .BookBOLCode = d.BookBOLCode _
                                            , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                            , .BookModDate = d.BookModDate _
                                            , .BookModUser = d.BookModUser _
                                            , .BookCarrBLNumber = d.BookCarrBLNumber _
                                            , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                            , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                            , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                            , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                            , .BookRouteFinalDate = d.BookRouteFinalDate _
                                            , .BookRouteFinalCode = d.BookRouteFinalCode _
                                            , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                            , .BookWarehouseNumber = d.BookWarehouseNumber _
                                            , .BookComCode = d.BookComCode _
                                            , .BookTransType = d.BookTransType _
                                            , .BookCarrActDate = d.BookCarrActDate _
                                            , .BookCarrActTime = d.BookCarrActTime _
                                            , .BookRouteConsFlag = d.BookRouteConsFlag _
                                            , .BookHotLoad = If(d.BookHotLoad.HasValue, d.BookHotLoad, False) _
                                            , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                            , .BookCarrierContControl = If(d.BookCarrierContControl.HasValue, d.BookCarrierContControl, 0) _
                                            , .BookExportDocCreated = If(d.BookExportDocCreated.HasValue, d.BookExportDocCreated, False) _
                                            , .BookDoNotInvoice = d.BookDoNotInvoice _
                                            , .BookOrderSequence = d.BookOrderSequence _
                                            , .BookCarrierEquipmentCodes = d.BookCarrierEquipmentCodes _
                                            , .BookDateRequested = d.BookDateRequested _
                                            , .BookShipCarrierProNumber = d.BookShipCarrierProNumber _
                                            , .BookShipCarrierName = d.BookShipCarrierName _
                                            , .BookShipCarrierNumber = d.BookShipCarrierNumber _
                                            , .BookAPAdjReasonControl = d.BookAPAdjReasonControl _
                                            , .CompanyName = d.CompanyName _
                                            , .CompanyNumber = d.CompanyNumber _
                                            , .CarrierText = d.CarrierText _
                                            , .CommissionsName = d.CommissionsName _
                                            , .LaneName = d.LaneName _
                                            , .LaneOriginAddressUse = d.LaneOriginAddressUse _
                                            , .BookLockAllCosts = d.BookLockAllCosts _
                                            , .BookLockBFCCost = d.BookLockBFCCost _
                                            , .BookDestStopNumber = d.BookDestStopNumber _
                                            , .BookOrigStopNumber = d.BookOrigStopNumber _
                                            , .BookDestStopControl = d.BookDestStopControl _
                                            , .BookOrigStopControl = d.BookOrigStopControl _
                                            , .BookRouteTypeCode = d.BookRouteTypeCode _
                                            , .BookAlternateAddressLaneControl = d.BookAlternateAddressLaneControl _
                                            , .BookAlternateAddressLaneNumber = d.BookAlternateAddressLaneNumber _
                                            , .BookDefaultRouteSequence = d.BookDefaultRouteSequence _
                                            , .BookRouteGuideControl = d.BookRouteGuideControl _
                                            , .BookRouteGuideNumber = d.BookRouteGuideNumber _
                                            , .BookCustomerApprovalRecieved = d.BookCustomerApprovalRecieved _
                                            , .BookCustomerApprovalTransmitted = d.BookCustomerApprovalTransmitted _
                                            , .CompFinUseImportFrtCost = d.CompFinUseImportFrtCost}).Take(20).ToArray()

                Return BookLoadDetails

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Overrides Function Update(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity)) As Object
        SaveChanges(oData)
        Dim source As DTO.BookLoadDetail = TryCast(oData, DTO.BookLoadDetail)
        If source Is Nothing Then Return Nothing
        Dim oBook As New NGLBookData(Me.Parameters)
        oBook.UpdateCNSLockFlags(source.BookControl)
        ' Return the updated order
        Return GetBookLoadDetailFiltered(Control:=source.BookControl)

    End Function

    Public Overrides Sub UpdateNoReturn(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity))
        SaveChanges(oData)
        Dim source As DTO.BookLoadDetail = TryCast(oData, DTO.BookLoadDetail)
        If source Is Nothing Then Return
        Dim oBook As New NGLBookData(Me.Parameters)
        oBook.UpdateCNSLockFlags(source.BookControl)
    End Sub

    Public Overrides Sub Delete(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity))
        Using LinqDB
            'Note: the ValidateData Function must throw a FaultException error on failure
            ValidateDeletedRecord(LinqDB, oData)
            Try
                With CType(oData, DTO.BookLoadDetail)

                    'Open the existing Record
                    Dim nObject As LTS.vBookLoadMaintenance = (From e In CType(LinqDB, NGLMasBookDataContext).vBookLoadMaintenances Where e.BookControl = .BookControl Select e).First
                    If nObject Is Nothing Then
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_RecordDeleted"}, New FaultReason("E_InvalidOperationException"))
                    Else
                        CType(LinqDB, NGLMasBookDataContext).vBookLoadMaintenances.DeleteOnSubmit(nObject)
                        LinqDB.SubmitChanges()
                    End If

                End With
            Catch ex As SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch conflictEx As ChangeConflictException
                Try
                    Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(LinqDB))
                    conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                    Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                Catch ex As FaultException
                    Throw
                Catch ex As Exception
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
                End Try
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try
        End Using
    End Sub

#End Region

#Region "Protected Methods"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Dim d = TryCast(oData, DTO.BookLoadDetail)
        Dim strCompAbrev As String = getScalarString("Select top 1 isnull(dbo.Comp.CompAbrev,'') From dbo.Comp Where dbo.Comp.CompControl = " & d.BookCustCompControl)
        Dim strBookPro As String = strCompAbrev & d.BookProBase

        'Create New Record
        Return New LTS.vBookLoadMaintenance With {.BookControl = d.BookControl _
                                            , .BookProNumber = d.BookProNumber _
                                            , .BookProBase = d.BookProBase _
                                            , .BookConsPrefix = d.BookConsPrefix _
                                            , .BookCustCompControl = d.BookCustCompControl _
                                            , .BookCommCompControl = d.BookCommCompControl _
                                            , .BookODControl = d.BookODControl _
                                            , .BookCarrierControl = d.BookCarrierControl _
                                            , .BookCarrierContact = d.BookCarrierContact _
                                            , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                            , .BookOrigCompControl = d.BookOrigCompControl _
                                            , .BookOrigName = d.BookOrigName _
                                            , .BookOrigAddress1 = d.BookOrigAddress1 _
                                            , .BookOrigAddress2 = d.BookOrigAddress2 _
                                            , .BookOrigAddress3 = d.BookOrigAddress3 _
                                            , .BookOrigCity = d.BookOrigCity _
                                            , .BookOrigState = d.BookOrigState _
                                            , .BookOrigCountry = d.BookOrigCountry _
                                            , .BookOrigZip = d.BookOrigZip _
                                            , .BookOrigPhone = d.BookOrigPhone _
                                            , .BookOrigFax = d.BookOrigFax _
                                            , .BookOriginStartHrs = d.BookOriginStartHrs _
                                            , .BookOriginStopHrs = d.BookOriginStopHrs _
                                            , .BookOriginApptReq = d.BookOriginApptReq _
                                            , .BookDestCompControl = d.BookDestCompControl _
                                            , .BookDestName = d.BookDestName _
                                            , .BookDestAddress1 = d.BookDestAddress1 _
                                            , .BookDestAddress2 = d.BookDestAddress2 _
                                            , .BookDestAddress3 = d.BookDestAddress3 _
                                            , .BookDestCity = d.BookDestCity _
                                            , .BookDestState = d.BookDestState _
                                            , .BookDestCountry = d.BookDestCountry _
                                            , .BookDestZip = d.BookDestZip _
                                            , .BookDestPhone = d.BookDestPhone _
                                            , .BookDestFax = d.BookDestFax _
                                            , .BookDestStartHrs = d.BookDestStartHrs _
                                            , .BookDestStopHrs = d.BookDestStopHrs _
                                            , .BookDestApptReq = d.BookDestApptReq _
                                            , .BookDateOrdered = d.BookDateOrdered _
                                            , .BookDateLoad = d.BookDateLoad _
                                            , .BookDateInvoice = d.BookDateInvoice _
                                            , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                            , .BookDateRequired = d.BookDateRequired _
                                            , .BookDateDelivered = d.BookDateDelivered _
                                            , .BookTotalCases = d.BookTotalCases _
                                            , .BookTotalWgt = d.BookTotalWgt _
                                            , .BookTotalPL = d.BookTotalPL _
                                            , .BookTotalCube = d.BookTotalCube _
                                            , .BookTotalPX = d.BookTotalPX _
                                            , .BookTotalBFC = d.BookTotalBFC _
                                            , .BookTranCode = d.BookTranCode _
                                            , .BookPayCode = d.BookPayCode _
                                            , .BookTypeCode = d.BookTypeCode _
                                            , .BookBOLCode = d.BookBOLCode _
                                            , .BookStopNo = d.BookStopNo _
                                            , .BookModDate = Date.Now _
                                            , .BookModUser = Me.Parameters.UserName _
                                            , .BookCarrBLNumber = d.BookCarrBLNumber _
                                            , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                            , .BookFinAPBillNumber = d.BookFinAPBillNumber _
                                            , .BookRevBilledBFC = d.BookRevBilledBFC _
                                            , .BookRevTotalCost = d.BookRevTotalCost _
                                            , .BookRouteFinalDate = d.BookRouteFinalDate _
                                            , .BookRouteFinalCode = d.BookRouteFinalCode _
                                            , .BookRouteFinalFlag = d.BookRouteFinalFlag _
                                            , .BookWarehouseNumber = d.BookWarehouseNumber _
                                            , .BookComCode = d.BookComCode _
                                            , .BookTransType = d.BookTransType _
                                            , .BookCarrActDate = d.BookCarrActDate _
                                            , .BookCarrActTime = d.BookCarrActTime _
                                            , .BookRouteConsFlag = d.BookRouteConsFlag _
                                            , .BookHotLoad = d.BookHotLoad _
                                            , .BookMilesFrom = d.BookMilesFrom _
                                            , .BookCarrierContControl = d.BookCarrierContControl _
                                            , .BookExportDocCreated = d.BookExportDocCreated _
                                            , .BookDoNotInvoice = d.BookDoNotInvoice _
                                            , .BookOrderSequence = d.BookOrderSequence _
                                            , .BookCarrierEquipmentCodes = d.BookCarrierEquipmentCodes _
                                            , .BookDateRequested = d.BookDateRequested _
                                            , .BookShipCarrierProNumber = d.BookShipCarrierProNumber _
                                            , .BookShipCarrierName = d.BookShipCarrierName _
                                            , .BookShipCarrierNumber = d.BookShipCarrierNumber _
                                            , .BookAPAdjReasonControl = d.BookAPAdjReasonControl _
                                            , .BookLockAllCosts = d.BookLockAllCosts _
                                            , .BookLockBFCCost = d.BookLockBFCCost _
                                            , .BookDestStopNumber = d.BookDestStopNumber _
                                            , .BookOrigStopNumber = d.BookOrigStopNumber _
                                            , .BookDestStopControl = d.BookDestStopControl _
                                            , .BookOrigStopControl = d.BookOrigStopControl _
                                            , .BookRouteTypeCode = d.BookRouteTypeCode _
                                            , .BookAlternateAddressLaneControl = d.BookAlternateAddressLaneControl _
                                            , .BookAlternateAddressLaneNumber = d.BookAlternateAddressLaneNumber _
                                            , .BookDefaultRouteSequence = d.BookDefaultRouteSequence _
                                            , .BookRouteGuideControl = d.BookRouteGuideControl _
                                            , .BookRouteGuideNumber = d.BookRouteGuideNumber _
                                            , .BookCustomerApprovalRecieved = d.BookCustomerApprovalRecieved _
                                            , .BookCustomerApprovalTransmitted = d.BookCustomerApprovalTransmitted}
    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Dim source As LTS.vBookLoadMaintenance = TryCast(LinqTable, LTS.vBookLoadMaintenance)
        If source Is Nothing Then Return Nothing
        Dim oBook As New NGLBookData(Me.Parameters)
        oBook.UpdateCNSLockFlags(source.BookControl)
        Return GetBookLoadDetailFiltered(Control:=source.BookControl)
    End Function

    Protected Overrides Sub NoReturnCleanUp(ByVal LinqTable As Object)
        Dim source As LTS.vBookLoadMaintenance = TryCast(LinqTable, LTS.vBookLoadMaintenance)
        If Not source Is Nothing Then
            Dim oBook As New NGLBookData(Me.Parameters)
            oBook.UpdateCNSLockFlags(source.BookControl)
        End If
    End Sub

    Protected Overrides Sub ValidateNewRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'Check if the data already exists only one allowed      
        With CType(oData, DTO.BookLoadDetail)
            Try
                'Check if a company is selected
                If .BookCustCompControl = 0 Then
                    Utilities.SaveAppError("Cannot save new Book data.  A company has not been selected.  Please select a company and try again.", Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_InvalidKeyField"}, New FaultReason("E_DataValidationFailure"))
                End If
                If String.IsNullOrEmpty(.BookProNumber) OrElse .BookProNumber.Trim.Length < 1 Then
                    'We need to add the pro number
                    Dim PROBase As String = getScalarString("SELECT TOP 1 p.ParValue FROM dbo.parameter as p WHERE p.parkey = 'PRONUMBER'")
                    Dim intNextPro As Integer = 0
                    Integer.TryParse(PROBase, intNextPro)
                    intNextPro += 1
                    executeSQL("Update dbo.Parameter Set ParValue = " & intNextPro & " Where ParKey = 'PRONUMBER'")
                    Dim NewPRONumber = Trim(GetCustAbrev(.BookCustCompControl)) & intNextPro.ToString
                    .BookProBase = Left(intNextPro.ToString, 50)
                    .BookProNumber = NewPRONumber
                    .TrackingState = TrackingInfo.Updated
                Else
                    'verify that the bookpronumber is not in use
                    Dim BookLoadDetail As DTO.BookLoadDetail = ( _
                        From t In CType(oDB, NGLMasBookDataContext).vBookLoadMaintenances _
                         Where _
                             t.BookProNumber = .BookProNumber _
                         Select New DTO.BookLoadDetail With {.BookControl = t.BookControl}).First
                    If Not BookLoadDetail Is Nothing Then
                        Utilities.SaveAppError("Cannot save new Book data.  The Book Pro number, " & .BookProNumber & " ,  already exist.", Me.Parameters)
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_InvalidKeyField"}, New FaultReason("E_DataValidationFailure"))
                    End If
                End If
            Catch ex As FaultException
                Throw
            Catch ex As InvalidOperationException
                'do nothing this is the desired result.
            End Try
        End With
    End Sub

    Protected Overrides Sub ValidateUpdatedRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'Check if the data already exists only one allowed
        With CType(oData, DTO.BookLoadDetail)
            Try
                'Get the newest record that matches the provided criteria
                Dim BookLoadDetail As DTO.BookLoadDetail = ( _
                From t In CType(oDB, NGLMasBookDataContext).vBookLoadMaintenances _
                 Where _
                     (t.BookControl <> .BookControl) _
                     And _
                     (t.BookProNumber = .BookProNumber) _
                 Select New DTO.BookLoadDetail With {.BookControl = t.BookControl}).First

                If Not BookLoadDetail Is Nothing Then
                    Utilities.SaveAppError("Cannot save Book changes.  The Book PRO Number, " & .BookProNumber & " already exist.", Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_InvalidKeyField"}, New FaultReason("E_DataValidationFailure"))
                End If

            Catch ex As FaultException
                Throw
            Catch ex As InvalidOperationException
                'do nothing this is the desired result.
            End Try
        End With
    End Sub

    Protected Overrides Sub ValidateDeletedRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'Check if the BookLoadDetail is being used by the BookLoadDetail data or the lane data
        With CType(oData, DTO.BookLoadDetail)
            Try
                ''Add code here to call the Book and Lane data providers when they are created
                'Dim dpBook As New NGLBookData(Me.Parameters)
                'Dim dpLane As New NGLLaneData(Me.Parameters)
                'Dim oBooks() As DTO.Book
                'Dim oLanes() As DTO.Lane
                'Try
                '    oBooks = dpBook.GetBooksByBook(.BookControl)
                'Catch ex As FaultException
                '    If ex.Message <> "E_NoData" Then
                '        Throw
                '    End If
                'End Try
                'Try
                '    oLanes = dpLane.GetLanesByBook(.BookControl)
                'Catch ex As FaultException
                '    If ex.Message <> "E_NoData" Then
                '        Throw
                '    End If
                'End Try
                'If (Not oBooks Is Nothing AndAlso oBooks.Length > 0) OrElse (Not oLanes Is Nothing AndAlso oLanes.Length > 0) Then
                '    Utilities.SaveAppError("Cannot delete Book data.  The Book number, " & .BookNumber & " is being used and cannot be deleted. check the book or lane information.", Me.Parameters)
                '    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_DataInUse"}, New FaultReason("E_DataValidationFailure"))
                'End If
            Catch ex As FaultException
                Throw
            Catch ex As InvalidOperationException
                'do nothing this is the desired result.
            End Try
        End With
    End Sub

    Private Function getNewBookCodeValues(ByRef intCodeVal1 As Integer, ByRef intCodeVal2 As Integer) As Boolean
        Dim blnRet As Boolean = False
        Try
            intCodeVal1 = getScalarInteger("Select dbo.getLastBookCode1() as RetVal")
            intCodeVal2 = getScalarInteger("Select dbo.getLastBookCode2() as RetVal")
            intCodeVal2 = intCodeVal2 + 1
            If intCodeVal2 >= 255 Then
                intCodeVal2 = 33
                intCodeVal1 = intCodeVal1 + 1
                If intCodeVal1 = 160 Then intCodeVal1 = 161
                If intCodeVal1 = 173 Then intCodeVal1 = 174
            End If
            If intCodeVal1 > 255 Then
                Utilities.SaveAppError("E_MaxNbrOfBooks", Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_MaxNbrOfBooks"}, New FaultReason("E_CreateRecordFailure"))
            End If
            If intCodeVal2 < 40 Then intCodeVal2 = 40
            If intCodeVal2 = 45 Then intCodeVal2 = 46
            If intCodeVal2 > 96 And intCodeVal2 < 123 Then intCodeVal2 = 124
            If intCodeVal2 = 126 Then intCodeVal2 = 128
            If intCodeVal2 = 127 Then intCodeVal2 = 128
            If intCodeVal2 = 160 Then intCodeVal2 = 161
            If intCodeVal1 = 173 Then intCodeVal1 = 174
            blnRet = True
        Catch ex As FaultException
            Throw
        Catch ex As Exception
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
        End Try
        Return blnRet
    End Function

    Private Function GetCustAbrev(ByVal Control As Integer, _
                                 Optional ByVal UseCompNumber As Boolean = False) As String

        Dim strSQL As String = "Select dbo.comp.compabrev as RetVal " _
            & " From dbo.comp "
        If UseCompNumber Then
            strSQL &= " Where dbo.comp.compnumber = " & Control
        Else
            strSQL &= " Where dbo.comp.compcontrol = " & Control
        End If
        Return getScalarString(strSQL)

    End Function

    Private Sub SaveChanges(ByVal oData As DTO.BookLoadDetail)
        Using LinqDB
            'Note: the ValidateData Function must throw a FaultException error on failure
            ValidateUpdatedRecord(LinqDB, oData)
            With oData
                Try
                    Dim strCompAbrev As String = getScalarString("Select top 1 isnull(dbo.Comp.CompAbrev,'') From dbo.Comp Where dbo.Comp.CompControl = " & .BookCustCompControl)
                    Dim strBookPro As String = strCompAbrev & .BookProBase
                    'Open the existing Record
                    Dim d = (From e In CType(LinqDB, NGLMasBookDataContext).vBookLoadMaintenances Where e.BookControl = .BookControl Select e).First
                    If d Is Nothing Then
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_RecordDeleted"}, New FaultReason("E_InvalidOperationException"))
                    Else
                        'Check for conflicts
                        If .BookModDate <> d.BookModDate Then
                            'the data may have changed so check each field for conflicts
                            Dim ConflictData As New List(Of KeyValuePair(Of String, String))
                            Dim blnConflictFound As Boolean = False
                            addToConflicts("BookProNumber", .BookProNumber, d.BookProNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookProBase", .BookProBase, d.BookProBase, ConflictData, blnConflictFound)
                            addToConflicts("BookConsPrefix", .BookConsPrefix, d.BookConsPrefix, ConflictData, blnConflictFound)
                            addToConflicts("BookCustCompControl", .BookCustCompControl, d.BookCustCompControl, ConflictData, blnConflictFound)
                            addToConflicts("BookCommCompControl", .BookCommCompControl, d.BookCommCompControl, ConflictData, blnConflictFound)
                            addToConflicts("BookODControl", .BookODControl, d.BookODControl, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrierControl", .BookCarrierControl, d.BookCarrierControl, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrierContact", .BookCarrierContact, d.BookCarrierContact, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrierContactPhone", .BookCarrierContactPhone, d.BookCarrierContactPhone, ConflictData, blnConflictFound)
                            addToConflicts("BookOrigCompControl", .BookOrigCompControl, If(d.BookOrigCompControl.HasValue, d.BookOrigCompControl, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookOrigName", .BookOrigName, d.BookOrigName, ConflictData, blnConflictFound)
                            addToConflicts("BookOrigAddress1", .BookOrigAddress1, d.BookOrigAddress1, ConflictData, blnConflictFound)
                            addToConflicts("BookOrigAddress2", .BookOrigAddress2, d.BookOrigAddress2, ConflictData, blnConflictFound)
                            addToConflicts("BookOrigAddress3", .BookOrigAddress3, d.BookOrigAddress3, ConflictData, blnConflictFound)
                            addToConflicts("BookOrigCity", .BookOrigCity, d.BookOrigCity, ConflictData, blnConflictFound)
                            addToConflicts("BookOrigState", .BookOrigState, d.BookOrigState, ConflictData, blnConflictFound)
                            addToConflicts("BookOrigCountry", .BookOrigCountry, d.BookOrigCountry, ConflictData, blnConflictFound)
                            addToConflicts("BookOrigZip", .BookOrigZip, d.BookOrigZip, ConflictData, blnConflictFound)
                            addToConflicts("BookOrigPhone", .BookOrigPhone, d.BookOrigPhone, ConflictData, blnConflictFound)
                            addToConflicts("BookOrigFax", .BookOrigFax, d.BookOrigFax, ConflictData, blnConflictFound)
                            addToConflicts("BookOriginStartHrs", .BookOriginStartHrs, d.BookOriginStartHrs, ConflictData, blnConflictFound)
                            addToConflicts("BookOriginStopHrs", .BookOriginStopHrs, d.BookOriginStopHrs, ConflictData, blnConflictFound)
                            addToConflicts("BookOriginApptReq", .BookOriginApptReq, If(d.BookOriginApptReq.HasValue, d.BookOriginApptReq, False), ConflictData, blnConflictFound)
                            addToConflicts("BookDestCompControl", .BookDestCompControl, If(d.BookDestCompControl.HasValue, d.BookDestCompControl, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookDestAddress1", .BookDestAddress1, d.BookDestAddress1, ConflictData, blnConflictFound)
                            addToConflicts("BookDestAddress2", .BookDestAddress2, d.BookDestAddress2, ConflictData, blnConflictFound)
                            addToConflicts("BookDestAddress3", .BookDestAddress3, d.BookDestAddress3, ConflictData, blnConflictFound)
                            addToConflicts("BookDestCity", .BookDestCity, d.BookDestCity, ConflictData, blnConflictFound)
                            addToConflicts("BookDestState", .BookDestState, d.BookDestState, ConflictData, blnConflictFound)
                            addToConflicts("BookDestCountry", .BookDestCountry, d.BookDestCountry, ConflictData, blnConflictFound)
                            addToConflicts("BookDestZip", .BookDestZip, d.BookDestZip, ConflictData, blnConflictFound)
                            addToConflicts("BookDestPhone", .BookDestPhone, d.BookDestPhone, ConflictData, blnConflictFound)
                            addToConflicts("BookDestFax", .BookDestFax, d.BookDestFax, ConflictData, blnConflictFound)
                            addToConflicts("BookDestStartHrs", .BookDestStartHrs, d.BookDestStartHrs, ConflictData, blnConflictFound)
                            addToConflicts("BookDestStopHrs", .BookDestStopHrs, d.BookDestStopHrs, ConflictData, blnConflictFound)
                            addToConflicts("BookDestApptReq", .BookDestApptReq, If(d.BookDestApptReq.HasValue, d.BookDestApptReq, False), ConflictData, blnConflictFound)
                            addToConflicts("BookDateOrdered", .BookDateOrdered, d.BookDateOrdered, ConflictData, blnConflictFound)
                            addToConflicts("BookDateLoad", .BookDateLoad, d.BookDateLoad, ConflictData, blnConflictFound)
                            addToConflicts("BookDateInvoice", .BookDateInvoice, d.BookDateInvoice, ConflictData, blnConflictFound)
                            addToConflicts("BookFinARInvoiceDate", .BookFinARInvoiceDate, d.BookFinARInvoiceDate, ConflictData, blnConflictFound)
                            addToConflicts("BookDateRequired", .BookDateRequired, d.BookDateRequired, ConflictData, blnConflictFound)
                            addToConflicts("BookDateDelivered", .BookDateDelivered, d.BookDateDelivered, ConflictData, blnConflictFound)
                            addToConflicts("BookTotalCases", .BookTotalCases, If(d.BookTotalCases.HasValue, d.BookTotalCases, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookTotalWgt", .BookTotalWgt, If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookTotalPL", .BookTotalPL, If(d.BookTotalPL.HasValue, d.BookTotalPL, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookTotalCube", .BookTotalCube, If(d.BookTotalCube.HasValue, d.BookTotalCube, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookTotalPX", .BookTotalPX, If(d.BookTotalPX.HasValue, d.BookTotalPX, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookTotalBFC", .BookTotalBFC, If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookTranCode", .BookTranCode, d.BookTranCode, ConflictData, blnConflictFound)
                            addToConflicts("BookPayCode", .BookPayCode, d.BookPayCode, ConflictData, blnConflictFound)
                            addToConflicts("BookTypeCode", .BookTypeCode, d.BookTypeCode, ConflictData, blnConflictFound)
                            addToConflicts("BookBOLCode", .BookBOLCode, d.BookBOLCode, ConflictData, blnConflictFound)
                            addToConflicts("BookStopNo", .BookStopNo, If(d.BookStopNo.HasValue, d.BookStopNo, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookCarrBLNumber", .BookCarrBLNumber, d.BookCarrBLNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrOrderNumber", .BookCarrOrderNumber, d.BookCarrOrderNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookFinAPBillNumber", .BookFinAPBillNumber, d.BookFinAPBillNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookRevBilledBFC", .BookRevBilledBFC, If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookRevTotalCost", .BookRevTotalCost, If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookRouteFinalDate", .BookRouteFinalDate, d.BookRouteFinalDate, ConflictData, blnConflictFound)
                            addToConflicts("BookRouteFinalCode", .BookRouteFinalCode, d.BookRouteFinalCode, ConflictData, blnConflictFound)
                            addToConflicts("BookRouteFinalFlag", .BookRouteFinalFlag, d.BookRouteFinalFlag, ConflictData, blnConflictFound)
                            addToConflicts("BookWarehouseNumber", .BookWarehouseNumber, d.BookWarehouseNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookComCode", .BookComCode, d.BookComCode, ConflictData, blnConflictFound)
                            addToConflicts("BookTransType", .BookTransType, d.BookTransType, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrActDate", .BookCarrActDate, d.BookCarrActDate, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrActTime", .BookCarrActTime, d.BookCarrActTime, ConflictData, blnConflictFound)
                            addToConflicts("BookRouteConsFlag", .BookRouteConsFlag, d.BookRouteConsFlag, ConflictData, blnConflictFound)
                            addToConflicts("BookHotLoad", .BookHotLoad, If(d.BookHotLoad.HasValue, d.BookHotLoad, False), ConflictData, blnConflictFound)
                            addToConflicts("BookMilesFrom", .BookMilesFrom, If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookCarrierContControl", .BookCarrierContControl, If(d.BookCarrierContControl.HasValue, d.BookCarrierContControl, 0), ConflictData, blnConflictFound)
                            addToConflicts("BookExportDocCreated", .BookExportDocCreated, If(d.BookExportDocCreated.HasValue, d.BookExportDocCreated, False), ConflictData, blnConflictFound)
                            addToConflicts("BookDoNotInvoice", .BookDoNotInvoice, d.BookDoNotInvoice, ConflictData, blnConflictFound)
                            addToConflicts("BookOrderSequence", .BookOrderSequence, d.BookOrderSequence, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrierEquipmentCodes", .BookCarrierEquipmentCodes, d.BookCarrierEquipmentCodes, ConflictData, blnConflictFound)
                            addToConflicts("BookDateRequested", .BookDateRequested, d.BookDateRequested, ConflictData, blnConflictFound)
                            addToConflicts("BookShipCarrierProNumber", .BookShipCarrierProNumber, d.BookShipCarrierProNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookShipCarrierName", .BookShipCarrierName, d.BookShipCarrierName, ConflictData, blnConflictFound)
                            addToConflicts("BookShipCarrierNumber", .BookShipCarrierNumber, d.BookShipCarrierNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookAPAdjReasonControl", .BookAPAdjReasonControl, d.BookAPAdjReasonControl, ConflictData, blnConflictFound)
                            addToConflicts("BookLockAllCosts", .BookLockAllCosts, d.BookLockAllCosts, ConflictData, blnConflictFound)
                            addToConflicts("BookLockBFCCost", .BookLockBFCCost, d.BookLockBFCCost, ConflictData, blnConflictFound)
                            addToConflicts("BookDestStopNumber", .BookDestStopNumber, d.BookDestStopNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookOrigStopNumber", .BookOrigStopNumber, d.BookOrigStopNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookDestStopControl", .BookDestStopControl, d.BookDestStopControl, ConflictData, blnConflictFound)
                            addToConflicts("BookOrigStopControl", .BookOrigStopControl, d.BookOrigStopControl, ConflictData, blnConflictFound)
                            addToConflicts("BookRouteTypeCode", .BookRouteTypeCode, d.BookRouteTypeCode, ConflictData, blnConflictFound)
                            addToConflicts("BookAlternateAddressLaneControl", .BookAlternateAddressLaneControl, d.BookAlternateAddressLaneControl, ConflictData, blnConflictFound)
                            addToConflicts("BookDefaultRouteSequence", .BookDefaultRouteSequence, d.BookDefaultRouteSequence, ConflictData, blnConflictFound)
                            addToConflicts("BookRouteGuideControl", .BookRouteGuideControl, d.BookRouteGuideControl, ConflictData, blnConflictFound)
                            addToConflicts("BookCustomerApprovalRecieved", .BookCustomerApprovalRecieved, d.BookCustomerApprovalRecieved, ConflictData, blnConflictFound)
                            addToConflicts("BookCustomerApprovalTransmitted", .BookCustomerApprovalTransmitted, d.BookCustomerApprovalTransmitted, ConflictData, blnConflictFound)

                            If blnConflictFound Then
                                'We only add the mod date and mod user if one or more other fields have been modified
                                addToConflicts("BookModDate", .BookModDate, d.BookModDate, ConflictData, blnConflictFound)
                                addToConflicts("BookModUser", .BookModUser, d.BookModUser, ConflictData, blnConflictFound)
                                Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(ConflictData))
                                conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                                Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                            End If
                        End If
                        'Update the table data
                        d.BookProNumber = strBookPro
                        d.BookProBase = .BookProBase
                        d.BookConsPrefix = .BookConsPrefix
                        d.BookCustCompControl = .BookCustCompControl
                        d.BookCommCompControl = .BookCommCompControl
                        d.BookODControl = .BookODControl
                        d.BookCarrierControl = .BookCarrierControl
                        d.BookCarrierContact = .BookCarrierContact
                        d.BookCarrierContactPhone = .BookCarrierContactPhone
                        d.BookOrigCompControl = .BookOrigCompControl
                        d.BookOrigName = .BookOrigName
                        d.BookOrigAddress1 = .BookOrigAddress1
                        d.BookOrigAddress2 = .BookOrigAddress2
                        d.BookOrigAddress3 = .BookOrigAddress3
                        d.BookOrigCity = .BookOrigCity
                        d.BookOrigState = .BookOrigState
                        d.BookOrigCountry = .BookOrigCountry
                        d.BookOrigZip = .BookOrigZip
                        d.BookOrigPhone = .BookOrigPhone
                        d.BookOrigFax = .BookOrigFax
                        d.BookOriginStartHrs = .BookOriginStartHrs
                        d.BookOriginStopHrs = .BookOriginStopHrs
                        d.BookOriginApptReq = .BookOriginApptReq
                        d.BookDestCompControl = .BookDestCompControl
                        d.BookDestName = .BookDestName
                        d.BookDestAddress1 = .BookDestAddress1
                        d.BookDestAddress2 = .BookDestAddress2
                        d.BookDestAddress3 = .BookDestAddress3
                        d.BookDestCity = .BookDestCity
                        d.BookDestState = .BookDestState
                        d.BookDestCountry = .BookDestCountry
                        d.BookDestZip = .BookDestZip
                        d.BookDestPhone = .BookDestPhone
                        d.BookDestFax = .BookDestFax
                        d.BookDestStartHrs = .BookDestStartHrs
                        d.BookDestStopHrs = .BookDestStopHrs
                        d.BookDestApptReq = .BookDestApptReq
                        d.BookDateOrdered = .BookDateOrdered
                        d.BookDateLoad = .BookDateLoad
                        d.BookDateInvoice = .BookDateInvoice
                        d.BookFinARInvoiceDate = .BookFinARInvoiceDate
                        d.BookDateRequired = .BookDateRequired
                        d.BookDateDelivered = .BookDateDelivered
                        d.BookTotalCases = .BookTotalCases
                        d.BookTotalWgt = .BookTotalWgt
                        d.BookTotalPL = .BookTotalPL
                        d.BookTotalCube = .BookTotalCube
                        d.BookTotalPX = .BookTotalPX
                        d.BookTotalBFC = .BookTotalBFC
                        d.BookTranCode = .BookTranCode
                        d.BookPayCode = .BookPayCode
                        d.BookTypeCode = .BookTypeCode
                        d.BookBOLCode = .BookBOLCode
                        d.BookOrigStopNumber = If(.BookOrigStopNumber < 1, 1, .BookOrigStopNumber)
                        d.BookDestStopNumber = calculateBookDestStopNumber(d.BookStopNo, .BookStopNo, d.BookDestStopNumber)
                        d.BookStopNo = If(.BookStopNo < 1, 1, .BookStopNo)
                        d.BookModDate = Date.Now
                        d.BookModUser = Me.Parameters.UserName
                        d.BookCarrBLNumber = .BookCarrBLNumber
                        d.BookCarrOrderNumber = .BookCarrOrderNumber
                        d.BookFinAPBillNumber = .BookFinAPBillNumber
                        d.BookRevBilledBFC = .BookRevBilledBFC
                        d.BookRevTotalCost = .BookRevTotalCost
                        d.BookRouteFinalDate = .BookRouteFinalDate
                        d.BookRouteFinalCode = .BookRouteFinalCode
                        d.BookRouteFinalFlag = .BookRouteFinalFlag
                        d.BookWarehouseNumber = .BookWarehouseNumber
                        d.BookComCode = .BookComCode
                        d.BookTransType = .BookTransType
                        d.BookCarrActDate = .BookCarrActDate
                        d.BookCarrActTime = .BookCarrActTime
                        d.BookRouteConsFlag = .BookRouteConsFlag
                        d.BookHotLoad = .BookHotLoad
                        d.BookMilesFrom = .BookMilesFrom
                        d.BookCarrierContControl = .BookCarrierContControl
                        d.BookExportDocCreated = .BookExportDocCreated
                        d.BookDoNotInvoice = .BookDoNotInvoice
                        d.BookOrderSequence = .BookOrderSequence
                        d.BookCarrierEquipmentCodes = .BookCarrierEquipmentCodes
                        d.BookDateRequested = .BookDateRequested
                        d.BookShipCarrierProNumber = .BookShipCarrierProNumber
                        d.BookShipCarrierName = .BookShipCarrierName
                        d.BookShipCarrierNumber = .BookShipCarrierNumber
                        d.BookAPAdjReasonControl = .BookAPAdjReasonControl
                        d.BookLockAllCosts = .BookLockAllCosts
                        d.BookLockBFCCost = .BookLockBFCCost
                        d.BookDestStopControl = .BookDestStopControl
                        d.BookOrigStopControl = .BookOrigStopControl
                        d.BookRouteTypeCode = .BookRouteTypeCode
                        d.BookAlternateAddressLaneControl = .BookAlternateAddressLaneControl
                        d.BookAlternateAddressLaneNumber = .BookAlternateAddressLaneNumber
                        d.BookDefaultRouteSequence = .BookDefaultRouteSequence
                        d.BookRouteGuideControl = .BookRouteGuideControl
                        d.BookRouteGuideNumber = .BookRouteGuideNumber
                        d.BookCustomerApprovalRecieved = .BookCustomerApprovalRecieved
                        d.BookCustomerApprovalTransmitted = .BookCustomerApprovalTransmitted
                    End If
                    LinqDB.SubmitChanges()
                Catch ex As FaultException
                    Throw
                Catch ex As SqlException
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
                Catch conflictEx As ChangeConflictException
                    Try
                        Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(LinqDB))
                        conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                        Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                    Catch ex As FaultException
                        Throw
                    Catch ex As Exception
                        Utilities.SaveAppError(ex.Message, Me.Parameters)
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
                    End Try
                Catch ex As InvalidOperationException
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_RecordDeleted"}, New FaultReason("E_InvalidOperationException"))
                Catch ex As Exception
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
                End Try

            End With
        End Using
    End Sub

#End Region

End Class

Public Class NGLBookFeeData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.BookFees
        Me.LinqDB = db
    End Sub

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GetBookFeeFiltered(Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return GetBookFeesFiltered()
    End Function

    Public Function GetBookFeeFiltered(ByVal Control As Integer) As DTO.BookFee
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'Get the newest record that matches the provided criteria
                Dim BookFee As DTO.BookFee = ( _
                From d In db.BookFees _
                Where _
                    d.BookFeesControl = Control _
                Select New DTO.BookFee With {.BookFeesControl = d.BookFeesControl _
                                                  , .BookFeesBookControl = If(d.BookFeesBookControl.HasValue, d.BookFeesBookControl.Value, 0) _
                                                  , .BookFeesMinimum = If(d.BookFeesMinimum.HasValue, d.BookFeesMinimum.Value, 0) _
                                                  , .BookFeesVariable = If(d.BookFeesVariable.HasValue, d.BookFeesVariable.Value, 0) _
                                                  , .BookFeesAccessorialCode = If(d.BookFeesAccessorialCode.HasValue, d.BookFeesAccessorialCode.Value, 0) _
                                                  , .BookFeesModDate = d.BookFeesModDate _
                                                  , .BookFeesModUser = d.BookFeesModUser _
                                                  , .BookFeesUpdated = d.BookFeesUpdated.ToArray()}).First


                Return BookFee

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetBookFeesFiltered(Optional ByVal BookControl As Integer = 0) As DTO.BookFee()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Return all the contacts that match the criteria sorted by name
                Dim BookFees() As DTO.BookFee = ( _
                From d In db.BookFees _
                Where _
                    (d.BookFeesBookControl = BookControl) _
                Order By d.BookFeesControl _
                Select New DTO.BookFee With {.BookFeesControl = d.BookFeesControl _
                                              , .BookFeesBookControl = If(d.BookFeesBookControl.HasValue, d.BookFeesBookControl.Value, 0) _
                                              , .BookFeesMinimum = If(d.BookFeesMinimum.HasValue, d.BookFeesMinimum.Value, 0) _
                                              , .BookFeesVariable = If(d.BookFeesVariable.HasValue, d.BookFeesVariable.Value, 0) _
                                              , .BookFeesAccessorialCode = If(d.BookFeesAccessorialCode.HasValue, d.BookFeesAccessorialCode.Value, 0) _
                                              , .BookFeesModDate = d.BookFeesModDate _
                                              , .BookFeesModUser = d.BookFeesModUser _
                                              , .BookFeesUpdated = d.BookFeesUpdated.ToArray()}).ToArray()
                Return BookFees

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

#End Region

#Region "Protected Functions"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Dim d = CType(oData, DTO.BookFee)
        'Create New Record
        Return New LTS.BookFee With {.BookFeesControl = d.BookFeesControl _
                                      , .BookFeesBookControl = d.BookFeesBookControl _
                                      , .BookFeesMinimum = d.BookFeesMinimum _
                                      , .BookFeesVariable = d.BookFeesVariable _
                                      , .BookFeesAccessorialCode = d.BookFeesAccessorialCode _
                                      , .BookFeesModDate = Date.Now _
                                      , .BookFeesModUser = Parameters.UserName _
                                      , .BookFeesUpdated = If(d.BookFeesUpdated Is Nothing, New Byte() {}, d.BookFeesUpdated)}
    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Return GetBookFeeFiltered(Control:=CType(LinqTable, LTS.BookFee).BookFeesControl)
    End Function

    Protected Overrides Function GetQuickSaveResults(ByVal LinqTable As Object) As DataTransferObjects.QuickSaveResults
        Dim ret As DTO.QuickSaveResults
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim source As LTS.BookFee = TryCast(LinqTable, LTS.BookFee)
                If source Is Nothing Then Return Nothing

                ret = (From d In db.BookFees _
                       Where d.BookFeesControl = source.BookFeesControl _
                       Select New DTO.QuickSaveResults With {.Control = d.BookFeesControl _
                                                            , .ModDate = d.BookFeesModDate _
                                                            , .ModUser = d.BookFeesModUser _
                                                            , .Updated = d.BookFeesUpdated.ToArray}).First

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

        End Using
        Return ret
    End Function

#End Region

End Class

Public Class NGLvBookMultiPickData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = Nothing
        Me.LinqDB = db
    End Sub

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return Nothing
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return Nothing
    End Function

    Public Function GetvBookMultiPickRecord(ByVal MultiPickConsPrefix As String, _
                                            ByVal MultiPickBookControl As Integer, _
                                            ByVal MultiPickLocationisOrigin As Boolean) As DTO.vBookMultiPick
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'Get the newest record that matches the provided criteria
                Dim ovBookMultiPick As DTO.vBookMultiPick = ( _
                From d In db.spGetBookConsMultiPickRecord(MultiPickConsPrefix, MultiPickBookControl, MultiPickLocationisOrigin, Me.Parameters.UserName) _
                Select New DTO.vBookMultiPick With {.MultiPickControl = d.MultiPickControl _
                                              , .MultiPickBookControl = d.MultiPickBookControl _
                                              , .MultiPickProNumber = d.MultiPickProNumber _
                                              , .MultiPickConsPrefix = d.MultiPickConsPrefix _
                                              , .MultiPickCustCompControl = d.MultiPickCustCompControl _
                                              , .MultiPickODControl = d.MultiPickODControl _
                                              , .MultiPickCarrierControl = d.MultiPickCarrierControl _
                                              , .MultiPickLocationControl = d.MultiPickLocationControl _
                                              , .MultiPickLocationisOrigin = d.MultiPickLocationisOrigin _
                                              , .MultiPickName = d.MultiPickName _
                                              , .MultiPickAddress1 = d.MultiPickAddress1 _
                                              , .MultiPickAddress2 = d.MultiPickAddress2 _
                                              , .MultiPickAddress3 = d.MultiPickAddress3 _
                                              , .MultiPickCity = d.MultiPickCity _
                                              , .MultiPickState = d.MultiPickState _
                                              , .MultiPickCountry = d.MultiPickCountry _
                                              , .MultiPickZip = d.MultiPickZip _
                                              , .MultiPickPhone = d.MultiPickPhone _
                                              , .MultiPickFax = d.MultiPickFax _
                                              , .MultiPickStopNumber = d.MultiPickStopNumber _
                                              , .MultiPickMiles = d.MultiPickMiles _
                                              , .MultiPickPickNumber = d.MultiPickPickNumber _
                                              , .MultiPickDateOrdered = d.MultiPickDateOrdered _
                                              , .MultiPickDateLoad = d.MultiPickDateLoad _
                                              , .MultiPickDateRequired = d.MultiPickDateRequired _
                                              , .MultiPickDateDelivered = d.MultiPickDateDelivered _
                                              , .MultiPickTotalCases = d.MultiPickTotalCases _
                                              , .MultiPickTotalWgt = d.MultiPickTotalWgt _
                                              , .MultiPickTotalPL = d.MultiPickTotalPL _
                                              , .MultiPickTotalCube = d.MultiPickTotalCube _
                                              , .MultiPickTotalPX = d.MultiPickTotalPX _
                                              , .MultiPickTranCode = d.MultiPickTranCode _
                                              , .MultiPickPayCode = d.MultiPickPayCode _
                                              , .MultiPickTypeCode = d.MultiPickTypeCode _
                                              , .MultiPickDeliveryStopNumber = d.MultiPickDeliveryStopNumber _
                                              , .MultiPickModDate = d.MultiPickModDate _
                                              , .MultiPickModUser = d.MultiPickModUser _
                                              , .MultiPickOrderNumber = d.MultiPickOrderNumber _
                                              , .MultiPickOrderSequence = d.MultiPickOrderSequence _
                                              , .MultiPickTotalOrderMiles = d.MultiPickTotalOrderMiles _
                                              , .MultiPickRouteFinalDate = d.MultiPickRouteFinalDate _
                                              , .MultiPickRouteFinalCode = d.MultiPickRouteFinalCode _
                                              , .MultiPickRouteFinalFlag = d.MultiPickRouteFinalFlag _
                                              , .MultiPickTransType = d.MultiPickTransType _
                                              , .MultiPickRouteConsFlag = d.MultiPickRouteConsFlag _
                                              , .MultiPickIsPickUpFlag = d.MultiPickIsPickUpFlag _
                                              , .MultiPickBilledBFC = d.MultiPickBilledBFC _
                                              , .MultiPickCarrierCost = d.MultiPickCarrierCost _
                                              , .MultiPickOtherCost = d.MultiPickOtherCost _
                                              , .MultiPickTotalCost = d.MultiPickTotalCost _
                                              , .MultiPickLoadSavings = d.MultiPickLoadSavings _
                                              , .MultiPickGrossRevenue = d.MultiPickGrossRevenue _
                                              , .MultiPickNonTaxable = d.MultiPickNonTaxable _
                                              , .MultiPickRouteBFC = d.MultiPickRouteBFC _
                                              , .MultiPickRouteCarrierCost = d.MultiPickRouteCarrierCost _
                                              , .MultiPickRouteOtherCost = d.MultiPickRouteOtherCost _
                                              , .MultiPickRouteTotalCost = d.MultiPickRouteTotalCost _
                                              , .MultiPickRouteLoadSavings = d.MultiPickRouteLoadSavings _
                                              , .MultiPickRouteGrossRevenue = d.MultiPickRouteGrossRevenue _
                                              , .MultiPickRouteNonTaxable = d.MultiPickRouteNonTaxable _
                                              , .MultiPickRouteMiles = d.MultiPickRouteMiles _
                                              , .MultiPickLockAllCosts = d.MultiPickLockAllCosts _
                                              , .MultiPickLockBFCCost = d.MultiPickLockBFCCost _
                                              , .MultiPickCompanyName = d.MultiPickCompanyName _
                                              , .MultiPickCompanyNumber = d.MultiPickCompanyNumber _
                                              , .MultiPickUseImportFrtCost = d.MultiPickUseImportFrtCost _
                                              , .MultiPickLaneNumber = d.MultiPickLaneNumber _
                                              , .MultiPickLaneName = d.MultiPickLaneName _
                                              , .MultiPickCarrierName = d.MultiPickCarrierName _
                                              , .MultiPickCarrierNumber = d.MultiPickCarrierNumber _
                                              , .MultiPickPickupStopNumber = d.MultiPickPickupStopNumber}).First


                Return ovBookMultiPick

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetvBookMultiPickRecords(ByVal MultiPickConsPrefix As String) As DTO.vBookMultiPick()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'Get the newest record that matches the provided criteria
                Dim ovBookMultiPick() As DTO.vBookMultiPick = ( _
                From d In db.spGetBookConsMultiPick(MultiPickConsPrefix, Me.Parameters.UserName) _
                Select New DTO.vBookMultiPick With {.MultiPickControl = d.MultiPickControl _
                                              , .MultiPickBookControl = d.MultiPickBookControl _
                                              , .MultiPickProNumber = d.MultiPickProNumber _
                                              , .MultiPickConsPrefix = d.MultiPickConsPrefix _
                                              , .MultiPickCustCompControl = d.MultiPickCustCompControl _
                                              , .MultiPickODControl = d.MultiPickODControl _
                                              , .MultiPickCarrierControl = d.MultiPickCarrierControl _
                                              , .MultiPickLocationControl = d.MultiPickLocationControl _
                                              , .MultiPickLocationisOrigin = d.MultiPickLocationisOrigin _
                                              , .MultiPickName = d.MultiPickName _
                                              , .MultiPickAddress1 = d.MultiPickAddress1 _
                                              , .MultiPickAddress2 = d.MultiPickAddress2 _
                                              , .MultiPickAddress3 = d.MultiPickAddress3 _
                                              , .MultiPickCity = d.MultiPickCity _
                                              , .MultiPickState = d.MultiPickState _
                                              , .MultiPickCountry = d.MultiPickCountry _
                                              , .MultiPickZip = d.MultiPickZip _
                                              , .MultiPickPhone = d.MultiPickPhone _
                                              , .MultiPickFax = d.MultiPickFax _
                                              , .MultiPickStopNumber = d.MultiPickStopNumber _
                                              , .MultiPickMiles = d.MultiPickMiles _
                                              , .MultiPickPickNumber = d.MultiPickPickNumber _
                                              , .MultiPickDateOrdered = d.MultiPickDateOrdered _
                                              , .MultiPickDateLoad = d.MultiPickDateLoad _
                                              , .MultiPickDateRequired = d.MultiPickDateRequired _
                                              , .MultiPickDateDelivered = d.MultiPickDateDelivered _
                                              , .MultiPickTotalCases = d.MultiPickTotalCases _
                                              , .MultiPickTotalWgt = d.MultiPickTotalWgt _
                                              , .MultiPickTotalPL = d.MultiPickTotalPL _
                                              , .MultiPickTotalCube = d.MultiPickTotalCube _
                                              , .MultiPickTotalPX = d.MultiPickTotalPX _
                                              , .MultiPickTranCode = d.MultiPickTranCode _
                                              , .MultiPickPayCode = d.MultiPickPayCode _
                                              , .MultiPickTypeCode = d.MultiPickTypeCode _
                                              , .MultiPickDeliveryStopNumber = d.MultiPickDeliveryStopNumber _
                                              , .MultiPickModDate = d.MultiPickModDate _
                                              , .MultiPickModUser = d.MultiPickModUser _
                                              , .MultiPickOrderNumber = d.MultiPickOrderNumber _
                                              , .MultiPickOrderSequence = d.MultiPickOrderSequence _
                                              , .MultiPickTotalOrderMiles = d.MultiPickTotalOrderMiles _
                                              , .MultiPickRouteFinalDate = d.MultiPickRouteFinalDate _
                                              , .MultiPickRouteFinalCode = d.MultiPickRouteFinalCode _
                                              , .MultiPickRouteFinalFlag = d.MultiPickRouteFinalFlag _
                                              , .MultiPickTransType = d.MultiPickTransType _
                                              , .MultiPickRouteConsFlag = d.MultiPickRouteConsFlag _
                                              , .MultiPickIsPickUpFlag = d.MultiPickIsPickUpFlag _
                                              , .MultiPickBilledBFC = d.MultiPickBilledBFC _
                                              , .MultiPickCarrierCost = d.MultiPickCarrierCost _
                                              , .MultiPickOtherCost = d.MultiPickOtherCost _
                                              , .MultiPickTotalCost = d.MultiPickTotalCost _
                                              , .MultiPickLoadSavings = d.MultiPickLoadSavings _
                                              , .MultiPickGrossRevenue = d.MultiPickGrossRevenue _
                                              , .MultiPickNonTaxable = d.MultiPickNonTaxable _
                                              , .MultiPickRouteBFC = d.MultiPickRouteBFC _
                                              , .MultiPickRouteCarrierCost = d.MultiPickRouteCarrierCost _
                                              , .MultiPickRouteOtherCost = d.MultiPickRouteOtherCost _
                                              , .MultiPickRouteTotalCost = d.MultiPickRouteTotalCost _
                                              , .MultiPickRouteLoadSavings = d.MultiPickRouteLoadSavings _
                                              , .MultiPickRouteGrossRevenue = d.MultiPickRouteGrossRevenue _
                                              , .MultiPickRouteNonTaxable = d.MultiPickRouteNonTaxable _
                                              , .MultiPickRouteMiles = d.MultiPickRouteMiles _
                                              , .MultiPickLockAllCosts = d.MultiPickLockAllCosts _
                                              , .MultiPickLockBFCCost = d.MultiPickLockBFCCost _
                                              , .MultiPickCompanyName = d.MultiPickCompanyName _
                                              , .MultiPickCompanyNumber = d.MultiPickCompanyNumber _
                                              , .MultiPickUseImportFrtCost = d.MultiPickUseImportFrtCost _
                                              , .MultiPickLaneNumber = d.MultiPickLaneNumber _
                                              , .MultiPickLaneName = d.MultiPickLaneName _
                                              , .MultiPickCarrierName = d.MultiPickCarrierName _
                                              , .MultiPickCarrierNumber = d.MultiPickCarrierNumber _
                                              , .MultiPickPickupStopNumber = d.MultiPickPickupStopNumber}).Take(100).ToArray


                Return ovBookMultiPick

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetvBookMultiPickRecordsByStopNumber(ByVal MultiPickConsPrefix As String) As DTO.vBookMultiPick()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'Get the newest record that matches the provided criteria
                Dim ovBookMultiPick() As DTO.vBookMultiPick = ( _
                From d In db.spGetBookConsMultiPickByStopNumber(MultiPickConsPrefix, Me.Parameters.UserName) _
                Select New DTO.vBookMultiPick With {.MultiPickControl = d.MultiPickControl _
                                              , .MultiPickBookControl = d.MultiPickBookControl _
                                              , .MultiPickProNumber = d.MultiPickProNumber _
                                              , .MultiPickConsPrefix = d.MultiPickConsPrefix _
                                              , .MultiPickCustCompControl = d.MultiPickCustCompControl _
                                              , .MultiPickODControl = d.MultiPickODControl _
                                              , .MultiPickCarrierControl = d.MultiPickCarrierControl _
                                              , .MultiPickLocationControl = d.MultiPickLocationControl _
                                              , .MultiPickLocationisOrigin = d.MultiPickLocationisOrigin _
                                              , .MultiPickName = d.MultiPickName _
                                              , .MultiPickAddress1 = d.MultiPickAddress1 _
                                              , .MultiPickAddress2 = d.MultiPickAddress2 _
                                              , .MultiPickAddress3 = d.MultiPickAddress3 _
                                              , .MultiPickCity = d.MultiPickCity _
                                              , .MultiPickState = d.MultiPickState _
                                              , .MultiPickCountry = d.MultiPickCountry _
                                              , .MultiPickZip = d.MultiPickZip _
                                              , .MultiPickPhone = d.MultiPickPhone _
                                              , .MultiPickFax = d.MultiPickFax _
                                              , .MultiPickStopNumber = d.MultiPickStopNumber _
                                              , .MultiPickMiles = d.MultiPickMiles _
                                              , .MultiPickPickNumber = d.MultiPickPickNumber _
                                              , .MultiPickDateOrdered = d.MultiPickDateOrdered _
                                              , .MultiPickDateLoad = d.MultiPickDateLoad _
                                              , .MultiPickDateRequired = d.MultiPickDateRequired _
                                              , .MultiPickDateDelivered = d.MultiPickDateDelivered _
                                              , .MultiPickTotalCases = d.MultiPickTotalCases _
                                              , .MultiPickTotalWgt = d.MultiPickTotalWgt _
                                              , .MultiPickTotalPL = d.MultiPickTotalPL _
                                              , .MultiPickTotalCube = d.MultiPickTotalCube _
                                              , .MultiPickTotalPX = d.MultiPickTotalPX _
                                              , .MultiPickTranCode = d.MultiPickTranCode _
                                              , .MultiPickPayCode = d.MultiPickPayCode _
                                              , .MultiPickTypeCode = d.MultiPickTypeCode _
                                              , .MultiPickDeliveryStopNumber = d.MultiPickDeliveryStopNumber _
                                              , .MultiPickModDate = d.MultiPickModDate _
                                              , .MultiPickModUser = d.MultiPickModUser _
                                              , .MultiPickOrderNumber = d.MultiPickOrderNumber _
                                              , .MultiPickOrderSequence = d.MultiPickOrderSequence _
                                              , .MultiPickTotalOrderMiles = d.MultiPickTotalOrderMiles _
                                              , .MultiPickRouteFinalDate = d.MultiPickRouteFinalDate _
                                              , .MultiPickRouteFinalCode = d.MultiPickRouteFinalCode _
                                              , .MultiPickRouteFinalFlag = d.MultiPickRouteFinalFlag _
                                              , .MultiPickTransType = d.MultiPickTransType _
                                              , .MultiPickRouteConsFlag = d.MultiPickRouteConsFlag _
                                              , .MultiPickIsPickUpFlag = d.MultiPickIsPickUpFlag _
                                              , .MultiPickBilledBFC = d.MultiPickBilledBFC _
                                              , .MultiPickCarrierCost = d.MultiPickCarrierCost _
                                              , .MultiPickOtherCost = d.MultiPickOtherCost _
                                              , .MultiPickTotalCost = d.MultiPickTotalCost _
                                              , .MultiPickLoadSavings = d.MultiPickLoadSavings _
                                              , .MultiPickGrossRevenue = d.MultiPickGrossRevenue _
                                              , .MultiPickNonTaxable = d.MultiPickNonTaxable _
                                              , .MultiPickRouteBFC = d.MultiPickRouteBFC _
                                              , .MultiPickRouteCarrierCost = d.MultiPickRouteCarrierCost _
                                              , .MultiPickRouteOtherCost = d.MultiPickRouteOtherCost _
                                              , .MultiPickRouteTotalCost = d.MultiPickRouteTotalCost _
                                              , .MultiPickRouteLoadSavings = d.MultiPickRouteLoadSavings _
                                              , .MultiPickRouteGrossRevenue = d.MultiPickRouteGrossRevenue _
                                              , .MultiPickRouteNonTaxable = d.MultiPickRouteNonTaxable _
                                              , .MultiPickRouteMiles = d.MultiPickRouteMiles _
                                              , .MultiPickLockAllCosts = d.MultiPickLockAllCosts _
                                              , .MultiPickLockBFCCost = d.MultiPickLockBFCCost _
                                              , .MultiPickCompanyName = d.MultiPickCompanyName _
                                              , .MultiPickCompanyNumber = d.MultiPickCompanyNumber _
                                              , .MultiPickUseImportFrtCost = d.MultiPickUseImportFrtCost _
                                              , .MultiPickLaneNumber = d.MultiPickLaneNumber _
                                              , .MultiPickLaneName = d.MultiPickLaneName _
                                              , .MultiPickCarrierName = d.MultiPickCarrierName _
                                              , .MultiPickCarrierNumber = d.MultiPickCarrierNumber _
                                              , .MultiPickPickupStopNumber = d.MultiPickPickupStopNumber}).Take(100).ToArray


                Return ovBookMultiPick

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Overrides Function Update(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity)) As Object
        Dim oVbookMultiPick As DTO.vBookMultiPick = TryCast(oData, DTO.vBookMultiPick)
        If Not oVbookMultiPick Is Nothing Then
            SaveChanges(oVbookMultiPick)
            Dim updatedMultiPick As DTO.vBookMultiPick = GetvBookMultiPickRecord(oVbookMultiPick.MultiPickConsPrefix, oVbookMultiPick.MultiPickBookControl, oVbookMultiPick.MultiPickLocationisOrigin)
            'we set the MultiPickControl number to the previous value because it is dynamic
            updatedMultiPick.MultiPickControl = oVbookMultiPick.MultiPickControl
            Return updatedMultiPick
        End If
        Return Nothing

    End Function

    Public Overrides Sub UpdateNoReturn(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity))

        Dim oVbookMultiPick As DTO.vBookMultiPick = TryCast(oData, DTO.vBookMultiPick)
        If Not oVbookMultiPick Is Nothing Then
            SaveChanges(oVbookMultiPick)
        End If

    End Sub

    Public Function UpdateSequence(ByVal oData As DTO.vBookMultiPick) As DTO.vBookMultiPick

        Dim oVbookMultiPick As DTO.vBookMultiPick = TryCast(oData, DTO.vBookMultiPick)
        If Not oVbookMultiPick Is Nothing Then
            SaveStopSequenceChanges(oVbookMultiPick)
            Dim updatedMultiPick As DTO.vBookMultiPick = GetvBookMultiPickRecord(oVbookMultiPick.MultiPickConsPrefix, oVbookMultiPick.MultiPickBookControl, oVbookMultiPick.MultiPickLocationisOrigin)
            'we set the MultiPickControl number to the previous value because it is dynamic
            updatedMultiPick.MultiPickControl = oVbookMultiPick.MultiPickControl
            Return updatedMultiPick
        End If
        Return Nothing
    End Function

    Public Overrides Sub Delete(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity))
        'We do not allow booking records to be added from this class
        Utilities.SaveAppError("Cannot delete data.  Records cannot be deleted using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))
    End Sub

#End Region

#Region "Protected Functions"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Return Nothing

    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Return Nothing
    End Function

    Protected Overrides Sub ValidateNewRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'We do not allow booking records to be added from this class
        Utilities.SaveAppError("Cannot add data.  Records cannot be inserted using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))
    End Sub

    Private Sub SaveChanges(ByVal oData As DTO.vBookMultiPick)
        Dim spConfig As New clsNGLSPConfig("UpdateBookConsMultiPick", "dbo.spUpdateBookConsMultiPick", True)
        Dim oSystem As New NGLSystemDataProvider(Me.Parameters)
        With spConfig.oCmd.Parameters
            .AddWithValue("@MultiPickBookControl", oData.MultiPickBookControl)
            .AddWithValue("@MultiPickProNumber", oData.MultiPickProNumber)
            .AddWithValue("@MultiPickConsPrefix", oData.MultiPickConsPrefix)
            .AddWithValue("@MultiPickLocationisOrigin", oData.MultiPickLocationisOrigin)
            .AddWithValue("@MultiPickName", oData.MultiPickName)
            .AddWithValue("@MultiPickAddress1", oData.MultiPickAddress1)
            .AddWithValue("@MultiPickAddress2", oData.MultiPickAddress2)
            .AddWithValue("@MultiPickAddress3", oData.MultiPickAddress3)
            .AddWithValue("@MultiPickCity", oData.MultiPickCity)
            .AddWithValue("@MultiPickState", oData.MultiPickState)
            .AddWithValue("@MultiPickCountry", oData.MultiPickCountry)
            .AddWithValue("@MultiPickZip", oData.MultiPickZip)
            .AddWithValue("@MultiPickPhone", oData.MultiPickPhone)
            .AddWithValue("@MultiPickFax", oData.MultiPickFax)
            .AddWithValue("@MultiPickStopNumber", oData.MultiPickStopNumber)
            .AddWithValue("@MultiPickMiles", oData.MultiPickMiles)
            .AddWithValue("@MultiPickPickNumber", oData.MultiPickPickNumber)
            .AddWithValue("@MultiPickDeliveryStopNumber", oData.MultiPickDeliveryStopNumber)
            .AddWithValue("@MultiPickOrderNumber", oData.MultiPickOrderNumber)
            .AddWithValue("@MultiPickOrderSequence", oData.MultiPickOrderSequence)
            .AddWithValue("@MultiPickTotalOrderMiles", oData.MultiPickTotalOrderMiles)
            .AddWithValue("@MultiPickRouteMiles", oData.MultiPickRouteMiles)
            .AddWithValue("@MultiPickLockAllCosts", oData.MultiPickLockAllCosts)
            .AddWithValue("@MultiPickLockBFCCost", oData.MultiPickLockBFCCost)
            .AddWithValue("@UserName", Left(Me.Parameters.UserName, 100))
        End With
        processNGLStoredProcedure(spConfig, oSystem)

    End Sub

    Private Sub SaveStopSequenceChanges(ByVal oData As DTO.vBookMultiPick)
        Dim spConfig As New clsNGLSPConfig("UpdateBookConsMultiPickStopSequence", "dbo.spUpdateBookConsMultiPickStopSequence", True)
        Dim oSystem As New NGLSystemDataProvider(Me.Parameters)
        With spConfig.oCmd.Parameters
            .AddWithValue("@MultiPickBookControl", oData.MultiPickBookControl)
            .AddWithValue("@MultiPickProNumber", oData.MultiPickProNumber)
            .AddWithValue("@MultiPickConsPrefix", oData.MultiPickConsPrefix)
            .AddWithValue("@MultiPickLocationisOrigin", oData.MultiPickLocationisOrigin)
            .AddWithValue("@MultiPickStopNumber", oData.MultiPickStopNumber)
            .AddWithValue("@MultiPickMiles", oData.MultiPickMiles)
            .AddWithValue("@UserName", Left(Me.Parameters.UserName, 100))
        End With
        processNGLStoredProcedure(spConfig, oSystem)
    End Sub

#End Region

End Class

Public Class NGLLoadStatusBoardData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.vLoadStatusBoards
        Me.LinqDB = db
    End Sub

#End Region

#Region "Properties"
    Private _RecalcTotals As Boolean = False
#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GetvLoadStatusBoardFiltered(Control:=Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return GetvLoadStatusBoardsByCNS()
    End Function

    Public Function GetvLoadStatusBoardFiltered(Optional ByVal Control As Integer = 0) As DTO.vLoadStatusBoard
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                'Get the newest record that matches the provided criteria                
                Dim vLoadStatusBoard As DTO.vLoadStatusBoard = ( _
                From d In db.vLoadStatusBoards _
                Where _
                    (d.BookControl = If(Control = 0, d.BookControl, Control)) _
                    And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.BookCustCompControl)) _
                Order By d.BookControl Descending _
                Select New DTO.vLoadStatusBoard With {.BookControl = d.BookControl _
                                            , .BookProNumber = d.BookProNumber _
                                            , .BookDateLoad = d.BookDateLoad _
                                            , .BookDateRequired = d.BookDateRequired _
                                            , .BookConsPrefix = d.BookConsPrefix _
                                            , .BookCustCompControl = d.BookCustCompControl _
                                            , .CompName = d.CompName _
                                            , .CompNumber = d.CompNumber _
                                            , .BookODControl = d.BookODControl _
                                            , .BookCarrierControl = d.BookCarrierControl _
                                            , .CarrierName = d.CarrierName _
                                            , .CarrierNumber = d.CarrierNumber _
                                            , .BookCarrierContControl = d.BookCarrierContControl _
                                            , .BookCarrierContact = d.BookCarrierContact _
                                            , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                            , .BookOrigName = d.BookOrigName _
                                            , .BookOrigAddress1 = d.BookOrigAddress1 _
                                            , .BookOrigCity = d.BookOrigCity _
                                            , .BookOrigState = d.BookOrigState _
                                            , .BookOrigZip = d.BookOrigZip _
                                            , .BookDestName = d.BookDestName _
                                            , .BookDestAddress1 = d.BookDestAddress1 _
                                            , .BookDestCity = d.BookDestCity _
                                            , .BookDestState = d.BookDestState _
                                            , .BookDestZip = d.BookDestZip _
                                            , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                            , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                            , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                            , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                            , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                            , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                            , .BookCarrActDate = d.BookCarrActDate _
                                            , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                            , .BookTranCode = d.BookTranCode _
                                            , .BookPayCode = d.BookPayCode _
                                            , .BookTypeCode = d.BookTypeCode _
                                            , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                            , .BookModDate = d.BookModDate _
                                            , .BookModUser = d.BookModUser _
                                            , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                            , .BookRevCarrierCost = If(d.BookRevCarrierCost.HasValue, d.BookRevCarrierCost, 0) _
                                            , .BookRevOtherCost = If(d.BookRevOtherCost.HasValue, d.BookRevOtherCost, 0) _
                                            , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                            , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                            , .BookRouteConsFlag = d.BookRouteConsFlag _
                                            , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                            , .BookOrderSequence = d.BookOrderSequence _
                                            , .BookLockAllCosts = d.BookLockAllCosts _
                                            , .BookLockBFCCost = d.BookLockBFCCost _
                                            , .BookPickupStopNumber = d.BookPickupStopNumber _
                                            , .BookOrigStopNumber = d.BookOrigStopNumber _
                                            , .BookDestStopNumber = d.BookDestStopNumber _
                                            , .BookOrigMiles = d.BookOrigMiles _
                                            , .BookDestMiles = d.BookDestMiles _
                                            , .BookPickNumber = d.BookPickNumber _
                                            , .BookTransType = d.BookTransType}).First

                Return vLoadStatusBoard

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetvLoadStatusBoardsFiltered(ByVal Filters As String) As DTO.vLoadStatusBoard()
        'Create a data connection 
        Dim oQuery As New Ngl.Core.Data.Query(ConnectionString)
        Dim oLoadStatusBoards As New List(Of DTO.vLoadStatusBoard)

        Try
            Dim strComp As String = ""
            strComp &= "( " _
                & "(isnull((SELECT top 1 isnull(dbo.UserAdmin.UserAdminCompControl,0) FROM dbo.UserAdmin Where dbo.UserAdmin.UserAdminUserName = '" & Me.Parameters.UserName & "'),0) > 0" _
                & "	AND " _
                & " CompNumber In (SELECT dbo.UserAdmin.UserAdminCompControl FROM dbo.UserAdmin	Where dbo.UserAdmin.UserAdminUserName = '" & Me.Parameters.UserName & "')" _
                & ")" _
                & " OR " _
                & " isnull((SELECT top 1 isnull(dbo.UserAdmin.UserAdminCompControl,0) FROM dbo.UserAdmin Where dbo.UserAdmin.UserAdminUserName = '" & Me.Parameters.UserName & "'),0) = 0" _
                & ") "

            If Not String.IsNullOrEmpty(Filters) AndAlso Filters.Trim.Length > 1 Then
                strComp &= " AND "
            End If
            Dim strSQL As String = "SELECT Top 500 * From vLoadStatusBoard  " _
                                     & " WHERE  " & strComp & Filters

            'Dim strSQL As String = "SELECT Top 500 BookControl, BookDateLoad, BookDateRequired, BookOrigZip, BookOrigCity, BookOrigState, BookConsPrefix, BookProNumber, " _
            '                        & " BookCustCompControl, CompName, BookOrigName, BookDestName, BookDestCity, BookDestState, BookDestZip, BookTotalCases, BookTotalWgt, " _
            '                         & " BookTotalPL, BookTotalCube, BookTotalPX, BookTotalBFC, BookCarrActDate, BookFinARInvoiceDate, BookODControl, BookCarrierControl, CarrierName, BookTranCode, " _
            '                         & " BookPayCode, BookModDate, BookModUser, BookStopNo, BookRevBilledBFC, BookRevCarrierCost, BookRevOtherCost, BookRevTotalCost, " _
            '                         & " BookMilesFrom , BookRouteConsFlag,BookCarrierContact , BookCarrierContactPhone,BookTypeCode,BookCarrOrderNumber " _
            '                         & " FROM Book, Comp, Carrier " _
            '                         & " WHERE Book.BookCustCompControl = Comp.CompControl and Book.BookCarrierControl = Carrier.CarrierControl " & strComp & " and " & Filters

            Dim oQRet As Ngl.Core.Data.QueryResult = oQuery.ExecuteWithFill(strSQL)
            If Not oQRet.Exception Is Nothing Then
                Utilities.SaveAppError(oQRet.Exception.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_FailedToExecute"}, New FaultReason("E_DataAccessError"))
            End If
            If Not oQRet.Data Is Nothing AndAlso oQRet.Data.Rows.Count > 0 Then
                For Each oRow As System.Data.DataRow In oQRet.Data.Rows
                    Dim oItem As New DTO.vLoadStatusBoard
                    With oItem
                        .BookControl = DTran.getDataRowValue(oRow, "BookControl", 0)
                        .BookDateLoad = DTran.getDataRowValue(oRow, "BookDateLoad")
                        .BookDateRequired = DTran.getDataRowValue(oRow, "BookDateRequired")
                        .BookOrigZip = DTran.getDataRowValue(oRow, "BookOrigZip", "")
                        .BookOrigCity = DTran.getDataRowValue(oRow, "BookOrigCity", "")
                        .BookOrigState = DTran.getDataRowValue(oRow, "BookOrigState", "")
                        .BookConsPrefix = DTran.getDataRowValue(oRow, "BookConsPrefix", "")
                        .BookProNumber = DTran.getDataRowValue(oRow, "BookProNumber", "")
                        .BookCustCompControl = DTran.getDataRowValue(oRow, "BookCustCompControl", 0)
                        .CompName = DTran.getDataRowValue(oRow, "CompName", "")
                        .BookOrigName = DTran.getDataRowValue(oRow, "BookOrigName", "")
                        .BookDestName = DTran.getDataRowValue(oRow, "BookDestName", "")
                        .BookDestCity = DTran.getDataRowValue(oRow, "BookDestCity", "")
                        .BookDestState = DTran.getDataRowValue(oRow, "BookDestState", "")
                        .BookDestZip = DTran.getDataRowValue(oRow, "BookDestZip", "")
                        .BookTotalCases = DTran.getDataRowValue(oRow, "BookTotalCases", 0)
                        .BookTotalWgt = DTran.getDataRowValue(oRow, "BookTotalWgt", 0)
                        .BookTotalPL = DTran.getDataRowValue(oRow, "BookTotalPL", 0)
                        .BookTotalCube = DTran.getDataRowValue(oRow, "BookTotalCube", 0)
                        .BookTotalPX = DTran.getDataRowValue(oRow, "BookTotalPX", 0)
                        .BookTotalBFC = DTran.getDataRowValue(oRow, "BookTotalBFC", 0)
                        .BookCarrActDate = DTran.getDataRowValue(oRow, "BookCarrActDate")
                        .BookFinARInvoiceDate = DTran.getDataRowValue(oRow, "BookFinARInvoiceDate")
                        .BookODControl = DTran.getDataRowValue(oRow, "BookODControl", 0)
                        .BookCarrierControl = DTran.getDataRowValue(oRow, "BookCarrierControl", 0)
                        .CarrierName = DTran.getDataRowValue(oRow, "CarrierName", "")
                        .BookTranCode = DTran.getDataRowValue(oRow, "BookTranCode", "")
                        .BookPayCode = DTran.getDataRowValue(oRow, "BookPayCode", "")
                        .BookStopNo = DTran.getDataRowValue(oRow, "BookStopNo", 0)
                        .BookModDate = DTran.getDataRowValue(oRow, "BookModDate")
                        .BookModUser = DTran.getDataRowValue(oRow, "BookModUser", "")
                        .BookRevBilledBFC = DTran.getDataRowValue(oRow, "BookRevBilledBFC", 0)
                        .BookCarrOrderNumber = DTran.getDataRowValue(oRow, "BookCarrOrderNumber", "")
                        .BookRevCarrierCost = DTran.getDataRowValue(oRow, "BookRevCarrierCost", 0)
                        .BookRevOtherCost = DTran.getDataRowValue(oRow, "BookRevOtherCost", 0)
                        .BookRevTotalCost = DTran.getDataRowValue(oRow, "BookRevTotalCost", 0)
                        .BookMilesFrom = DTran.getDataRowValue(oRow, "BookMilesFrom", 0)
                        .BookRouteConsFlag = DTran.getDataRowValue(oRow, "BookRouteConsFlag", 0)
                        .BookCarrierContact = DTran.getDataRowValue(oRow, "BookCarrierContact", "")
                        .BookCarrierContactPhone = DTran.getDataRowValue(oRow, "BookCarrierContactPhone", "")
                        .BookTypeCode = DTran.getDataRowValue(oRow, "BookTypeCode", "")
                        .BookCarrOrderNumber = DTran.getDataRowValue(oRow, "BookCarrOrderNumber", "")
                        .BookCarrierContControl = DTran.getDataRowValue(oRow, "BookCarrierContControl", 0)
                        .BookOrderSequence = DTran.getDataRowValue(oRow, "BookOrderSequence", 0)
                        .BookOrigAddress1 = DTran.getDataRowValue(oRow, "BookOrigAddress1", "")
                        .BookDestAddress1 = DTran.getDataRowValue(oRow, "BookDestAddress1", "")
                        .CompNumber = DTran.getDataRowValue(oRow, "CompNumber", 0)
                        .CarrierNumber = DTran.getDataRowValue(oRow, "CarrierNumber", 0)
                        .BookLockAllCosts = DTran.getDataRowValue(oRow, "BookLockAllCosts", False)
                        .BookLockBFCCost = DTran.getDataRowValue(oRow, "BookLockBFCCost", False)
                        .BookPickupStopNumber = DTran.getDataRowValue(oRow, "BookPickupStopNumber", 0)
                        .BookOrigStopNumber = DTran.getDataRowValue(oRow, "BookOrigStopNumber", 0)
                        .BookDestStopNumber = DTran.getDataRowValue(oRow, "BookDestStopNumber", 0)
                        .BookOrigMiles = DTran.getDataRowValue(oRow, "BookOrigMiles", 0)
                        .BookDestMiles = DTran.getDataRowValue(oRow, "BookDestMiles", 0)
                        .BookPickNumber = DTran.getDataRowValue(oRow, "BookPickNumber", 0)
                        .BookTransType = DTran.getDataRowValue(oRow, "BookTransType", 0)
                    End With
                    oLoadStatusBoards.Add(oItem)
                Next
            Else
                oLoadStatusBoards.Add(New DTO.vLoadStatusBoard)
            End If
            Return oLoadStatusBoards.ToArray()
        Catch ex As FaultException
            Throw
        Catch ex As System.Data.SqlClient.SqlException
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
        Catch ex As InvalidOperationException
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
        Catch ex As Exception
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
        Finally
            oQuery = Nothing
        End Try

        Return Nothing
    End Function

    Public Function GetvLoadStatusBoardsByCNS(Optional ByVal BookConsPrefix As String = "") As DTO.vLoadStatusBoard()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl

                'db.Log = New DebugTextWriter
                'Get the newest record that matches the provided criteria
                Dim vLoadStatusBoards() As DTO.vLoadStatusBoard = ( _
                From d In db.vLoadStatusBoards _
                Where _
                    (BookConsPrefix Is Nothing OrElse String.IsNullOrEmpty(BookConsPrefix) OrElse d.BookConsPrefix = BookConsPrefix) _
                    And _
                    (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.BookCustCompControl)) _
                Order By d.BookConsPrefix Descending, d.BookStopNo _
                Select New DTO.vLoadStatusBoard With {.BookControl = d.BookControl _
                                            , .BookProNumber = d.BookProNumber _
                                            , .BookDateLoad = d.BookDateLoad _
                                            , .BookDateRequired = d.BookDateRequired _
                                            , .BookConsPrefix = d.BookConsPrefix _
                                            , .BookCustCompControl = d.BookCustCompControl _
                                            , .CompName = d.CompName _
                                            , .CompNumber = d.CompNumber _
                                            , .BookODControl = d.BookODControl _
                                            , .BookCarrierControl = d.BookCarrierControl _
                                            , .CarrierName = d.CarrierName _
                                            , .CarrierNumber = d.CarrierNumber _
                                            , .BookCarrierContControl = d.BookCarrierContControl _
                                            , .BookCarrierContact = d.BookCarrierContact _
                                            , .BookCarrierContactPhone = d.BookCarrierContactPhone _
                                            , .BookOrigName = d.BookOrigName _
                                            , .BookOrigAddress1 = d.BookOrigAddress1 _
                                            , .BookOrigCity = d.BookOrigCity _
                                            , .BookOrigState = d.BookOrigState _
                                            , .BookOrigZip = d.BookOrigZip _
                                            , .BookDestName = d.BookDestName _
                                            , .BookDestAddress1 = d.BookDestAddress1 _
                                            , .BookDestCity = d.BookDestCity _
                                            , .BookDestState = d.BookDestState _
                                            , .BookDestZip = d.BookDestZip _
                                            , .BookTotalCases = If(d.BookTotalCases.HasValue, d.BookTotalCases, 0) _
                                            , .BookTotalWgt = If(d.BookTotalWgt.HasValue, d.BookTotalWgt, 0) _
                                            , .BookTotalPL = If(d.BookTotalPL.HasValue, d.BookTotalPL, 0) _
                                            , .BookTotalCube = If(d.BookTotalCube.HasValue, d.BookTotalCube, 0) _
                                            , .BookTotalPX = If(d.BookTotalPX.HasValue, d.BookTotalPX, 0) _
                                            , .BookTotalBFC = If(d.BookTotalBFC.HasValue, d.BookTotalBFC, 0) _
                                            , .BookCarrActDate = d.BookCarrActDate _
                                            , .BookFinARInvoiceDate = d.BookFinARInvoiceDate _
                                            , .BookTranCode = d.BookTranCode _
                                            , .BookPayCode = d.BookPayCode _
                                            , .BookTypeCode = d.BookTypeCode _
                                            , .BookStopNo = If(d.BookStopNo.HasValue, d.BookStopNo, 0) _
                                            , .BookModDate = d.BookModDate _
                                            , .BookModUser = d.BookModUser _
                                            , .BookRevBilledBFC = If(d.BookRevBilledBFC.HasValue, d.BookRevBilledBFC, 0) _
                                            , .BookRevCarrierCost = If(d.BookRevCarrierCost.HasValue, d.BookRevCarrierCost, 0) _
                                            , .BookRevOtherCost = If(d.BookRevOtherCost.HasValue, d.BookRevOtherCost, 0) _
                                            , .BookRevTotalCost = If(d.BookRevTotalCost.HasValue, d.BookRevTotalCost, 0) _
                                            , .BookMilesFrom = If(d.BookMilesFrom.HasValue, d.BookMilesFrom, 0) _
                                            , .BookRouteConsFlag = d.BookRouteConsFlag _
                                            , .BookCarrOrderNumber = d.BookCarrOrderNumber _
                                            , .BookOrderSequence = d.BookOrderSequence _
                                            , .BookLockAllCosts = d.BookLockAllCosts _
                                            , .BookLockBFCCost = d.BookLockBFCCost _
                                            , .BookPickupStopNumber = d.BookPickupStopNumber _
                                            , .BookOrigStopNumber = d.BookOrigStopNumber _
                                            , .BookDestStopNumber = d.BookDestStopNumber _
                                            , .BookOrigMiles = d.BookOrigMiles _
                                            , .BookDestMiles = d.BookDestMiles _
                                            , .BookPickNumber = d.BookPickNumber _ 
                                            , .BookTransType = d.BookTransType}).Take(500).ToArray()

                Return vLoadStatusBoards

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Overrides Function Update(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity)) As Object
        SaveChanges(oData)
        Dim source As DTO.vLoadStatusBoard = TryCast(oData, DTO.vLoadStatusBoard)
        If source Is Nothing Then Return Nothing
        Dim oBook As New NGLBookData(Me.Parameters)
        oBook.UpdateCNSLockFlags(source.BookControl)
        ' Return the updated order
        Return GetvLoadStatusBoardFiltered(Control:=source.BookControl)

    End Function

    Public Overrides Function UpdateQuick(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity)) As DTO.QuickSaveResults
        SaveChanges(oData)
        Dim source As DTO.vLoadStatusBoard = TryCast(oData, DTO.vLoadStatusBoard)
        If source Is Nothing Then Return Nothing
        ' Return the updated order
        Return GetQuickSaveResults(oData)

    End Function

    Public Overrides Sub UpdateNoReturn(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity))
        SaveChanges(oData)
        Dim source As DTO.vBookCons = TryCast(oData, DTO.vBookCons)
        If source Is Nothing Then Return
        Dim oBook As New NGLBookData(Me.Parameters)
        oBook.UpdateCNSLockFlags(source.BookControl)
    End Sub   

#End Region

#Region "Protected Methods"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Return Nothing
    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Dim source As LTS.vLoadStatusBoard = TryCast(LinqTable, LTS.vLoadStatusBoard)
        If source Is Nothing Then Return Nothing
        Dim oBook As New NGLBookData(Me.Parameters)
        oBook.UpdateCNSLockFlags(source.BookControl)
        Return GetvLoadStatusBoardFiltered(Control:=source.BookControl)
    End Function

    Protected Overrides Sub NoReturnCleanUp(ByVal LinqTable As Object)
        Dim source As LTS.vLoadStatusBoard = TryCast(LinqTable, LTS.vLoadStatusBoard)
        If Not source Is Nothing Then
            Dim oBook As New NGLBookData(Me.Parameters)
            oBook.UpdateCNSLockFlags(source.BookControl)
        End If
    End Sub

    Protected Overrides Function GetQuickSaveResults(ByVal LinqTable As Object) As DataTransferObjects.QuickSaveResults
        Dim ret As DTO.QuickSaveResults
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim source As DTO.vLoadStatusBoard = TryCast(LinqTable, DTO.vLoadStatusBoard)
                If source Is Nothing Then Return Nothing
                Dim oBook As New NGLBookData(Me.Parameters)
                oBook.UpdateCNSLockFlags(source.BookControl)
                ret = (From d In db.vLoadStatusBoards _
                       Where d.BookControl = source.BookControl _
                       Select New DTO.QuickSaveResults With {.Control = d.BookControl _
                                                            , .ModDate = d.BookModDate _
                                                            , .ModUser = d.BookModUser}).First

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

        End Using
        Return ret
    End Function

    Protected Overrides Sub ValidateNewRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
         'We do not allow booking records to be deleted from this class
        Utilities.SaveAppError("Cannot add data.  Records cannot be inserted using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))

    End Sub

    Protected Overrides Sub ValidateDeletedRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'We do not allow booking records to be deleted from this class
        Utilities.SaveAppError("Cannot delete data.  Records cannot be deleted using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))

    End Sub

    Private Sub SaveChanges(ByVal oData As DTO.vLoadStatusBoard)
        Using LinqDB
            'Note: the ValidateData Function must throw a FaultException error on failure
            ValidateUpdatedRecord(LinqDB, oData)
            With oData
                Try
                    'Open the existing Record
                    Dim d = (From e In CType(LinqDB, NGLMasBookDataContext).vLoadStatusBoards Where e.BookControl = .BookControl Select e).First
                    If d Is Nothing Then
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_RecordDeleted"}, New FaultReason("E_InvalidOperationException"))
                    Else
                        'Check for conflicts
                        If .BookModDate <> d.BookModDate Then
                            'the data may have changed so check each field for conflicts
                            Dim ConflictData As New List(Of KeyValuePair(Of String, String))
                            Dim blnConflictFound As Boolean = False
                            addToConflicts("BookProNumber", .BookProNumber, d.BookProNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookDateLoad", .BookDateLoad, d.BookDateLoad, ConflictData, blnConflictFound)
                            addToConflicts("BookDateRequired", .BookDateRequired, d.BookDateRequired, ConflictData, blnConflictFound)
                            addToConflicts("BookConsPrefix", .BookConsPrefix, d.BookConsPrefix, ConflictData, blnConflictFound)
                            addToConflicts("BookCustCompControl", .BookCustCompControl, d.BookCustCompControl, ConflictData, blnConflictFound)
                            addToConflicts("BookODControl", .BookODControl, d.BookODControl, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrierControl", .BookCarrierControl, d.BookCarrierControl, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrierContControl", .BookCarrierContControl, d.BookCarrierContControl, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrierContact", .BookCarrierContact, d.BookCarrierContact, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrierContactPhone", .BookCarrierContactPhone, d.BookCarrierContactPhone, ConflictData, blnConflictFound)
                            addToConflicts("BookOrigName", .BookOrigName, d.BookOrigName, ConflictData, blnConflictFound)
                            addToConflicts("BookOrigAddress1", .BookOrigAddress1, d.BookOrigAddress1, ConflictData, blnConflictFound)
                            addToConflicts("BookOrigCity", .BookOrigCity, d.BookOrigCity, ConflictData, blnConflictFound)
                            addToConflicts("BookOrigState", .BookOrigState, d.BookOrigState, ConflictData, blnConflictFound)
                            addToConflicts("BookOrigZip", .BookOrigZip, d.BookOrigZip, ConflictData, blnConflictFound)
                            addToConflicts("BookDestName", .BookDestName, d.BookDestName, ConflictData, blnConflictFound)
                            addToConflicts("BookDestAddress1", .BookDestAddress1, d.BookDestAddress1, ConflictData, blnConflictFound)
                            addToConflicts("BookDestCity", .BookDestCity, d.BookDestCity, ConflictData, blnConflictFound)
                            addToConflicts("BookDestState", .BookDestState, d.BookDestState, ConflictData, blnConflictFound)
                            addToConflicts("BookDestZip", .BookDestZip, d.BookDestZip, ConflictData, blnConflictFound)
                            addToConflicts("BookTotalCases", .BookTotalCases, d.BookTotalCases, ConflictData, blnConflictFound)
                            addToConflicts("BookTotalWgt", .BookTotalWgt, d.BookTotalWgt, ConflictData, blnConflictFound)
                            addToConflicts("BookTotalPL", .BookTotalPL, d.BookTotalPL, ConflictData, blnConflictFound)
                            addToConflicts("BookTotalCube", .BookTotalCube, d.BookTotalCube, ConflictData, blnConflictFound)
                            addToConflicts("BookTotalPX", .BookTotalPX, d.BookTotalPX, ConflictData, blnConflictFound)
                            addToConflicts("BookTotalBFC", .BookTotalBFC, d.BookTotalBFC, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrActDate", .BookCarrActDate, d.BookCarrActDate, ConflictData, blnConflictFound)
                            addToConflicts("BookFinARInvoiceDate", .BookFinARInvoiceDate, d.BookFinARInvoiceDate, ConflictData, blnConflictFound)
                            addToConflicts("BookTranCode", .BookTranCode, d.BookTranCode, ConflictData, blnConflictFound)
                            addToConflicts("BookPayCode", .BookPayCode, d.BookPayCode, ConflictData, blnConflictFound)
                            addToConflicts("BookTypeCode", .BookTypeCode, d.BookTypeCode, ConflictData, blnConflictFound)
                            addToConflicts("BookStopNo", .BookStopNo, d.BookStopNo, ConflictData, blnConflictFound)
                            addToConflicts("BookRevBilledBFC", .BookRevBilledBFC, d.BookRevBilledBFC, ConflictData, blnConflictFound)
                            addToConflicts("BookRevCarrierCost", .BookRevCarrierCost, d.BookRevCarrierCost, ConflictData, blnConflictFound)
                            addToConflicts("BookRevOtherCost", .BookRevOtherCost, d.BookRevOtherCost, ConflictData, blnConflictFound)
                            addToConflicts("BookRevTotalCost", .BookRevTotalCost, d.BookRevTotalCost, ConflictData, blnConflictFound)
                            addToConflicts("BookMilesFrom", .BookMilesFrom, d.BookMilesFrom, ConflictData, blnConflictFound)
                            addToConflicts("BookRouteConsFlag", .BookRouteConsFlag, d.BookRouteConsFlag, ConflictData, blnConflictFound)
                            addToConflicts("BookCarrOrderNumber", .BookCarrOrderNumber, d.BookCarrOrderNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookOrderSequence", .BookOrderSequence, d.BookOrderSequence, ConflictData, blnConflictFound)
                            addToConflicts("BookMilesFrom", .BookMilesFrom, d.BookMilesFrom, ConflictData, blnConflictFound)
                            addToConflicts("BookLockAllCosts", .BookLockAllCosts, d.BookLockAllCosts, ConflictData, blnConflictFound)
                            addToConflicts("BookLockBFCCost", .BookLockBFCCost, d.BookLockBFCCost, ConflictData, blnConflictFound)
                            addToConflicts("BookPickupStopNumber", .BookPickupStopNumber, d.BookPickupStopNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookOrigStopNumber", .BookOrigStopNumber, d.BookOrigStopNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookDestStopNumber", .BookDestStopNumber, d.BookDestStopNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookOrigMiles", .BookOrigMiles, d.BookOrigMiles, ConflictData, blnConflictFound)
                            addToConflicts("BookDestMiles", .BookDestMiles, d.BookDestMiles, ConflictData, blnConflictFound)
                            addToConflicts("BookPickNumber", .BookPickNumber, d.BookPickNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookTransType", .BookTransType, d.BookTransType, ConflictData, blnConflictFound)


                            If blnConflictFound Then
                                'We only add the mod date and mod user if one or more other fields have been modified
                                addToConflicts("BookModDate", .BookModDate, d.BookModDate, ConflictData, blnConflictFound)
                                addToConflicts("BookModUser", .BookModUser, d.BookModUser, ConflictData, blnConflictFound)
                                Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(ConflictData))
                                conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                                Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                            End If
                        End If
                        'Update the table data
                        d.BookProNumber = .BookProNumber
                        d.BookDateLoad = .BookDateLoad
                        d.BookDateRequired = .BookDateRequired
                        d.BookConsPrefix = .BookConsPrefix
                        d.BookCustCompControl = .BookCustCompControl
                        d.BookODControl = .BookODControl
                        d.BookCarrierControl = .BookCarrierControl
                        d.BookCarrierContControl = .BookCarrierContControl
                        d.BookCarrierContact = .BookCarrierContact
                        d.BookCarrierContactPhone = .BookCarrierContactPhone
                        d.BookOrigName = .BookOrigName
                        d.BookOrigAddress1 = .BookOrigAddress1
                        d.BookOrigCity = .BookOrigCity
                        d.BookOrigState = .BookOrigState
                        d.BookOrigZip = .BookOrigZip
                        d.BookDestName = .BookDestName
                        d.BookDestAddress1 = .BookDestAddress1
                        d.BookDestCity = .BookDestCity
                        d.BookDestState = .BookDestState
                        d.BookDestZip = .BookDestZip
                        d.BookTotalCases = .BookTotalCases
                        d.BookTotalWgt = .BookTotalWgt
                        d.BookTotalPL = .BookTotalPL
                        d.BookTotalCube = .BookTotalCube
                        d.BookTotalPX = .BookTotalPX
                        d.BookTotalBFC = .BookTotalBFC
                        d.BookCarrActDate = .BookCarrActDate
                        d.BookFinARInvoiceDate = .BookFinARInvoiceDate
                        d.BookTranCode = .BookTranCode
                        d.BookPayCode = .BookPayCode
                        d.BookTypeCode = .BookTypeCode
                        d.BookOrigStopNumber = If(.BookOrigStopNumber < 1, 1, .BookOrigStopNumber)
                        d.BookDestStopNumber = calculateBookDestStopNumber(d.BookStopNo, .BookStopNo, d.BookDestStopNumber)
                        d.BookStopNo = If(.BookStopNo < 1, 1, .BookStopNo)
                        d.BookRevBilledBFC = .BookRevBilledBFC
                        d.BookRevCarrierCost = .BookRevCarrierCost
                        d.BookRevOtherCost = .BookRevOtherCost
                        d.BookRevTotalCost = .BookRevTotalCost
                        d.BookMilesFrom = .BookMilesFrom
                        d.BookRouteConsFlag = .BookRouteConsFlag
                        d.BookCarrOrderNumber = .BookCarrOrderNumber
                        d.BookOrderSequence = .BookOrderSequence
                        d.BookLockAllCosts = .BookLockAllCosts
                        d.BookLockBFCCost = .BookLockBFCCost
                        d.BookPickupStopNumber = If(.BookPickupStopNumber < 1, 1, .BookPickupStopNumber)
                        d.BookOrigMiles = .BookOrigMiles
                        d.BookDestMiles = .BookDestMiles
                        d.BookPickNumber = If(.BookPickNumber < 1, 1, .BookPickNumber)
                        d.BookTransType = .BookTransType
                        'update the mod date and mod user                       
                        d.BookModDate = Date.Now
                        d.BookModUser = Me.Parameters.UserName
                    End If
                    LinqDB.SubmitChanges()
                Catch ex As FaultException
                    Throw
                Catch ex As SqlException
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
                Catch conflictEx As ChangeConflictException
                    Try
                        Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(LinqDB))
                        conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                        Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                    Catch ex As FaultException
                        Throw
                    Catch ex As Exception
                        Utilities.SaveAppError(ex.Message, Me.Parameters)
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
                    End Try
                Catch ex As InvalidOperationException
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_RecordDeleted"}, New FaultReason("E_InvalidOperationException"))
                Catch ex As Exception
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
                End Try

            End With
        End Using
    End Sub

#End Region

End Class

Public Class NGLAllItemData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.spNGLLOADRecord(0)
        Me.LinqDB = db
    End Sub

#End Region

#Region "Properties"

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GetAllItem(Control:=Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return Nothing
    End Function

    Public Function GetAllItem(ByVal Control As Integer) As DTO.AllItem

        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Get the page data
                Dim oItem As DTO.AllItem = (From d In db.spNGLLOADRecord(Control) _
                                                  Select New DTO.AllItem With {.Control = d.LOADBookControl, _
                                                     .ProNumber = d.LOADProNumber, _
                                                     .CnsNumber = d.LOADCONSPREFIX, _
                                                     .StopNumber = d.LOADStopNo, _
                                                     .BookPickupStopNumber = d.BookPickupStopNumber, _
                                                     .PurchaseOrderNumber = d.LOADPO, _
                                                     .OrderNumber = d.LOADOrderNumber, _
                                                     .ScheduledToLoad = d.LOADDATE, _
                                                     .RequestedToArrive = d.SCHEDULEDATE, _
                                                     .AssignedCarrier = d.LOADCarrierName, _
                                                     .DestinationName = d.LOADDestName, _
                                                     .DestinationCity = d.LOADDestCity, _
                                                     .DestinationState = d.LOADDestState, _
                                                     .CarrierData = New DTO.BookCarrier With {.BookCarrScheduleDate = d.LOADToLoadDate, _
                                                                                              .BookCarrScheduleTime = d.LOADScheduleTime, _
                                                                                              .BookCarrActualDate = d.LOADActPickupDate, _
                                                                                              .BookCarrActualTime = d.LOADActPickupTime, _
                                                                                              .BookCarrStartLoadingDate = d.LOADStartLoadingDate, _
                                                                                              .BookCarrStartLoadingTime = d.LOADStartLoadingTime, _
                                                                                              .BookCarrFinishLoadingDate = d.LOADFinishLoadingDate, _
                                                                                              .BookCarrFinishLoadingTime = d.LOADFinishLoadingTime, _
                                                                                              .BookCarrActLoadComplete_Date = d.LOADActLoadComplete_Date, _
                                                                                              .BookCarrActLoadCompleteTime = d.LOADActLoadCompleteTime, _
                                                                                              .BookCarrDockPUAssigment = d.LOADDockPUAssigment, _
                                                                                              .BookCarrApptDate = d.LOADDelScheduleDate, _
                                                                                              .BookCarrApptTime = d.LOADDelScheduleTime, _
                                                                                              .BookCarrActDate = d.LOADActDelDate, _
                                                                                              .BookCarrActTime = d.LOADActDelTime, _
                                                                                              .BookCarrStartUnloadingDate = d.LOADDelStartUnloadingDate, _
                                                                                              .BookCarrStartUnloadingTime = d.LOADDelStartUnloadingTime, _
                                                                                              .BookCarrFinishUnloadingDate = d.LOADDelFinishUnloadingDate, _
                                                                                              .BookCarrFinishUnloadingTime = d.LOADDelFinishUnloadingTime, _
                                                                                              .BookCarrActUnloadCompDate = d.LOADActLoadCompDate, _
                                                                                              .BookCarrActUnloadCompTime = d.LOADActLoadCompTime, _
                                                                                              .BookCarrDockDelAssignment = d.LOADDelDock, _
                                                                                              .BookCarrTrailerNo = d.LOADTrailerNo, _
                                                                                              .BookCarrSealNo = d.LOADSealNo, _
                                                                                              .BookCarrDriverNo = d.LOADDriverNo, _
                                                                                              .BookCarrDriverName = d.LOADDriverName, _
                                                                                              .BookCarrTripNo = d.LOADTripNo, _
                                                                                              .BookCarrRouteNo = d.LOADRouteNo, _
                                                                                              .BookWhseAuthorizationNo = d.LOADWhseAuthorizationNo}, _
                                                     .Comments = d.Comments, _
                                                     .BookNotes1 = d.BookNotesVisable1, _
                                                     .BookNotes2 = d.BookNotesVisable2, _
                                                     .BookNotes3 = d.BookNotesVisable3, _
                                                     .AssignedProNumber = d.BookShipCarrierProNumber, _
                                                     .AssignedCarrierName = d.BookShipCarrierName, _
                                                     .AssignedCarrierNumber = d.BookShipCarrierNumber, _
                                                     .AssignedCarrierContact = d.BookCarrierContact, _
                                                     .AssignedCarrierContactPhone = d.BookCarrierContactPhone, _
                                                     .BookModDate = d.BookModDate, _
                                                     .BookModUser = d.BookModUser, _
                                                     .BookAMSPickupApptControl = d.BookAMSPickupApptControl, _
                                                     .BookAMSDeliveryApptControl = d.BookAMSDeliveryApptControl, _
                                                     .BookLoadControl = d.BookLoadControl}).First

                Return oItem

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetAllItems(ByVal proNumber As String, _
                                ByVal CNS As String, _
                                ByVal PO As String, _
                                ByVal OrderNumber As String, _
                                ByVal LoadDate As Nullable(Of DateTime), _
                                ByVal LoadDateTo As Nullable(Of DateTime), _
                                ByVal SCHEDULEDATE As Nullable(Of DateTime), _
                                ByVal SCHEDULEDATETo As Nullable(Of DateTime), _
                                ByVal LOADDelScheduleDate As Nullable(Of DateTime), _
                                ByVal LOADDelScheduleDateTo As Nullable(Of DateTime), _
                                ByVal LOADDelScheduleTime As String, _
                                ByVal LOADActDelDate As Nullable(Of DateTime), _
                                ByVal LOADActDelDateTo As Nullable(Of DateTime), _
                                ByVal LOADCARRIERNAME As String, _
                                ByVal LOADCARRIERNUMBER As Nullable(Of Integer), _
                                ByVal LOADDESTNAME As String, _
                                ByVal LOADDESTCITY As String, _
                                ByVal LOADDESTSTATE As String, _
                                ByVal LOADBROKERNUMBER As String, _
                                ByVal LOADCARRIERCONTCONTROL As Nullable(Of Integer), _
                                ByVal UseCarrierFilters As Nullable(Of Boolean), _
                                ByVal DaysOut As Nullable(Of Integer), _
                                ByVal DelDaysOut As Nullable(Of Integer), _
                                ByVal xmlTransCode As String, _
                                ByVal xmlLoadCompanyIDs As String, _
                                ByVal xmlLoadLanes As String, _
                                ByVal p_sortordinal As String, _
                                ByVal p_sortdirection As String, _
                                ByVal p_datefilterfield As String, _
                                ByVal p_datefilterfrom As Nullable(Of DateTime), _
                                ByVal p_datefilterto As Nullable(Of DateTime), _
                                Optional ByVal page As Integer = 1, _
                                Optional ByVal pagesize As Integer = 1000) As DTO.AllItem()
        If pagesize < 1 Then pagesize = 1
        If page < 1 Then page = 1
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim xmlXmlTransCode As XElement = If(String.IsNullOrEmpty(xmlTransCode), Nothing, XElement.Parse(xmlTransCode))
                Dim xmlXmlLoadCompanyIDs As XElement = If(String.IsNullOrEmpty(xmlLoadCompanyIDs), Nothing, XElement.Parse(xmlLoadCompanyIDs))
                Dim xmlXmlLoadLanes As XElement = If(String.IsNullOrEmpty(xmlLoadLanes), Nothing, XElement.Parse(xmlLoadLanes))
                'Get the page data
                Dim oList() As DTO.AllItem = (From d In db.spNGLLOAD_SORTEDWPages_New(proNumber, _
                                                                                    CNS, _
                                                                                    PO, _
                                                                                    OrderNumber, _
                                                                                    LoadDate, _
                                                                                    LoadDateTo, _
                                                                                    SCHEDULEDATE, _
                                                                                    SCHEDULEDATETo, _
                                                                                    LOADDelScheduleDate, _
                                                                                    LOADDelScheduleDateTo, _
                                                                                    LOADDelScheduleTime, _
                                                                                    LOADActDelDate, _
                                                                                    LOADActDelDateTo, _
                                                                                    LOADCARRIERNAME, _
                                                                                    LOADCARRIERNUMBER, _
                                                                                    LOADDESTNAME, _
                                                                                    LOADDESTCITY, _
                                                                                    LOADDESTSTATE, _
                                                                                    LOADBROKERNUMBER, _
                                                                                    LOADCARRIERCONTCONTROL, _
                                                                                    UseCarrierFilters, _
                                                                                    DaysOut, _
                                                                                    DelDaysOut, _
                                                                                    xmlXmlTransCode, _
                                                                                    xmlXmlLoadCompanyIDs, _
                                                                                    xmlXmlLoadLanes, _
                                                                                    p_sortordinal, _
                                                                                    p_sortdirection, _
                                                                                    p_datefilterfield, _
                                                                                    p_datefilterfrom, _
                                                                                    p_datefilterto, _
                                                                                    page, _
                                                                                    pagesize) _
                                                  Select New DTO.AllItem With {.Control = d.LOADBookControl, _
                                                     .ProNumber = d.LOADProNumber, _
                                                     .CnsNumber = d.LOADCONSPREFIX, _
                                                     .StopNumber = d.LOADStopNo, _
                                                     .BookPickupStopNumber = d.BookPickupStopNumber, _
                                                     .PurchaseOrderNumber = d.LOADPO, _
                                                     .OrderNumber = d.LOADOrderNumber, _
                                                     .ScheduledToLoad = d.LOADDATE, _
                                                     .RequestedToArrive = d.SCHEDULEDATE, _
                                                     .AssignedCarrier = d.LOADCarrierName, _
                                                     .DestinationName = d.LOADDestName, _
                                                     .DestinationCity = d.LOADDestCity, _
                                                     .DestinationState = d.LOADDestState, _
                                                     .CarrierData = New DTO.BookCarrier With {.BookCarrScheduleDate = d.LOADToLoadDate, _
                                                                                              .BookCarrScheduleTime = d.LOADScheduleTime, _
                                                                                              .BookCarrActualDate = d.LOADActPickupDate, _
                                                                                              .BookCarrActualTime = d.LOADActPickupTime, _
                                                                                              .BookCarrStartLoadingDate = d.LOADStartLoadingDate, _
                                                                                              .BookCarrStartLoadingTime = d.LOADStartLoadingTime, _
                                                                                              .BookCarrFinishLoadingDate = d.LOADFinishLoadingDate, _
                                                                                              .BookCarrFinishLoadingTime = d.LOADFinishLoadingTime, _
                                                                                              .BookCarrActLoadComplete_Date = d.LOADActLoadComplete_Date, _
                                                                                              .BookCarrActLoadCompleteTime = d.LOADActLoadCompleteTime, _
                                                                                              .BookCarrDockPUAssigment = d.LOADDockPUAssigment, _
                                                                                              .BookCarrApptDate = d.LOADDelScheduleDate, _
                                                                                              .BookCarrApptTime = d.LOADDelScheduleTime, _
                                                                                              .BookCarrActDate = d.LOADActDelDate, _
                                                                                              .BookCarrActTime = d.LOADActDelTime, _
                                                                                              .BookCarrStartUnloadingDate = d.LOADDelStartUnloadingDate, _
                                                                                              .BookCarrStartUnloadingTime = d.LOADDelStartUnloadingTime, _
                                                                                              .BookCarrFinishUnloadingDate = d.LOADDelFinishUnloadingDate, _
                                                                                              .BookCarrFinishUnloadingTime = d.LOADDelFinishUnloadingTime, _
                                                                                              .BookCarrActUnloadCompDate = d.LOADActLoadCompDate, _
                                                                                              .BookCarrActUnloadCompTime = d.LOADActLoadCompTime, _
                                                                                              .BookCarrDockDelAssignment = d.LOADDelDock, _
                                                                                              .BookCarrTrailerNo = d.LOADTrailerNo, _
                                                                                              .BookCarrSealNo = d.LOADSealNo, _
                                                                                              .BookCarrDriverNo = d.LOADDriverNo, _
                                                                                              .BookCarrDriverName = d.LOADDriverName, _
                                                                                              .BookCarrTripNo = d.LOADTripNo, _
                                                                                              .BookCarrRouteNo = d.LOADRouteNo, _
                                                                                              .BookWhseAuthorizationNo = d.LOADWhseAuthorizationNo}, _
                                                     .Comments = d.Comments, _
                                                     .BookNotes1 = d.BookNotesVisable1, _
                                                     .BookNotes2 = d.BookNotesVisable2, _
                                                     .BookNotes3 = d.BookNotesVisable3, _
                                                     .AssignedProNumber = d.BookShipCarrierProNumber, _
                                                     .AssignedCarrierName = d.BookShipCarrierName, _
                                                     .AssignedCarrierNumber = d.BookShipCarrierNumber, _
                                                     .AssignedCarrierContact = d.BookCarrierContact, _
                                                     .AssignedCarrierContactPhone = d.BookCarrierContactPhone, _
                                                     .BookModDate = d.BookModDate, _
                                                     .BookModUser = d.BookModUser, _
                                                     .BookAMSPickupApptControl = If(d.BookAMSPickupApptControl.HasValue, d.BookAMSPickupApptControl.Value, 0), _
                                                     .BookAMSDeliveryApptControl = If(d.BookAMSDeliveryApptControl.HasValue, d.BookAMSDeliveryApptControl.Value, 0), _
                                                     .BookLoadControl = d.BookLoadControl,
                                                     .Page = page, _
                                                     .Pages = d.Pages, _
                                                     .RecordCount = d.RecordCount}).ToArray()

                Return oList

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Overrides Function Update(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity)) As Object
        SaveChanges(oData)
        Dim source As DTO.AllItem = TryCast(oData, DTO.AllItem)
        If source Is Nothing Then Return Nothing
        ' Return the updated order
        Return GetAllItem(Control:=source.Control)

    End Function

    Public Sub UpdateAll(ByVal AllItems() As DTO.AllItem)

        For Each Item As DTO.AllItem In AllItems
            SaveChanges(Item)
        Next


    End Sub

    Public Overrides Sub UpdateNoReturn(Of TEntity As Class)(ByVal oData As Object, _
                                ByVal oLinqTable As System.Data.Linq.Table(Of TEntity))
        SaveChanges(oData)
    End Sub

#End Region

#Region "Protected Methods"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Return Nothing
    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Return Nothing
    End Function

    Protected Overrides Sub NoReturnCleanUp(ByVal LinqTable As Object)
        Dim source As LTS.vBookLoadMaintenance = TryCast(LinqTable, LTS.vBookLoadMaintenance)
        If Not source Is Nothing Then
            Dim oBook As New NGLBookData(Me.Parameters)
            oBook.UpdateCNSLockFlags(source.BookControl)
        End If
    End Sub

    Protected Overrides Sub ValidateNewRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'We do not allow booking records to be deleted from this class
        Utilities.SaveAppError("Cannot add data.  Records cannot be inserted using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))
    End Sub

    Protected Overrides Sub ValidateDeletedRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'We do not allow booking records to be deleted from this class
        Utilities.SaveAppError("Cannot delete data.  Records cannot be deleted using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))

    End Sub

    Protected Overrides Sub ValidateUpdatedRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        ''Check if the data already exists only one allowed
        'With CType(oData, DTO.AllItem)
        '    Try
        '        'Get the newest record that matches the provided criteria
        '        Dim AllItem As DTO.AllItem = ( _
        '        From t In CType(oDB, NGLMasBookDataContext).vBookLoadMaintenances _
        '         Where _
        '             (t.BookControl <> .BookControl) _
        '             And _
        '             (t.BookProNumber = .BookProNumber) _
        '         Select New DTO.AllItem With {.BookControl = t.BookControl}).First

        '        If Not AllItem Is Nothing Then
        '            Utilities.SaveAppError("Cannot save Book changes.  The Book PRO Number, " & .BookProNumber & " already exist.", Me.Parameters)
        '            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_InvalidKeyField"}, New FaultReason("E_DataValidationFailure"))
        '        End If

        '    Catch ex As FaultException
        '        Throw
        '    Catch ex As InvalidOperationException
        '        'do nothing this is the desired result.
        '    End Try
        'End With
    End Sub

    Private Function getNewBookCodeValues(ByRef intCodeVal1 As Integer, ByRef intCodeVal2 As Integer) As Boolean
        Dim blnRet As Boolean = False
        Try
            intCodeVal1 = getScalarInteger("Select dbo.getLastBookCode1() as RetVal")
            intCodeVal2 = getScalarInteger("Select dbo.getLastBookCode2() as RetVal")
            intCodeVal2 = intCodeVal2 + 1
            If intCodeVal2 >= 255 Then
                intCodeVal2 = 33
                intCodeVal1 = intCodeVal1 + 1
                If intCodeVal1 = 160 Then intCodeVal1 = 161
                If intCodeVal1 = 173 Then intCodeVal1 = 174
            End If
            If intCodeVal1 > 255 Then
                Utilities.SaveAppError("E_MaxNbrOfBooks", Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_MaxNbrOfBooks"}, New FaultReason("E_CreateRecordFailure"))
            End If
            If intCodeVal2 < 40 Then intCodeVal2 = 40
            If intCodeVal2 = 45 Then intCodeVal2 = 46
            If intCodeVal2 > 96 And intCodeVal2 < 123 Then intCodeVal2 = 124
            If intCodeVal2 = 126 Then intCodeVal2 = 128
            If intCodeVal2 = 127 Then intCodeVal2 = 128
            If intCodeVal2 = 160 Then intCodeVal2 = 161
            If intCodeVal1 = 173 Then intCodeVal1 = 174
            blnRet = True
        Catch ex As FaultException
            Throw
        Catch ex As Exception
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
        End Try
        Return blnRet
    End Function

    Private Function GetCustAbrev(ByVal Control As Integer, _
                                 Optional ByVal UseCompNumber As Boolean = False) As String

        Dim strSQL As String = "Select dbo.comp.compabrev as RetVal " _
            & " From dbo.comp "
        If UseCompNumber Then
            strSQL &= " Where dbo.comp.compnumber = " & Control
        Else
            strSQL &= " Where dbo.comp.compcontrol = " & Control
        End If
        Return getScalarString(strSQL)

    End Function

    Private Sub SaveChanges(ByVal oData As DTO.AllItem)
        Using LinqDB
            'Note: the ValidateData Function must throw a FaultException error on failure
            ValidateUpdatedRecord(LinqDB, oData)
            With oData
                Try
                    'Open the existing Record
                    Dim d = (From e In CType(LinqDB, NGLMasBookDataContext).Books Where e.BookControl = .Control Select e).First
                    If d Is Nothing Then
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_RecordDeleted"}, New FaultReason("E_InvalidOperationException"))
                    Else
                        'Check for conflicts
                        If .BookModDate <> d.BookModDate Then
                            'the data may have changed so check each field for conflicts
                            Dim ConflictData As New List(Of KeyValuePair(Of String, String))
                            Dim blnConflictFound As Boolean = False
                            With .CarrierData
                                addToConflicts("BookCarrScheduleDate", .BookCarrScheduleDate, d.BookCarrScheduleDate, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrScheduleTime", .BookCarrScheduleTime, d.BookCarrScheduleTime, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrActualDate", .BookCarrActualDate, d.BookCarrActualDate, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrActualTime", .BookCarrActualTime, d.BookCarrActualTime, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrStartLoadingDate", .BookCarrStartLoadingDate, d.BookCarrStartLoadingDate, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrStartLoadingTime", .BookCarrStartLoadingTime, d.BookCarrStartLoadingTime, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrFinishLoadingDate", .BookCarrFinishLoadingDate, d.BookCarrFinishLoadingDate, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrFinishLoadingTime", .BookCarrFinishLoadingTime, d.BookCarrFinishLoadingTime, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrActLoadComplete_Date", .BookCarrActLoadComplete_Date, d.BookCarrActLoadComplete_Date, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrActLoadCompleteTime", .BookCarrActLoadCompleteTime, d.BookCarrActLoadCompleteTime, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrDockPUAssigment", .BookCarrDockPUAssigment, d.BookCarrDockPUAssigment, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrApptDate", .BookCarrApptDate, d.BookCarrApptDate, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrApptTime", .BookCarrApptTime, d.BookCarrApptTime, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrActDate", .BookCarrActDate, d.BookCarrActDate, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrActTime", .BookCarrActTime, d.BookCarrActTime, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrStartUnloadingDate", .BookCarrStartUnloadingDate, d.BookCarrStartUnloadingDate, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrStartUnloadingTime", .BookCarrStartUnloadingTime, d.BookCarrStartUnloadingTime, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrFinishUnloadingDate", .BookCarrFinishUnloadingDate, d.BookCarrFinishUnloadingDate, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrFinishUnloadingTime", .BookCarrFinishUnloadingTime, d.BookCarrFinishUnloadingTime, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrActUnloadCompDate", .BookCarrActUnloadCompDate, d.BookCarrActUnloadCompDate, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrActUnloadCompTime", .BookCarrActUnloadCompTime, d.BookCarrActUnloadCompTime, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrDockDelAssignment", .BookCarrDockDelAssignment, d.BookCarrDockDelAssignment, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrTrailerNo", .BookCarrTrailerNo, d.BookCarrTrailerNo, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrSealNo", .BookCarrSealNo, d.BookCarrSealNo, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrDriverNo", .BookCarrDriverNo, d.BookCarrDriverNo, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrDriverName", .BookCarrDriverName, d.BookCarrDriverName, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrTripNo", .BookCarrTripNo, d.BookCarrTripNo, ConflictData, blnConflictFound)
                                addToConflicts("BookCarrRouteNo", .BookCarrRouteNo, d.BookCarrRouteNo, ConflictData, blnConflictFound)
                                addToConflicts("BookWhseAuthorizationNo", .BookWhseAuthorizationNo, d.BookWhseAuthorizationNo, ConflictData, blnConflictFound)
                            End With
                            'addToConflicts("Comments", .Comments, d.Comments, ConflictData, blnConflictFound)
                            addToConflicts("BookShipCarrierProNumber", .AssignedProNumber, d.BookShipCarrierProNumber, ConflictData, blnConflictFound)
                            addToConflicts("BookShipCarrierName", .AssignedCarrierName, d.BookShipCarrierName, ConflictData, blnConflictFound)
                            addToConflicts("BookShipCarrierNumber", .AssignedCarrierNumber, d.BookShipCarrierNumber, ConflictData, blnConflictFound)

                            If blnConflictFound Then
                                'We only add the mod date and mod user if one or more other fields have been modified
                                addToConflicts("BookModDate", .BookModDate, d.BookModDate, ConflictData, blnConflictFound)
                                addToConflicts("BookModUser", .BookModUser, d.BookModUser, ConflictData, blnConflictFound)
                                Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(ConflictData))
                                conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                                Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                            End If
                        End If
                        Dim StatusUpdateMsg As String = "NEXTrack changes "
                        'build the status update string for the date and time changes and update the data in the book table as needed
                        With .CarrierData
                            If d.BookCarrScheduleDate <> .BookCarrScheduleDate Then
                                d.BookCarrScheduleDate = .BookCarrScheduleDate

                            End If
                            d.BookCarrScheduleTime = .BookCarrScheduleTime
                            d.BookCarrActualDate = .BookCarrActualDate
                            d.BookCarrActualTime = .BookCarrActualTime
                            d.BookCarrStartLoadingDate = .BookCarrStartLoadingDate
                            d.BookCarrStartLoadingTime = .BookCarrStartLoadingTime
                            d.BookCarrFinishLoadingDate = .BookCarrFinishLoadingDate
                            d.BookCarrFinishLoadingTime = .BookCarrFinishLoadingTime
                            d.BookCarrActLoadComplete_Date = .BookCarrActLoadComplete_Date
                            d.BookCarrActLoadCompleteTime = .BookCarrActLoadCompleteTime
                            d.BookCarrDockPUAssigment = .BookCarrDockPUAssigment
                            d.BookCarrApptDate = .BookCarrApptDate
                            d.BookCarrApptTime = .BookCarrApptTime
                            d.BookCarrActDate = .BookCarrActDate
                            d.BookCarrActTime = .BookCarrActTime
                            d.BookCarrStartUnloadingDate = .BookCarrStartUnloadingDate
                            d.BookCarrStartUnloadingTime = .BookCarrStartUnloadingTime
                            d.BookCarrFinishUnloadingDate = .BookCarrFinishUnloadingDate
                            d.BookCarrFinishUnloadingTime = .BookCarrFinishUnloadingTime
                            d.BookCarrActUnloadCompDate = .BookCarrActUnloadCompDate
                            d.BookCarrActUnloadCompTime = .BookCarrActUnloadCompTime
                            d.BookCarrDockDelAssignment = .BookCarrDockDelAssignment
                            d.BookCarrTrailerNo = .BookCarrTrailerNo
                            d.BookCarrSealNo = .BookCarrSealNo
                            d.BookCarrDriverNo = .BookCarrDriverNo
                            d.BookCarrDriverName = .BookCarrDriverName
                            d.BookCarrTripNo = .BookCarrTripNo
                            d.BookCarrRouteNo = .BookCarrRouteNo
                            d.BookWhseAuthorizationNo = .BookWhseAuthorizationNo
                        End With
                        d.BookModDate = Date.Now
                        d.BookModUser = Me.Parameters.UserName
                        d.BookShipCarrierProNumber = .AssignedProNumber
                        d.BookShipCarrierName = .AssignedCarrierName
                        d.BookShipCarrierNumber = .AssignedCarrierNumber
                    End If
                    LinqDB.SubmitChanges()
                Catch ex As FaultException
                    Throw
                Catch ex As SqlException
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
                Catch conflictEx As ChangeConflictException
                    Try
                        Dim conflictInfo As ConflictFaultInfo = (New SqlConflictFaultInfo(LinqDB))
                        conflictInfo.LogConflictDetails(conflictInfo.Message, Me.Parameters)
                        Throw New FaultException(Of ConflictFaultInfo)(conflictInfo, New FaultReason("E_DataConflict"))
                    Catch ex As FaultException
                        Throw
                    Catch ex As Exception
                        Utilities.SaveAppError(ex.Message, Me.Parameters)
                        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
                    End Try
                Catch ex As InvalidOperationException
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_RecordDeleted"}, New FaultReason("E_InvalidOperationException"))
                Catch ex As Exception
                    Utilities.SaveAppError(ex.Message, Me.Parameters)
                    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
                End Try

            End With
        End Using
    End Sub

    Private Function AddToTrackingMessageForDate(ByVal Original As DateTime, ByVal Updated As DateTime, ByVal prefix As String) As String
        Dim strRet As String = ""
        If Original <> Updated Then
            strRet = prefix & " [from " & Original.ToShortDateString & " " & Original.ToShortTimeString & " to " & Updated.ToShortDateString & " " & Updated.ToShortTimeString & "]" & Environment.NewLine
        End If
        Return strRet
        '//create string to hold changeds
        '  string changed = string.Empty;

        '  string pickup = trackPickupChanges ? "PICKUP: " + Environment.NewLine : string.Empty;
        '  string delivery = trackDeliveryChanges ? "DELIVERY: " + Environment.NewLine : string.Empty;

        '  if (trackPickupChanges) //vil >> 
        '  {
        '      //compare this (current item) with changed item (passed in)
        '      if ((oldAllItem.PickupScheduledAppointmentDate.ToString("MM/dd/yyyy") != newAllItem.PickupScheduledAppointmentDate.ToString("MM/dd/yyyy")) || (oldAllItem.PickupScheduledAppointmentTime.ToShortTimeString() != newAllItem.PickupScheduledAppointmentTime.ToShortTimeString()))
        '      {
        '          changed += pickup + " APPT [from " + oldAllItem.PickupScheduledAppointmentDate.ToString("MM/dd/yyyy") + " " + oldAllItem.PickupScheduledAppointmentTime.ToShortTimeString() + " to " + newAllItem.PickupScheduledAppointmentDate.ToString("MM/dd/yyyy") + " " + newAllItem.PickupScheduledAppointmentTime.ToShortTimeString() + "]" + Environment.NewLine;
        '          pickup = string.Empty;
        '      }

        '      if ((oldAllItem.PickupActualArrivalDate.ToString("MM/dd/yyyy") != newAllItem.PickupActualArrivalDate.ToString("MM/dd/yyyy")) || (oldAllItem.PickupActualArrivalTime.ToShortTimeString() != newAllItem.PickupActualArrivalTime.ToShortTimeString()))
        '      {
        '          changed += pickup + " ACT [from " + oldAllItem.PickupActualArrivalDate.ToString("MM/dd/yyyy") + " " + oldAllItem.PickupActualArrivalTime.ToShortTimeString() + " to " + newAllItem.PickupActualArrivalDate.ToString("MM/dd/yyyy") + " " + newAllItem.PickupActualArrivalTime.ToShortTimeString() + "]" + Environment.NewLine;
        '          //aan:>>
        '          pickup = string.Empty;
        '          //aan:<<
        '      }

        '      //aan:>>
        '      if ((oldAllItem.PickupStartLoadingDate.ToString("MM/dd/yyyy") != newAllItem.PickupStartLoadingDate.ToString("MM/dd/yyyy")) || (oldAllItem.PickupStartLoadingTime.ToShortTimeString() != newAllItem.PickupStartLoadingTime.ToShortTimeString()))
        '      {
        '          changed += pickup + " STRT [from " + oldAllItem.PickupStartLoadingDate.ToString("MM/dd/yyyy") + " " + oldAllItem.PickupStartLoadingTime.ToShortTimeString() + " to " + newAllItem.PickupStartLoadingDate.ToString("MM/dd/yyyy") + " " + newAllItem.PickupStartLoadingTime.ToShortTimeString() + "]" + Environment.NewLine;
        '          pickup = string.Empty;
        '      }

        '      if ((oldAllItem.PickupFinishLoadingDate.ToString("MM/dd/yyyy") != newAllItem.PickupFinishLoadingDate.ToString("MM/dd/yyyy")) || (oldAllItem.PickupFinishLoadingTime.ToShortTimeString() != newAllItem.PickupFinishLoadingTime.ToShortTimeString()))
        '      {
        '          changed += pickup + " FNSH [from " + oldAllItem.PickupFinishLoadingDate.ToString("MM/dd/yyyy") + " " + oldAllItem.PickupFinishLoadingTime.ToShortTimeString() + " to " + newAllItem.PickupFinishLoadingDate.ToString("MM/dd/yyyy") + " " + newAllItem.PickupFinishLoadingTime.ToShortTimeString() + "]" + Environment.NewLine;
        '          pickup = string.Empty;
        '      }

        '      if ((oldAllItem.PickupActLoadCompleteDate.ToString("MM/dd/yyyy") != newAllItem.PickupActLoadCompleteDate.ToString("MM/dd/yyyy")) || (oldAllItem.PickupActLoadCompleteTime.ToShortTimeString() != newAllItem.PickupActLoadCompleteTime.ToShortTimeString()))
        '      {
        '          changed += pickup + " CMPL [from " + oldAllItem.PickupActLoadCompleteDate.ToString("MM/dd/yyyy") + " " + oldAllItem.PickupActLoadCompleteTime.ToShortTimeString() + " to " + newAllItem.PickupActLoadCompleteDate.ToString("MM/dd/yyyy") + " " + newAllItem.PickupActLoadCompleteTime.ToShortTimeString() + "]" + Environment.NewLine;
        '      }
        '      //aan:<<
        '  } //vil<< 

        '                      If (trackDeliveryChanges) Then
        '  {
        '      if ((oldAllItem.DeliveryScheduledAppointmentDate.ToString("MM/dd/yyyy") != newAllItem.DeliveryScheduledAppointmentDate.ToString("MM/dd/yyyy")) || (oldAllItem.DeliveryScheduledAppointmentTime.ToShortTimeString() != newAllItem.DeliveryScheduledAppointmentTime.ToShortTimeString()))
        '      {
        '          changed += ((changed.Length > 0) ? " " : string.Empty) + delivery + " APPT [from " + oldAllItem.DeliveryScheduledAppointmentDate.ToString("MM/dd/yyyy") + " " + oldAllItem.DeliveryScheduledAppointmentTime.ToShortTimeString() + " to " + newAllItem.DeliveryScheduledAppointmentDate.ToString("MM/dd/yyyy") + " " + newAllItem.DeliveryScheduledAppointmentTime.ToShortTimeString() + "]" + Environment.NewLine;
        '          delivery = string.Empty;
        '      }

        '      if ((oldAllItem.DeliveryActualArrivalDate.ToString("MM/dd/yyyy") != newAllItem.DeliveryActualArrivalDate.ToString("MM/dd/yyyy")) || (oldAllItem.DeliveryActualArrivalTime.ToShortTimeString() != newAllItem.DeliveryActualArrivalTime.ToShortTimeString()))
        '      {
        '          changed += ((changed.Length > 0 && delivery.Length == 0) ? " " : string.Empty) + delivery + " ACT [from " + oldAllItem.DeliveryActualArrivalDate.ToString("MM/dd/yyyy") + " " + oldAllItem.DeliveryActualArrivalTime.ToShortTimeString() + " to " + newAllItem.DeliveryActualArrivalDate.ToString("MM/dd/yyyy") + " " + newAllItem.DeliveryActualArrivalTime.ToShortTimeString() + "]" + Environment.NewLine;
        '          //aan:>>
        '          delivery = string.Empty;
        '          //aan:<<
        '      }

        '      //aan:>>
        '      if ((oldAllItem.DeliveryStartUnloadingDate.ToString("MM/dd/yyyy") != newAllItem.DeliveryStartUnloadingDate.ToString("MM/dd/yyyy")) || (oldAllItem.DeliveryStartUnloadingTime.ToShortTimeString() != newAllItem.DeliveryStartUnloadingTime.ToShortTimeString()))
        '      {
        '          changed += ((changed.Length > 0 && delivery.Length == 0) ? " " : string.Empty) + delivery + " STRT [from " + oldAllItem.DeliveryStartUnloadingDate.ToString("MM/dd/yyyy") + " " + oldAllItem.DeliveryStartUnloadingTime.ToShortTimeString() + " to " + newAllItem.DeliveryStartUnloadingDate.ToString("MM/dd/yyyy") + " " + newAllItem.DeliveryStartUnloadingTime.ToShortTimeString() + "]" + Environment.NewLine;
        '          delivery = string.Empty;
        '      }

        '      if ((oldAllItem.DeliveryFinishUnloadingDate.ToString("MM/dd/yyyy") != newAllItem.DeliveryFinishUnloadingDate.ToString("MM/dd/yyyy")) || (oldAllItem.DeliveryFinishUnloadingTime.ToShortTimeString() != newAllItem.DeliveryFinishUnloadingTime.ToShortTimeString()))
        '      {
        '          changed += ((changed.Length > 0 && delivery.Length == 0) ? " " : string.Empty) + delivery + " FNSH [from " + oldAllItem.DeliveryFinishUnloadingDate.ToString("MM/dd/yyyy") + " " + oldAllItem.DeliveryFinishUnloadingTime.ToShortTimeString() + " to " + newAllItem.DeliveryFinishUnloadingDate.ToString("MM/dd/yyyy") + " " + newAllItem.DeliveryFinishUnloadingTime.ToShortTimeString() + "]" + Environment.NewLine;
        '          delivery = string.Empty;
        '      }

        '      if ((oldAllItem.DeliveryActUnloadCompDate.ToString("MM/dd/yyyy") != newAllItem.DeliveryActUnloadCompDate.ToString("MM/dd/yyyy")) || (oldAllItem.DeliveryActUnloadCompTime.ToShortTimeString() != newAllItem.DeliveryActUnloadCompTime.ToShortTimeString()))
        '      {
        '          changed += ((changed.Length > 0 && delivery.Length == 0) ? " " : string.Empty) + delivery + " CMPLT [from " + oldAllItem.DeliveryActUnloadCompDate.ToString("MM/dd/yyyy") + " " + oldAllItem.DeliveryActUnloadCompTime.ToShortTimeString() + " to " + newAllItem.DeliveryActUnloadCompDate.ToString("MM/dd/yyyy") + " " + newAllItem.DeliveryActUnloadCompTime.ToShortTimeString() + "]" + Environment.NewLine;
        '      }
        '      //aan:<<
        '  } //vil<<

        '  //check changed
        '                                              If (changed.Length > 0) Then
        '  {
        '      //prepend title
        '      changed = "NEXTrack Changes " + changed;

        '      //save in db
        '      //aan:>>
        '      //DataProviderFactory.GetDataProvider().SetChangedDateComments(newAllItem.Control, changed, newAllItem);//aan:
        '      //aan:<<
        '      //alg:>>
        '      DataProviderFactory.GetWCFDataProvider().SetChangedDateComments(newAllItem.Control, changed, newAllItem);
        '      //alg:<<
        '  }
    End Function

#End Region

End Class

Public Class NGLNewBookingsForSolutionData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.vNewBookingsForSolutions
        Me.LinqDB = db
    End Sub

#End Region

#Region " Properties "

    Protected Overrides Property LinqTable() As Object
        Get
            Dim db As New NGLMasBookDataContext(ConnectionString)
            Me.LinqTable = db.vNewBookingsForSolutions
            Me.LinqDB = db
            Return _LinqTable
        End Get
        Set(ByVal value As Object)
            _LinqTable = value
        End Set
    End Property

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GetNewBookingFiltered(Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return Nothing
    End Function

    ''' <summary>
    ''' The LowerControl parameter allows for a starting control number to be providced.
    ''' The Solution Control Number is used to ignore new booking records that have already been assigned to the solution. 
    ''' The FKControl parameter is a reference to the Comp Control Number.
    ''' </summary>
    ''' <param name="LowerControl"></param>
    ''' <param name="FKControl"></param>
    ''' <param name="SolutionControl"></param>
    ''' <param name="FromDate"></param>
    ''' <param name="ToDate"></param>
    ''' <param name="UseLoadDate"></param>
    ''' <param name="NatAccountNumber"></param>
    ''' <param name="RouteTypeCode"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overloads Function GetFirstRecord(ByVal LowerControl As Long, _
                                             ByVal FKControl As Long, _
                                             ByVal SolutionControl As Long, _
                                             ByVal FromDate As Date, _
                                             ByVal ToDate As Date, _
                                             ByVal UseLoadDate As Boolean, _
                                             ByVal NatAccountNumber As Integer, _
                                             ByVal RouteTypeCode As Integer) As DataTransferObjects.DTOBaseClass

        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                FromDate = DTran.formatStartDateFilter(FromDate)
                ToDate = DTran.formatEndDateFilter(ToDate)
                Dim NewBooking As New DTO.tblSolutionDetail
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                Dim oSecureNat = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName And s.CompNatNumber <> 0 Select s.CompNatNumber

                If SolutionControl <> 0 Then
                    Dim SolutionTrucks = From st In db.tblSolutionTrucks Where st.SolutionTruckSolutionControl = SolutionControl Select st.SolutionTruckControl
                    Dim AssignedBookings = From t In db.tblSolutionDetails Where SolutionTrucks.Contains(t.SolutionDetailSolutionTruckControl) Select t.SolutionDetailBookControl

                    NewBooking = ( _
                    From d In db.vNewBookingsForSolutions _
                    Where (LowerControl = 0 OrElse d.SolutionDetailBookControl >= LowerControl) _
                    And _
                    (NatAccountNumber <> 0 OrElse (d.SolutionDetailCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionDetailCompControl)))) _
                    And _
                    (If(UseLoadDate, _
                            (d.SolutionDetailDateLoad >= FromDate And d.SolutionDetailDateLoad <= ToDate), _
                            (d.SolutionDetailDateRequired >= FromDate And d.SolutionDetailDateRequired <= ToDate) _
                        ) _
                    ) _
                    And _
                    (NatAccountNumber = 0 OrElse (d.SolutionDetailCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionDetailCompNatNumber)))) _
                    And _
                    (RouteTypeCode = 0 OrElse d.SolutionDetailRouteTypeCode = RouteTypeCode) _
                    And _
                    (AssignedBookings Is Nothing _
                        OrElse AssignedBookings.Count < 1 _
                        OrElse Not AssignedBookings.Contains(d.SolutionDetailBookControl)) _
                    Order By d.SolutionDetailBookControl _
                    Select New DTO.tblSolutionDetail With {.SolutionDetailBookControl = d.SolutionDetailBookControl _
                    , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                    , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                    , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                    , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                    , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                    , .SolutionDetailCom = d.SolutionDetailCom _
                    , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                    , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                    , .SolutionDetailCompNumber = If(d.SolutionDetailCompNumber.HasValue, d.SolutionDetailCompNumber.Value, 0) _
                    , .SolutionDetailCompName = d.SolutionDetailCompName _
                    , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                    , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                    , .SolutionDetailODControl = d.SolutionDetailODControl _
                    , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                    , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                    , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                    , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                    , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                    , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                    , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                    , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                    , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                    , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                    , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                    , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                    , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                    , .SolutionDetailDestName = d.SolutionDetailDestName _
                    , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                    , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                    , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                    , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                    , .SolutionDetailDestState = d.SolutionDetailDestState _
                    , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                    , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                    , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                    , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                    , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                    , .SolutionDetailTotalCases = If(d.SolutionDetailTotalCases.HasValue, d.SolutionDetailTotalCases.Value, 0) _
                    , .SolutionDetailTotalWgt = If(d.SolutionDetailTotalWgt.HasValue, d.SolutionDetailTotalWgt.Value, 0) _
                    , .SolutionDetailTotalPL = If(d.SolutionDetailTotalPL.HasValue, d.SolutionDetailTotalPL.Value, 0) _
                    , .SolutionDetailTotalCube = If(d.SolutionDetailTotalCube.HasValue, d.SolutionDetailTotalCube.Value, 0) _
                    , .SolutionDetailTotalPX = If(d.SolutionDetailTotalPX.HasValue, d.SolutionDetailTotalPX.Value, 0) _
                    , .SolutionDetailTotalBFC = If(d.SolutionDetailTotalBFC.HasValue, d.SolutionDetailTotalBFC.Value, 0) _
                    , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                    , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                    , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                    , .SolutionDetailStopNo = If(d.SolutionDetailStopNo.HasValue, d.SolutionDetailStopNo.Value, 0) _
                    , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                    , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                    , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                    , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                    , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                    , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                    , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                    , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                    , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                    , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                    , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                    , .SolutionDetailTransType = d.SolutionDetailTransType _
                    , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                    , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                    , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                    , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                    , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                    , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                    , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                    , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                    , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                    , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                    , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                    , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                    , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                    , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                    , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                    , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                    , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                    , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                    , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                    , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                    , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                    , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                    , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                    , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                    , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                    , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                    , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                    , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                    , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                    , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                    , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                    , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                    , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                    , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                    , .SolutionDetailInbound = d.SolutionDetailInbound _
                    , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                    , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                    , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                    , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                    , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                    , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray()}).FirstOrDefault
                Else
                    'Zero indicates that we should get all the records no solution exists
                    NewBooking = ( _
                    From d In db.vNewBookingsForSolutions _
                    Where (LowerControl = 0 OrElse d.SolutionDetailBookControl >= LowerControl) _
                    And _
                    (NatAccountNumber <> 0 OrElse (d.SolutionDetailCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionDetailCompControl)))) _
                    And _
                    (If(UseLoadDate, _
                            (d.SolutionDetailDateLoad >= FromDate And d.SolutionDetailDateLoad <= ToDate), _
                            (d.SolutionDetailDateRequired >= FromDate And d.SolutionDetailDateRequired <= ToDate) _
                        ) _
                    ) _
                    And _
                    (NatAccountNumber = 0 OrElse (d.SolutionDetailCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionDetailCompNatNumber)))) _
                    And _
                    (RouteTypeCode = 0 OrElse d.SolutionDetailRouteTypeCode = RouteTypeCode) _
                    Order By d.SolutionDetailBookControl _
                    Select New DTO.tblSolutionDetail With {.SolutionDetailBookControl = d.SolutionDetailBookControl _
                    , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                    , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                    , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                    , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                    , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                    , .SolutionDetailCom = d.SolutionDetailCom _
                    , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                    , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                    , .SolutionDetailCompNumber = If(d.SolutionDetailCompNumber.HasValue, d.SolutionDetailCompNumber, 0) _
                    , .SolutionDetailCompName = d.SolutionDetailCompName _
                    , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                    , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                    , .SolutionDetailODControl = d.SolutionDetailODControl _
                    , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                    , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                    , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                    , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                    , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                    , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                    , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                    , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                    , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                    , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                    , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                    , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                    , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                    , .SolutionDetailDestName = d.SolutionDetailDestName _
                    , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                    , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                    , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                    , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                    , .SolutionDetailDestState = d.SolutionDetailDestState _
                    , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                    , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                    , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                    , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                    , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                    , .SolutionDetailTotalCases = If(d.SolutionDetailTotalCases.HasValue, d.SolutionDetailTotalCases.Value, 0) _
                    , .SolutionDetailTotalWgt = If(d.SolutionDetailTotalWgt.HasValue, d.SolutionDetailTotalWgt.Value, 0) _
                    , .SolutionDetailTotalPL = If(d.SolutionDetailTotalPL.HasValue, d.SolutionDetailTotalPL.Value, 0) _
                    , .SolutionDetailTotalCube = If(d.SolutionDetailTotalCube.HasValue, d.SolutionDetailTotalCube.Value, 0) _
                    , .SolutionDetailTotalPX = If(d.SolutionDetailTotalPX.HasValue, d.SolutionDetailTotalPX.Value, 0) _
                    , .SolutionDetailTotalBFC = If(d.SolutionDetailTotalBFC.HasValue, d.SolutionDetailTotalBFC.Value, 0) _
                    , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                    , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                    , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                    , .SolutionDetailStopNo = If(d.SolutionDetailStopNo.HasValue, d.SolutionDetailStopNo.Value, 0) _
                    , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                    , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                    , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                    , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                    , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                    , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                    , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                    , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                    , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                    , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                    , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                    , .SolutionDetailTransType = d.SolutionDetailTransType _
                    , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                    , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                    , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                    , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                    , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                    , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                    , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                    , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                    , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                    , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                    , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                    , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                    , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                    , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                    , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                    , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                    , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                    , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                    , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                    , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                    , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                    , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                    , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                    , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                    , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                    , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                    , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                    , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                    , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                    , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                    , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                    , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                    , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                    , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                    , .SolutionDetailInbound = d.SolutionDetailInbound _
                    , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                    , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                    , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                    , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                    , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                    , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray()}).FirstOrDefault
                End If

                Return NewBooking

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary>
    ''' The CurrentControl parameter is the seed for the previous record.
    ''' The Solution Control Number is used to ignore new booking records that have already been assigned to the solution. 
    ''' The FKControl parameter is a reference to the Comp Control Number.
    ''' </summary>
    ''' <param name="CurrentControl"></param>
    ''' <param name="FKControl"></param>
    ''' <param name="SolutionControl"></param>
    ''' <param name="FromDate"></param>
    ''' <param name="ToDate"></param>
    ''' <param name="UseLoadDate"></param>
    ''' <param name="NatAccountNumber"></param>
    ''' <param name="RouteTypeCode"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overloads Function GetPreviousRecord(ByVal CurrentControl As Long, _
                                                ByVal FKControl As Long, _
                                                ByVal SolutionControl As Long, _
                                                ByVal FromDate As Date, _
                                                ByVal ToDate As Date, _
                                                ByVal UseLoadDate As Boolean, _
                                                ByVal NatAccountNumber As Integer, _
                                                ByVal RouteTypeCode As Integer) As DataTransferObjects.DTOBaseClass
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                FromDate = DTran.formatStartDateFilter(FromDate)
                ToDate = DTran.formatEndDateFilter(ToDate)
                'For the test we use the book table and the bookload data is ignored.  
                'The final query will need to use a view that selects the book load data because
                'We need the temperature.
                Dim NewBooking As New DTO.tblSolutionDetail
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                Dim oSecureNat = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName And s.CompNatNumber <> 0 Select s.CompNatNumber

                If SolutionControl <> 0 Then
                    Dim SolutionTrucks = From st In db.tblSolutionTrucks Where st.SolutionTruckSolutionControl = SolutionControl Select st.SolutionTruckControl
                    Dim AssignedBookings = From t In db.tblSolutionDetails Where SolutionTrucks.Contains(t.SolutionDetailSolutionTruckControl) Select t.SolutionDetailBookControl

                    'Get the first record that matches the provided criteria
                    NewBooking = ( _
                    From d In db.vNewBookingsForSolutions _
                    Where d.SolutionDetailBookControl < CurrentControl _
                    And _
                    (NatAccountNumber <> 0 OrElse (d.SolutionDetailCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionDetailCompControl)))) _
                    And _
                    (If(UseLoadDate, _
                            (d.SolutionDetailDateLoad >= FromDate And d.SolutionDetailDateLoad <= ToDate), _
                            (d.SolutionDetailDateRequired >= FromDate And d.SolutionDetailDateRequired <= ToDate) _
                        ) _
                    ) _
                    And _
                    (NatAccountNumber = 0 OrElse (d.SolutionDetailCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionDetailCompNatNumber)))) _
                    And _
                    (RouteTypeCode = 0 OrElse d.SolutionDetailRouteTypeCode = RouteTypeCode) _
                    And _
                    (AssignedBookings Is Nothing _
                        OrElse AssignedBookings.Count < 1 _
                        OrElse Not AssignedBookings.Contains(d.SolutionDetailBookControl)) _
                    Order By d.SolutionDetailBookControl Descending _
                    Select New DTO.tblSolutionDetail With {.SolutionDetailBookControl = d.SolutionDetailBookControl _
                    , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                    , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                    , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                    , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                    , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                    , .SolutionDetailCom = d.SolutionDetailCom _
                    , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                    , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                    , .SolutionDetailCompNumber = If(d.SolutionDetailCompNumber.HasValue, d.SolutionDetailCompNumber, 0) _
                    , .SolutionDetailCompName = d.SolutionDetailCompName _
                    , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                    , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                    , .SolutionDetailODControl = d.SolutionDetailODControl _
                    , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                    , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                    , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                    , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                    , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                    , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                    , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                    , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                    , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                    , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                    , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                    , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                    , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                    , .SolutionDetailDestName = d.SolutionDetailDestName _
                    , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                    , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                    , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                    , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                    , .SolutionDetailDestState = d.SolutionDetailDestState _
                    , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                    , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                    , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                    , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                    , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                    , .SolutionDetailTotalCases = If(d.SolutionDetailTotalCases.HasValue, d.SolutionDetailTotalCases.Value, 0) _
                    , .SolutionDetailTotalWgt = If(d.SolutionDetailTotalWgt.HasValue, d.SolutionDetailTotalWgt.Value, 0) _
                    , .SolutionDetailTotalPL = If(d.SolutionDetailTotalPL.HasValue, d.SolutionDetailTotalPL.Value, 0) _
                    , .SolutionDetailTotalCube = If(d.SolutionDetailTotalCube.HasValue, d.SolutionDetailTotalCube.Value, 0) _
                    , .SolutionDetailTotalPX = If(d.SolutionDetailTotalPX.HasValue, d.SolutionDetailTotalPX.Value, 0) _
                    , .SolutionDetailTotalBFC = If(d.SolutionDetailTotalBFC.HasValue, d.SolutionDetailTotalBFC.Value, 0) _
                    , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                    , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                    , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                    , .SolutionDetailStopNo = If(d.SolutionDetailStopNo.HasValue, d.SolutionDetailStopNo.Value, 0) _
                    , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                    , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                    , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                    , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                    , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                    , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                    , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                    , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                    , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                    , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                    , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                    , .SolutionDetailTransType = d.SolutionDetailTransType _
                    , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                    , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                    , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                    , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                    , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                    , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                    , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                    , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                    , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                    , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                    , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                    , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                    , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                    , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                    , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                    , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                    , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                    , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                    , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                    , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                    , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                    , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                    , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                    , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                    , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                    , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                    , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                    , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                    , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                    , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                    , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                    , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                    , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                    , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                    , .SolutionDetailInbound = d.SolutionDetailInbound _
                    , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                    , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                    , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                    , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                    , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                    , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray()}).FirstOrDefault
                Else
                    NewBooking = ( _
                    From d In db.vNewBookingsForSolutions _
                    Where d.SolutionDetailBookControl < CurrentControl _
                    And _
                    (NatAccountNumber <> 0 OrElse (d.SolutionDetailCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionDetailCompControl)))) _
                    And _
                    (If(UseLoadDate, _
                            (d.SolutionDetailDateLoad >= FromDate And d.SolutionDetailDateLoad <= ToDate), _
                            (d.SolutionDetailDateRequired >= FromDate And d.SolutionDetailDateRequired <= ToDate) _
                        ) _
                    ) _
                    And _
                    (NatAccountNumber = 0 OrElse (d.SolutionDetailCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionDetailCompNatNumber)))) _
                    And _
                    (RouteTypeCode = 0 OrElse d.SolutionDetailRouteTypeCode = RouteTypeCode) _
                    Order By d.SolutionDetailBookControl Descending _
                    Select New DTO.tblSolutionDetail With {.SolutionDetailBookControl = d.SolutionDetailBookControl _
                    , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                    , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                    , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                    , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                    , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                    , .SolutionDetailCom = d.SolutionDetailCom _
                    , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                    , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                    , .SolutionDetailCompNumber = If(d.SolutionDetailCompNumber.HasValue, d.SolutionDetailCompNumber, 0) _
                    , .SolutionDetailCompName = d.SolutionDetailCompName _
                    , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                    , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                    , .SolutionDetailODControl = d.SolutionDetailODControl _
                    , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                    , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                    , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                    , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                    , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                    , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                    , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                    , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                    , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                    , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                    , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                    , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                    , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                    , .SolutionDetailDestName = d.SolutionDetailDestName _
                    , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                    , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                    , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                    , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                    , .SolutionDetailDestState = d.SolutionDetailDestState _
                    , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                    , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                    , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                    , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                    , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                    , .SolutionDetailTotalCases = If(d.SolutionDetailTotalCases.HasValue, d.SolutionDetailTotalCases.Value, 0) _
                    , .SolutionDetailTotalWgt = If(d.SolutionDetailTotalWgt.HasValue, d.SolutionDetailTotalWgt.Value, 0) _
                    , .SolutionDetailTotalPL = If(d.SolutionDetailTotalPL.HasValue, d.SolutionDetailTotalPL.Value, 0) _
                    , .SolutionDetailTotalCube = If(d.SolutionDetailTotalCube.HasValue, d.SolutionDetailTotalCube.Value, 0) _
                    , .SolutionDetailTotalPX = If(d.SolutionDetailTotalPX.HasValue, d.SolutionDetailTotalPX.Value, 0) _
                    , .SolutionDetailTotalBFC = If(d.SolutionDetailTotalBFC.HasValue, d.SolutionDetailTotalBFC.Value, 0) _
                    , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                    , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                    , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                    , .SolutionDetailStopNo = If(d.SolutionDetailStopNo.HasValue, d.SolutionDetailStopNo.Value, 0) _
                    , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                    , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                    , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                    , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                    , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                    , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                    , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                    , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                    , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                    , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                    , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                    , .SolutionDetailTransType = d.SolutionDetailTransType _
                    , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                    , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                    , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                    , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                    , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                    , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                    , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                    , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                    , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                    , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                    , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                    , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                    , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                    , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                    , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                    , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                    , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                    , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                    , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                    , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                    , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                    , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                    , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                    , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                    , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                    , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                    , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                    , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                    , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                    , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                    , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                    , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                    , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                    , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                    , .SolutionDetailInbound = d.SolutionDetailInbound _
                    , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                    , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                    , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                    , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                    , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                    , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray()}).FirstOrDefault
                End If


                Return NewBooking

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary>
    ''' The LowerControl parameter allows for a starting control number to be providced.
    ''' The Solution Control Number is used to ignore new booking records that have already been assigned to the solution. 
    ''' The FKControl parameter is a reference to the Comp Control Number.
    ''' </summary>
    ''' <param name="CurrentControl"></param>
    ''' <param name="FKControl"></param>
    ''' <param name="SolutionControl"></param>
    ''' <param name="FromDate"></param>
    ''' <param name="ToDate"></param>
    ''' <param name="UseLoadDate"></param>
    ''' <param name="NatAccountNumber"></param>
    ''' <param name="RouteTypeCode"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overloads Function GetNextRecord(ByVal CurrentControl As Long, _
                                             ByVal FKControl As Long, _
                                             ByVal SolutionControl As Long, _
                                             ByVal FromDate As Date, _
                                             ByVal ToDate As Date, _
                                             ByVal UseLoadDate As Boolean, _
                                             ByVal NatAccountNumber As Integer, _
                                             ByVal RouteTypeCode As Integer) As DataTransferObjects.DTOBaseClass
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                FromDate = DTran.formatStartDateFilter(FromDate)
                ToDate = DTran.formatEndDateFilter(ToDate)
                'For the test we use the book table and the bookload data is ignored.  
                'The final query will need to use a view that selects the book load data because
                'We need the temperature.
                Dim NewBooking As New DTO.tblSolutionDetail
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                Dim oSecureNat = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName And s.CompNatNumber <> 0 Select s.CompNatNumber

                If SolutionControl <> 0 Then
                    Dim SolutionTrucks = From st In db.tblSolutionTrucks Where st.SolutionTruckSolutionControl = SolutionControl Select st.SolutionTruckControl
                    Dim AssignedBookings = From t In db.tblSolutionDetails Where SolutionTrucks.Contains(t.SolutionDetailSolutionTruckControl) Select t.SolutionDetailBookControl

                    'Get the first record that matches the provided criteria
                    NewBooking = ( _
                    From d In db.vNewBookingsForSolutions _
                    Where d.SolutionDetailBookControl > CurrentControl _
                    And _
                    (NatAccountNumber <> 0 OrElse (d.SolutionDetailCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionDetailCompControl)))) _
                    And _
                    (If(UseLoadDate, _
                            (d.SolutionDetailDateLoad >= FromDate And d.SolutionDetailDateLoad <= ToDate), _
                            (d.SolutionDetailDateRequired >= FromDate And d.SolutionDetailDateRequired <= ToDate) _
                        ) _
                    ) _
                    And _
                    (NatAccountNumber = 0 OrElse (d.SolutionDetailCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionDetailCompNatNumber)))) _
                    And _
                    (RouteTypeCode = 0 OrElse d.SolutionDetailRouteTypeCode = RouteTypeCode) _
                    And _
                    (AssignedBookings Is Nothing _
                        OrElse AssignedBookings.Count < 1 _
                        OrElse Not AssignedBookings.Contains(d.SolutionDetailBookControl)) _
                    Order By d.SolutionDetailBookControl _
                    Select New DTO.tblSolutionDetail With {.SolutionDetailBookControl = d.SolutionDetailBookControl _
                    , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                    , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                    , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                    , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                    , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                    , .SolutionDetailCom = d.SolutionDetailCom _
                    , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                    , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                    , .SolutionDetailCompNumber = If(d.SolutionDetailCompNumber.HasValue, d.SolutionDetailCompNumber, 0) _
                    , .SolutionDetailCompName = d.SolutionDetailCompName _
                    , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                    , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                    , .SolutionDetailODControl = d.SolutionDetailODControl _
                    , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                    , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                    , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                    , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                    , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                    , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                    , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                    , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                    , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                    , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                    , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                    , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                    , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                    , .SolutionDetailDestName = d.SolutionDetailDestName _
                    , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                    , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                    , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                    , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                    , .SolutionDetailDestState = d.SolutionDetailDestState _
                    , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                    , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                    , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                    , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                    , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                    , .SolutionDetailTotalCases = If(d.SolutionDetailTotalCases.HasValue, d.SolutionDetailTotalCases.Value, 0) _
                    , .SolutionDetailTotalWgt = If(d.SolutionDetailTotalWgt.HasValue, d.SolutionDetailTotalWgt.Value, 0) _
                    , .SolutionDetailTotalPL = If(d.SolutionDetailTotalPL.HasValue, d.SolutionDetailTotalPL.Value, 0) _
                    , .SolutionDetailTotalCube = If(d.SolutionDetailTotalCube.HasValue, d.SolutionDetailTotalCube.Value, 0) _
                    , .SolutionDetailTotalPX = If(d.SolutionDetailTotalPX.HasValue, d.SolutionDetailTotalPX.Value, 0) _
                    , .SolutionDetailTotalBFC = If(d.SolutionDetailTotalBFC.HasValue, d.SolutionDetailTotalBFC.Value, 0) _
                    , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                    , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                    , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                    , .SolutionDetailStopNo = If(d.SolutionDetailStopNo.HasValue, d.SolutionDetailStopNo.Value, 0) _
                    , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                    , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                    , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                    , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                    , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                    , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                    , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                    , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                    , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                    , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                    , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                    , .SolutionDetailTransType = d.SolutionDetailTransType _
                    , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                    , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                    , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                    , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                    , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                    , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                    , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                    , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                    , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                    , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                    , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                    , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                    , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                    , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                    , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                    , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                    , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                    , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                    , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                    , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                    , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                    , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                    , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                    , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                    , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                    , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                    , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                    , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                    , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                    , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                    , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                    , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                    , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                    , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                    , .SolutionDetailInbound = d.SolutionDetailInbound _
                    , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                    , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                    , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                    , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                    , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                    , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray()}).FirstOrDefault
                Else
                    NewBooking = ( _
                   From d In db.vNewBookingsForSolutions _
                   Where d.SolutionDetailBookControl > CurrentControl _
                   And _
                    (NatAccountNumber <> 0 OrElse (d.SolutionDetailCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionDetailCompControl)))) _
                    And _
                    (If(UseLoadDate, _
                            (d.SolutionDetailDateLoad >= FromDate And d.SolutionDetailDateLoad <= ToDate), _
                            (d.SolutionDetailDateRequired >= FromDate And d.SolutionDetailDateRequired <= ToDate) _
                        ) _
                    ) _
                    And _
                    (NatAccountNumber = 0 OrElse (d.SolutionDetailCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionDetailCompNatNumber)))) _
                    And _
                    (RouteTypeCode = 0 OrElse d.SolutionDetailRouteTypeCode = RouteTypeCode) _
                   Order By d.SolutionDetailBookControl _
                   Select New DTO.tblSolutionDetail With {.SolutionDetailBookControl = d.SolutionDetailBookControl _
                    , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                    , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                    , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                    , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                    , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                    , .SolutionDetailCom = d.SolutionDetailCom _
                    , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                    , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                    , .SolutionDetailCompNumber = If(d.SolutionDetailCompNumber.HasValue, d.SolutionDetailCompNumber, 0) _
                    , .SolutionDetailCompName = d.SolutionDetailCompName _
                    , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                    , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                    , .SolutionDetailODControl = d.SolutionDetailODControl _
                    , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                    , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                    , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                    , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                    , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                    , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                    , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                    , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                    , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                    , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                    , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                    , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                    , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                    , .SolutionDetailDestName = d.SolutionDetailDestName _
                    , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                    , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                    , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                    , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                    , .SolutionDetailDestState = d.SolutionDetailDestState _
                    , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                    , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                    , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                    , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                    , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                    , .SolutionDetailTotalCases = If(d.SolutionDetailTotalCases.HasValue, d.SolutionDetailTotalCases.Value, 0) _
                    , .SolutionDetailTotalWgt = If(d.SolutionDetailTotalWgt.HasValue, d.SolutionDetailTotalWgt.Value, 0) _
                    , .SolutionDetailTotalPL = If(d.SolutionDetailTotalPL.HasValue, d.SolutionDetailTotalPL.Value, 0) _
                    , .SolutionDetailTotalCube = If(d.SolutionDetailTotalCube.HasValue, d.SolutionDetailTotalCube.Value, 0) _
                    , .SolutionDetailTotalPX = If(d.SolutionDetailTotalPX.HasValue, d.SolutionDetailTotalPX.Value, 0) _
                    , .SolutionDetailTotalBFC = If(d.SolutionDetailTotalBFC.HasValue, d.SolutionDetailTotalBFC.Value, 0) _
                    , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                    , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                    , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                    , .SolutionDetailStopNo = If(d.SolutionDetailStopNo.HasValue, d.SolutionDetailStopNo.Value, 0) _
                    , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                    , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                    , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                    , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                    , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                    , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                    , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                    , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                    , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                    , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                    , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                    , .SolutionDetailTransType = d.SolutionDetailTransType _
                    , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                    , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                    , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                    , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                    , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                    , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                    , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                    , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                    , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                    , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                    , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                    , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                    , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                    , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                    , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                    , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                    , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                    , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                    , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                    , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                    , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                    , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                    , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                    , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                    , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                    , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                    , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                    , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                    , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                    , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                    , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                    , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                    , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                    , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                    , .SolutionDetailInbound = d.SolutionDetailInbound _
                    , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                    , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                    , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                    , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                    , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                    , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray()}).FirstOrDefault
                End If
                Return NewBooking

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary>
    ''' The UpperControl parameter allows for a starting control number to be providced.
    ''' The Solution Control Number is used to ignore new booking records that have already been assigned to the solution. 
    ''' The FKControl parameter is a reference to the Comp Control Number.
    ''' </summary>
    ''' <param name="UpperControl"></param>
    ''' <param name="FKControl"></param>
    ''' <param name="SolutionControl"></param>
    ''' <param name="FromDate"></param>
    ''' <param name="ToDate"></param>
    ''' <param name="UseLoadDate"></param>
    ''' <param name="NatAccountNumber"></param>
    ''' <param name="RouteTypeCode"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overloads Function GetLastRecord(ByVal UpperControl As Long, _
                                             ByVal FKControl As Long, _
                                             ByVal SolutionControl As Long, _
                                             ByVal FromDate As Date, _
                                             ByVal ToDate As Date, _
                                             ByVal UseLoadDate As Boolean, _
                                             ByVal NatAccountNumber As Integer, _
                                             ByVal RouteTypeCode As Integer) As DataTransferObjects.DTOBaseClass
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                FromDate = DTran.formatStartDateFilter(FromDate)
                ToDate = DTran.formatEndDateFilter(ToDate)
                Dim NewBooking As New DTO.tblSolutionDetail
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                Dim oSecureNat = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName And s.CompNatNumber <> 0 Select s.CompNatNumber

                If UpperControl <> 0 Then

                    If SolutionControl <> 0 Then
                        Dim SolutionTrucks = From st In db.tblSolutionTrucks Where st.SolutionTruckSolutionControl = SolutionControl Select st.SolutionTruckControl
                        Dim AssignedBookings = From t In db.tblSolutionDetails Where SolutionTrucks.Contains(t.SolutionDetailSolutionTruckControl) Select t.SolutionDetailBookControl

                        NewBooking = ( _
                        From d In db.vNewBookingsForSolutions _
                        Where d.SolutionDetailBookControl >= UpperControl _
                        And _
                        (NatAccountNumber <> 0 OrElse (d.SolutionDetailCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionDetailCompControl)))) _
                        And _
                        (If(UseLoadDate, _
                                (d.SolutionDetailDateLoad >= FromDate And d.SolutionDetailDateLoad <= ToDate), _
                                (d.SolutionDetailDateRequired >= FromDate And d.SolutionDetailDateRequired <= ToDate) _
                            ) _
                        ) _
                        And _
                        (NatAccountNumber = 0 OrElse (d.SolutionDetailCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionDetailCompNatNumber)))) _
                        And _
                        (RouteTypeCode = 0 OrElse d.SolutionDetailRouteTypeCode = RouteTypeCode) _
                        And _
                        (AssignedBookings Is Nothing _
                            OrElse AssignedBookings.Count < 1 _
                            OrElse Not AssignedBookings.Contains(d.SolutionDetailBookControl)) _
                        Order By d.SolutionDetailBookControl _
                        Select New DTO.tblSolutionDetail With {.SolutionDetailBookControl = d.SolutionDetailBookControl _
                        , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                        , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                        , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                        , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                        , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                        , .SolutionDetailCom = d.SolutionDetailCom _
                        , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                        , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                        , .SolutionDetailCompNumber = If(d.SolutionDetailCompNumber.HasValue, d.SolutionDetailCompNumber, 0) _
                        , .SolutionDetailCompName = d.SolutionDetailCompName _
                        , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                        , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                        , .SolutionDetailODControl = d.SolutionDetailODControl _
                        , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                        , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                        , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                        , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                        , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                        , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                        , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                        , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                        , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                        , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                        , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                        , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                        , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                        , .SolutionDetailDestName = d.SolutionDetailDestName _
                        , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                        , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                        , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                        , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                        , .SolutionDetailDestState = d.SolutionDetailDestState _
                        , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                        , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                        , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                        , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                        , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                        , .SolutionDetailTotalCases = If(d.SolutionDetailTotalCases.HasValue, d.SolutionDetailTotalCases.Value, 0) _
                        , .SolutionDetailTotalWgt = If(d.SolutionDetailTotalWgt.HasValue, d.SolutionDetailTotalWgt.Value, 0) _
                        , .SolutionDetailTotalPL = If(d.SolutionDetailTotalPL.HasValue, d.SolutionDetailTotalPL.Value, 0) _
                        , .SolutionDetailTotalCube = If(d.SolutionDetailTotalCube.HasValue, d.SolutionDetailTotalCube.Value, 0) _
                        , .SolutionDetailTotalPX = If(d.SolutionDetailTotalPX.HasValue, d.SolutionDetailTotalPX.Value, 0) _
                        , .SolutionDetailTotalBFC = If(d.SolutionDetailTotalBFC.HasValue, d.SolutionDetailTotalBFC.Value, 0) _
                        , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                        , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                        , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                        , .SolutionDetailStopNo = If(d.SolutionDetailStopNo.HasValue, d.SolutionDetailStopNo.Value, 0) _
                        , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                        , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                        , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                        , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                        , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                        , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                        , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                        , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                        , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                        , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                        , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                        , .SolutionDetailTransType = d.SolutionDetailTransType _
                        , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                        , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                        , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                        , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                        , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                        , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                        , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                        , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                        , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                        , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                        , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                        , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                        , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                        , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                        , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                        , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                        , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                        , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                        , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                        , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                        , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                        , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                        , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                        , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                        , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                        , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                        , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                        , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                        , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                        , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                        , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                        , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                        , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                        , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                        , .SolutionDetailInbound = d.SolutionDetailInbound _
                        , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                        , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                        , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                        , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                        , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                        , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray()}).FirstOrDefault
                    Else

                        NewBooking = ( _
                        From d In db.vNewBookingsForSolutions _
                        Where d.SolutionDetailBookControl >= UpperControl _
                        And _
                        (NatAccountNumber <> 0 OrElse (d.SolutionDetailCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionDetailCompControl)))) _
                        And _
                        (If(UseLoadDate, _
                                (d.SolutionDetailDateLoad >= FromDate And d.SolutionDetailDateLoad <= ToDate), _
                                (d.SolutionDetailDateRequired >= FromDate And d.SolutionDetailDateRequired <= ToDate) _
                            ) _
                        ) _
                        And _
                        (NatAccountNumber = 0 OrElse (d.SolutionDetailCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionDetailCompNatNumber)))) _
                        And _
                        (RouteTypeCode = 0 OrElse d.SolutionDetailRouteTypeCode = RouteTypeCode) _
                        Order By d.SolutionDetailBookControl _
                        Select New DTO.tblSolutionDetail With {.SolutionDetailBookControl = d.SolutionDetailBookControl _
                        , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                        , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                        , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                        , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                        , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                        , .SolutionDetailCom = d.SolutionDetailCom _
                        , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                        , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                        , .SolutionDetailCompNumber = If(d.SolutionDetailCompNumber.HasValue, d.SolutionDetailCompNumber, 0) _
                        , .SolutionDetailCompName = d.SolutionDetailCompName _
                        , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                        , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                        , .SolutionDetailODControl = d.SolutionDetailODControl _
                        , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                        , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                        , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                        , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                        , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                        , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                        , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                        , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                        , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                        , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                        , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                        , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                        , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                        , .SolutionDetailDestName = d.SolutionDetailDestName _
                        , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                        , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                        , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                        , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                        , .SolutionDetailDestState = d.SolutionDetailDestState _
                        , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                        , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                        , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                        , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                        , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                        , .SolutionDetailTotalCases = If(d.SolutionDetailTotalCases.HasValue, d.SolutionDetailTotalCases.Value, 0) _
                        , .SolutionDetailTotalWgt = If(d.SolutionDetailTotalWgt.HasValue, d.SolutionDetailTotalWgt.Value, 0) _
                        , .SolutionDetailTotalPL = If(d.SolutionDetailTotalPL.HasValue, d.SolutionDetailTotalPL.Value, 0) _
                        , .SolutionDetailTotalCube = If(d.SolutionDetailTotalCube.HasValue, d.SolutionDetailTotalCube.Value, 0) _
                        , .SolutionDetailTotalPX = If(d.SolutionDetailTotalPX.HasValue, d.SolutionDetailTotalPX.Value, 0) _
                        , .SolutionDetailTotalBFC = If(d.SolutionDetailTotalBFC.HasValue, d.SolutionDetailTotalBFC.Value, 0) _
                        , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                        , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                        , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                        , .SolutionDetailStopNo = If(d.SolutionDetailStopNo.HasValue, d.SolutionDetailStopNo.Value, 0) _
                        , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                        , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                        , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                        , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                        , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                        , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                        , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                        , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                        , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                        , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                        , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                        , .SolutionDetailTransType = d.SolutionDetailTransType _
                        , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                        , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                        , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                        , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                        , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                        , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                        , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                        , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                        , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                        , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                        , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                        , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                        , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                        , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                        , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                        , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                        , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                        , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                        , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                        , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                        , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                        , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                        , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                        , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                        , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                        , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                        , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                        , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                        , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                        , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                        , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                        , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                        , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                        , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                        , .SolutionDetailInbound = d.SolutionDetailInbound _
                        , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                        , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                        , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                        , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                        , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                        , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray()}).FirstOrDefault

                    End If

                Else

                    If SolutionControl <> 0 Then
                        Dim SolutionTrucks = From st In db.tblSolutionTrucks Where st.SolutionTruckSolutionControl = SolutionControl Select st.SolutionTruckControl
                        Dim AssignedBookings = From t In db.tblSolutionDetails Where SolutionTrucks.Contains(t.SolutionDetailSolutionTruckControl) Select t.SolutionDetailBookControl

                        NewBooking = ( _
                        From d In db.vNewBookingsForSolutions _
                        Where (NatAccountNumber <> 0 OrElse (d.SolutionDetailCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionDetailCompControl)))) _
                        And _
                        (If(UseLoadDate, _
                                (d.SolutionDetailDateLoad >= FromDate And d.SolutionDetailDateLoad <= ToDate), _
                                (d.SolutionDetailDateRequired >= FromDate And d.SolutionDetailDateRequired <= ToDate) _
                            ) _
                        ) _
                        And _
                        (NatAccountNumber = 0 OrElse (d.SolutionDetailCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionDetailCompNatNumber)))) _
                        And _
                        (RouteTypeCode = 0 OrElse d.SolutionDetailRouteTypeCode = RouteTypeCode) _
                        And _
                        (AssignedBookings Is Nothing _
                            OrElse AssignedBookings.Count < 1 _
                            OrElse Not AssignedBookings.Contains(d.SolutionDetailBookControl)) _
                        Order By d.SolutionDetailBookControl Descending _
                        Select New DTO.tblSolutionDetail With {.SolutionDetailBookControl = d.SolutionDetailBookControl _
                        , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                        , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                        , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                        , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                        , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                        , .SolutionDetailCom = d.SolutionDetailCom _
                        , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                        , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                        , .SolutionDetailCompNumber = If(d.SolutionDetailCompNumber.HasValue, d.SolutionDetailCompNumber, 0) _
                        , .SolutionDetailCompName = d.SolutionDetailCompName _
                        , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                        , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                        , .SolutionDetailODControl = d.SolutionDetailODControl _
                        , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                        , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                        , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                        , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                        , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                        , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                        , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                        , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                        , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                        , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                        , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                        , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                        , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                        , .SolutionDetailDestName = d.SolutionDetailDestName _
                        , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                        , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                        , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                        , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                        , .SolutionDetailDestState = d.SolutionDetailDestState _
                        , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                        , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                        , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                        , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                        , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                        , .SolutionDetailTotalCases = If(d.SolutionDetailTotalCases.HasValue, d.SolutionDetailTotalCases.Value, 0) _
                        , .SolutionDetailTotalWgt = If(d.SolutionDetailTotalWgt.HasValue, d.SolutionDetailTotalWgt.Value, 0) _
                        , .SolutionDetailTotalPL = If(d.SolutionDetailTotalPL.HasValue, d.SolutionDetailTotalPL.Value, 0) _
                        , .SolutionDetailTotalCube = If(d.SolutionDetailTotalCube.HasValue, d.SolutionDetailTotalCube.Value, 0) _
                        , .SolutionDetailTotalPX = If(d.SolutionDetailTotalPX.HasValue, d.SolutionDetailTotalPX.Value, 0) _
                        , .SolutionDetailTotalBFC = If(d.SolutionDetailTotalBFC.HasValue, d.SolutionDetailTotalBFC.Value, 0) _
                        , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                        , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                        , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                        , .SolutionDetailStopNo = If(d.SolutionDetailStopNo.HasValue, d.SolutionDetailStopNo.Value, 0) _
                        , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                        , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                        , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                        , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                        , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                        , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                        , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                        , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                        , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                        , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                        , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                        , .SolutionDetailTransType = d.SolutionDetailTransType _
                        , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                        , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                        , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                        , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                        , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                        , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                        , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                        , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                        , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                        , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                        , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                        , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                        , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                        , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                        , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                        , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                        , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                        , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                        , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                        , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                        , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                        , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                        , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                        , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                        , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                        , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                        , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                        , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                        , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                        , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                        , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                        , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                        , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                        , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                        , .SolutionDetailInbound = d.SolutionDetailInbound _
                        , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                        , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                        , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                        , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                        , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                        , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray()}).FirstOrDefault
                    Else

                        NewBooking = ( _
                        From d In db.vNewBookingsForSolutions _
                        Where (NatAccountNumber <> 0 OrElse (d.SolutionDetailCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionDetailCompControl)))) _
                        And _
                        (If(UseLoadDate, _
                                (d.SolutionDetailDateLoad >= FromDate And d.SolutionDetailDateLoad <= ToDate), _
                                (d.SolutionDetailDateRequired >= FromDate And d.SolutionDetailDateRequired <= ToDate) _
                            ) _
                        ) _
                        And _
                        (NatAccountNumber = 0 OrElse (d.SolutionDetailCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionDetailCompNatNumber)))) _
                        And _
                        (RouteTypeCode = 0 OrElse d.SolutionDetailRouteTypeCode = RouteTypeCode) _
                        Order By d.SolutionDetailBookControl Descending _
                        Select New DTO.tblSolutionDetail With {.SolutionDetailBookControl = d.SolutionDetailBookControl _
                        , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                        , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                        , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                        , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                        , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                        , .SolutionDetailCom = d.SolutionDetailCom _
                        , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                        , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                        , .SolutionDetailCompNumber = If(d.SolutionDetailCompNumber.HasValue, d.SolutionDetailCompNumber, 0) _
                        , .SolutionDetailCompName = d.SolutionDetailCompName _
                        , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                        , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                        , .SolutionDetailODControl = d.SolutionDetailODControl _
                        , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                        , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                        , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                        , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                        , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                        , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                        , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                        , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                        , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                        , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                        , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                        , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                        , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                        , .SolutionDetailDestName = d.SolutionDetailDestName _
                        , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                        , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                        , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                        , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                        , .SolutionDetailDestState = d.SolutionDetailDestState _
                        , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                        , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                        , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                        , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                        , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                        , .SolutionDetailTotalCases = If(d.SolutionDetailTotalCases.HasValue, d.SolutionDetailTotalCases.Value, 0) _
                        , .SolutionDetailTotalWgt = If(d.SolutionDetailTotalWgt.HasValue, d.SolutionDetailTotalWgt.Value, 0) _
                        , .SolutionDetailTotalPL = If(d.SolutionDetailTotalPL.HasValue, d.SolutionDetailTotalPL.Value, 0) _
                        , .SolutionDetailTotalCube = If(d.SolutionDetailTotalCube.HasValue, d.SolutionDetailTotalCube.Value, 0) _
                        , .SolutionDetailTotalPX = If(d.SolutionDetailTotalPX.HasValue, d.SolutionDetailTotalPX.Value, 0) _
                        , .SolutionDetailTotalBFC = If(d.SolutionDetailTotalBFC.HasValue, d.SolutionDetailTotalBFC.Value, 0) _
                        , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                        , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                        , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                        , .SolutionDetailStopNo = If(d.SolutionDetailStopNo.HasValue, d.SolutionDetailStopNo.Value, 0) _
                        , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                        , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                        , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                        , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                        , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                        , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                        , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                        , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                        , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                        , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                        , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                        , .SolutionDetailTransType = d.SolutionDetailTransType _
                        , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                        , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                        , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                        , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                        , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                        , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                        , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                        , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                        , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                        , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                        , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                        , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                        , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                        , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                        , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                        , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                        , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                        , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                        , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                        , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                        , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                        , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                        , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                        , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                        , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                        , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                        , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                        , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                        , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                        , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                        , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                        , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                        , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                        , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                        , .SolutionDetailInbound = d.SolutionDetailInbound _
                        , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                        , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                        , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                        , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                        , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                        , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray()}).FirstOrDefault

                    End If

                End If


                Return NewBooking

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetNewBookingFiltered(ByVal Control As Long) As DTO.tblSolutionDetail
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'Get the newest record that matches the provided criteria
                Dim NewBooking As DTO.tblSolutionDetail = ( _
                From d In db.vNewBookingsForSolutions _
                Where _
                    d.SolutionDetailBookControl = Control _
                Select New DTO.tblSolutionDetail With {.SolutionDetailBookControl = d.SolutionDetailBookControl _
                    , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                    , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                    , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                    , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                    , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                    , .SolutionDetailCom = d.SolutionDetailCom _
                    , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                    , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                    , .SolutionDetailCompNumber = If(d.SolutionDetailCompNumber.HasValue, d.SolutionDetailCompNumber, 0) _
                    , .SolutionDetailCompName = d.SolutionDetailCompName _
                    , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                    , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                    , .SolutionDetailODControl = d.SolutionDetailODControl _
                    , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                    , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                    , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                    , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                    , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                    , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                    , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                    , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                    , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                    , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                    , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                    , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                    , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                    , .SolutionDetailDestName = d.SolutionDetailDestName _
                    , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                    , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                    , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                    , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                    , .SolutionDetailDestState = d.SolutionDetailDestState _
                    , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                    , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                    , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                    , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                    , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                    , .SolutionDetailTotalCases = If(d.SolutionDetailTotalCases.HasValue, d.SolutionDetailTotalCases, 0) _
                    , .SolutionDetailTotalWgt = If(d.SolutionDetailTotalWgt.HasValue, d.SolutionDetailTotalWgt, 0) _
                    , .SolutionDetailTotalPL = If(d.SolutionDetailTotalPL.HasValue, d.SolutionDetailTotalPL, 0) _
                    , .SolutionDetailTotalCube = If(d.SolutionDetailTotalCube.HasValue, d.SolutionDetailTotalCube, 0) _
                    , .SolutionDetailTotalPX = If(d.SolutionDetailTotalPX.HasValue, d.SolutionDetailTotalPX, 0) _
                    , .SolutionDetailTotalBFC = If(d.SolutionDetailTotalBFC.HasValue, d.SolutionDetailTotalBFC, 0) _
                    , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                    , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                    , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                    , .SolutionDetailStopNo = If(d.SolutionDetailStopNo.HasValue, d.SolutionDetailStopNo, 0) _
                    , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                    , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                    , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                    , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                    , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                    , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                    , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                    , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                    , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                    , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                    , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                    , .SolutionDetailTransType = d.SolutionDetailTransType _
                    , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                    , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                    , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                    , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                    , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                    , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                    , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                    , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                    , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                    , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                    , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                    , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                    , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                    , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                    , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                    , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                    , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                    , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                    , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                    , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                    , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                    , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                    , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                    , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                    , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                    , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                    , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                    , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                    , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                    , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                    , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                    , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                    , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                    , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                    , .SolutionDetailInbound = d.SolutionDetailInbound _
                    , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                    , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                    , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                    , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                    , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                    , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray()}).First


                Return NewBooking

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetNewBookingsFiltered(ByVal Filter As DTO.LoadPlanningTruckDataFilter) As DTO.tblSolutionDetail()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                Filter.StartDateFilter = DTran.formatStartDateFilter(Filter.StartDateFilter)
                Filter.StopDateFilter = DTran.formatEndDateFilter(Filter.StopDateFilter)
                'For this release the comp control number is requried and must be provided by the caller so we do not need to apply company level restrictions
                'Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                'Dim oSecureNat = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName And s.CompNatNumber <> 0 Select s.CompNatNumber
                Dim OrigStates As New List(Of String)
                Dim blnUseOrigStateFilter As Boolean = False
                Dim DestStates As New List(Of String)
                Dim blnUseDestStateFilter As Boolean = False
                populateStateListsFromFilter(Filter, OrigStates, blnUseOrigStateFilter, DestStates, blnUseDestStateFilter)

                Dim intRecordCount As Integer = 0
                Dim intPageCount As Integer = 1
                'count the record

                'Try
                '    Dim qNewBookings = From d In db.vNewBookingsForSolutions _
                '        Where (NatAccountNumber <> 0 OrElse (d.SolutionDetailCompControl = CompanyControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionDetailCompControl)))) _
                '        And _
                '        (If(UseLoadDate, _
                '                (d.SolutionDetailDateLoad >= FromDate And d.SolutionDetailDateLoad < ToDate.AddDays(1)), _
                '                (d.SolutionDetailDateRequired >= FromDate And d.SolutionDetailDateRequired < ToDate.AddDays(1)) _
                '            ) _
                '        ) _
                '        And _
                '        (NatAccountNumber = 0 OrElse (d.SolutionDetailCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionDetailCompNatNumber)))) _
                '        And _
                '        (RouteTypeCode = 0 OrElse d.SolutionDetailRouteTypeCode = RouteTypeCode) Select d.SolutionDetailPOHdrControl
                '    If Not qNewBookings Is Nothing Then
                '        intRecordCount = qNewBookings.Count
                '    End If
                'Catch ex As Exception
                '    'ignore any record count errors when counting the available new bookings
                'End Try
                'db.Log = New DebugTextWriter
                Try
                    Dim qNewBookings = (From d In db.vNewBookingsForSolutions _
                          Where _
                        d.SolutionDetailCompControl = Filter.CompControlFilter _
                        And If(Filter.UseLoadDateFilter = True, _
                               If(d.SolutionDetailDateLoad.HasValue, d.SolutionDetailDateLoad.Value >= Filter.StartDateFilter, False) And If(d.SolutionDetailDateLoad.HasValue, d.SolutionDetailDateLoad.Value <= Filter.StopDateFilter, False), _
                               If(d.SolutionDetailDateRequired.HasValue, d.SolutionDetailDateRequired.Value >= Filter.StartDateFilter, False) And If(d.SolutionDetailDateRequired.HasValue, d.SolutionDetailDateRequired.Value <= Filter.StopDateFilter, False)) _
                   And (d.SolutionDetailOrigZip.Trim >= If(Filter.OrigStartZipFilter = String.Empty, "0", Filter.OrigStartZipFilter)) _
                   And (d.SolutionDetailOrigZip.Trim <= If(Filter.OrigStopZipFilter = String.Empty, "9999999999", Filter.OrigStopZipFilter)) _
                   And (d.SolutionDetailDestZip.Trim >= If(Filter.DestStartZipFilter = String.Empty, "0", Filter.DestStartZipFilter)) _
                   And (d.SolutionDetailDestZip.Trim <= If(Filter.DestStopZipFilter = String.Empty, "9999999999", Filter.DestStopZipFilter)) _
                   And If(Filter.OrigCityFilter.Trim = String.Empty, True, (d.SolutionDetailOrigCity.Trim.ToUpper = Filter.OrigCityFilter.Trim.ToUpper)) _
                   And If(Filter.DestCityFilter.Trim = String.Empty, True, (d.SolutionDetailDestCity.Trim.ToUpper = Filter.DestCityFilter.Trim.ToUpper)) _
                   And (blnUseOrigStateFilter = False _
                         OrElse (OrigStates.Contains(d.SolutionDetailOrigState))) _
                   And (blnUseDestStateFilter = False _
                         OrElse (DestStates.Contains(d.SolutionDetailDestState))) _
                   And ((Filter.BookTransTypeFilter.Trim Is Nothing Or Filter.BookTransTypeFilter.Trim Is String.Empty) _
                         OrElse d.SolutionDetailTransType.ToUpper = Filter.BookTransTypeFilter.ToUpper) _
                  Select d.SolutionDetailPOHdrControl).ToArray()


                    If Not qNewBookings Is Nothing Then intRecordCount = qNewBookings.Count
                Catch ex As Exception
                    'ignore any record count errors when counting the available new bookings
                End Try

                If Filter.PageSize < 1 Then Filter.PageSize = 1
                If intRecordCount < 1 Then intRecordCount = 1
                If Filter.Page < 1 Then Filter.Page = 1
                If intRecordCount > Filter.PageSize Then intPageCount = ((intRecordCount - 1) \ Filter.PageSize) + 1
                Dim intSkip As Integer = (Filter.Page - 1) * Filter.PageSize


                'Return all the booking records that match the criteria sorted by name
                Dim NewBookings() As DTO.tblSolutionDetail = ( _
                From d In db.vNewBookingsForSolutions _
                Where _
                        d.SolutionDetailCompControl = Filter.CompControlFilter _
                        And If(Filter.UseLoadDateFilter = True, _
                               If(d.SolutionDetailDateLoad.HasValue, d.SolutionDetailDateLoad.Value >= Filter.StartDateFilter, False) And If(d.SolutionDetailDateLoad.HasValue, d.SolutionDetailDateLoad.Value <= Filter.StopDateFilter, False), _
                               If(d.SolutionDetailDateRequired.HasValue, d.SolutionDetailDateRequired.Value >= Filter.StartDateFilter, False) And If(d.SolutionDetailDateRequired.HasValue, d.SolutionDetailDateRequired.Value <= Filter.StopDateFilter, False)) _
                   And (d.SolutionDetailOrigZip.Trim >= If(Filter.OrigStartZipFilter = String.Empty, "0", Filter.OrigStartZipFilter)) _
                   And (d.SolutionDetailOrigZip.Trim <= If(Filter.OrigStopZipFilter = String.Empty, "9999999999", Filter.OrigStopZipFilter)) _
                   And (d.SolutionDetailDestZip.Trim >= If(Filter.DestStartZipFilter = String.Empty, "0", Filter.DestStartZipFilter)) _
                   And (d.SolutionDetailDestZip.Trim <= If(Filter.DestStopZipFilter = String.Empty, "9999999999", Filter.DestStopZipFilter)) _
                   And If(Filter.OrigCityFilter.Trim = String.Empty, True, (d.SolutionDetailOrigCity.Trim.ToUpper = Filter.OrigCityFilter.Trim.ToUpper)) _
                   And If(Filter.DestCityFilter.Trim = String.Empty, True, (d.SolutionDetailDestCity.Trim.ToUpper = Filter.DestCityFilter.Trim.ToUpper)) _
                   And (blnUseOrigStateFilter = False _
                         OrElse (OrigStates.Contains(d.SolutionDetailOrigState))) _
                   And (blnUseDestStateFilter = False _
                         OrElse (DestStates.Contains(d.SolutionDetailDestState))) _
                   And ((Filter.BookTransTypeFilter.Trim Is Nothing Or Filter.BookTransTypeFilter.Trim Is String.Empty) _
                         OrElse d.SolutionDetailTransType.ToUpper = Filter.BookTransTypeFilter.ToUpper) _
                Order By d.SolutionDetailBookControl Descending _
                Select New DTO.tblSolutionDetail With {.SolutionDetailBookControl = d.SolutionDetailBookControl _
                                                , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                                                , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                                                , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                                                , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                                                , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                                                , .SolutionDetailCom = d.SolutionDetailCom _
                                                , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                                                , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                                                , .SolutionDetailCompNumber = If(d.SolutionDetailCompNumber.HasValue, d.SolutionDetailCompNumber.Value, 0) _
                                                , .SolutionDetailCompName = d.SolutionDetailCompName _
                                                , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                                                , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                                                , .SolutionDetailODControl = d.SolutionDetailODControl _
                                                , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                                                , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                                                , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                                                , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                                                , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                                                , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                                                , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                                                , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                                                , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                                                , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                                                , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                                                , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                                                , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                                                , .SolutionDetailDestName = d.SolutionDetailDestName _
                                                , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                                                , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                                                , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                                                , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                                                , .SolutionDetailDestState = d.SolutionDetailDestState _
                                                , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                                                , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                                                , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                                                , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                                                , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                                                , .SolutionDetailTotalCases = If(d.SolutionDetailTotalCases.HasValue, d.SolutionDetailTotalCases.Value, 0) _
                                                , .SolutionDetailTotalWgt = If(d.SolutionDetailTotalWgt.HasValue, d.SolutionDetailTotalWgt.Value, 0) _
                                                , .SolutionDetailTotalPL = If(d.SolutionDetailTotalPL.HasValue, d.SolutionDetailTotalPL.Value, 0) _
                                                , .SolutionDetailTotalCube = If(d.SolutionDetailTotalCube.HasValue, d.SolutionDetailTotalCube.Value, 0) _
                                                , .SolutionDetailTotalPX = If(d.SolutionDetailTotalPX.HasValue, d.SolutionDetailTotalPX.Value, 0) _
                                                , .SolutionDetailTotalBFC = If(d.SolutionDetailTotalBFC.HasValue, d.SolutionDetailTotalBFC.Value, 0) _
                                                , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                                                , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                                                , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                                                , .SolutionDetailStopNo = If(d.SolutionDetailStopNo.HasValue, d.SolutionDetailStopNo.Value, 0) _
                                                , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                                                , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                                                , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                                                , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                                                , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                                                , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                                                , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                                                , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                                                , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                                                , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                                                , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                                                , .SolutionDetailTransType = d.SolutionDetailTransType _
                                                , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                                                , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                                                , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                                                , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                                                , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                                                , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                                                , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                                                , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                                                , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                                                , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                                                , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                                                , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                                                , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                                                , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                                                , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                                                , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                                                , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                                                , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                                                , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                                                , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                                                , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                                                , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                                                , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                                                , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                                                , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                                                , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                                                , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                                                , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                                                , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                                                , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                                                , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                                                , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                                                , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                                                , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                                                , .SolutionDetailInbound = d.SolutionDetailInbound _
                                                , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                                                , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                                                , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                                                , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                                                , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                                                , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray() _
                                                , .Page = Filter.Page _
                                                , .Pages = intPageCount _
                                                , .PageSize = Filter.PageSize}).Skip(intSkip).Take(Filter.PageSize).ToArray()

                Return NewBookings

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                'Utilities.SaveAppError(ex.Message, Me.Parameters)
                'Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
                'its ok if there is no data
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetNewBookingFilteredByPro(ByVal BookProNumber As String) As DTO.tblSolutionDetail
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'db.Log = New DebugTextWriter
                'Get the newest record that matches the provided criteria
                Dim NewBooking As DTO.tblSolutionDetail = ( _
                From d In db.vNewBookingsForSolutions _
                Where _
                    d.SolutionDetailProNumber = BookProNumber _
                Select New DTO.tblSolutionDetail With {.SolutionDetailBookControl = d.SolutionDetailBookControl _
                    , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                    , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                    , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                    , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                    , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                    , .SolutionDetailCom = d.SolutionDetailCom _
                    , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                    , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                    , .SolutionDetailCompNumber = If(d.SolutionDetailCompNumber.HasValue, d.SolutionDetailCompNumber, 0) _
                    , .SolutionDetailCompName = d.SolutionDetailCompName _
                    , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                    , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                    , .SolutionDetailODControl = d.SolutionDetailODControl _
                    , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                    , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                    , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                    , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                    , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                    , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                    , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                    , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                    , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                    , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                    , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                    , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                    , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                    , .SolutionDetailDestName = d.SolutionDetailDestName _
                    , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                    , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                    , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                    , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                    , .SolutionDetailDestState = d.SolutionDetailDestState _
                    , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                    , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                    , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                    , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                    , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                    , .SolutionDetailTotalCases = If(d.SolutionDetailTotalCases.HasValue, d.SolutionDetailTotalCases, 0) _
                    , .SolutionDetailTotalWgt = If(d.SolutionDetailTotalWgt.HasValue, d.SolutionDetailTotalWgt, 0) _
                    , .SolutionDetailTotalPL = If(d.SolutionDetailTotalPL.HasValue, d.SolutionDetailTotalPL, 0) _
                    , .SolutionDetailTotalCube = If(d.SolutionDetailTotalCube.HasValue, d.SolutionDetailTotalCube, 0) _
                    , .SolutionDetailTotalPX = If(d.SolutionDetailTotalPX.HasValue, d.SolutionDetailTotalPX, 0) _
                    , .SolutionDetailTotalBFC = If(d.SolutionDetailTotalBFC.HasValue, d.SolutionDetailTotalBFC, 0) _
                    , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                    , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                    , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                    , .SolutionDetailStopNo = If(d.SolutionDetailStopNo.HasValue, d.SolutionDetailStopNo, 0) _
                    , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                    , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                    , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                    , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                    , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                    , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                    , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                    , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                    , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                    , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                    , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                    , .SolutionDetailTransType = d.SolutionDetailTransType _
                    , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                    , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                    , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                    , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                    , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                    , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                    , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                    , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                    , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                    , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                    , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                    , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                    , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                    , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                    , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                    , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                    , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                    , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                    , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                    , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                    , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                    , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                    , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                    , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                    , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                    , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                    , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                    , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                    , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                    , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                    , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                    , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                    , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                    , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                    , .SolutionDetailInbound = d.SolutionDetailInbound _
                    , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                    , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                    , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                    , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                    , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                    , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray()}).FirstOrDefault


                Return NewBooking

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

#End Region

#Region "Protected Functions"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Return Nothing
    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Return Nothing
    End Function

    Protected Overrides Sub ValidateNewRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'We do not allow records to be added 
        Utilities.SaveAppError("Cannot add data.  Records cannot be created using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))

    End Sub

    Protected Overrides Sub ValidateUpdatedRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'We do not allow records to be updated 
        Utilities.SaveAppError("Cannot save data.  Records cannot be modified using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))

    End Sub

    Protected Overrides Sub ValidateDeletedRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'We do not allow Route Type records to be deleted 
        Utilities.SaveAppError("Cannot delete data.  Records cannot be deleted using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))

    End Sub

#End Region

End Class

Public Class NGLNewPOsForSolutionData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.vNewPOsForSolutions
        Me.LinqDB = db
    End Sub

#End Region

#Region " Properties "

    Protected Overrides Property LinqTable() As Object
        Get
            Dim db As New NGLMasBookDataContext(ConnectionString)
            Me.LinqTable = db.vNewPOsForSolutions
            Me.LinqDB = db
            Return _LinqTable
        End Get
        Set(ByVal value As Object)
            _LinqTable = value
        End Set
    End Property

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GetNewPOFiltered(Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return Nothing 'Cannot execuete without parameters
    End Function

    ''' <summary>
    ''' The LowerControl parameter allows for a starting control number to be provided.
    ''' The FKControl parameter is a reference to the Comp Control Number.  If a NatAccountNumber is provided the 
    ''' FKcontrol is ignored
    ''' </summary>
    ''' <param name="LowerControl"></param>
    ''' <param name="FKControl"></param>
    ''' <param name="FromDate"></param>
    ''' <param name="ToDate"></param>
    ''' <param name="UseLoadDate"></param>
    ''' <param name="NatAccountNumber"></param>
    ''' <param name="RouteTypeCode"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overloads Function GetFirstRecord(ByVal LowerControl As Long, _
                                             ByVal FKControl As Long, _
                                             ByVal FromDate As Date, _
                                             ByVal ToDate As Date, _
                                             ByVal UseLoadDate As Boolean, _
                                             ByVal NatAccountNumber As Integer, _
                                             ByVal RouteTypeCode As Integer) As DataTransferObjects.DTOBaseClass

        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                FromDate = DTran.formatStartDateFilter(FromDate)
                ToDate = DTran.formatEndDateFilter(ToDate)
                'For the test we use the book table and the bookload data is ignored.  
                'The final query will need to use a view that selects the book load data because
                'We need the temperature.
                Dim NewPO As New DTO.tblSolutionDetail
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                Dim oSecureNat = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName And s.CompNatNumber <> 0 Select s.CompNatNumber

                NewPO = ( _
                From d In db.vNewPOsForSolutions
                Where (LowerControl = 0 OrElse d.SolutionDetailPOHdrControl >= LowerControl) _
                And _
                (NatAccountNumber <> 0 OrElse (d.SolutionDetailCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionDetailCompControl)))) _
                And _
                (If(UseLoadDate, _
                        (d.SolutionDetailDateLoad >= FromDate And d.SolutionDetailDateLoad <= ToDate), _
                        (d.SolutionDetailDateRequired >= FromDate And d.SolutionDetailDateRequired <= ToDate) _
                    ) _
                ) _
                And _
                (NatAccountNumber = 0 OrElse (d.SolutionDetailCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionDetailCompNatNumber)))) _
                And _
                (RouteTypeCode = 0 OrElse d.SolutionDetailRouteTypeCode = RouteTypeCode) _
                Order By d.SolutionDetailPOHdrControl _
                Select selectDTOData(d, db)).FirstOrDefault

                Return NewPO

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary>
    ''' The CurrentControl is the seed control value.
    ''' The FKControl parameter is a reference to the Comp Control Number.  If a NatAccountNumber is provided the 
    ''' FKcontrol is ignored.
    ''' </summary>
    ''' <param name="CurrentControl"></param>
    ''' <param name="FKControl"></param>
    ''' <param name="FromDate"></param>
    ''' <param name="ToDate"></param>
    ''' <param name="UseLoadDate"></param>
    ''' <param name="NatAccountNumber"></param>
    ''' <param name="RouteTypeCode"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overloads Function GetPreviousRecord(ByVal CurrentControl As Long, _
                                                 ByVal FKControl As Long, _
                                                 ByVal FromDate As Date, _
                                                 ByVal ToDate As Date, _
                                                 ByVal UseLoadDate As Boolean, _
                                                 ByVal NatAccountNumber As Integer, _
                                                 ByVal RouteTypeCode As Integer) As DataTransferObjects.DTOBaseClass
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                FromDate = DTran.formatStartDateFilter(FromDate)
                ToDate = DTran.formatEndDateFilter(ToDate)

                Dim NewPO As New DTO.tblSolutionDetail
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                Dim oSecureNat = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName And s.CompNatNumber <> 0 Select s.CompNatNumber


                NewPO = ( _
                From d In db.vNewPOsForSolutions _
                Where d.SolutionDetailPOHdrControl < CurrentControl _
                And _
                (NatAccountNumber <> 0 OrElse (d.SolutionDetailCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionDetailCompControl)))) _
                And _
                (If(UseLoadDate, _
                        (d.SolutionDetailDateLoad >= FromDate And d.SolutionDetailDateLoad <= ToDate), _
                        (d.SolutionDetailDateRequired >= FromDate And d.SolutionDetailDateRequired <= ToDate) _
                    ) _
                ) _
                And _
                (NatAccountNumber = 0 OrElse (d.SolutionDetailCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionDetailCompNatNumber)))) _
                And _
                (RouteTypeCode = 0 OrElse d.SolutionDetailRouteTypeCode = RouteTypeCode) _
                Order By d.SolutionDetailPOHdrControl Descending _
                Select selectDTOData(d, db)).FirstOrDefault

                Return NewPO

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary>
    ''' The CurrentControl is the seed control value.
    ''' The FKControl parameter is a reference to the Comp Control Number.  If a NatAccountNumber is provided the 
    ''' FKcontrol is ignored.
    ''' </summary>
    ''' <param name="CurrentControl"></param>
    ''' <param name="FKControl"></param>
    ''' <param name="FromDate"></param>
    ''' <param name="ToDate"></param>
    ''' <param name="UseLoadDate"></param>
    ''' <param name="NatAccountNumber"></param>
    ''' <param name="RouteTypeCode"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overloads Function GetNextRecord(ByVal CurrentControl As Long, _
                                            ByVal FKControl As Long, _
                                            ByVal FromDate As Date, _
                                            ByVal ToDate As Date, _
                                            ByVal UseLoadDate As Boolean, _
                                            ByVal NatAccountNumber As Integer, _
                                            ByVal RouteTypeCode As Integer) As DataTransferObjects.DTOBaseClass
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                Dim NewPO As New DTO.tblSolutionDetail
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                Dim oSecureNat = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName And s.CompNatNumber <> 0 Select s.CompNatNumber


                NewPO = ( _
                   From d In db.vNewPOsForSolutions _
                   Where d.SolutionDetailPOHdrControl > CurrentControl _
                   And _
                   (NatAccountNumber <> 0 OrElse (d.SolutionDetailCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionDetailCompControl)))) _
                    And _
                    (If(UseLoadDate, _
                            (d.SolutionDetailDateLoad >= FromDate And d.SolutionDetailDateLoad < ToDate.AddDays(1)), _
                            (d.SolutionDetailDateRequired >= FromDate And d.SolutionDetailDateRequired < ToDate.AddDays(1)) _
                        ) _
                    ) _
                    And _
                    (NatAccountNumber = 0 OrElse (d.SolutionDetailCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionDetailCompNatNumber)))) _
                    And _
                    (RouteTypeCode = 0 OrElse d.SolutionDetailRouteTypeCode = RouteTypeCode) _
                   Order By d.SolutionDetailPOHdrControl _
                   Select selectDTOData(d, db)).FirstOrDefault

                Return NewPO

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary>
    ''' The UpperControl parameter allows for a starting control number to be provided.
    ''' The FKControl parameter is a reference to the Comp Control Number.  If a NatAccountNumber is provided the 
    ''' FKcontrol is ignored
    ''' </summary>
    ''' <param name="UpperControl"></param>
    ''' <param name="FKControl"></param>
    ''' <param name="FromDate"></param>
    ''' <param name="ToDate"></param>
    ''' <param name="UseLoadDate"></param>
    ''' <param name="NatAccountNumber"></param>
    ''' <param name="RouteTypeCode"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overloads Function GetLastRecord(ByVal UpperControl As Long, _
                                            ByVal FKControl As Long, _
                                            ByVal FromDate As Date, _
                                            ByVal ToDate As Date, _
                                            ByVal UseLoadDate As Boolean, _
                                            ByVal NatAccountNumber As Integer, _
                                            ByVal RouteTypeCode As Integer) As DataTransferObjects.DTOBaseClass
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim NewPO As New DTO.tblSolutionDetail
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                Dim oSecureNat = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName And s.CompNatNumber <> 0 Select s.CompNatNumber

                If UpperControl <> 0 Then
                    NewPO = ( _
                    From d In db.vNewPOsForSolutions _
                    Where d.SolutionDetailPOHdrControl >= UpperControl _
                    And _
                    (NatAccountNumber <> 0 OrElse (d.SolutionDetailCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionDetailCompControl)))) _
                    And _
                    (If(UseLoadDate, _
                            (d.SolutionDetailDateLoad >= FromDate And d.SolutionDetailDateLoad < ToDate.AddDays(1)), _
                            (d.SolutionDetailDateRequired >= FromDate And d.SolutionDetailDateRequired < ToDate.AddDays(1)) _
                        ) _
                    ) _
                    And _
                    (NatAccountNumber = 0 OrElse (d.SolutionDetailCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionDetailCompNatNumber)))) _
                    And _
                    (RouteTypeCode = 0 OrElse d.SolutionDetailRouteTypeCode = RouteTypeCode) _
                    Order By d.SolutionDetailPOHdrControl _
                    Select selectDTOData(d, db)).FirstOrDefault

                Else
                    NewPO = ( _
                    From d In db.vNewPOsForSolutions _
                    Where _
                    (NatAccountNumber <> 0 OrElse (d.SolutionDetailCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionDetailCompControl)))) _
                    And _
                    (If(UseLoadDate, _
                            (d.SolutionDetailDateLoad >= FromDate And d.SolutionDetailDateLoad < ToDate.AddDays(1)), _
                            (d.SolutionDetailDateRequired >= FromDate And d.SolutionDetailDateRequired < ToDate.AddDays(1)) _
                        ) _
                    ) _
                    And _
                    (NatAccountNumber = 0 OrElse (d.SolutionDetailCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionDetailCompNatNumber)))) _
                    And _
                    (RouteTypeCode = 0 OrElse d.SolutionDetailRouteTypeCode = RouteTypeCode) _
                    Order By d.SolutionDetailPOHdrControl Descending _
                    Select selectDTOData(d, db)).FirstOrDefault

                End If

                Return NewPO

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetNewPOFiltered(ByVal Control As Long) As DTO.tblSolutionDetail
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Get the newest record that matches the provided criteria

                Dim NewPO As DTO.tblSolutionDetail = ( _
                From d In db.vNewPOsForSolutions _
                Where _
                    d.SolutionDetailPOHdrControl = Control _
                Select selectDTOData(d, db)).First


                Return NewPO

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetNewPOsFiltered(ByVal Filter As DTO.LoadPlanningTruckDataFilter) As DTO.tblSolutionDetail()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                Filter.StartDateFilter = DTran.formatStartDateFilter(Filter.StartDateFilter)
                Filter.StopDateFilter = DTran.formatEndDateFilter(Filter.StopDateFilter)
                'For this release the comp control number is requried and must be provided by the caller so we do not need to apply company level restrictions
                'Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                'Dim oSecureNat = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName And s.CompNatNumber <> 0 Select s.CompNatNumber
                Dim OrigStates As New List(Of String)
                Dim blnUseOrigStateFilter As Boolean = False
                Dim DestStates As New List(Of String)
                Dim blnUseDestStateFilter As Boolean = False
                populateStateListsFromFilter(Filter, OrigStates, blnUseOrigStateFilter, DestStates, blnUseDestStateFilter)

                Dim intRecordCount As Integer = 0
                Dim intPageCount As Integer = 1
                'count the record

                'Dim qNewPOs = From d In db.vNewPOsForSolutions _
                '    Where (NatAccountNumber <> 0 OrElse (d.SolutionDetailCompControl = CompanyControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionDetailCompControl)))) _
                '    And _
                '    (If(UseLoadDate, _
                '            (d.SolutionDetailDateLoad >= FromDate And d.SolutionDetailDateLoad < ToDate.AddDays(1)), _
                '            (d.SolutionDetailDateRequired >= FromDate And d.SolutionDetailDateRequired < ToDate.AddDays(1)) _
                '        ) _
                '    ) _
                '    And _
                '    (NatAccountNumber = 0 OrElse (d.SolutionDetailCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionDetailCompNatNumber)))) _
                '    And _
                '    (RouteTypeCode = 0 OrElse d.SolutionDetailRouteTypeCode = RouteTypeCode) Select d.SolutionDetailPOHdrControl


                Try
                    Dim qNewPOs = (From d In db.vNewPOsForSolutions _
                        Where _
                        d.SolutionDetailCompControl = Filter.CompControlFilter _
                        And If(Filter.UseLoadDateFilter = True, _
                               If(d.SolutionDetailDateLoad.HasValue, d.SolutionDetailDateLoad.Value >= Filter.StartDateFilter, False) And If(d.SolutionDetailDateLoad.HasValue, d.SolutionDetailDateLoad.Value <= Filter.StopDateFilter, False), _
                               If(d.SolutionDetailDateRequired.HasValue, d.SolutionDetailDateRequired.Value >= Filter.StartDateFilter, False) And If(d.SolutionDetailDateRequired.HasValue, d.SolutionDetailDateRequired.Value <= Filter.StopDateFilter, False)) _
                   And (d.SolutionDetailOrigZip.Trim >= If(Filter.OrigStartZipFilter = String.Empty, "0", Filter.OrigStartZipFilter)) _
                   And (d.SolutionDetailOrigZip.Trim <= If(Filter.OrigStopZipFilter = String.Empty, "9999999999", Filter.OrigStopZipFilter)) _
                   And (d.SolutionDetailDestZip.Trim >= If(Filter.DestStartZipFilter = String.Empty, "0", Filter.DestStartZipFilter)) _
                   And (d.SolutionDetailDestZip.Trim <= If(Filter.DestStopZipFilter = String.Empty, "9999999999", Filter.DestStopZipFilter)) _
                   And If(Filter.OrigCityFilter.Trim = String.Empty, True, (d.SolutionDetailOrigCity.Trim.ToUpper = Filter.OrigCityFilter.Trim.ToUpper)) _
                   And If(Filter.DestCityFilter.Trim = String.Empty, True, (d.SolutionDetailDestCity.Trim.ToUpper = Filter.DestCityFilter.Trim.ToUpper)) _
                   And (blnUseOrigStateFilter = False _
                         OrElse (OrigStates.Contains(d.SolutionDetailOrigState))) _
                   And (blnUseDestStateFilter = False _
                         OrElse (DestStates.Contains(d.SolutionDetailDestState))) _
                   And ((Filter.BookTransTypeFilter.Trim Is Nothing Or Filter.BookTransTypeFilter.Trim Is String.Empty) _
                         OrElse d.SolutionDetailTransType.ToUpper = Filter.BookTransTypeFilter.ToUpper) _
                  Select d.SolutionDetailPOHdrControl).ToArray()


                    If Not qNewPOs Is Nothing AndAlso qNewPOs.Count > 0 Then intRecordCount = qNewPOs.Count
                Catch ex As Exception
                    'ignore any record count errors when counting the available new bookings
                End Try


                If Filter.PageSize < 1 Then Filter.PageSize = 1
                If intRecordCount < 1 Then intRecordCount = 1
                If Filter.Page < 1 Then Filter.Page = 1
                If intRecordCount > Filter.PageSize Then intPageCount = ((intRecordCount - 1) \ Filter.PageSize) + 1
                Dim intSkip As Integer = (Filter.Page - 1) * Filter.PageSize

                'Return all the pohdr records that match the criteria sorted by name
                Dim NewPOs() As DTO.tblSolutionDetail = ( _
                From d In db.vNewPOsForSolutions _
                Where _
                d.SolutionDetailCompControl = Filter.CompControlFilter _
                 And If(Filter.UseLoadDateFilter = True, _
                               If(d.SolutionDetailDateLoad.HasValue, d.SolutionDetailDateLoad.Value >= Filter.StartDateFilter, False) And If(d.SolutionDetailDateLoad.HasValue, d.SolutionDetailDateLoad.Value <= Filter.StopDateFilter, False), _
                               If(d.SolutionDetailDateRequired.HasValue, d.SolutionDetailDateRequired.Value >= Filter.StartDateFilter, False) And If(d.SolutionDetailDateRequired.HasValue, d.SolutionDetailDateRequired.Value <= Filter.StopDateFilter, False)) _
                   And (d.SolutionDetailOrigZip.Trim >= If(Filter.OrigStartZipFilter = String.Empty, "0", Filter.OrigStartZipFilter)) _
                   And (d.SolutionDetailOrigZip.Trim <= If(Filter.OrigStopZipFilter = String.Empty, "9999999999", Filter.OrigStopZipFilter)) _
                   And (d.SolutionDetailDestZip.Trim >= If(Filter.DestStartZipFilter = String.Empty, "0", Filter.DestStartZipFilter)) _
                   And (d.SolutionDetailDestZip.Trim <= If(Filter.DestStopZipFilter = String.Empty, "9999999999", Filter.DestStopZipFilter)) _
                   And If(Filter.OrigCityFilter.Trim = String.Empty, True, (d.SolutionDetailOrigCity.Trim.ToUpper = Filter.OrigCityFilter.Trim.ToUpper)) _
                   And If(Filter.DestCityFilter.Trim = String.Empty, True, (d.SolutionDetailDestCity.Trim.ToUpper = Filter.DestCityFilter.Trim.ToUpper)) _
                   And (blnUseOrigStateFilter = False _
                         OrElse (OrigStates.Contains(d.SolutionDetailOrigState))) _
                   And (blnUseDestStateFilter = False _
                         OrElse (DestStates.Contains(d.SolutionDetailDestState))) _
                   And ((Filter.BookTransTypeFilter.Trim Is Nothing Or Filter.BookTransTypeFilter.Trim Is String.Empty) _
                         OrElse d.SolutionDetailTransType.ToUpper = Filter.BookTransTypeFilter.ToUpper) _
                Order By d.SolutionDetailPOHdrControl Descending _
                Select selectDTOData(d, db, Filter.Page, intPageCount, Filter.PageSize)).Skip(intSkip).Take(Filter.PageSize).ToArray()

                Return NewPOs

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                'Utilities.SaveAppError(ex.Message, Me.Parameters)
                'Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))

                'it is ok when there is no data.
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Friend Function selectDTOData(ByVal d As LTS.vNewPOsForSolution, ByRef db As NGLMasBookDataContext, Optional page As Integer = 1, Optional pagecount As Integer = 1, Optional pagesize As Integer = 1000) As DTO.tblSolutionDetail
        Return New DTO.tblSolutionDetail With {.SolutionDetailPOHdrControl = d.SolutionDetailPOHdrControl _
                                                    , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                                                    , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                                                    , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                                                    , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                                                    , .SolutionDetailCom = d.SolutionDetailCom _
                                                    , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                                                    , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                                                    , .SolutionDetailCompNumber = If(d.SolutionDetailCompNumber.HasValue, d.SolutionDetailCompNumber.Value, 0) _
                                                    , .SolutionDetailCompName = d.SolutionDetailCompName _
                                                    , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                                                    , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                                                    , .SolutionDetailODControl = d.SolutionDetailODControl _
                                                    , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                                                    , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                                                    , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                                                    , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                                                    , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                                                    , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                                                    , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                                                    , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                                                    , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                                                    , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                                                    , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                                                    , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                                                    , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                                                    , .SolutionDetailDestName = d.SolutionDetailDestName _
                                                    , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                                                    , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                                                    , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                                                    , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                                                    , .SolutionDetailDestState = d.SolutionDetailDestState _
                                                    , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                                                    , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                                                    , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                                                    , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                                                    , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                                                    , .SolutionDetailTotalCases = If(d.SolutionDetailTotalCases.HasValue, d.SolutionDetailTotalCases.Value, 0) _
                                                    , .SolutionDetailTotalWgt = If(d.SolutionDetailTotalWgt.HasValue, d.SolutionDetailTotalWgt.Value, 0) _
                                                    , .SolutionDetailTotalPL = If(d.SolutionDetailTotalPL.HasValue, d.SolutionDetailTotalPL.Value, 0) _
                                                    , .SolutionDetailTotalCube = If(d.SolutionDetailTotalCube.HasValue, d.SolutionDetailTotalCube.Value, 0) _
                                                    , .SolutionDetailTotalPX = d.SolutionDetailTotalPX _
                                                    , .SolutionDetailTotalBFC = If(d.SolutionDetailTotalBFC.HasValue, d.SolutionDetailTotalBFC.Value, 0) _
                                                    , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                                                    , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                                                    , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                                                    , .SolutionDetailStopNo = d.SolutionDetailStopNo _
                                                    , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                                                    , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                                                    , .SolutionDetailTransType = d.SolutionDetailTransType _
                                                    , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                                                    , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                                                    , .SolutionDetailRouteTypeCode = If(d.SolutionDetailRouteTypeCode.HasValue, d.SolutionDetailRouteTypeCode.Value, 0) _
                                                    , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                                                    , .SolutionDetailInbound = d.SolutionDetailInbound _
                                                    , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                                                    , .SolutionDetailModDate = d.SolutionDetailModDate _
                                                    , .SolutionDetailModUser = d.SolutionDetailModUser _
                                                    , .SolutionDetailUpdated = New Byte() {} _
                                                    , .Page = page _
                                                    , .Pages = pagecount _
                                                    , .PageSize = pagesize}

    End Function
#End Region

#Region "Protected Functions"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Return Nothing
    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Return Nothing
    End Function

    Protected Overrides Sub ValidateNewRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'We do not allow records to be added 
        Utilities.SaveAppError("Cannot add data.  Records cannot be created using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))

    End Sub

    Protected Overrides Sub ValidateUpdatedRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'We do not allow records to be updated 
        Utilities.SaveAppError("Cannot save data.  Records cannot be modified using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))

    End Sub

    Protected Overrides Sub ValidateDeletedRecord(ByRef oDB As System.Data.Linq.DataContext, ByRef oData As DTO.DTOBaseClass)
        'We do not allow Route Type records to be deleted 
        Utilities.SaveAppError("Cannot delete data.  Records cannot be deleted using this interface!", Me.Parameters)
        Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_AccessDenied"}, New FaultReason("E_DataValidationFailure"))

    End Sub


#End Region

End Class

Public Class NGLtblSolutionData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.tblSolutions
        Me.LinqDB = db
    End Sub

#End Region

#Region " Properties "

    Protected Overrides Property LinqTable() As Object
        Get
            Dim db As New NGLMasBookDataContext(ConnectionString)
            Me.LinqTable = db.tblSolutions
            Me.LinqDB = db
            Return _LinqTable
        End Get
        Set(ByVal value As Object)
            _LinqTable = value
        End Set
    End Property

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GettblSolutionFiltered(Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return Nothing
    End Function

    ''' <summary>
    ''' The LowerControl parameter allows for a starting control number to be provided.
    ''' The FKControl parameter is a reference to the Comp Control Number.  If a NatAccountNumber is provided the 
    ''' FKcontrol is ignored
    ''' </summary>
    ''' <param name="LowerControl"></param>
    ''' <param name="FKControl"></param>
    ''' <param name="FromDate"></param>
    ''' <param name="ToDate"></param>
    ''' <param name="UseCreateDate"></param>
    ''' <param name="UseCommittedDate"></param>
    ''' <param name="UseArchivedDate"></param>
    ''' <param name="NatAccountNumber"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overloads Function GetFirstRecord(ByVal LowerControl As Long, _
                                             ByVal FKControl As Long, _
                                             ByVal FromDate As Date, _
                                             ByVal ToDate As Date, _
                                             ByVal UseCreateDate As Boolean, _
                                             ByVal UseCommittedDate As Boolean, _
                                             ByVal UseArchivedDate As Boolean, _
                                             ByVal NatAccountNumber As Integer) As DataTransferObjects.DTOBaseClass

        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                
                Dim tblSolution As New DTO.tblSolution
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                Dim oSecureNat = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName And s.CompNatNumber <> 0 Select s.CompNatNumber

                tblSolution = ( _
                From d In db.tblSolutions
                Where (LowerControl = 0 OrElse d.SolutionControl >= LowerControl) _
                And _
                (NatAccountNumber <> 0 OrElse (d.SolutionCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionCompControl)))) _
                And _
                (If(UseCreateDate Or UseCommittedDate Or UseArchivedDate, _
                    If(UseCreateDate, _
                        (d.SolutionCreateDate >= FromDate And d.SolutionCreateDate < ToDate.AddDays(1)), _
                        If(UseCommittedDate, _
                            (d.SolutionCommittedDate >= FromDate And d.SolutionCommittedDate < ToDate.AddDays(1)), _
                            (d.SolutionArchivedDate >= FromDate And d.SolutionArchivedDate < ToDate.AddDays(1)))), _
                    True
                    ) _
                ) _
                And _
                (NatAccountNumber = 0 OrElse (d.SolutionCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionCompNatNumber)))) _
                Order By d.SolutionControl _
                Select New DTO.tblSolution With {.SolutionControl = d.SolutionControl _
                                                    , .SolutionAttributeControl = d.SolutionAttributeControl _
                                                    , .SolutionAttributeTypeControl = d.SolutionAttributeTypeControl _
                                                    , .SolutionName = d.SolutionName _
                                                    , .SolutionDescription = d.SolutionDescription _
                                                    , .SolutionCompControl = d.SolutionCompControl _
                                                    , .SolutionCompNumber = d.SolutionCompNumber _
                                                    , .SolutionCompName = d.SolutionCompName _
                                                    , .SolutionCompNatNumber = d.SolutionCompNatNumber _
                                                    , .SolutionCompNatName = d.SolutionCompNatName _
                                                    , .SolutionCreateDate = d.SolutionCreateDate _
                                                    , .SolutionTotalCases = d.SolutionTotalCases _
                                                    , .SolutionTotalWgt = d.SolutionTotalWgt _
                                                    , .SolutionTotalPL = d.SolutionTotalPL _
                                                    , .SolutionTotalCube = d.SolutionTotalCube _
                                                    , .SolutionTotalPX = d.SolutionTotalPX _
                                                    , .SolutionTotalBFC = d.SolutionTotalBFC _
                                                    , .SolutionTotalOrders = d.SolutionTotalOrders _
                                                    , .SolutionTotalTLCost = d.SolutionTotalTLCost _
                                                    , .SolutionTotalMPCost = d.SolutionTotalMPCost _
                                                    , .SolutionTotalPoolCost = d.SolutionTotalPoolCost _
                                                    , .SolutionTotalLTLPoolCost = d.SolutionTotalLTLPoolCost _
                                                    , .SolutionTotalLTLCost = d.SolutionTotalLTLCost _
                                                    , .SolutionTotalCost = d.SolutionTotalCost _
                                                    , .SolutionTotalTrucks = d.SolutionTotalTrucks _
                                                    , .SolutionTotalMiles = d.SolutionTotalMiles _
                                                    , .SolutionCommitted = d.SolutionCommitted _
                                                    , .SolutionCommittedDate = d.SolutionCommittedDate _
                                                    , .SolutionArchived = d.SolutionArchived _
                                                    , .SolutionArchivedDate = d.SolutionArchivedDate _
                                                    , .SolutionModDate = d.SolutionModDate _
                                                    , .SolutionModUser = d.SolutionModUser _
                                                    , .SolutionUpdated = d.SolutionUpdated.ToArray()}).FirstOrDefault

                Return tblSolution

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary>
    ''' The CurrentControl is the seed control value.
    ''' The FKControl parameter is a reference to the Comp Control Number.  If a NatAccountNumber is provided the 
    ''' FKcontrol is ignored.
    ''' </summary>
    ''' <param name="CurrentControl"></param>
    ''' <param name="FKControl"></param>
    ''' <param name="FromDate"></param>
    ''' <param name="ToDate"></param>
    ''' <param name="UseCreateDate"></param>
    ''' <param name="UseCommittedDate"></param>
    ''' <param name="UseArchivedDate"></param>
    ''' <param name="NatAccountNumber"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overloads Function GetPreviousRecord(ByVal CurrentControl As Long, _
                                                 ByVal FKControl As Long, _
                                                 ByVal FromDate As Date, _
                                                 ByVal ToDate As Date, _
                                                 ByVal UseCreateDate As Boolean, _
                                                 ByVal UseCommittedDate As Boolean, _
                                                 ByVal UseArchivedDate As Boolean, _
                                                 ByVal NatAccountNumber As Integer) As DataTransferObjects.DTOBaseClass
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                Dim tblSolution As New DTO.tblSolution
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                Dim oSecureNat = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName And s.CompNatNumber <> 0 Select s.CompNatNumber


                tblSolution = ( _
                From d In db.tblSolutions _
                Where d.SolutionControl < CurrentControl _
                And _
                (NatAccountNumber <> 0 OrElse (d.SolutionCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionCompControl)))) _
                And _
                (If(UseCreateDate Or UseCommittedDate Or UseArchivedDate, _
                    If(UseCreateDate, _
                        (d.SolutionCreateDate >= FromDate And d.SolutionCreateDate < ToDate.AddDays(1)), _
                        If(UseCommittedDate, _
                            (d.SolutionCommittedDate >= FromDate And d.SolutionCommittedDate < ToDate.AddDays(1)), _
                            (d.SolutionArchivedDate >= FromDate And d.SolutionArchivedDate < ToDate.AddDays(1)))), _
                    True
                    ) _
                ) _
                And _
                (NatAccountNumber = 0 OrElse (d.SolutionCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionCompNatNumber)))) _
                Order By d.SolutionControl Descending _
                Select New DTO.tblSolution With {.SolutionControl = d.SolutionControl _
                                                    , .SolutionAttributeControl = d.SolutionAttributeControl _
                                                    , .SolutionAttributeTypeControl = d.SolutionAttributeTypeControl _
                                                    , .SolutionName = d.SolutionName _
                                                    , .SolutionDescription = d.SolutionDescription _
                                                    , .SolutionCompControl = d.SolutionCompControl _
                                                    , .SolutionCompNumber = d.SolutionCompNumber _
                                                    , .SolutionCompName = d.SolutionCompName _
                                                    , .SolutionCompNatNumber = d.SolutionCompNatNumber _
                                                    , .SolutionCompNatName = d.SolutionCompNatName _
                                                    , .SolutionCreateDate = d.SolutionCreateDate _
                                                    , .SolutionTotalCases = d.SolutionTotalCases _
                                                    , .SolutionTotalWgt = d.SolutionTotalWgt _
                                                    , .SolutionTotalPL = d.SolutionTotalPL _
                                                    , .SolutionTotalCube = d.SolutionTotalCube _
                                                    , .SolutionTotalPX = d.SolutionTotalPX _
                                                    , .SolutionTotalBFC = d.SolutionTotalBFC _
                                                    , .SolutionTotalOrders = d.SolutionTotalOrders _
                                                    , .SolutionTotalTLCost = d.SolutionTotalTLCost _
                                                    , .SolutionTotalMPCost = d.SolutionTotalMPCost _
                                                    , .SolutionTotalPoolCost = d.SolutionTotalPoolCost _
                                                    , .SolutionTotalLTLPoolCost = d.SolutionTotalLTLPoolCost _
                                                    , .SolutionTotalLTLCost = d.SolutionTotalLTLCost _
                                                    , .SolutionTotalCost = d.SolutionTotalCost _
                                                    , .SolutionTotalTrucks = d.SolutionTotalTrucks _
                                                    , .SolutionTotalMiles = d.SolutionTotalMiles _
                                                    , .SolutionCommitted = d.SolutionCommitted _
                                                    , .SolutionCommittedDate = d.SolutionCommittedDate _
                                                    , .SolutionArchived = d.SolutionArchived _
                                                    , .SolutionArchivedDate = d.SolutionArchivedDate _
                                                    , .SolutionModDate = d.SolutionModDate _
                                                    , .SolutionModUser = d.SolutionModUser _
                                                    , .SolutionUpdated = d.SolutionUpdated.ToArray()}).FirstOrDefault

                Return tblSolution

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary>
    ''' The CurrentControl is the seed control value.
    ''' The FKControl parameter is a reference to the Comp Control Number.  If a NatAccountNumber is provided the 
    ''' FKcontrol is ignored.
    ''' </summary>
    ''' <param name="CurrentControl"></param>
    ''' <param name="FKControl"></param>
    ''' <param name="FromDate"></param>
    ''' <param name="ToDate"></param>
    ''' <param name="UseCreateDate"></param>
    ''' <param name="UseCommittedDate"></param>
    ''' <param name="UseArchivedDate"></param>
    ''' <param name="NatAccountNumber"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overloads Function GetNextRecord(ByVal CurrentControl As Long, _
                                            ByVal FKControl As Long, _
                                            ByVal FromDate As Date, _
                                            ByVal ToDate As Date, _
                                             ByVal UseCreateDate As Boolean, _
                                             ByVal UseCommittedDate As Boolean, _
                                             ByVal UseArchivedDate As Boolean, _
                                             ByVal NatAccountNumber As Integer) As DataTransferObjects.DTOBaseClass
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                Dim tblSolution As New DTO.tblSolution
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                Dim oSecureNat = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName And s.CompNatNumber <> 0 Select s.CompNatNumber


                tblSolution = ( _
                   From d In db.tblSolutions _
                   Where d.SolutionControl > CurrentControl _
                   And _
                   (NatAccountNumber <> 0 OrElse (d.SolutionCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionCompControl)))) _
                    And _
                    (If(UseCreateDate Or UseCommittedDate Or UseArchivedDate, _
                        If(UseCreateDate, _
                            (d.SolutionCreateDate >= FromDate And d.SolutionCreateDate < ToDate.AddDays(1)), _
                            If(UseCommittedDate, _
                                (d.SolutionCommittedDate >= FromDate And d.SolutionCommittedDate < ToDate.AddDays(1)), _
                                (d.SolutionArchivedDate >= FromDate And d.SolutionArchivedDate < ToDate.AddDays(1)))), _
                        True
                        ) _
                    ) _
                    And _
                    (NatAccountNumber = 0 OrElse (d.SolutionCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionCompNatNumber)))) _
                    Order By d.SolutionControl _
                   Select New DTO.tblSolution With {.SolutionControl = d.SolutionControl _
                                                    , .SolutionAttributeControl = d.SolutionAttributeControl _
                                                    , .SolutionAttributeTypeControl = d.SolutionAttributeTypeControl _
                                                    , .SolutionName = d.SolutionName _
                                                    , .SolutionDescription = d.SolutionDescription _
                                                    , .SolutionCompControl = d.SolutionCompControl _
                                                    , .SolutionCompNumber = d.SolutionCompNumber _
                                                    , .SolutionCompName = d.SolutionCompName _
                                                    , .SolutionCompNatNumber = d.SolutionCompNatNumber _
                                                    , .SolutionCompNatName = d.SolutionCompNatName _
                                                    , .SolutionCreateDate = d.SolutionCreateDate _
                                                    , .SolutionTotalCases = d.SolutionTotalCases _
                                                    , .SolutionTotalWgt = d.SolutionTotalWgt _
                                                    , .SolutionTotalPL = d.SolutionTotalPL _
                                                    , .SolutionTotalCube = d.SolutionTotalCube _
                                                    , .SolutionTotalPX = d.SolutionTotalPX _
                                                    , .SolutionTotalBFC = d.SolutionTotalBFC _
                                                    , .SolutionTotalOrders = d.SolutionTotalOrders _
                                                    , .SolutionTotalTLCost = d.SolutionTotalTLCost _
                                                    , .SolutionTotalMPCost = d.SolutionTotalMPCost _
                                                    , .SolutionTotalPoolCost = d.SolutionTotalPoolCost _
                                                    , .SolutionTotalLTLPoolCost = d.SolutionTotalLTLPoolCost _
                                                    , .SolutionTotalLTLCost = d.SolutionTotalLTLCost _
                                                    , .SolutionTotalCost = d.SolutionTotalCost _
                                                    , .SolutionTotalTrucks = d.SolutionTotalTrucks _
                                                    , .SolutionTotalMiles = d.SolutionTotalMiles _
                                                    , .SolutionCommitted = d.SolutionCommitted _
                                                    , .SolutionCommittedDate = d.SolutionCommittedDate _
                                                    , .SolutionArchived = d.SolutionArchived _
                                                    , .SolutionArchivedDate = d.SolutionArchivedDate _
                                                    , .SolutionModDate = d.SolutionModDate _
                                                    , .SolutionModUser = d.SolutionModUser _
                                                    , .SolutionUpdated = d.SolutionUpdated.ToArray()}).FirstOrDefault

                Return tblSolution

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary>
    ''' The UpperControl parameter allows for a starting control number to be provided.
    ''' The FKControl parameter is a reference to the Comp Control Number.  If a NatAccountNumber is provided the 
    ''' FKcontrol is ignored
    ''' </summary>
    ''' <param name="UpperControl"></param>
    ''' <param name="FKControl"></param>
    ''' <param name="FromDate"></param>
    ''' <param name="ToDate"></param>
    ''' <param name="UseCreateDate"></param>
    ''' <param name="UseCommittedDate"></param>
    ''' <param name="UseArchivedDate"></param>
    ''' <param name="NatAccountNumber"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overloads Function GetLastRecord(ByVal UpperControl As Long, _
                                            ByVal FKControl As Long, _
                                            ByVal FromDate As Date, _
                                            ByVal ToDate As Date, _
                                             ByVal UseCreateDate As Boolean, _
                                             ByVal UseCommittedDate As Boolean, _
                                             ByVal UseArchivedDate As Boolean, _
                                             ByVal NatAccountNumber As Integer) As DataTransferObjects.DTOBaseClass
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim tblSolution As New DTO.tblSolution
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                Dim oSecureNat = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName And s.CompNatNumber <> 0 Select s.CompNatNumber

                If UpperControl <> 0 Then
                    tblSolution = ( _
                    From d In db.tblSolutions _
                    Where d.SolutionControl >= UpperControl _
                    And _
                    (NatAccountNumber <> 0 OrElse (d.SolutionCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionCompControl)))) _
                    And _
                    (If(UseCreateDate Or UseCommittedDate Or UseArchivedDate, _
                        If(UseCreateDate, _
                            (d.SolutionCreateDate >= FromDate And d.SolutionCreateDate < ToDate.AddDays(1)), _
                            If(UseCommittedDate, _
                                (d.SolutionCommittedDate >= FromDate And d.SolutionCommittedDate < ToDate.AddDays(1)), _
                                (d.SolutionArchivedDate >= FromDate And d.SolutionArchivedDate < ToDate.AddDays(1)))), _
                        True
                        ) _
                    ) _
                    And _
                    (NatAccountNumber = 0 OrElse (d.SolutionCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionCompNatNumber)))) _
                    Order By d.SolutionControl _
                    Select New DTO.tblSolution With {.SolutionControl = d.SolutionControl _
                                                    , .SolutionAttributeControl = d.SolutionAttributeControl _
                                                    , .SolutionAttributeTypeControl = d.SolutionAttributeTypeControl _
                                                    , .SolutionName = d.SolutionName _
                                                    , .SolutionDescription = d.SolutionDescription _
                                                    , .SolutionCompControl = d.SolutionCompControl _
                                                    , .SolutionCompNumber = d.SolutionCompNumber _
                                                    , .SolutionCompName = d.SolutionCompName _
                                                    , .SolutionCompNatNumber = d.SolutionCompNatNumber _
                                                    , .SolutionCompNatName = d.SolutionCompNatName _
                                                    , .SolutionCreateDate = d.SolutionCreateDate _
                                                    , .SolutionTotalCases = d.SolutionTotalCases _
                                                    , .SolutionTotalWgt = d.SolutionTotalWgt _
                                                    , .SolutionTotalPL = d.SolutionTotalPL _
                                                    , .SolutionTotalCube = d.SolutionTotalCube _
                                                    , .SolutionTotalPX = d.SolutionTotalPX _
                                                    , .SolutionTotalBFC = d.SolutionTotalBFC _
                                                    , .SolutionTotalOrders = d.SolutionTotalOrders _
                                                    , .SolutionTotalTLCost = d.SolutionTotalTLCost _
                                                    , .SolutionTotalMPCost = d.SolutionTotalMPCost _
                                                    , .SolutionTotalPoolCost = d.SolutionTotalPoolCost _
                                                    , .SolutionTotalLTLPoolCost = d.SolutionTotalLTLPoolCost _
                                                    , .SolutionTotalLTLCost = d.SolutionTotalLTLCost _
                                                    , .SolutionTotalCost = d.SolutionTotalCost _
                                                    , .SolutionTotalTrucks = d.SolutionTotalTrucks _
                                                    , .SolutionTotalMiles = d.SolutionTotalMiles _
                                                    , .SolutionCommitted = d.SolutionCommitted _
                                                    , .SolutionCommittedDate = d.SolutionCommittedDate _
                                                    , .SolutionArchived = d.SolutionArchived _
                                                    , .SolutionArchivedDate = d.SolutionArchivedDate _
                                                    , .SolutionModDate = d.SolutionModDate _
                                                    , .SolutionModUser = d.SolutionModUser _
                                                    , .SolutionUpdated = d.SolutionUpdated.ToArray()}).FirstOrDefault

                Else
                    tblSolution = ( _
                    From d In db.tblSolutions _
                    Where _
                    (NatAccountNumber <> 0 OrElse (d.SolutionCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionCompControl)))) _
                    And _
                    (If(UseCreateDate Or UseCommittedDate Or UseArchivedDate, _
                        If(UseCreateDate, _
                            (d.SolutionCreateDate >= FromDate And d.SolutionCreateDate < ToDate.AddDays(1)), _
                            If(UseCommittedDate, _
                                (d.SolutionCommittedDate >= FromDate And d.SolutionCommittedDate < ToDate.AddDays(1)), _
                                (d.SolutionArchivedDate >= FromDate And d.SolutionArchivedDate < ToDate.AddDays(1)))), _
                        True
                        ) _
                    ) _
                    And _
                    (NatAccountNumber = 0 OrElse (d.SolutionCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionCompNatNumber)))) _
                    Order By d.SolutionControl Descending _
                    Select New DTO.tblSolution With {.SolutionControl = d.SolutionControl _
                                                    , .SolutionAttributeControl = d.SolutionAttributeControl _
                                                    , .SolutionAttributeTypeControl = d.SolutionAttributeTypeControl _
                                                    , .SolutionName = d.SolutionName _
                                                    , .SolutionDescription = d.SolutionDescription _
                                                    , .SolutionCompControl = d.SolutionCompControl _
                                                    , .SolutionCompNumber = d.SolutionCompNumber _
                                                    , .SolutionCompName = d.SolutionCompName _
                                                    , .SolutionCompNatNumber = d.SolutionCompNatNumber _
                                                    , .SolutionCompNatName = d.SolutionCompNatName _
                                                    , .SolutionCreateDate = d.SolutionCreateDate _
                                                    , .SolutionTotalCases = d.SolutionTotalCases _
                                                    , .SolutionTotalWgt = d.SolutionTotalWgt _
                                                    , .SolutionTotalPL = d.SolutionTotalPL _
                                                    , .SolutionTotalCube = d.SolutionTotalCube _
                                                    , .SolutionTotalPX = d.SolutionTotalPX _
                                                    , .SolutionTotalBFC = d.SolutionTotalBFC _
                                                    , .SolutionTotalOrders = d.SolutionTotalOrders _
                                                    , .SolutionTotalTLCost = d.SolutionTotalTLCost _
                                                    , .SolutionTotalMPCost = d.SolutionTotalMPCost _
                                                    , .SolutionTotalPoolCost = d.SolutionTotalPoolCost _
                                                    , .SolutionTotalLTLPoolCost = d.SolutionTotalLTLPoolCost _
                                                    , .SolutionTotalLTLCost = d.SolutionTotalLTLCost _
                                                    , .SolutionTotalCost = d.SolutionTotalCost _
                                                    , .SolutionTotalTrucks = d.SolutionTotalTrucks _
                                                    , .SolutionTotalMiles = d.SolutionTotalMiles _
                                                    , .SolutionCommitted = d.SolutionCommitted _
                                                    , .SolutionCommittedDate = d.SolutionCommittedDate _
                                                    , .SolutionArchived = d.SolutionArchived _
                                                    , .SolutionArchivedDate = d.SolutionArchivedDate _
                                                    , .SolutionModDate = d.SolutionModDate _
                                                    , .SolutionModUser = d.SolutionModUser _
                                                    , .SolutionUpdated = d.SolutionUpdated.ToArray()}).FirstOrDefault

                End If

                Return tblSolution

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GettblSolutionFiltered(ByVal Control As Integer) As DTO.tblSolution
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'Get the newest record that matches the provided criteria
                Dim tblSolution As DTO.tblSolution = ( _
                From d In db.tblSolutions _
                Where _
                    d.SolutionControl = Control _
                Select New DTO.tblSolution With {.SolutionControl = d.SolutionControl _
                                                , .SolutionAttributeControl = d.SolutionAttributeControl _
                                                , .SolutionAttributeTypeControl = d.SolutionAttributeTypeControl _
                                                , .SolutionName = d.SolutionName _
                                                , .SolutionDescription = d.SolutionDescription _
                                                , .SolutionCompControl = d.SolutionCompControl _
                                                , .SolutionCompNumber = d.SolutionCompNumber _
                                                , .SolutionCompName = d.SolutionCompName _
                                                , .SolutionCreateDate = d.SolutionCreateDate _
                                                , .SolutionTotalCases = d.SolutionTotalCases _
                                                , .SolutionTotalWgt = d.SolutionTotalWgt _
                                                , .SolutionTotalPL = d.SolutionTotalPL _
                                                , .SolutionTotalCube = d.SolutionTotalCube _
                                                , .SolutionTotalPX = d.SolutionTotalPX _
                                                , .SolutionTotalBFC = d.SolutionTotalBFC _
                                                , .SolutionTotalOrders = d.SolutionTotalOrders _
                                                , .SolutionTotalTLCost = d.SolutionTotalTLCost _
                                                , .SolutionTotalMPCost = d.SolutionTotalMPCost _
                                                , .SolutionTotalPoolCost = d.SolutionTotalPoolCost _
                                                , .SolutionTotalLTLPoolCost = d.SolutionTotalLTLPoolCost _
                                                , .SolutionTotalLTLCost = d.SolutionTotalLTLCost _
                                                , .SolutionTotalCost = d.SolutionTotalCost _
                                                , .SolutionTotalTrucks = d.SolutionTotalTrucks _
                                                , .SolutionTotalMiles = d.SolutionTotalMiles _
                                                , .SolutionCommitted = d.SolutionCommitted _
                                                , .SolutionCommittedDate = d.SolutionCommittedDate _
                                                , .SolutionArchived = d.SolutionArchived _
                                                , .SolutionArchivedDate = d.SolutionArchivedDate _
                                                , .SolutionModDate = d.SolutionModDate _
                                                , .SolutionModUser = d.SolutionModUser _
                                                , .SolutionUpdated = d.SolutionUpdated.ToArray()}).First


                Return tblSolution

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GettblSolutionsFiltered(ByVal CompanyControl As Integer, _
                                      ByVal FromDate As Date, _
                                      ByVal ToDate As Date, _
                                      ByVal UseCreateDate As Boolean, _
                                      ByVal UseCommittedDate As Boolean, _
                                      ByVal UseArchivedDate As Boolean, _
                                      ByVal NatAccountNumber As Integer, _
                                      Optional ByVal page As Integer = 1, _
                                      Optional ByVal pagesize As Integer = 1000) As DTO.tblSolution()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                Dim oSecureNat = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName And s.CompNatNumber <> 0 Select s.CompNatNumber

                Dim intRecordCount As Integer = 0
                Dim intPageCount As Integer = 1

                Dim qRet = From d In db.tblSolutions _
                    Where (NatAccountNumber <> 0 OrElse (d.SolutionCompControl = CompanyControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionCompControl)))) _
                    And _
                    (If(UseCreateDate Or UseCommittedDate Or UseArchivedDate, _
                        If(UseCreateDate, _
                            (d.SolutionCreateDate >= FromDate And d.SolutionCreateDate < ToDate.AddDays(1)), _
                            If(UseCommittedDate, _
                                (d.SolutionCommittedDate >= FromDate And d.SolutionCommittedDate < ToDate.AddDays(1)), _
                                (d.SolutionArchivedDate >= FromDate And d.SolutionArchivedDate < ToDate.AddDays(1)))), _
                        True
                        ) _
                    ) _
                    And _
                    (NatAccountNumber = 0 OrElse (d.SolutionCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionCompNatNumber)))) _
                    And _
                    (d.SolutionModUser = Parameters.UserName) _
                    Select d.SolutionControl

                If Not qRet Is Nothing AndAlso qRet.Count > 0 Then

                    intRecordCount = qRet.Count

                    If pagesize < 1 Then pagesize = 1
                    If intRecordCount < 1 Then intRecordCount = 1
                    If page < 1 Then page = 1
                    If intRecordCount > pagesize Then intPageCount = ((intRecordCount - 1) \ pagesize) + 1
                    Dim intSkip As Integer = (page - 1) * pagesize
                    'Return all the contacts that match the criteria sorted by name
                    Dim tblSolutions() As DTO.tblSolution = ( _
                    From d In db.tblSolutions _
                    Where qRet.Contains(d.SolutionControl) _
                    Order By d.SolutionControl _
                    Select New DTO.tblSolution With {.SolutionControl = d.SolutionControl _
                                                    , .SolutionAttributeControl = d.SolutionAttributeControl _
                                                    , .SolutionAttributeTypeControl = d.SolutionAttributeTypeControl _
                                                    , .SolutionName = d.SolutionName _
                                                    , .SolutionDescription = d.SolutionDescription _
                                                    , .SolutionCompControl = d.SolutionCompControl _
                                                    , .SolutionCompNumber = d.SolutionCompNumber _
                                                    , .SolutionCompName = d.SolutionCompName _
                                                    , .SolutionCompNatNumber = d.SolutionCompNatNumber _
                                                    , .SolutionCompNatName = d.SolutionCompNatName _
                                                    , .SolutionCreateDate = d.SolutionCreateDate _
                                                    , .SolutionTotalCases = d.SolutionTotalCases _
                                                    , .SolutionTotalWgt = d.SolutionTotalWgt _
                                                    , .SolutionTotalPL = d.SolutionTotalPL _
                                                    , .SolutionTotalCube = d.SolutionTotalCube _
                                                    , .SolutionTotalPX = d.SolutionTotalPX _
                                                    , .SolutionTotalBFC = d.SolutionTotalBFC _
                                                    , .SolutionTotalOrders = d.SolutionTotalOrders _
                                                    , .SolutionTotalTLCost = d.SolutionTotalTLCost _
                                                    , .SolutionTotalMPCost = d.SolutionTotalMPCost _
                                                    , .SolutionTotalPoolCost = d.SolutionTotalPoolCost _
                                                    , .SolutionTotalLTLPoolCost = d.SolutionTotalLTLPoolCost _
                                                    , .SolutionTotalLTLCost = d.SolutionTotalLTLCost _
                                                    , .SolutionTotalCost = d.SolutionTotalCost _
                                                    , .SolutionTotalTrucks = d.SolutionTotalTrucks _
                                                    , .SolutionTotalMiles = d.SolutionTotalMiles _
                                                    , .SolutionCommitted = d.SolutionCommitted _
                                                    , .SolutionCommittedDate = d.SolutionCommittedDate _
                                                    , .SolutionArchived = d.SolutionArchived _
                                                    , .SolutionArchivedDate = d.SolutionArchivedDate _
                                                    , .SolutionModDate = d.SolutionModDate _
                                                    , .SolutionModUser = d.SolutionModUser _
                                                    , .SolutionUpdated = d.SolutionUpdated.ToArray()}).ToArray()
                    Return tblSolutions
                Else
                    Return Nothing
                End If

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Sub UpdateBookFromLoadPlanning(ByVal BookProNumber As String, ByVal dictData As Dictionary(Of String, String))
        Dim strProcName As String = "dbo.spMassUpdateLoadPlanningPro"
        Dim oCmd As New System.Data.SqlClient.SqlCommand
        oCmd.Parameters.AddWithValue("@BookProNumber", BookProNumber)
        Dim intDefault As Integer = 0
        Dim dtDefault As Date
        Dim boolDefault As Boolean
        For Each item In dictData
            Select Case item.Key
                Case "BookDateLoad"
                    If Date.TryParse(item.Value, dtDefault) Then
                        oCmd.Parameters.AddWithValue("@BookDateLoad", dtDefault)
                    End If
                Case "BookDateRequired"
                    If Date.TryParse(item.Value, dtDefault) Then
                        oCmd.Parameters.AddWithValue("@BookDateRequired", dtDefault)
                    End If
                Case "BookCarrActDate"
                    If Date.TryParse(item.Value, dtDefault) Then
                        oCmd.Parameters.AddWithValue("@BookCarrActDate", dtDefault)
                    End If
                Case "BookShipCarrierProNumber"
                    oCmd.Parameters.AddWithValue("@BookShipCarrierProNumber", Left(item.Value, 20))
                Case "BookShipCarrierName"
                    oCmd.Parameters.AddWithValue("@BookShipCarrierName", Left(item.Value, 60))
                Case "BookShipCarrierNumber"
                    oCmd.Parameters.AddWithValue("@BookShipCarrierNumber", Left(item.Value, 80))
                Case "BookCustomerApprovalTransmitted"
                    If Boolean.TryParse(item.Value, boolDefault) Then
                        oCmd.Parameters.AddWithValue("@BookCustomerApprovalTransmitted", If(boolDefault = True, "1", "0"))
                    End If
                Case "BookCustomerApprovalRecieved"
                    If Boolean.TryParse(item.Value, boolDefault) Then
                        oCmd.Parameters.AddWithValue("@BookCustomerApprovalRecieved", If(boolDefault = True, "1", "0"))
                    End If
                Case "BookCarrTrailerNo"
                    oCmd.Parameters.AddWithValue("@BookCarrTrailerNo", Left(item.Value, 50))
                Case "BookCarrSealNo"
                    oCmd.Parameters.AddWithValue("@BookCarrSealNo", Left(item.Value, 50))
                Case "BookCarrDriverNo"
                    oCmd.Parameters.AddWithValue("@BookCarrDriverNo", Left(item.Value, 50))
                Case "BookCarrDriverName"
                    oCmd.Parameters.AddWithValue("@BookCarrDriverName", Left(item.Value, 50))
                Case "BookCarrRouteNo"
                    oCmd.Parameters.AddWithValue("@BookCarrRouteNo", Left(item.Value, 50))
                Case "BookCarrTripNo"
                    oCmd.Parameters.AddWithValue("@BookCarrTripNo", Left(item.Value, 50))
                Case "BookTrackContact"
                    oCmd.Parameters.AddWithValue("@BookTrackContact", Left(item.Value, 50))
                Case "BookTrackComment"
                    oCmd.Parameters.AddWithValue("@BookTrackComment", Left(item.Value, 255))
                Case "BookTrackStatus"
                    oCmd.Parameters.AddWithValue("@BookTrackStatus", item.Value)
            End Select
        Next
        oCmd.Parameters.AddWithValue("@UserName", Left(Me.Parameters.UserName, 100))
        runNGLStoredProcedure(oCmd, strProcName, 0)
    End Sub

#End Region

#Region "Protected Functions"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Dim d = CType(oData, DTO.tblSolution)
        'Create New Record
        Return New LTS.tblSolution With {.SolutionControl = d.SolutionControl _
                                                    , .SolutionAttributeControl = d.SolutionAttributeControl _
                                                    , .SolutionAttributeTypeControl = d.SolutionAttributeTypeControl _
                                                    , .SolutionName = d.SolutionName _
                                                    , .SolutionDescription = d.SolutionDescription _
                                                    , .SolutionCompControl = d.SolutionCompControl _
                                                    , .SolutionCompNumber = d.SolutionCompNumber _
                                                    , .SolutionCompName = d.SolutionCompName _
                                                    , .SolutionCompNatNumber = d.SolutionCompNatNumber _
                                                    , .SolutionCompNatName = d.SolutionCompNatName _
                                                    , .SolutionCreateDate = If(d.SolutionCreateDate.HasValue, d.SolutionCreateDate, Date.Now) _
                                                    , .SolutionTotalCases = d.SolutionTotalCases _
                                                    , .SolutionTotalWgt = d.SolutionTotalWgt _
                                                    , .SolutionTotalPL = d.SolutionTotalPL _
                                                    , .SolutionTotalCube = d.SolutionTotalCube _
                                                    , .SolutionTotalPX = d.SolutionTotalPX _
                                                    , .SolutionTotalBFC = d.SolutionTotalBFC _
                                                    , .SolutionTotalOrders = d.SolutionTotalOrders _
                                                    , .SolutionTotalTLCost = d.SolutionTotalTLCost _
                                                    , .SolutionTotalMPCost = d.SolutionTotalMPCost _
                                                    , .SolutionTotalPoolCost = d.SolutionTotalPoolCost _
                                                    , .SolutionTotalLTLPoolCost = d.SolutionTotalLTLPoolCost _
                                                    , .SolutionTotalLTLCost = d.SolutionTotalLTLCost _
                                                    , .SolutionTotalCost = d.SolutionTotalCost _
                                                    , .SolutionTotalTrucks = d.SolutionTotalTrucks _
                                                    , .SolutionTotalMiles = d.SolutionTotalMiles _
                                                    , .SolutionCommitted = d.SolutionCommitted _
                                                    , .SolutionCommittedDate = d.SolutionCommittedDate _
                                                    , .SolutionArchived = d.SolutionArchived _
                                                    , .SolutionArchivedDate = d.SolutionArchivedDate _
                                                    , .SolutionModDate = Date.Now _
                                                    , .SolutionModUser = Parameters.UserName _
                                                    , .SolutionUpdated = If(d.SolutionUpdated Is Nothing, New Byte() {}, d.SolutionUpdated)}

    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Return GettblSolutionFiltered(Control:=CType(LinqTable, LTS.tblSolution).SolutionControl)
    End Function

    Protected Overrides Function GetQuickSaveResults(ByVal LinqTable As Object) As DataTransferObjects.QuickSaveResults
        Dim ret As DTO.QuickSaveResults
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim source As LTS.tblSolution = TryCast(LinqTable, LTS.tblSolution)
                If source Is Nothing Then Return Nothing

                ret = (From d In db.tblSolutions _
                       Where d.SolutionControl = source.SolutionControl _
                       Select New DTO.QuickSaveResults With {.Control = d.SolutionControl _
                                                            , .ModDate = d.SolutionModDate _
                                                            , .ModUser = d.SolutionModUser _
                                                            , .Updated = d.SolutionUpdated.ToArray}).First

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

        End Using
        Return ret
    End Function

#End Region

End Class

Public Class NGLtblSolutionTruckData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.tblSolutionTrucks
        Me.LinqDB = db
    End Sub

#End Region

#Region " Properties "

    Protected Overrides Property LinqTable() As Object
        Get
            Dim db As New NGLMasBookDataContext(ConnectionString)
            Me.LinqTable = db.tblSolutionTrucks
            Me.LinqDB = db
            Return _LinqTable
        End Get
        Set(ByVal value As Object)
            _LinqTable = value
        End Set
    End Property

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GettblSolutionTruckFiltered(Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return Nothing
    End Function

    ''' <summary>
    ''' The LowerControl parameter allows for a starting control number to be providced. 
    ''' The FKControl parameter is a reference to the Solution Control Number.
    ''' </summary>
    ''' <param name="LowerControl"></param>
    ''' <param name="FKControl"></param>
    ''' <param name="RouteTypeCode"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overloads Function GetFirstRecord(ByVal LowerControl As Long, _
                                             ByVal FKControl As Long, _
                                             ByVal RouteTypeCode As Integer) As DataTransferObjects.DTOBaseClass

        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                Dim tblSolutionTruck As New DTO.tblSolutionTruck

                tblSolutionTruck = ( _
                From d In db.tblSolutionTrucks _
                Where (LowerControl = 0 OrElse d.SolutionTruckControl >= LowerControl) _
                And _
                (d.SolutionTruckSolutionControl = FKControl) _
                And _
                (RouteTypeCode = 0 OrElse d.SolutionTruckRouteTypeCode = RouteTypeCode) _
                Order By d.SolutionTruckControl _
                Select selectDTOData(d, db)).FirstOrDefault


                Return tblSolutionTruck


            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary>
    ''' The CurrentControl parameter is the seed for the previous record.
    ''' The FKControl parameter is a reference to the Solution Control Number.
    ''' </summary>
    ''' <param name="CurrentControl"></param>
    ''' <param name="FKControl"></param>
    ''' <param name="RouteTypeCode"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overloads Function GetPreviousRecord(ByVal CurrentControl As Long, _
                                                ByVal FKControl As Long, _
                                                ByVal RouteTypeCode As Integer) As DataTransferObjects.DTOBaseClass
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                Dim tblSolutionTruck As New DTO.tblSolutionTruck

                tblSolutionTruck = ( _
                From d In db.tblSolutionTrucks _
                Where d.SolutionTruckControl < CurrentControl _
                And _
                (d.SolutionTruckSolutionControl = FKControl) _
                And _
                (RouteTypeCode = 0 OrElse d.SolutionTruckRouteTypeCode = RouteTypeCode) _
                Order By d.SolutionTruckControl Descending _
                Select selectDTOData(d, db)).FirstOrDefault

                Return tblSolutionTruck

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary>
    ''' The LowerControl parameter allows for a starting control number to be providced.
    ''' The FKControl parameter is a reference to the Solution Control Number.
    ''' </summary>
    ''' <param name="CurrentControl"></param>
    ''' <param name="FKControl"></param>
    ''' <param name="RouteTypeCode"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overloads Function GetNextRecord(ByVal CurrentControl As Long, _
                                             ByVal FKControl As Long, _
                                             ByVal RouteTypeCode As Integer) As DataTransferObjects.DTOBaseClass

        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                Dim tblSolutionTruck As New DTO.tblSolutionTruck

                tblSolutionTruck = ( _
               From d In db.tblSolutionTrucks _
               Where d.SolutionTruckControl > CurrentControl _
                And _
                (d.SolutionTruckSolutionControl = FKControl) _
                And _
                (RouteTypeCode = 0 OrElse d.SolutionTruckRouteTypeCode = RouteTypeCode) _
                Order By d.SolutionTruckControl _
               Select selectDTOData(d, db)).FirstOrDefault


                Return tblSolutionTruck

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary>
    ''' The UpperControl parameter allows for a starting control number to be providced.
    ''' The FKControl parameter is a reference to the Solution Truck Control Number.
    ''' </summary>
    ''' <param name="UpperControl"></param>
    ''' <param name="FKControl"></param>
    ''' <param name="RouteTypeCode"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overloads Function GetLastRecord(ByVal UpperControl As Long, _
                                             ByVal FKControl As Long, _
                                             ByVal RouteTypeCode As Integer) As DataTransferObjects.DTOBaseClass
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim tblSolutionTruck As New DTO.tblSolutionTruck

                If UpperControl <> 0 Then

                    tblSolutionTruck = ( _
                    From d In db.tblSolutionTrucks _
                    Where d.SolutionTruckControl >= UpperControl _
                    And _
                    (d.SolutionTruckSolutionControl = FKControl) _
                    And _
                    (RouteTypeCode = 0 OrElse d.SolutionTruckRouteTypeCode = RouteTypeCode) _
                    Order By d.SolutionTruckControl _
                    Select selectDTOData(d, db)).FirstOrDefault

                Else



                    tblSolutionTruck = ( _
                    From d In db.tblSolutionTrucks _
                    Where (d.SolutionTruckSolutionControl = FKControl) _
                    And _
                    (RouteTypeCode = 0 OrElse d.SolutionTruckRouteTypeCode = RouteTypeCode) _
                    Order By d.SolutionTruckControl Descending _
                    Select selectDTOData(d, db)).FirstOrDefault
                End If


                Return tblSolutionTruck

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GettblSolutionTruckFiltered(ByVal Control As Long) As DTO.tblSolutionTruck
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'Get the newest record that matches the provided criteria
                Dim tblSolutionTruck As DTO.tblSolutionTruck = ( _
                From d In db.tblSolutionTrucks _
                Where _
                    d.SolutionTruckControl = Control _
                Select selectDTOData(d, db)).First


                Return tblSolutionTruck

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GettblSolutionTrucksFiltered(ByVal SolutionControl As Long, _
                                            ByVal RouteTypeCode As Integer, _
                                            Optional ByVal page As Integer = 1, _
                                            Optional ByVal pagesize As Integer = 1000) As DTO.tblSolutionTruck()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                Dim intRecordCount As Integer = 0
                Dim intPageCount As Integer = 1

                Dim qRet = From d In db.tblSolutionTrucks _
                    Where (d.SolutionTruckSolutionControl = SolutionControl) _
                    And _
                    (RouteTypeCode = 0 OrElse d.SolutionTruckRouteTypeCode = RouteTypeCode) _
                    Select d.SolutionTruckControl

                If Not qRet Is Nothing AndAlso qRet.Count > 0 Then

                    intRecordCount = qRet.Count

                    If pagesize < 1 Then pagesize = 1
                    If intRecordCount < 1 Then intRecordCount = 1
                    If page < 1 Then page = 1
                    If intRecordCount > pagesize Then intPageCount = ((intRecordCount - 1) \ pagesize) + 1
                    Dim intSkip As Integer = (page - 1) * pagesize

                    'Return all the records that match the criteria sorted by name
                    Dim tblSolutionTrucks() As DTO.tblSolutionTruck = ( _
                    From d In db.tblSolutionTrucks _
                    Where qRet.Contains(d.SolutionTruckControl) _
                    Order By d.SolutionTruckControl Descending _
                    Select selectDTOData(d, db, page, intPageCount, pagesize)).Skip(intSkip).Take(pagesize).ToArray()

                    Return tblSolutionTrucks
                Else
                    Return Nothing
                End If

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Friend Function selectDTOData(ByVal d As LTS.tblSolutionTruck, ByRef db As NGLMasBookDataContext, Optional page As Integer = 1, Optional pagecount As Integer = 1, Optional pagesize As Integer = 1000) As DTO.tblSolutionTruck
        Return New DTO.tblSolutionTruck With {.SolutionTruckControl = d.SolutionTruckControl _
                                                      , .SolutionTruckSolutionControl = d.SolutionTruckSolutionControl _
                                                      , .SolutionTruckCom = d.SolutionTruckCom _
                                                      , .SolutionTruckConsPrefix = d.SolutionTruckConsPrefix _
                                                      , .SolutionTruckRouteConsFlag = d.SolutionTruckRouteConsFlag _
                                                      , .SolutionTruckCarrierControl = d.SolutionTruckCarrierControl _
                                                      , .SolutionTruckCarrierNumber = d.SolutionTruckCarrierNumber _
                                                      , .SolutionTruckCarrierName = d.SolutionTruckCarrierName _
                                                      , .SolutionTruckCarrierTruckControl = d.SolutionTruckCarrierTruckControl _
                                                      , .SolutionTruckCarrierTruckDescription = d.SolutionTruckCarrierTruckDescription _
                                                      , .SolutionTruckTotalCases = d.SolutionTruckTotalCases _
                                                      , .SolutionTruckTotalWgt = d.SolutionTruckTotalWgt _
                                                      , .SolutionTruckTotalPL = d.SolutionTruckTotalPL _
                                                      , .SolutionTruckTotalCube = d.SolutionTruckTotalCube _
                                                      , .SolutionTruckTotalPX = d.SolutionTruckTotalPX _
                                                      , .SolutionTruckTotalBFC = d.SolutionTruckTotalBFC _
                                                      , .SolutionTruckTotalOrders = d.SolutionTruckTotalOrders _
                                                      , .SolutionTruckTotalCost = d.SolutionTruckTotalCost _
                                                      , .SolutionTruckTotalMiles = d.SolutionTruckTotalMiles _
                                                      , .SolutionTruckCarrierEquipmentCodes = d.SolutionTruckCarrierEquipmentCodes _
                                                      , .SolutionTruckRouteTypeCode = d.SolutionTruckRouteTypeCode _
                                                      , .SolutionTruckCommitted = d.SolutionTruckCommitted _
                                                      , .SolutionTruckCommittedDate = d.SolutionTruckCommittedDate _
                                                      , .SolutionTruckStaticRouteControl = d.SolutionTruckStaticRouteControl _
                                                      , .SolutionTruckStaticRouteNumber = db.udfGetStaticRouteNumber(d.SolutionTruckStaticRouteControl) _
                                                      , .SolutionTruckAttributeControl = d.SolutionTruckAttributeControl _
                                                      , .SolutionTruckAttributeTypeControl = d.SolutionTruckAttributeTypeControl _
                                                      , .SolutionTruckCapacityPreference = d.SolutionTruckCapacityPreference _
                                                      , .SolutionTruckSplitCases = d.SolutionTruckSplitCases _
                                                      , .SolutionTruckMaxCases = d.SolutionTruckMaxCases _
                                                      , .SolutionTruckMinWgt = d.SolutionTruckMinWgt _
                                                      , .SolutionTruckSplitWgt = d.SolutionTruckSplitWgt _
                                                      , .SolutionTruckMaxWgt = d.SolutionTruckMaxWgt _
                                                      , .SolutionTruckMinCubes = d.SolutionTruckMinCubes _
                                                      , .SolutionTruckSplitCubes = d.SolutionTruckSplitCubes _
                                                      , .SolutionTruckMaxCubes = d.SolutionTruckMaxCubes _
                                                      , .SolutionTruckMinPlts = d.SolutionTruckMinPlts _
                                                      , .SolutionTruckSplitPlts = d.SolutionTruckSplitPlts _
                                                      , .SolutionTruckMaxPlts = d.SolutionTruckMaxPlts _
                                                      , .SolutionTruckTrucksAvailable = d.SolutionTruckTrucksAvailable _
                                                      , .SolutionTruckIsHazmat = d.SolutionTruckIsHazmat _
                                                      , .SolutionTruckModDate = d.SolutionTruckModDate _
                                                      , .SolutionTruckModUser = d.SolutionTruckModUser _
                                                      , .SolutionTruckUpdated = d.SolutionTruckUpdated.ToArray() _
                                                      , .Page = page _
                                                      , .Pages = pagecount _
                                                      , .PageSize = pagesize}

    End Function

#End Region

    '#Region " Load Routing "


    '    ''' <summary>
    '    ''' in the produciton system this method would check the routing guide for a carrier with equipment 
    '    ''' large enough to handle the load.  For the POC we just return false.  If this were true the orders
    '    ''' would be moved leaving space on the smaller trucks for more orders.
    '    ''' </summary>
    '    ''' <param name="orders"></param>
    '    ''' <returns></returns>
    '    ''' <remarks></remarks>
    '    Private Function moveToLargerTruck(ByRef orders As List(Of DTO.tblSolutionDetail), ByVal RtCapPref As DTO.tblSolutionTruck.RoutingCapacityPreference) As Boolean
    '        Dim blnRet As Boolean = False
    '        'TODO: add code here to check the routing guide for larger trucks
    '        Return blnRet

    '    End Function


    '    Private Function getNextCNSNbr(ByVal seed As Integer) As String
    '        Dim nextCNSNbr As String = "CNS001"
    '        Dim nextID As Integer = seed + 1
    '        If nextID < 10 Then
    '            nextCNSNbr = "CNS00" & nextID.ToString
    '        ElseIf nextID < 100 Then
    '            nextCNSNbr = "CNS0" & nextID.ToString
    '        Else
    '            nextCNSNbr = "CNS" & nextID.ToString
    '        End If
    '        Return nextCNSNbr
    '    End Function

    '#End Region

#Region "Protected Functions"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Dim d = CType(oData, DTO.tblSolutionTruck)
        'Create New Record
        Return New LTS.tblSolutionTruck With {.SolutionTruckControl = d.SolutionTruckControl _
                                                      , .SolutionTruckSolutionControl = d.SolutionTruckSolutionControl _
                                                      , .SolutionTruckCom = d.SolutionTruckCom _
                                                      , .SolutionTruckConsPrefix = d.SolutionTruckConsPrefix _
                                                      , .SolutionTruckRouteConsFlag = d.SolutionTruckRouteConsFlag _
                                                      , .SolutionTruckCarrierControl = d.SolutionTruckCarrierControl _
                                                      , .SolutionTruckCarrierNumber = d.SolutionTruckCarrierNumber _
                                                      , .SolutionTruckCarrierName = d.SolutionTruckCarrierName _
                                                      , .SolutionTruckCarrierTruckControl = d.SolutionTruckCarrierTruckControl _
                                                      , .SolutionTruckCarrierTruckDescription = d.SolutionTruckCarrierTruckDescription _
                                                      , .SolutionTruckTotalCases = d.SolutionTruckTotalCases _
                                                      , .SolutionTruckTotalWgt = d.SolutionTruckTotalWgt _
                                                      , .SolutionTruckTotalPL = d.SolutionTruckTotalPL _
                                                      , .SolutionTruckTotalCube = d.SolutionTruckTotalCube _
                                                      , .SolutionTruckTotalPX = d.SolutionTruckTotalPX _
                                                      , .SolutionTruckTotalBFC = d.SolutionTruckTotalBFC _
                                                      , .SolutionTruckTotalOrders = d.SolutionTruckTotalOrders _
                                                      , .SolutionTruckTotalCost = d.SolutionTruckTotalCost _
                                                      , .SolutionTruckTotalMiles = d.SolutionTruckTotalMiles _
                                                      , .SolutionTruckCarrierEquipmentCodes = d.SolutionTruckCarrierEquipmentCodes _
                                                      , .SolutionTruckRouteTypeCode = d.SolutionTruckRouteTypeCode _
                                                      , .SolutionTruckCommitted = d.SolutionTruckCommitted _
                                                      , .SolutionTruckCommittedDate = d.SolutionTruckCommittedDate _
                                                      , .SolutionTruckStaticRouteControl = d.SolutionTruckStaticRouteControl _
                                                      , .SolutionTruckAttributeControl = d.SolutionTruckAttributeControl _
                                                      , .SolutionTruckAttributeTypeControl = d.SolutionTruckAttributeTypeControl _
                                                      , .SolutionTruckCapacityPreference = d.SolutionTruckCapacityPreference _
                                                      , .SolutionTruckSplitCases = d.SolutionTruckSplitCases _
                                                      , .SolutionTruckMaxCases = d.SolutionTruckMaxCases _
                                                      , .SolutionTruckMinWgt = d.SolutionTruckMinWgt _
                                                      , .SolutionTruckSplitWgt = d.SolutionTruckSplitWgt _
                                                      , .SolutionTruckMaxWgt = d.SolutionTruckMaxWgt _
                                                      , .SolutionTruckMinCubes = d.SolutionTruckMinCubes _
                                                      , .SolutionTruckSplitCubes = d.SolutionTruckSplitCubes _
                                                      , .SolutionTruckMaxCubes = d.SolutionTruckMaxCubes _
                                                      , .SolutionTruckMinPlts = d.SolutionTruckMinPlts _
                                                      , .SolutionTruckSplitPlts = d.SolutionTruckSplitPlts _
                                                      , .SolutionTruckMaxPlts = d.SolutionTruckMaxPlts _
                                                      , .SolutionTruckTrucksAvailable = d.SolutionTruckTrucksAvailable _
                                                      , .SolutionTruckIsHazmat = d.SolutionTruckIsHazmat _
                                                    , .SolutionTruckModDate = Date.Now _
                                                    , .SolutionTruckModUser = Parameters.UserName _
                                                    , .SolutionTruckUpdated = If(d.SolutionTruckUpdated Is Nothing, New Byte() {}, d.SolutionTruckUpdated)}

    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Return GettblSolutionTruckFiltered(Control:=CType(LinqTable, LTS.tblSolutionTruck).SolutionTruckControl)
    End Function

    Protected Overrides Function GetQuickSaveResults(ByVal LinqTable As Object) As DataTransferObjects.QuickSaveResults

        Dim ret As DTO.QuickSaveResults
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim source As LTS.tblSolutionTruck = TryCast(LinqTable, LTS.tblSolutionTruck)
                If source Is Nothing Then Return Nothing

                ret = (From d In db.tblSolutionTrucks _
                       Where d.SolutionTruckControl = source.SolutionTruckControl _
                       Select New DTO.QuickSaveResults With {.Control = d.SolutionTruckControl _
                                                            , .ModDate = d.SolutionTruckModDate _
                                                            , .ModUser = d.SolutionTruckModUser _
                                                            , .Updated = d.SolutionTruckUpdated.ToArray}).First

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

        End Using
        Return ret
    End Function


#End Region

End Class

Public Class NGLtblSolutionDetailData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.tblSolutionDetails
        Me.LinqDB = db
    End Sub

#End Region

#Region " Properties "

    Protected Overrides Property LinqTable() As Object
        Get
            Dim db As New NGLMasBookDataContext(ConnectionString)
            Me.LinqTable = db.tblSolutionDetails
            Me.LinqDB = db
            Return _LinqTable
        End Get
        Set(ByVal value As Object)
            _LinqTable = value
        End Set
    End Property

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GettblSolutionDetailFiltered(Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return Nothing
    End Function

    ''' <summary>
    ''' The LowerControl parameter allows for a starting control number to be providced. 
    ''' The FKControl parameter is a reference to the Solution Truck Control Number.
    ''' </summary>
    ''' <param name="LowerControl"></param>
    ''' <param name="FKControl"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overrides Function GetFirstRecord(ByVal LowerControl As Long, _
                                             ByVal FKControl As Long) As DataTransferObjects.DTOBaseClass

        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                Dim tblSolutionDetail As New DTO.tblSolutionDetail

                tblSolutionDetail = ( _
                From d In db.tblSolutionDetails _
                Where (LowerControl = 0 OrElse d.SolutionDetailControl >= LowerControl) _
                And _
                (d.SolutionDetailSolutionTruckControl = FKControl) _
                Order By d.SolutionDetailControl _
                Select New DTO.tblSolutionDetail With {.SolutionDetailControl = d.SolutionDetailControl _
                                                      , .SolutionDetailSolutionTruckControl = d.SolutionDetailSolutionTruckControl _
                                                      , .SolutionDetailBookControl = d.SolutionDetailBookControl _
                                                      , .SolutionDetailPOHdrControl = d.SolutionDetailPOHdrControl _
                                                      , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                                                      , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                                                      , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                                                      , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                                                      , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                                                      , .SolutionDetailCom = d.SolutionDetailCom _
                                                      , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                                                      , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                                                      , .SolutionDetailCompNumber = d.SolutionDetailCompNumber _
                                                      , .SolutionDetailCompName = d.SolutionDetailCompName _
                                                      , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                                                      , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                                                      , .SolutionDetailODControl = d.SolutionDetailODControl _
                                                      , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                                                      , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                                                      , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                                                      , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                                                      , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                                                      , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                                                      , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                                                      , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                                                      , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                                                      , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                                                      , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                                                      , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                                                      , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                                                      , .SolutionDetailDestName = d.SolutionDetailDestName _
                                                      , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                                                      , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                                                      , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                                                      , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                                                      , .SolutionDetailDestState = d.SolutionDetailDestState _
                                                      , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                                                      , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                                                      , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                                                      , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                                                      , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                                                      , .SolutionDetailTotalCases = d.SolutionDetailTotalCases _
                                                      , .SolutionDetailTotalWgt = d.SolutionDetailTotalWgt _
                                                      , .SolutionDetailTotalPL = d.SolutionDetailTotalPL _
                                                      , .SolutionDetailTotalCube = d.SolutionDetailTotalCube _
                                                      , .SolutionDetailTotalPX = d.SolutionDetailTotalPX _
                                                      , .SolutionDetailTotalBFC = d.SolutionDetailTotalBFC _
                                                      , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                                                      , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                                                      , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                                                      , .SolutionDetailStopNo = d.SolutionDetailStopNo _
                                                      , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                                                      , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                                                      , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                                                      , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                                                      , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                                                      , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                                                      , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                                                      , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                                                      , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                                                      , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                                                      , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                                                      , .SolutionDetailTransType = d.SolutionDetailTransType _
                                                      , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                                                      , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                                                      , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                                                      , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                                                      , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                                                      , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                                                      , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                                                      , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                                                      , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                                                      , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                                                      , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                                                      , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                                                      , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                                                      , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                                                      , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                                                      , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                                                      , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                                                      , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                                                      , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                                                      , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                                                      , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                                                      , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                                                      , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                                                      , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                                                      , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                                                      , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                                                      , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                                                      , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                                                      , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                                                      , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                                                      , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                                                      , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                                                      , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                                                      , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                                                      , .SolutionDetailInbound = d.SolutionDetailInbound _
                                                      , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                                                      , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                                                      , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                                                      , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                                                      , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                                                      , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray()}).FirstOrDefault


                Return tblSolutionDetail


            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary>
    ''' The CurrentControl parameter is the seed for the previous record.
    ''' The FKControl parameter is a reference to the Solution Truck Control Number.
    ''' </summary>
    ''' <param name="CurrentControl"></param>
    ''' <param name="FKControl"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overrides Function GetPreviousRecord(ByVal CurrentControl As Long, _
                                                ByVal FKControl As Long) As DataTransferObjects.DTOBaseClass
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                Dim tblSolutionDetail As New DTO.tblSolutionDetail

                tblSolutionDetail = ( _
                From d In db.tblSolutionDetails _
                Where d.SolutionDetailControl < CurrentControl _
                And _
                (d.SolutionDetailSolutionTruckControl = FKControl) _
                Order By d.SolutionDetailBookControl Descending _
                Select New DTO.tblSolutionDetail With {.SolutionDetailControl = d.SolutionDetailControl _
                                                      , .SolutionDetailSolutionTruckControl = d.SolutionDetailSolutionTruckControl _
                                                      , .SolutionDetailBookControl = d.SolutionDetailBookControl _
                                                      , .SolutionDetailPOHdrControl = d.SolutionDetailPOHdrControl _
                                                      , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                                                      , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                                                      , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                                                      , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                                                      , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                                                      , .SolutionDetailCom = d.SolutionDetailCom _
                                                      , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                                                      , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                                                      , .SolutionDetailCompNumber = d.SolutionDetailCompNumber _
                                                      , .SolutionDetailCompName = d.SolutionDetailCompName _
                                                      , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                                                      , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                                                      , .SolutionDetailODControl = d.SolutionDetailODControl _
                                                      , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                                                      , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                                                      , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                                                      , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                                                      , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                                                      , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                                                      , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                                                      , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                                                      , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                                                      , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                                                      , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                                                      , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                                                      , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                                                      , .SolutionDetailDestName = d.SolutionDetailDestName _
                                                      , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                                                      , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                                                      , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                                                      , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                                                      , .SolutionDetailDestState = d.SolutionDetailDestState _
                                                      , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                                                      , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                                                      , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                                                      , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                                                      , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                                                      , .SolutionDetailTotalCases = d.SolutionDetailTotalCases _
                                                      , .SolutionDetailTotalWgt = d.SolutionDetailTotalWgt _
                                                      , .SolutionDetailTotalPL = d.SolutionDetailTotalPL _
                                                      , .SolutionDetailTotalCube = d.SolutionDetailTotalCube _
                                                      , .SolutionDetailTotalPX = d.SolutionDetailTotalPX _
                                                      , .SolutionDetailTotalBFC = d.SolutionDetailTotalBFC _
                                                      , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                                                      , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                                                      , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                                                      , .SolutionDetailStopNo = d.SolutionDetailStopNo _
                                                      , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                                                      , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                                                      , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                                                      , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                                                      , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                                                      , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                                                      , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                                                      , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                                                      , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                                                      , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                                                      , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                                                      , .SolutionDetailTransType = d.SolutionDetailTransType _
                                                      , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                                                      , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                                                      , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                                                      , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                                                      , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                                                      , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                                                      , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                                                      , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                                                      , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                                                      , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                                                      , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                                                      , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                                                      , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                                                      , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                                                      , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                                                      , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                                                      , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                                                      , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                                                      , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                                                      , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                                                      , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                                                      , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                                                      , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                                                      , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                                                      , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                                                      , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                                                      , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                                                      , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                                                      , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                                                      , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                                                      , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                                                      , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                                                      , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                                                      , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                                                      , .SolutionDetailInbound = d.SolutionDetailInbound _
                                                      , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                                                      , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                                                      , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                                                      , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                                                      , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                                                      , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray()}).FirstOrDefault

                Return tblSolutionDetail

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary>
    ''' The LowerControl parameter allows for a starting control number to be providced.
    ''' The FKControl parameter is a reference to the Solution Truck Control Number.
    ''' </summary>
    ''' <param name="CurrentControl"></param>
    ''' <param name="FKControl"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overrides Function GetNextRecord(ByVal CurrentControl As Long, _
                                             ByVal FKControl As Long) As DataTransferObjects.DTOBaseClass
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'For the test we use the book table and the bookload data is ignored.  
                'The final query will need to use a view that selects the book load data because
                'We need the temperature.
                Dim tblSolutionDetail As New DTO.tblSolutionDetail


                tblSolutionDetail = ( _
               From d In db.tblSolutionDetails _
               Where d.SolutionDetailControl > CurrentControl _
                And _
                (d.SolutionDetailSolutionTruckControl = FKControl) _
               Order By d.SolutionDetailBookControl _
               Select New DTO.tblSolutionDetail With {.SolutionDetailControl = d.SolutionDetailControl _
                                                      , .SolutionDetailSolutionTruckControl = d.SolutionDetailSolutionTruckControl _
                                                      , .SolutionDetailBookControl = d.SolutionDetailBookControl _
                                                      , .SolutionDetailPOHdrControl = d.SolutionDetailPOHdrControl _
                                                      , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                                                      , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                                                      , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                                                      , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                                                      , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                                                      , .SolutionDetailCom = d.SolutionDetailCom _
                                                      , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                                                      , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                                                      , .SolutionDetailCompNumber = d.SolutionDetailCompNumber _
                                                      , .SolutionDetailCompName = d.SolutionDetailCompName _
                                                      , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                                                      , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                                                      , .SolutionDetailODControl = d.SolutionDetailODControl _
                                                      , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                                                      , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                                                      , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                                                      , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                                                      , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                                                      , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                                                      , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                                                      , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                                                      , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                                                      , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                                                      , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                                                      , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                                                      , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                                                      , .SolutionDetailDestName = d.SolutionDetailDestName _
                                                      , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                                                      , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                                                      , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                                                      , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                                                      , .SolutionDetailDestState = d.SolutionDetailDestState _
                                                      , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                                                      , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                                                      , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                                                      , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                                                      , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                                                      , .SolutionDetailTotalCases = d.SolutionDetailTotalCases _
                                                      , .SolutionDetailTotalWgt = d.SolutionDetailTotalWgt _
                                                      , .SolutionDetailTotalPL = d.SolutionDetailTotalPL _
                                                      , .SolutionDetailTotalCube = d.SolutionDetailTotalCube _
                                                      , .SolutionDetailTotalPX = d.SolutionDetailTotalPX _
                                                      , .SolutionDetailTotalBFC = d.SolutionDetailTotalBFC _
                                                      , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                                                      , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                                                      , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                                                      , .SolutionDetailStopNo = d.SolutionDetailStopNo _
                                                      , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                                                      , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                                                      , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                                                      , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                                                      , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                                                      , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                                                      , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                                                      , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                                                      , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                                                      , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                                                      , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                                                      , .SolutionDetailTransType = d.SolutionDetailTransType _
                                                      , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                                                      , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                                                      , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                                                      , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                                                      , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                                                      , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                                                      , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                                                      , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                                                      , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                                                      , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                                                      , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                                                      , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                                                      , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                                                      , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                                                      , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                                                      , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                                                      , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                                                      , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                                                      , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                                                      , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                                                      , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                                                      , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                                                      , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                                                      , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                                                      , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                                                      , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                                                      , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                                                      , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                                                      , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                                                      , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                                                      , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                                                      , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                                                      , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                                                      , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                                                      , .SolutionDetailInbound = d.SolutionDetailInbound _
                                                      , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                                                      , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                                                      , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                                                      , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                                                      , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                                                      , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray()}).FirstOrDefault


                Return tblSolutionDetail

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary>
    ''' The UpperControl parameter allows for a starting control number to be providced.
    ''' The FKControl parameter is a reference to the Solution Truck Control Number.
    ''' </summary>
    ''' <param name="UpperControl"></param>
    ''' <param name="FKControl"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overrides Function GetLastRecord(ByVal UpperControl As Long, _
                                             ByVal FKControl As Long) As DataTransferObjects.DTOBaseClass
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim tblSolutionDetail As New DTO.tblSolutionDetail

                If UpperControl <> 0 Then


                    tblSolutionDetail = ( _
                    From d In db.tblSolutionDetails _
                    Where d.SolutionDetailControl >= UpperControl _
                    And _
                    (d.SolutionDetailSolutionTruckControl = FKControl) _
                    Order By d.SolutionDetailBookControl _
                    Select New DTO.tblSolutionDetail With {.SolutionDetailControl = d.SolutionDetailControl _
                                                      , .SolutionDetailSolutionTruckControl = d.SolutionDetailSolutionTruckControl _
                                                      , .SolutionDetailBookControl = d.SolutionDetailBookControl _
                                                      , .SolutionDetailPOHdrControl = d.SolutionDetailPOHdrControl _
                                                      , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                                                      , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                                                      , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                                                      , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                                                      , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                                                      , .SolutionDetailCom = d.SolutionDetailCom _
                                                      , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                                                      , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                                                      , .SolutionDetailCompNumber = d.SolutionDetailCompNumber _
                                                      , .SolutionDetailCompName = d.SolutionDetailCompName _
                                                      , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                                                      , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                                                      , .SolutionDetailODControl = d.SolutionDetailODControl _
                                                      , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                                                      , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                                                      , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                                                      , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                                                      , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                                                      , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                                                      , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                                                      , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                                                      , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                                                      , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                                                      , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                                                      , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                                                      , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                                                      , .SolutionDetailDestName = d.SolutionDetailDestName _
                                                      , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                                                      , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                                                      , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                                                      , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                                                      , .SolutionDetailDestState = d.SolutionDetailDestState _
                                                      , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                                                      , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                                                      , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                                                      , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                                                      , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                                                      , .SolutionDetailTotalCases = d.SolutionDetailTotalCases _
                                                      , .SolutionDetailTotalWgt = d.SolutionDetailTotalWgt _
                                                      , .SolutionDetailTotalPL = d.SolutionDetailTotalPL _
                                                      , .SolutionDetailTotalCube = d.SolutionDetailTotalCube _
                                                      , .SolutionDetailTotalPX = d.SolutionDetailTotalPX _
                                                      , .SolutionDetailTotalBFC = d.SolutionDetailTotalBFC _
                                                      , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                                                      , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                                                      , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                                                      , .SolutionDetailStopNo = d.SolutionDetailStopNo _
                                                      , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                                                      , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                                                      , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                                                      , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                                                      , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                                                      , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                                                      , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                                                      , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                                                      , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                                                      , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                                                      , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                                                      , .SolutionDetailTransType = d.SolutionDetailTransType _
                                                      , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                                                      , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                                                      , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                                                      , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                                                      , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                                                      , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                                                      , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                                                      , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                                                      , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                                                      , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                                                      , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                                                      , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                                                      , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                                                      , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                                                      , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                                                      , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                                                      , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                                                      , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                                                      , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                                                      , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                                                      , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                                                      , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                                                      , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                                                      , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                                                      , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                                                      , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                                                      , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                                                      , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                                                      , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                                                      , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                                                      , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                                                      , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                                                      , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                                                      , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                                                      , .SolutionDetailInbound = d.SolutionDetailInbound _
                                                      , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                                                      , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                                                      , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                                                      , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                                                      , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                                                      , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray()}).FirstOrDefault

                Else



                    tblSolutionDetail = ( _
                    From d In db.tblSolutionDetails _
                    Where (d.SolutionDetailSolutionTruckControl = FKControl) _
                    Order By d.SolutionDetailBookControl Descending _
                    Select New DTO.tblSolutionDetail With {.SolutionDetailControl = d.SolutionDetailControl _
                                                  , .SolutionDetailSolutionTruckControl = d.SolutionDetailSolutionTruckControl _
                                                  , .SolutionDetailBookControl = d.SolutionDetailBookControl _
                                                  , .SolutionDetailPOHdrControl = d.SolutionDetailPOHdrControl _
                                                  , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                                                  , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                                                  , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                                                  , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                                                  , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                                                  , .SolutionDetailCom = d.SolutionDetailCom _
                                                  , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                                                  , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                                                  , .SolutionDetailCompNumber = d.SolutionDetailCompNumber _
                                                  , .SolutionDetailCompName = d.SolutionDetailCompName _
                                                  , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                                                  , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                                                  , .SolutionDetailODControl = d.SolutionDetailODControl _
                                                  , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                                                  , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                                                  , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                                                  , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                                                  , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                                                  , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                                                  , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                                                  , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                                                  , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                                                  , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                                                  , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                                                  , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                                                  , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                                                  , .SolutionDetailDestName = d.SolutionDetailDestName _
                                                  , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                                                  , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                                                  , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                                                  , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                                                  , .SolutionDetailDestState = d.SolutionDetailDestState _
                                                  , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                                                  , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                                                  , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                                                  , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                                                  , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                                                  , .SolutionDetailTotalCases = d.SolutionDetailTotalCases _
                                                  , .SolutionDetailTotalWgt = d.SolutionDetailTotalWgt _
                                                  , .SolutionDetailTotalPL = d.SolutionDetailTotalPL _
                                                  , .SolutionDetailTotalCube = d.SolutionDetailTotalCube _
                                                  , .SolutionDetailTotalPX = d.SolutionDetailTotalPX _
                                                  , .SolutionDetailTotalBFC = d.SolutionDetailTotalBFC _
                                                  , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                                                  , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                                                  , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                                                  , .SolutionDetailStopNo = d.SolutionDetailStopNo _
                                                  , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                                                  , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                                                  , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                                                  , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                                                  , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                                                  , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                                                  , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                                                  , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                                                  , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                                                  , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                                                  , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                                                  , .SolutionDetailTransType = d.SolutionDetailTransType _
                                                  , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                                                  , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                                                  , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                                                  , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                                                  , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                                                  , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                                                  , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                                                  , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                                                  , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                                                  , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                                                  , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                                                  , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                                                  , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                                                  , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                                                  , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                                                  , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                                                  , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                                                  , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                                                  , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                                                  , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                                                  , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                                                  , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                                                  , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                                                  , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                                                  , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                                                  , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                                                  , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                                                  , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                                                  , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                                                  , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                                                  , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                                                  , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                                                  , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                                                  , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                                                  , .SolutionDetailInbound = d.SolutionDetailInbound _
                                                  , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                                                  , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                                                  , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                                                  , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                                                  , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                                                  , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray()}).FirstOrDefault
                End If


                Return tblSolutionDetail

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GettblSolutionDetailFiltered(ByVal Control As Long) As DTO.tblSolutionDetail
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'Get the newest record that matches the provided criteria
                Dim tblSolutionDetail As DTO.tblSolutionDetail = ( _
                From d In db.tblSolutionDetails _
                Where _
                    d.SolutionDetailControl = Control _
                Select New DTO.tblSolutionDetail With {.SolutionDetailControl = d.SolutionDetailControl _
                                                      , .SolutionDetailSolutionTruckControl = d.SolutionDetailSolutionTruckControl _
                                                      , .SolutionDetailBookControl = d.SolutionDetailBookControl _
                                                      , .SolutionDetailPOHdrControl = d.SolutionDetailPOHdrControl _
                                                      , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                                                      , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                                                      , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                                                      , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                                                      , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                                                      , .SolutionDetailCom = d.SolutionDetailCom _
                                                      , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                                                      , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                                                      , .SolutionDetailCompNumber = d.SolutionDetailCompNumber _
                                                      , .SolutionDetailCompName = d.SolutionDetailCompName _
                                                      , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                                                      , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                                                      , .SolutionDetailODControl = d.SolutionDetailODControl _
                                                      , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                                                      , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                                                      , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                                                      , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                                                      , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                                                      , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                                                      , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                                                      , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                                                      , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                                                      , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                                                      , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                                                      , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                                                      , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                                                      , .SolutionDetailDestName = d.SolutionDetailDestName _
                                                      , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                                                      , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                                                      , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                                                      , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                                                      , .SolutionDetailDestState = d.SolutionDetailDestState _
                                                      , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                                                      , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                                                      , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                                                      , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                                                      , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                                                      , .SolutionDetailTotalCases = d.SolutionDetailTotalCases _
                                                      , .SolutionDetailTotalWgt = d.SolutionDetailTotalWgt _
                                                      , .SolutionDetailTotalPL = d.SolutionDetailTotalPL _
                                                      , .SolutionDetailTotalCube = d.SolutionDetailTotalCube _
                                                      , .SolutionDetailTotalPX = d.SolutionDetailTotalPX _
                                                      , .SolutionDetailTotalBFC = d.SolutionDetailTotalBFC _
                                                      , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                                                      , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                                                      , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                                                      , .SolutionDetailStopNo = d.SolutionDetailStopNo _
                                                      , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                                                      , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                                                      , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                                                      , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                                                      , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                                                      , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                                                      , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                                                      , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                                                      , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                                                      , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                                                      , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                                                      , .SolutionDetailTransType = d.SolutionDetailTransType _
                                                      , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                                                      , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                                                      , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                                                      , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                                                      , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                                                      , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                                                      , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                                                      , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                                                      , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                                                      , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                                                      , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                                                      , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                                                      , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                                                      , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                                                      , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                                                      , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                                                      , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                                                      , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                                                      , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                                                      , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                                                      , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                                                      , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                                                      , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                                                      , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                                                      , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                                                      , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                                                      , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                                                      , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                                                      , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                                                      , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                                                      , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                                                      , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                                                      , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                                                      , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                                                      , .SolutionDetailInbound = d.SolutionDetailInbound _
                                                      , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                                                      , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                                                      , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                                                      , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                                                      , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                                                      , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray()}).First


                Return tblSolutionDetail

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GettblSolutionDetailsFiltered(ByVal SolutionTruckControl As Long, _
                                           Optional ByVal page As Integer = 1, _
                                           Optional ByVal pagesize As Integer = 1000) As DTO.tblSolutionDetail()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                Dim intRecordCount As Integer = 0
                Dim intPageCount As Integer = 1

                Dim qRet = From d In db.tblSolutionDetails _
                    Where (d.SolutionDetailSolutionTruckControl = SolutionTruckControl) Select d.SolutionDetailControl

                If Not qRet Is Nothing AndAlso qRet.Count > 0 Then

                    intRecordCount = qRet.Count

                    If pagesize < 1 Then pagesize = 1
                    If intRecordCount < 1 Then intRecordCount = 1
                    If page < 1 Then page = 1
                    If intRecordCount > pagesize Then intPageCount = ((intRecordCount - 1) \ pagesize) + 1
                    Dim intSkip As Integer = (page - 1) * pagesize

                    'Return all the contacts that match the criteria sorted by name
                    Dim tblSolutionDetails() As DTO.tblSolutionDetail = ( _
                    From d In db.tblSolutionDetails _
                    Where qRet.Contains(d.SolutionDetailControl) _
                    Order By d.SolutionDetailControl Descending _
                    Select New DTO.tblSolutionDetail With {.SolutionDetailControl = d.SolutionDetailControl _
                                                          , .SolutionDetailSolutionTruckControl = d.SolutionDetailSolutionTruckControl _
                                                          , .SolutionDetailBookControl = d.SolutionDetailBookControl _
                                                          , .SolutionDetailPOHdrControl = d.SolutionDetailPOHdrControl _
                                                          , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                                                          , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                                                          , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                                                          , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                                                          , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                                                          , .SolutionDetailCom = d.SolutionDetailCom _
                                                          , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                                                          , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                                                          , .SolutionDetailCompNumber = d.SolutionDetailCompNumber _
                                                          , .SolutionDetailCompName = d.SolutionDetailCompName _
                                                          , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                                                          , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                                                          , .SolutionDetailODControl = d.SolutionDetailODControl _
                                                          , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                                                          , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                                                          , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                                                          , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                                                          , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                                                          , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                                                          , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                                                          , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                                                          , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                                                          , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                                                          , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                                                          , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                                                          , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                                                          , .SolutionDetailDestName = d.SolutionDetailDestName _
                                                          , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                                                          , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                                                          , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                                                          , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                                                          , .SolutionDetailDestState = d.SolutionDetailDestState _
                                                          , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                                                          , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                                                          , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                                                          , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                                                          , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                                                          , .SolutionDetailTotalCases = d.SolutionDetailTotalCases _
                                                          , .SolutionDetailTotalWgt = d.SolutionDetailTotalWgt _
                                                          , .SolutionDetailTotalPL = d.SolutionDetailTotalPL _
                                                          , .SolutionDetailTotalCube = d.SolutionDetailTotalCube _
                                                          , .SolutionDetailTotalPX = d.SolutionDetailTotalPX _
                                                          , .SolutionDetailTotalBFC = d.SolutionDetailTotalBFC _
                                                          , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                                                          , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                                                          , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                                                          , .SolutionDetailStopNo = d.SolutionDetailStopNo _
                                                          , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                                                          , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                                                          , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                                                          , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                                                          , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                                                          , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                                                          , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                                                          , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                                                          , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                                                          , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                                                          , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                                                          , .SolutionDetailTransType = d.SolutionDetailTransType _
                                                          , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                                                          , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                                                          , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                                                          , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                                                          , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                                                          , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                                                          , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                                                          , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                                                          , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                                                          , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                                                          , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                                                          , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                                                          , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                                                          , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                                                          , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                                                          , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                                                          , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                                                          , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                                                          , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                                                          , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                                                          , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                                                          , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                                                          , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                                                          , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                                                          , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                                                          , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                                                          , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                                                          , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                                                          , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                                                          , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                                                          , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                                                          , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                                                          , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                                                          , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                                                          , .SolutionDetailInbound = d.SolutionDetailInbound _
                                                          , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                                                          , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                                                          , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                                                          , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                                                          , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                                                          , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray() _
                                                          , .Page = page _
                                                          , .Pages = intPageCount _
                                                          , .PageSize = pagesize}).Skip(intSkip).Take(pagesize).ToArray()

                    Return tblSolutionDetails
                Else
                    Return Nothing
                End If

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

#End Region

#Region "Protected Functions"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Dim d = CType(oData, DTO.tblSolutionDetail)
        'Create New Record
        Return New LTS.tblSolutionDetail With {.SolutionDetailControl = d.SolutionDetailControl _
                                                    , .SolutionDetailSolutionTruckControl = d.SolutionDetailSolutionTruckControl _
                                                    , .SolutionDetailBookControl = d.SolutionDetailBookControl _
                                                    , .SolutionDetailPOHdrControl = d.SolutionDetailPOHdrControl _
                                                    , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                                                    , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                                                    , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                                                    , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                                                    , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                                                    , .SolutionDetailCom = d.SolutionDetailCom _
                                                    , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                                                    , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                                                    , .SolutionDetailCompNumber = d.SolutionDetailCompNumber _
                                                    , .SolutionDetailCompName = d.SolutionDetailCompName _
                                                    , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                                                    , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                                                    , .SolutionDetailODControl = d.SolutionDetailODControl _
                                                    , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                                                    , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                                                    , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                                                    , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                                                    , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                                                    , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                                                    , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                                                    , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                                                    , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                                                    , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                                                    , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                                                    , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                                                    , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                                                    , .SolutionDetailDestName = d.SolutionDetailDestName _
                                                    , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                                                    , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                                                    , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                                                    , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                                                    , .SolutionDetailDestState = d.SolutionDetailDestState _
                                                    , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                                                    , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                                                    , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                                                    , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                                                    , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                                                    , .SolutionDetailTotalCases = d.SolutionDetailTotalCases _
                                                    , .SolutionDetailTotalWgt = d.SolutionDetailTotalWgt _
                                                    , .SolutionDetailTotalPL = d.SolutionDetailTotalPL _
                                                    , .SolutionDetailTotalCube = d.SolutionDetailTotalCube _
                                                    , .SolutionDetailTotalPX = d.SolutionDetailTotalPX _
                                                    , .SolutionDetailTotalBFC = d.SolutionDetailTotalBFC _
                                                    , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                                                    , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                                                    , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                                                    , .SolutionDetailStopNo = d.SolutionDetailStopNo _
                                                    , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                                                    , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                                                    , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                                                    , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                                                    , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                                                    , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                                                    , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                                                    , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                                                    , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                                                    , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                                                    , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                                                    , .SolutionDetailTransType = d.SolutionDetailTransType _
                                                    , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                                                    , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                                                    , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                                                    , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                                                    , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                                                    , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                                                    , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                                                    , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                                                    , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                                                    , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                                                    , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                                                    , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                                                    , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                                                    , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                                                    , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                                                    , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                                                    , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                                                    , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                                                    , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                                                    , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                                                    , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                                                    , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                                                    , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                                                    , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                                                    , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                                                    , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                                                    , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                                                    , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                                                    , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                                                    , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                                                    , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                                                    , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                                                    , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                                                    , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                                                    , .SolutionDetailInbound = d.SolutionDetailInbound _
                                                    , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                                                    , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                                                    , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                                                    , .SolutionDetailModDate = Date.Now _
                                                    , .SolutionDetailModUser = Parameters.UserName _
                                                    , .SolutionDetailUpdated = If(d.SolutionDetailUpdated Is Nothing, New Byte() {}, d.SolutionDetailUpdated)}

    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Return GettblSolutionDetailFiltered(Control:=CType(LinqTable, LTS.tblSolutionDetail).SolutionDetailControl)
    End Function

    Protected Overrides Function GetQuickSaveResults(ByVal LinqTable As Object) As DataTransferObjects.QuickSaveResults

        Dim ret As DTO.QuickSaveResults
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim source As LTS.tblSolutionDetail = TryCast(LinqTable, LTS.tblSolutionDetail)
                If source Is Nothing Then Return Nothing

                ret = (From d In db.tblSolutionDetails _
                       Where d.SolutionDetailControl = source.SolutionDetailControl _
                       Select New DTO.QuickSaveResults With {.Control = d.SolutionDetailControl _
                                                            , .ModDate = d.SolutionDetailModDate _
                                                            , .ModUser = d.SolutionDetailModUser _
                                                            , .Updated = d.SolutionDetailUpdated.ToArray}).First

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

        End Using
        Return ret
    End Function


#End Region

End Class

Public Class NGLLoadPlanningData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.tblSolutions
        Me.LinqDB = db
    End Sub

#End Region

#Region " Properties "

    Protected Overrides Property LinqTable() As Object
        Get
            Dim db As New NGLMasBookDataContext(ConnectionString)
            Me.LinqTable = db.tblSolutions
            Me.LinqDB = db
            Return _LinqTable
        End Get
        Set(ByVal value As Object)
            _LinqTable = value
        End Set
    End Property

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return GettblSolutionFiltered(Control)
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return Nothing
    End Function

    ''' <summary>
    ''' The LowerControl parameter allows for a starting control number to be provided.
    ''' The FKControl parameter is a reference to the Comp Control Number.  If a NatAccountNumber is provided the 
    ''' FKcontrol is ignored
    ''' </summary>
    ''' <param name="LowerControl"></param>
    ''' <param name="FKControl"></param>
    ''' <param name="FromDate"></param>
    ''' <param name="ToDate"></param>
    ''' <param name="UseCreateDate"></param>
    ''' <param name="UseCommittedDate"></param>
    ''' <param name="UseArchivedDate"></param>
    ''' <param name="NatAccountNumber"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overloads Function GetFirstRecord(ByVal LowerControl As Long, _
                                             ByVal FKControl As Long, _
                                             ByVal FromDate As Date, _
                                             ByVal ToDate As Date, _
                                             ByVal UseCreateDate As Boolean, _
                                             ByVal UseCommittedDate As Boolean, _
                                             ByVal UseArchivedDate As Boolean, _
                                             ByVal NatAccountNumber As Integer) As DataTransferObjects.DTOBaseClass

        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                Dim tblSolution As New DTO.tblSolution
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                Dim oSecureNat = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName And s.CompNatNumber <> 0 Select s.CompNatNumber

                tblSolution = ( _
                From d In db.tblSolutions
                Where (LowerControl = 0 OrElse d.SolutionControl >= LowerControl) _
                And _
                (NatAccountNumber <> 0 OrElse (d.SolutionCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionCompControl)))) _
                And _
                (If(UseCreateDate Or UseCommittedDate Or UseArchivedDate, _
                    If(UseCreateDate, _
                        (d.SolutionCreateDate >= FromDate And d.SolutionCreateDate < ToDate.AddDays(1)), _
                        If(UseCommittedDate, _
                            (d.SolutionCommittedDate >= FromDate And d.SolutionCommittedDate < ToDate.AddDays(1)), _
                            (d.SolutionArchivedDate >= FromDate And d.SolutionArchivedDate < ToDate.AddDays(1)))), _
                    True
                    ) _
                ) _
                And _
                (NatAccountNumber = 0 OrElse (d.SolutionCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionCompNatNumber)))) _
                Order By d.SolutionControl _
                Select New DTO.tblSolution With {.SolutionControl = d.SolutionControl _
                                                    , .SolutionAttributeControl = d.SolutionAttributeControl _
                                                    , .SolutionAttributeTypeControl = d.SolutionAttributeTypeControl _
                                                    , .SolutionName = d.SolutionName _
                                                    , .SolutionDescription = d.SolutionDescription _
                                                    , .SolutionCompControl = d.SolutionCompControl _
                                                    , .SolutionCompNumber = d.SolutionCompNumber _
                                                    , .SolutionCompName = d.SolutionCompName _
                                                    , .SolutionCompNatNumber = d.SolutionCompNatNumber _
                                                    , .SolutionCompNatName = d.SolutionCompNatName _
                                                    , .SolutionCreateDate = d.SolutionCreateDate _
                                                    , .SolutionTotalCases = d.SolutionTotalCases _
                                                    , .SolutionTotalWgt = d.SolutionTotalWgt _
                                                    , .SolutionTotalPL = d.SolutionTotalPL _
                                                    , .SolutionTotalCube = d.SolutionTotalCube _
                                                    , .SolutionTotalPX = d.SolutionTotalPX _
                                                    , .SolutionTotalBFC = d.SolutionTotalBFC _
                                                    , .SolutionTotalOrders = d.SolutionTotalOrders _
                                                    , .SolutionTotalTLCost = d.SolutionTotalTLCost _
                                                    , .SolutionTotalMPCost = d.SolutionTotalMPCost _
                                                    , .SolutionTotalPoolCost = d.SolutionTotalPoolCost _
                                                    , .SolutionTotalLTLPoolCost = d.SolutionTotalLTLPoolCost _
                                                    , .SolutionTotalLTLCost = d.SolutionTotalLTLCost _
                                                    , .SolutionTotalCost = d.SolutionTotalCost _
                                                    , .SolutionTotalTrucks = d.SolutionTotalTrucks _
                                                    , .SolutionTotalMiles = d.SolutionTotalMiles _
                                                    , .SolutionCommitted = d.SolutionCommitted _
                                                    , .SolutionCommittedDate = d.SolutionCommittedDate _
                                                    , .SolutionArchived = d.SolutionArchived _
                                                    , .SolutionArchivedDate = d.SolutionArchivedDate _
                                                    , .SolutionModDate = d.SolutionModDate _
                                                    , .SolutionModUser = d.SolutionModUser _
                                                    , .SolutionUpdated = d.SolutionUpdated.ToArray()}).FirstOrDefault

                Return tblSolution

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary>
    ''' The CurrentControl is the seed control value.
    ''' The FKControl parameter is a reference to the Comp Control Number.  If a NatAccountNumber is provided the 
    ''' FKcontrol is ignored.
    ''' </summary>
    ''' <param name="CurrentControl"></param>
    ''' <param name="FKControl"></param>
    ''' <param name="FromDate"></param>
    ''' <param name="ToDate"></param>
    ''' <param name="UseCreateDate"></param>
    ''' <param name="UseCommittedDate"></param>
    ''' <param name="UseArchivedDate"></param>
    ''' <param name="NatAccountNumber"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overloads Function GetPreviousRecord(ByVal CurrentControl As Long, _
                                                 ByVal FKControl As Long, _
                                                 ByVal FromDate As Date, _
                                                 ByVal ToDate As Date, _
                                                 ByVal UseCreateDate As Boolean, _
                                                 ByVal UseCommittedDate As Boolean, _
                                                 ByVal UseArchivedDate As Boolean, _
                                                 ByVal NatAccountNumber As Integer) As DataTransferObjects.DTOBaseClass
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                Dim tblSolution As New DTO.tblSolution
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                Dim oSecureNat = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName And s.CompNatNumber <> 0 Select s.CompNatNumber


                tblSolution = ( _
                From d In db.tblSolutions _
                Where d.SolutionControl < CurrentControl _
                And _
                (NatAccountNumber <> 0 OrElse (d.SolutionCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionCompControl)))) _
                And _
                (If(UseCreateDate Or UseCommittedDate Or UseArchivedDate, _
                    If(UseCreateDate, _
                        (d.SolutionCreateDate >= FromDate And d.SolutionCreateDate < ToDate.AddDays(1)), _
                        If(UseCommittedDate, _
                            (d.SolutionCommittedDate >= FromDate And d.SolutionCommittedDate < ToDate.AddDays(1)), _
                            (d.SolutionArchivedDate >= FromDate And d.SolutionArchivedDate < ToDate.AddDays(1)))), _
                    True
                    ) _
                ) _
                And _
                (NatAccountNumber = 0 OrElse (d.SolutionCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionCompNatNumber)))) _
                Order By d.SolutionControl Descending _
                Select New DTO.tblSolution With {.SolutionControl = d.SolutionControl _
                                                    , .SolutionAttributeControl = d.SolutionAttributeControl _
                                                    , .SolutionAttributeTypeControl = d.SolutionAttributeTypeControl _
                                                    , .SolutionName = d.SolutionName _
                                                    , .SolutionDescription = d.SolutionDescription _
                                                    , .SolutionCompControl = d.SolutionCompControl _
                                                    , .SolutionCompNumber = d.SolutionCompNumber _
                                                    , .SolutionCompName = d.SolutionCompName _
                                                    , .SolutionCompNatNumber = d.SolutionCompNatNumber _
                                                    , .SolutionCompNatName = d.SolutionCompNatName _
                                                    , .SolutionCreateDate = d.SolutionCreateDate _
                                                    , .SolutionTotalCases = d.SolutionTotalCases _
                                                    , .SolutionTotalWgt = d.SolutionTotalWgt _
                                                    , .SolutionTotalPL = d.SolutionTotalPL _
                                                    , .SolutionTotalCube = d.SolutionTotalCube _
                                                    , .SolutionTotalPX = d.SolutionTotalPX _
                                                    , .SolutionTotalBFC = d.SolutionTotalBFC _
                                                    , .SolutionTotalOrders = d.SolutionTotalOrders _
                                                    , .SolutionTotalTLCost = d.SolutionTotalTLCost _
                                                    , .SolutionTotalMPCost = d.SolutionTotalMPCost _
                                                    , .SolutionTotalPoolCost = d.SolutionTotalPoolCost _
                                                    , .SolutionTotalLTLPoolCost = d.SolutionTotalLTLPoolCost _
                                                    , .SolutionTotalLTLCost = d.SolutionTotalLTLCost _
                                                    , .SolutionTotalCost = d.SolutionTotalCost _
                                                    , .SolutionTotalTrucks = d.SolutionTotalTrucks _
                                                    , .SolutionTotalMiles = d.SolutionTotalMiles _
                                                    , .SolutionCommitted = d.SolutionCommitted _
                                                    , .SolutionCommittedDate = d.SolutionCommittedDate _
                                                    , .SolutionArchived = d.SolutionArchived _
                                                    , .SolutionArchivedDate = d.SolutionArchivedDate _
                                                    , .SolutionModDate = d.SolutionModDate _
                                                    , .SolutionModUser = d.SolutionModUser _
                                                    , .SolutionUpdated = d.SolutionUpdated.ToArray()}).FirstOrDefault

                Return tblSolution

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary>
    ''' The CurrentControl is the seed control value.
    ''' The FKControl parameter is a reference to the Comp Control Number.  If a NatAccountNumber is provided the 
    ''' FKcontrol is ignored.
    ''' </summary>
    ''' <param name="CurrentControl"></param>
    ''' <param name="FKControl"></param>
    ''' <param name="FromDate"></param>
    ''' <param name="ToDate"></param>
    ''' <param name="UseCreateDate"></param>
    ''' <param name="UseCommittedDate"></param>
    ''' <param name="UseArchivedDate"></param>
    ''' <param name="NatAccountNumber"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overloads Function GetNextRecord(ByVal CurrentControl As Long, _
                                            ByVal FKControl As Long, _
                                            ByVal FromDate As Date, _
                                            ByVal ToDate As Date, _
                                             ByVal UseCreateDate As Boolean, _
                                             ByVal UseCommittedDate As Boolean, _
                                             ByVal UseArchivedDate As Boolean, _
                                             ByVal NatAccountNumber As Integer) As DataTransferObjects.DTOBaseClass
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                Dim tblSolution As New DTO.tblSolution
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                Dim oSecureNat = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName And s.CompNatNumber <> 0 Select s.CompNatNumber


                tblSolution = ( _
                   From d In db.tblSolutions _
                   Where d.SolutionControl > CurrentControl _
                   And _
                   (NatAccountNumber <> 0 OrElse (d.SolutionCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionCompControl)))) _
                    And _
                    (If(UseCreateDate Or UseCommittedDate Or UseArchivedDate, _
                        If(UseCreateDate, _
                            (d.SolutionCreateDate >= FromDate And d.SolutionCreateDate < ToDate.AddDays(1)), _
                            If(UseCommittedDate, _
                                (d.SolutionCommittedDate >= FromDate And d.SolutionCommittedDate < ToDate.AddDays(1)), _
                                (d.SolutionArchivedDate >= FromDate And d.SolutionArchivedDate < ToDate.AddDays(1)))), _
                        True
                        ) _
                    ) _
                    And _
                    (NatAccountNumber = 0 OrElse (d.SolutionCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionCompNatNumber)))) _
                    Order By d.SolutionControl _
                   Select New DTO.tblSolution With {.SolutionControl = d.SolutionControl _
                                                    , .SolutionAttributeControl = d.SolutionAttributeControl _
                                                    , .SolutionAttributeTypeControl = d.SolutionAttributeTypeControl _
                                                    , .SolutionName = d.SolutionName _
                                                    , .SolutionDescription = d.SolutionDescription _
                                                    , .SolutionCompControl = d.SolutionCompControl _
                                                    , .SolutionCompNumber = d.SolutionCompNumber _
                                                    , .SolutionCompName = d.SolutionCompName _
                                                    , .SolutionCompNatNumber = d.SolutionCompNatNumber _
                                                    , .SolutionCompNatName = d.SolutionCompNatName _
                                                    , .SolutionCreateDate = d.SolutionCreateDate _
                                                    , .SolutionTotalCases = d.SolutionTotalCases _
                                                    , .SolutionTotalWgt = d.SolutionTotalWgt _
                                                    , .SolutionTotalPL = d.SolutionTotalPL _
                                                    , .SolutionTotalCube = d.SolutionTotalCube _
                                                    , .SolutionTotalPX = d.SolutionTotalPX _
                                                    , .SolutionTotalBFC = d.SolutionTotalBFC _
                                                    , .SolutionTotalOrders = d.SolutionTotalOrders _
                                                    , .SolutionTotalTLCost = d.SolutionTotalTLCost _
                                                    , .SolutionTotalMPCost = d.SolutionTotalMPCost _
                                                    , .SolutionTotalPoolCost = d.SolutionTotalPoolCost _
                                                    , .SolutionTotalLTLPoolCost = d.SolutionTotalLTLPoolCost _
                                                    , .SolutionTotalLTLCost = d.SolutionTotalLTLCost _
                                                    , .SolutionTotalCost = d.SolutionTotalCost _
                                                    , .SolutionTotalTrucks = d.SolutionTotalTrucks _
                                                    , .SolutionTotalMiles = d.SolutionTotalMiles _
                                                    , .SolutionCommitted = d.SolutionCommitted _
                                                    , .SolutionCommittedDate = d.SolutionCommittedDate _
                                                    , .SolutionArchived = d.SolutionArchived _
                                                    , .SolutionArchivedDate = d.SolutionArchivedDate _
                                                    , .SolutionModDate = d.SolutionModDate _
                                                    , .SolutionModUser = d.SolutionModUser _
                                                    , .SolutionUpdated = d.SolutionUpdated.ToArray()}).FirstOrDefault

                Return tblSolution

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    ''' <summary>
    ''' The UpperControl parameter allows for a starting control number to be provided.
    ''' The FKControl parameter is a reference to the Comp Control Number.  If a NatAccountNumber is provided the 
    ''' FKcontrol is ignored
    ''' </summary>
    ''' <param name="UpperControl"></param>
    ''' <param name="FKControl"></param>
    ''' <param name="FromDate"></param>
    ''' <param name="ToDate"></param>
    ''' <param name="UseCreateDate"></param>
    ''' <param name="UseCommittedDate"></param>
    ''' <param name="UseArchivedDate"></param>
    ''' <param name="NatAccountNumber"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Overloads Function GetLastRecord(ByVal UpperControl As Long, _
                                            ByVal FKControl As Long, _
                                            ByVal FromDate As Date, _
                                            ByVal ToDate As Date, _
                                             ByVal UseCreateDate As Boolean, _
                                             ByVal UseCommittedDate As Boolean, _
                                             ByVal UseArchivedDate As Boolean, _
                                             ByVal NatAccountNumber As Integer) As DataTransferObjects.DTOBaseClass
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim tblSolution As New DTO.tblSolution
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                Dim oSecureNat = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName And s.CompNatNumber <> 0 Select s.CompNatNumber

                If UpperControl <> 0 Then
                    tblSolution = ( _
                    From d In db.tblSolutions _
                    Where d.SolutionControl >= UpperControl _
                    And _
                    (NatAccountNumber <> 0 OrElse (d.SolutionCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionCompControl)))) _
                    And _
                    (If(UseCreateDate Or UseCommittedDate Or UseArchivedDate, _
                        If(UseCreateDate, _
                            (d.SolutionCreateDate >= FromDate And d.SolutionCreateDate < ToDate.AddDays(1)), _
                            If(UseCommittedDate, _
                                (d.SolutionCommittedDate >= FromDate And d.SolutionCommittedDate < ToDate.AddDays(1)), _
                                (d.SolutionArchivedDate >= FromDate And d.SolutionArchivedDate < ToDate.AddDays(1)))), _
                        True
                        ) _
                    ) _
                    And _
                    (NatAccountNumber = 0 OrElse (d.SolutionCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionCompNatNumber)))) _
                    Order By d.SolutionControl _
                    Select New DTO.tblSolution With {.SolutionControl = d.SolutionControl _
                                                    , .SolutionAttributeControl = d.SolutionAttributeControl _
                                                    , .SolutionAttributeTypeControl = d.SolutionAttributeTypeControl _
                                                    , .SolutionName = d.SolutionName _
                                                    , .SolutionDescription = d.SolutionDescription _
                                                    , .SolutionCompControl = d.SolutionCompControl _
                                                    , .SolutionCompNumber = d.SolutionCompNumber _
                                                    , .SolutionCompName = d.SolutionCompName _
                                                    , .SolutionCompNatNumber = d.SolutionCompNatNumber _
                                                    , .SolutionCompNatName = d.SolutionCompNatName _
                                                    , .SolutionCreateDate = d.SolutionCreateDate _
                                                    , .SolutionTotalCases = d.SolutionTotalCases _
                                                    , .SolutionTotalWgt = d.SolutionTotalWgt _
                                                    , .SolutionTotalPL = d.SolutionTotalPL _
                                                    , .SolutionTotalCube = d.SolutionTotalCube _
                                                    , .SolutionTotalPX = d.SolutionTotalPX _
                                                    , .SolutionTotalBFC = d.SolutionTotalBFC _
                                                    , .SolutionTotalOrders = d.SolutionTotalOrders _
                                                    , .SolutionTotalTLCost = d.SolutionTotalTLCost _
                                                    , .SolutionTotalMPCost = d.SolutionTotalMPCost _
                                                    , .SolutionTotalPoolCost = d.SolutionTotalPoolCost _
                                                    , .SolutionTotalLTLPoolCost = d.SolutionTotalLTLPoolCost _
                                                    , .SolutionTotalLTLCost = d.SolutionTotalLTLCost _
                                                    , .SolutionTotalCost = d.SolutionTotalCost _
                                                    , .SolutionTotalTrucks = d.SolutionTotalTrucks _
                                                    , .SolutionTotalMiles = d.SolutionTotalMiles _
                                                    , .SolutionCommitted = d.SolutionCommitted _
                                                    , .SolutionCommittedDate = d.SolutionCommittedDate _
                                                    , .SolutionArchived = d.SolutionArchived _
                                                    , .SolutionArchivedDate = d.SolutionArchivedDate _
                                                    , .SolutionModDate = d.SolutionModDate _
                                                    , .SolutionModUser = d.SolutionModUser _
                                                    , .SolutionUpdated = d.SolutionUpdated.ToArray()}).FirstOrDefault

                Else
                    tblSolution = ( _
                    From d In db.tblSolutions _
                    Where _
                    (NatAccountNumber <> 0 OrElse (d.SolutionCompControl = FKControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionCompControl)))) _
                    And _
                    (If(UseCreateDate Or UseCommittedDate Or UseArchivedDate, _
                        If(UseCreateDate, _
                            (d.SolutionCreateDate >= FromDate And d.SolutionCreateDate < ToDate.AddDays(1)), _
                            If(UseCommittedDate, _
                                (d.SolutionCommittedDate >= FromDate And d.SolutionCommittedDate < ToDate.AddDays(1)), _
                                (d.SolutionArchivedDate >= FromDate And d.SolutionArchivedDate < ToDate.AddDays(1)))), _
                        True
                        ) _
                    ) _
                    And _
                    (NatAccountNumber = 0 OrElse (d.SolutionCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionCompNatNumber)))) _
                    Order By d.SolutionControl Descending _
                    Select New DTO.tblSolution With {.SolutionControl = d.SolutionControl _
                                                    , .SolutionAttributeControl = d.SolutionAttributeControl _
                                                    , .SolutionAttributeTypeControl = d.SolutionAttributeTypeControl _
                                                    , .SolutionName = d.SolutionName _
                                                    , .SolutionDescription = d.SolutionDescription _
                                                    , .SolutionCompControl = d.SolutionCompControl _
                                                    , .SolutionCompNumber = d.SolutionCompNumber _
                                                    , .SolutionCompName = d.SolutionCompName _
                                                    , .SolutionCompNatNumber = d.SolutionCompNatNumber _
                                                    , .SolutionCompNatName = d.SolutionCompNatName _
                                                    , .SolutionCreateDate = d.SolutionCreateDate _
                                                    , .SolutionTotalCases = d.SolutionTotalCases _
                                                    , .SolutionTotalWgt = d.SolutionTotalWgt _
                                                    , .SolutionTotalPL = d.SolutionTotalPL _
                                                    , .SolutionTotalCube = d.SolutionTotalCube _
                                                    , .SolutionTotalPX = d.SolutionTotalPX _
                                                    , .SolutionTotalBFC = d.SolutionTotalBFC _
                                                    , .SolutionTotalOrders = d.SolutionTotalOrders _
                                                    , .SolutionTotalTLCost = d.SolutionTotalTLCost _
                                                    , .SolutionTotalMPCost = d.SolutionTotalMPCost _
                                                    , .SolutionTotalPoolCost = d.SolutionTotalPoolCost _
                                                    , .SolutionTotalLTLPoolCost = d.SolutionTotalLTLPoolCost _
                                                    , .SolutionTotalLTLCost = d.SolutionTotalLTLCost _
                                                    , .SolutionTotalCost = d.SolutionTotalCost _
                                                    , .SolutionTotalTrucks = d.SolutionTotalTrucks _
                                                    , .SolutionTotalMiles = d.SolutionTotalMiles _
                                                    , .SolutionCommitted = d.SolutionCommitted _
                                                    , .SolutionCommittedDate = d.SolutionCommittedDate _
                                                    , .SolutionArchived = d.SolutionArchived _
                                                    , .SolutionArchivedDate = d.SolutionArchivedDate _
                                                    , .SolutionModDate = d.SolutionModDate _
                                                    , .SolutionModUser = d.SolutionModUser _
                                                    , .SolutionUpdated = d.SolutionUpdated.ToArray()}).FirstOrDefault

                End If

                Return tblSolution

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GettblSolutionFiltered(ByVal Control As Integer) As DTO.tblSolution
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'Get the newest record that matches the provided criteria
                Dim tblSolution As DTO.tblSolution = ( _
                From d In db.tblSolutions _
                Where _
                    d.SolutionControl = Control _
                Select New DTO.tblSolution With {.SolutionControl = d.SolutionControl _
                                                , .SolutionAttributeControl = d.SolutionAttributeControl _
                                                , .SolutionAttributeTypeControl = d.SolutionAttributeTypeControl _
                                                , .SolutionName = d.SolutionName _
                                                , .SolutionDescription = d.SolutionDescription _
                                                , .SolutionCompControl = d.SolutionCompControl _
                                                , .SolutionCompNumber = d.SolutionCompNumber _
                                                , .SolutionCompName = d.SolutionCompName _
                                                , .SolutionCreateDate = d.SolutionCreateDate _
                                                , .SolutionTotalCases = d.SolutionTotalCases _
                                                , .SolutionTotalWgt = d.SolutionTotalWgt _
                                                , .SolutionTotalPL = d.SolutionTotalPL _
                                                , .SolutionTotalCube = d.SolutionTotalCube _
                                                , .SolutionTotalPX = d.SolutionTotalPX _
                                                , .SolutionTotalBFC = d.SolutionTotalBFC _
                                                , .SolutionTotalOrders = d.SolutionTotalOrders _
                                                , .SolutionTotalTLCost = d.SolutionTotalTLCost _
                                                , .SolutionTotalMPCost = d.SolutionTotalMPCost _
                                                , .SolutionTotalPoolCost = d.SolutionTotalPoolCost _
                                                , .SolutionTotalLTLPoolCost = d.SolutionTotalLTLPoolCost _
                                                , .SolutionTotalLTLCost = d.SolutionTotalLTLCost _
                                                , .SolutionTotalCost = d.SolutionTotalCost _
                                                , .SolutionTotalTrucks = d.SolutionTotalTrucks _
                                                , .SolutionTotalMiles = d.SolutionTotalMiles _
                                                , .SolutionCommitted = d.SolutionCommitted _
                                                , .SolutionCommittedDate = d.SolutionCommittedDate _
                                                , .SolutionArchived = d.SolutionArchived _
                                                , .SolutionArchivedDate = d.SolutionArchivedDate _
                                                , .SolutionModDate = d.SolutionModDate _
                                                , .SolutionModUser = d.SolutionModUser _
                                                , .SolutionUpdated = d.SolutionUpdated.ToArray()}).First


                Return tblSolution

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GettblSolutionsFiltered(ByVal CompanyControl As Integer, _
                                      ByVal FromDate As Date, _
                                      ByVal ToDate As Date, _
                                      ByVal UseCreateDate As Boolean, _
                                      ByVal UseCommittedDate As Boolean, _
                                      ByVal UseArchivedDate As Boolean, _
                                      ByVal NatAccountNumber As Integer, _
                                      Optional ByVal page As Integer = 1, _
                                      Optional ByVal pagesize As Integer = 1000) As DTO.tblSolution()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim oSecureComp = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName Select s.CompControl
                Dim oSecureNat = From s In db.vUserAdminWithCompControlRefBooks Where s.UserAdminUserName = Me.Parameters.UserName And s.CompNatNumber <> 0 Select s.CompNatNumber

                Dim intRecordCount As Integer = 0
                Dim intPageCount As Integer = 1

                Dim qRet = From d In db.tblSolutions _
                    Where (NatAccountNumber <> 0 OrElse (d.SolutionCompControl = CompanyControl And (oSecureComp Is Nothing OrElse oSecureComp.Count = 0 OrElse oSecureComp.Contains(d.SolutionCompControl)))) _
                    And _
                    (If(UseCreateDate Or UseCommittedDate Or UseArchivedDate, _
                        If(UseCreateDate, _
                            (d.SolutionCreateDate >= FromDate And d.SolutionCreateDate < ToDate.AddDays(1)), _
                            If(UseCommittedDate, _
                                (d.SolutionCommittedDate >= FromDate And d.SolutionCommittedDate < ToDate.AddDays(1)), _
                                (d.SolutionArchivedDate >= FromDate And d.SolutionArchivedDate < ToDate.AddDays(1)))), _
                        True
                        ) _
                    ) _
                    And _
                    (NatAccountNumber = 0 OrElse (d.SolutionCompNatNumber = NatAccountNumber And (oSecureNat Is Nothing OrElse oSecureNat.Count = 0 OrElse oSecureNat.Contains(d.SolutionCompNatNumber)))) _
                    And _
                    (d.SolutionModUser = Parameters.UserName) _
                    Select d.SolutionControl

                If Not qRet Is Nothing AndAlso qRet.Count > 0 Then

                    intRecordCount = qRet.Count

                    If pagesize < 1 Then pagesize = 1
                    If intRecordCount < 1 Then intRecordCount = 1
                    If page < 1 Then page = 1
                    If intRecordCount > pagesize Then intPageCount = ((intRecordCount - 1) \ pagesize) + 1
                    Dim intSkip As Integer = (page - 1) * pagesize
                    'Return all the contacts that match the criteria sorted by name
                    Dim tblSolutions() As DTO.tblSolution = ( _
                    From d In db.tblSolutions _
                    Where qRet.Contains(d.SolutionControl) _
                    Order By d.SolutionControl _
                    Select New DTO.tblSolution With {.SolutionControl = d.SolutionControl _
                                                    , .SolutionAttributeControl = d.SolutionAttributeControl _
                                                    , .SolutionAttributeTypeControl = d.SolutionAttributeTypeControl _
                                                    , .SolutionName = d.SolutionName _
                                                    , .SolutionDescription = d.SolutionDescription _
                                                    , .SolutionCompControl = d.SolutionCompControl _
                                                    , .SolutionCompNumber = d.SolutionCompNumber _
                                                    , .SolutionCompName = d.SolutionCompName _
                                                    , .SolutionCompNatNumber = d.SolutionCompNatNumber _
                                                    , .SolutionCompNatName = d.SolutionCompNatName _
                                                    , .SolutionCreateDate = d.SolutionCreateDate _
                                                    , .SolutionTotalCases = d.SolutionTotalCases _
                                                    , .SolutionTotalWgt = d.SolutionTotalWgt _
                                                    , .SolutionTotalPL = d.SolutionTotalPL _
                                                    , .SolutionTotalCube = d.SolutionTotalCube _
                                                    , .SolutionTotalPX = d.SolutionTotalPX _
                                                    , .SolutionTotalBFC = d.SolutionTotalBFC _
                                                    , .SolutionTotalOrders = d.SolutionTotalOrders _
                                                    , .SolutionTotalTLCost = d.SolutionTotalTLCost _
                                                    , .SolutionTotalMPCost = d.SolutionTotalMPCost _
                                                    , .SolutionTotalPoolCost = d.SolutionTotalPoolCost _
                                                    , .SolutionTotalLTLPoolCost = d.SolutionTotalLTLPoolCost _
                                                    , .SolutionTotalLTLCost = d.SolutionTotalLTLCost _
                                                    , .SolutionTotalCost = d.SolutionTotalCost _
                                                    , .SolutionTotalTrucks = d.SolutionTotalTrucks _
                                                    , .SolutionTotalMiles = d.SolutionTotalMiles _
                                                    , .SolutionCommitted = d.SolutionCommitted _
                                                    , .SolutionCommittedDate = d.SolutionCommittedDate _
                                                    , .SolutionArchived = d.SolutionArchived _
                                                    , .SolutionArchivedDate = d.SolutionArchivedDate _
                                                    , .SolutionModDate = d.SolutionModDate _
                                                    , .SolutionModUser = d.SolutionModUser _
                                                    , .SolutionUpdated = d.SolutionUpdated.ToArray()}).ToArray()
                    Return tblSolutions
                Else
                    Return Nothing
                End If

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

#End Region

#Region "Protected Functions"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Dim d = CType(oData, DTO.tblSolution)
        If d.SolutionAttributeTypeControl = 0 Then
            Try
                'try to get the default attrubute type control for this data object
                d.SolutionAttributeTypeControl = New NGLLookupDataProvider(Me.Parameters).GetAttributeTypeControl("tblSolution", "Load Planning Solution Attributes")
            Catch ex As FaultException
                'ignore any fault exceptions just leave the value at zero
            Catch ex As Exception
                Throw
            End Try
        End If
        'Create New Record
        Return New LTS.tblSolution With {.SolutionControl = d.SolutionControl _
                                                    , .SolutionAttributeControl = d.SolutionAttributeControl _
                                                    , .SolutionAttributeTypeControl = d.SolutionAttributeTypeControl _
                                                    , .SolutionName = d.SolutionName _
                                                    , .SolutionDescription = d.SolutionDescription _
                                                    , .SolutionCompControl = d.SolutionCompControl _
                                                    , .SolutionCompNumber = d.SolutionCompNumber _
                                                    , .SolutionCompName = d.SolutionCompName _
                                                    , .SolutionCompNatNumber = d.SolutionCompNatNumber _
                                                    , .SolutionCompNatName = d.SolutionCompNatName _
                                                    , .SolutionCreateDate = If(d.SolutionCreateDate.HasValue, d.SolutionCreateDate, Date.Now) _
                                                    , .SolutionTotalCases = d.SolutionTotalCases _
                                                    , .SolutionTotalWgt = d.SolutionTotalWgt _
                                                    , .SolutionTotalPL = d.SolutionTotalPL _
                                                    , .SolutionTotalCube = d.SolutionTotalCube _
                                                    , .SolutionTotalPX = d.SolutionTotalPX _
                                                    , .SolutionTotalBFC = d.SolutionTotalBFC _
                                                    , .SolutionTotalOrders = d.SolutionTotalOrders _
                                                    , .SolutionTotalTLCost = d.SolutionTotalTLCost _
                                                    , .SolutionTotalMPCost = d.SolutionTotalMPCost _
                                                    , .SolutionTotalPoolCost = d.SolutionTotalPoolCost _
                                                    , .SolutionTotalLTLPoolCost = d.SolutionTotalLTLPoolCost _
                                                    , .SolutionTotalLTLCost = d.SolutionTotalLTLCost _
                                                    , .SolutionTotalCost = d.SolutionTotalCost _
                                                    , .SolutionTotalTrucks = d.SolutionTotalTrucks _
                                                    , .SolutionTotalMiles = d.SolutionTotalMiles _
                                                    , .SolutionCommitted = d.SolutionCommitted _
                                                    , .SolutionCommittedDate = d.SolutionCommittedDate _
                                                    , .SolutionArchived = d.SolutionArchived _
                                                    , .SolutionArchivedDate = d.SolutionArchivedDate _
                                                    , .SolutionModDate = Date.Now _
                                                    , .SolutionModUser = Parameters.UserName _
                                                    , .SolutionUpdated = If(d.SolutionUpdated Is Nothing, New Byte() {}, d.SolutionUpdated)}

    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Return GettblSolutionFiltered(Control:=CType(LinqTable, LTS.tblSolution).SolutionControl)
    End Function

    Protected Overrides Function GetQuickSaveResults(ByVal LinqTable As Object) As DataTransferObjects.QuickSaveResults
        Dim ret As DTO.QuickSaveResults
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim source As LTS.tblSolution = TryCast(LinqTable, LTS.tblSolution)
                If source Is Nothing Then Return Nothing

                ret = (From d In db.tblSolutions _
                       Where d.SolutionControl = source.SolutionControl _
                       Select New DTO.QuickSaveResults With {.Control = d.SolutionControl _
                                                            , .ModDate = d.SolutionModDate _
                                                            , .ModUser = d.SolutionModUser _
                                                            , .Updated = d.SolutionUpdated.ToArray}).First

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

        End Using
        Return ret
    End Function

#End Region

End Class

Public Class NGLLoadPlanningTruckData : Inherits NDPBaseClass

#Region " Constructors "

    Public Sub New(ByVal oParameters As WCFParameters)
        MyBase.New()
        processParameters(oParameters)
        Dim db As New NGLMasBookDataContext(ConnectionString)
        Me.LinqTable = db.tblSolutionTrucks
        Me.LinqDB = db
    End Sub

#End Region

#Region " Properties "

    Private Shared mSharedLoadsBeingRouted As Boolean = False
    Private Shared mSharedLastOrderNumber As String = "New Process No Order Number"
    Private Shared mSharedOrdersToRoute As New List(Of DTO.tblSolutionDetail)
    Private Shared mSharedPadLock As New Object

    Protected Overrides Property LinqTable() As Object
        Get
            Dim db As New NGLMasBookDataContext(ConnectionString)
            Me.LinqTable = db.tblSolutionTrucks
            Me.LinqDB = db
            Return _LinqTable
        End Get
        Set(ByVal value As Object)
            _LinqTable = value
        End Set
    End Property

    Private _TempCNSSeed As Integer = 0
    Public ReadOnly Property TempCNSSeed As String
        Get
            _TempCNSSeed += 1
            Return _TempCNSSeed.ToString
        End Get
    End Property

    Private _OrdersNotLoaded As List(Of DTO.tblSolutionDetail)
    Public Property OrdersNotLoaded As List(Of DTO.tblSolutionDetail)
        Get
            If _OrdersNotLoaded Is Nothing Then _OrdersNotLoaded = New List(Of DTO.tblSolutionDetail)
            Return _OrdersNotLoaded
        End Get
        Set(value As List(Of DTO.tblSolutionDetail))
            _OrdersNotLoaded = value
        End Set
    End Property

    Private _TrucksReadyToTender As List(Of DTO.tblSolutionTruck)
    Public Property TrucksReadyToTender As List(Of DTO.tblSolutionTruck)
        Get
            Return _TrucksReadyToTender
        End Get
        Set(value As List(Of DTO.tblSolutionTruck))
            _TrucksReadyToTender = value
        End Set
    End Property

    Private _ListAvailableEquipment As New List(Of DTO.CarriersForRoute)
    Public Property ListAvailableEquipment As List(Of DTO.CarriersForRoute)
        Get
            If _ListAvailableEquipment Is Nothing Then _ListAvailableEquipment = New List(Of DTO.CarriersForRoute)
            Return _ListAvailableEquipment
        End Get
        Set(value As List(Of DTO.CarriersForRoute))
            _ListAvailableEquipment = value
        End Set
    End Property

    Private _StaticRouteData As DTO.tblStaticRoute
    Public Property StaticRouteData As DTO.tblStaticRoute
        Get
            Return _StaticRouteData
        End Get
        Set(value As DTO.tblStaticRoute)
            _StaticRouteData = value
        End Set
    End Property

    'Public gblnFillLargestFirst As Boolean = False
    'Public ListAvailableEquipment As New List(Of clsTruck2)
    'Public gblnOptimizeCapacity As Boolean = False
#End Region

#Region "Delegates"

    Public Delegate Sub ProcessDataDelegate(ByRef lOrders As List(Of DTO.tblSolutionDetail), ByVal OptimizeCapacity As Boolean)
    Public Delegate Sub ProcessUnRoutedDataDelegate(ByRef lOrders As List(Of DTO.tblSolutionDetail))

#End Region

#Region "Public Methods"

    Public Overrides Function GetRecordFiltered(Optional ByVal Control As Integer = 0) As DataTransferObjects.DTOBaseClass
        Return Nothing
    End Function

    Public Overrides Function GetRecordsFiltered() As DataTransferObjects.DTOBaseClass()
        Return Nothing
    End Function

    ' ''' <summary>
    ' ''' The LowerControl parameter allows for a starting control number to be providced. 
    ' ''' The FKControl parameter is a reference to the Solution Control Number.
    ' ''' </summary>
    ' ''' <param name="LowerControl"></param>
    ' ''' <param name="FKControl"></param>
    ' ''' <param name="RouteTypeCode"></param>
    ' ''' <returns></returns>
    ' ''' <remarks></remarks>
    'Public Overloads Function GetFirstRecord(ByVal LowerControl As Long, _
    '                                         ByVal FKControl As Long, _
    '                                         ByVal RouteTypeCode As Integer) As DataTransferObjects.DTOBaseClass

    '    Using db As New NGLMasBookDataContext(ConnectionString)
    '        Try

    '            Dim tblSolutionTruck As New DTO.tblSolutionTruck

    '            tblSolutionTruck = ( _
    '            From d In db.tblSolutionTrucks _
    '            Where (LowerControl = 0 OrElse d.SolutionTruckControl >= LowerControl) _
    '            And _
    '            (d.SolutionTruckSolutionControl = FKControl) _
    '            And _
    '            (RouteTypeCode = 0 OrElse d.SolutionTruckRouteTypeCode = RouteTypeCode) _
    '            Order By d.SolutionTruckControl _
    '            Select New DTO.tblSolutionTruck With {.SolutionTruckControl = d.SolutionTruckControl _
    '                                                  , .SolutionTruckSolutionControl = d.SolutionTruckSolutionControl _
    '                                                  , .SolutionTruckCom = d.SolutionTruckCom _
    '                                                  , .SolutionTruckConsPrefix = d.SolutionTruckConsPrefix _
    '                                                  , .SolutionTruckRouteConsFlag = d.SolutionTruckRouteConsFlag _
    '                                                  , .SolutionTruckCarrierControl = d.SolutionTruckCarrierControl _
    '                                                  , .SolutionTruckCarrierNumber = d.SolutionTruckCarrierNumber _
    '                                                  , .SolutionTruckCarrierName = d.SolutionTruckCarrierName _
    '                                                  , .SolutionTruckCarrierTruckControl = d.SolutionTruckCarrierTruckControl _
    '                                                  , .SolutionTruckCarrierTruckDescription = d.SolutionTruckCarrierTruckDescription _
    '                                                  , .SolutionTruckTotalCases = d.SolutionTruckTotalCases _
    '                                                  , .SolutionTruckTotalWgt = d.SolutionTruckTotalWgt _
    '                                                  , .SolutionTruckTotalPL = d.SolutionTruckTotalPL _
    '                                                  , .SolutionTruckTotalCube = d.SolutionTruckTotalCube _
    '                                                  , .SolutionTruckTotalPX = d.SolutionTruckTotalPX _
    '                                                  , .SolutionTruckTotalBFC = d.SolutionTruckTotalBFC _
    '                                                  , .SolutionTruckTotalOrders = d.SolutionTruckTotalOrders _
    '                                                  , .SolutionTruckTotalCost = d.SolutionTruckTotalCost _
    '                                                  , .SolutionTruckTotalMiles = d.SolutionTruckTotalMiles _
    '                                                  , .SolutionTruckCarrierEquipmentCodes = d.SolutionTruckCarrierEquipmentCodes _
    '                                                  , .SolutionTruckRouteTypeCode = d.SolutionTruckRouteTypeCode _
    '                                                  , .SolutionTruckCommitted = d.SolutionTruckCommitted _
    '                                                  , .SolutionTruckCommittedDate = d.SolutionTruckCommittedDate _
    '                                                  , .SolutionTruckModDate = d.SolutionTruckModDate _
    '                                                  , .SolutionTruckModUser = d.SolutionTruckModUser _
    '                                                  , .SolutionTruckUpdated = d.SolutionTruckUpdated.ToArray()}).FirstOrDefault


    '            Return tblSolutionTruck


    '        Catch ex As System.Data.SqlClient.SqlException
    '            Utilities.SaveAppError(ex.Message, Me.Parameters)
    '            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
    '        Catch ex As InvalidOperationException
    '            Utilities.SaveAppError(ex.Message, Me.Parameters)
    '            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
    '        Catch ex As Exception
    '            Utilities.SaveAppError(ex.Message, Me.Parameters)
    '            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
    '        End Try

    '        Return Nothing

    '    End Using
    'End Function

    ' ''' <summary>
    ' ''' The CurrentControl parameter is the seed for the previous record.
    ' ''' The FKControl parameter is a reference to the Solution Control Number.
    ' ''' </summary>
    ' ''' <param name="CurrentControl"></param>
    ' ''' <param name="FKControl"></param>
    ' ''' <param name="RouteTypeCode"></param>
    ' ''' <returns></returns>
    ' ''' <remarks></remarks>
    'Public Overloads Function GetPreviousRecord(ByVal CurrentControl As Long, _
    '                                            ByVal FKControl As Long, _
    '                                            ByVal RouteTypeCode As Integer) As DataTransferObjects.DTOBaseClass
    '    Using db As New NGLMasBookDataContext(ConnectionString)
    '        Try

    '            Dim tblSolutionTruck As New DTO.tblSolutionTruck

    '            tblSolutionTruck = ( _
    '            From d In db.tblSolutionTrucks _
    '            Where d.SolutionTruckControl < CurrentControl _
    '            And _
    '            (d.SolutionTruckSolutionControl = FKControl) _
    '            And _
    '            (RouteTypeCode = 0 OrElse d.SolutionTruckRouteTypeCode = RouteTypeCode) _
    '            Order By d.SolutionTruckControl Descending _
    '            Select New DTO.tblSolutionTruck With {.SolutionTruckControl = d.SolutionTruckControl _
    '                                                  , .SolutionTruckSolutionControl = d.SolutionTruckSolutionControl _
    '                                                  , .SolutionTruckCom = d.SolutionTruckCom _
    '                                                  , .SolutionTruckConsPrefix = d.SolutionTruckConsPrefix _
    '                                                  , .SolutionTruckRouteConsFlag = d.SolutionTruckRouteConsFlag _
    '                                                  , .SolutionTruckCarrierControl = d.SolutionTruckCarrierControl _
    '                                                  , .SolutionTruckCarrierNumber = d.SolutionTruckCarrierNumber _
    '                                                  , .SolutionTruckCarrierName = d.SolutionTruckCarrierName _
    '                                                  , .SolutionTruckCarrierTruckControl = d.SolutionTruckCarrierTruckControl _
    '                                                  , .SolutionTruckCarrierTruckDescription = d.SolutionTruckCarrierTruckDescription _
    '                                                  , .SolutionTruckTotalCases = d.SolutionTruckTotalCases _
    '                                                  , .SolutionTruckTotalWgt = d.SolutionTruckTotalWgt _
    '                                                  , .SolutionTruckTotalPL = d.SolutionTruckTotalPL _
    '                                                  , .SolutionTruckTotalCube = d.SolutionTruckTotalCube _
    '                                                  , .SolutionTruckTotalPX = d.SolutionTruckTotalPX _
    '                                                  , .SolutionTruckTotalBFC = d.SolutionTruckTotalBFC _
    '                                                  , .SolutionTruckTotalOrders = d.SolutionTruckTotalOrders _
    '                                                  , .SolutionTruckTotalCost = d.SolutionTruckTotalCost _
    '                                                  , .SolutionTruckTotalMiles = d.SolutionTruckTotalMiles _
    '                                                  , .SolutionTruckCarrierEquipmentCodes = d.SolutionTruckCarrierEquipmentCodes _
    '                                                  , .SolutionTruckRouteTypeCode = d.SolutionTruckRouteTypeCode _
    '                                                  , .SolutionTruckCommitted = d.SolutionTruckCommitted _
    '                                                  , .SolutionTruckCommittedDate = d.SolutionTruckCommittedDate _
    '                                                  , .SolutionTruckModDate = d.SolutionTruckModDate _
    '                                                  , .SolutionTruckModUser = d.SolutionTruckModUser _
    '                                                  , .SolutionTruckUpdated = d.SolutionTruckUpdated.ToArray()}).FirstOrDefault

    '            Return tblSolutionTruck

    '        Catch ex As System.Data.SqlClient.SqlException
    '            Utilities.SaveAppError(ex.Message, Me.Parameters)
    '            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
    '        Catch ex As InvalidOperationException
    '            Utilities.SaveAppError(ex.Message, Me.Parameters)
    '            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
    '        Catch ex As Exception
    '            Utilities.SaveAppError(ex.Message, Me.Parameters)
    '            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
    '        End Try

    '        Return Nothing

    '    End Using
    'End Function

    ' ''' <summary>
    ' ''' The LowerControl parameter allows for a starting control number to be providced.
    ' ''' The FKControl parameter is a reference to the Solution Control Number.
    ' ''' </summary>
    ' ''' <param name="CurrentControl"></param>
    ' ''' <param name="FKControl"></param>
    ' ''' <param name="RouteTypeCode"></param>
    ' ''' <returns></returns>
    ' ''' <remarks></remarks>
    'Public Overloads Function GetNextRecord(ByVal CurrentControl As Long, _
    '                                         ByVal FKControl As Long, _
    '                                         ByVal RouteTypeCode As Integer) As DataTransferObjects.DTOBaseClass

    '    Using db As New NGLMasBookDataContext(ConnectionString)
    '        Try

    '            Dim tblSolutionTruck As New DTO.tblSolutionTruck

    '            tblSolutionTruck = ( _
    '           From d In db.tblSolutionTrucks _
    '           Where d.SolutionTruckControl > CurrentControl _
    '            And _
    '            (d.SolutionTruckSolutionControl = FKControl) _
    '            And _
    '            (RouteTypeCode = 0 OrElse d.SolutionTruckRouteTypeCode = RouteTypeCode) _
    '            Order By d.SolutionTruckControl _
    '           Select New DTO.tblSolutionTruck With {.SolutionTruckControl = d.SolutionTruckControl _
    '                                                  , .SolutionTruckSolutionControl = d.SolutionTruckSolutionControl _
    '                                                  , .SolutionTruckCom = d.SolutionTruckCom _
    '                                                  , .SolutionTruckConsPrefix = d.SolutionTruckConsPrefix _
    '                                                  , .SolutionTruckRouteConsFlag = d.SolutionTruckRouteConsFlag _
    '                                                  , .SolutionTruckCarrierControl = d.SolutionTruckCarrierControl _
    '                                                  , .SolutionTruckCarrierNumber = d.SolutionTruckCarrierNumber _
    '                                                  , .SolutionTruckCarrierName = d.SolutionTruckCarrierName _
    '                                                  , .SolutionTruckCarrierTruckControl = d.SolutionTruckCarrierTruckControl _
    '                                                  , .SolutionTruckCarrierTruckDescription = d.SolutionTruckCarrierTruckDescription _
    '                                                  , .SolutionTruckTotalCases = d.SolutionTruckTotalCases _
    '                                                  , .SolutionTruckTotalWgt = d.SolutionTruckTotalWgt _
    '                                                  , .SolutionTruckTotalPL = d.SolutionTruckTotalPL _
    '                                                  , .SolutionTruckTotalCube = d.SolutionTruckTotalCube _
    '                                                  , .SolutionTruckTotalPX = d.SolutionTruckTotalPX _
    '                                                  , .SolutionTruckTotalBFC = d.SolutionTruckTotalBFC _
    '                                                  , .SolutionTruckTotalOrders = d.SolutionTruckTotalOrders _
    '                                                  , .SolutionTruckTotalCost = d.SolutionTruckTotalCost _
    '                                                  , .SolutionTruckTotalMiles = d.SolutionTruckTotalMiles _
    '                                                  , .SolutionTruckCarrierEquipmentCodes = d.SolutionTruckCarrierEquipmentCodes _
    '                                                  , .SolutionTruckRouteTypeCode = d.SolutionTruckRouteTypeCode _
    '                                                  , .SolutionTruckCommitted = d.SolutionTruckCommitted _
    '                                                  , .SolutionTruckCommittedDate = d.SolutionTruckCommittedDate _
    '                                                  , .SolutionTruckModDate = d.SolutionTruckModDate _
    '                                                  , .SolutionTruckModUser = d.SolutionTruckModUser _
    '                                                  , .SolutionTruckUpdated = d.SolutionTruckUpdated.ToArray()}).FirstOrDefault


    '            Return tblSolutionTruck

    '        Catch ex As System.Data.SqlClient.SqlException
    '            Utilities.SaveAppError(ex.Message, Me.Parameters)
    '            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
    '        Catch ex As InvalidOperationException
    '            Utilities.SaveAppError(ex.Message, Me.Parameters)
    '            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
    '        Catch ex As Exception
    '            Utilities.SaveAppError(ex.Message, Me.Parameters)
    '            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
    '        End Try

    '        Return Nothing

    '    End Using
    'End Function

    ' ''' <summary>
    ' ''' The UpperControl parameter allows for a starting control number to be providced.
    ' ''' The FKControl parameter is a reference to the Solution Truck Control Number.
    ' ''' </summary>
    ' ''' <param name="UpperControl"></param>
    ' ''' <param name="FKControl"></param>
    ' ''' <param name="RouteTypeCode"></param>
    ' ''' <returns></returns>
    ' ''' <remarks></remarks>
    'Public Overloads Function GetLastRecord(ByVal UpperControl As Long, _
    '                                         ByVal FKControl As Long, _
    '                                         ByVal RouteTypeCode As Integer) As DataTransferObjects.DTOBaseClass
    '    Using db As New NGLMasBookDataContext(ConnectionString)
    '        Try
    '            Dim tblSolutionTruck As New DTO.tblSolutionTruck

    '            If UpperControl <> 0 Then

    '                tblSolutionTruck = ( _
    '                From d In db.tblSolutionTrucks _
    '                Where d.SolutionTruckControl >= UpperControl _
    '                And _
    '                (d.SolutionTruckSolutionControl = FKControl) _
    '                And _
    '                (RouteTypeCode = 0 OrElse d.SolutionTruckRouteTypeCode = RouteTypeCode) _
    '                Order By d.SolutionTruckControl _
    '                Select New DTO.tblSolutionTruck With {.SolutionTruckControl = d.SolutionTruckControl _
    '                                                  , .SolutionTruckSolutionControl = d.SolutionTruckSolutionControl _
    '                                                  , .SolutionTruckCom = d.SolutionTruckCom _
    '                                                  , .SolutionTruckConsPrefix = d.SolutionTruckConsPrefix _
    '                                                  , .SolutionTruckRouteConsFlag = d.SolutionTruckRouteConsFlag _
    '                                                  , .SolutionTruckCarrierControl = d.SolutionTruckCarrierControl _
    '                                                  , .SolutionTruckCarrierNumber = d.SolutionTruckCarrierNumber _
    '                                                  , .SolutionTruckCarrierName = d.SolutionTruckCarrierName _
    '                                                  , .SolutionTruckCarrierTruckControl = d.SolutionTruckCarrierTruckControl _
    '                                                  , .SolutionTruckCarrierTruckDescription = d.SolutionTruckCarrierTruckDescription _
    '                                                  , .SolutionTruckTotalCases = d.SolutionTruckTotalCases _
    '                                                  , .SolutionTruckTotalWgt = d.SolutionTruckTotalWgt _
    '                                                  , .SolutionTruckTotalPL = d.SolutionTruckTotalPL _
    '                                                  , .SolutionTruckTotalCube = d.SolutionTruckTotalCube _
    '                                                  , .SolutionTruckTotalPX = d.SolutionTruckTotalPX _
    '                                                  , .SolutionTruckTotalBFC = d.SolutionTruckTotalBFC _
    '                                                  , .SolutionTruckTotalOrders = d.SolutionTruckTotalOrders _
    '                                                  , .SolutionTruckTotalCost = d.SolutionTruckTotalCost _
    '                                                  , .SolutionTruckTotalMiles = d.SolutionTruckTotalMiles _
    '                                                  , .SolutionTruckCarrierEquipmentCodes = d.SolutionTruckCarrierEquipmentCodes _
    '                                                  , .SolutionTruckRouteTypeCode = d.SolutionTruckRouteTypeCode _
    '                                                  , .SolutionTruckCommitted = d.SolutionTruckCommitted _
    '                                                  , .SolutionTruckCommittedDate = d.SolutionTruckCommittedDate _
    '                                                  , .SolutionTruckModDate = d.SolutionTruckModDate _
    '                                                  , .SolutionTruckModUser = d.SolutionTruckModUser _
    '                                                  , .SolutionTruckUpdated = d.SolutionTruckUpdated.ToArray()}).FirstOrDefault

    '            Else



    '                tblSolutionTruck = ( _
    '                From d In db.tblSolutionTrucks _
    '                Where (d.SolutionTruckSolutionControl = FKControl) _
    '                And _
    '                (RouteTypeCode = 0 OrElse d.SolutionTruckRouteTypeCode = RouteTypeCode) _
    '                Order By d.SolutionTruckControl Descending _
    '                Select New DTO.tblSolutionTruck With {.SolutionTruckControl = d.SolutionTruckControl _
    '                                                  , .SolutionTruckSolutionControl = d.SolutionTruckSolutionControl _
    '                                                  , .SolutionTruckCom = d.SolutionTruckCom _
    '                                                  , .SolutionTruckConsPrefix = d.SolutionTruckConsPrefix _
    '                                                  , .SolutionTruckRouteConsFlag = d.SolutionTruckRouteConsFlag _
    '                                                  , .SolutionTruckCarrierControl = d.SolutionTruckCarrierControl _
    '                                                  , .SolutionTruckCarrierNumber = d.SolutionTruckCarrierNumber _
    '                                                  , .SolutionTruckCarrierName = d.SolutionTruckCarrierName _
    '                                                  , .SolutionTruckCarrierTruckControl = d.SolutionTruckCarrierTruckControl _
    '                                                  , .SolutionTruckCarrierTruckDescription = d.SolutionTruckCarrierTruckDescription _
    '                                                  , .SolutionTruckTotalCases = d.SolutionTruckTotalCases _
    '                                                  , .SolutionTruckTotalWgt = d.SolutionTruckTotalWgt _
    '                                                  , .SolutionTruckTotalPL = d.SolutionTruckTotalPL _
    '                                                  , .SolutionTruckTotalCube = d.SolutionTruckTotalCube _
    '                                                  , .SolutionTruckTotalPX = d.SolutionTruckTotalPX _
    '                                                  , .SolutionTruckTotalBFC = d.SolutionTruckTotalBFC _
    '                                                  , .SolutionTruckTotalOrders = d.SolutionTruckTotalOrders _
    '                                                  , .SolutionTruckTotalCost = d.SolutionTruckTotalCost _
    '                                                  , .SolutionTruckTotalMiles = d.SolutionTruckTotalMiles _
    '                                                  , .SolutionTruckCarrierEquipmentCodes = d.SolutionTruckCarrierEquipmentCodes _
    '                                                  , .SolutionTruckRouteTypeCode = d.SolutionTruckRouteTypeCode _
    '                                                  , .SolutionTruckCommitted = d.SolutionTruckCommitted _
    '                                                  , .SolutionTruckCommittedDate = d.SolutionTruckCommittedDate _
    '                                                  , .SolutionTruckModDate = d.SolutionTruckModDate _
    '                                                  , .SolutionTruckModUser = d.SolutionTruckModUser _
    '                                                  , .SolutionTruckUpdated = d.SolutionTruckUpdated.ToArray()}).FirstOrDefault
    '            End If


    '            Return tblSolutionTruck

    '        Catch ex As System.Data.SqlClient.SqlException
    '            Utilities.SaveAppError(ex.Message, Me.Parameters)
    '            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
    '        Catch ex As InvalidOperationException
    '            Utilities.SaveAppError(ex.Message, Me.Parameters)
    '            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
    '        Catch ex As Exception
    '            Utilities.SaveAppError(ex.Message, Me.Parameters)
    '            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
    '        End Try

    '        Return Nothing

    '    End Using
    'End Function

    Public Function GetLoadPlanningTruckFiltered(ByVal CompControl As Integer, ByVal TruckKey As String) As DTO.tblSolutionTruck
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'Get the first record that matches the criteria in TruckFilter
                Dim tblSolutionTruck As DTO.tblSolutionTruck = ( _
                From d In db.spGetLoadPlanningTruckRecord(CompControl, TruckKey) _
                Select selectDTOData(d, db, CompControl)).First
                If Not tblSolutionTruck Is Nothing Then
                    'get the details
                    Dim Details As List(Of DTO.tblSolutionDetail) = (
                    From d In db.spGetLoadPlanningBookData(tblSolutionTruck.SolutionTruckConsPrefix, tblSolutionTruck.SolutionTruckRouteConsFlag, tblSolutionTruck.SolutionTruckCarrierTruckControl, tblSolutionTruck.SolutionTruckCarrierControl) _
                    Select selectDTODetailData(d, db)).ToList

                    If Not Details Is Nothing Then tblSolutionTruck.SolutionDetails = Details

                End If


                Return tblSolutionTruck

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                'no data so just return nothing
                Return Nothing
                ' Utilities.SaveAppError(ex.Message, Me.Parameters)
                ' Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetLoadPlanningTrucksFiltered(ByVal TruckFilter As DTO.LoadPlanningTruckDataFilter) As DTO.tblSolutionTruck()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                'Return all the records that match the criteria in TruckFilter
                Dim tblSolutionTrucks() As DTO.tblSolutionTruck = ( _
                From d In db.spGetLoadPlanningTruckData(TruckFilter.CompControlFilter, TruckFilter.CarrierControlFilter, TruckFilter.StartDateFilter, TruckFilter.StopDateFilter, TruckFilter.OrigStartZipFilter, TruckFilter.OrigStopZipFilter, TruckFilter.DestStartZipFilter, TruckFilter.DestStopZipFilter, TruckFilter.OrigCityFilter, TruckFilter.DestCityFilter, TruckFilter.OrigSt1Filter, TruckFilter.OrigSt2Filter, TruckFilter.OrigSt3Filter, TruckFilter.OrigSt4Filter, TruckFilter.DestSt1Filter, TruckFilter.DestSt2Filter, TruckFilter.DestSt3Filter, TruckFilter.DestSt4Filter, TruckFilter.UseLoadDateFilter, TruckFilter.BookTransTypeFilter, TruckFilter.BookConsPrefixFilter, TruckFilter.LaneNumberFilter, TruckFilter.BookTranCodeFilter, TruckFilter.Page, TruckFilter.PageSize) _
                Select selectDTOData(d, db, TruckFilter)).ToArray()

                If Not tblSolutionTrucks Is Nothing AndAlso tblSolutionTrucks.Count > 0 Then
                    For Each tblSolutionTruck In tblSolutionTrucks
                        If Not tblSolutionTruck Is Nothing Then
                            'get the details
                            Dim Details As List(Of DTO.tblSolutionDetail) = (
                            From d In db.spGetLoadPlanningBookData(tblSolutionTruck.SolutionTruckConsPrefix, tblSolutionTruck.SolutionTruckRouteConsFlag, tblSolutionTruck.SolutionTruckCarrierTruckControl, tblSolutionTruck.SolutionTruckCarrierControl) _
                            Select selectDTODetailData(d, db)).ToList

                            If Not Details Is Nothing Then tblSolutionTruck.SolutionDetails = Details

                        End If
                    Next
                End If

                Return tblSolutionTrucks


            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                'No Data so just return nothing
                Return Nothing
                'Utilities.SaveAppError(ex.Message, Me.Parameters)
                'Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetMatchingRoutedLoads(ByVal CompControl As Integer, _
                                           ByVal CarrierTruckControl As Integer, _
                                           ByVal LoadDate As Date, _
                                           ByVal TransType As String, _
                                           ByVal TranCode As String, _
                                           ByVal RouteGuideControl As Integer, _
                                           ByVal RouteTypeCode As Integer) As DTO.tblSolutionTruck()
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'Return all the records that match the criteria in TruckFilter
                Dim tblSolutionTrucks() As DTO.tblSolutionTruck = ( _
                From d In db.spGetMatchingRoutedLoads(CompControl, _
                                                      CarrierTruckControl, _
                                                      LoadDate, _
                                                      TransType, _
                                                      TranCode, _
                                                      RouteGuideControl, _
                                                      RouteTypeCode) _
                Select selectDTOData(d, db, CompControl)).ToArray()

                If Not tblSolutionTrucks Is Nothing AndAlso tblSolutionTrucks.Count > 0 Then
                    For Each tblSolutionTruck In tblSolutionTrucks

                        If Not tblSolutionTruck Is Nothing Then
                            'get the details
                            Dim Details As List(Of DTO.tblSolutionDetail) = (
                            From d In db.spGetLoadPlanningBookData(tblSolutionTruck.SolutionTruckConsPrefix, tblSolutionTruck.SolutionTruckRouteConsFlag, tblSolutionTruck.SolutionTruckCarrierTruckControl, tblSolutionTruck.SolutionTruckCarrierControl) _
                            Select selectDTODetailData(d, db)).ToList

                            If Not Details Is Nothing Then tblSolutionTruck.SolutionDetails = Details

                        End If
                    Next
                End If

                Return tblSolutionTrucks


            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function GetCarriersForRoute(ByVal CompControl As Integer, _
                                           ByVal RouteGuideControl As Integer, _
                                           ByVal RouteTypeCode As Integer, _
                                           ByVal TransType As String, _
                                           ByVal StateFilter As String, _
                                           ByVal LoadDate As Date, _
                                           ByVal RequiredDate As Date, _
                                           ByVal Cases As Double, _
                                           ByVal Wgt As Double, _
                                           ByVal Cubes As Double, _
                                           ByVal Plts As Integer, _
                                           ByVal TempType As String, _
                                           ByVal IsHazmat As Boolean, _
                                           Optional ByVal ActiveCarriersOnly As Boolean = True) As DTO.CarriersForRoute()


        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'Return all the records that match the criteria in TruckFilter
                Dim CarriersForRoute() As DTO.CarriersForRoute = ( _
                From d In db.spGetCarriersForRoute(CompControl, _
                                                   RouteGuideControl, _
                                                   RouteTypeCode, _
                                                   TransType, _
                                                   StateFilter, _
                                                   LoadDate, _
                                                   RequiredDate, _
                                                   Cases, _
                                                   Wgt, _
                                                   Cubes, _
                                                   Plts, _
                                                   TempType, _
                                                   IsHazmat, _
                                                   ActiveCarriersOnly) _
                                               Select New DTO.CarriersForRoute With { _
                                                   .StaticRouteControl = d.StaticRouteControl _
                                                    , .StaticRouteNumber = d.StaticRouteNumber _
                                                    , .StaticRouteCompControl = d.StaticRouteCompControl _
                                                    , .StaticRouteAutoTenderFlag = d.StaticRouteAutoTenderFlag _
                                                    , .StaticRouteUseShipDateFlag = d.StaticRouteUseShipDateFlag _
                                                    , .StaticRouteGuideDateSelectionDaysBefore = d.StaticRouteGuideDateSelectionDaysBefore _
                                                    , .StaticRouteGuideDateSelectionDaysAfter = d.StaticRouteGuideDateSelectionDaysAfter _
                                                    , .StaticRouteSplitOversizedLoads = d.StaticRouteSplitOversizedLoads _
                                                    , .StaticRouteCapacityPreference = d.StaticRouteCapacityPreference _
                                                    , .StaticRouteRequireAutoTenderApproval = d.StaticRouteRequireAutoTenderApproval _
                                                    , .StaticRouteFillLargestFirst = d.StaticRouteFillLargestFirst _
                                                    , .StaticRoutePlaceOnHold = d.StaticRoutePlaceOnHold _
                                                    , .StaticRouteCarrCarrierControl = d.StaticRouteCarrCarrierControl _
                                                    , .StaticRouteCarrCarrierName = d.StaticRouteCarrCarrierName _
                                                    , .StaticRouteCarrName = d.StaticRouteCarrName _
                                                    , .StaticRouteCarrRouteTypeCode = d.StaticRouteCarrRouteTypeCode _
                                                    , .StaticRouteCarrAutoTenderFlag = d.StaticRouteCarrAutoTenderFlag _
                                                    , .StaticRouteCarrTendLeadTime = d.StaticRouteCarrTendLeadTime _
                                                    , .StaticRouteCarrMaxStops = d.StaticRouteCarrMaxStops _
                                                    , .StaticRouteCarrHazmatFlag = d.StaticRouteCarrHazmatFlag _
                                                    , .StaticRouteCarrTransType = d.StaticRouteCarrTransType _
                                                    , .StaticRouteCarrRouteSequence = d.StaticRouteCarrRouteSequence _
                                                    , .StaticRouteCarrRequireAutoTenderApproval = d.StaticRouteCarrRequireAutoTenderApproval _
                                                    , .StaticRouteCarrAutoAcceptLoads = d.StaticRouteCarrAutoAcceptLoads _
                                                    , .StaticRouteStateFilter = d.StaticRouteStateFilter _
                                                    , .StaticRouteCarrControl = d.StaticRouteCarrControl _
                                                    , .StaticRouteEquipControl = d.StaticRouteEquipControl _
                                                    , .StaticRouteEquipCarrierTruckControl = d.StaticRouteEquipCarrierTruckControl _
                                                    , .StaticRouteEquipName = d.StaticRouteEquipName _
                                                    , .CarrierSCAC = d.CarrierSCAC _
                                                    , .CarrierActive = d.CarrierActive _
                                                    , .CarrierIgnoreTariff = d.CarrierIgnoreTariff _
                                                    , .CarrierAutoFinalize = d.CarrierAutoFinalize _
                                                    , .CarrierTruckEquipment = d.CarrierTruckEquipment _
                                                    , .CarrierTruckFAK = d.CarrierTruckFAK _
                                                    , .CarrierTruckPUMon = d.CarrierTruckPUMon _
                                                    , .CarrierTruckPUTue = d.CarrierTruckPUTue _
                                                    , .CarrierTruckPUWed = d.CarrierTruckPUWed _
                                                    , .CarrierTruckPUThu = d.CarrierTruckPUThu _
                                                    , .CarrierTruckPUFri = d.CarrierTruckPUFri _
                                                    , .CarrierTruckPUSat = d.CarrierTruckPUSat _
                                                    , .CarrierTruckPUSun = d.CarrierTruckPUSun _
                                                    , .CarrierTruckDLMon = d.CarrierTruckDLMon _
                                                    , .CarrierTruckDLTue = d.CarrierTruckDLTue _
                                                    , .CarrierTruckDLWed = d.CarrierTruckDLWed _
                                                    , .CarrierTruckDLThu = d.CarrierTruckDLThu _
                                                    , .CarrierTruckDLFri = d.CarrierTruckDLFri _
                                                    , .CarrierTruckDLSat = d.CarrierTruckDLSat _
                                                    , .CarrierTruckDLSun = d.CarrierTruckDLSun _
                                                    , .CarrierTruckMaxCases = d.CarrierTruckMaxCases _
                                                    , .CarrierTruckMinCases = d.CarrierTruckMinCases _
                                                    , .CarrierTruckSplitCases = d.CarrierTruckSplitCases _
                                                    , .CarrierTruckMaxWgt = d.CarrierTruckMaxWgt _
                                                    , .CarrierTruckMinWgt = d.CarrierTruckMinWgt _
                                                    , .CarrierTruckSplitWgt = d.CarrierTruckSplitWgt _
                                                    , .CarrierTruckMaxCubes = d.CarrierTruckMaxCubes _
                                                    , .CarrierTruckMinCubes = d.CarrierTruckMinCubes _
                                                    , .CarrierTruckSplitCubes = d.CarrierTruckSplitCubes _
                                                    , .CarrierTruckMaxPlts = d.CarrierTruckMaxPlts _
                                                    , .CarrierTruckMinPlts = d.CarrierTruckMinPlts _
                                                    , .CarrierTruckSplitPlts = d.CarrierTruckSplitPlts _
                                                    , .CarrierTruckTrucksAvailable = d.CarrierTruckTrucksAvailable _
                                                    , .CarrierTruckMaxLoadsByWeek = d.CarrierTruckMaxLoadsByWeek _
                                                    , .CarrierTruckMaxLoadsByMonth = d.CarrierTruckMaxLoadsByMonth _
                                                    , .CarrierTruckTotalLoadsForWeek = d.CarrierTruckTotalLoadsForWeek _
                                                    , .CarrierTruckTotalLoadsForMonth = d.CarrierTruckTotalLoadsForMonth _
                                                    , .CarrierTruckTempType = d.CarrierTruckTempType _
                                                    , .CarrierTruckHazmat = d.CarrierTruckHazmat _
                                                    }).ToArray()






                Return CarriersForRoute


            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Function UpdateLoadPlanningItem30(ByVal CompControl As Integer, ByVal TruckKey As String, ByVal droppedItem As DTO.tblSolutionDetail, ByVal droppedIndex As Integer) As DTO.UpdateLoadPlanningResults
        Dim success As Boolean
        Dim newStopNo As Integer = 1
        Dim curItem As DTO.tblSolutionDetail = Nothing
        Dim foundItem As Boolean = False
        Dim newTruck As DTO.tblSolutionTruck = GetLoadPlanningTruckFiltered(CompControl, TruckKey)
        'remove the item if can.
        For i As Integer = 0 To newTruck.SolutionDetails.Count - 1
            curItem = newTruck.SolutionDetails(i)
            If curItem.SolutionDetailBookControl = droppedItem.SolutionDetailBookControl Then
                newTruck.SolutionDetails.RemoveAt(i)
                foundItem = True
                Exit For
            End If
        Next

        'if the dropped index is last, add the dropped item to the end.
        If droppedIndex > newTruck.SolutionDetails.Count - 1 Then
            newTruck.SolutionDetails.Add(droppedItem)
        Else
            newTruck.SolutionDetails.Insert(droppedIndex, droppedItem)
        End If

        Dim result As DTO.UpdateLoadPlanningResults = reSequenceStopNumbers(newTruck, newTruck.SolutionDetails.IndexOf(droppedItem))

        'finally get the latest changes.
        Dim lpTruck As DTO.tblSolutionTruck = Me.GetLoadPlanningTruckFiltered(newTruck.SolutionTruckCompControl, newTruck.SolutionTruckKey)

        result.UpdatedLPTruck = lpTruck

        Return result
    End Function

    ''' <summary>
    ''' This overload has been depreciated
    ''' </summary>
    ''' <param name="newTruck"></param>
    ''' <param name="droppedItem"></param>
    ''' <param name="droppedIndex"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function UpdateLoadPlanningItem30(ByVal newTruck As DTO.tblSolutionTruck, ByVal droppedItem As DTO.tblSolutionDetail, ByVal droppedIndex As Integer) As DTO.UpdateLoadPlanningResults
        Dim success As Boolean
        Dim newStopNo As Integer = 1
        Dim curItem As DTO.tblSolutionDetail = Nothing
        Dim foundItem As Boolean = False

        'remove the item if can.
        For i As Integer = 0 To newTruck.SolutionDetails.Count - 1
            curItem = newTruck.SolutionDetails(i)
            If curItem.SolutionDetailBookControl = droppedItem.SolutionDetailBookControl Then
                newTruck.SolutionDetails.RemoveAt(i)
                foundItem = True
                Exit For
            End If
        Next

        'if the dropped index is last, add the dropped item to the end.
        If droppedIndex > newTruck.SolutionDetails.Count - 1 Then
            newTruck.SolutionDetails.Add(droppedItem)
        Else
            newTruck.SolutionDetails.Insert(droppedIndex, droppedItem)
        End If

        Dim result As DTO.UpdateLoadPlanningResults = reSequenceStopNumbers(newTruck, newTruck.SolutionDetails.IndexOf(droppedItem))

        'finally get the latest changes.
        Dim lpTruck As DTO.tblSolutionTruck = Me.GetLoadPlanningTruckFiltered(newTruck.SolutionTruckCompControl, newTruck.SolutionTruckKey)

        result.UpdatedLPTruck = lpTruck

        Return result
    End Function

    Friend Function selectDTOData(ByVal d As LTS.spGetLoadPlanningTruckRecordResult, ByRef db As NGLMasBookDataContext, ByVal CompControl As Integer, Optional page As Integer = 1, Optional pagecount As Integer = 1, Optional pagesize As Integer = 1000) As DTO.tblSolutionTruck
        Return New DTO.tblSolutionTruck With {.SolutionTruckControl = 0 _
                                                      , .SolutionTruckCompControl = CompControl _
                                                      , .SolutionTruckKey = d.SolutionTruckCarrierControl.ToString & "-" & d.SolutionTruckConsPrefix.Trim & "-" & If(d.SolutionTruckRouteConsFlag, "1", "0") & "-" & d.SolutionTruckRouteTypeCode & "-" & d.SolutionTruckCarrierTruckControl.ToString _
                                                      , .SolutionTruckSolutionControl = 0 _
                                                      , .SolutionTruckCom = d.SolutionTruckCom _
                                                      , .SolutionTruckConsPrefix = d.SolutionTruckConsPrefix _
                                                      , .SolutionTruckRouteConsFlag = d.SolutionTruckRouteConsFlag _
                                                      , .SolutionTruckCarrierControl = d.SolutionTruckCarrierControl _
                                                      , .SolutionTruckCarrierNumber = d.SolutionTruckCarrierNumber _
                                                      , .SolutionTruckCarrierName = d.SolutionTruckCarrierName _
                                                      , .SolutionTruckCarrierTruckControl = d.SolutionTruckCarrierTruckControl _
                                                      , .SolutionTruckCarrierTruckDescription = d.SolutionTruckCarrierTruckDescription _
                                                      , .SolutionTruckTotalCases = If(d.SolutionTruckTotalCases.HasValue, d.SolutionTruckTotalCases.Value, 0) _
                                                      , .SolutionTruckTotalWgt = If(d.SolutionTruckTotalWgt.HasValue, d.SolutionTruckTotalWgt.Value, 0) _
                                                      , .SolutionTruckTotalPL = If(d.SolutionTruckTotalPL.HasValue, d.SolutionTruckTotalPL.Value, 0) _
                                                      , .SolutionTruckTotalCube = If(d.SolutionTruckTotalCube.HasValue, d.SolutionTruckTotalCube.Value, 0) _
                                                      , .SolutionTruckTotalPX = If(d.SolutionTruckTotalPX.HasValue, d.SolutionTruckTotalPX.Value, 0) _
                                                      , .SolutionTruckTotalBFC = If(d.SolutionTruckTotalBFC.HasValue, d.SolutionTruckTotalBFC.Value, 0) _
                                                      , .SolutionTruckTotalOrders = If(d.SolutionTruckTotalOrders.HasValue, d.SolutionTruckTotalOrders.Value, 0) _
                                                      , .SolutionTruckTotalCost = If(d.SolutionTruckTotalCost.HasValue, d.SolutionTruckTotalCost.Value, 0) _
                                                      , .SolutionTruckTotalMiles = If(d.SolutionTruckTotalMiles.HasValue, d.SolutionTruckTotalMiles.Value, 0) _
                                                      , .SolutionTruckCarrierEquipmentCodes = "" _
                                                      , .SolutionTruckRouteTypeCode = d.SolutionTruckRouteTypeCode _
                                                      , .SolutionTruckStaticRouteControl = d.SolutionTruckStaticRouteControl _
                                                      , .SolutionTruckStaticRouteNumber = d.SolutionTruckStaticRouteNumber _
                                                      , .SolutionTruckAttributeControl = 0 _
                                                      , .SolutionTruckAttributeTypeControl = 0 _
                                                      , .SolutionTruckCapacityPreference = db.udfGetRouteCapacityPreference(d.SolutionTruckStaticRouteControl) _
                                                      , .SolutionTruckSplitCases = d.SolutionTruckSplitCases _
                                                      , .SolutionTruckMaxCases = d.SolutionTruckMaxCases _
                                                      , .SolutionTruckMinWgt = d.SolutionTruckMinWgt _
                                                      , .SolutionTruckSplitWgt = d.SolutionTruckSplitWgt _
                                                      , .SolutionTruckMaxWgt = d.SolutionTruckMaxWgt _
                                                      , .SolutionTruckMinCubes = d.SolutionTruckMinCubes _
                                                      , .SolutionTruckSplitCubes = d.SolutionTruckSplitCubes _
                                                      , .SolutionTruckMaxCubes = d.SolutionTruckMaxCubes _
                                                      , .SolutionTruckMinPlts = d.SolutionTruckMinPlts _
                                                      , .SolutionTruckSplitPlts = d.SolutionTruckSplitPlts _
                                                      , .SolutionTruckMaxPlts = d.SolutionTruckMaxPlts _
                                                      , .SolutionTruckTrucksAvailable = d.SolutionTruckTrucksAvailable _
                                                      , .SolutionTruckIsHazmat = d.SolutionTruckIsHazmat _
                                                      , .Page = page _
                                                      , .Pages = pagecount _
                                                      , .PageSize = pagesize}

    End Function

    Friend Function selectDTOData(ByVal d As LTS.spGetLoadPlanningTruckDataResult, ByRef db As NGLMasBookDataContext, ByVal TruckFilter As DTO.LoadPlanningTruckDataFilter, Optional page As Integer = 1, Optional pagecount As Integer = 1, Optional pagesize As Integer = 1000) As DTO.tblSolutionTruck

        Return New DTO.tblSolutionTruck With {.SolutionTruckControl = 0 _
                                                      , .SolutionTruckCompControl = TruckFilter.CompControlFilter _
                                                      , .SolutionTruckKey = d.SolutionTruckCarrierControl.ToString & "-" & d.SolutionTruckConsPrefix.Trim & "-" & If(d.SolutionTruckRouteConsFlag, "1", "0") & "-" & d.SolutionTruckRouteTypeCode & "-" & d.SolutionTruckCarrierTruckControl.ToString _
                                                      , .SolutionTruckSolutionControl = 0 _
                                                      , .SolutionTruckCom = d.SolutionTruckCom _
                                                      , .SolutionTruckConsPrefix = d.SolutionTruckConsPrefix _
                                                      , .SolutionTruckRouteConsFlag = d.SolutionTruckRouteConsFlag _
                                                      , .SolutionTruckCarrierControl = d.SolutionTruckCarrierControl _
                                                      , .SolutionTruckCarrierNumber = d.SolutionTruckCarrierNumber _
                                                      , .SolutionTruckCarrierName = d.SolutionTruckCarrierName _
                                                      , .SolutionTruckCarrierTruckControl = d.SolutionTruckCarrierTruckControl _
                                                      , .SolutionTruckCarrierTruckDescription = d.SolutionTruckCarrierTruckDescription _
                                                      , .SolutionTruckTotalCases = If(d.SolutionTruckTotalCases.HasValue, d.SolutionTruckTotalCases.Value, 0) _
                                                      , .SolutionTruckTotalWgt = If(d.SolutionTruckTotalWgt.HasValue, d.SolutionTruckTotalWgt.Value, 0) _
                                                      , .SolutionTruckTotalPL = If(d.SolutionTruckTotalPL.HasValue, d.SolutionTruckTotalPL.Value, 0) _
                                                      , .SolutionTruckTotalCube = If(d.SolutionTruckTotalCube.HasValue, d.SolutionTruckTotalCube.Value, 0) _
                                                      , .SolutionTruckTotalPX = If(d.SolutionTruckTotalPX.HasValue, d.SolutionTruckTotalPX.Value, 0) _
                                                      , .SolutionTruckTotalBFC = If(d.SolutionTruckTotalBFC.HasValue, d.SolutionTruckTotalBFC.Value, 0) _
                                                      , .SolutionTruckTotalOrders = If(d.SolutionTruckTotalOrders.HasValue, d.SolutionTruckTotalOrders.Value, 0) _
                                                      , .SolutionTruckTotalCost = If(d.SolutionTruckTotalCost.HasValue, d.SolutionTruckTotalCost.Value, 0) _
                                                      , .SolutionTruckTotalMiles = If(d.SolutionTruckTotalMiles.HasValue, d.SolutionTruckTotalMiles.Value, 0) _
                                                      , .SolutionTruckCarrierEquipmentCodes = "" _
                                                      , .SolutionTruckRouteTypeCode = d.SolutionTruckRouteTypeCode _
                                                      , .SolutionTruckStaticRouteControl = d.SolutionTruckStaticRouteControl _
                                                      , .SolutionTruckStaticRouteNumber = d.SolutionTruckStaticRouteNumber _
                                                      , .SolutionTruckAttributeControl = 0 _
                                                      , .SolutionTruckAttributeTypeControl = 0 _
                                                      , .SolutionTruckCapacityPreference = db.udfGetRouteCapacityPreference(d.SolutionTruckStaticRouteControl) _
                                                      , .SolutionTruckSplitCases = d.SolutionTruckSplitCases _
                                                      , .SolutionTruckMaxCases = d.SolutionTruckMaxCases _
                                                      , .SolutionTruckMinWgt = d.SolutionTruckMinWgt _
                                                      , .SolutionTruckSplitWgt = d.SolutionTruckSplitWgt _
                                                      , .SolutionTruckMaxWgt = d.SolutionTruckMaxWgt _
                                                      , .SolutionTruckMinCubes = d.SolutionTruckMinCubes _
                                                      , .SolutionTruckSplitCubes = d.SolutionTruckSplitCubes _
                                                      , .SolutionTruckMaxCubes = d.SolutionTruckMaxCubes _
                                                      , .SolutionTruckMinPlts = d.SolutionTruckMinPlts _
                                                      , .SolutionTruckSplitPlts = d.SolutionTruckSplitPlts _
                                                      , .SolutionTruckMaxPlts = d.SolutionTruckMaxPlts _
                                                      , .SolutionTruckTrucksAvailable = d.SolutionTruckTrucksAvailable _
                                                      , .SolutionTruckIsHazmat = d.SolutionTruckIsHazmat _
                                                      , .Page = page _
                                                      , .Pages = pagecount _
                                                      , .PageSize = pagesize}

    End Function

    Friend Function selectDTOData(ByVal d As LTS.spGetMatchingRoutedLoadsResult, ByRef db As NGLMasBookDataContext, ByVal CompControl As Integer, Optional page As Integer = 1, Optional pagecount As Integer = 1, Optional pagesize As Integer = 1000) As DTO.tblSolutionTruck

        Return New DTO.tblSolutionTruck With {.SolutionTruckControl = 0 _
                                                      , .SolutionTruckCompControl = CompControl _
                                                      , .SolutionTruckKey = d.SolutionTruckCarrierControl.ToString & "-" & d.SolutionTruckConsPrefix.Trim & "-" & If(d.SolutionTruckRouteConsFlag, "1", "0") & "-" & d.SolutionTruckRouteTypeCode & "-" & d.SolutionTruckCarrierTruckControl.ToString _
                                                      , .SolutionTruckSolutionControl = 0 _
                                                      , .SolutionTruckCom = d.SolutionTruckCom _
                                                      , .SolutionTruckConsPrefix = d.SolutionTruckConsPrefix _
                                                      , .SolutionTruckRouteConsFlag = d.SolutionTruckRouteConsFlag _
                                                      , .SolutionTruckCarrierControl = d.SolutionTruckCarrierControl _
                                                      , .SolutionTruckCarrierNumber = d.SolutionTruckCarrierNumber _
                                                      , .SolutionTruckCarrierName = d.SolutionTruckCarrierName _
                                                      , .SolutionTruckCarrierTruckControl = d.SolutionTruckCarrierTruckControl _
                                                      , .SolutionTruckCarrierTruckDescription = d.SolutionTruckCarrierTruckDescription _
                                                      , .SolutionTruckTotalCases = If(d.SolutionTruckTotalCases.HasValue, d.SolutionTruckTotalCases.Value, 0) _
                                                      , .SolutionTruckTotalWgt = If(d.SolutionTruckTotalWgt.HasValue, d.SolutionTruckTotalWgt.Value, 0) _
                                                      , .SolutionTruckTotalPL = If(d.SolutionTruckTotalPL.HasValue, d.SolutionTruckTotalPL.Value, 0) _
                                                      , .SolutionTruckTotalCube = If(d.SolutionTruckTotalCube.HasValue, d.SolutionTruckTotalCube.Value, 0) _
                                                      , .SolutionTruckTotalPX = If(d.SolutionTruckTotalPX.HasValue, d.SolutionTruckTotalPX.Value, 0) _
                                                      , .SolutionTruckTotalBFC = If(d.SolutionTruckTotalBFC.HasValue, d.SolutionTruckTotalBFC.Value, 0) _
                                                      , .SolutionTruckTotalOrders = If(d.SolutionTruckTotalOrders.HasValue, d.SolutionTruckTotalOrders.Value, 0) _
                                                      , .SolutionTruckTotalCost = If(d.SolutionTruckTotalCost.HasValue, d.SolutionTruckTotalCost.Value, 0) _
                                                      , .SolutionTruckTotalMiles = If(d.SolutionTruckTotalMiles.HasValue, d.SolutionTruckTotalMiles.Value, 0) _
                                                      , .SolutionTruckCarrierEquipmentCodes = "" _
                                                      , .SolutionTruckRouteTypeCode = d.SolutionTruckRouteTypeCode _
                                                      , .SolutionTruckStaticRouteControl = d.SolutionTruckStaticRouteControl _
                                                      , .SolutionTruckStaticRouteNumber = d.SolutionTruckStaticRouteNumber _
                                                      , .SolutionTruckAttributeControl = 0 _
                                                      , .SolutionTruckAttributeTypeControl = 0 _
                                                      , .SolutionTruckCapacityPreference = db.udfGetRouteCapacityPreference(d.SolutionTruckStaticRouteControl) _
                                                      , .SolutionTruckSplitCases = d.SolutionTruckSplitCases _
                                                      , .SolutionTruckMaxCases = d.SolutionTruckMaxCases _
                                                      , .SolutionTruckMinWgt = d.SolutionTruckMinWgt _
                                                      , .SolutionTruckSplitWgt = d.SolutionTruckSplitWgt _
                                                      , .SolutionTruckMaxWgt = d.SolutionTruckMaxWgt _
                                                      , .SolutionTruckMinCubes = d.SolutionTruckMinCubes _
                                                      , .SolutionTruckSplitCubes = d.SolutionTruckSplitCubes _
                                                      , .SolutionTruckMaxCubes = d.SolutionTruckMaxCubes _
                                                      , .SolutionTruckMinPlts = d.SolutionTruckMinPlts _
                                                      , .SolutionTruckSplitPlts = d.SolutionTruckSplitPlts _
                                                      , .SolutionTruckMaxPlts = d.SolutionTruckMaxPlts _
                                                      , .SolutionTruckTrucksAvailable = d.SolutionTruckTrucksAvailable _
                                                      , .SolutionTruckIsHazmat = d.SolutionTruckIsHazmat _
                                                      , .Page = page _
                                                      , .Pages = pagecount _
                                                      , .PageSize = pagesize}

    End Function

    Friend Function selectDTODetailData(ByVal d As LTS.spGetLoadPlanningBookDataResult, ByRef db As NGLMasBookDataContext) As DTO.tblSolutionDetail

        Return New DTO.tblSolutionDetail With {.SolutionDetailControl = 0 _
                                                      , .SolutionDetailSolutionTruckControl = 0 _
                                                      , .SolutionDetailBookControl = d.SolutionDetailBookControl _
                                                      , .SolutionDetailPOHdrControl = d.SolutionDetailPOHdrControl _
                                                      , .SolutionDetailBookLoadControl = d.SolutionDetailBookLoadControl _
                                                      , .SolutionDetailProNumber = d.SolutionDetailProNumber _
                                                      , .SolutionDetailPONumber = d.SolutionDetailPONumber _
                                                      , .SolutionDetailOrderNumber = d.SolutionDetailOrderNumber _
                                                      , .SolutionDetailOrderSequence = d.SolutionDetailOrderSequence _
                                                      , .SolutionDetailCom = d.SolutionDetailCom _
                                                      , .SolutionDetailConsPrefix = d.SolutionDetailConsPrefix _
                                                      , .SolutionDetailCompControl = d.SolutionDetailCompControl _
                                                      , .SolutionDetailCompNumber = If(d.SolutionDetailCompNumber.HasValue, d.SolutionDetailCompNumber, 0) _
                                                      , .SolutionDetailCompName = d.SolutionDetailCompName _
                                                      , .SolutionDetailCompNatNumber = d.SolutionDetailCompNatNumber _
                                                      , .SolutionDetailCompNatName = d.SolutionDetailCompNatName _
                                                      , .SolutionDetailODControl = d.SolutionDetailODControl _
                                                      , .SolutionDetailCarrierControl = d.SolutionDetailCarrierControl _
                                                      , .SolutionDetailCarrierNumber = d.SolutionDetailCarrierNumber _
                                                      , .SolutionDetailCarrierName = d.SolutionDetailCarrierName _
                                                      , .SolutionDetailOrigCompControl = d.SolutionDetailOrigCompControl _
                                                      , .SolutionDetailOrigName = d.SolutionDetailOrigName _
                                                      , .SolutionDetailOrigAddress1 = d.SolutionDetailOrigAddress1 _
                                                      , .SolutionDetailOrigAddress2 = d.SolutionDetailOrigAddress2 _
                                                      , .SolutionDetailOrigAddress3 = d.SolutionDetailOrigAddress3 _
                                                      , .SolutionDetailOrigCity = d.SolutionDetailOrigCity _
                                                      , .SolutionDetailOrigState = d.SolutionDetailOrigState _
                                                      , .SolutionDetailOrigCountry = d.SolutionDetailOrigCountry _
                                                      , .SolutionDetailOrigZip = d.SolutionDetailOrigZip _
                                                      , .SolutionDetailDestCompControl = d.SolutionDetailDestCompControl _
                                                      , .SolutionDetailDestName = d.SolutionDetailDestName _
                                                      , .SolutionDetailDestAddress1 = d.SolutionDetailDestAddress1 _
                                                      , .SolutionDetailDestAddress2 = d.SolutionDetailDestAddress2 _
                                                      , .SolutionDetailDestAddress3 = d.SolutionDetailDestAddress3 _
                                                      , .SolutionDetailDestCity = d.SolutionDetailDestCity _
                                                      , .SolutionDetailDestState = d.SolutionDetailDestState _
                                                      , .SolutionDetailDestCountry = d.SolutionDetailDestCountry _
                                                      , .SolutionDetailDestZip = d.SolutionDetailDestZip _
                                                      , .SolutionDetailDateOrdered = d.SolutionDetailDateOrdered _
                                                      , .SolutionDetailDateLoad = d.SolutionDetailDateLoad _
                                                      , .SolutionDetailDateRequired = d.SolutionDetailDateRequired _
                                                      , .SolutionDetailTotalCases = If(d.SolutionDetailTotalCases.HasValue, d.SolutionDetailTotalCases, 0) _
                                                      , .SolutionDetailTotalWgt = If(d.SolutionDetailTotalWgt.HasValue, d.SolutionDetailTotalWgt, 0) _
                                                      , .SolutionDetailTotalPL = If(d.SolutionDetailTotalPL.HasValue, d.SolutionDetailTotalPL, 0) _
                                                      , .SolutionDetailTotalCube = If(d.SolutionDetailTotalCube.HasValue, d.SolutionDetailTotalCube, 0) _
                                                      , .SolutionDetailTotalPX = If(d.SolutionDetailTotalPX.HasValue, d.SolutionDetailTotalPX, 0) _
                                                      , .SolutionDetailTotalBFC = If(d.SolutionDetailTotalBFC.HasValue, d.SolutionDetailTotalBFC, 0) _
                                                      , .SolutionDetailTranCode = d.SolutionDetailTranCode _
                                                      , .SolutionDetailPayCode = d.SolutionDetailPayCode _
                                                      , .SolutionDetailTypeCode = d.SolutionDetailTypeCode _
                                                      , .SolutionDetailStopNo = If(d.SolutionDetailStopNo.HasValue, d.SolutionDetailStopNo, 0) _
                                                      , .SolutionDetailRevBilledBFC = d.SolutionDetailRevBilledBFC _
                                                      , .SolutionDetailRevCarrierCost = d.SolutionDetailRevCarrierCost _
                                                      , .SolutionDetailRevOtherCost = d.SolutionDetailRevOtherCost _
                                                      , .SolutionDetailRevTotalCost = d.SolutionDetailRevTotalCost _
                                                      , .SolutionDetailRevLoadSavings = d.SolutionDetailRevLoadSavings _
                                                      , .SolutionDetailRevCommPercent = d.SolutionDetailRevCommPercent _
                                                      , .SolutionDetailRevCommCost = d.SolutionDetailRevCommCost _
                                                      , .SolutionDetailRevGrossRevenue = d.SolutionDetailRevGrossRevenue _
                                                      , .SolutionDetailRevNegRevenue = d.SolutionDetailRevNegRevenue _
                                                      , .SolutionDetailMilesFrom = d.SolutionDetailMilesFrom _
                                                      , .SolutionDetailHoldLoad = d.SolutionDetailHoldLoad _
                                                      , .SolutionDetailTransType = d.SolutionDetailTransType _
                                                      , .SolutionDetailRouteConsFlag = d.SolutionDetailRouteConsFlag _
                                                      , .SolutionDetailFinAPActTax = d.SolutionDetailFinAPActTax _
                                                      , .SolutionDetailRevFreightTax = d.SolutionDetailRevFreightTax _
                                                      , .SolutionDetailRevNetCost = d.SolutionDetailRevNetCost _
                                                      , .SolutionDetailFinServiceFee = d.SolutionDetailFinServiceFee _
                                                      , .SolutionDetailDateRequested = d.SolutionDetailDateRequested _
                                                      , .SolutionDetailCarrierEquipmentCodes = d.SolutionDetailCarrierEquipmentCodes _
                                                      , .SolutionDetailLockAllCosts = d.SolutionDetailLockAllCosts _
                                                      , .SolutionDetailLockBFCCost = d.SolutionDetailLockBFCCost _
                                                      , .SolutionDetailRevNonTaxable = d.SolutionDetailRevNonTaxable _
                                                      , .SolutionDetailPickupStopNumber = d.SolutionDetailPickupStopNumber _
                                                      , .SolutionDetailOrigStopNumber = d.SolutionDetailOrigStopNumber _
                                                      , .SolutionDetailDestStopNumber = d.SolutionDetailDestStopNumber _
                                                      , .SolutionDetailOrigMiles = d.SolutionDetailOrigMiles _
                                                      , .SolutionDetailDestMiles = d.SolutionDetailDestMiles _
                                                      , .SolutionDetailOrigPCMCost = d.SolutionDetailOrigPCMCost _
                                                      , .SolutionDetailDestPCMCost = d.SolutionDetailDestPCMCost _
                                                      , .SolutionDetailOrigPCMTime = d.SolutionDetailOrigPCMTime _
                                                      , .SolutionDetailDestPCMTime = d.SolutionDetailDestPCMTime _
                                                      , .SolutionDetailOrigPCMTolls = d.SolutionDetailOrigPCMTolls _
                                                      , .SolutionDetailDestPCMTolls = d.SolutionDetailDestPCMTolls _
                                                      , .SolutionDetailOrigPCMESTCHG = d.SolutionDetailOrigPCMESTCHG _
                                                      , .SolutionDetailDestPCMESTCHG = d.SolutionDetailDestPCMESTCHG _
                                                      , .SolutionDetailPickNumber = d.SolutionDetailPickNumber _
                                                      , .SolutionDetailOrigStopControl = d.SolutionDetailOrigStopControl _
                                                      , .SolutionDetailDestStopControl = d.SolutionDetailDestStopControl _
                                                      , .SolutionDetailRouteTypeCode = d.SolutionDetailRouteTypeCode _
                                                      , .SolutionDetailAlternateAddressLaneControl = d.SolutionDetailAlternateAddressLaneControl _
                                                      , .SolutionDetailAlternateAddressLaneNumber = d.SolutionDetailAlternateAddressLaneNumber _
                                                      , .SolutionDetailDefaultRouteSequence = d.SolutionDetailDefaultRouteSequence _
                                                      , .SolutionDetailRouteGuideControl = d.SolutionDetailRouteGuideControl _
                                                      , .SolutionDetailRouteGuideNumber = d.SolutionDetailRouteGuideNumber _
                                                      , .SolutionDetailCustomerApprovalTransmitted = d.SolutionDetailCustomerApprovalTransmitted _
                                                      , .SolutionDetailCustomerApprovalRecieved = d.SolutionDetailCustomerApprovalRecieved _
                                                      , .SolutionDetailInbound = d.SolutionDetailInbound _
                                                      , .SolutionDetailIsHazmat = d.SolutionDetailIsHazmat _
                                                      , .SolutionDetailBookModDate = d.SolutionDetailBookModDate _
                                                      , .SolutionDetailBookModUser = d.SolutionDetailBookModUser _
                                                      , .SolutionDetailModDate = d.SolutionDetailBookModDate _
                                                      , .SolutionDetailModUser = d.SolutionDetailBookModUser _
                                                      , .SolutionDetailUpdated = d.SolutionDetailUpdated.ToArray()}

    End Function

    Private Function reSequenceStopNumbers(ByVal truck As DTO.tblSolutionTruck, ByVal newDetailIndex As Integer) As DTO.UpdateLoadPlanningResults

        Dim strStatusMsg As String = "Failed"
        Dim success As Boolean = False
        Dim result As New DTO.UpdateLoadPlanningResults
        Try

            Dim Item As DTO.tblSolutionDetail
            Dim stopNumbCounter As Integer = 0
            Dim currAddr As String = ""
            Dim prevAddr As String = ""
            For i As Integer = 0 To truck.SolutionDetails.Count - 1
                Item = truck.SolutionDetails(i)
                stopNumbCounter = stopNumbCounter + 1

                'they dropped it somewhere after the first spot
                If Item.SolutionDetailInbound Then
                    'compare the origins
                    currAddr = Item.SolutionDetailOrigAddress1.ToUpper & "-" & Item.SolutionDetailOrigCity.ToUpper & "-" & Item.SolutionDetailOrigState.ToUpper & "-" & Item.SolutionDetailOrigZip.ToUpper
                Else
                    'compare the destinations
                    currAddr = Item.SolutionDetailDestAddress1.ToUpper & "-" & Item.SolutionDetailDestCity.ToUpper & "-" & Item.SolutionDetailDestState.ToUpper & "-" & Item.SolutionDetailDestZip.ToUpper
                End If

                'If the address is the same, no need to increment the stop number.
                If prevAddr.Equals(currAddr) Then
                    'same stop no.
                    stopNumbCounter = stopNumbCounter - 1
                End If

                'check is this is an import.  Imported records will not have a BookControl number.
                If Item.SolutionDetailBookControl = 0 Then
                    'if the newDetailIndex is the same as the index we are on, then we must call the updateFull method instead of the quick update stop method.
                    If i = newDetailIndex Then
                        success = UpdateNewPOWithLoadPlanningCarrier30(truck, Item, stopNumbCounter, False)
                    Else
                        success = UpdateLoadPlanningNewStopNo30(truck, Item, stopNumbCounter, False)
                    End If
                Else
                    If i = newDetailIndex Then
                        success = UpdateLoadPlanningCarrierWithTruck30(truck, Item, stopNumbCounter, False)
                    Else
                        success = UpdateLoadPlanningNewStopNo30(truck, Item, stopNumbCounter, False)
                    End If
                End If
                prevAddr = currAddr
                If success = False Then
                    Exit For
                End If
            Next

            result.Success = success
        Catch ex As FaultException
            result.Success = False
            result.Exception = ex
            Throw ex
        Catch ex As InvalidOperationException
            result.Success = False
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Dim exFaultException As New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            result.Exception = exFaultException
            Throw exFaultException
        Catch ex As System.Data.SqlClient.SqlException
            result.Success = False
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Dim exFaultException As New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            result.Exception = exFaultException
            Throw exFaultException
        Catch ex As Exception
            result.Success = False
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Dim exFaultException As New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            result.Exception = exFaultException
            Throw exFaultException
        Finally

        End Try
        Return result
    End Function

    Private Function UpdateLoadPlanningCarrierWithTruck30(ByVal newTruck As DTO.tblSolutionTruck, ByVal detailItem As DTO.tblSolutionDetail, ByRef newStopNo As Integer, ByVal refreshTruck As Boolean) As Boolean
        Dim success As Boolean = False
        'Try
        UpdateLoadPlanningCarrier(detailItem.SolutionDetailBookControl, _
                                                                              newTruck.SolutionTruckConsPrefix, _
                                                                              detailItem.SolutionDetailRouteConsFlag, _
                                                                              newStopNo,
                                                                              newTruck.SolutionTruckCarrierControl,
                                                                              newTruck.SolutionTruckCarrierTruckControl)
        success = True

        'Catch ex As FaultException
        '    Throw
        'Catch ex As InvalidOperationException
        '    success = False
        '    Utilities.SaveAppError(ex.Message, Me.Parameters)
        '    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))

        'Catch ex As Exception
        '    success = False
        '    Utilities.SaveAppError(ex.Message, Me.Parameters)
        '    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
        'End Try
        Return success
    End Function

    Private Function UpdateNewPOWithLoadPlanningCarrier30(ByVal newTruck As DTO.tblSolutionTruck, ByVal detailItem As DTO.tblSolutionDetail, ByRef newStopNo As Integer, ByVal refreshTruck As Boolean) As Boolean
        Dim success As Boolean = False
        'Try
        'get consIntegrity flag from other load
        Dim consFlag As Boolean = True
        Dim holdLoad As Integer = 0

        If newTruck.SolutionDetails.Count = 0 Then
            consFlag = True
            holdLoad = 0
        Else
            consFlag = newTruck.SolutionDetails(0).SolutionDetailRouteConsFlag
            holdLoad = newTruck.SolutionDetails(0).SolutionDetailHoldLoad
        End If

        UpdateNewPOWithLoadPlanningCarrier(detailItem.SolutionDetailOrderNumber, _
                                                                              detailItem.SolutionDetailOrderSequence, _
                                                                              detailItem.SolutionDetailCompNumber, _
                                                                              newTruck.SolutionTruckConsPrefix, _
                                                                              consFlag, _
                                                                              newStopNo,
                                                                              newTruck.SolutionTruckCarrierControl, _
                                                                              newTruck.SolutionTruckCarrierTruckControl, _
                                                                              holdLoad)
        success = True

        'Catch ex As FaultException
        '    Throw
        'Catch ex As InvalidOperationException
        '    success = False
        '    Utilities.SaveAppError(ex.Message, Me.Parameters)
        '    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))

        'Catch ex As Exception
        '    success = False
        '    Utilities.SaveAppError(ex.Message, Me.Parameters)
        '    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
        'End Try
        Return success
    End Function

    Private Function UpdateLoadPlanningNewStopNo30(ByVal newTruck As DTO.tblSolutionTruck, ByVal detailItem As DTO.tblSolutionDetail, ByRef newStopNo As Integer, ByVal refreshTruck As Boolean) As Boolean
        Dim success As Boolean = False
        'Try

        UpdateLoadPlanningStopNo(detailItem.SolutionDetailBookControl, newStopNo)
        success = True
        'Catch ex As FaultException
        '    Throw
        'Catch ex As InvalidOperationException
        '    success = False
        '    Utilities.SaveAppError(ex.Message, Me.Parameters)
        '    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))

        'Catch ex As Exception
        '    success = False
        '    Utilities.SaveAppError(ex.Message, Me.Parameters)
        '    Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
        'End Try
        Return success
    End Function

    ' <summary>
    ' calls spUpdateCarrierCons with the following parameters
    ' BookControl integer,
    ' BookConsPrefix string,
    ' BookRouteConsFlag boolean,
    ' BookStopNo integer,
    ' CarrierControl integer,	
    ' </summary>
    ' <param name="BookControl"></param>
    ' <remarks>the runNGLStoredProcedrue method throws the following Fault Exceptions:
    ' E_DataValidationFailure
    ' E_FailedToExecute
    ' E_DBLoginFailure
    ' E_DBConnectionFailure
    ' E_SQLException
    ' E_UnExpected
    ' </remarks>


    ''' <summary>
    ''' calls the spUpdateLoadPlanningCarrier NGL stored procedure 
    ''' </summary>
    ''' <param name="BookControl"></param>
    ''' <param name="BookConsPrefix"></param>
    ''' <param name="BookRouteConsFlag"></param>
    ''' <param name="BookStopNo"></param>
    ''' <param name="CarrierControl"></param>
    ''' <remarks>
    ''' the runNGLStoredProcedrue method throws the following Fault Exceptions:
    ''' E_DataValidationFailure
    ''' E_FailedToExecute
    ''' E_DBLoginFailure
    ''' E_DBConnectionFailure
    ''' E_SQLException
    ''' E_UnExpected
    ''' </remarks>
    Public Sub UpdateLoadPlanningCarrier(ByVal BookControl As Integer, _
                                               ByVal BookConsPrefix As String, _
                                               ByVal BookRouteConsFlag As Boolean, _
                                               ByVal BookStopNo As Integer, _
                                               ByVal CarrierControl As Integer, _
                                               Optional ByVal BookCarrTruckControl As System.Nullable(Of Integer) = Nothing, _
                                               Optional ByVal BookHoldLoad As System.Nullable(Of Integer) = Nothing)
        Dim strProcName As String = "dbo.spUpdateLoadPlanningCarrier"
        Dim oCmd As New System.Data.SqlClient.SqlCommand
        oCmd.Parameters.AddWithValue("@BookControl", BookControl)
        oCmd.Parameters.AddWithValue("@BookConsPrefix", BookConsPrefix)
        oCmd.Parameters.AddWithValue("@BookRouteConsFlag", BookRouteConsFlag)
        oCmd.Parameters.AddWithValue("@BookStopNo", BookStopNo)
        oCmd.Parameters.AddWithValue("@CarrierControl", CarrierControl)
        If BookCarrTruckControl.HasValue Then oCmd.Parameters.AddWithValue("@BookCarrTruckControl", BookCarrTruckControl.Value)
        If BookHoldLoad.HasValue Then oCmd.Parameters.AddWithValue("@BookHoldLoad", BookHoldLoad.Value)
        oCmd.Parameters.AddWithValue("@UserName", Left(Me.Parameters.UserName, 100))
        runNGLStoredProcedure(oCmd, strProcName, 0)
    End Sub

    ''' <summary>
    ''' calls the spUpdateLoadPlanningStopNo NGL stored procedure
    ''' </summary>
    ''' <param name="BookControl"></param>
    ''' <param name="BookStopNo"></param>
    ''' <remarks> 
    ''' the runNGLStoredProcedrue method throws the following Fault Exceptions:
    ''' E_DataValidationFailure
    ''' E_FailedToExecute
    ''' E_DBLoginFailure
    ''' E_DBConnectionFailure
    ''' E_SQLException
    ''' E_UnExpected</remarks>
    Public Sub UpdateLoadPlanningStopNo(ByVal BookControl As Integer, _
                                               ByVal BookStopNo As Integer)
        Dim strProcName As String = "dbo.spUpdateLoadPlanningStopNo"
        Dim oCmd As New System.Data.SqlClient.SqlCommand
        oCmd.Parameters.AddWithValue("@BookControl", BookControl)
        oCmd.Parameters.AddWithValue("@BookStopNo", BookStopNo)
        oCmd.Parameters.AddWithValue("@UserName", Left(Me.Parameters.UserName, 100))
        runNGLStoredProcedure(oCmd, strProcName, 0)
    End Sub

    Public Function UpdateLoadPlanningSplitOrder(ByVal BookControl As Integer, _
                                               ByVal TempOrderSequence As Integer, _
                                               ByVal BookConsPrefix As String, _
                                               ByVal BookRouteConsFlag As Boolean, _
                                               ByVal BookStopNo As Integer, _
                                               ByVal CarrierControl As Integer, _
                                               Optional ByVal BookCarrTruckControl As System.Nullable(Of Integer) = Nothing, _
                                               Optional ByVal BookHoldLoad As System.Nullable(Of Integer) = Nothing) As LTS.spUpdateLoadPlanningSplitOrderResult

        Using db As New NGLMasBookDataContext(ConnectionString)
            Try


                Dim oResults = db.spUpdateLoadPlanningSplitOrder(BookControl, _
                                                    TempOrderSequence, _
                                                   BookConsPrefix, _
                                                   BookRouteConsFlag, _
                                                   BookStopNo, _
                                                   CarrierControl, _
                                                   BookCarrTruckControl, _
                                                   BookHoldLoad, _
                                                   Me.Parameters.UserName)

                If Not oResults Is Nothing Then
                    Return oResults.FirstOrDefault
                Else
                    Return Nothing
                End If


            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))

            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using

    End Function

    Public Sub TenderLoadFromLoadPlanning(ByVal BookConsPrefix As String)
        Dim strProcName As String = "dbo.spTenderLoadFromLoadPlanning"
        Dim oCmd As New System.Data.SqlClient.SqlCommand
        oCmd.Parameters.AddWithValue("@BookConsPrefix", Left(BookConsPrefix, 20))
        oCmd.Parameters.AddWithValue("@UserName", Left(Me.Parameters.UserName, 100))
        runNGLStoredProcedure(oCmd, strProcName, 0)
    End Sub

    ' TO DO: modify this routine as a sub routine that spawns a new thread.  the new thread should check 
    'Global parameters and wait for any previous processes to complete before starting.
    Public Sub TryToRouteLoad(ByVal BookProNumber As String)
        Dim NewBookingDataObject As New NGLNewBookingsForSolutionData(Me.Parameters)
        Dim newBooking = NewBookingDataObject.GetNewBookingFilteredByPro(BookProNumber)
        If Not newBooking Is Nothing AndAlso newBooking.SolutionDetailRouteGuideControl <> 0 Then
            RouteLoads(New List(Of DTO.tblSolutionDetail) From {newBooking}, True)
        End If
    End Sub

    Public Sub TryToRouteLoadAsync(ByVal BookProNumber As String)

        Dim newBooking = CType(NDPBaseClassFactory("NGLNewBookingsForSolutionData"), NGLNewBookingsForSolutionData).GetNewBookingFilteredByPro(BookProNumber)
        If Not newBooking Is Nothing AndAlso newBooking.SolutionDetailRouteGuideControl <> 0 Then
            Dim fetcher As New ProcessDataDelegate(AddressOf Me.prepareToRouteLoads)
            ' Launch thread
            fetcher.BeginInvoke(New List(Of DTO.tblSolutionDetail) From {newBooking}, True, Nothing, Nothing)
        Else
            Dim fetcher As New ProcessUnRoutedDataDelegate(AddressOf Me.processUnRoutedLoads)
            ' Launch thread
            fetcher.BeginInvoke(New List(Of DTO.tblSolutionDetail) From {newBooking}, Nothing, Nothing)
        End If
    End Sub

    Public Function WriteNewBooking(ByVal strOrderNumber As String, _
                                                    ByVal intOrderSequence As Integer, _
                                                    ByVal intDefCompNumber As Integer) As String
        'Get the Next Pro Number 
        Dim strProBase As String = getScalarString("Exec spGetNextProBase")
        Dim strProAbrev As String = getScalarString("Exec spGetProAbrev 0," & intDefCompNumber.ToString)
        Dim strNewPro As String = strProAbrev & strProBase
        If String.IsNullOrEmpty(strNewPro) OrElse strNewPro.Trim.Length < 1 Then
            Utilities.SaveAppError("The system could not generate a new Pro Number.", Me.Parameters)
            Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_FailedToExecute"}, New FaultReason("E_InvalidOperationException"))
        End If
        'Update the status of the record to received.
        Dim oCmd As New System.Data.SqlClient.SqlCommand
        oCmd.Parameters.AddWithValue("@NewPRONumber", strNewPro)
        oCmd.Parameters.AddWithValue("@PROBase", strProBase)
        oCmd.Parameters.AddWithValue("@pohdrOrderNumber", strOrderNumber)
        oCmd.Parameters.AddWithValue("@POHDROrderSequence", intOrderSequence)
        oCmd.Parameters.AddWithValue("@POHdrDefCustNumber", intDefCompNumber)
        runNGLStoredProcedure(oCmd, "dbo.WriteNewBooking", 3)

        Return strNewPro

    End Function

    Public Sub UpdateNewPOWithLoadPlanningCarrier(ByVal OrderNumber As String, _
                                                  ByVal OrderSequence As Integer, _
                                                  ByVal CompNumber As Integer, _
                                                  ByVal BookConsPrefix As String, _
                                                  ByVal BookRouteConsFlag As Boolean, _
                                                  ByVal BookStopNo As Integer, _
                                                  ByVal CarrierControl As Integer, _
                                                  ByVal BookCarrTruckControl As Integer, _
                                                  ByVal BookHoldLoad As Integer)
        Dim strNewPro = WriteNewBooking(OrderNumber, OrderSequence, CompNumber)
        Dim strProcName As String = "dbo.spUpdateLoadPlanningCarrierWithPro"
        Dim oCmd As New System.Data.SqlClient.SqlCommand
        oCmd.Parameters.AddWithValue("@BookProNumber", strNewPro)
        oCmd.Parameters.AddWithValue("@BookConsPrefix", BookConsPrefix)
        oCmd.Parameters.AddWithValue("@BookRouteConsFlag", BookRouteConsFlag)
        oCmd.Parameters.AddWithValue("@BookStopNo", BookStopNo)
        oCmd.Parameters.AddWithValue("@CarrierControl", CarrierControl)
        oCmd.Parameters.AddWithValue("@BookCarrTruckControl", BookCarrTruckControl)
        oCmd.Parameters.AddWithValue("@BookHoldLoad", BookHoldLoad)
        oCmd.Parameters.AddWithValue("@UserName", Left(Me.Parameters.UserName, 100))
        runNGLStoredProcedure(oCmd, strProcName, 0)
    End Sub

    Public Sub UpdateDefaultCarrierForUnRouted(ByVal BookControl As Integer)
        Dim strProcName As String = "dbo.spUpdateDefaultCarrierForUnRouted"
        Dim oCmd As New System.Data.SqlClient.SqlCommand
        oCmd.Parameters.AddWithValue("@BookControl", BookControl)
        oCmd.Parameters.AddWithValue("@UserName", Left(Me.Parameters.UserName, 100))
        runNGLStoredProcedure(oCmd, strProcName, 0)
    End Sub

    Public Sub prepareToRouteLoads(ByRef lOrders As List(Of DTO.tblSolutionDetail), ByVal OptimizeCapacity As Boolean)
        Try
            'Debug Error Message to Test Routing 
            'Utilities.SaveAppError("Preparing to Route Loads.", Me.Parameters)
            Dim blnNeedToCallRouteLoads As Boolean = False
            If Not lOrders Is Nothing AndAlso lOrders.Count > 0 Then
                'Debug Error Message to Test Routing 
                'Utilities.SaveAppError("Adding " & lOrders.Count & " orders to be routed.", Me.Parameters)
                'lock other threads from executing
                SyncLock mSharedPadLock
                    If mSharedOrdersToRoute Is Nothing Then mSharedOrdersToRoute = New List(Of DTO.tblSolutionDetail)
                    For Each o In lOrders
                        If Not o Is Nothing Then
                            Dim pronumber = o.SolutionDetailProNumber
                            Dim exists As Boolean = mSharedOrdersToRoute.Any(Function(x) x.SolutionDetailProNumber = pronumber)
                            If Not exists Then mSharedOrdersToRoute.Add(o)
                        End If
                    Next
                    'Debug Error Message to Test Routing 
                    'Utilities.SaveAppError(mSharedOrdersToRoute.Count & " orders are ready to route.", Me.Parameters)
                    'Read the shared flag 
                    blnNeedToCallRouteLoads = Not mSharedLoadsBeingRouted
                    'this will prevent other threads from calling RouteLoads again
                    'because RouteLoads is called outside of SyncLock
                    If blnNeedToCallRouteLoads Then mSharedLoadsBeingRouted = True
                End SyncLock
                If blnNeedToCallRouteLoads Then
                    'Debug Error Message to Test Routing 
                    'Utilities.SaveAppError("Calling RouteLoads", Me.Parameters)
                    RouteLoads(OptimizeCapacity)
                Else
                    'Debug Error Message to Test Routing 
                    'Utilities.SaveAppError("Loads are already being routed", Me.Parameters)
                End If
            End If
        Catch ex As Exception
            Utilities.SaveAppError(ex.ToString, Me.Parameters)
            Utilities.SendToNGLEmailService("System Error! Unexpected Routing Guide System Exception", "Unexpected Error: Unable to prepare loads for routing. <br />" & vbCrLf & ex.ToString, Me.Parameters, False)
        End Try
    End Sub

    Public Sub processUnRoutedLoads(ByRef lOrders As List(Of DTO.tblSolutionDetail))
        Dim strUpdateDefCarrierDataErrors As New List(Of String)
        Try
            For Each o In lOrders
                Try
                    UpdateDefaultCarrierForUnRouted(o.SolutionDetailBookControl)
                Catch ex As FaultException(Of SqlFaultInfo)
                    strUpdateDefCarrierDataErrors.Add("Order Number: " & o.OrderNumber & " " & ex.Detail.Message & "<br />" & vbCrLf & ex.Detail.Details & "<br />" & vbCrLf)
                Catch ex As Exception
                    strUpdateDefCarrierDataErrors.Add("Order Number: " & o.OrderNumber & " " & ex.Message & "<br />" & vbCrLf)
                    Continue For
                End Try
            Next
            If Not strUpdateDefCarrierDataErrors Is Nothing AndAlso strUpdateDefCarrierDataErrors.Count > 0 Then
                Dim strEmailBody As String = String.Concat(strUpdateDefCarrierDataErrors.ToArray())
                Utilities.SaveAppError(strEmailBody, Me.Parameters)
                Utilities.SendToNGLEmailService("Errors while updating the default carriers! ", strEmailBody, Me.Parameters, True, True)
            End If

        Catch ex As Exception
            Utilities.SaveAppError(ex.ToString, Me.Parameters)
            Utilities.SendToNGLEmailService("Unexpected System Error while updating the default carriers", "Unexpected Error: Unable to update orders with default carrier data. <br />" & vbCrLf & ex.ToString, Me.Parameters, False)

        End Try
    End Sub

    Public Sub RouteLoads(ByRef lOrders As List(Of DTO.tblSolutionDetail), ByVal OptimizeCapacity As Boolean)
        Try
            Dim blnNeedToCallRouteLoads As Boolean = False
            If Not lOrders Is Nothing AndAlso lOrders.Count > 0 Then
                'lock other threads
                SyncLock mSharedPadLock
                    If mSharedOrdersToRoute Is Nothing Then mSharedOrdersToRoute = New List(Of DTO.tblSolutionDetail)
                    For Each o In lOrders
                        If Not o Is Nothing Then
                            Dim pronumber = o.SolutionDetailProNumber
                            Dim exists As Boolean = mSharedOrdersToRoute.Any(Function(x) x.SolutionDetailProNumber = pronumber)
                            If Not exists Then mSharedOrdersToRoute.Add(o)
                        End If
                    Next
                    blnNeedToCallRouteLoads = Not mSharedLoadsBeingRouted
                End SyncLock
                'oOrdersToRoute.AddRange(lOrders)
                If blnNeedToCallRouteLoads Then RouteLoads(OptimizeCapacity)
            End If
        Catch ex As Exception
            Utilities.SaveAppError(ex.ToString, Me.Parameters)
            Utilities.SendToNGLEmailService("System Error! Unexpected Routing Guide System Exception", "Unexpected Error: Unable to route loads using routing guide! <br />" & vbCrLf & ex.ToString, Me.Parameters, False)
        End Try
    End Sub

    ''' <summary>
    ''' This method attempts to route loads according to the routing guide 
    ''' any orders that cannot be routed are returned in the result list  
    ''' </summary>
    ''' <param name="OptimizeCapacity"></param>
    ''' <remarks></remarks>
    Public Sub RouteLoads(ByVal OptimizeCapacity As Boolean)
        'enmRtCapPref
        '0 = Sequence
        '1 = Cases
        '2 = Weight
        '3 = Pallets
        '4 = Cubes   
        Dim strCurrentOrder As String = "{Not Found}"
        Try

            Dim enmRtCapPref As DTO.tblSolutionTruck.RoutingCapacityPreference = DataTransferObjects.tblSolutionTruck.RoutingCapacityPreference.Pallets
            Dim lTrucks As New List(Of DTO.tblSolutionTruck)
            Dim providerStaticRoute As NGLtblStaticRouteData = Me.NDPBaseClassFactory("NGLtblStaticRouteData")
            Dim BookItemData As NGLBookItemData = Me.NDPBaseClassFactory("NGLBookItemData")
            Dim strUnexpectedErrors As New List(Of String)
            Dim strNotLoadedErrors As New List(Of String)
            Dim blnStopProcessing As Boolean = False
            'Debug Error Message to Test Routing 
            'Utilities.SaveAppError("RouteLoads Running.", Me.Parameters)
            Do
                Dim oSorted As New List(Of DTO.tblSolutionDetail)
                'Lock other threads
                SyncLock mSharedPadLock
                    mSharedLoadsBeingRouted = True
                    'Debug Error Message to Test Routing 
                    'Utilities.SaveAppError("Loads being routed is now true ", Me.Parameters)
                    'Debug Error Message to Test Routing 
                    'Utilities.SaveAppError("Shared Order Available " & mSharedOrdersToRoute.Count & " Shared Orders.", Me.Parameters)
                    'Debug Error Message to Test Routing 
                    'Utilities.SaveAppError("Sorted Orders Available " & oSorted.Count & " Sorted Orders.", Me.Parameters)
                    If Not mSharedOrdersToRoute Is Nothing AndAlso mSharedOrdersToRoute.Count > 0 Then
                        'sort the records by location and order
                        oSorted = (From d In mSharedOrdersToRoute Order By d.LaneLocation, d.OrderNumber Descending Select d).ToList
                    End If
                    If Not oSorted Is Nothing AndAlso oSorted.Count > 0 Then
                        'Debug Error Message to Test Routing 
                        'Utilities.SaveAppError("Read " & oSorted.Count & " Sorted Orders.", Me.Parameters)
                        For Each o In oSorted
                            'Debug Error Message to Test Routing 
                            'Utilities.SaveAppError("Searching For ProNumber to remove: " & o.SolutionDetailProNumber, Me.Parameters)
                            For Each m In mSharedOrdersToRoute
                                If m.SolutionDetailProNumber = o.SolutionDetailProNumber Then
                                    'Debug Error Message to Test Routing 
                                    'Utilities.SaveAppError("Removed ProNumber: " & o.SolutionDetailProNumber, Me.Parameters)
                                    mSharedOrdersToRoute.Remove(m)
                                    Exit For
                                End If
                            Next
                        Next
                        'Debug Error Message to Test Routing 
                        'Utilities.SaveAppError("Shared Order After Remove " & mSharedOrdersToRoute.Count & " Shared Orders.", Me.Parameters)
                    Else
                        'allow RouteLoads to be called again
                        mSharedLoadsBeingRouted = False
                        'Debug Error Message to Test Routing 
                        'Utilities.SaveAppError("Loads being routed is now false no orders left", Me.Parameters)
                        blnStopProcessing = True
                        Exit Do
                    End If
                End SyncLock
                'Debug Error Message to Test Routing 
                'Utilities.SaveAppError("Routing " & oSorted.Count & " Sorted Orders.", Me.Parameters)
                '*********************************  TO DO ****************************************************               
                'Add code to use lcarriers when selecting or creating a new truck.  we always start with the smallest piece of equipment for a new truck that will hold the order or load to be routed
                '
                'Complete the code that checks if a larger truck is available
                '
                'Add logic to check if we fill the largest truck first based on the route guide setting
                '
                'Add code to get the Route Configuration for each piece of equipment? or for each order?  (by order my be the best option now that I think of it)
                '
                'Check the logic that uses the LN list:
                '   Dim MasterBuild = lTrucks.Where(Function(p) p.Orders.Any(Function(y) LN.Contains(y.LaneLocation)))
                '   this may not work as expected because we are refreshing the truck list with each order (some thought and understanding of this is required)
                '
                '**********************************************************************************************
                If oSorted Is Nothing OrElse oSorted.Count < 1 Then Continue Do
                OrdersNotLoaded = New List(Of DTO.tblSolutionDetail)
                For Each o In oSorted
                    'Debug Error Message to Test Routing 
                    'Utilities.SaveAppError("Route Loads is finished processing order number " & mSharedLastOrderNumber & ".", Me.Parameters)
                    strCurrentOrder = o.OrderNumber
                    'lock other threads
                    SyncLock mSharedPadLock
                        mSharedLastOrderNumber = strCurrentOrder
                    End SyncLock
                    'Debug Error Message to Test Routing 
                    'Utilities.SaveAppError("Route Loads is starting to process order number " & mSharedLastOrderNumber & ".", Me.Parameters)
                    Try
                        Dim blnLoaded As Boolean = False
                        'get the static route data for this order
                        If o.SolutionDetailRouteGuideControl = 0 Then
                            'note:  we need to add a message or attribute control for why this load was not loaded
                            'to be appended to the attributes list
                            strNotLoadedErrors.Add("Cannot Route Order Number, " & o.OrderNumber & ", because it has not been assigned a routing guide.<br />" & vbCrLf)
                            AddToNotLoaded(o)
                            Continue For
                        End If
                        StaticRouteData = providerStaticRoute.GettblStaticRouteFiltered(o.SolutionDetailRouteGuideControl)
                        If StaticRouteData Is Nothing Then
                            strNotLoadedErrors.Add("Cannot Route Order Number, " & o.OrderNumber & ", because the system could not read the static route guide settings.<br />" & vbCrLf)
                            AddToNotLoaded(o)
                            Continue For
                        End If
                        o.Details = BookItemData.GetBookItemsFiltered(o.SolutionDetailBookLoadControl).ToList

                        enmRtCapPref = StaticRouteData.StaticRouteCapacityPreference
                        'get a list of available carriers and their trucks, we pass zero for capacity to be sure we can route smaller loads together and that we can split orders.
                        ListAvailableEquipment = GetCarriersForRoute(o.SolutionDetailCompControl, o.SolutionDetailRouteGuideControl, o.SolutionDetailRouteTypeCode, o.SolutionDetailTransType, o.SolutionDetailDestState, o.SolutionDetailDateLoad, o.SolutionDetailDateRequired, 0, 0, 0, 0, o.SolutionDetailCom, o.SolutionDetailIsHazmat).ToList
                        If ListAvailableEquipment Is Nothing OrElse ListAvailableEquipment.Count < 1 Then
                            'note:  we need to add a message or attribute control for why this load was not loaded
                            'to be appended to the attributes list
                            strNotLoadedErrors.Add("Cannot Route Order Number, " & o.OrderNumber & ", because no equipment types match the order requirements.<br />" & vbCrLf)
                            AddToNotLoaded(o)
                            Continue For
                        End If
                        'check the route type and filter the matching loads/trucks as needed
                        Select Case o.SolutionDetailRouteTypeCode
                            Case DTO.tblSolutionTruck.RouteTypeCodes.Single_LTL
                                lTrucks = Nothing
                                addNewTruck(lTrucks, enmRtCapPref, o)
                            Case DTO.tblSolutionTruck.RouteTypeCodes.Full_Load
                                'filter the list by address
                                Dim strLaneLocation As String = o.LaneLocation
                                lTrucks = GetMatchingRoutedLoads(o.SolutionDetailCompControl, o.SolutionDetailSolutionTruckControl, o.SolutionDetailDateLoad, o.SolutionDetailTransType, "P", o.SolutionDetailRouteGuideControl, o.SolutionDetailRouteTypeCode).Where(Function(x) x.Orders(0).LaneLocation = strLaneLocation).ToList
                            Case Else
                                'get all available loads that match
                                lTrucks = GetMatchingRoutedLoads(o.SolutionDetailCompControl, o.SolutionDetailSolutionTruckControl, o.SolutionDetailDateLoad, o.SolutionDetailTransType, "P", o.SolutionDetailRouteGuideControl, o.SolutionDetailRouteTypeCode).ToList
                        End Select
                        'if the list of matching loads is empty we need to add a default truck
                        Dim lInvalidTrucks As New List(Of DTO.tblSolutionTruck)
                        If lTrucks Is Nothing OrElse lTrucks.Count < 1 Then
                            addNewTruck(lTrucks, enmRtCapPref)
                        Else
                            Dim oBookLoadControls As List(Of Integer) = (From t In lTrucks From l In t.Orders Select l.SolutionDetailBookLoadControl).ToList()
                            Dim oDetailsList As List(Of DTO.BookItem) = BookItemData.GetBookItemsFiltered(oBookLoadControls)
                            For Each t In lTrucks
                                t.Parameters = Me.Parameters
                                t.TruckDataObject = Me
                                t.BatchProcessingDataObject = New NGLBatchProcessDataProvider(Me.Parameters)
                                t.BookItemDataObject = New NGLBookItemData(Me.Parameters)
                                t.RouteConfig = GetRouteConfigForEquipment(Me.StaticRouteData.StaticRouteControl, t.SolutionTruckCarrierControl, t.SolutionTruckCarrierTruckControl)
                                If t.RouteConfig Is Nothing Then
                                    lInvalidTrucks.Add(t)
                                Else
                                    If Not t.Orders Is Nothing AndAlso t.Orders.Count > 0 Then
                                        For Each order In t.Orders
                                            Dim intBookLoadControl = order.SolutionDetailBookLoadControl
                                            order.Details = (From d In oDetailsList Where d.BookItemBookLoadControl = intBookLoadControl Select d).ToList()
                                            'order.Details = BookItemData.GetBookItemsFiltered(order.SolutionDetailBookLoadControl).ToList
                                        Next
                                    End If
                                End If
                            Next
                        End If
                        If Not lInvalidTrucks Is Nothing AndAlso lInvalidTrucks.Count > 0 Then
                            For Each t In lInvalidTrucks
                                If lTrucks.Contains(t) Then lTrucks.Remove(t)
                            Next
                            If lTrucks Is Nothing OrElse lTrucks.Count < 1 Then
                                addNewTruck(lTrucks, enmRtCapPref)
                            End If
                        End If

                        Dim LN As New List(Of String)
                        LN.Add(o.LaneLocation)

                        If enmRtCapPref = DTO.tblSolutionTruck.RoutingCapacityPreference.Sequence Then
                            If Not lTrucks Is Nothing AndAlso lTrucks.Count > 0 Then
                                Dim previousTruck As DTO.tblSolutionTruck = Nothing
                                Dim tCount = lTrucks.Count
                                Dim cCount = 0
                                For Each t In lTrucks.OrderBy(Function(x) x.MinSequence)
                                    cCount += 1
                                    If previousTruck Is Nothing Then
                                        If cCount = tCount OrElse t.MaxSequence = 0 OrElse t.MaxSequence >= o.RouteSequence Then
                                            If t.masterBuild(o, lTrucks, enmRtCapPref) Then
                                                blnLoaded = True
                                                Exit For
                                            Else
                                                strNotLoadedErrors.Add("Cannot Route Order Number, " & o.OrderNumber & ", because it did not meet the routing guide requirements.<br />" & vbCrLf)
                                                AddToNotLoaded(o)
                                                Exit For
                                            End If
                                        Else
                                            previousTruck = t
                                        End If
                                    Else
                                        If cCount = tCount OrElse t.MinSequence = 0 OrElse t.MaxSequence = 0 Then
                                            If t.masterBuild(o, lTrucks, enmRtCapPref) Then
                                                blnLoaded = True
                                                Exit For
                                            Else
                                                strNotLoadedErrors.Add("Cannot Route Order Number, " & o.OrderNumber & ", because it did not meet the routing guide requirements.<br />" & vbCrLf)
                                                AddToNotLoaded(o)
                                                Exit For
                                            End If
                                        Else
                                            If t.MinSequence > o.RouteSequence Then
                                                'try to put this order on the previous truck
                                                If previousTruck.masterBuild(o, lTrucks, enmRtCapPref) Then
                                                    blnLoaded = True
                                                    Exit For
                                                Else
                                                    'try to put this order ont the current truck
                                                    If t.masterBuild(o, lTrucks, enmRtCapPref) Then
                                                        blnLoaded = True
                                                        Exit For
                                                    Else
                                                        strNotLoadedErrors.Add("Cannot Route Order Number, " & o.OrderNumber & ", because it did not meet the routing guide requirements.<br />" & vbCrLf)
                                                        AddToNotLoaded(o)
                                                        Exit For
                                                    End If
                                                End If

                                            ElseIf t.MinSequence = o.RouteSequence Then
                                                'this truck already has an order with this sequence so see if there is room for this order
                                                If t.masterBuild(o, lTrucks, enmRtCapPref, True) Then
                                                    blnLoaded = True
                                                    Exit For
                                                Else
                                                    'try to put this order on the previous truck
                                                    If previousTruck.masterBuild(o, lTrucks, enmRtCapPref, True) Then
                                                        blnLoaded = True
                                                        Exit For
                                                    Else
                                                        'try again to put this order on the current truck but this time without the match seq only flag
                                                        If t.masterBuild(o, lTrucks, enmRtCapPref) Then
                                                            blnLoaded = True
                                                            Exit For
                                                        Else
                                                            strNotLoadedErrors.Add("Cannot Route Order Number, " & o.OrderNumber & ", because it did not meet the routing guide requirements.<br />" & vbCrLf)
                                                            AddToNotLoaded(o)
                                                            Exit For
                                                        End If
                                                    End If
                                                End If
                                            ElseIf t.MinSequence <= o.RouteSequence And t.MaxSequence >= o.RouteSequence Then
                                                If t.masterBuild(o, lTrucks, enmRtCapPref) Then
                                                    blnLoaded = True
                                                    Exit For
                                                Else
                                                    strNotLoadedErrors.Add("Cannot Route Order Number, " & o.OrderNumber & ", because it did not meet the routing guide requirements.<br />" & vbCrLf)
                                                    AddToNotLoaded(o)
                                                    Exit For
                                                End If
                                            Else
                                                previousTruck = t
                                            End If
                                        End If
                                    End If
                                Next
                            End If
                        Else
                            'we group orders by destination
                            'Build a list of trucks that have orders with the same lane number (typically one but may be more if more than a full truck load of orders exists for any given lane)
                            Dim MasterBuild = lTrucks.Where(Function(p) p.Orders.Any(Function(y) LN.Contains(y.LaneLocation)))
                            If Not MasterBuild Is Nothing AndAlso MasterBuild.Count > 0 Then
                                'we use a for loop because items may be added or removed from the collection
                                For truck = 0 To MasterBuild.Count - 1
                                    Dim t As DTO.tblSolutionTruck = MasterBuild(truck)
                                    If t.masterBuild(o, lTrucks, enmRtCapPref) Then
                                        blnLoaded = True
                                        Exit For
                                    Else
                                        'master build failed, trying next truck
                                    End If
                                Next
                            End If
                            'If no match found then try to fit the load on any truck available sorted by trucks with the smallest capacity
                            If Not blnLoaded Then
                                For Each t In lTrucks
                                    If t.addOrder(o, enmRtCapPref) Then
                                        blnLoaded = True
                                        Exit For
                                    End If
                                Next
                            End If
                        End If
                        'if we get here no trucks are available so create a new truck
                        If Not blnLoaded Then
                            Dim newTruck As DTO.tblSolutionTruck = addNewTruck(lTrucks, enmRtCapPref, o, True)
                            'Modified by RHR 2/19/13 we do not need to call lTrucks.Add after addNewTruck because 
                            'it is already added to the collection.
                            'lTrucks.Add(newTruck)
                            If Not newTruck.addOrderWSplit(o, lTrucks, enmRtCapPref) Then
                                If newTruck.Orders Is Nothing OrElse newTruck.Orders.Count < 1 Then lTrucks.Remove(newTruck)
                                strNotLoadedErrors.Add("Cannot Route Order Number, " & o.OrderNumber & ", because it did not meet the routing guide requirements.<br />" & vbCrLf)
                                AddToNotLoaded(o)
                            End If
                        End If
                        'optimize capacity and equipment size


                        If enmRtCapPref <> DTO.tblSolutionTruck.RoutingCapacityPreference.Sequence Then
                            'optimize capacity
                            If Me.StaticRouteData.StaticRouteFillLargestFirst Then
                                'try to move orders from smaller loads onto the larger trucks
                                For Each t In lTrucks.OrderByDescending(Function(x) x.TotalWgt).Where(Function(y) y.atCapacity = False)
                                    Dim spaceleft As Double = 0
                                    Dim strCNS As String = t.CNS
                                    Dim dblMaxWeight As Double = t.maxWgt
                                    Dim blnMatchFound As Boolean = False
                                    Dim trucksleft As List(Of DTO.tblSolutionTruck) = (From lt In lTrucks Where ((lt.maxWgt = dblMaxWeight And lt.atCapacity = False) Or (lt.maxWgt < dblMaxWeight)) And lt.CNS <> strCNS Order By lt.maxWgt Select lt).ToList
                                    If Not trucksleft Is Nothing AndAlso trucksleft.Count > 0 Then
                                        optimizeLoadByCapacity(t, trucksleft, enmRtCapPref)
                                    End If
                                Next
                            Else
                                'optimize for smallest truck
                                'try to move orders from non full larger trucks to fill smaller trucks (later will will call the resize equipment requirement to maximize cost by size)
                                For Each t In lTrucks.OrderBy(Function(x) x.TotalWgt).Where(Function(y) y.atCapacity = False)
                                    Dim spaceleft As Double = 0
                                    Dim strCNS As String = t.CNS
                                    Dim dblMaxWeight As Double = t.maxWgt
                                    Dim blnMatchFound As Boolean = False
                                    Dim trucksleft As List(Of DTO.tblSolutionTruck) = (From lt In lTrucks Where lt.atCapacity = False And lt.CNS <> strCNS Order By lt.maxWgt Descending Select lt).ToList
                                    If Not trucksleft Is Nothing AndAlso trucksleft.Count > 0 Then
                                        optimizeLoadByCapacity(t, trucksleft, enmRtCapPref)
                                    End If
                                Next
                            End If
                        End If

                    Catch ex As FaultException(Of SqlFaultInfo)
                        Utilities.SaveAppError(ex, Me.Parameters)
                        strNotLoadedErrors.Add(String.Format("Cannot Load Order Number, {0}, because: <br />Reason: {1} <br />Message: {2} <br />Details: {3} <br />{4}", o.OrderNumber, ex.Reason, ex.Detail.Message, ex.Detail.Details, vbCrLf))
                        AddToNotLoaded(o)
                        Continue For
                    Catch ex As Exception
                        Utilities.SaveAppError(ex, Me.Parameters)
                        strNotLoadedErrors.Add("Cannot Route Order Number, " & o.OrderNumber & ", because of an unexpected error: <br />" & ex.Message & "<br />" & vbCrLf)
                        AddToNotLoaded(o)
                        strUnexpectedErrors.Add("Cannot Route Order Number, " & o.OrderNumber & ", because: <br />" & ex.ToString & "<br />" & vbCrLf)
                        Continue For
                    End Try

                    For Each t In lTrucks
                        'this method resized the required equipment to match smaller loads so that we use the smallest piece of equipment
                        'needed on loads that do not fill a full truck of larger capacity.
                        moveLoadToSmallestTruck(t)
                    Next
                    'save the changes
                    For Each t In lTrucks.Where(Function(x) x.TrackingState <> TrackingInfo.Unchanged)
                        Try
                            'If t.TrackingState <> TrackingInfo.Unchanged Then t.SaveChanges()
                            t.SaveChanges()
                        Catch ex As FaultException(Of SqlFaultInfo)
                            Utilities.SaveAppError(ex, Me.Parameters)
                            strNotLoadedErrors.Add(String.Format("Cannot Load Order Number, {0}, because: <br />Reason: {1} <br />Message: {2} <br />Details: {3} <br />{4}", o.OrderNumber, ex.Reason, ex.Detail.Message, ex.Detail.Details, vbCrLf))
                        Catch ex As Exception
                            Utilities.SaveAppError(ex, Me.Parameters)
                            strNotLoadedErrors.Add("Cannot Route Order Number, " & o.OrderNumber & ", because of an unexpected error: <br />" & ex.Message & "<br />" & vbCrLf)
                            strUnexpectedErrors.Add("Cannot Route Order Number, " & o.OrderNumber & ", because of an unexpected system error: <br />" & ex.ToString & "<br />" & vbCrLf)
                        End Try
                    Next
                    'save the changes to any ready to tender loads
                    If Not TrucksReadyToTender Is Nothing AndAlso TrucksReadyToTender.Count > 0 Then
                        For Each t In TrucksReadyToTender
                            Try
                                t.SaveChanges()
                            Catch ex As FaultException(Of SqlFaultInfo)
                                Utilities.SaveAppError(ex, Me.Parameters)
                                strNotLoadedErrors.Add(String.Format("Cannot Load Order Number, {0}, because: <br />Reason: {1} <br />Message: {2} <br />Details: {3} <br />{4}", o.OrderNumber, ex.Reason, ex.Detail.Message, ex.Detail.Details, vbCrLf))
                            Catch ex As Exception
                                Utilities.SaveAppError(ex, Me.Parameters)
                                strNotLoadedErrors.Add("Cannot Route Order Number, " & o.OrderNumber & ", because of an unexpected error: <br />" & ex.Message & "<br />" & vbCrLf)
                                strUnexpectedErrors.Add("Cannot Route Order Number, " & o.OrderNumber & ", because of an unexpected system error: <br />" & ex.ToString & "<br />" & vbCrLf)
                            End Try
                        Next
                    End If
                Next
                Dim strUpdateDefCarrierDataErrors As New List(Of String)

                If Not OrdersNotLoaded Is Nothing AndAlso OrdersNotLoaded.Count > 0 Then
                    For Each o In OrdersNotLoaded
                        Try
                            UpdateDefaultCarrierForUnRouted(o.SolutionDetailBookControl)
                        Catch ex As FaultException(Of SqlFaultInfo)
                            strUpdateDefCarrierDataErrors.Add("Order Number: " & o.OrderNumber & " " & ex.Detail.Message & "<br />" & vbCrLf & ex.Detail.Details & "<br />" & vbCrLf)
                        Catch ex As Exception
                            strUnexpectedErrors.Add("Cannot save default carrier information for unrouted order number, " & o.OrderNumber & ", because:<br />" & ex.ToString & "<br />" & vbCrLf)
                            Continue For
                        End Try
                    Next
                    If Not strUpdateDefCarrierDataErrors Is Nothing AndAlso strUpdateDefCarrierDataErrors.Count > 0 Then
                        Dim strmsg As String = "Errors while updating the default carriers! "
                        For Each s In strUpdateDefCarrierDataErrors
                            strmsg &= s
                        Next
                        strUnexpectedErrors.Add(strmsg)
                    End If
                End If
            Loop While (Not blnStopProcessing)
            'lock other threads
            SyncLock mSharedPadLock
                mSharedLoadsBeingRouted = False
            End SyncLock
            If Not strNotLoadedErrors Is Nothing AndAlso strNotLoadedErrors.Count > 0 Then
                Dim strEmailBody As String = String.Concat(strNotLoadedErrors.ToArray())
                Utilities.SaveAppError(strEmailBody, Me.Parameters)
                Utilities.SendToNGLEmailService("Warning! Some orders could not be routed", strEmailBody, Me.Parameters, True, False)
            End If
            If Not strUnexpectedErrors Is Nothing AndAlso strUnexpectedErrors.Count > 0 Then
                Dim strEmailBody As String = String.Concat(strUnexpectedErrors.ToArray())
                Utilities.SaveAppError(strEmailBody, Me.Parameters)
                Utilities.SendToNGLEmailService("System Error! Unexpected Routing Guide Exception", strEmailBody, Me.Parameters, False)
            End If
        Catch ex As Exception
            Utilities.SaveAppError(ex.Message, Me.Parameters)
            Utilities.SendToNGLEmailService("System Error!  Unexpected Routing Guide Exception", "Unable to route order number, " & strCurrentOrder & ", using routing guide! <br />" & vbCrLf & ex.ToString, Me.Parameters, False)
        Finally
            SyncLock mSharedPadLock
                mSharedLoadsBeingRouted = False
            End SyncLock
        End Try
        'Return OrdersNotLoaded
        Return
    End Sub

    Public Function GetRouteConfigForEquipment(ByVal RouteControl As Integer, ByVal CarrierControl As Integer, ByVal CarrierTruckControl As Integer) As DTO.RouteConfigForEquip
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try

                'Get the first record that matches the criteria in TruckFilter
                Dim RouteConfig As DTO.RouteConfigForEquip = (From d In db.spGetRouteConfigForEquipment(RouteControl, CarrierControl, CarrierTruckControl) _
                                                              Select New DTO.RouteConfigForEquip With {.StaticRouteControl = d.StaticRouteControl _
                                                                                                      , .StaticRouteCarrControl = d.StaticRouteCarrControl _
                                                                                                      , .StaticRouteEquipControl = d.StaticRouteEquipControl _
                                                                                                      , .StaticRouteAutoTenderFlag = d.StaticRouteAutoTenderFlag _
                                                                                                      , .StaticRouteUseShipDateFlag = d.StaticRouteUseShipDateFlag _
                                                                                                      , .StaticRouteGuideDateSelectionDaysBefore = d.StaticRouteGuideDateSelectionDaysBefore _
                                                                                                      , .StaticRouteGuideDateSelectionDaysAfter = d.StaticRouteGuideDateSelectionDaysAfter _
                                                                                                      , .StaticRouteSplitOversizedLoads = d.StaticRouteSplitOversizedLoads _
                                                                                                      , .StaticRouteCapacityPreference = d.StaticRouteCapacityPreference _
                                                                                                      , .StaticRouteRequireAutoTenderApproval = d.StaticRouteRequireAutoTenderApproval _
                                                                                                      , .StaticRouteFillLargestFirst = d.StaticRouteFillLargestFirst _
                                                                                                      , .StaticRoutePlaceOnHold = d.StaticRoutePlaceOnHold _
                                                                                                      , .StaticRouteCarrCarrierControl = d.StaticRouteCarrCarrierControl _
                                                                                                      , .StaticRouteCarrRouteTypeCode = d.StaticRouteCarrRouteTypeCode _
                                                                                                      , .StaticRouteCarrAutoTenderFlag = d.StaticRouteCarrAutoTenderFlag _
                                                                                                      , .StaticRouteCarrTendLeadTime = d.StaticRouteCarrTendLeadTime _
                                                                                                      , .StaticRouteCarrMaxStops = d.StaticRouteCarrMaxStops _
                                                                                                      , .StaticRouteCarrHazmatFlag = d.StaticRouteCarrHazmatFlag _
                                                                                                      , .StaticRouteCarrTransType = d.StaticRouteCarrTransType _
                                                                                                      , .StaticRouteCarrRouteSequence = d.StaticRouteCarrRouteSequence _
                                                                                                      , .StaticRouteCarrRequireAutoTenderApproval = d.StaticRouteCarrRequireAutoTenderApproval _
                                                                                                      , .StaticRouteCarrAutoAcceptLoads = d.StaticRouteCarrAutoAcceptLoads _
                                                                                                      , .StaticRouteStateFilter = d.StaticRouteStateFilter}).FirstOrDefault




                Return RouteConfig

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.ToString, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.ToString, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "The route equipment configuration has not been completed for route " & RouteControl.ToString, .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.ToString, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

            Return Nothing

        End Using
    End Function

    Public Sub AddToNotLoaded(ByRef o As DTO.tblSolutionDetail)

        If OrdersNotLoaded Is Nothing Then OrdersNotLoaded = New List(Of DTO.tblSolutionDetail)
        If Not OrdersNotLoaded.Contains(o) Then OrdersNotLoaded.Add(o)

    End Sub

    Public Sub AddToReadyToTender(ByRef t As DTO.tblSolutionTruck)

        If TrucksReadyToTender Is Nothing Then TrucksReadyToTender = New List(Of DTO.tblSolutionTruck)
        If Not TrucksReadyToTender.Contains(t) Then TrucksReadyToTender.Add(t)

    End Sub

    Public Sub optimizeLoadByCapacity(ByRef t As DTO.tblSolutionTruck, ByRef trucksleft As List(Of DTO.tblSolutionTruck), ByVal enmRtCapPref As DTO.tblSolutionTruck.RoutingCapacityPreference)
        Dim blnMatchFound As Boolean = False
        Dim strCNS As String = t.CNS
        Dim dblMaxWeight As Double = t.maxWgt
        Dim spaceleft As Double = 0

        Do
            blnMatchFound = False
            Select Case enmRtCapPref
                Case DTO.tblSolutionTruck.RoutingCapacityPreference.Cases
                    For Each tl In trucksleft
                        Dim movedLanes As New List(Of String)
                        Dim movedOrders As New List(Of DTO.tblSolutionDetail)
                        For Each o In tl.Orders
                            If Not movedLanes.Contains(o.LaneLocation) Then
                                Dim ordersByLane = tl.consolidateOrders(o, o.LaneLocation)
                                If Not ordersByLane Is Nothing AndAlso ordersByLane.Sum(Function(x) x.Cases) <= (t.maxCases - t.TotalCases) Then
                                    Dim OrderSummary As DTO.clsOrderSummary = tl.getOrderSummary(ordersByLane, o.LaneLocation)
                                    If Not OrderSummary Is Nothing Then
                                        'try to add the orders to this truck
                                        If t.addOrders(ordersByLane, OrderSummary, enmRtCapPref, False) Then
                                            blnMatchFound = True
                                            If Not movedLanes.Contains(o.LaneLocation) Then movedLanes.Add(o.LaneLocation)
                                            For Each movedOrder In ordersByLane
                                                If Not movedOrders.Contains(movedOrder) Then movedOrders.Add(movedOrder)
                                            Next
                                        End If
                                    End If
                                End If
                            End If
                        Next
                        For Each movedOrder In movedOrders
                            If tl.Orders.Contains(movedOrder) Then
                                tl.Orders.Remove(movedOrder)
                                tl.TrackingState = TrackingInfo.Updated
                            End If
                        Next
                    Next
                    spaceleft = t.maxCases - t.TotalCases
                Case DTO.tblSolutionTruck.RoutingCapacityPreference.Weight
                    For Each tl In trucksleft
                        Dim movedLanes As New List(Of String)
                        Dim movedOrders As New List(Of DTO.tblSolutionDetail)
                        For Each o In tl.Orders
                            If Not movedLanes.Contains(o.LaneLocation) Then
                                Dim ordersByLane = tl.consolidateOrders(o, o.LaneLocation)
                                If Not ordersByLane Is Nothing AndAlso ordersByLane.Sum(Function(x) x.Wgt) <= (t.maxWgt - t.TotalWgt) Then
                                    Dim OrderSummary As DTO.clsOrderSummary = tl.getOrderSummary(ordersByLane, o.LaneLocation)
                                    If Not OrderSummary Is Nothing Then
                                        'try to add the orders to this truck
                                        If t.addOrders(ordersByLane, OrderSummary, enmRtCapPref, False) Then
                                            blnMatchFound = True
                                            If Not movedLanes.Contains(o.LaneLocation) Then movedLanes.Add(o.LaneLocation)
                                            For Each movedOrder In ordersByLane
                                                If Not movedOrders.Contains(movedOrder) Then movedOrders.Add(movedOrder)
                                            Next
                                        End If
                                    End If
                                End If
                            End If
                        Next
                        For Each movedOrder In movedOrders
                            If tl.Orders.Contains(movedOrder) Then
                                tl.Orders.Remove(movedOrder)
                                tl.TrackingState = TrackingInfo.Updated
                            End If
                        Next
                    Next
                    spaceleft = t.maxWgt - t.TotalWgt
                Case DTO.tblSolutionTruck.RoutingCapacityPreference.Cubes
                    For Each tl In trucksleft
                        Dim movedLanes As New List(Of String)
                        Dim movedOrders As New List(Of DTO.tblSolutionDetail)
                        For Each o In tl.Orders
                            If Not movedLanes.Contains(o.LaneLocation) Then
                                Dim ordersByLane = tl.consolidateOrders(o, o.LaneLocation)
                                If Not ordersByLane Is Nothing AndAlso ordersByLane.Sum(Function(x) x.Cubes) <= (t.maxCubes - t.TotalCubes) Then
                                    Dim OrderSummary As DTO.clsOrderSummary = tl.getOrderSummary(ordersByLane, o.LaneLocation)
                                    If Not OrderSummary Is Nothing Then
                                        'try to add the orders to this truck
                                        If t.addOrders(ordersByLane, OrderSummary, enmRtCapPref, False) Then
                                            blnMatchFound = True
                                            If Not movedLanes.Contains(o.LaneLocation) Then movedLanes.Add(o.LaneLocation)
                                            For Each movedOrder In ordersByLane
                                                If Not movedOrders.Contains(movedOrder) Then movedOrders.Add(movedOrder)
                                            Next
                                        End If
                                    End If
                                End If
                            End If
                        Next
                        For Each movedOrder In movedOrders
                            If tl.Orders.Contains(movedOrder) Then
                                tl.Orders.Remove(movedOrder)
                                tl.TrackingState = TrackingInfo.Updated
                            End If
                        Next
                    Next
                    spaceleft = t.maxCubes - t.TotalCubes
                Case Else
                    For Each tl In trucksleft
                        Dim movedLanes As New List(Of String)
                        Dim movedOrders As New List(Of DTO.tblSolutionDetail)
                        For Each o In tl.Orders
                            If Not movedLanes.Contains(o.LaneLocation) Then
                                Dim ordersByLane = tl.consolidateOrders(o, o.LaneLocation)
                                If Not ordersByLane Is Nothing AndAlso ordersByLane.Sum(Function(x) x.Plts) <= (t.maxPLTs - t.TotalPlts) Then
                                    Dim OrderSummary As DTO.clsOrderSummary = tl.getOrderSummary(ordersByLane, o.LaneLocation)
                                    If Not OrderSummary Is Nothing Then
                                        'try to add the orders to this truck
                                        If t.addOrders(ordersByLane, OrderSummary, enmRtCapPref, False) Then
                                            blnMatchFound = True
                                            If Not movedLanes.Contains(o.LaneLocation) Then movedLanes.Add(o.LaneLocation)
                                            For Each movedOrder In ordersByLane
                                                If Not movedOrders.Contains(movedOrder) Then movedOrders.Add(movedOrder)
                                            Next
                                        End If
                                    End If
                                End If
                            End If
                        Next
                        For Each movedOrder In movedOrders
                            If tl.Orders.Contains(movedOrder) Then
                                tl.Orders.Remove(movedOrder)
                                tl.TrackingState = TrackingInfo.Updated
                            End If
                        Next
                    Next
                    spaceleft = t.maxPLTs - t.TotalPlts
            End Select
        Loop While blnMatchFound And spaceleft > 0
    End Sub

    Public Function getTempCNSNbr() As String
        Return "TempCNS00" & TempCNSSeed
    End Function

    Public Function addNewTruck(ByRef lTrucks As List(Of DTO.tblSolutionTruck), ByVal RtCapPref As DTO.tblSolutionTruck.RoutingCapacityPreference, Optional ByRef o As DTO.tblSolutionDetail = Nothing, Optional ByVal GetLargest As Boolean = False) As DTO.tblSolutionTruck
        If lTrucks Is Nothing Then lTrucks = New List(Of DTO.tblSolutionTruck)
        Dim newTruck As DTO.tblSolutionTruck = getNewTruck(RtCapPref, New NGLBatchProcessDataProvider(Me.Parameters), New NGLBookItemData(Me.Parameters), o, GetLargest)
        lTrucks.Add(newTruck)
        Return newTruck

    End Function

    Public Function getNewTruck(ByVal RtCapPref As DTO.tblSolutionTruck.RoutingCapacityPreference, ByRef BatchProcessingDataObject As NGLBatchProcessDataProvider, ByRef BookItemDataObject As NGLBookItemData, Optional ByRef o As DTO.tblSolutionDetail = Nothing, Optional ByVal GetLargest As Boolean = False) As DTO.tblSolutionTruck

        If Not o Is Nothing Then
            Return getNewTruck(RtCapPref, New List(Of DTO.tblSolutionDetail) From {o}, BatchProcessingDataObject, BookItemDataObject, GetLargest)
        End If
        Dim e As DTO.CarriersForRoute
        Dim newTruck As New DTO.tblSolutionTruck(Me.Parameters, Me)
        If ListAvailableEquipment Is Nothing OrElse ListAvailableEquipment.Count < 1 Then Return newTruck
        If GetLargest Then
            e = (From d In ListAvailableEquipment Order By d.CarrierTruckMaxWgt Descending, d.StaticRouteCarrRouteSequence Select d).FirstOrDefault
        Else
            e = (From d In ListAvailableEquipment Order By d.CarrierTruckMaxWgt, d.StaticRouteCarrRouteSequence Select d).FirstOrDefault
        End If
        If Not e Is Nothing Then newTruck.updateEquipmentInfo(e)
        Return newTruck
    End Function

    Public Function getNewTruck(ByVal RtCapPref As DTO.tblSolutionTruck.RoutingCapacityPreference, ByRef items As List(Of DTO.tblSolutionDetail), ByRef BatchProcessingDataObject As NGLBatchProcessDataProvider, ByRef BookItemDataObject As NGLBookItemData, Optional ByVal GetLargest As Boolean = False) As DTO.tblSolutionTruck

        Dim e As DTO.CarriersForRoute
        Dim newTruck As New DTO.tblSolutionTruck(Me.Parameters, Me, BatchProcessingDataObject, BookItemDataObject)
        If ListAvailableEquipment Is Nothing OrElse ListAvailableEquipment.Count < 1 Then Return newTruck
        If GetLargest Then
            'just get the largest truck 
            e = (From d In ListAvailableEquipment Order By d.CarrierTruckMaxWgt Descending, d.StaticRouteCarrRouteSequence Select d).FirstOrDefault
        Else
            'find the best truck that will hold the orders
            Select Case RtCapPref
                Case DTO.tblSolutionTruck.RoutingCapacityPreference.Cases
                    Dim totalCases = items.Sum(Function(x) x.Cases)
                    'get the smallest piece of equipment that can hold the items based on the capaciy setting
                    e = (From d In ListAvailableEquipment Where d.CarrierTruckMaxCases >= totalCases Order By d.CarrierTruckMaxCases, d.StaticRouteCarrRouteSequence Select d).FirstOrDefault
                Case DTO.tblSolutionTruck.RoutingCapacityPreference.Weight
                    Dim totalWgt = items.Sum(Function(x) x.Wgt)
                    'get the smallest piece of equipment that can hold the items based on the capaciy setting
                    e = (From d In ListAvailableEquipment Where d.CarrierTruckMaxWgt >= totalWgt Order By d.CarrierTruckMaxWgt, d.StaticRouteCarrRouteSequence Select d).FirstOrDefault
                Case DTO.tblSolutionTruck.RoutingCapacityPreference.Cubes
                    Dim totalCubes = items.Sum(Function(x) x.Cubes)
                    'get the smallest piece of equipment that can hold the items based on the capaciy setting
                    e = (From d In ListAvailableEquipment Where d.CarrierTruckMaxCubes >= totalCubes Order By d.CarrierTruckMaxCubes, d.StaticRouteCarrRouteSequence Select d).FirstOrDefault
                Case Else
                    'we use pallets
                    Dim totalPallets = items.Sum(Function(x) x.Plts)
                    'get the smallest piece of equipment that can hold the items based on the capaciy setting
                    e = (From d In ListAvailableEquipment Where d.CarrierTruckMaxPlts >= totalPallets Order By d.CarrierTruckMaxPlts, d.StaticRouteCarrRouteSequence Select d).FirstOrDefault
            End Select
            If e Is Nothing Then
                'just get the largest truck the system should split the load to fit as needed
                e = (From d In ListAvailableEquipment Order By d.CarrierTruckMaxWgt Descending, d.StaticRouteCarrRouteSequence Select d).FirstOrDefault
            End If
        End If
        If Not e Is Nothing Then newTruck.updateEquipmentInfo(e)
        Return newTruck
    End Function

    Public Function doesLargerTruckExist(ByVal smallTruck As DTO.tblSolutionTruck, ByVal RtCapPref As DTO.tblSolutionTruck.RoutingCapacityPreference, Optional ByVal spaceNeeded As Double = 0) As Boolean

        For Each e In ListAvailableEquipment.OrderBy(Function(x) x.CarrierTruckMaxWgt)
            Select Case RtCapPref
                Case DTO.tblSolutionTruck.RoutingCapacityPreference.Cases
                    If e.CarrierTruckMaxCases > smallTruck.maxCases AndAlso (spaceNeeded = 0 OrElse e.CarrierTruckMaxCases >= spaceNeeded) Then Return True
                Case DTO.tblSolutionTruck.RoutingCapacityPreference.Weight
                    If e.CarrierTruckMaxWgt > smallTruck.maxWgt AndAlso (spaceNeeded = 0 OrElse e.CarrierTruckMaxWgt >= spaceNeeded) Then Return True
                Case DTO.tblSolutionTruck.RoutingCapacityPreference.Cubes
                    If e.CarrierTruckMaxCubes > smallTruck.maxCubes AndAlso (spaceNeeded = 0 OrElse e.CarrierTruckMaxCubes >= spaceNeeded) Then Return True
                Case Else
                    'we use pallets
                    If e.CarrierTruckMaxPlts > smallTruck.maxPLTs AndAlso (spaceNeeded = 0 OrElse e.CarrierTruckMaxPlts >= spaceNeeded) Then Return True
            End Select
        Next

        Return False


    End Function

    ''' <summary>
    ''' We always use weight to determine if this is the largest truck
    ''' </summary>
    ''' <param name="thisTruck"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function isLargestTruck(ByVal thisTruck As DTO.tblSolutionTruck) As Boolean

        Try
            'here we only hace 3 types in produciton we would use a linq query to select the next truck fromn a list of available trucks
            For Each e In ListAvailableEquipment.Where(Function(x) x.CarrierTruckMaxWgt > thisTruck.maxWgt)
                Return False 'if any trucks exist

            Next
        Catch ex As Exception
            'do nothing
        End Try
        'if we get here not trucks are larger so return true
        Return True


    End Function

    Public Function sortTrucksByCapacity(ByRef trucks As List(Of DTO.tblSolutionTruck), ByVal RtCapPref As DTO.tblSolutionTruck.RoutingCapacityPreference, Optional ByVal decending As Boolean = False) As List(Of DTO.tblSolutionTruck)
        Select Case RtCapPref
            Case DTO.tblSolutionTruck.RoutingCapacityPreference.Cases
                If decending Then
                    Return trucks.OrderByDescending(Function(s) s.TotalCases).ToList
                Else
                    Return trucks.OrderBy(Function(s) s.TotalCases).ToList
                End If
            Case DTO.tblSolutionTruck.RoutingCapacityPreference.Weight
                If decending Then
                    Return trucks.OrderByDescending(Function(s) s.TotalWgt).ToList
                Else
                    Return trucks.OrderBy(Function(s) s.TotalWgt).ToList
                End If

            Case DTO.tblSolutionTruck.RoutingCapacityPreference.Pallets
                If decending Then
                    Return trucks.OrderByDescending(Function(s) s.TotalPlts).ToList
                Else
                    Return trucks.OrderBy(Function(s) s.TotalPlts).ToList
                End If

            Case DTO.tblSolutionTruck.RoutingCapacityPreference.Cubes
                If decending Then
                    Return trucks.OrderByDescending(Function(s) s.TotalCubes).ToList
                Else
                    Return trucks.OrderBy(Function(s) s.TotalCubes).ToList
                End If

            Case DTO.tblSolutionTruck.RoutingCapacityPreference.Sequence
                If decending Then
                    Return trucks.OrderByDescending(Function(s) s.TotalPlts).ToList
                Else
                    Return trucks.OrderBy(Function(s) s.TotalPlts).ToList
                End If

            Case Else
                Return trucks
        End Select
    End Function

    Public Function moveLoadToNextLargerTruck(ByRef smallTruck As DTO.tblSolutionTruck, ByVal RtCapPref As DTO.tblSolutionTruck.RoutingCapacityPreference, Optional ByVal spaceNeeded As Double = 0) As Boolean

        For Each e In ListAvailableEquipment.OrderBy(Function(x) x.CarrierTruckMaxWgt)
            Select Case RtCapPref
                Case DTO.tblSolutionTruck.RoutingCapacityPreference.Cases
                    If e.CarrierTruckMaxCases > smallTruck.maxCases AndAlso (spaceNeeded = 0 OrElse e.CarrierTruckMaxCases >= spaceNeeded) Then
                        smallTruck.updateEquipmentInfo(e)
                        Return True
                    End If
                Case DTO.tblSolutionTruck.RoutingCapacityPreference.Weight
                    If e.CarrierTruckMaxWgt > smallTruck.maxWgt AndAlso (spaceNeeded = 0 OrElse e.CarrierTruckMaxWgt >= spaceNeeded) Then
                        smallTruck.updateEquipmentInfo(e)
                        Return True
                    End If
                Case DTO.tblSolutionTruck.RoutingCapacityPreference.Cubes
                    If e.CarrierTruckMaxCubes > smallTruck.maxCubes AndAlso (spaceNeeded = 0 OrElse e.CarrierTruckMaxCubes >= spaceNeeded) Then
                        smallTruck.updateEquipmentInfo(e)
                        Return True
                    End If
                Case Else
                    'we use pallets
                    If e.CarrierTruckMaxPlts > smallTruck.maxPLTs AndAlso (spaceNeeded = 0 OrElse e.CarrierTruckMaxPlts >= spaceNeeded) Then
                        smallTruck.updateEquipmentInfo(e)
                        Return True
                    End If
            End Select
        Next
        Return False


    End Function

    Public Function moveLoadToSmallestTruck(ByRef largeTruck As DTO.tblSolutionTruck) As Boolean

        For Each e In ListAvailableEquipment.OrderBy(Function(x) x.CarrierTruckMaxWgt) 'order by smallest equipment first
            If e.CarrierTruckMaxCases >= largeTruck.TotalCases _
                AndAlso e.CarrierTruckMaxWgt >= largeTruck.TotalWgt _
                AndAlso e.CarrierTruckMaxCubes >= largeTruck.TotalCubes _
                AndAlso e.CarrierTruckMaxPlts >= largeTruck.TotalPlts _
                AndAlso _
                (e.CarrierTruckMaxCases < largeTruck.maxCases Or e.CarrierTruckMaxCubes < largeTruck.maxCubes Or e.CarrierTruckMaxPlts < largeTruck.maxPLTs Or e.CarrierTruckMaxWgt < e.CarrierTruckMaxWgt) Then
                largeTruck.updateEquipmentInfo(e)
                Return True
            End If
        Next
        Return False


    End Function

#End Region

#Region "Protected or Private Functions"

    Protected Overrides Function CopyDTOToLinq(ByVal oData As DataTransferObjects.DTOBaseClass) As Object
        Dim d = CType(oData, DTO.tblSolutionTruck)
        'Create New Record
        Return New LTS.tblSolutionTruck With {.SolutionTruckControl = d.SolutionTruckControl _
                                                      , .SolutionTruckSolutionControl = d.SolutionTruckSolutionControl _
                                                      , .SolutionTruckCom = d.SolutionTruckCom _
                                                      , .SolutionTruckConsPrefix = d.SolutionTruckConsPrefix _
                                                      , .SolutionTruckRouteConsFlag = d.SolutionTruckRouteConsFlag _
                                                      , .SolutionTruckCarrierControl = d.SolutionTruckCarrierControl _
                                                      , .SolutionTruckCarrierNumber = d.SolutionTruckCarrierNumber _
                                                      , .SolutionTruckCarrierName = d.SolutionTruckCarrierName _
                                                      , .SolutionTruckCarrierTruckControl = d.SolutionTruckCarrierTruckControl _
                                                      , .SolutionTruckCarrierTruckDescription = d.SolutionTruckCarrierTruckDescription _
                                                      , .SolutionTruckTotalCases = d.SolutionTruckTotalCases _
                                                      , .SolutionTruckTotalWgt = d.SolutionTruckTotalWgt _
                                                      , .SolutionTruckTotalPL = d.SolutionTruckTotalPL _
                                                      , .SolutionTruckTotalCube = d.SolutionTruckTotalCube _
                                                      , .SolutionTruckTotalPX = d.SolutionTruckTotalPX _
                                                      , .SolutionTruckTotalBFC = d.SolutionTruckTotalBFC _
                                                      , .SolutionTruckTotalOrders = d.SolutionTruckTotalOrders _
                                                      , .SolutionTruckTotalCost = d.SolutionTruckTotalCost _
                                                      , .SolutionTruckTotalMiles = d.SolutionTruckTotalMiles _
                                                      , .SolutionTruckCarrierEquipmentCodes = d.SolutionTruckCarrierEquipmentCodes _
                                                      , .SolutionTruckRouteTypeCode = d.SolutionTruckRouteTypeCode _
                                                      , .SolutionTruckCommitted = d.SolutionTruckCommitted _
                                                      , .SolutionTruckCommittedDate = d.SolutionTruckCommittedDate _
                                                      , .SolutionTruckStaticRouteControl = d.SolutionTruckStaticRouteControl _
                                                      , .SolutionTruckAttributeControl = d.SolutionTruckAttributeControl _
                                                      , .SolutionTruckAttributeTypeControl = d.SolutionTruckAttributeTypeControl _
                                                      , .SolutionTruckCapacityPreference = d.SolutionTruckCapacityPreference _
                                                      , .SolutionTruckMinCases = d.SolutionTruckMinCases _
                                                      , .SolutionTruckSplitCases = d.SolutionTruckSplitCases _
                                                      , .SolutionTruckMaxCases = d.SolutionTruckMaxCases _
                                                      , .SolutionTruckMinWgt = d.SolutionTruckMinWgt _
                                                      , .SolutionTruckSplitWgt = d.SolutionTruckSplitWgt _
                                                      , .SolutionTruckMaxWgt = d.SolutionTruckMaxWgt _
                                                      , .SolutionTruckMinCubes = d.SolutionTruckMinCubes _
                                                      , .SolutionTruckSplitCubes = d.SolutionTruckSplitCubes _
                                                      , .SolutionTruckMaxCubes = d.SolutionTruckMaxCubes _
                                                      , .SolutionTruckMinPlts = d.SolutionTruckMinPlts _
                                                      , .SolutionTruckSplitPlts = d.SolutionTruckSplitPlts _
                                                      , .SolutionTruckMaxPlts = d.SolutionTruckMaxPlts _
                                                      , .SolutionTruckTrucksAvailable = d.SolutionTruckTrucksAvailable _
                                                      , .SolutionTruckIsHazmat = d.SolutionTruckIsHazmat _
                                                      , .SolutionTruckModDate = Date.Now _
                                                      , .SolutionTruckModUser = Parameters.UserName _
                                                      , .SolutionTruckUpdated = If(d.SolutionTruckUpdated Is Nothing, New Byte() {}, d.SolutionTruckUpdated)}

    End Function

    Protected Overrides Function GetDTOUsingLinqTable(ByVal LinqTable As Object) As DataTransferObjects.DTOBaseClass
        Return Nothing ' GettblSolutionTruckFiltered(Control:=CType(LinqTable, LTS.tblSolutionTruck).SolutionTruckControl)
    End Function

    Protected Overrides Function GetQuickSaveResults(ByVal LinqTable As Object) As DataTransferObjects.QuickSaveResults

        Dim ret As DTO.QuickSaveResults
        Using db As New NGLMasBookDataContext(ConnectionString)
            Try
                Dim source As LTS.tblSolutionTruck = TryCast(LinqTable, LTS.tblSolutionTruck)
                If source Is Nothing Then Return Nothing

                ret = (From d In db.tblSolutionTrucks _
                       Where d.SolutionTruckControl = source.SolutionTruckControl _
                       Select New DTO.QuickSaveResults With {.Control = d.SolutionTruckControl _
                                                            , .ModDate = d.SolutionTruckModDate _
                                                            , .ModUser = d.SolutionTruckModUser _
                                                            , .Updated = d.SolutionTruckUpdated.ToArray}).First

            Catch ex As System.Data.SqlClient.SqlException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_SQLExceptionMSG", .Details = ex.Message}, New FaultReason("E_SQLException"))
            Catch ex As InvalidOperationException
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_NoData", .Details = ex.Message}, New FaultReason("E_InvalidOperationException"))
            Catch ex As Exception
                Utilities.SaveAppError(ex.Message, Me.Parameters)
                Throw New FaultException(Of SqlFaultInfo)(New SqlFaultInfo With {.Message = "E_UnExpectedMSG", .Details = ex.Message}, New FaultReason("E_UnExpected"))
            End Try

        End Using
        Return ret
    End Function

#End Region

End Class
End Namespace